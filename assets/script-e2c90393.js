var Ai=Object.defineProperty;var Ti=(a,e,t)=>e in a?Ai(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var re=(a,e,t)=>(Ti(a,typeof e!="symbol"?e+"":e,t),t),Wt=(a,e,t)=>{if(!e.has(a))throw TypeError("Cannot "+t)};var I=(a,e,t)=>(Wt(a,e,"read from private field"),t?t.call(a):e.get(a)),Q=(a,e,t)=>{if(e.has(a))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(a):e.set(a,t)},$=(a,e,t,i)=>(Wt(a,e,"write to private field"),i?i.call(a,t):e.set(a,t),t),Ht=(a,e,t,i)=>({set _(r){$(a,e,r,t)},get _(){return I(a,e,i)}}),ne=(a,e,t)=>(Wt(a,e,"access private method"),t);var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var indexMinimal={},minimal$1={},aspromise=asPromise;function asPromise(a,e){for(var t=new Array(arguments.length-1),i=0,r=2,s=!0;r<arguments.length;)t[i++]=arguments[r++];return new Promise(function(o,l){t[i]=function(u){if(s)if(s=!1,u)l(u);else{for(var c=new Array(arguments.length-1),d=0;d<c.length;)c[d++]=arguments[d];o.apply(null,c)}};try{a.apply(e||null,t)}catch(h){s&&(s=!1,l(h))}})}var base64$1={};(function(a){var e=a;e.length=function(o){var l=o.length;if(!l)return 0;for(var h=0;--l%4>1&&o.charAt(l)==="=";)++h;return Math.ceil(o.length*3)/4-h};for(var t=new Array(64),i=new Array(123),r=0;r<64;)i[t[r]=r<26?r+65:r<52?r+71:r<62?r-4:r-59|43]=r++;e.encode=function(o,l,h){for(var u=null,c=[],d=0,f=0,_;l<h;){var g=o[l++];switch(f){case 0:c[d++]=t[g>>2],_=(g&3)<<4,f=1;break;case 1:c[d++]=t[_|g>>4],_=(g&15)<<2,f=2;break;case 2:c[d++]=t[_|g>>6],c[d++]=t[g&63],f=0;break}d>8191&&((u||(u=[])).push(String.fromCharCode.apply(String,c)),d=0)}return f&&(c[d++]=t[_],c[d++]=61,f===1&&(c[d++]=61)),u?(d&&u.push(String.fromCharCode.apply(String,c.slice(0,d))),u.join("")):String.fromCharCode.apply(String,c.slice(0,d))};var s="invalid encoding";e.decode=function(o,l,h){for(var u=h,c=0,d,f=0;f<o.length;){var _=o.charCodeAt(f++);if(_===61&&c>1)break;if((_=i[_])===void 0)throw Error(s);switch(c){case 0:d=_,c=1;break;case 1:l[h++]=d<<2|(_&48)>>4,d=_,c=2;break;case 2:l[h++]=(d&15)<<4|(_&60)>>2,d=_,c=3;break;case 3:l[h++]=(d&3)<<6|_,c=0;break}}if(c===1)throw Error(s);return h-u},e.test=function(o){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(o)}})(base64$1);var eventemitter=EventEmitter;function EventEmitter(){this._listeners={}}EventEmitter.prototype.on=function(e,t,i){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:i||this}),this};EventEmitter.prototype.off=function(e,t){if(e===void 0)this._listeners={};else if(t===void 0)this._listeners[e]=[];else for(var i=this._listeners[e],r=0;r<i.length;)i[r].fn===t?i.splice(r,1):++r;return this};EventEmitter.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var i=[],r=1;r<arguments.length;)i.push(arguments[r++]);for(r=0;r<t.length;)t[r].fn.apply(t[r++].ctx,i)}return this};var float=factory(factory);function factory(a){return typeof Float32Array<"u"?function(){var e=new Float32Array([-0]),t=new Uint8Array(e.buffer),i=t[3]===128;function r(l,h,u){e[0]=l,h[u]=t[0],h[u+1]=t[1],h[u+2]=t[2],h[u+3]=t[3]}function s(l,h,u){e[0]=l,h[u]=t[3],h[u+1]=t[2],h[u+2]=t[1],h[u+3]=t[0]}a.writeFloatLE=i?r:s,a.writeFloatBE=i?s:r;function n(l,h){return t[0]=l[h],t[1]=l[h+1],t[2]=l[h+2],t[3]=l[h+3],e[0]}function o(l,h){return t[3]=l[h],t[2]=l[h+1],t[1]=l[h+2],t[0]=l[h+3],e[0]}a.readFloatLE=i?n:o,a.readFloatBE=i?o:n}():function(){function e(i,r,s,n){var o=r<0?1:0;if(o&&(r=-r),r===0)i(1/r>0?0:2147483648,s,n);else if(isNaN(r))i(2143289344,s,n);else if(r>34028234663852886e22)i((o<<31|2139095040)>>>0,s,n);else if(r<11754943508222875e-54)i((o<<31|Math.round(r/1401298464324817e-60))>>>0,s,n);else{var l=Math.floor(Math.log(r)/Math.LN2),h=Math.round(r*Math.pow(2,-l)*8388608)&8388607;i((o<<31|l+127<<23|h)>>>0,s,n)}}a.writeFloatLE=e.bind(null,writeUintLE),a.writeFloatBE=e.bind(null,writeUintBE);function t(i,r,s){var n=i(r,s),o=(n>>31)*2+1,l=n>>>23&255,h=n&8388607;return l===255?h?NaN:o*(1/0):l===0?o*1401298464324817e-60*h:o*Math.pow(2,l-150)*(h+8388608)}a.readFloatLE=t.bind(null,readUintLE),a.readFloatBE=t.bind(null,readUintBE)}(),typeof Float64Array<"u"?function(){var e=new Float64Array([-0]),t=new Uint8Array(e.buffer),i=t[7]===128;function r(l,h,u){e[0]=l,h[u]=t[0],h[u+1]=t[1],h[u+2]=t[2],h[u+3]=t[3],h[u+4]=t[4],h[u+5]=t[5],h[u+6]=t[6],h[u+7]=t[7]}function s(l,h,u){e[0]=l,h[u]=t[7],h[u+1]=t[6],h[u+2]=t[5],h[u+3]=t[4],h[u+4]=t[3],h[u+5]=t[2],h[u+6]=t[1],h[u+7]=t[0]}a.writeDoubleLE=i?r:s,a.writeDoubleBE=i?s:r;function n(l,h){return t[0]=l[h],t[1]=l[h+1],t[2]=l[h+2],t[3]=l[h+3],t[4]=l[h+4],t[5]=l[h+5],t[6]=l[h+6],t[7]=l[h+7],e[0]}function o(l,h){return t[7]=l[h],t[6]=l[h+1],t[5]=l[h+2],t[4]=l[h+3],t[3]=l[h+4],t[2]=l[h+5],t[1]=l[h+6],t[0]=l[h+7],e[0]}a.readDoubleLE=i?n:o,a.readDoubleBE=i?o:n}():function(){function e(i,r,s,n,o,l){var h=n<0?1:0;if(h&&(n=-n),n===0)i(0,o,l+r),i(1/n>0?0:2147483648,o,l+s);else if(isNaN(n))i(0,o,l+r),i(2146959360,o,l+s);else if(n>17976931348623157e292)i(0,o,l+r),i((h<<31|2146435072)>>>0,o,l+s);else{var u;if(n<22250738585072014e-324)u=n/5e-324,i(u>>>0,o,l+r),i((h<<31|u/4294967296)>>>0,o,l+s);else{var c=Math.floor(Math.log(n)/Math.LN2);c===1024&&(c=1023),u=n*Math.pow(2,-c),i(u*4503599627370496>>>0,o,l+r),i((h<<31|c+1023<<20|u*1048576&1048575)>>>0,o,l+s)}}}a.writeDoubleLE=e.bind(null,writeUintLE,0,4),a.writeDoubleBE=e.bind(null,writeUintBE,4,0);function t(i,r,s,n,o){var l=i(n,o+r),h=i(n,o+s),u=(h>>31)*2+1,c=h>>>20&2047,d=4294967296*(h&1048575)+l;return c===2047?d?NaN:u*(1/0):c===0?u*5e-324*d:u*Math.pow(2,c-1075)*(d+4503599627370496)}a.readDoubleLE=t.bind(null,readUintLE,0,4),a.readDoubleBE=t.bind(null,readUintBE,4,0)}(),a}function writeUintLE(a,e,t){e[t]=a&255,e[t+1]=a>>>8&255,e[t+2]=a>>>16&255,e[t+3]=a>>>24}function writeUintBE(a,e,t){e[t]=a>>>24,e[t+1]=a>>>16&255,e[t+2]=a>>>8&255,e[t+3]=a&255}function readUintLE(a,e){return(a[e]|a[e+1]<<8|a[e+2]<<16|a[e+3]<<24)>>>0}function readUintBE(a,e){return(a[e]<<24|a[e+1]<<16|a[e+2]<<8|a[e+3])>>>0}var inquire_1=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(a){}return null}var utf8$2={};(function(a){var e=a;e.length=function(i){for(var r=0,s=0,n=0;n<i.length;++n)s=i.charCodeAt(n),s<128?r+=1:s<2048?r+=2:(s&64512)===55296&&(i.charCodeAt(n+1)&64512)===56320?(++n,r+=4):r+=3;return r},e.read=function(i,r,s){var n=s-r;if(n<1)return"";for(var o=null,l=[],h=0,u;r<s;)u=i[r++],u<128?l[h++]=u:u>191&&u<224?l[h++]=(u&31)<<6|i[r++]&63:u>239&&u<365?(u=((u&7)<<18|(i[r++]&63)<<12|(i[r++]&63)<<6|i[r++]&63)-65536,l[h++]=55296+(u>>10),l[h++]=56320+(u&1023)):l[h++]=(u&15)<<12|(i[r++]&63)<<6|i[r++]&63,h>8191&&((o||(o=[])).push(String.fromCharCode.apply(String,l)),h=0);return o?(h&&o.push(String.fromCharCode.apply(String,l.slice(0,h))),o.join("")):String.fromCharCode.apply(String,l.slice(0,h))},e.write=function(i,r,s){for(var n=s,o,l,h=0;h<i.length;++h)o=i.charCodeAt(h),o<128?r[s++]=o:o<2048?(r[s++]=o>>6|192,r[s++]=o&63|128):(o&64512)===55296&&((l=i.charCodeAt(h+1))&64512)===56320?(o=65536+((o&1023)<<10)+(l&1023),++h,r[s++]=o>>18|240,r[s++]=o>>12&63|128,r[s++]=o>>6&63|128,r[s++]=o&63|128):(r[s++]=o>>12|224,r[s++]=o>>6&63|128,r[s++]=o&63|128);return s-n}})(utf8$2);var pool_1=pool;function pool(a,e,t){var i=t||8192,r=i>>>1,s=null,n=i;return function(l){if(l<1||l>r)return a(l);n+l>i&&(s=a(i),n=0);var h=e.call(s,n,n+=l);return n&7&&(n=(n|7)+1),h}}var longbits,hasRequiredLongbits;function requireLongbits(){if(hasRequiredLongbits)return longbits;hasRequiredLongbits=1,longbits=e;var a=requireMinimal();function e(s,n){this.lo=s>>>0,this.hi=n>>>0}var t=e.zero=new e(0,0);t.toNumber=function(){return 0},t.zzEncode=t.zzDecode=function(){return this},t.length=function(){return 1};var i=e.zeroHash="\0\0\0\0\0\0\0\0";e.fromNumber=function(n){if(n===0)return t;var o=n<0;o&&(n=-n);var l=n>>>0,h=(n-l)/4294967296>>>0;return o&&(h=~h>>>0,l=~l>>>0,++l>4294967295&&(l=0,++h>4294967295&&(h=0))),new e(l,h)},e.from=function(n){if(typeof n=="number")return e.fromNumber(n);if(a.isString(n))if(a.Long)n=a.Long.fromString(n);else return e.fromNumber(parseInt(n,10));return n.low||n.high?new e(n.low>>>0,n.high>>>0):t},e.prototype.toNumber=function(n){if(!n&&this.hi>>>31){var o=~this.lo+1>>>0,l=~this.hi>>>0;return o||(l=l+1>>>0),-(o+l*4294967296)}return this.lo+this.hi*4294967296},e.prototype.toLong=function(n){return a.Long?new a.Long(this.lo|0,this.hi|0,!!n):{low:this.lo|0,high:this.hi|0,unsigned:!!n}};var r=String.prototype.charCodeAt;return e.fromHash=function(n){return n===i?t:new e((r.call(n,0)|r.call(n,1)<<8|r.call(n,2)<<16|r.call(n,3)<<24)>>>0,(r.call(n,4)|r.call(n,5)<<8|r.call(n,6)<<16|r.call(n,7)<<24)>>>0)},e.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},e.prototype.zzEncode=function(){var n=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^n)>>>0,this.lo=(this.lo<<1^n)>>>0,this},e.prototype.zzDecode=function(){var n=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^n)>>>0,this.hi=(this.hi>>>1^n)>>>0,this},e.prototype.length=function(){var n=this.lo,o=(this.lo>>>28|this.hi<<4)>>>0,l=this.hi>>>24;return l===0?o===0?n<16384?n<128?1:2:n<2097152?3:4:o<16384?o<128?5:6:o<2097152?7:8:l<128?9:10},longbits}var hasRequiredMinimal;function requireMinimal(){return hasRequiredMinimal||(hasRequiredMinimal=1,function(a){var e=a;e.asPromise=aspromise,e.base64=base64$1,e.EventEmitter=eventemitter,e.float=float,e.inquire=inquire_1,e.utf8=utf8$2,e.pool=pool_1,e.LongBits=requireLongbits(),e.isNode=!!(typeof commonjsGlobal<"u"&&commonjsGlobal&&commonjsGlobal.process&&commonjsGlobal.process.versions&&commonjsGlobal.process.versions.node),e.global=e.isNode&&commonjsGlobal||typeof window<"u"&&window||typeof self<"u"&&self||commonjsGlobal,e.emptyArray=Object.freeze?Object.freeze([]):[],e.emptyObject=Object.freeze?Object.freeze({}):{},e.isInteger=Number.isInteger||function(s){return typeof s=="number"&&isFinite(s)&&Math.floor(s)===s},e.isString=function(s){return typeof s=="string"||s instanceof String},e.isObject=function(s){return s&&typeof s=="object"},e.isset=e.isSet=function(s,n){var o=s[n];return o!=null&&s.hasOwnProperty(n)?typeof o!="object"||(Array.isArray(o)?o.length:Object.keys(o).length)>0:!1},e.Buffer=function(){try{var r=e.inquire("buffer").Buffer;return r.prototype.utf8Write?r:null}catch{return null}}(),e._Buffer_from=null,e._Buffer_allocUnsafe=null,e.newBuffer=function(s){return typeof s=="number"?e.Buffer?e._Buffer_allocUnsafe(s):new e.Array(s):e.Buffer?e._Buffer_from(s):typeof Uint8Array>"u"?s:new Uint8Array(s)},e.Array=typeof Uint8Array<"u"?Uint8Array:Array,e.Long=e.global.dcodeIO&&e.global.dcodeIO.Long||e.global.Long||e.inquire("long"),e.key2Re=/^true|false|0|1$/,e.key32Re=/^-?(?:0|[1-9][0-9]*)$/,e.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,e.longToHash=function(s){return s?e.LongBits.from(s).toHash():e.LongBits.zeroHash},e.longFromHash=function(s,n){var o=e.LongBits.fromHash(s);return e.Long?e.Long.fromBits(o.lo,o.hi,n):o.toNumber(!!n)};function t(r,s,n){for(var o=Object.keys(s),l=0;l<o.length;++l)(r[o[l]]===void 0||!n)&&(r[o[l]]=s[o[l]]);return r}e.merge=t,e.lcFirst=function(s){return s.charAt(0).toLowerCase()+s.substring(1)};function i(r){function s(n,o){if(!(this instanceof s))return new s(n,o);Object.defineProperty(this,"message",{get:function(){return n}}),Error.captureStackTrace?Error.captureStackTrace(this,s):Object.defineProperty(this,"stack",{value:new Error().stack||""}),o&&t(this,o)}return s.prototype=Object.create(Error.prototype,{constructor:{value:s,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return r},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),s}e.newError=i,e.ProtocolError=i("ProtocolError"),e.oneOfGetter=function(s){for(var n={},o=0;o<s.length;++o)n[s[o]]=1;return function(){for(var l=Object.keys(this),h=l.length-1;h>-1;--h)if(n[l[h]]===1&&this[l[h]]!==void 0&&this[l[h]]!==null)return l[h]}},e.oneOfSetter=function(s){return function(n){for(var o=0;o<s.length;++o)s[o]!==n&&delete this[s[o]]}},e.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},e._configure=function(){var r=e.Buffer;if(!r){e._Buffer_from=e._Buffer_allocUnsafe=null;return}e._Buffer_from=r.from!==Uint8Array.from&&r.from||function(n,o){return new r(n,o)},e._Buffer_allocUnsafe=r.allocUnsafe||function(n){return new r(n)}}}(minimal$1)),minimal$1}var writer=Writer$1,util$4=requireMinimal(),BufferWriter$1,LongBits$1=util$4.LongBits,base64=util$4.base64,utf8$1=util$4.utf8;function Op(a,e,t){this.fn=a,this.len=e,this.next=void 0,this.val=t}function noop(){}function State(a){this.head=a.head,this.tail=a.tail,this.len=a.len,this.next=a.states}function Writer$1(){this.len=0,this.head=new Op(noop,0,0),this.tail=this.head,this.states=null}var create$1=function a(){return util$4.Buffer?function(){return(Writer$1.create=function(){return new BufferWriter$1})()}:function(){return new Writer$1}};Writer$1.create=create$1();Writer$1.alloc=function a(e){return new util$4.Array(e)};util$4.Array!==Array&&(Writer$1.alloc=util$4.pool(Writer$1.alloc,util$4.Array.prototype.subarray));Writer$1.prototype._push=function a(e,t,i){return this.tail=this.tail.next=new Op(e,t,i),this.len+=t,this};function writeByte(a,e,t){e[t]=a&255}function writeVarint32(a,e,t){for(;a>127;)e[t++]=a&127|128,a>>>=7;e[t]=a}function VarintOp(a,e){this.len=a,this.next=void 0,this.val=e}VarintOp.prototype=Object.create(Op.prototype);VarintOp.prototype.fn=writeVarint32;Writer$1.prototype.uint32=function a(e){return this.len+=(this.tail=this.tail.next=new VarintOp((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this};Writer$1.prototype.int32=function a(e){return e<0?this._push(writeVarint64,10,LongBits$1.fromNumber(e)):this.uint32(e)};Writer$1.prototype.sint32=function a(e){return this.uint32((e<<1^e>>31)>>>0)};function writeVarint64(a,e,t){for(;a.hi;)e[t++]=a.lo&127|128,a.lo=(a.lo>>>7|a.hi<<25)>>>0,a.hi>>>=7;for(;a.lo>127;)e[t++]=a.lo&127|128,a.lo=a.lo>>>7;e[t++]=a.lo}Writer$1.prototype.uint64=function a(e){var t=LongBits$1.from(e);return this._push(writeVarint64,t.length(),t)};Writer$1.prototype.int64=Writer$1.prototype.uint64;Writer$1.prototype.sint64=function a(e){var t=LongBits$1.from(e).zzEncode();return this._push(writeVarint64,t.length(),t)};Writer$1.prototype.bool=function a(e){return this._push(writeByte,1,e?1:0)};function writeFixed32(a,e,t){e[t]=a&255,e[t+1]=a>>>8&255,e[t+2]=a>>>16&255,e[t+3]=a>>>24}Writer$1.prototype.fixed32=function a(e){return this._push(writeFixed32,4,e>>>0)};Writer$1.prototype.sfixed32=Writer$1.prototype.fixed32;Writer$1.prototype.fixed64=function a(e){var t=LongBits$1.from(e);return this._push(writeFixed32,4,t.lo)._push(writeFixed32,4,t.hi)};Writer$1.prototype.sfixed64=Writer$1.prototype.fixed64;Writer$1.prototype.float=function a(e){return this._push(util$4.float.writeFloatLE,4,e)};Writer$1.prototype.double=function a(e){return this._push(util$4.float.writeDoubleLE,8,e)};var writeBytes=util$4.Array.prototype.set?function a(e,t,i){t.set(e,i)}:function a(e,t,i){for(var r=0;r<e.length;++r)t[i+r]=e[r]};Writer$1.prototype.bytes=function a(e){var t=e.length>>>0;if(!t)return this._push(writeByte,1,0);if(util$4.isString(e)){var i=Writer$1.alloc(t=base64.length(e));base64.decode(e,i,0),e=i}return this.uint32(t)._push(writeBytes,t,e)};Writer$1.prototype.string=function a(e){var t=utf8$1.length(e);return t?this.uint32(t)._push(utf8$1.write,t,e):this._push(writeByte,1,0)};Writer$1.prototype.fork=function a(){return this.states=new State(this),this.head=this.tail=new Op(noop,0,0),this.len=0,this};Writer$1.prototype.reset=function a(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Op(noop,0,0),this.len=0),this};Writer$1.prototype.ldelim=function a(){var e=this.head,t=this.tail,i=this.len;return this.reset().uint32(i),i&&(this.tail.next=e.next,this.tail=t,this.len+=i),this};Writer$1.prototype.finish=function a(){for(var e=this.head.next,t=this.constructor.alloc(this.len),i=0;e;)e.fn(e.val,t,i),i+=e.len,e=e.next;return t};Writer$1._configure=function(a){BufferWriter$1=a,Writer$1.create=create$1(),BufferWriter$1._configure()};var writer_buffer=BufferWriter,Writer=writer;(BufferWriter.prototype=Object.create(Writer.prototype)).constructor=BufferWriter;var util$3=requireMinimal();function BufferWriter(){Writer.call(this)}BufferWriter._configure=function(){BufferWriter.alloc=util$3._Buffer_allocUnsafe,BufferWriter.writeBytesBuffer=util$3.Buffer&&util$3.Buffer.prototype instanceof Uint8Array&&util$3.Buffer.prototype.set.name==="set"?function(e,t,i){t.set(e,i)}:function(e,t,i){if(e.copy)e.copy(t,i,0,e.length);else for(var r=0;r<e.length;)t[i++]=e[r++]}};BufferWriter.prototype.bytes=function a(e){util$3.isString(e)&&(e=util$3._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(BufferWriter.writeBytesBuffer,t,e),this};function writeStringBuffer(a,e,t){a.length<40?util$3.utf8.write(a,e,t):e.utf8Write?e.utf8Write(a,t):e.write(a,t)}BufferWriter.prototype.string=function a(e){var t=util$3.Buffer.byteLength(e);return this.uint32(t),t&&this._push(writeStringBuffer,t,e),this};BufferWriter._configure();var reader=Reader$1,util$2=requireMinimal(),BufferReader$1,LongBits=util$2.LongBits,utf8=util$2.utf8;function indexOutOfRange(a,e){return RangeError("index out of range: "+a.pos+" + "+(e||1)+" > "+a.len)}function Reader$1(a){this.buf=a,this.pos=0,this.len=a.length}var create_array=typeof Uint8Array<"u"?function a(e){if(e instanceof Uint8Array||Array.isArray(e))return new Reader$1(e);throw Error("illegal buffer")}:function a(e){if(Array.isArray(e))return new Reader$1(e);throw Error("illegal buffer")},create=function a(){return util$2.Buffer?function(t){return(Reader$1.create=function(r){return util$2.Buffer.isBuffer(r)?new BufferReader$1(r):create_array(r)})(t)}:create_array};Reader$1.create=create();Reader$1.prototype._slice=util$2.Array.prototype.subarray||util$2.Array.prototype.slice;Reader$1.prototype.uint32=function a(){var e=4294967295;return function(){if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,indexOutOfRange(this,10);return e}}();Reader$1.prototype.int32=function a(){return this.uint32()|0};Reader$1.prototype.sint32=function a(){var e=this.uint32();return e>>>1^-(e&1)|0};function readLongVarint(){var a=new LongBits(0,0),e=0;if(this.len-this.pos>4){for(;e<4;++e)if(a.lo=(a.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return a;if(a.lo=(a.lo|(this.buf[this.pos]&127)<<28)>>>0,a.hi=(a.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return a;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw indexOutOfRange(this);if(a.lo=(a.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return a}return a.lo=(a.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,a}if(this.len-this.pos>4){for(;e<5;++e)if(a.hi=(a.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return a}else for(;e<5;++e){if(this.pos>=this.len)throw indexOutOfRange(this);if(a.hi=(a.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return a}throw Error("invalid varint encoding")}Reader$1.prototype.bool=function a(){return this.uint32()!==0};function readFixed32_end(a,e){return(a[e-4]|a[e-3]<<8|a[e-2]<<16|a[e-1]<<24)>>>0}Reader$1.prototype.fixed32=function a(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)};Reader$1.prototype.sfixed32=function a(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)|0};function readFixed64(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);return new LongBits(readFixed32_end(this.buf,this.pos+=4),readFixed32_end(this.buf,this.pos+=4))}Reader$1.prototype.float=function a(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);var e=util$2.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e};Reader$1.prototype.double=function a(){if(this.pos+8>this.len)throw indexOutOfRange(this,4);var e=util$2.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e};Reader$1.prototype.bytes=function a(){var e=this.uint32(),t=this.pos,i=this.pos+e;if(i>this.len)throw indexOutOfRange(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,i):t===i?new this.buf.constructor(0):this._slice.call(this.buf,t,i)};Reader$1.prototype.string=function a(){var e=this.bytes();return utf8.read(e,0,e.length)};Reader$1.prototype.skip=function a(e){if(typeof e=="number"){if(this.pos+e>this.len)throw indexOutOfRange(this,e);this.pos+=e}else do if(this.pos>=this.len)throw indexOutOfRange(this);while(this.buf[this.pos++]&128);return this};Reader$1.prototype.skipType=function(a){switch(a){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(a=this.uint32()&7)!==4;)this.skipType(a);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+a+" at offset "+this.pos)}return this};Reader$1._configure=function(a){BufferReader$1=a,Reader$1.create=create(),BufferReader$1._configure();var e=util$2.Long?"toLong":"toNumber";util$2.merge(Reader$1.prototype,{int64:function(){return readLongVarint.call(this)[e](!1)},uint64:function(){return readLongVarint.call(this)[e](!0)},sint64:function(){return readLongVarint.call(this).zzDecode()[e](!1)},fixed64:function(){return readFixed64.call(this)[e](!0)},sfixed64:function(){return readFixed64.call(this)[e](!1)}})};var reader_buffer=BufferReader,Reader=reader;(BufferReader.prototype=Object.create(Reader.prototype)).constructor=BufferReader;var util$1=requireMinimal();function BufferReader(a){Reader.call(this,a)}BufferReader._configure=function(){util$1.Buffer&&(BufferReader.prototype._slice=util$1.Buffer.prototype.slice)};BufferReader.prototype.string=function a(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))};BufferReader._configure();var rpc={},service=Service,util=requireMinimal();(Service.prototype=Object.create(util.EventEmitter.prototype)).constructor=Service;function Service(a,e,t){if(typeof a!="function")throw TypeError("rpcImpl must be a function");util.EventEmitter.call(this),this.rpcImpl=a,this.requestDelimited=!!e,this.responseDelimited=!!t}Service.prototype.rpcCall=function a(e,t,i,r,s){if(!r)throw TypeError("request must be specified");var n=this;if(!s)return util.asPromise(a,n,e,t,i,r);if(!n.rpcImpl){setTimeout(function(){s(Error("already ended"))},0);return}try{return n.rpcImpl(e,t[n.requestDelimited?"encodeDelimited":"encode"](r).finish(),function(l,h){if(l)return n.emit("error",l,e),s(l);if(h===null){n.end(!0);return}if(!(h instanceof i))try{h=i[n.responseDelimited?"decodeDelimited":"decode"](h)}catch(u){return n.emit("error",u,e),s(u)}return n.emit("data",h,e),s(null,h)})}catch(o){n.emit("error",o,e),setTimeout(function(){s(o)},0);return}};Service.prototype.end=function a(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};(function(a){var e=a;e.Service=service})(rpc);var roots={};(function(a){var e=a;e.build="minimal",e.Writer=writer,e.BufferWriter=writer_buffer,e.Reader=reader,e.BufferReader=reader_buffer,e.util=requireMinimal(),e.rpc=rpc,e.roots=roots,e.configure=t;function t(){e.util._configure(),e.Writer._configure(e.BufferWriter),e.Reader._configure(e.BufferReader)}t()})(indexMinimal);var minimal=indexMinimal,_m0=getDefaultExportFromCjs(minimal);function createBaseColor(){return{r:0,g:0,b:0,a:0}}const Color={encode(a,e=_m0.Writer.create()){return a.r!==0&&e.uint32(13).float(a.r),a.g!==0&&e.uint32(21).float(a.g),a.b!==0&&e.uint32(29).float(a.b),a.a!==0&&e.uint32(37).float(a.a),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseColor();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==13)break;r.r=t.float();continue;case 2:if(s!==21)break;r.g=t.float();continue;case 3:if(s!==29)break;r.b=t.float();continue;case 4:if(s!==37)break;r.a=t.float();continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{r:isSet$f(a.r)?Number(a.r):0,g:isSet$f(a.g)?Number(a.g):0,b:isSet$f(a.b)?Number(a.b):0,a:isSet$f(a.a)?Number(a.a):0}},toJSON(a){const e={};return a.r!==void 0&&(e.r=a.r),a.g!==void 0&&(e.g=a.g),a.b!==void 0&&(e.b=a.b),a.a!==void 0&&(e.a=a.a),e},create(a){return Color.fromPartial(a??{})},fromPartial(a){const e=createBaseColor();return e.r=a.r??0,e.g=a.g??0,e.b=a.b??0,e.a=a.a??0,e}};function isSet$f(a){return a!=null}function createBaseVector(){return{x:0,y:0,z:0}}const Vector={encode(a,e=_m0.Writer.create()){return a.x!==0&&e.uint32(9).double(a.x),a.y!==0&&e.uint32(17).double(a.y),a.z!==0&&e.uint32(25).double(a.z),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseVector();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==9)break;r.x=t.double();continue;case 2:if(s!==17)break;r.y=t.double();continue;case 3:if(s!==25)break;r.z=t.double();continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{x:isSet$e(a.x)?Number(a.x):0,y:isSet$e(a.y)?Number(a.y):0,z:isSet$e(a.z)?Number(a.z):0}},toJSON(a){const e={};return a.x!==void 0&&(e.x=a.x),a.y!==void 0&&(e.y=a.y),a.z!==void 0&&(e.z=a.z),e},create(a){return Vector.fromPartial(a??{})},fromPartial(a){const e=createBaseVector();return e.x=a.x??0,e.y=a.y??0,e.z=a.z??0,e}};function isSet$e(a){return a!=null}function createBaseScalarProperty(){return{source:void 0}}const ScalarProperty={encode(a,e=_m0.Writer.create()){var t;switch((t=a.source)==null?void 0:t.$case){case"constValue":e.uint32(9).double(a.source.constValue);break;case"graphId":e.uint32(16).uint32(a.source.graphId);break}return e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseScalarProperty();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==9)break;r.source={$case:"constValue",constValue:t.double()};continue;case 2:if(s!==16)break;r.source={$case:"graphId",graphId:t.uint32()};continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{source:isSet$d(a.constValue)?{$case:"constValue",constValue:Number(a.constValue)}:isSet$d(a.graphId)?{$case:"graphId",graphId:Number(a.graphId)}:void 0}},toJSON(a){var t,i,r,s;const e={};return((t=a.source)==null?void 0:t.$case)==="constValue"&&(e.constValue=(i=a.source)==null?void 0:i.constValue),((r=a.source)==null?void 0:r.$case)==="graphId"&&(e.graphId=Math.round((s=a.source)==null?void 0:s.graphId)),e},create(a){return ScalarProperty.fromPartial(a??{})},fromPartial(a){var t,i,r,s,n,o;const e=createBaseScalarProperty();return((t=a.source)==null?void 0:t.$case)==="constValue"&&((i=a.source)==null?void 0:i.constValue)!==void 0&&((r=a.source)==null?void 0:r.constValue)!==null&&(e.source={$case:"constValue",constValue:a.source.constValue}),((s=a.source)==null?void 0:s.$case)==="graphId"&&((n=a.source)==null?void 0:n.graphId)!==void 0&&((o=a.source)==null?void 0:o.graphId)!==null&&(e.source={$case:"graphId",graphId:a.source.graphId}),e}};function createBaseVectorProperty(){return{source:void 0}}const VectorProperty={encode(a,e=_m0.Writer.create()){var t;switch((t=a.source)==null?void 0:t.$case){case"constValue":Vector.encode(a.source.constValue,e.uint32(10).fork()).ldelim();break;case"pathId":e.uint32(16).uint32(a.source.pathId);break}return e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseVectorProperty();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.source={$case:"constValue",constValue:Vector.decode(t,t.uint32())};continue;case 2:if(s!==16)break;r.source={$case:"pathId",pathId:t.uint32()};continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{source:isSet$d(a.constValue)?{$case:"constValue",constValue:Vector.fromJSON(a.constValue)}:isSet$d(a.pathId)?{$case:"pathId",pathId:Number(a.pathId)}:void 0}},toJSON(a){var t,i,r,s,n;const e={};return((t=a.source)==null?void 0:t.$case)==="constValue"&&(e.constValue=(i=a.source)!=null&&i.constValue?Vector.toJSON((r=a.source)==null?void 0:r.constValue):void 0),((s=a.source)==null?void 0:s.$case)==="pathId"&&(e.pathId=Math.round((n=a.source)==null?void 0:n.pathId)),e},create(a){return VectorProperty.fromPartial(a??{})},fromPartial(a){var t,i,r,s,n,o;const e=createBaseVectorProperty();return((t=a.source)==null?void 0:t.$case)==="constValue"&&((i=a.source)==null?void 0:i.constValue)!==void 0&&((r=a.source)==null?void 0:r.constValue)!==null&&(e.source={$case:"constValue",constValue:Vector.fromPartial(a.source.constValue)}),((s=a.source)==null?void 0:s.$case)==="pathId"&&((n=a.source)==null?void 0:n.pathId)!==void 0&&((o=a.source)==null?void 0:o.pathId)!==null&&(e.source={$case:"pathId",pathId:a.source.pathId}),e}};function createBaseColorProperty(){return{source:void 0}}const ColorProperty={encode(a,e=_m0.Writer.create()){var t;switch((t=a.source)==null?void 0:t.$case){case"constValue":Color.encode(a.source.constValue,e.uint32(10).fork()).ldelim();break;case"graphId":e.uint32(16).uint32(a.source.graphId);break;case"scalarValue":e.uint32(25).double(a.source.scalarValue);break}return e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseColorProperty();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.source={$case:"constValue",constValue:Color.decode(t,t.uint32())};continue;case 2:if(s!==16)break;r.source={$case:"graphId",graphId:t.uint32()};continue;case 3:if(s!==25)break;r.source={$case:"scalarValue",scalarValue:t.double()};continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{source:isSet$d(a.constValue)?{$case:"constValue",constValue:Color.fromJSON(a.constValue)}:isSet$d(a.graphId)?{$case:"graphId",graphId:Number(a.graphId)}:isSet$d(a.scalarValue)?{$case:"scalarValue",scalarValue:Number(a.scalarValue)}:void 0}},toJSON(a){var t,i,r,s,n,o,l;const e={};return((t=a.source)==null?void 0:t.$case)==="constValue"&&(e.constValue=(i=a.source)!=null&&i.constValue?Color.toJSON((r=a.source)==null?void 0:r.constValue):void 0),((s=a.source)==null?void 0:s.$case)==="graphId"&&(e.graphId=Math.round((n=a.source)==null?void 0:n.graphId)),((o=a.source)==null?void 0:o.$case)==="scalarValue"&&(e.scalarValue=(l=a.source)==null?void 0:l.scalarValue),e},create(a){return ColorProperty.fromPartial(a??{})},fromPartial(a){var t,i,r,s,n,o,l,h,u;const e=createBaseColorProperty();return((t=a.source)==null?void 0:t.$case)==="constValue"&&((i=a.source)==null?void 0:i.constValue)!==void 0&&((r=a.source)==null?void 0:r.constValue)!==null&&(e.source={$case:"constValue",constValue:Color.fromPartial(a.source.constValue)}),((s=a.source)==null?void 0:s.$case)==="graphId"&&((n=a.source)==null?void 0:n.graphId)!==void 0&&((o=a.source)==null?void 0:o.graphId)!==null&&(e.source={$case:"graphId",graphId:a.source.graphId}),((l=a.source)==null?void 0:l.$case)==="scalarValue"&&((h=a.source)==null?void 0:h.scalarValue)!==void 0&&((u=a.source)==null?void 0:u.scalarValue)!==null&&(e.source={$case:"scalarValue",scalarValue:a.source.scalarValue}),e}};function isSet$d(a){return a!=null}function createBaseLine(){return{start:void 0,end:void 0,lineWidth:void 0,color:void 0,pointForward:!1,pointBackward:!1}}const Line$1={encode(a,e=_m0.Writer.create()){return a.start!==void 0&&VectorProperty.encode(a.start,e.uint32(10).fork()).ldelim(),a.end!==void 0&&VectorProperty.encode(a.end,e.uint32(18).fork()).ldelim(),a.lineWidth!==void 0&&ScalarProperty.encode(a.lineWidth,e.uint32(26).fork()).ldelim(),a.color!==void 0&&ColorProperty.encode(a.color,e.uint32(34).fork()).ldelim(),a.pointForward===!0&&e.uint32(40).bool(a.pointForward),a.pointBackward===!0&&e.uint32(48).bool(a.pointBackward),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseLine();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.start=VectorProperty.decode(t,t.uint32());continue;case 2:if(s!==18)break;r.end=VectorProperty.decode(t,t.uint32());continue;case 3:if(s!==26)break;r.lineWidth=ScalarProperty.decode(t,t.uint32());continue;case 4:if(s!==34)break;r.color=ColorProperty.decode(t,t.uint32());continue;case 5:if(s!==40)break;r.pointForward=t.bool();continue;case 6:if(s!==48)break;r.pointBackward=t.bool();continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{start:isSet$c(a.start)?VectorProperty.fromJSON(a.start):void 0,end:isSet$c(a.end)?VectorProperty.fromJSON(a.end):void 0,lineWidth:isSet$c(a.lineWidth)?ScalarProperty.fromJSON(a.lineWidth):void 0,color:isSet$c(a.color)?ColorProperty.fromJSON(a.color):void 0,pointForward:isSet$c(a.pointForward)?!!a.pointForward:!1,pointBackward:isSet$c(a.pointBackward)?!!a.pointBackward:!1}},toJSON(a){const e={};return a.start!==void 0&&(e.start=a.start?VectorProperty.toJSON(a.start):void 0),a.end!==void 0&&(e.end=a.end?VectorProperty.toJSON(a.end):void 0),a.lineWidth!==void 0&&(e.lineWidth=a.lineWidth?ScalarProperty.toJSON(a.lineWidth):void 0),a.color!==void 0&&(e.color=a.color?ColorProperty.toJSON(a.color):void 0),a.pointForward!==void 0&&(e.pointForward=a.pointForward),a.pointBackward!==void 0&&(e.pointBackward=a.pointBackward),e},create(a){return Line$1.fromPartial(a??{})},fromPartial(a){const e=createBaseLine();return e.start=a.start!==void 0&&a.start!==null?VectorProperty.fromPartial(a.start):void 0,e.end=a.end!==void 0&&a.end!==null?VectorProperty.fromPartial(a.end):void 0,e.lineWidth=a.lineWidth!==void 0&&a.lineWidth!==null?ScalarProperty.fromPartial(a.lineWidth):void 0,e.color=a.color!==void 0&&a.color!==null?ColorProperty.fromPartial(a.color):void 0,e.pointForward=a.pointForward??!1,e.pointBackward=a.pointBackward??!1,e}};function isSet$c(a){return a!=null}var TextPosition=(a=>(a[a.CENTER=0]="CENTER",a[a.UPPER_RIGHT=1]="UPPER_RIGHT",a[a.TOP=2]="TOP",a[a.UPPER_LEFT=3]="UPPER_LEFT",a[a.LEFT=4]="LEFT",a[a.LOWER_LEFT=5]="LOWER_LEFT",a[a.BOTTOM=6]="BOTTOM",a[a.LOWER_RIGHT=7]="LOWER_RIGHT",a[a.RIGHT=8]="RIGHT",a[a.UNRECOGNIZED=-1]="UNRECOGNIZED",a))(TextPosition||{});function textPositionFromJSON(a){switch(a){case 0:case"CENTER":return 0;case 1:case"UPPER_RIGHT":return 1;case 2:case"TOP":return 2;case 3:case"UPPER_LEFT":return 3;case 4:case"LEFT":return 4;case 5:case"LOWER_LEFT":return 5;case 6:case"BOTTOM":return 6;case 7:case"LOWER_RIGHT":return 7;case 8:case"RIGHT":return 8;case-1:case"UNRECOGNIZED":default:return-1}}function textPositionToJSON(a){switch(a){case 0:return"CENTER";case 1:return"UPPER_RIGHT";case 2:return"TOP";case 3:return"UPPER_LEFT";case 4:return"LEFT";case 5:return"LOWER_LEFT";case 6:return"BOTTOM";case 7:return"LOWER_RIGHT";case 8:return"RIGHT";case-1:default:return"UNRECOGNIZED"}}function createBaseOverlay(){return{text:"",position:0,fontSize:void 0,bold:!1,italic:!1}}const Overlay={encode(a,e=_m0.Writer.create()){return a.text!==""&&e.uint32(10).string(a.text),a.position!==0&&e.uint32(16).int32(a.position),a.fontSize!==void 0&&ScalarProperty.encode(a.fontSize,e.uint32(26).fork()).ldelim(),a.bold===!0&&e.uint32(32).bool(a.bold),a.italic===!0&&e.uint32(40).bool(a.italic),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseOverlay();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.text=t.string();continue;case 2:if(s!==16)break;r.position=t.int32();continue;case 3:if(s!==26)break;r.fontSize=ScalarProperty.decode(t,t.uint32());continue;case 4:if(s!==32)break;r.bold=t.bool();continue;case 5:if(s!==40)break;r.italic=t.bool();continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{text:isSet$b(a.text)?String(a.text):"",position:isSet$b(a.position)?textPositionFromJSON(a.position):0,fontSize:isSet$b(a.fontSize)?ScalarProperty.fromJSON(a.fontSize):void 0,bold:isSet$b(a.bold)?!!a.bold:!1,italic:isSet$b(a.italic)?!!a.italic:!1}},toJSON(a){const e={};return a.text!==void 0&&(e.text=a.text),a.position!==void 0&&(e.position=textPositionToJSON(a.position)),a.fontSize!==void 0&&(e.fontSize=a.fontSize?ScalarProperty.toJSON(a.fontSize):void 0),a.bold!==void 0&&(e.bold=a.bold),a.italic!==void 0&&(e.italic=a.italic),e},create(a){return Overlay.fromPartial(a??{})},fromPartial(a){const e=createBaseOverlay();return e.text=a.text??"",e.position=a.position??0,e.fontSize=a.fontSize!==void 0&&a.fontSize!==null?ScalarProperty.fromPartial(a.fontSize):void 0,e.bold=a.bold??!1,e.italic=a.italic??!1,e}};function isSet$b(a){return a!=null}function createBasePrism(){return{position:void 0,normal:void 0,rotation:void 0,radius:void 0,height:void 0,nVertices:0,color:void 0}}const Prism={encode(a,e=_m0.Writer.create()){return a.position!==void 0&&VectorProperty.encode(a.position,e.uint32(10).fork()).ldelim(),a.normal!==void 0&&VectorProperty.encode(a.normal,e.uint32(18).fork()).ldelim(),a.rotation!==void 0&&ScalarProperty.encode(a.rotation,e.uint32(26).fork()).ldelim(),a.radius!==void 0&&ScalarProperty.encode(a.radius,e.uint32(34).fork()).ldelim(),a.height!==void 0&&ScalarProperty.encode(a.height,e.uint32(42).fork()).ldelim(),a.nVertices!==0&&e.uint32(48).uint32(a.nVertices),a.color!==void 0&&ColorProperty.encode(a.color,e.uint32(58).fork()).ldelim(),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBasePrism();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.position=VectorProperty.decode(t,t.uint32());continue;case 2:if(s!==18)break;r.normal=VectorProperty.decode(t,t.uint32());continue;case 3:if(s!==26)break;r.rotation=ScalarProperty.decode(t,t.uint32());continue;case 4:if(s!==34)break;r.radius=ScalarProperty.decode(t,t.uint32());continue;case 5:if(s!==42)break;r.height=ScalarProperty.decode(t,t.uint32());continue;case 6:if(s!==48)break;r.nVertices=t.uint32();continue;case 7:if(s!==58)break;r.color=ColorProperty.decode(t,t.uint32());continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{position:isSet$a(a.position)?VectorProperty.fromJSON(a.position):void 0,normal:isSet$a(a.normal)?VectorProperty.fromJSON(a.normal):void 0,rotation:isSet$a(a.rotation)?ScalarProperty.fromJSON(a.rotation):void 0,radius:isSet$a(a.radius)?ScalarProperty.fromJSON(a.radius):void 0,height:isSet$a(a.height)?ScalarProperty.fromJSON(a.height):void 0,nVertices:isSet$a(a.nVertices)?Number(a.nVertices):0,color:isSet$a(a.color)?ColorProperty.fromJSON(a.color):void 0}},toJSON(a){const e={};return a.position!==void 0&&(e.position=a.position?VectorProperty.toJSON(a.position):void 0),a.normal!==void 0&&(e.normal=a.normal?VectorProperty.toJSON(a.normal):void 0),a.rotation!==void 0&&(e.rotation=a.rotation?ScalarProperty.toJSON(a.rotation):void 0),a.radius!==void 0&&(e.radius=a.radius?ScalarProperty.toJSON(a.radius):void 0),a.height!==void 0&&(e.height=a.height?ScalarProperty.toJSON(a.height):void 0),a.nVertices!==void 0&&(e.nVertices=Math.round(a.nVertices)),a.color!==void 0&&(e.color=a.color?ColorProperty.toJSON(a.color):void 0),e},create(a){return Prism.fromPartial(a??{})},fromPartial(a){const e=createBasePrism();return e.position=a.position!==void 0&&a.position!==null?VectorProperty.fromPartial(a.position):void 0,e.normal=a.normal!==void 0&&a.normal!==null?VectorProperty.fromPartial(a.normal):void 0,e.rotation=a.rotation!==void 0&&a.rotation!==null?ScalarProperty.fromPartial(a.rotation):void 0,e.radius=a.radius!==void 0&&a.radius!==null?ScalarProperty.fromPartial(a.radius):void 0,e.height=a.height!==void 0&&a.height!==null?ScalarProperty.fromPartial(a.height):void 0,e.nVertices=a.nVertices??0,e.color=a.color!==void 0&&a.color!==null?ColorProperty.fromPartial(a.color):void 0,e}};function isSet$a(a){return a!=null}function createBaseSphere(){return{position:void 0,radius:void 0,color:void 0}}const Sphere={encode(a,e=_m0.Writer.create()){return a.position!==void 0&&VectorProperty.encode(a.position,e.uint32(10).fork()).ldelim(),a.radius!==void 0&&ScalarProperty.encode(a.radius,e.uint32(18).fork()).ldelim(),a.color!==void 0&&ColorProperty.encode(a.color,e.uint32(26).fork()).ldelim(),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseSphere();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.position=VectorProperty.decode(t,t.uint32());continue;case 2:if(s!==18)break;r.radius=ScalarProperty.decode(t,t.uint32());continue;case 3:if(s!==26)break;r.color=ColorProperty.decode(t,t.uint32());continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{position:isSet$9(a.position)?VectorProperty.fromJSON(a.position):void 0,radius:isSet$9(a.radius)?ScalarProperty.fromJSON(a.radius):void 0,color:isSet$9(a.color)?ColorProperty.fromJSON(a.color):void 0}},toJSON(a){const e={};return a.position!==void 0&&(e.position=a.position?VectorProperty.toJSON(a.position):void 0),a.radius!==void 0&&(e.radius=a.radius?ScalarProperty.toJSON(a.radius):void 0),a.color!==void 0&&(e.color=a.color?ColorProperty.toJSON(a.color):void 0),e},create(a){return Sphere.fromPartial(a??{})},fromPartial(a){const e=createBaseSphere();return e.position=a.position!==void 0&&a.position!==null?VectorProperty.fromPartial(a.position):void 0,e.radius=a.radius!==void 0&&a.radius!==null?ScalarProperty.fromPartial(a.radius):void 0,e.color=a.color!==void 0&&a.color!==null?ColorProperty.fromPartial(a.color):void 0,e}};function isSet$9(a){return a!=null}function createBaseTube(){return{pathId:0,isGrowing:!1,radius:void 0,color:void 0}}const Tube={encode(a,e=_m0.Writer.create()){return a.pathId!==0&&e.uint32(8).uint32(a.pathId),a.isGrowing===!0&&e.uint32(16).bool(a.isGrowing),a.radius!==void 0&&ScalarProperty.encode(a.radius,e.uint32(26).fork()).ldelim(),a.color!==void 0&&ColorProperty.encode(a.color,e.uint32(34).fork()).ldelim(),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseTube();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==8)break;r.pathId=t.uint32();continue;case 2:if(s!==16)break;r.isGrowing=t.bool();continue;case 3:if(s!==26)break;r.radius=ScalarProperty.decode(t,t.uint32());continue;case 4:if(s!==34)break;r.color=ColorProperty.decode(t,t.uint32());continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{pathId:isSet$8(a.pathId)?Number(a.pathId):0,isGrowing:isSet$8(a.isGrowing)?!!a.isGrowing:!1,radius:isSet$8(a.radius)?ScalarProperty.fromJSON(a.radius):void 0,color:isSet$8(a.color)?ColorProperty.fromJSON(a.color):void 0}},toJSON(a){const e={};return a.pathId!==void 0&&(e.pathId=Math.round(a.pathId)),a.isGrowing!==void 0&&(e.isGrowing=a.isGrowing),a.radius!==void 0&&(e.radius=a.radius?ScalarProperty.toJSON(a.radius):void 0),a.color!==void 0&&(e.color=a.color?ColorProperty.toJSON(a.color):void 0),e},create(a){return Tube.fromPartial(a??{})},fromPartial(a){const e=createBaseTube();return e.pathId=a.pathId??0,e.isGrowing=a.isGrowing??!1,e.radius=a.radius!==void 0&&a.radius!==null?ScalarProperty.fromPartial(a.radius):void 0,e.color=a.color!==void 0&&a.color!==null?ColorProperty.fromPartial(a.color):void 0,e}};function isSet$8(a){return a!=null}function createBaseAnimatible(){return{name:"",groups:[],description:"",instance:void 0}}const Animatible={encode(a,e=_m0.Writer.create()){var t;a.name!==""&&e.uint32(10).string(a.name);for(const i of a.groups)e.uint32(18).string(i);switch(a.description!==""&&e.uint32(26).string(a.description),(t=a.instance)==null?void 0:t.$case){case"sphere":Sphere.encode(a.instance.sphere,e.uint32(130).fork()).ldelim();break;case"line":Line$1.encode(a.instance.line,e.uint32(138).fork()).ldelim();break;case"tube":Tube.encode(a.instance.tube,e.uint32(146).fork()).ldelim();break;case"overlay":Overlay.encode(a.instance.overlay,e.uint32(154).fork()).ldelim();break;case"prism":Prism.encode(a.instance.prism,e.uint32(162).fork()).ldelim();break}return e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseAnimatible();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.name=t.string();continue;case 2:if(s!==18)break;r.groups.push(t.string());continue;case 3:if(s!==26)break;r.description=t.string();continue;case 16:if(s!==130)break;r.instance={$case:"sphere",sphere:Sphere.decode(t,t.uint32())};continue;case 17:if(s!==138)break;r.instance={$case:"line",line:Line$1.decode(t,t.uint32())};continue;case 18:if(s!==146)break;r.instance={$case:"tube",tube:Tube.decode(t,t.uint32())};continue;case 19:if(s!==154)break;r.instance={$case:"overlay",overlay:Overlay.decode(t,t.uint32())};continue;case 20:if(s!==162)break;r.instance={$case:"prism",prism:Prism.decode(t,t.uint32())};continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{name:isSet$7(a.name)?String(a.name):"",groups:Array.isArray(a==null?void 0:a.groups)?a.groups.map(e=>String(e)):[],description:isSet$7(a.description)?String(a.description):"",instance:isSet$7(a.sphere)?{$case:"sphere",sphere:Sphere.fromJSON(a.sphere)}:isSet$7(a.line)?{$case:"line",line:Line$1.fromJSON(a.line)}:isSet$7(a.tube)?{$case:"tube",tube:Tube.fromJSON(a.tube)}:isSet$7(a.overlay)?{$case:"overlay",overlay:Overlay.fromJSON(a.overlay)}:isSet$7(a.prism)?{$case:"prism",prism:Prism.fromJSON(a.prism)}:void 0}},toJSON(a){var t,i,r,s,n,o,l,h,u,c,d,f,_,g,p;const e={};return a.name!==void 0&&(e.name=a.name),a.groups?e.groups=a.groups.map(m=>m):e.groups=[],a.description!==void 0&&(e.description=a.description),((t=a.instance)==null?void 0:t.$case)==="sphere"&&(e.sphere=(i=a.instance)!=null&&i.sphere?Sphere.toJSON((r=a.instance)==null?void 0:r.sphere):void 0),((s=a.instance)==null?void 0:s.$case)==="line"&&(e.line=(n=a.instance)!=null&&n.line?Line$1.toJSON((o=a.instance)==null?void 0:o.line):void 0),((l=a.instance)==null?void 0:l.$case)==="tube"&&(e.tube=(h=a.instance)!=null&&h.tube?Tube.toJSON((u=a.instance)==null?void 0:u.tube):void 0),((c=a.instance)==null?void 0:c.$case)==="overlay"&&(e.overlay=(d=a.instance)!=null&&d.overlay?Overlay.toJSON((f=a.instance)==null?void 0:f.overlay):void 0),((_=a.instance)==null?void 0:_.$case)==="prism"&&(e.prism=(g=a.instance)!=null&&g.prism?Prism.toJSON((p=a.instance)==null?void 0:p.prism):void 0),e},create(a){return Animatible.fromPartial(a??{})},fromPartial(a){var t,i,r,s,n,o,l,h,u,c,d,f,_,g,p,m;const e=createBaseAnimatible();return e.name=a.name??"",e.groups=((t=a.groups)==null?void 0:t.map(E=>E))||[],e.description=a.description??"",((i=a.instance)==null?void 0:i.$case)==="sphere"&&((r=a.instance)==null?void 0:r.sphere)!==void 0&&((s=a.instance)==null?void 0:s.sphere)!==null&&(e.instance={$case:"sphere",sphere:Sphere.fromPartial(a.instance.sphere)}),((n=a.instance)==null?void 0:n.$case)==="line"&&((o=a.instance)==null?void 0:o.line)!==void 0&&((l=a.instance)==null?void 0:l.line)!==null&&(e.instance={$case:"line",line:Line$1.fromPartial(a.instance.line)}),((h=a.instance)==null?void 0:h.$case)==="tube"&&((u=a.instance)==null?void 0:u.tube)!==void 0&&((c=a.instance)==null?void 0:c.tube)!==null&&(e.instance={$case:"tube",tube:Tube.fromPartial(a.instance.tube)}),((d=a.instance)==null?void 0:d.$case)==="overlay"&&((f=a.instance)==null?void 0:f.overlay)!==void 0&&((_=a.instance)==null?void 0:_.overlay)!==null&&(e.instance={$case:"overlay",overlay:Overlay.fromPartial(a.instance.overlay)}),((g=a.instance)==null?void 0:g.$case)==="prism"&&((p=a.instance)==null?void 0:p.prism)!==void 0&&((m=a.instance)==null?void 0:m.prism)!==null&&(e.instance={$case:"prism",prism:Prism.fromPartial(a.instance.prism)}),e}};function isSet$7(a){return a!=null}function createBaseCamera(){return{position:void 0,target:void 0}}const Camera$1={encode(a,e=_m0.Writer.create()){return a.position!==void 0&&Vector.encode(a.position,e.uint32(10).fork()).ldelim(),a.target!==void 0&&Vector.encode(a.target,e.uint32(18).fork()).ldelim(),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseCamera();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.position=Vector.decode(t,t.uint32());continue;case 2:if(s!==18)break;r.target=Vector.decode(t,t.uint32());continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{position:isSet$6(a.position)?Vector.fromJSON(a.position):void 0,target:isSet$6(a.target)?Vector.fromJSON(a.target):void 0}},toJSON(a){const e={};return a.position!==void 0&&(e.position=a.position?Vector.toJSON(a.position):void 0),a.target!==void 0&&(e.target=a.target?Vector.toJSON(a.target):void 0),e},create(a){return Camera$1.fromPartial(a??{})},fromPartial(a){const e=createBaseCamera();return e.position=a.position!==void 0&&a.position!==null?Vector.fromPartial(a.position):void 0,e.target=a.target!==void 0&&a.target!==null?Vector.fromPartial(a.target):void 0,e}};function isSet$6(a){return a!=null}function createBaseColorMap(){return{stops:[]}}const ColorMap={encode(a,e=_m0.Writer.create()){for(const t of a.stops)ColorMap_Stop.encode(t,e.uint32(10).fork()).ldelim();return e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseColorMap();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.stops.push(ColorMap_Stop.decode(t,t.uint32()));continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{stops:Array.isArray(a==null?void 0:a.stops)?a.stops.map(e=>ColorMap_Stop.fromJSON(e)):[]}},toJSON(a){const e={};return a.stops?e.stops=a.stops.map(t=>t?ColorMap_Stop.toJSON(t):void 0):e.stops=[],e},create(a){return ColorMap.fromPartial(a??{})},fromPartial(a){var t;const e=createBaseColorMap();return e.stops=((t=a.stops)==null?void 0:t.map(i=>ColorMap_Stop.fromPartial(i)))||[],e}};function createBaseColorMap_Stop(){return{value:0,color:void 0}}const ColorMap_Stop={encode(a,e=_m0.Writer.create()){return a.value!==0&&e.uint32(9).double(a.value),a.color!==void 0&&Color.encode(a.color,e.uint32(18).fork()).ldelim(),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseColorMap_Stop();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==9)break;r.value=t.double();continue;case 2:if(s!==18)break;r.color=Color.decode(t,t.uint32());continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{value:isSet$5(a.value)?Number(a.value):0,color:isSet$5(a.color)?Color.fromJSON(a.color):void 0}},toJSON(a){const e={};return a.value!==void 0&&(e.value=a.value),a.color!==void 0&&(e.color=a.color?Color.toJSON(a.color):void 0),e},create(a){return ColorMap_Stop.fromPartial(a??{})},fromPartial(a){const e=createBaseColorMap_Stop();return e.value=a.value??0,e.color=a.color!==void 0&&a.color!==null?Color.fromPartial(a.color):void 0,e}};function isSet$5(a){return a!=null}var Interpolation=(a=>(a[a.LINEAR=0]="LINEAR",a[a.HOLD=1]="HOLD",a[a.AHEAD=2]="AHEAD",a[a.STEP=3]="STEP",a[a.UNRECOGNIZED=-1]="UNRECOGNIZED",a))(Interpolation||{});function interpolationFromJSON(a){switch(a){case 0:case"LINEAR":return 0;case 1:case"HOLD":return 1;case 2:case"AHEAD":return 2;case 3:case"STEP":return 3;case-1:case"UNRECOGNIZED":default:return-1}}function interpolationToJSON(a){switch(a){case 0:return"LINEAR";case 1:return"HOLD";case 2:return"AHEAD";case 3:return"STEP";case-1:default:return"UNRECOGNIZED"}}function createBaseGraph(){return{name:"",id:0,points:[],interpolation:0}}const Graph={encode(a,e=_m0.Writer.create()){a.name!==""&&e.uint32(10).string(a.name),a.id!==0&&e.uint32(16).uint32(a.id);for(const t of a.points)Graph_Point.encode(t,e.uint32(26).fork()).ldelim();return a.interpolation!==0&&e.uint32(32).int32(a.interpolation),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseGraph();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.name=t.string();continue;case 2:if(s!==16)break;r.id=t.uint32();continue;case 3:if(s!==26)break;r.points.push(Graph_Point.decode(t,t.uint32()));continue;case 4:if(s!==32)break;r.interpolation=t.int32();continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{name:isSet$4(a.name)?String(a.name):"",id:isSet$4(a.id)?Number(a.id):0,points:Array.isArray(a==null?void 0:a.points)?a.points.map(e=>Graph_Point.fromJSON(e)):[],interpolation:isSet$4(a.interpolation)?interpolationFromJSON(a.interpolation):0}},toJSON(a){const e={};return a.name!==void 0&&(e.name=a.name),a.id!==void 0&&(e.id=Math.round(a.id)),a.points?e.points=a.points.map(t=>t?Graph_Point.toJSON(t):void 0):e.points=[],a.interpolation!==void 0&&(e.interpolation=interpolationToJSON(a.interpolation)),e},create(a){return Graph.fromPartial(a??{})},fromPartial(a){var t;const e=createBaseGraph();return e.name=a.name??"",e.id=a.id??0,e.points=((t=a.points)==null?void 0:t.map(i=>Graph_Point.fromPartial(i)))||[],e.interpolation=a.interpolation??0,e}};function createBaseGraph_Point(){return{time:0,value:0}}const Graph_Point={encode(a,e=_m0.Writer.create()){return a.time!==0&&e.uint32(9).double(a.time),a.value!==0&&e.uint32(17).double(a.value),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseGraph_Point();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==9)break;r.time=t.double();continue;case 2:if(s!==17)break;r.value=t.double();continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{time:isSet$4(a.time)?Number(a.time):0,value:isSet$4(a.value)?Number(a.value):0}},toJSON(a){const e={};return a.time!==void 0&&(e.time=a.time),a.value!==void 0&&(e.value=a.value),e},create(a){return Graph_Point.fromPartial(a??{})},fromPartial(a){const e=createBaseGraph_Point();return e.time=a.time??0,e.value=a.value??0,e}};function isSet$4(a){return a!=null}var long=Long,wasm=null;try{wasm=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(a){}function Long(a,e,t){this.low=a|0,this.high=e|0,this.unsigned=!!t}Long.prototype.__isLong__;Object.defineProperty(Long.prototype,"__isLong__",{value:!0});function isLong(a){return(a&&a.__isLong__)===!0}Long.isLong=isLong;var INT_CACHE={},UINT_CACHE={};function fromInt(a,e){var t,i,r;return e?(a>>>=0,(r=0<=a&&a<256)&&(i=UINT_CACHE[a],i)?i:(t=fromBits(a,(a|0)<0?-1:0,!0),r&&(UINT_CACHE[a]=t),t)):(a|=0,(r=-128<=a&&a<128)&&(i=INT_CACHE[a],i)?i:(t=fromBits(a,a<0?-1:0,!1),r&&(INT_CACHE[a]=t),t))}Long.fromInt=fromInt;function fromNumber(a,e){if(isNaN(a))return e?UZERO:ZERO;if(e){if(a<0)return UZERO;if(a>=TWO_PWR_64_DBL)return MAX_UNSIGNED_VALUE}else{if(a<=-TWO_PWR_63_DBL)return MIN_VALUE;if(a+1>=TWO_PWR_63_DBL)return MAX_VALUE}return a<0?fromNumber(-a,e).neg():fromBits(a%TWO_PWR_32_DBL|0,a/TWO_PWR_32_DBL|0,e)}Long.fromNumber=fromNumber;function fromBits(a,e,t){return new Long(a,e,t)}Long.fromBits=fromBits;var pow_dbl=Math.pow;function fromString(a,e,t){if(a.length===0)throw Error("empty string");if(a==="NaN"||a==="Infinity"||a==="+Infinity"||a==="-Infinity")return ZERO;if(typeof e=="number"?(t=e,e=!1):e=!!e,t=t||10,t<2||36<t)throw RangeError("radix");var i;if((i=a.indexOf("-"))>0)throw Error("interior hyphen");if(i===0)return fromString(a.substring(1),e,t).neg();for(var r=fromNumber(pow_dbl(t,8)),s=ZERO,n=0;n<a.length;n+=8){var o=Math.min(8,a.length-n),l=parseInt(a.substring(n,n+o),t);if(o<8){var h=fromNumber(pow_dbl(t,o));s=s.mul(h).add(fromNumber(l))}else s=s.mul(r),s=s.add(fromNumber(l))}return s.unsigned=e,s}Long.fromString=fromString;function fromValue(a,e){return typeof a=="number"?fromNumber(a,e):typeof a=="string"?fromString(a,e):fromBits(a.low,a.high,typeof e=="boolean"?e:a.unsigned)}Long.fromValue=fromValue;var TWO_PWR_16_DBL=65536,TWO_PWR_24_DBL=1<<24,TWO_PWR_32_DBL=TWO_PWR_16_DBL*TWO_PWR_16_DBL,TWO_PWR_64_DBL=TWO_PWR_32_DBL*TWO_PWR_32_DBL,TWO_PWR_63_DBL=TWO_PWR_64_DBL/2,TWO_PWR_24=fromInt(TWO_PWR_24_DBL),ZERO=fromInt(0);Long.ZERO=ZERO;var UZERO=fromInt(0,!0);Long.UZERO=UZERO;var ONE=fromInt(1);Long.ONE=ONE;var UONE=fromInt(1,!0);Long.UONE=UONE;var NEG_ONE=fromInt(-1);Long.NEG_ONE=NEG_ONE;var MAX_VALUE=fromBits(-1,2147483647,!1);Long.MAX_VALUE=MAX_VALUE;var MAX_UNSIGNED_VALUE=fromBits(-1,-1,!0);Long.MAX_UNSIGNED_VALUE=MAX_UNSIGNED_VALUE;var MIN_VALUE=fromBits(0,-2147483648,!1);Long.MIN_VALUE=MIN_VALUE;var LongPrototype=Long.prototype;LongPrototype.toInt=function a(){return this.unsigned?this.low>>>0:this.low};LongPrototype.toNumber=function a(){return this.unsigned?(this.high>>>0)*TWO_PWR_32_DBL+(this.low>>>0):this.high*TWO_PWR_32_DBL+(this.low>>>0)};LongPrototype.toString=function a(e){if(e=e||10,e<2||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative())if(this.eq(MIN_VALUE)){var t=fromNumber(e),i=this.div(t),r=i.mul(t).sub(this);return i.toString(e)+r.toInt().toString(e)}else return"-"+this.neg().toString(e);for(var s=fromNumber(pow_dbl(e,6),this.unsigned),n=this,o="";;){var l=n.div(s),h=n.sub(l.mul(s)).toInt()>>>0,u=h.toString(e);if(n=l,n.isZero())return u+o;for(;u.length<6;)u="0"+u;o=""+u+o}};LongPrototype.getHighBits=function a(){return this.high};LongPrototype.getHighBitsUnsigned=function a(){return this.high>>>0};LongPrototype.getLowBits=function a(){return this.low};LongPrototype.getLowBitsUnsigned=function a(){return this.low>>>0};LongPrototype.getNumBitsAbs=function a(){if(this.isNegative())return this.eq(MIN_VALUE)?64:this.neg().getNumBitsAbs();for(var e=this.high!=0?this.high:this.low,t=31;t>0&&!(e&1<<t);t--);return this.high!=0?t+33:t+1};LongPrototype.isZero=function a(){return this.high===0&&this.low===0};LongPrototype.eqz=LongPrototype.isZero;LongPrototype.isNegative=function a(){return!this.unsigned&&this.high<0};LongPrototype.isPositive=function a(){return this.unsigned||this.high>=0};LongPrototype.isOdd=function a(){return(this.low&1)===1};LongPrototype.isEven=function a(){return(this.low&1)===0};LongPrototype.equals=function a(e){return isLong(e)||(e=fromValue(e)),this.unsigned!==e.unsigned&&this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low};LongPrototype.eq=LongPrototype.equals;LongPrototype.notEquals=function a(e){return!this.eq(e)};LongPrototype.neq=LongPrototype.notEquals;LongPrototype.ne=LongPrototype.notEquals;LongPrototype.lessThan=function a(e){return this.comp(e)<0};LongPrototype.lt=LongPrototype.lessThan;LongPrototype.lessThanOrEqual=function a(e){return this.comp(e)<=0};LongPrototype.lte=LongPrototype.lessThanOrEqual;LongPrototype.le=LongPrototype.lessThanOrEqual;LongPrototype.greaterThan=function a(e){return this.comp(e)>0};LongPrototype.gt=LongPrototype.greaterThan;LongPrototype.greaterThanOrEqual=function a(e){return this.comp(e)>=0};LongPrototype.gte=LongPrototype.greaterThanOrEqual;LongPrototype.ge=LongPrototype.greaterThanOrEqual;LongPrototype.compare=function a(e){if(isLong(e)||(e=fromValue(e)),this.eq(e))return 0;var t=this.isNegative(),i=e.isNegative();return t&&!i?-1:!t&&i?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1};LongPrototype.comp=LongPrototype.compare;LongPrototype.negate=function a(){return!this.unsigned&&this.eq(MIN_VALUE)?MIN_VALUE:this.not().add(ONE)};LongPrototype.neg=LongPrototype.negate;LongPrototype.add=function a(e){isLong(e)||(e=fromValue(e));var t=this.high>>>16,i=this.high&65535,r=this.low>>>16,s=this.low&65535,n=e.high>>>16,o=e.high&65535,l=e.low>>>16,h=e.low&65535,u=0,c=0,d=0,f=0;return f+=s+h,d+=f>>>16,f&=65535,d+=r+l,c+=d>>>16,d&=65535,c+=i+o,u+=c>>>16,c&=65535,u+=t+n,u&=65535,fromBits(d<<16|f,u<<16|c,this.unsigned)};LongPrototype.subtract=function a(e){return isLong(e)||(e=fromValue(e)),this.add(e.neg())};LongPrototype.sub=LongPrototype.subtract;LongPrototype.multiply=function a(e){if(this.isZero())return ZERO;if(isLong(e)||(e=fromValue(e)),wasm){var t=wasm.mul(this.low,this.high,e.low,e.high);return fromBits(t,wasm.get_high(),this.unsigned)}if(e.isZero())return ZERO;if(this.eq(MIN_VALUE))return e.isOdd()?MIN_VALUE:ZERO;if(e.eq(MIN_VALUE))return this.isOdd()?MIN_VALUE:ZERO;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(TWO_PWR_24)&&e.lt(TWO_PWR_24))return fromNumber(this.toNumber()*e.toNumber(),this.unsigned);var i=this.high>>>16,r=this.high&65535,s=this.low>>>16,n=this.low&65535,o=e.high>>>16,l=e.high&65535,h=e.low>>>16,u=e.low&65535,c=0,d=0,f=0,_=0;return _+=n*u,f+=_>>>16,_&=65535,f+=s*u,d+=f>>>16,f&=65535,f+=n*h,d+=f>>>16,f&=65535,d+=r*u,c+=d>>>16,d&=65535,d+=s*h,c+=d>>>16,d&=65535,d+=n*l,c+=d>>>16,d&=65535,c+=i*u+r*h+s*l+n*o,c&=65535,fromBits(f<<16|_,c<<16|d,this.unsigned)};LongPrototype.mul=LongPrototype.multiply;LongPrototype.divide=function a(e){if(isLong(e)||(e=fromValue(e)),e.isZero())throw Error("division by zero");if(wasm){if(!this.unsigned&&this.high===-2147483648&&e.low===-1&&e.high===-1)return this;var t=(this.unsigned?wasm.div_u:wasm.div_s)(this.low,this.high,e.low,e.high);return fromBits(t,wasm.get_high(),this.unsigned)}if(this.isZero())return this.unsigned?UZERO:ZERO;var i,r,s;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return UZERO;if(e.gt(this.shru(1)))return UONE;s=UZERO}else{if(this.eq(MIN_VALUE)){if(e.eq(ONE)||e.eq(NEG_ONE))return MIN_VALUE;if(e.eq(MIN_VALUE))return ONE;var n=this.shr(1);return i=n.div(e).shl(1),i.eq(ZERO)?e.isNegative()?ONE:NEG_ONE:(r=this.sub(e.mul(i)),s=i.add(r.div(e)),s)}else if(e.eq(MIN_VALUE))return this.unsigned?UZERO:ZERO;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();s=ZERO}for(r=this;r.gte(e);){i=Math.max(1,Math.floor(r.toNumber()/e.toNumber()));for(var o=Math.ceil(Math.log(i)/Math.LN2),l=o<=48?1:pow_dbl(2,o-48),h=fromNumber(i),u=h.mul(e);u.isNegative()||u.gt(r);)i-=l,h=fromNumber(i,this.unsigned),u=h.mul(e);h.isZero()&&(h=ONE),s=s.add(h),r=r.sub(u)}return s};LongPrototype.div=LongPrototype.divide;LongPrototype.modulo=function a(e){if(isLong(e)||(e=fromValue(e)),wasm){var t=(this.unsigned?wasm.rem_u:wasm.rem_s)(this.low,this.high,e.low,e.high);return fromBits(t,wasm.get_high(),this.unsigned)}return this.sub(this.div(e).mul(e))};LongPrototype.mod=LongPrototype.modulo;LongPrototype.rem=LongPrototype.modulo;LongPrototype.not=function a(){return fromBits(~this.low,~this.high,this.unsigned)};LongPrototype.and=function a(e){return isLong(e)||(e=fromValue(e)),fromBits(this.low&e.low,this.high&e.high,this.unsigned)};LongPrototype.or=function a(e){return isLong(e)||(e=fromValue(e)),fromBits(this.low|e.low,this.high|e.high,this.unsigned)};LongPrototype.xor=function a(e){return isLong(e)||(e=fromValue(e)),fromBits(this.low^e.low,this.high^e.high,this.unsigned)};LongPrototype.shiftLeft=function a(e){return isLong(e)&&(e=e.toInt()),(e&=63)===0?this:e<32?fromBits(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):fromBits(0,this.low<<e-32,this.unsigned)};LongPrototype.shl=LongPrototype.shiftLeft;LongPrototype.shiftRight=function a(e){return isLong(e)&&(e=e.toInt()),(e&=63)===0?this:e<32?fromBits(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):fromBits(this.high>>e-32,this.high>=0?0:-1,this.unsigned)};LongPrototype.shr=LongPrototype.shiftRight;LongPrototype.shiftRightUnsigned=function a(e){if(isLong(e)&&(e=e.toInt()),e&=63,e===0)return this;var t=this.high;if(e<32){var i=this.low;return fromBits(i>>>e|t<<32-e,t>>>e,this.unsigned)}else return e===32?fromBits(t,0,this.unsigned):fromBits(t>>>e-32,0,this.unsigned)};LongPrototype.shru=LongPrototype.shiftRightUnsigned;LongPrototype.shr_u=LongPrototype.shiftRightUnsigned;LongPrototype.toSigned=function a(){return this.unsigned?fromBits(this.low,this.high,!1):this};LongPrototype.toUnsigned=function a(){return this.unsigned?this:fromBits(this.low,this.high,!0)};LongPrototype.toBytes=function a(e){return e?this.toBytesLE():this.toBytesBE()};LongPrototype.toBytesLE=function a(){var e=this.high,t=this.low;return[t&255,t>>>8&255,t>>>16&255,t>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]};LongPrototype.toBytesBE=function a(){var e=this.high,t=this.low;return[e>>>24,e>>>16&255,e>>>8&255,e&255,t>>>24,t>>>16&255,t>>>8&255,t&255]};Long.fromBytes=function a(e,t,i){return i?Long.fromBytesLE(e,t):Long.fromBytesBE(e,t)};Long.fromBytesLE=function a(e,t){return new Long(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24,t)};Long.fromBytesBE=function a(e,t){return new Long(e[4]<<24|e[5]<<16|e[6]<<8|e[7],e[0]<<24|e[1]<<16|e[2]<<8|e[3],t)};var Long$1=getDefaultExportFromCjs(long);function createBaseTimestamp(){return{seconds:0,nanos:0}}const Timestamp={encode(a,e=_m0.Writer.create()){return a.seconds!==0&&e.uint32(8).int64(a.seconds),a.nanos!==0&&e.uint32(16).int32(a.nanos),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseTimestamp();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==8)break;r.seconds=longToNumber(t.int64());continue;case 2:if(s!==16)break;r.nanos=t.int32();continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{seconds:isSet$3(a.seconds)?Number(a.seconds):0,nanos:isSet$3(a.nanos)?Number(a.nanos):0}},toJSON(a){const e={};return a.seconds!==void 0&&(e.seconds=Math.round(a.seconds)),a.nanos!==void 0&&(e.nanos=Math.round(a.nanos)),e},create(a){return Timestamp.fromPartial(a??{})},fromPartial(a){const e=createBaseTimestamp();return e.seconds=a.seconds??0,e.nanos=a.nanos??0,e}};var tsProtoGlobalThis=(()=>{if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw"Unable to locate global object"})();function longToNumber(a){if(a.gt(Number.MAX_SAFE_INTEGER))throw new tsProtoGlobalThis.Error("Value is larger than Number.MAX_SAFE_INTEGER");return a.toNumber()}_m0.util.Long!==Long$1&&(_m0.util.Long=Long$1,_m0.configure());function isSet$3(a){return a!=null}function createBaseProjectMeta(){return{name:"",author:"",date:void 0,startTime:0,endTime:0,speedRatio:0,description:""}}const ProjectMeta={encode(a,e=_m0.Writer.create()){return a.name!==""&&e.uint32(10).string(a.name),a.author!==""&&e.uint32(18).string(a.author),a.date!==void 0&&Timestamp.encode(a.date,e.uint32(26).fork()).ldelim(),a.startTime!==0&&e.uint32(33).double(a.startTime),a.endTime!==0&&e.uint32(41).double(a.endTime),a.speedRatio!==0&&e.uint32(49).double(a.speedRatio),a.description!==""&&e.uint32(58).string(a.description),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseProjectMeta();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.name=t.string();continue;case 2:if(s!==18)break;r.author=t.string();continue;case 3:if(s!==26)break;r.date=Timestamp.decode(t,t.uint32());continue;case 4:if(s!==33)break;r.startTime=t.double();continue;case 5:if(s!==41)break;r.endTime=t.double();continue;case 6:if(s!==49)break;r.speedRatio=t.double();continue;case 7:if(s!==58)break;r.description=t.string();continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{name:isSet$2(a.name)?String(a.name):"",author:isSet$2(a.author)?String(a.author):"",date:isSet$2(a.date)?fromJsonTimestamp(a.date):void 0,startTime:isSet$2(a.startTime)?Number(a.startTime):0,endTime:isSet$2(a.endTime)?Number(a.endTime):0,speedRatio:isSet$2(a.speedRatio)?Number(a.speedRatio):0,description:isSet$2(a.description)?String(a.description):""}},toJSON(a){const e={};return a.name!==void 0&&(e.name=a.name),a.author!==void 0&&(e.author=a.author),a.date!==void 0&&(e.date=fromTimestamp(a.date).toISOString()),a.startTime!==void 0&&(e.startTime=a.startTime),a.endTime!==void 0&&(e.endTime=a.endTime),a.speedRatio!==void 0&&(e.speedRatio=a.speedRatio),a.description!==void 0&&(e.description=a.description),e},create(a){return ProjectMeta.fromPartial(a??{})},fromPartial(a){const e=createBaseProjectMeta();return e.name=a.name??"",e.author=a.author??"",e.date=a.date!==void 0&&a.date!==null?Timestamp.fromPartial(a.date):void 0,e.startTime=a.startTime??0,e.endTime=a.endTime??0,e.speedRatio=a.speedRatio??0,e.description=a.description??"",e}};function toTimestamp(a){const e=a.getTime()/1e3,t=a.getTime()%1e3*1e6;return{seconds:e,nanos:t}}function fromTimestamp(a){let e=(a.seconds||0)*1e3;return e+=(a.nanos||0)/1e6,new Date(e)}function fromJsonTimestamp(a){return a instanceof Date?toTimestamp(a):typeof a=="string"?toTimestamp(new Date(a)):Timestamp.fromJSON(a)}function isSet$2(a){return a!=null}function createBasePath(){return{name:"",id:0,points:[],interpolation:0}}const Path={encode(a,e=_m0.Writer.create()){a.name!==""&&e.uint32(10).string(a.name),a.id!==0&&e.uint32(16).uint32(a.id);for(const t of a.points)Path_Point.encode(t,e.uint32(26).fork()).ldelim();return a.interpolation!==0&&e.uint32(32).int32(a.interpolation),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBasePath();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.name=t.string();continue;case 2:if(s!==16)break;r.id=t.uint32();continue;case 3:if(s!==26)break;r.points.push(Path_Point.decode(t,t.uint32()));continue;case 4:if(s!==32)break;r.interpolation=t.int32();continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{name:isSet$1(a.name)?String(a.name):"",id:isSet$1(a.id)?Number(a.id):0,points:Array.isArray(a==null?void 0:a.points)?a.points.map(e=>Path_Point.fromJSON(e)):[],interpolation:isSet$1(a.interpolation)?interpolationFromJSON(a.interpolation):0}},toJSON(a){const e={};return a.name!==void 0&&(e.name=a.name),a.id!==void 0&&(e.id=Math.round(a.id)),a.points?e.points=a.points.map(t=>t?Path_Point.toJSON(t):void 0):e.points=[],a.interpolation!==void 0&&(e.interpolation=interpolationToJSON(a.interpolation)),e},create(a){return Path.fromPartial(a??{})},fromPartial(a){var t;const e=createBasePath();return e.name=a.name??"",e.id=a.id??0,e.points=((t=a.points)==null?void 0:t.map(i=>Path_Point.fromPartial(i)))||[],e.interpolation=a.interpolation??0,e}};function createBasePath_Point(){return{time:0,position:void 0}}const Path_Point={encode(a,e=_m0.Writer.create()){return a.time!==0&&e.uint32(9).double(a.time),a.position!==void 0&&Vector.encode(a.position,e.uint32(18).fork()).ldelim(),e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBasePath_Point();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==9)break;r.time=t.double();continue;case 2:if(s!==18)break;r.position=Vector.decode(t,t.uint32());continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{time:isSet$1(a.time)?Number(a.time):0,position:isSet$1(a.position)?Vector.fromJSON(a.position):void 0}},toJSON(a){const e={};return a.time!==void 0&&(e.time=a.time),a.position!==void 0&&(e.position=a.position?Vector.toJSON(a.position):void 0),e},create(a){return Path_Point.fromPartial(a??{})},fromPartial(a){const e=createBasePath_Point();return e.time=a.time??0,e.position=a.position!==void 0&&a.position!==null?Vector.fromPartial(a.position):void 0,e}};function isSet$1(a){return a!=null}function createBaseProject(){return{meta:void 0,graphs:[],paths:[],colormap:void 0,camera:void 0,hiddenGroups:[],animatibles:[]}}const Project={encode(a,e=_m0.Writer.create()){a.meta!==void 0&&ProjectMeta.encode(a.meta,e.uint32(10).fork()).ldelim();for(const t of a.graphs)Graph.encode(t,e.uint32(18).fork()).ldelim();for(const t of a.paths)Path.encode(t,e.uint32(26).fork()).ldelim();a.colormap!==void 0&&ColorMap.encode(a.colormap,e.uint32(42).fork()).ldelim(),a.camera!==void 0&&Camera$1.encode(a.camera,e.uint32(82).fork()).ldelim();for(const t of a.hiddenGroups)e.uint32(122).string(t);for(const t of a.animatibles)Animatible.encode(t,e.uint32(130).fork()).ldelim();return e},decode(a,e){const t=a instanceof _m0.Reader?a:_m0.Reader.create(a);let i=e===void 0?t.len:t.pos+e;const r=createBaseProject();for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(s!==10)break;r.meta=ProjectMeta.decode(t,t.uint32());continue;case 2:if(s!==18)break;r.graphs.push(Graph.decode(t,t.uint32()));continue;case 3:if(s!==26)break;r.paths.push(Path.decode(t,t.uint32()));continue;case 5:if(s!==42)break;r.colormap=ColorMap.decode(t,t.uint32());continue;case 10:if(s!==82)break;r.camera=Camera$1.decode(t,t.uint32());continue;case 15:if(s!==122)break;r.hiddenGroups.push(t.string());continue;case 16:if(s!==130)break;r.animatibles.push(Animatible.decode(t,t.uint32()));continue}if((s&7)===4||s===0)break;t.skipType(s&7)}return r},fromJSON(a){return{meta:isSet(a.meta)?ProjectMeta.fromJSON(a.meta):void 0,graphs:Array.isArray(a==null?void 0:a.graphs)?a.graphs.map(e=>Graph.fromJSON(e)):[],paths:Array.isArray(a==null?void 0:a.paths)?a.paths.map(e=>Path.fromJSON(e)):[],colormap:isSet(a.colormap)?ColorMap.fromJSON(a.colormap):void 0,camera:isSet(a.camera)?Camera$1.fromJSON(a.camera):void 0,hiddenGroups:Array.isArray(a==null?void 0:a.hiddenGroups)?a.hiddenGroups.map(e=>String(e)):[],animatibles:Array.isArray(a==null?void 0:a.animatibles)?a.animatibles.map(e=>Animatible.fromJSON(e)):[]}},toJSON(a){const e={};return a.meta!==void 0&&(e.meta=a.meta?ProjectMeta.toJSON(a.meta):void 0),a.graphs?e.graphs=a.graphs.map(t=>t?Graph.toJSON(t):void 0):e.graphs=[],a.paths?e.paths=a.paths.map(t=>t?Path.toJSON(t):void 0):e.paths=[],a.colormap!==void 0&&(e.colormap=a.colormap?ColorMap.toJSON(a.colormap):void 0),a.camera!==void 0&&(e.camera=a.camera?Camera$1.toJSON(a.camera):void 0),a.hiddenGroups?e.hiddenGroups=a.hiddenGroups.map(t=>t):e.hiddenGroups=[],a.animatibles?e.animatibles=a.animatibles.map(t=>t?Animatible.toJSON(t):void 0):e.animatibles=[],e},create(a){return Project.fromPartial(a??{})},fromPartial(a){var t,i,r,s;const e=createBaseProject();return e.meta=a.meta!==void 0&&a.meta!==null?ProjectMeta.fromPartial(a.meta):void 0,e.graphs=((t=a.graphs)==null?void 0:t.map(n=>Graph.fromPartial(n)))||[],e.paths=((i=a.paths)==null?void 0:i.map(n=>Path.fromPartial(n)))||[],e.colormap=a.colormap!==void 0&&a.colormap!==null?ColorMap.fromPartial(a.colormap):void 0,e.camera=a.camera!==void 0&&a.camera!==null?Camera$1.fromPartial(a.camera):void 0,e.hiddenGroups=((r=a.hiddenGroups)==null?void 0:r.map(n=>n))||[],e.animatibles=((s=a.animatibles)==null?void 0:s.map(n=>Animatible.fromPartial(n)))||[],e}};function isSet(a){return a!=null}class ArrayTools{static BuildArray(e,t){const i=[];for(let r=0;r<e;++r)i.push(t());return i}static BuildTuple(e,t){return ArrayTools.BuildArray(e,t)}}function _observeArrayfunction(a,e,t){const i=a[e];if(typeof i!="function")return null;const r=function(){const s=a.length,n=r.previous.apply(a,arguments);return t(e,s),n};return i.next=r,r.previous=i,a[e]=r,()=>{const s=r.previous;if(!s)return;const n=r.next;n?(s.next=n,n.previous=s):(s.next=void 0,a[e]=s),r.next=void 0,r.previous=void 0}}const observedArrayFunctions=["push","splice","pop","shift","unshift"];function _ObserveArray(a,e){const t=observedArrayFunctions.map(i=>_observeArrayfunction(a,i,e));return()=>{t.forEach(i=>{i==null||i()})}}class Scalar{static WithinEpsilon(e,t,i=1401298e-51){return Math.abs(e-t)<=i}static ToHex(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}static Sign(e){return e=+e,e===0||isNaN(e)?e:e>0?1:-1}static Clamp(e,t=0,i=1){return Math.min(i,Math.max(t,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(e===0)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e=e*2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}static Repeat(e,t){return e-Math.floor(e/t)*t}static Normalize(e,t,i){return(e-t)/(i-t)}static Denormalize(e,t,i){return e*(i-t)+t}static DeltaAngle(e,t){let i=Scalar.Repeat(t-e,360);return i>180&&(i-=360),i}static PingPong(e,t){const i=Scalar.Repeat(e,t*2);return t-Math.abs(i-t)}static SmoothStep(e,t,i){let r=Scalar.Clamp(i);return r=-2*r*r*r+3*r*r,t*r+e*(1-r)}static MoveTowards(e,t,i){let r=0;return Math.abs(t-e)<=i?r=t:r=e+Scalar.Sign(t-e)*i,r}static MoveTowardsAngle(e,t,i){const r=Scalar.DeltaAngle(e,t);let s=0;return-i<r&&r<i?s=t:(t=e+r,s=Scalar.MoveTowards(e,t,i)),s}static Lerp(e,t,i){return e+(t-e)*i}static LerpAngle(e,t,i){let r=Scalar.Repeat(t-e,360);return r>180&&(r-=360),e+r*Scalar.Clamp(i)}static InverseLerp(e,t,i){let r=0;return e!=t?r=Scalar.Clamp((i-e)/(t-e)):r=0,r}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,h=-2*o+3*n,u=o-2*n+s,c=o-n;return e*l+i*h+t*u+r*c}static Hermite1stDerivative(e,t,i,r,s){const n=s*s;return(n-s)*6*e+(3*n-4*s+1)*t+(-n+s)*6*i+(3*n-2*s)*r}static RandomRange(e,t){return e===t?e:Math.random()*(t-e)+e}static RangeToPercent(e,t,i){return(e-t)/(i-t)}static PercentToRange(e,t,i){return(i-t)*e+t}static NormalizeRadians(e){return e-=Scalar.TwoPi*Math.floor((e+Math.PI)/Scalar.TwoPi),e}static HCF(e,t){const i=e%t;return i===0?t:Scalar.HCF(t,i)}}Scalar.TwoPi=Math.PI*2;const ToGammaSpace=1/2.2,ToLinearSpace=2.2,PHI=(1+Math.sqrt(5))/2,Epsilon=.001,_RegisteredTypes={};function RegisterClass(a,e){_RegisteredTypes[a]=e}function GetClass(a){return _RegisteredTypes[a]}class PerformanceConfigurator{static SetMatrixPrecision(e){if(PerformanceConfigurator.MatrixTrackPrecisionChange=!1,e&&!PerformanceConfigurator.MatrixUse64Bits&&PerformanceConfigurator.MatrixTrackedMatrices)for(let t=0;t<PerformanceConfigurator.MatrixTrackedMatrices.length;++t){const i=PerformanceConfigurator.MatrixTrackedMatrices[t],r=i._m;i._m=new Array(16);for(let s=0;s<16;++s)i._m[s]=r[s]}PerformanceConfigurator.MatrixUse64Bits=e,PerformanceConfigurator.MatrixCurrentType=PerformanceConfigurator.MatrixUse64Bits?Array:Float32Array,PerformanceConfigurator.MatrixTrackedMatrices=null}}PerformanceConfigurator.MatrixUse64Bits=!1;PerformanceConfigurator.MatrixTrackPrecisionChange=!0;PerformanceConfigurator.MatrixCurrentType=Float32Array;PerformanceConfigurator.MatrixTrackedMatrices=[];class EventState{constructor(e,t=!1,i,r){this.initialize(e,t,i,r)}initialize(e,t=!1,i,r){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=r,this}}class Observer{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(){this._remove&&this._remove()}}class Observable{static FromPromise(e,t){const i=new Observable;return e.then(r=>{i.notifyObservers(r)}).catch(r=>{if(t)t.notifyObservers(r);else throw r}),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new EventState(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,r=null,s=!1){if(!e)return null;const n=new Observer(e,t,r);return n.unregisterOnNextCall=s,i?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),this._hasNotified&&this.notifyIfTriggered&&this._lastNotifiedValue!==void 0&&this.notifyObserver(n,this._lastNotifiedValue),n._remove=()=>{this.remove(n)},n}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e?(e._remove=null,this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1):!1}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const r=this._observers[i];if(!r._willBeUnregistered&&r.callback===e&&(!t||t===r.scope))return this._deferUnregister(r),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return i!==-1?(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0):!1}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,r,s){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const n=this._eventState;n.mask=t,n.target=i,n.currentTarget=r,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=s;for(const o of this._observers)if(!o._willBeUnregistered&&(o.mask&t&&(o.unregisterOnNextCall&&this._deferUnregister(o),o.scope?n.lastReturnValue=o.callback.apply(o.scope,[e,n]):n.lastReturnValue=o.callback(e,n)),n.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const r=this._eventState;r.mask=i,r.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,r)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new Observable;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class EngineStore{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}EngineStore.Instances=new Array;EngineStore.OnEnginesDisposedObservable=new Observable;EngineStore._LastCreatedScene=null;EngineStore.UseFallbackTexture=!0;EngineStore.FallbackTexture="";const _ExtractAsInt=a=>parseInt(a.toString().replace(/\W/g,""));class Vector2{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){const e=_ExtractAsInt(this.x),t=_ExtractAsInt(this.y);let i=e;return i=i*397^t,i}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return Vector2.FromArrayToRef(e,t,this),this}asArray(){const e=new Array;return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new this.constructor(this.x+e.x,this.y+e.y)}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new this.constructor(this.x*e,this.y*t)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){const t=new this.constructor(0,0);return this.scaleToRef(e,t),t}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=Epsilon){return e&&Scalar.WithinEpsilon(this.x,e.x,t)&&Scalar.WithinEpsilon(this.y,e.y,t)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,t){const i=Math.cos(e),r=Math.sin(e),s=i*this.x-r*this.y,n=r*this.x+i*this.y;return t.x=s,t.y=n,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return Vector2.NormalizeToRef(this,this),this}clone(){return new this.constructor(this.x,this.y)}static Zero(){return new Vector2(0,0)}static One(){return new Vector2(1,1)}static Random(e=0,t=1){return new Vector2(Scalar.RandomRange(e,t),Scalar.RandomRange(e,t))}static get ZeroReadOnly(){return Vector2._ZeroReadOnly}static FromArray(e,t=0){return new Vector2(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static CatmullRom(e,t,i,r,s){const n=s*s,o=s*n,l=.5*(2*t.x+(-e.x+i.x)*s+(2*e.x-5*t.x+4*i.x-r.x)*n+(-e.x+3*t.x-3*i.x+r.x)*o),h=.5*(2*t.y+(-e.y+i.y)*s+(2*e.y-5*t.y+4*i.y-r.y)*n+(-e.y+3*t.y-3*i.y+r.y)*o);return new e.constructor(l,h)}static Clamp(e,t,i){let r=e.x;r=r>i.x?i.x:r,r=r<t.x?t.x:r;let s=e.y;return s=s>i.y?i.y:s,s=s<t.y?t.y:s,new e.constructor(r,s)}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,h=-2*o+3*n,u=o-2*n+s,c=o-n,d=e.x*l+i.x*h+t.x*u+r.x*c,f=e.y*l+i.y*h+t.y*u+r.y*c;return new e.constructor(d,f)}static Hermite1stDerivative(e,t,i,r,s){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const o=s*s;return n.x=(o-s)*6*e.x+(3*o-4*s+1)*t.x+(-o+s)*6*i.x+(3*o-2*s)*r.x,n.y=(o-s)*6*e.y+(3*o-4*s+1)*t.y+(-o+s)*6*i.y+(3*o-2*s)*r.y,n}static Lerp(e,t,i){const r=e.x+(t.x-e.x)*i,s=e.y+(t.y-e.y)*i;return new e.constructor(r,s)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=new e.constructor;return this.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){const i=e.length();return i===0||(t.x=e.x/i,t.y=e.y/i),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,r=e.y<t.y?e.y:t.y;return new e.constructor(i,r)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,r=e.y>t.y?e.y:t.y;return new e.constructor(i,r)}static Transform(e,t){const i=new e.constructor;return Vector2.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){const r=t.m,s=e.x*r[0]+e.y*r[4]+r[12],n=e.x*r[1]+e.y*r[5]+r[13];return i.x=s,i.y=n,i}static PointInTriangle(e,t,i,r){const s=.5*(-i.y*r.x+t.y*(-i.x+r.x)+t.x*(i.y-r.y)+i.x*r.y),n=s<0?-1:1,o=(t.y*r.x-t.x*r.y+(r.y-t.y)*e.x+(t.x-r.x)*e.y)*n,l=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*n;return o>0&&l>0&&o+l<2*s*n}static Distance(e,t){return Math.sqrt(Vector2.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y;return i*i+r*r}static Center(e,t){const i=new e.constructor;return Vector2.CenterToRef(e,t,i)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const r=Vector2.DistanceSquared(t,i);if(r===0)return Vector2.Distance(e,t);const s=i.subtract(t),n=Math.max(0,Math.min(1,Vector2.Dot(e.subtract(t),s)/r)),o=t.add(s.multiplyByFloats(n,n));return Vector2.Distance(e,o)}}Vector2._ZeroReadOnly=Vector2.Zero();class Vector3{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){const e=_ExtractAsInt(this._x),t=_ExtractAsInt(this._y),i=_ExtractAsInt(this._z);let r=e;return r=r*397^t,r=r*397^i,r}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return Vector3.FromArrayToRef(e,t,this),this}toQuaternion(){return Quaternion.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new this.constructor(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,r){return r.copyFromFloats(this._x-e,this._y-t,this._z-i)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const r=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const s=t*Math.sin(i)*Math.cos(r),n=t*Math.cos(i),o=t*Math.sin(i)*Math.sin(r);return e.set(s,n,o),e}applyRotationQuaternionToRef(e,t){const i=e._w*this._x+e._y*this._z-e._z*this._y,r=e._w*this._y+e._z*this._x-e._x*this._z,s=e._w*this._z+e._x*this._y-e._y*this._x,n=-e._x*this._x-e._y*this._y-e._z*this._z;return t._x=i*e._w+n*-e._x+r*-e._z-s*-e._y,t._y=r*e._w+n*-e._y+s*-e._x-i*-e._z,t._z=s*e._w+n*-e._z+i*-e._y-r*-e._x,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){const i=new this.constructor;return this.projectOnPlaneToRef(e,t,i),i}projectOnPlaneToRef(e,t,i){const r=e.normal,s=e.d,n=MathTmp.Vector3[0];this.subtractToRef(t,n),n.normalize();const o=Vector3.Dot(n,r);if(Math.abs(o)<Math.pow(10,-10))i.setAll(1/0);else{const l=-(Vector3.Dot(t,r)+s)/o,h=n.scaleInPlace(l);t.addToRef(h,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=Epsilon){return e&&Scalar.WithinEpsilon(this._x,e._x,t)&&Scalar.WithinEpsilon(this._y,e._y,t)&&Scalar.WithinEpsilon(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,i){return new this.constructor(this._x*e,this._y*t,this._z*i)}divide(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!Scalar.WithinEpsilon(t,i,e))return!0;const r=Math.abs(this._z);return!Scalar.WithinEpsilon(t,r,e)||!Scalar.WithinEpsilon(i,r,e)}get isNonUniform(){const e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;const i=Math.abs(this._z);return e!==i}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){return e=e.toLowerCase(),e==="xyz"?this:(MathTmp.Vector3[0].copyFrom(this),["x","y","z"].forEach((t,i)=>{this[t]=MathTmp.Vector3[0][e[i]]}),this)}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(MathTmp.Matrix[0]),Vector3.TransformCoordinatesToRef(this,MathTmp.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,MathTmp.Vector3[0]),MathTmp.Vector3[0].rotateByQuaternionToRef(e,MathTmp.Vector3[0]),t.addToRef(MathTmp.Vector3[0],i),i}cross(e){const t=new this.constructor;return Vector3.CrossToRef(this,e,t)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,r){const s=Vector3.Dot(e,i)-r,n=Vector3.Dot(t,i)-r;return s/(s-n)}static GetAngleBetweenVectors(e,t,i){const r=e.normalizeToRef(MathTmp.Vector3[1]),s=t.normalizeToRef(MathTmp.Vector3[2]);let n=Vector3.Dot(r,s);n=Scalar.Clamp(n,-1,1);const o=Math.acos(n),l=MathTmp.Vector3[3];return Vector3.CrossToRef(r,s,l),Vector3.Dot(l,i)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(n)}static GetAngleBetweenVectorsOnPlane(e,t,i){MathTmp.Vector3[0].copyFrom(e);const r=MathTmp.Vector3[0];MathTmp.Vector3[1].copyFrom(t);const s=MathTmp.Vector3[1];MathTmp.Vector3[2].copyFrom(i);const n=MathTmp.Vector3[2],o=MathTmp.Vector3[3],l=MathTmp.Vector3[4];r.normalize(),s.normalize(),n.normalize(),Vector3.CrossToRef(n,r,o),Vector3.CrossToRef(o,n,l);const h=Math.atan2(Vector3.Dot(s,o),Vector3.Dot(s,l));return Scalar.NormalizeRadians(h)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const r=TmpVectors.Vector3[0];return t.subtractToRef(e,r),i._y=Math.atan2(r.x,r.z)||0,i._x=Math.atan2(Math.sqrt(r.x**2+r.z**2),r.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=Vector3.Zero();return Vector3.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,r){i=Scalar.Clamp(i,0,1);const s=MathTmp.Vector3[0],n=MathTmp.Vector3[1];s.copyFrom(e);const o=s.length();s.normalizeFromLength(o),n.copyFrom(t);const l=n.length();n.normalizeFromLength(l);const h=Vector3.Dot(s,n);let u,c;if(h<1-Epsilon){const d=Math.acos(h),f=1/Math.sin(d);u=Math.sin((1-i)*d)*f,c=Math.sin(i*d)*f}else u=1-i,c=i;return s.scaleInPlace(u),n.scaleInPlace(c),r.copyFrom(s).addInPlace(n),r.scaleInPlace(Scalar.Lerp(o,l,i)),r}static SmoothToRef(e,t,i,r,s){return Vector3.SlerpToRef(e,t,r===0?1:i/r,s),s}static FromArray(e,t=0){return new Vector3(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return Vector3.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return Vector3.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,r){return r.copyFromFloats(e,t,i),r}static Zero(){return new Vector3(0,0,0)}static One(){return new Vector3(1,1,1)}static Up(){return new Vector3(0,1,0)}static get UpReadOnly(){return Vector3._UpReadOnly}static get DownReadOnly(){return Vector3._DownReadOnly}static get RightReadOnly(){return Vector3._RightReadOnly}static get LeftReadOnly(){return Vector3._LeftReadOnly}static get LeftHandedForwardReadOnly(){return Vector3._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return Vector3._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return Vector3._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return Vector3._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return Vector3._ZeroReadOnly}static get OneReadOnly(){return Vector3._OneReadOnly}static Down(){return new Vector3(0,-1,0)}static Forward(e=!1){return new Vector3(0,0,e?-1:1)}static Backward(e=!1){return new Vector3(0,0,e?1:-1)}static Right(){return new Vector3(1,0,0)}static Left(){return new Vector3(-1,0,0)}static Random(e=0,t=1){return new Vector3(Scalar.RandomRange(e,t),Scalar.RandomRange(e,t),Scalar.RandomRange(e,t))}static TransformCoordinates(e,t){const i=Vector3.Zero();return Vector3.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return Vector3.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,s){const n=r.m,o=e*n[0]+t*n[4]+i*n[8]+n[12],l=e*n[1]+t*n[5]+i*n[9]+n[13],h=e*n[2]+t*n[6]+i*n[10]+n[14],u=1/(e*n[3]+t*n[7]+i*n[11]+n[15]);return s._x=o*u,s._y=l*u,s._z=h*u,s._isDirty=!0,s}static TransformNormal(e,t){const i=Vector3.Zero();return Vector3.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,r,s){const n=r.m;return s._x=e*n[0]+t*n[4]+i*n[8],s._y=e*n[1]+t*n[5]+i*n[9],s._z=e*n[2]+t*n[6]+i*n[10],s._isDirty=!0,s}static CatmullRom(e,t,i,r,s){const n=s*s,o=s*n,l=.5*(2*t._x+(-e._x+i._x)*s+(2*e._x-5*t._x+4*i._x-r._x)*n+(-e._x+3*t._x-3*i._x+r._x)*o),h=.5*(2*t._y+(-e._y+i._y)*s+(2*e._y-5*t._y+4*i._y-r._y)*n+(-e._y+3*t._y-3*i._y+r._y)*o),u=.5*(2*t._z+(-e._z+i._z)*s+(2*e._z-5*t._z+4*i._z-r._z)*n+(-e._z+3*t._z-3*i._z+r._z)*o);return new e.constructor(l,h,u)}static Clamp(e,t,i){const r=new e.constructor;return Vector3.ClampToRef(e,t,i,r),r}static ClampToRef(e,t,i,r){let s=e._x;s=s>i._x?i._x:s,s=s<t._x?t._x:s;let n=e._y;n=n>i._y?i._y:n,n=n<t._y?t._y:n;let o=e._z;return o=o>i._z?i._z:o,o=o<t._z?t._z:o,r.copyFromFloats(s,n,o),r}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,h=-2*o+3*n,u=o-2*n+s,c=o-n,d=e._x*l+i._x*h+t._x*u+r._x*c,f=e._y*l+i._y*h+t._y*u+r._y*c,_=e._z*l+i._z*h+t._z*u+r._z*c;return new e.constructor(d,f,_)}static Hermite1stDerivative(e,t,i,r,s){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const o=s*s;return n._x=(o-s)*6*e._x+(3*o-4*s+1)*t._x+(-o+s)*6*i._x+(3*o-2*s)*r._x,n._y=(o-s)*6*e._y+(3*o-4*s+1)*t._y+(-o+s)*6*i._y+(3*o-2*s)*r._y,n._z=(o-s)*6*e._z+(3*o-4*s+1)*t._z+(-o+s)*6*i._z+(3*o-2*s)*r._z,n._isDirty=!0,n}static Lerp(e,t,i){const r=new e.constructor(0,0,0);return Vector3.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){return r._x=e._x+(t._x-e._x)*i,r._y=e._y+(t._y-e._y)*i,r._z=e._z+(t._z-e._z)*i,r._isDirty=!0,r}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}static Cross(e,t){const i=new e.constructor;return Vector3.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const r=e._y*t._z-e._z*t._y,s=e._z*t._x-e._x*t._z,n=e._x*t._y-e._y*t._x;return i.copyFromFloats(r,s,n),i}static Normalize(e){const t=Vector3.Zero();return Vector3.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,r){const s=new e.constructor;return Vector3.ProjectToRef(e,t,i,r,s),s}static ProjectToRef(e,t,i,r,s){const n=r.width,o=r.height,l=r.x,h=r.y,u=MathTmp.Matrix[1];Matrix.FromValuesToRef(n/2,0,0,0,0,-o/2,0,0,0,0,.5,0,l+n/2,o/2+h,.5,1,u);const c=MathTmp.Matrix[0];return t.multiplyToRef(i,c),c.multiplyToRef(u,c),Vector3.TransformCoordinatesToRef(e,c,s),s}static Reflect(e,t){return this.ReflectToRef(e,t,new Vector3)}static ReflectToRef(e,t,i){const r=TmpVectors.Vector3[0];return r.copyFrom(t).scaleInPlace(2*Vector3.Dot(e,t)),i.copyFrom(e).subtractInPlace(r)}static _UnprojectFromInvertedMatrixToRef(e,t,i){Vector3.TransformCoordinatesToRef(e,t,i);const r=t.m,s=e._x*r[3]+e._y*r[7]+e._z*r[11]+r[15];return Scalar.WithinEpsilon(s,1)&&i.scaleInPlace(1/s),i}static UnprojectFromTransform(e,t,i,r,s){return this.Unproject(e,t,i,r,s,Matrix.IdentityReadOnly)}static Unproject(e,t,i,r,s,n){const o=new e.constructor;return Vector3.UnprojectToRef(e,t,i,r,s,n,o),o}static UnprojectToRef(e,t,i,r,s,n,o){return Vector3.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,r,s,n,o),o}static UnprojectFloatsToRef(e,t,i,r,s,n,o,l,h){var u;const c=MathTmp.Matrix[0];n.multiplyToRef(o,c),c.multiplyToRef(l,c),c.invert();const d=MathTmp.Vector3[0];return d.x=e/r*2-1,d.y=-(t/s*2-1),!((u=EngineStore.LastCreatedEngine)===null||u===void 0)&&u.isNDCHalfZRange?d.z=i:d.z=2*i-1,Vector3._UnprojectFromInvertedMatrixToRef(d,c,h),h}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(Vector3.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,r=e._y-t._y,s=e._z-t._z;return i*i+r*r+s*s}static ProjectOnTriangleToRef(e,t,i,r,s){const n=MathTmp.Vector3[0],o=MathTmp.Vector3[1],l=MathTmp.Vector3[2],h=MathTmp.Vector3[3],u=MathTmp.Vector3[4];i.subtractToRef(t,n),r.subtractToRef(t,o),r.subtractToRef(i,l);const c=n.length(),d=o.length(),f=l.length();if(c<Epsilon||d<Epsilon||f<Epsilon)return s.copyFrom(t),Vector3.Distance(e,t);e.subtractToRef(t,u),Vector3.CrossToRef(n,o,h);const _=h.length();if(_<Epsilon)return s.copyFrom(t),Vector3.Distance(e,t);h.normalizeFromLength(_);let g=u.length();if(g<Epsilon)return s.copyFrom(t),0;u.normalizeFromLength(g);const p=Vector3.Dot(h,u),m=MathTmp.Vector3[5],E=MathTmp.Vector3[6];m.copyFrom(h).scaleInPlace(-g*p),E.copyFrom(e).addInPlace(m);const M=MathTmp.Vector3[4],x=MathTmp.Vector3[5],A=MathTmp.Vector3[7],T=MathTmp.Vector3[8];M.copyFrom(n).scaleInPlace(1/c),T.copyFrom(o).scaleInPlace(1/d),M.addInPlace(T).scaleInPlace(-1),x.copyFrom(n).scaleInPlace(-1/c),T.copyFrom(l).scaleInPlace(1/f),x.addInPlace(T).scaleInPlace(-1),A.copyFrom(l).scaleInPlace(-1/f),T.copyFrom(o).scaleInPlace(-1/d),A.addInPlace(T).scaleInPlace(-1);const C=MathTmp.Vector3[9];let b;C.copyFrom(E).subtractInPlace(t),Vector3.CrossToRef(M,C,T),b=Vector3.Dot(T,h);const y=b;C.copyFrom(E).subtractInPlace(i),Vector3.CrossToRef(x,C,T),b=Vector3.Dot(T,h);const S=b;C.copyFrom(E).subtractInPlace(r),Vector3.CrossToRef(A,C,T),b=Vector3.Dot(T,h);const R=b,P=MathTmp.Vector3[10];let N,V;y>0&&S<0?(P.copyFrom(n),N=t,V=i):S>0&&R<0?(P.copyFrom(l),N=i,V=r):(P.copyFrom(o).scaleInPlace(-1),N=r,V=t);const F=MathTmp.Vector3[9],U=MathTmp.Vector3[4];if(N.subtractToRef(E,T),V.subtractToRef(E,F),Vector3.CrossToRef(T,F,U),!(Vector3.Dot(U,h)<0))return s.copyFrom(E),Math.abs(g*p);const X=MathTmp.Vector3[5];Vector3.CrossToRef(P,U,X),X.normalize();const w=MathTmp.Vector3[9];w.copyFrom(N).subtractInPlace(E);const O=w.length();if(O<Epsilon)return s.copyFrom(N),Vector3.Distance(e,N);w.normalizeFromLength(O);const v=Vector3.Dot(X,w),D=MathTmp.Vector3[7];D.copyFrom(E).addInPlace(X.scaleInPlace(O*v)),T.copyFrom(D).subtractInPlace(N),g=P.length(),P.normalizeFromLength(g);let B=Vector3.Dot(T,P)/Math.max(g,Epsilon);return B=Scalar.Clamp(B,0,1),D.copyFrom(N).addInPlace(P.scaleInPlace(B*g)),s.copyFrom(D),Vector3.Distance(e,D)}static Center(e,t){return Vector3.CenterToRef(e,t,Vector3.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const r=new e.constructor;return Vector3.RotationFromAxisToRef(e,t,i,r),r}static RotationFromAxisToRef(e,t,i,r){const s=MathTmp.Quaternion[0];return Quaternion.RotationQuaternionFromAxisToRef(e,t,i,s),s.toEulerAnglesToRef(r),r}}Vector3._UpReadOnly=Vector3.Up();Vector3._DownReadOnly=Vector3.Down();Vector3._LeftHandedForwardReadOnly=Vector3.Forward(!1);Vector3._RightHandedForwardReadOnly=Vector3.Forward(!0);Vector3._LeftHandedBackwardReadOnly=Vector3.Backward(!1);Vector3._RightHandedBackwardReadOnly=Vector3.Backward(!0);Vector3._RightReadOnly=Vector3.Right();Vector3._LeftReadOnly=Vector3.Left();Vector3._ZeroReadOnly=Vector3.Zero();Vector3._OneReadOnly=Vector3.One();class Vector4{constructor(e=0,t=0,i=0,r=0){this.x=e,this.y=t,this.z=i,this.w=r}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){const e=_ExtractAsInt(this.x),t=_ExtractAsInt(this.y),i=_ExtractAsInt(this.z),r=_ExtractAsInt(this.w);let s=e;return s=s*397^t,s=s*397^i,s=s*397^r,s}asArray(){const e=new Array;return this.toArray(e,0),e}toArray(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return Vector4.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,r){return new this.constructor(this.x-e,this.y-t,this.z-i,this.w-r)}subtractFromFloatsToRef(e,t,i,r,s){return s.x=this.x-e,s.y=this.y-t,s.z=this.z-i,s.w=this.w-r,s}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1,this.z*-1,this.w*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=Epsilon){return e&&Scalar.WithinEpsilon(this.x,e.x,t)&&Scalar.WithinEpsilon(this.y,e.y,t)&&Scalar.WithinEpsilon(this.z,e.z,t)&&Scalar.WithinEpsilon(this.w,e.w,t)}equalsToFloats(e,t,i,r){return this.x===e&&this.y===t&&this.z===i&&this.w===r}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,r){return new this.constructor(this.x*e,this.y*t,this.z*i,this.w*r)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){const e=this.length();return e===0?this:this.scaleInPlace(1/e)}toVector3(){return new Vector3(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.x=this.y=this.z=this.w=e,this}static FromArray(e,t){return t||(t=0),new Vector4(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return Vector4.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,r,s){return s.x=e,s.y=t,s.z=i,s.w=r,s}static Zero(){return new Vector4(0,0,0,0)}static One(){return new Vector4(1,1,1,1)}static Random(e=0,t=1){return new Vector4(Scalar.RandomRange(e,t),Scalar.RandomRange(e,t),Scalar.RandomRange(e,t),Scalar.RandomRange(e,t))}static get ZeroReadOnly(){return Vector4._ZeroReadOnly}static Normalize(e){const t=Vector4.Zero();return Vector4.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return t.copyFrom(e),t.normalize(),t}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(Vector4.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.z-t.z,n=e.w-t.w;return i*i+r*r+s*s+n*n}static Center(e,t){return Vector4.CenterToRef(e,t,Vector4.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}static TransformCoordinates(e,t){const i=Vector4.Zero();return Vector4.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return Vector4.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,s){const n=r.m,o=e*n[0]+t*n[4]+i*n[8]+n[12],l=e*n[1]+t*n[5]+i*n[9]+n[13],h=e*n[2]+t*n[6]+i*n[10]+n[14],u=e*n[3]+t*n[7]+i*n[11]+n[15];return s.x=o,s.y=l,s.z=h,s.w=u,s}static TransformNormal(e,t){const i=new e.constructor;return Vector4.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){const r=t.m,s=e.x*r[0]+e.y*r[4]+e.z*r[8],n=e.x*r[1]+e.y*r[5]+e.z*r[9],o=e.x*r[2]+e.y*r[6]+e.z*r[10];return i.x=s,i.y=n,i.z=o,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,r,s,n){const o=s.m;return n.x=e*o[0]+t*o[4]+i*o[8],n.y=e*o[1]+t*o[5]+i*o[9],n.z=e*o[2]+t*o[6]+i*o[10],n.w=r,n}static FromVector3(e,t=0){return new Vector4(e._x,e._y,e._z,t)}}Vector4._ZeroReadOnly=Vector4.Zero();class Quaternion{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,r=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=r}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){const e=_ExtractAsInt(this._x),t=_ExtractAsInt(this._y),i=_ExtractAsInt(this._z),r=_ExtractAsInt(this._w);let s=e;return s=s*397^t,s=s*397^i,s=s*397^r,s}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=Epsilon){return e&&Scalar.WithinEpsilon(this._x,e._x,t)&&Scalar.WithinEpsilon(this._y,e._y,t)&&Scalar.WithinEpsilon(this._z,e._z,t)&&Scalar.WithinEpsilon(this._w,e._w,t)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._w=r,this._isDirty=!0,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new this.constructor(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,r=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,s=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,n=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,r,s,n),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){const e=this.length();if(e===0)return this;const t=1/e;return this.scaleInPlace(t),this}normalizeToNew(){const e=this.length();if(e===0)return this.clone();const t=1/e;return this.scale(t)}toEulerAngles(){const e=Vector3.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,r=this._y,s=this._w,n=r*t-i*s,o=.4999999;if(n<-o)e._y=2*Math.atan2(r,s),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(n>o)e._y=2*Math.atan2(r,s),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const l=s*s,h=t*t,u=i*i,c=r*r;e._z=Math.atan2(2*(i*r+t*s),-h-u+c+l),e._x=Math.asin(-2*n),e._y=Math.atan2(2*(t*i+r*s),h-u-c+l),e._isDirty=!0}return e}toRotationMatrix(e){return Matrix.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return Quaternion.FromRotationMatrixToRef(e,this),this}static FromRotationMatrix(e){const t=new Quaternion;return Quaternion.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,r=i[0],s=i[4],n=i[8],o=i[1],l=i[5],h=i[9],u=i[2],c=i[6],d=i[10],f=r+l+d;let _;return f>0?(_=.5/Math.sqrt(f+1),t._w=.25/_,t._x=(c-h)*_,t._y=(n-u)*_,t._z=(o-s)*_,t._isDirty=!0):r>l&&r>d?(_=2*Math.sqrt(1+r-l-d),t._w=(c-h)/_,t._x=.25*_,t._y=(s+o)/_,t._z=(n+u)/_,t._isDirty=!0):l>d?(_=2*Math.sqrt(1+l-r-d),t._w=(n-u)/_,t._x=(s+o)/_,t._y=.25*_,t._z=(h+c)/_,t._isDirty=!0):(_=2*Math.sqrt(1+d-r-l),t._w=(o-s)/_,t._x=(n+u)/_,t._y=(h+c)/_,t._z=.25*_,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const r=Quaternion.Dot(e,t);return 1-r*r<=i}static SmoothToRef(e,t,i,r,s){let n=r===0?1:i/r;return n=Scalar.Clamp(n,0,1),Quaternion.SlerpToRef(e,t,n,s),s}static Zero(){return new Quaternion(0,0,0,0)}static Inverse(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new Quaternion(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(e,t){return Quaternion.RotationAxisToRef(e,t,new Quaternion)}static RotationAxisToRef(e,t,i){const r=Math.sin(t/2);return e.normalize(),i._w=Math.cos(t/2),i._x=e._x*r,i._y=e._y*r,i._z=e._z*r,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new Quaternion(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromEulerAngles(e,t,i){const r=new Quaternion;return Quaternion.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerAnglesToRef(e,t,i,r){return Quaternion.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerVector(e){const t=new Quaternion;return Quaternion.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return Quaternion.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,r=Epsilon){const s=Vector3.Dot(e,t)+1;return s<r?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(Vector3.CrossToRef(e,t,TmpVectors.Vector3[0]),i.set(TmpVectors.Vector3[0].x,TmpVectors.Vector3[0].y,TmpVectors.Vector3[0].z,s)),i.normalize()}static RotationYawPitchRoll(e,t,i){const r=new Quaternion;return Quaternion.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){const s=i*.5,n=t*.5,o=e*.5,l=Math.sin(s),h=Math.cos(s),u=Math.sin(n),c=Math.cos(n),d=Math.sin(o),f=Math.cos(o);return r._x=f*u*h+d*c*l,r._y=d*c*h-f*u*l,r._z=f*c*l-d*u*h,r._w=f*c*h+d*u*l,r._isDirty=!0,r}static RotationAlphaBetaGamma(e,t,i){const r=new Quaternion;return Quaternion.RotationAlphaBetaGammaToRef(e,t,i,r),r}static RotationAlphaBetaGammaToRef(e,t,i,r){const s=(i+e)*.5,n=(i-e)*.5,o=t*.5;return r._x=Math.cos(n)*Math.sin(o),r._y=Math.sin(n)*Math.sin(o),r._z=Math.sin(s)*Math.cos(o),r._w=Math.cos(s)*Math.cos(o),r._isDirty=!0,r}static RotationQuaternionFromAxis(e,t,i){const r=new Quaternion(0,0,0,0);return Quaternion.RotationQuaternionFromAxisToRef(e,t,i,r),r}static RotationQuaternionFromAxisToRef(e,t,i,r){const s=MathTmp.Matrix[0];return Matrix.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),s),Quaternion.FromRotationMatrixToRef(s,r),r}static FromLookDirectionLH(e,t){const i=new Quaternion;return Quaternion.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const r=MathTmp.Matrix[0];return Matrix.LookDirectionLHToRef(e,t,r),Quaternion.FromRotationMatrixToRef(r,i),i}static FromLookDirectionRH(e,t){const i=new Quaternion;return Quaternion.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const r=MathTmp.Matrix[0];return Matrix.LookDirectionRHToRef(e,t,r),Quaternion.FromRotationMatrixToRef(r,i)}static Slerp(e,t,i){const r=Quaternion.Identity();return Quaternion.SlerpToRef(e,t,i,r),r}static SlerpToRef(e,t,i,r){let s,n,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(o<0&&(l=!0,o=-o),o>.999999)n=1-i,s=l?-i:i;else{const h=Math.acos(o),u=1/Math.sin(h);n=Math.sin((1-i)*h)*u,s=l?-Math.sin(i*h)*u:Math.sin(i*h)*u}return r._x=n*e._x+s*t._x,r._y=n*e._y+s*t._y,r._z=n*e._z+s*t._z,r._w=n*e._w+s*t._w,r._isDirty=!0,r}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,h=-2*o+3*n,u=o-2*n+s,c=o-n,d=e._x*l+i._x*h+t._x*u+r._x*c,f=e._y*l+i._y*h+t._y*u+r._y*c,_=e._z*l+i._z*h+t._z*u+r._z*c,g=e._w*l+i._w*h+t._w*u+r._w*c;return new e.constructor(d,f,_,g)}static Hermite1stDerivative(e,t,i,r,s){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const o=s*s;return n._x=(o-s)*6*e._x+(3*o-4*s+1)*t._x+(-o+s)*6*i._x+(3*o-2*s)*r._x,n._y=(o-s)*6*e._y+(3*o-4*s+1)*t._y+(-o+s)*6*i._y+(3*o-2*s)*r._y,n._z=(o-s)*6*e._z+(3*o-4*s+1)*t._z+(-o+s)*6*i._z+(3*o-2*s)*r._z,n._w=(o-s)*6*e._w+(3*o-4*s+1)*t._w+(-o+s)*6*i._w+(3*o-2*s)*r._w,n._isDirty=!0,n}}class Matrix{static get Use64Bits(){return PerformanceConfigurator.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=Matrix._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,r=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:r}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,PerformanceConfigurator.MatrixTrackPrecisionChange&&PerformanceConfigurator.MatrixTrackedMatrices.push(this),this._m=new PerformanceConfigurator.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;const e=this._m,t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],_=e[12],g=e[13],p=e[14],m=e[15],E=d*m-p*f,M=c*m-g*f,x=c*p-g*d,A=u*m-_*f,T=u*p-d*_,C=u*g-_*c,b=+(o*E-l*M+h*x),y=-(n*E-l*A+h*T),S=+(n*M-o*A+h*C),R=-(n*x-o*T+l*C);return t*b+i*y+r*S+s*R}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return Matrix.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new this.constructor;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,r=t._m,s=e.m;for(let n=0;n<16;n++)r[n]=i[n]+s[n];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]+=i[r];return this.markAsUpdated(),this}invertToRef(e){if(this._isIdentity===!0)return Matrix.IdentityToRef(e),e;const t=this._m,i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=t[9],f=t[10],_=t[11],g=t[12],p=t[13],m=t[14],E=t[15],M=f*E-m*_,x=d*E-p*_,A=d*m-p*f,T=c*E-g*_,C=c*m-f*g,b=c*p-g*d,y=+(l*M-h*x+u*A),S=-(o*M-h*T+u*C),R=+(o*x-l*T+u*b),P=-(o*A-l*C+h*b),N=i*y+r*S+s*R+n*P;if(N===0)return e.copyFrom(this),e;const V=1/N,F=h*E-m*u,U=l*E-p*u,H=l*m-p*h,X=o*E-g*u,w=o*m-g*h,O=o*p-g*l,v=h*_-f*u,D=l*_-d*u,B=l*f-d*h,k=o*_-c*u,j=o*f-c*h,K=o*d-c*l,L=-(r*M-s*x+n*A),G=+(i*M-s*T+n*C),Z=-(i*x-r*T+n*b),z=+(i*A-r*C+s*b),Y=+(r*F-s*U+n*H),W=-(i*F-s*X+n*w),J=+(i*U-r*X+n*O),ee=-(i*H-r*w+s*O),te=-(r*v-s*D+n*B),ie=+(i*v-s*k+n*j),he=-(i*D-r*k+n*K),oe=+(i*B-r*j+s*K);return Matrix.FromValuesToRef(y*V,L*V,Y*V,te*V,S*V,G*V,W*V,ie*V,R*V,Z*V,J*V,he*V,P*V,z*V,ee*V,oe*V,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new Vector3(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return Matrix.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this}multiply(e){const t=new this.constructor;return this.multiplyToRef(e,t),t}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const r=this._m,s=e.m,n=r[0],o=r[1],l=r[2],h=r[3],u=r[4],c=r[5],d=r[6],f=r[7],_=r[8],g=r[9],p=r[10],m=r[11],E=r[12],M=r[13],x=r[14],A=r[15],T=s[0],C=s[1],b=s[2],y=s[3],S=s[4],R=s[5],P=s[6],N=s[7],V=s[8],F=s[9],U=s[10],H=s[11],X=s[12],w=s[13],O=s[14],v=s[15];return t[i]=n*T+o*S+l*V+h*X,t[i+1]=n*C+o*R+l*F+h*w,t[i+2]=n*b+o*P+l*U+h*O,t[i+3]=n*y+o*N+l*H+h*v,t[i+4]=u*T+c*S+d*V+f*X,t[i+5]=u*C+c*R+d*F+f*w,t[i+6]=u*b+c*P+d*U+f*O,t[i+7]=u*y+c*N+d*H+f*v,t[i+8]=_*T+g*S+p*V+m*X,t[i+9]=_*C+g*R+p*F+m*w,t[i+10]=_*b+g*P+p*U+m*O,t[i+11]=_*y+g*N+p*H+m*v,t[i+12]=E*T+M*S+x*V+A*X,t[i+13]=E*C+M*R+x*F+A*w,t[i+14]=E*b+M*P+x*U+A*O,t[i+15]=E*y+M*N+x*H+A*v,this}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,r=t.m;return i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]&&i[4]===r[4]&&i[5]===r[5]&&i[6]===r[6]&&i[7]===r[7]&&i[8]===r[8]&&i[9]===r[9]&&i[10]===r[10]&&i[11]===r[11]&&i[12]===r[12]&&i[13]===r[13]&&i[14]===r[14]&&i[15]===r[15]}clone(){const e=new this.constructor;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=_ExtractAsInt(this._m[0]);for(let t=1;t<16;t++)e=e*397^_ExtractAsInt(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new Quaternion,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,r){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const s=this._m;if(i&&i.copyFromFloats(s[12],s[13],s[14]),e=e||MathTmp.Vector3[0],e.x=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),e.y=Math.sqrt(s[4]*s[4]+s[5]*s[5]+s[6]*s[6]),e.z=Math.sqrt(s[8]*s[8]+s[9]*s[9]+s[10]*s[10]),r){const n=r.scaling.x<0?-1:1,o=r.scaling.y<0?-1:1,l=r.scaling.z<0?-1:1;e.x*=n,e.y*=o,e.z*=l}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const n=1/e._x,o=1/e._y,l=1/e._z;Matrix.FromValuesToRef(s[0]*n,s[1]*n,s[2]*n,0,s[4]*o,s[5]*o,s[6]*o,0,s[8]*l,s[9]*l,s[10]*l,0,0,0,0,1,MathTmp.Matrix[0]),Quaternion.FromRotationMatrixToRef(MathTmp.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=e*4;return new Vector4(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<3){const i=e*4;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new this.constructor;return Matrix.TransposeToRef(this,e),e}transposeToRef(e){return Matrix.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,r,s){if(e<0||e>3)return this;const n=e*4;return this._m[n+0]=t,this._m[n+1]=i,this._m[n+2]=r,this._m[n+3]=s,this.markAsUpdated(),this}scale(e){const t=new this.constructor;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}toNormalMatrix(e){const t=MathTmp.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return Matrix.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new this.constructor;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=MathTmp.Vector3[0];if(!this.decompose(t))return Matrix.IdentityToRef(e),e;const i=this._m,r=1/t._x,s=1/t._y,n=1/t._z;return Matrix.FromValuesToRef(i[0]*r,i[1]*r,i[2]*r,0,i[4]*s,i[5]*s,i[6]*s,0,i[8]*n,i[9]*n,i[10]*n,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new Matrix;return Matrix.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let r=0;r<16;r++)i._m[r]=e[r+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,r){for(let s=0;s<16;s++)r._m[s]=e[s+t]*i;return r.markAsUpdated(),r}static get IdentityReadOnly(){return Matrix._IdentityReadOnly}static FromValuesToRef(e,t,i,r,s,n,o,l,h,u,c,d,f,_,g,p,m){const E=m._m;E[0]=e,E[1]=t,E[2]=i,E[3]=r,E[4]=s,E[5]=n,E[6]=o,E[7]=l,E[8]=h,E[9]=u,E[10]=c,E[11]=d,E[12]=f,E[13]=_,E[14]=g,E[15]=p,m.markAsUpdated()}static FromValues(e,t,i,r,s,n,o,l,h,u,c,d,f,_,g,p){const m=new Matrix,E=m._m;return E[0]=e,E[1]=t,E[2]=i,E[3]=r,E[4]=s,E[5]=n,E[6]=o,E[7]=l,E[8]=h,E[9]=u,E[10]=c,E[11]=d,E[12]=f,E[13]=_,E[14]=g,E[15]=p,m.markAsUpdated(),m}static Compose(e,t,i){const r=new Matrix;return Matrix.ComposeToRef(e,t,i,r),r}static ComposeToRef(e,t,i,r){const s=r._m,n=t._x,o=t._y,l=t._z,h=t._w,u=n+n,c=o+o,d=l+l,f=n*u,_=n*c,g=n*d,p=o*c,m=o*d,E=l*d,M=h*u,x=h*c,A=h*d,T=e._x,C=e._y,b=e._z;return s[0]=(1-(p+E))*T,s[1]=(_+A)*T,s[2]=(g-x)*T,s[3]=0,s[4]=(_-A)*C,s[5]=(1-(f+E))*C,s[6]=(m+M)*C,s[7]=0,s[8]=(g+x)*b,s[9]=(m-M)*b,s[10]=(1-(f+p))*b,s[11]=0,s[12]=i._x,s[13]=i._y,s[14]=i._z,s[15]=1,r.markAsUpdated(),r}static Identity(){const e=Matrix.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return Matrix.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=Matrix.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new Matrix;return Matrix.RotationXToRef(e,t),t}static Invert(e){const t=new e.constructor;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return Matrix.FromValuesToRef(1,0,0,0,0,r,i,0,0,-i,r,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationY(e){const t=new Matrix;return Matrix.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return Matrix.FromValuesToRef(r,0,-i,0,0,1,0,0,i,0,r,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationZ(e){const t=new Matrix;return Matrix.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return Matrix.FromValuesToRef(r,i,0,0,-i,r,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationAxis(e,t){const i=new Matrix;return Matrix.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const r=Math.sin(-t),s=Math.cos(-t),n=1-s;e.normalize();const o=i._m;return o[0]=e._x*e._x*n+s,o[1]=e._x*e._y*n-e._z*r,o[2]=e._x*e._z*n+e._y*r,o[3]=0,o[4]=e._y*e._x*n+e._z*r,o[5]=e._y*e._y*n+s,o[6]=e._y*e._z*n-e._x*r,o[7]=0,o[8]=e._z*e._x*n-e._y*r,o[9]=e._z*e._y*n+e._x*r,o[10]=e._z*e._z*n+s,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i){const r=Vector3.Dot(t,e),s=i._m;if(r<-1+Epsilon)s[0]=-1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0;else{const n=Vector3.Cross(t,e),o=1/(1+r);s[0]=n._x*n._x*o+r,s[1]=n._y*n._x*o-n._z,s[2]=n._z*n._x*o+n._y,s[3]=0,s[4]=n._x*n._y*o+n._z,s[5]=n._y*n._y*o+r,s[6]=n._z*n._y*o-n._x,s[7]=0,s[8]=n._x*n._z*o-n._y,s[9]=n._y*n._z*o+n._x,s[10]=n._z*n._z*o+r,s[11]=0}return s[12]=0,s[13]=0,s[14]=0,s[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const r=new Matrix;return Matrix.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){return Quaternion.RotationYawPitchRollToRef(e,t,i,MathTmp.Quaternion[0]),MathTmp.Quaternion[0].toRotationMatrix(r),r}static Scaling(e,t,i){const r=new Matrix;return Matrix.ScalingToRef(e,t,i,r),r}static ScalingToRef(e,t,i,r){return Matrix.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,r),r._updateIdentityStatus(e===1&&t===1&&i===1),r}static Translation(e,t,i){const r=new Matrix;return Matrix.TranslationToRef(e,t,i,r),r}static TranslationToRef(e,t,i,r){return Matrix.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,r),r._updateIdentityStatus(e===0&&t===0&&i===0),r}static Lerp(e,t,i){const r=new e.constructor;return Matrix.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){const s=r._m,n=e.m,o=t.m;for(let l=0;l<16;l++)s[l]=n[l]*(1-i)+o[l]*i;return r.markAsUpdated(),r}static DecomposeLerp(e,t,i){const r=new e.constructor;return Matrix.DecomposeLerpToRef(e,t,i,r),r}static DecomposeLerpToRef(e,t,i,r){const s=MathTmp.Vector3[0],n=MathTmp.Quaternion[0],o=MathTmp.Vector3[1];e.decompose(s,n,o);const l=MathTmp.Vector3[2],h=MathTmp.Quaternion[1],u=MathTmp.Vector3[3];t.decompose(l,h,u);const c=MathTmp.Vector3[4];Vector3.LerpToRef(s,l,i,c);const d=MathTmp.Quaternion[2];Quaternion.SlerpToRef(n,h,i,d);const f=MathTmp.Vector3[5];return Vector3.LerpToRef(o,u,i,f),Matrix.ComposeToRef(c,d,f,r),r}static LookAtLH(e,t,i){const r=new Matrix;return Matrix.LookAtLHToRef(e,t,i,r),r}static LookAtLHToRef(e,t,i,r){const s=MathTmp.Vector3[0],n=MathTmp.Vector3[1],o=MathTmp.Vector3[2];t.subtractToRef(e,o),o.normalize(),Vector3.CrossToRef(i,o,s);const l=s.lengthSquared();l===0?s.x=1:s.normalizeFromLength(Math.sqrt(l)),Vector3.CrossToRef(o,s,n),n.normalize();const h=-Vector3.Dot(s,e),u=-Vector3.Dot(n,e),c=-Vector3.Dot(o,e);Matrix.FromValuesToRef(s._x,n._x,o._x,0,s._y,n._y,o._y,0,s._z,n._z,o._z,0,h,u,c,1,r)}static LookAtRH(e,t,i){const r=new Matrix;return Matrix.LookAtRHToRef(e,t,i,r),r}static LookAtRHToRef(e,t,i,r){const s=MathTmp.Vector3[0],n=MathTmp.Vector3[1],o=MathTmp.Vector3[2];e.subtractToRef(t,o),o.normalize(),Vector3.CrossToRef(i,o,s);const l=s.lengthSquared();l===0?s.x=1:s.normalizeFromLength(Math.sqrt(l)),Vector3.CrossToRef(o,s,n),n.normalize();const h=-Vector3.Dot(s,e),u=-Vector3.Dot(n,e),c=-Vector3.Dot(o,e);return Matrix.FromValuesToRef(s._x,n._x,o._x,0,s._y,n._y,o._y,0,s._z,n._z,o._z,0,h,u,c,1,r),r}static LookDirectionLH(e,t){const i=new Matrix;return Matrix.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const r=MathTmp.Vector3[0];r.copyFrom(e),r.scaleInPlace(-1);const s=MathTmp.Vector3[1];return Vector3.CrossToRef(t,r,s),Matrix.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,r._x,r._y,r._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new Matrix;return Matrix.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const r=MathTmp.Vector3[2];return Vector3.CrossToRef(t,e,r),Matrix.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,r,s){const n=new Matrix;return Matrix.OrthoLHToRef(e,t,i,r,n,s),n}static OrthoLHToRef(e,t,i,r,s,n){const o=i,l=r,h=2/e,u=2/t,c=2/(l-o),d=-(l+o)/(l-o);return Matrix.FromValuesToRef(h,0,0,0,0,u,0,0,0,0,c,0,0,0,d,1,s),n&&s.multiplyToRef(mtxConvertNDCToHalfZRange,s),s._updateIdentityStatus(h===1&&u===1&&c===1&&d===0),s}static OrthoOffCenterLH(e,t,i,r,s,n,o){const l=new Matrix;return Matrix.OrthoOffCenterLHToRef(e,t,i,r,s,n,l,o),l}static OrthoOffCenterLHToRef(e,t,i,r,s,n,o,l){const h=s,u=n,c=2/(t-e),d=2/(r-i),f=2/(u-h),_=-(u+h)/(u-h),g=(e+t)/(e-t),p=(r+i)/(i-r);return Matrix.FromValuesToRef(c,0,0,0,0,d,0,0,0,0,f,0,g,p,_,1,o),l&&o.multiplyToRef(mtxConvertNDCToHalfZRange,o),o.markAsUpdated(),o}static OrthoOffCenterRH(e,t,i,r,s,n,o){const l=new Matrix;return Matrix.OrthoOffCenterRHToRef(e,t,i,r,s,n,l,o),l}static OrthoOffCenterRHToRef(e,t,i,r,s,n,o,l){return Matrix.OrthoOffCenterLHToRef(e,t,i,r,s,n,o,l),o._m[10]*=-1,o}static PerspectiveLH(e,t,i,r,s,n=0){const o=new Matrix,l=i,h=r,u=2*l/e,c=2*l/t,d=(h+l)/(h-l),f=-2*h*l/(h-l),_=Math.tan(n);return Matrix.FromValuesToRef(u,0,0,0,0,c,0,_,0,0,d,1,0,0,f,0,o),s&&o.multiplyToRef(mtxConvertNDCToHalfZRange,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(e,t,i,r,s,n=0,o=!1){const l=new Matrix;return Matrix.PerspectiveFovLHToRef(e,t,i,r,l,!0,s,n,o),l}static PerspectiveFovLHToRef(e,t,i,r,s,n=!0,o,l=0,h=!1){const u=i,c=r,d=1/Math.tan(e*.5),f=n?d/t:d,_=n?d:d*t,g=h&&u===0?-1:c!==0?(c+u)/(c-u):1,p=h&&u===0?2*c:c!==0?-2*c*u/(c-u):-2*u,m=Math.tan(l);return Matrix.FromValuesToRef(f,0,0,0,0,_,0,m,0,0,g,1,0,0,p,0,s),o&&s.multiplyToRef(mtxConvertNDCToHalfZRange,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseLHToRef(e,t,i,r,s,n=!0,o,l=0){const h=1/Math.tan(e*.5),u=n?h/t:h,c=n?h:h*t,d=Math.tan(l);return Matrix.FromValuesToRef(u,0,0,0,0,c,0,d,0,0,-i,1,0,0,1,0,s),o&&s.multiplyToRef(mtxConvertNDCToHalfZRange,s),s._updateIdentityStatus(!1),s}static PerspectiveFovRH(e,t,i,r,s,n=0,o=!1){const l=new Matrix;return Matrix.PerspectiveFovRHToRef(e,t,i,r,l,!0,s,n,o),l}static PerspectiveFovRHToRef(e,t,i,r,s,n=!0,o,l=0,h=!1){const u=i,c=r,d=1/Math.tan(e*.5),f=n?d/t:d,_=n?d:d*t,g=h&&u===0?1:c!==0?-(c+u)/(c-u):-1,p=h&&u===0?2*c:c!==0?-2*c*u/(c-u):-2*u,m=Math.tan(l);return Matrix.FromValuesToRef(f,0,0,0,0,_,0,m,0,0,g,-1,0,0,p,0,s),o&&s.multiplyToRef(mtxConvertNDCToHalfZRange,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseRHToRef(e,t,i,r,s,n=!0,o,l=0){const h=1/Math.tan(e*.5),u=n?h/t:h,c=n?h:h*t,d=Math.tan(l);return Matrix.FromValuesToRef(u,0,0,0,0,c,0,d,0,0,-i,-1,0,0,-1,0,s),o&&s.multiplyToRef(mtxConvertNDCToHalfZRange,s),s._updateIdentityStatus(!1),s}static PerspectiveFovWebVRToRef(e,t,i,r,s=!1,n,o=0){const l=s?-1:1,h=Math.tan(e.upDegrees*Math.PI/180),u=Math.tan(e.downDegrees*Math.PI/180),c=Math.tan(e.leftDegrees*Math.PI/180),d=Math.tan(e.rightDegrees*Math.PI/180),f=2/(c+d),_=2/(h+u),g=Math.tan(o),p=r._m;return p[0]=f,p[1]=p[2]=p[3]=p[4]=0,p[5]=_,p[6]=0,p[7]=g,p[8]=(c-d)*f*.5,p[9]=-((h-u)*_*.5),p[10]=-i/(t-i),p[11]=1*l,p[12]=p[13]=p[15]=0,p[14]=-(2*i*t)/(i-t),n&&r.multiplyToRef(mtxConvertNDCToHalfZRange,r),r.markAsUpdated(),r}static GetFinalMatrix(e,t,i,r,s,n){const o=e.width,l=e.height,h=e.x,u=e.y,c=Matrix.FromValues(o/2,0,0,0,0,-l/2,0,0,0,0,n-s,0,h+o/2,l/2+u,s,1),d=new t.constructor;return t.multiplyToRef(i,d),d.multiplyToRef(r,d),d.multiplyToRef(c,d)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return PerformanceConfigurator.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return PerformanceConfigurator.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new e.constructor;return Matrix.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=t._m,r=e.m;return i[0]=r[0],i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=r[1],i[5]=r[5],i[6]=r[9],i[7]=r[13],i[8]=r[2],i[9]=r[6],i[10]=r[10],i[11]=r[14],i[12]=r[3],i[13]=r[7],i[14]=r[11],i[15]=r[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new Matrix;return Matrix.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,r=e.normal.y,s=e.normal.z,n=-2*i,o=-2*r,l=-2*s;return Matrix.FromValuesToRef(n*i+1,o*i,l*i,0,n*r,o*r+1,l*r,0,n*s,o*s,l*s+1,0,n*e.d,o*e.d,l*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,r){return Matrix.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,r),r}static FromQuaternionToRef(e,t){const i=e._x*e._x,r=e._y*e._y,s=e._z*e._z,n=e._x*e._y,o=e._z*e._w,l=e._z*e._x,h=e._y*e._w,u=e._y*e._z,c=e._x*e._w;return t._m[0]=1-2*(r+s),t._m[1]=2*(n+o),t._m[2]=2*(l-h),t._m[3]=0,t._m[4]=2*(n-o),t._m[5]=1-2*(s+i),t._m[6]=2*(u+c),t._m[7]=0,t._m[8]=2*(l+h),t._m[9]=2*(u-c),t._m[10]=1-2*(r+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}Matrix._UpdateFlagSeed=0;Matrix._IdentityReadOnly=Matrix.Identity();class MathTmp{}MathTmp.Vector3=ArrayTools.BuildTuple(11,Vector3.Zero);MathTmp.Matrix=ArrayTools.BuildTuple(2,Matrix.Identity);MathTmp.Quaternion=ArrayTools.BuildTuple(3,Quaternion.Zero);class TmpVectors{}TmpVectors.Vector2=ArrayTools.BuildTuple(3,Vector2.Zero);TmpVectors.Vector3=ArrayTools.BuildTuple(13,Vector3.Zero);TmpVectors.Vector4=ArrayTools.BuildTuple(3,Vector4.Zero);TmpVectors.Quaternion=ArrayTools.BuildTuple(2,Quaternion.Zero);TmpVectors.Matrix=ArrayTools.BuildTuple(8,Matrix.Identity);RegisterClass("BABYLON.Vector2",Vector2);RegisterClass("BABYLON.Vector3",Vector3);RegisterClass("BABYLON.Vector4",Vector4);RegisterClass("BABYLON.Matrix",Matrix);const mtxConvertNDCToHalfZRange=Matrix.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);class DataBuffer{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=DataBuffer._Counter++}}DataBuffer._Counter=0;class Buffer{constructor(e,t,i,r=0,s=!1,n=!1,o=!1,l){this._isAlreadyOwned=!1,e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=n,this._divisor=l||1,t instanceof DataBuffer?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?r:r*Float32Array.BYTES_PER_ELEMENT,s||this.create()}createVertexBuffer(e,t,i,r,s,n=!1,o){const l=n?t:t*Float32Array.BYTES_PER_ELEMENT,h=r?n?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new VertexBuffer(this._engine,this,e,this._updatable,!0,h,s===void 0?this._instanced:s,l,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e)))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,t,i,r=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),t===0&&i===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)}}class VertexBuffer{get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}constructor(e,t,i,r,s,n,o,l,h,u,c=!1,d=!1,f=1,_=!1){if(t instanceof Buffer?(this._buffer=t,this._ownsBuffer=_):(this._buffer=new Buffer(e,t,r,n,s,o,d),this._ownsBuffer=!0),this.uniqueId=VertexBuffer._Counter++,this._kind=i,u==null){const p=this.getData();this.type=VertexBuffer.FLOAT,p instanceof Int8Array?this.type=VertexBuffer.BYTE:p instanceof Uint8Array?this.type=VertexBuffer.UNSIGNED_BYTE:p instanceof Int16Array?this.type=VertexBuffer.SHORT:p instanceof Uint16Array?this.type=VertexBuffer.UNSIGNED_SHORT:p instanceof Int32Array?this.type=VertexBuffer.INT:p instanceof Uint32Array&&(this.type=VertexBuffer.UNSIGNED_INT)}else this.type=u;const g=VertexBuffer.GetTypeByteLength(this.type);d?(this._size=h||(n?n/g:VertexBuffer.DeduceStride(i)),this.byteStride=n||this._buffer.byteStride||this._size*g,this.byteOffset=l||0):(this._size=h||n||VertexBuffer.DeduceStride(i),this.byteStride=n?n*g:this._buffer.byteStride||this._size*g,this.byteOffset=(l||0)*g),this.normalized=c,this._instanced=o!==void 0?o:!1,this._instanceDivisor=o?f:0,this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer&&this._buffer._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();if(!i)return null;const r=this.getSize()*VertexBuffer.GetTypeByteLength(this.type),s=e*this.getSize();if(this.type!==VertexBuffer.FLOAT||this.byteStride!==r){const n=new Float32Array(s);return this.forEach(s,(o,l)=>n[l]=o),n}if(!(i instanceof Array||i instanceof Float32Array)||this.byteOffset!==0||i.length!==s)if(i instanceof Array){const n=this.byteOffset/4;return i.slice(n,n+s)}else{if(i instanceof ArrayBuffer)return new Float32Array(i,this.byteOffset,s);{let n=i.byteOffset+this.byteOffset;if(t){const l=new Float32Array(s),h=new Float32Array(i.buffer,n,s);return l.set(h),l}const o=n%4;return o&&(n=Math.max(0,n-o)),new Float32Array(i.buffer,n,s)}}return t?i.slice():i}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/VertexBuffer.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/VertexBuffer.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*VertexBuffer.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e)}update(e){this._buffer.update(e)}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i)}dispose(){this._ownsBuffer&&this._buffer.dispose()}forEach(e,t){VertexBuffer.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)}static DeduceStride(e){switch(e){case VertexBuffer.UVKind:case VertexBuffer.UV2Kind:case VertexBuffer.UV3Kind:case VertexBuffer.UV4Kind:case VertexBuffer.UV5Kind:case VertexBuffer.UV6Kind:return 2;case VertexBuffer.NormalKind:case VertexBuffer.PositionKind:return 3;case VertexBuffer.ColorKind:case VertexBuffer.MatricesIndicesKind:case VertexBuffer.MatricesIndicesExtraKind:case VertexBuffer.MatricesWeightsKind:case VertexBuffer.MatricesWeightsExtraKind:case VertexBuffer.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetTypeByteLength(e){switch(e){case VertexBuffer.BYTE:case VertexBuffer.UNSIGNED_BYTE:return 1;case VertexBuffer.SHORT:case VertexBuffer.UNSIGNED_SHORT:return 2;case VertexBuffer.INT:case VertexBuffer.UNSIGNED_INT:case VertexBuffer.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,t,i,r,s,n,o,l){if(e instanceof Array){let h=t/4;const u=i/4;for(let c=0;c<n;c+=r){for(let d=0;d<r;d++)l(e[h+d],c+d);h+=u}}else{const h=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),u=VertexBuffer.GetTypeByteLength(s);for(let c=0;c<n;c+=r){let d=t;for(let f=0;f<r;f++){const _=VertexBuffer._GetFloatValue(h,s,d,o);l(_,c+f),d+=u}t+=i}}}static _GetFloatValue(e,t,i,r){switch(t){case VertexBuffer.BYTE:{let s=e.getInt8(i);return r&&(s=Math.max(s/127,-1)),s}case VertexBuffer.UNSIGNED_BYTE:{let s=e.getUint8(i);return r&&(s=s/255),s}case VertexBuffer.SHORT:{let s=e.getInt16(i,!0);return r&&(s=Math.max(s/32767,-1)),s}case VertexBuffer.UNSIGNED_SHORT:{let s=e.getUint16(i,!0);return r&&(s=s/65535),s}case VertexBuffer.INT:return e.getInt32(i,!0);case VertexBuffer.UNSIGNED_INT:return e.getUint32(i,!0);case VertexBuffer.FLOAT:return e.getFloat32(i,!0);default:throw new Error(`Invalid component type ${t}`)}}}VertexBuffer._Counter=0;VertexBuffer.BYTE=5120;VertexBuffer.UNSIGNED_BYTE=5121;VertexBuffer.SHORT=5122;VertexBuffer.UNSIGNED_SHORT=5123;VertexBuffer.INT=5124;VertexBuffer.UNSIGNED_INT=5125;VertexBuffer.FLOAT=5126;VertexBuffer.PositionKind="position";VertexBuffer.NormalKind="normal";VertexBuffer.TangentKind="tangent";VertexBuffer.UVKind="uv";VertexBuffer.UV2Kind="uv2";VertexBuffer.UV3Kind="uv3";VertexBuffer.UV4Kind="uv4";VertexBuffer.UV5Kind="uv5";VertexBuffer.UV6Kind="uv6";VertexBuffer.ColorKind="color";VertexBuffer.ColorInstanceKind="instanceColor";VertexBuffer.MatricesIndicesKind="matricesIndices";VertexBuffer.MatricesWeightsKind="matricesWeights";VertexBuffer.MatricesIndicesExtraKind="matricesIndicesExtra";VertexBuffer.MatricesWeightsExtraKind="matricesWeightsExtra";class PickingInfo{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(VertexBuffer.NormalKind))return null;let i=this.pickedMesh.getIndices();(i==null?void 0:i.length)===0&&(i=null);let r;const s=TmpVectors.Vector3[0],n=TmpVectors.Vector3[1],o=TmpVectors.Vector3[2];if(t){const h=this.pickedMesh.getVerticesData(VertexBuffer.NormalKind);let u=i?Vector3.FromArrayToRef(h,i[this.faceId*3]*3,s):s.copyFromFloats(h[this.faceId*3*3],h[this.faceId*3*3+1],h[this.faceId*3*3+2]),c=i?Vector3.FromArrayToRef(h,i[this.faceId*3+1]*3,n):n.copyFromFloats(h[(this.faceId*3+1)*3],h[(this.faceId*3+1)*3+1],h[(this.faceId*3+1)*3+2]),d=i?Vector3.FromArrayToRef(h,i[this.faceId*3+2]*3,o):o.copyFromFloats(h[(this.faceId*3+2)*3],h[(this.faceId*3+2)*3+1],h[(this.faceId*3+2)*3+2]);u=u.scale(this.bu),c=c.scale(this.bv),d=d.scale(1-this.bu-this.bv),r=new Vector3(u.x+c.x+d.x,u.y+c.y+d.y,u.z+c.z+d.z)}else{const h=this.pickedMesh.getVerticesData(VertexBuffer.PositionKind),u=i?Vector3.FromArrayToRef(h,i[this.faceId*3]*3,s):s.copyFromFloats(h[this.faceId*3*3],h[this.faceId*3*3+1],h[this.faceId*3*3+2]),c=i?Vector3.FromArrayToRef(h,i[this.faceId*3+1]*3,n):n.copyFromFloats(h[(this.faceId*3+1)*3],h[(this.faceId*3+1)*3+1],h[(this.faceId*3+1)*3+2]),d=i?Vector3.FromArrayToRef(h,i[this.faceId*3+2]*3,o):o.copyFromFloats(h[(this.faceId*3+2)*3],h[(this.faceId*3+2)*3+1],h[(this.faceId*3+2)*3+2]),f=u.subtract(c),_=d.subtract(c);r=Vector3.Cross(f,_)}const l=(h,u)=>{let c=h.getWorldMatrix();h.nonUniformScaling&&(TmpVectors.Matrix[0].copyFrom(c),c=TmpVectors.Matrix[0],c.setTranslationFromFloats(0,0,0),c.invert(),c.transposeToRef(TmpVectors.Matrix[1]),c=TmpVectors.Matrix[1]),Vector3.TransformNormalToRef(u,c,u)};if(e&&l(this.pickedMesh,r),this.ray){const h=TmpVectors.Vector3[0].copyFrom(r);e||l(this.pickedMesh,h),Vector3.Dot(h,this.ray.direction)>0&&r.negateInPlace()}return r.normalize(),r}getTextureCoordinates(e=VertexBuffer.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let r=Vector2.FromArray(i,t[this.faceId*3]*2),s=Vector2.FromArray(i,t[this.faceId*3+1]*2),n=Vector2.FromArray(i,t[this.faceId*3+2]*2);return r=r.scale(this.bu),s=s.scale(this.bv),n=n.scale(1-this.bu-this.bv),new Vector2(r.x+s.x+n.x,r.y+s.y+n.y)}}class IntersectionInfo{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}function IsWindowObjectExist(){return typeof window<"u"}function IsNavigatorAvailable(){return typeof navigator<"u"}function IsDocumentAvailable(){return typeof document<"u"}function GetDOMTextContent(a){let e="",t=a.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}const DomManagement={IsWindowObjectExist,IsNavigatorAvailable,IsDocumentAvailable,GetDOMTextContent};class Logger{static _CheckLimit(e,t){let i=Logger._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},Logger._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){var i;const r=Logger._LogLimitOutputs[e];if(!r||!Logger.MessageLimitReached)return;const s=this._Levels[t];r.current===r.limit&&Logger[s.name](Logger.MessageLimitReached.replace(/%LIMIT%/g,""+r.limit).replace(/%TYPE%/g,(i=s.name)!==null&&i!==void 0?i:""))}static _AddLogEntry(e){Logger._LogCache=e+Logger._LogCache,Logger.OnNewCacheEntry&&Logger.OnNewCacheEntry(e)}static _FormatMessage(e){const t=r=>r<10?"0"+r:""+r,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){if(i!==void 0&&!Logger._CheckLimit(t,i))return;const r=Logger._FormatMessage(t),s=this._Levels[e];s.logFunc&&s.logFunc("BJS - "+r);const n=`<div style='color:${s.color}'>${r}</div><br>`;Logger._AddLogEntry(n),Logger._GenerateLimitMessage(t,e)}static get LogCache(){return Logger._LogCache}static ClearLogCache(){Logger._LogCache="",Logger._LogLimitOutputs={},Logger.errorsCount=0}static set LogLevels(e){Logger.Log=Logger._LogDisabled,Logger.Warn=Logger._LogDisabled,Logger.Error=Logger._LogDisabled,[Logger.MessageLogLevel,Logger.WarningLogLevel,Logger.ErrorLogLevel].forEach(t=>{if((e&t)===t){const i=this._Levels[t];Logger[i.name]=Logger._LogEnabled.bind(Logger,t)}})}}Logger.NoneLogLevel=0;Logger.MessageLogLevel=1;Logger.WarningLogLevel=2;Logger.ErrorLogLevel=4;Logger.AllLogLevel=7;Logger.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";Logger._LogCache="";Logger._LogLimitOutputs={};Logger._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];Logger.errorsCount=0;Logger.Log=Logger._LogEnabled.bind(Logger,Logger.MessageLogLevel);Logger.Warn=Logger._LogEnabled.bind(Logger,Logger.WarningLogLevel);Logger.Error=Logger._LogEnabled.bind(Logger,Logger.ErrorLogLevel);const CloneValue=(a,e)=>!a||a.getClassName&&a.getClassName()==="Mesh"?null:a.getClassName&&(a.getClassName()==="SubMesh"||a.getClassName()==="PhysicsBody")?a.clone(e):a.clone?a.clone():Array.isArray(a)?a.slice():null;function GetAllPropertyNames(a){const e=[];do Object.getOwnPropertyNames(a).forEach(function(t){e.indexOf(t)===-1&&e.push(t)});while(a=Object.getPrototypeOf(a));return e}class DeepCopier{static DeepCopy(e,t,i,r){const s=GetAllPropertyNames(e);for(const n of s){if(n[0]==="_"&&(!r||r.indexOf(n)===-1)||n.endsWith("Observable")||i&&i.indexOf(n)!==-1)continue;const o=e[n],l=typeof o;if(l!=="function")try{if(l==="object")if(o instanceof Uint8Array)t[n]=Uint8Array.from(o);else if(o instanceof Array){if(t[n]=[],o.length>0)if(typeof o[0]=="object")for(let h=0;h<o.length;h++){const u=CloneValue(o[h],t);t[n].indexOf(u)===-1&&t[n].push(u)}else t[n]=o.slice(0)}else t[n]=CloneValue(o,t);else t[n]=o}catch(h){Logger.Warn(h.message)}}}}class PrecisionDate{static get Now(){return DomManagement.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}function _WarnImport(a){return`${a} needs to be imported before as it contains a side-effect required by your code.`}function createXMLHttpRequest(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}class WebRequest{constructor(){this._xhr=createXMLHttpRequest(),this._requestURL=""}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in WebRequest.CustomRequestHeaders){const t=WebRequest.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return WebRequest.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){WebRequest.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const i of WebRequest.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;i(this._xhr,t)}return t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}WebRequest.CustomRequestHeaders={};WebRequest.CustomRequestModifiers=new Array;WebRequest.SkipRequestModificationForBabylonCDN=!0;class FilesInputStore{}FilesInputStore.FilesToLoad={};class RetryStrategy{static ExponentialBackoff(e=3,t=500){return(i,r,s)=>r.status!==0||s>=e||i.indexOf("file:")!==-1?-1:Math.pow(2,s)*t}}class BaseError extends Error{}BaseError._setPrototypeOf=Object.setPrototypeOf||((a,e)=>(a.__proto__=e,a));const ErrorCodes={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};class RuntimeError extends BaseError{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",BaseError._setPrototypeOf(this,RuntimeError.prototype)}}const Decode=a=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(a);let e="";for(let t=0;t<a.byteLength;t++)e+=String.fromCharCode(a[t]);return e},EncodeArrayBufferToBase64=a=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let t="",i,r,s,n,o,l,h,u=0;const c=ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a);for(;u<c.length;)i=c[u++],r=u<c.length?c[u++]:Number.NaN,s=u<c.length?c[u++]:Number.NaN,n=i>>2,o=(i&3)<<4|r>>4,l=(r&15)<<2|s>>6,h=s&63,isNaN(r)?l=h=64:isNaN(s)&&(h=64),t+=e.charAt(n)+e.charAt(o)+e.charAt(l)+e.charAt(h);return t},DecodeBase64ToString=a=>atob(a),DecodeBase64ToBinary=a=>{const e=DecodeBase64ToString(a),t=e.length,i=new Uint8Array(new ArrayBuffer(t));for(let r=0;r<t;r++)i[r]=e.charCodeAt(r);return i.buffer},defaultAttributeKeywordName="attribute",defaultVaryingKeywordName="varying";class ShaderCodeNode{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var i,r,s,n,o,l,h;let u="";if(this.line){let c=this.line;const d=t.processor;if(d){d.lineProcessor&&(c=d.lineProcessor(c,t.isFragment,t.processingContext));const f=(r=(i=t.processor)===null||i===void 0?void 0:i.attributeKeywordName)!==null&&r!==void 0?r:defaultAttributeKeywordName,_=t.isFragment&&(!((s=t.processor)===null||s===void 0)&&s.varyingFragmentKeywordName)?(n=t.processor)===null||n===void 0?void 0:n.varyingFragmentKeywordName:!t.isFragment&&(!((o=t.processor)===null||o===void 0)&&o.varyingVertexKeywordName)?(l=t.processor)===null||l===void 0?void 0:l.varyingVertexKeywordName:defaultVaryingKeywordName;!t.isFragment&&d.attributeProcessor&&this.line.startsWith(f)?c=d.attributeProcessor(this.line,e,t.processingContext):d.varyingProcessor&&(!((h=d.varyingCheck)===null||h===void 0)&&h.call(d,this.line,t.isFragment)||!d.varyingCheck&&this.line.startsWith(_))?c=d.varyingProcessor(this.line,t.isFragment,e,t.processingContext):d.uniformProcessor&&d.uniformRegexp&&d.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(c=d.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):d.uniformBufferProcessor&&d.uniformBufferRegexp&&d.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(c=d.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):d.textureProcessor&&d.textureRegexp&&d.textureRegexp.test(this.line)?c=d.textureProcessor(this.line,t.isFragment,e,t.processingContext):(d.uniformProcessor||d.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?d.uniformProcessor&&(c=d.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):d.uniformBufferProcessor&&(c=d.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,d.endOfUniformBufferProcessor&&(c=d.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}u+=c+`\r
`}return this.children.forEach(c=>{u+=c.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),u}}class ShaderCodeCursor{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(t[0]==="#"){this._lines.push(t);continue}if(t.trim().startsWith("//")){this._lines.push(t);continue}const i=t.split(";");for(let r=0;r<i.length;r++){let s=i[r];s=s.trim(),s&&this._lines.push(s+(r!==i.length-1?";":""))}}}}class ShaderCodeConditionNode extends ShaderCodeNode{process(e,t){for(let i=0;i<this.children.length;i++){const r=this.children[i];if(r.isValid(e))return r.process(e,t)}return""}}class ShaderCodeTestNode extends ShaderCodeNode{isValid(e){return this.testExpression.isTrue(e)}}class ShaderDefineExpression{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(ShaderDefineExpression._OperatorPriority[i]===void 0)t.push(i);else{const r=t[t.length-1],s=t[t.length-2];t.length-=2,t.push(`(${s}${i}${r})`)}return t[t.length-1]}static infixToPostfix(e){const t=ShaderDefineExpression._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!e.includes("&&")&&!e.includes("||")&&!e.includes(")")&&!e.includes("("))return[e];const i=[];let r=-1;const s=()=>{u=u.trim(),u!==""&&(i.push(u),u="")},n=c=>{r<ShaderDefineExpression._Stack.length-1&&(ShaderDefineExpression._Stack[++r]=c)},o=()=>ShaderDefineExpression._Stack[r],l=()=>r===-1?"!!INVALID EXPRESSION!!":ShaderDefineExpression._Stack[r--];let h=0,u="";for(;h<e.length;){const c=e.charAt(h),d=h<e.length-1?e.substr(h,2):"";if(c==="(")u="",n(c);else if(c===")"){for(s();r!==-1&&o()!=="(";)i.push(l());l()}else if(ShaderDefineExpression._OperatorPriority[d]>1){for(s();r!==-1&&ShaderDefineExpression._OperatorPriority[o()]>=ShaderDefineExpression._OperatorPriority[d];)i.push(l());n(d),h++}else u+=c;h++}for(s();r!==-1;)o()==="("?l():i.push(l());return ShaderDefineExpression._InfixToPostfixCache.size>=ShaderDefineExpression.InfixToPostfixCacheLimitSize&&ShaderDefineExpression.ClearCache(),ShaderDefineExpression._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(ShaderDefineExpression._InfixToPostfixCache.entries()).sort((t,i)=>t[1].accessTime-i[1].accessTime);for(let t=0;t<ShaderDefineExpression.InfixToPostfixCacheCleanupSize;t++)ShaderDefineExpression._InfixToPostfixCache.delete(e[t][0])}}ShaderDefineExpression.InfixToPostfixCacheLimitSize=5e4;ShaderDefineExpression.InfixToPostfixCacheCleanupSize=25e3;ShaderDefineExpression._InfixToPostfixCache=new Map;ShaderDefineExpression._OperatorPriority={")":0,"(":1,"||":2,"&&":3};ShaderDefineExpression._Stack=["","","","","","","","","","","","","","","","","","","",""];class ShaderDefineIsDefinedOperator extends ShaderDefineExpression{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}}class ShaderDefineOrOperator extends ShaderDefineExpression{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class ShaderDefineAndOperator extends ShaderDefineExpression{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class ShaderDefineArithmeticOperator extends ShaderDefineExpression{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];t===void 0&&(t=this.define);let i=!1;const r=parseInt(t),s=parseInt(this.testValue);switch(this.operand){case">":i=r>s;break;case"<":i=r<s;break;case"<=":i=r<=s;break;case">=":i=r>=s;break;case"==":i=r===s;break;case"!=":i=r!==s;break}return i}}var ShaderLanguage;(function(a){a[a.GLSL=0]="GLSL",a[a.WGSL=1]="WGSL"})(ShaderLanguage||(ShaderLanguage={}));const regexSE=/defined\s*?\((.+?)\)/g,regexSERevert=/defined\s*?\[(.+?)\]/g,regexShaderInclude=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,regexShaderDecl=/__decl__/,regexLightX=/light\{X\}.(\w*)/g,regexX=/\{X\}/g,reusableMatches=[];class ShaderProcessor{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,i,r){var s;!((s=t.processor)===null||s===void 0)&&s.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,n=>{t.processCodeAfterIncludes&&(n=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",n));const o=this._ProcessShaderConversion(n,t,r);i(o,n)})}static PreProcess(e,t,i,r){var s;!((s=t.processor)===null||s===void 0)&&s.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,n=>{t.processCodeAfterIncludes&&(n=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",n));const o=this._ApplyPreProcessing(n,t,r);i(o,n)})}static Finalize(e,t,i){return!i.processor||!i.processor.finalizeShaders?{vertexCode:e,fragmentCode:t}:i.processor.finalizeShaders(e,t,i.processingContext)}static _ProcessPrecision(e,t){var i;if(!((i=t.processor)===null||i===void 0)&&i.noPrecision)return e;const r=t.shouldUseHighPrecisionShader;return e.indexOf("precision highp float")===-1?r?e=`precision highp float;
`+e:e=`precision mediump float;
`+e:r||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const i=/defined\((.+)\)/.exec(e);if(i&&i.length)return new ShaderDefineIsDefinedOperator(i[1].trim(),e[0]==="!");const r=["==","!=",">=","<=","<",">"];let s="",n=0;for(s of r)if(n=e.indexOf(s),n>-1)break;if(n===-1)return new ShaderDefineIsDefinedOperator(e);const o=e.substring(0,n).trim(),l=e.substring(n+s.length).trim();return new ShaderDefineArithmeticOperator(o,s,l)}static _BuildSubExpression(e){e=e.replace(regexSE,"defined[$1]");const t=ShaderDefineExpression.infixToPostfix(e),i=[];for(const s of t)if(s!=="||"&&s!=="&&")i.push(s);else if(i.length>=2){let n=i[i.length-1],o=i[i.length-2];i.length-=2;const l=s=="&&"?new ShaderDefineAndOperator:new ShaderDefineOrOperator;typeof n=="string"&&(n=n.replace(regexSERevert,"defined($1)")),typeof o=="string"&&(o=o.replace(regexSERevert,"defined($1)")),l.leftOperand=typeof o=="string"?this._ExtractOperation(o):o,l.rightOperand=typeof n=="string"?this._ExtractOperation(n):n,i.push(l)}let r=i[i.length-1];return typeof r=="string"&&(r=r.replace(regexSERevert,"defined($1)")),typeof r=="string"?this._ExtractOperation(r):r}static _BuildExpression(e,t){const i=new ShaderCodeTestNode,r=e.substring(0,t);let s=e.substring(t);return s=s.substring(0,(s.indexOf("//")+1||s.length+1)-1).trim(),r==="#ifdef"?i.testExpression=new ShaderDefineIsDefinedOperator(s):r==="#ifndef"?i.testExpression=new ShaderDefineIsDefinedOperator(s,!0):i.testExpression=this._BuildSubExpression(s),i}static _MoveCursorWithinIf(e,t,i){let r=e.currentLine;for(;this._MoveCursor(e,i);){r=e.currentLine;const s=r.substring(0,5).toLowerCase();if(s==="#else"){const n=new ShaderCodeNode;t.children.push(n),this._MoveCursor(e,n);return}else if(s==="#elif"){const n=this._BuildExpression(r,5);t.children.push(n),i=n}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine;if(i.indexOf("#")>=0){const s=ShaderProcessor._MoveCursorRegex.exec(i);if(s&&s.length){switch(s[0]){case"#ifdef":{const o=new ShaderCodeConditionNode;t.children.push(o);const l=this._BuildExpression(i,6);o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const o=new ShaderCodeConditionNode;t.children.push(o);const l=this._BuildExpression(i,7);o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}case"#if":{const o=new ShaderCodeConditionNode,l=this._BuildExpression(i,3);t.children.push(o),o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}}continue}}const r=new ShaderCodeNode;if(r.line=i,t.children.push(r),i[0]==="#"&&i[1]==="d"){const s=i.replace(";","").split(" ");r.additionalDefineKey=s[1],s.length===3&&(r.additionalDefineValue=s[2])}}return!1}static _EvaluatePreProcessors(e,t,i){const r=new ShaderCodeNode,s=new ShaderCodeCursor;return s.lineIndex=-1,s.lines=e.split(`
`),this._MoveCursor(s,r),r.process(t,i)}static _PreparePreProcessors(e,t){var i;const r=e.defines,s={};for(const n of r){const l=n.replace("#define","").replace(";","").trim().split(" ");s[l[0]]=l.length>1?l[1]:""}return((i=e.processor)===null||i===void 0?void 0:i.shaderLanguage)===ShaderLanguage.GLSL&&(s.GL_ES="true"),s.__VERSION__=e.version,s[e.platformName]="true",t._getGlobalDefines(s),s}static _ProcessShaderConversion(e,t,i){let r=this._ProcessPrecision(e,t);if(!t.processor||t.processor.shaderLanguage===ShaderLanguage.GLSL&&r.indexOf("#version 3")!==-1&&(r=r.replace("#version 300 es",""),!t.processor.parseGLES3))return r;const s=t.defines,n=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(r=t.processor.preProcessor(r,s,t.isFragment,t.processingContext)),r=this._EvaluatePreProcessors(r,n,t),t.processor.postProcessor&&(r=t.processor.postProcessor(r,s,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(r=i.inlineShaderCode(r)),r}static _ApplyPreProcessing(e,t,i){var r,s;let n=e;const o=t.defines,l=this._PreparePreProcessors(t,i);return!((r=t.processor)===null||r===void 0)&&r.preProcessor&&(n=t.processor.preProcessor(n,o,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,l,t),!((s=t.processor)===null||s===void 0)&&s.postProcessor&&(n=t.processor.postProcessor(n,o,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n}static _ProcessIncludes(e,t,i){reusableMatches.length=0;let r;for(;(r=regexShaderInclude.exec(e))!==null;)reusableMatches.push(r);let s=String(e),n=[e],o=!1;for(const l of reusableMatches){let h=l[1];if(h.indexOf("__decl__")!==-1&&(h=h.replace(regexShaderDecl,""),t.supportsUniformBuffers&&(h=h.replace("Vertex","Ubo").replace("Fragment","Ubo")),h=h+"Declaration"),t.includesShadersStore[h]){let u=t.includesShadersStore[h];if(l[2]){const d=l[3].split(",");for(let f=0;f<d.length;f+=2){const _=new RegExp(d[f],"g"),g=d[f+1];u=u.replace(_,g)}}if(l[4]){const d=l[5];if(d.indexOf("..")!==-1){const f=d.split(".."),_=parseInt(f[0]);let g=parseInt(f[1]),p=u.slice(0);u="",isNaN(g)&&(g=t.indexParameters[f[1]]);for(let m=_;m<g;m++)t.supportsUniformBuffers||(p=p.replace(regexLightX,(E,M)=>M+"{X}")),u+=p.replace(regexX,m.toString())+`
`}else t.supportsUniformBuffers||(u=u.replace(regexLightX,(f,_)=>_+"{X}")),u=u.replace(regexX,d)}const c=[];for(const d of n){const f=d.split(l[0]);for(let _=0;_<f.length-1;_++)c.push(f[_]),c.push(u);c.push(f[f.length-1])}n=c,o=o||u.indexOf("#include<")>=0||u.indexOf("#include <")>=0}else{const u=t.shadersRepository+"ShadersInclude/"+h+".fx";ShaderProcessor._FileToolsLoadFile(u,c=>{t.includesShadersStore[h]=c,this._ProcessIncludes(n.join(""),t,i)});return}}reusableMatches.length=0,s=n.join(""),o?this._ProcessIncludes(s.toString(),t,i):i(s)}static _FileToolsLoadFile(e,t,i,r,s,n){throw _WarnImport("FileTools")}}ShaderProcessor._MoveCursorRegex=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;class ShaderStore{static GetShadersRepository(e=ShaderLanguage.GLSL){return e===ShaderLanguage.GLSL?ShaderStore.ShadersRepository:ShaderStore.ShadersRepositoryWGSL}static GetShadersStore(e=ShaderLanguage.GLSL){return e===ShaderLanguage.GLSL?ShaderStore.ShadersStore:ShaderStore.ShadersStoreWGSL}static GetIncludesShadersStore(e=ShaderLanguage.GLSL){return e===ShaderLanguage.GLSL?ShaderStore.IncludesShadersStore:ShaderStore.IncludesShadersStoreWGSL}}ShaderStore.ShadersRepository="src/Shaders/";ShaderStore.ShadersStore={};ShaderStore.IncludesShadersStore={};ShaderStore.ShadersRepositoryWGSL="src/ShadersWGSL/";ShaderStore.ShadersStoreWGSL={};ShaderStore.IncludesShadersStoreWGSL={};class Effect{static get ShadersRepository(){return ShaderStore.ShadersRepository}static set ShadersRepository(e){ShaderStore.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new Observable),this._onBindObservable}constructor(e,t,i,r=null,s,n=null,o=null,l=null,h=null,u,c="",d=ShaderLanguage.GLSL){var f,_,g;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new Observable,this.onErrorObservable=new Observable,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=e,this._key=c;let p,m=null;if(t.attributes){const b=t;if(this._engine=i,this._attributesNames=b.attributes,this._uniformsNames=b.uniformsNames.concat(b.samplers),this._samplerList=b.samplers.slice(),this.defines=b.defines,this.onError=b.onError,this.onCompiled=b.onCompiled,this._fallbacks=b.fallbacks,this._indexParameters=b.indexParameters,this._transformFeedbackVaryings=b.transformFeedbackVaryings||null,this._multiTarget=!!b.multiTarget,this._shaderLanguage=(f=b.shaderLanguage)!==null&&f!==void 0?f:ShaderLanguage.GLSL,b.uniformBuffersNames){this._uniformBuffersNamesList=b.uniformBuffersNames.slice();for(let y=0;y<b.uniformBuffersNames.length;y++)this._uniformBuffersNames[b.uniformBuffersNames[y]]=y}m=(_=b.processFinalCode)!==null&&_!==void 0?_:null,p=(g=b.processCodeAfterIncludes)!==null&&g!==void 0?g:void 0}else this._engine=s,this.defines=n??"",this._uniformsNames=i.concat(r),this._samplerList=r?r.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=d,this.onError=h,this.onCompiled=l,this._indexParameters=u,this._fallbacks=o;this._attributeLocationByName={},this.uniqueId=Effect._UniqueIdSeed++;let E,M;const x=IsWindowObjectExist()?this._engine.getHostDocument():null;e.vertexSource?E="source:"+e.vertexSource:e.vertexElement?(E=x?x.getElementById(e.vertexElement):null,E||(E=e.vertexElement)):E=e.vertex||e,e.fragmentSource?M="source:"+e.fragmentSource:e.fragmentElement?(M=x?x.getElementById(e.fragmentElement):null,M||(M=e.fragmentElement)):M=e.fragment||e,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let A={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:ShaderStore.GetShadersRepository(this._shaderLanguage),includesShadersStore:ShaderStore.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:p};const T=[void 0,void 0],C=()=>{if(T[0]&&T[1]){A.isFragment=!0;const[b,y]=T;ShaderProcessor.Process(y,A,(S,R)=>{this._fragmentSourceCodeBeforeMigration=R,m&&(S=m("fragment",S));const P=ShaderProcessor.Finalize(b,S,A);A=null,this._useFinalCode(P.vertexCode,P.fragmentCode,e)},this._engine)}};this._loadShader(E,"Vertex","",b=>{ShaderProcessor.Initialize(A),ShaderProcessor.Process(b,A,(y,S)=>{this._rawVertexSourceCode=b,this._vertexSourceCodeBeforeMigration=S,m&&(y=m("vertex",y)),T[0]=y,C()},this._engine)}),this._loadShader(M,"Fragment","Pixel",b=>{this._rawFragmentSourceCode=b,T[1]=b,C()})}_useFinalCode(e,t,i){if(i){const r=i.vertexElement||i.vertex||i.spectorName||i,s=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===ShaderLanguage.WGSL?"//":"")+"#define SHADER_NAME vertex:"+r+`
`+e,this._fragmentSourceCode=(this._shaderLanguage===ShaderLanguage.WGSL?"//":"")+"#define SHADER_NAME fragment:"+s+`
`+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,r){if(typeof HTMLElement<"u"&&e instanceof HTMLElement){const o=GetDOMTextContent(e);r(o);return}if(e.substr(0,7)==="source:"){r(e.substr(7));return}if(e.substr(0,7)==="base64:"){const o=window.atob(e.substr(7));r(o);return}const s=ShaderStore.GetShadersStore(this._shaderLanguage);if(s[e+t+"Shader"]){r(s[e+t+"Shader"]);return}if(i&&s[e+i+"Shader"]){r(s[e+i+"Shader"]);return}let n;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?n=e:n=ShaderStore.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(n+"."+t.toLowerCase()+".fx",r)}get vertexSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getVertexShaderCode())!==null&&t!==void 0?t:this._vertexSourceCode}get fragmentSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getFragmentShaderCode())!==null&&t!==void 0?t:this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,t,i,r){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(s,n)=>{r&&r(n)},this.onCompiled=()=>{const s=this.getEngine().scenes;if(s)for(let n=0;n<s.length;n++)s[n].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(){const e=this._attributesNames,t=this.defines,i=this._pipelineContext;this._isReady=!1;try{const r=this._engine;this._pipelineContext=r.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;const s=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?r._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,null,this._transformFeedbackVaryings,this._key):r._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,t,this._transformFeedbackVaryings,this._key),r._executeWhenRenderingStateIsCompiled(this._pipelineContext,()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,e,this._attributes),e)for(let n=0;n<e.length;n++){const o=e[n];this._attributeLocationByName[o]=this._attributes[n]}r.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),i&&this.getEngine()._deletePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(r){this._processCompilationErrors(r,i)}}_getShaderCodeAndErrorLine(e,t,i){const r=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let s=null;if(t&&e){const n=t.match(r);if(n&&n.length===2){const o=parseInt(n[1]),l=e.split(`
`,-1);l.length>=o&&(s=`Offending line [${o}] in ${i?"fragment":"vertex"} code: ${l[o-1]}`)}}return[e,s]}_processCompilationErrors(e,t=null){var i,r,s;this._compilationError=e.message;const n=this._attributesNames,o=this._fallbacks;if(Logger.Error("Unable to compile effect:"),Logger.Error("Uniforms: "+this._uniformsNames.map(function(h){return" "+h})),Logger.Error("Attributes: "+n.map(function(h){return" "+h})),Logger.Error(`Defines:\r
`+this.defines),Effect.LogShaderCodeOnCompilationError){let h=null,u=null,c=null;!((i=this._pipelineContext)===null||i===void 0)&&i._getVertexShaderCode()&&([c,h]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),c&&(Logger.Error("Vertex code:"),Logger.Error(c))),!((r=this._pipelineContext)===null||r===void 0)&&r._getFragmentShaderCode()&&([c,u]=this._getShaderCodeAndErrorLine((s=this._pipelineContext)===null||s===void 0?void 0:s._getFragmentShaderCode(),this._compilationError,!0),c&&(Logger.Error("Fragment code:"),Logger.Error(c))),h&&Logger.Error(h),u&&Logger.Error(u)}Logger.Error("Error: "+this._compilationError);const l=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,l()),o?(this._pipelineContext=null,o.hasMoreFallbacks?(this._allFallbacksProcessed=!1,Logger.Error("Trying next fallback."),this.defines=o.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,l(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||l())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setDepthStencilTexture(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(this._samplerList.indexOf(i+"0")===-1){const r=this._samplerList.indexOf(e);for(let n=1;n<t.length;n++){const o=i+(n-1).toString();this._samplerList.splice(r+n,0,o)}let s=0;for(const n of this._samplerList)this._samplers[n]=s,s+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}setTextureFromPostProcess(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}setTextureFromPostProcessOutput(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];i===void 0||Effect._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(Effect._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,r){return this._pipelineContext.setInt3(e,t,i,r),this}setInt4(e,t,i,r,s){return this._pipelineContext.setInt4(e,t,i,r,s),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setUInt3(e,t,i,r){return this._pipelineContext.setInt3(e,t,i,r),this}setUInt4(e,t,i,r,s){return this._pipelineContext.setInt4(e,t,i,r,s),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,r){return this._pipelineContext.setFloat3(e,t,i,r),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,r,s){return this._pipelineContext.setFloat4(e,t,i,r,s),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,i,r=ShaderLanguage.GLSL){t&&(ShaderStore.GetShadersStore(r)[`${e}PixelShader`]=t),i&&(ShaderStore.GetShadersStore(r)[`${e}VertexShader`]=i)}static ResetCache(){Effect._BaseCache={}}}Effect.LogShaderCodeOnCompilationError=!0;Effect._UniqueIdSeed=0;Effect._BaseCache={};Effect.ShadersStore=ShaderStore.ShadersStore;Effect.IncludesShadersStore=ShaderStore.IncludesShadersStore;class DepthCullingState{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class StencilState{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=StencilState.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=StencilState.KEEP,this.opDepthFail=StencilState.KEEP,this.opStencilDepthPass=StencilState.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}StencilState.ALWAYS=519;StencilState.KEEP=7680;StencilState.REPLACE=7681;class AlphaState{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,r){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===r||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=r,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,r){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class TextureSampler{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,r=1,s=2,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=r,this.samplingMode=s,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var InternalTextureSource;(function(a){a[a.Unknown=0]="Unknown",a[a.Url=1]="Url",a[a.Temp=2]="Temp",a[a.Raw=3]="Raw",a[a.Dynamic=4]="Dynamic",a[a.RenderTarget=5]="RenderTarget",a[a.MultiRenderTarget=6]="MultiRenderTarget",a[a.Cube=7]="Cube",a[a.CubeRaw=8]="CubeRaw",a[a.CubePrefiltered=9]="CubePrefiltered",a[a.Raw3D=10]="Raw3D",a[a.Raw2DArray=11]="Raw2DArray",a[a.DepthStencil=12]="DepthStencil",a[a.CubeRawRGBD=13]="CubeRawRGBD",a[a.Depth=14]="Depth"})(InternalTextureSource||(InternalTextureSource={}));class InternalTexture extends TextureSampler{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new Observable,this.onErrorObservable=new Observable,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=InternalTextureSource.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._engine=e,this._source=t,this._uniqueId=InternalTexture._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){var e;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const i=this.onRebuildCallback(this),r=s=>{s._swapAndDie(this,!1),this.isReady=i.isReady};i.isAsync?i.proxy.then(r):r(i.proxy);return}let t;switch(this.source){case InternalTextureSource.Temp:break;case InternalTextureSource.Url:t=this._engine.createTexture((e=this._originalUrl)!==null&&e!==void 0?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,i=>{i._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case InternalTextureSource.Raw:t=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),t._swapAndDie(this,!1),this.isReady=!0;break;case InternalTextureSource.Raw3D:t=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case InternalTextureSource.Raw2DArray:t=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case InternalTextureSource.Dynamic:t=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),t._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case InternalTextureSource.Cube:t=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case InternalTextureSource.CubeRaw:t=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),t._swapAndDie(this,!1),this.isReady=!0;break;case InternalTextureSource.CubeRawRGBD:return;case InternalTextureSource.CubePrefiltered:t=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,i=>{i&&i._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),t._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,t=!0){var i;(i=this._hardwareTexture)===null||i===void 0||i.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const r=this._engine.getLoadedTexturesCache();let s=r.indexOf(this);s!==-1&&r.splice(s,1),s=r.indexOf(e),s===-1&&r.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null)}}InternalTexture._Counter=0;class WebGLShaderProcessor{constructor(){this.shaderLanguage=ShaderLanguage.GLSL}postProcessor(e,t,i,r,s){if(!s.getCaps().drawBuffersExtension){const n=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(n,"")}return e}}const varyingRegex=/(flat\s)?\s*varying\s*.*/;class WebGL2ShaderProcessor{constructor(){this.shaderLanguage=ShaderLanguage.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return varyingRegex.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const r=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,s=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(s,""),e=e.replace(/texture2D\s*\(/g,"texture("),i)e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(r?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else if(t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class WebGLDataBuffer extends DataBuffer{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class WebGLPipelineContext{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,i,r,s,n,o,l){const h=this.engine;if(h.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);this.engine.getUniforms(this,i).forEach((d,f)=>{r[i[f]]=d}),this._uniforms=r;let c;for(c=0;c<s.length;c++)e.getUniform(s[c])==null&&(s.splice(c,1),c--);s.forEach((d,f)=>{n[d]=f});for(const d of h.getAttributes(this,o))l.push(d)}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r||r.length!==2)return r=[t,i],this._valueCache[e]=r,!0;let s=!1;return r[0]!==t&&(r[0]=t,s=!0),r[1]!==i&&(r[1]=i,s=!0),s}_cacheFloat3(e,t,i,r){let s=this._valueCache[e];if(!s||s.length!==3)return s=[t,i,r],this._valueCache[e]=s,!0;let n=!1;return s[0]!==t&&(s[0]=t,n=!0),s[1]!==i&&(s[1]=i,n=!0),s[2]!==r&&(s[2]=r,n=!0),n}_cacheFloat4(e,t,i,r,s){let n=this._valueCache[e];if(!n||n.length!==4)return n=[t,i,r,s],this._valueCache[e]=n,!0;let o=!1;return n[0]!==t&&(n[0]=t,o=!0),n[1]!==i&&(n[1]=i,o=!0),n[2]!==r&&(n[2]=r,o=!0),n[3]!==s&&(n[3]=s,o=!0),o}setInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setUInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setFloat4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}class WebGLHardwareTexture{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class DrawWrapper{static IsWrapper(e){return e.getPipelineContext===void 0}static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){var r;this.effect=e,t!==void 0&&(this.defines=t),i&&((r=this.drawContext)===null||r===void 0||r.reset())}dispose(){var e;(e=this.drawContext)===null||e===void 0||e.dispose()}}class StencilStateComposer{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)===null||e===void 0||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var t;if(!e)return;const i=!this.useStencilGlobalOnly&&!!(!((t=this.stencilMaterial)===null||t===void 0)&&t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class BufferPointer{}class ThinEngine{static get NpmPackage(){return"babylonjs@6.9.0"}static get Version(){return"6.9.0"}get description(){let e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}get isDisposed(){return this._isDisposed}static get ShadersRepository(){return Effect.ShadersRepository}static set ShadersRepository(e){Effect.ShadersRepository=e}_getShaderProcessor(e){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(e){this._snapshotRenderingMode=e}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(e,t){if(typeof document>"u")return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return ThinEngine._CreateCanvas(e,t)}createCanvasImage(){return document.createElement("img")}constructor(e,t,i,r){var s,n,o,l,h,u,c,d,f,_,g;this._name="WebGL",this._isDisposed=!1,this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new Observable,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new Observable,this.onContextRestoredObservable=new Observable,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new DepthCullingState,this._stencilStateComposer=new StencilStateComposer,this._stencilState=new StencilState,this._alphaState=new AlphaState,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new Observable,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=PrecisionDate.Now;let p=null;i=i||{},this._creationOptions=i,this.adaptToDeviceRatio=r??!1,this._stencilStateComposer.stencilGlobal=this._stencilState,PerformanceConfigurator.SetMatrixPrecision(!!i.useHighPrecisionMatrix),i.antialias=t??i.antialias,i.deterministicLockstep=(s=i.deterministicLockstep)!==null&&s!==void 0?s:!1,i.lockstepMaxSteps=(n=i.lockstepMaxSteps)!==null&&n!==void 0?n:4,i.timeStep=(o=i.timeStep)!==null&&o!==void 0?o:1/60,i.audioEngine=(l=i.audioEngine)!==null&&l!==void 0?l:!0,i.stencil=(h=i.stencil)!==null&&h!==void 0?h:!0,this._audioContext=(c=(u=i.audioEngineOptions)===null||u===void 0?void 0:u.audioContext)!==null&&c!==void 0?c:null,this._audioDestination=(f=(d=i.audioEngineOptions)===null||d===void 0?void 0:d.audioDestination)!==null&&f!==void 0?f:null,this.premultipliedAlpha=(_=i.premultipliedAlpha)!==null&&_!==void 0?_:!0,this.useExactSrgbConversions=(g=i.useExactSrgbConversions)!==null&&g!==void 0?g:!1,this._doNotHandleContextLost=!!i.doNotHandleContextLost,this._isStencilEnable=!!i.stencil,r=r||i.adaptToDeviceRatio||!1;const m=IsWindowObjectExist()&&window.devicePixelRatio||1,E=i.limitDeviceRatio||m;if(this._hardwareScalingLevel=r?1/Math.min(E,m):1,this._lastDevicePixelRatio=m,!e)return;if(e.getContext){if(p=e,this._renderingCanvas=p,i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.xrCompatible===void 0&&(i.xrCompatible=!0),navigator&&navigator.userAgent){this._setupMobileChecks();const x=navigator.userAgent;for(const A of ThinEngine.ExceptionList){const T=A.key,C=A.targets;if(new RegExp(T).test(x)){if(A.capture&&A.captureConstraint){const y=A.capture,S=A.captureConstraint,P=new RegExp(y).exec(x);if(P&&P.length>0&&parseInt(P[P.length-1])>=S)continue}for(const y of C)switch(y){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost||(this._onContextLost=x=>{x.preventDefault(),this._contextWasLost=!0,Logger.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(this._initGLContext.bind(this))},p.addEventListener("webglcontextlost",this._onContextLost,!1),p.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=p.getContext("webgl2",i)||p.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!p)throw new Error("The provided canvas is null or undefined.");try{this._gl=p.getContext("webgl",i)||p.getContext("experimental-webgl",i)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const x=this._gl.getContextAttributes();x&&(i.stencil=x.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let x=0;x<this._caps.maxVertexAttribs;x++)this._currentBufferPointers[x]=new BufferPointer;this._shaderProcessor=this.webGLVersion>1?new WebGL2ShaderProcessor:new WebGLShaderProcessor,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const M=`Babylon.js v${ThinEngine.Version}`;console.log(M+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",M)}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&IsDocumentAvailable()&&"ontouchend"in document},this._checkForMobile(),IsWindowObjectExist()&&window.addEventListener("resize",this._checkForMobile))}_restoreEngineAfterContextLost(e){setTimeout(async()=>{var t;this._dummyFramebuffer=null;const i=this._depthCullingState.depthTest,r=this._depthCullingState.depthFunc,s=this._depthCullingState.depthMask,n=this._stencilState.stencilTest;await e(),this.wipeCaches(!0),this._rebuildEffects(),(t=this._rebuildComputeEffects)===null||t===void 0||t.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0),this._depthCullingState.depthTest=i,this._depthCullingState.depthFunc=r,this._depthCullingState.depthMask=s,this._stencilState.stencilTest=n,Logger.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1},0)}_sharedInit(e){this._renderingCanvas=e}_getShaderProcessingContext(e){return null}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}Effect.ResetCache()}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuild();for(const e of this._storageBuffers)e._rebuild()}_initGLContext(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._glVersion=this._gl.getParameter(this._gl.VERSION);const t=this._gl.getExtension("WEBGL_debug_renderer_info");if(t!=null&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=((e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))!==null&&e!==void 0?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{const i=this._gl.getExtension("WEBGL_draw_buffers");if(i!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let r=0;r<16;r++)this._gl["COLOR_ATTACHMENT"+r+"_WEBGL"]=i["COLOR_ATTACHMENT"+r+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const i=this._gl.getExtension("WEBGL_depth_texture");i!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=i.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const i=this._gl.getExtension("OES_vertex_array_object");i!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=i.createVertexArrayOES.bind(i),this._gl.bindVertexArray=i.bindVertexArrayOES.bind(i),this._gl.deleteVertexArray=i.deleteVertexArrayOES.bind(i))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const i=this._gl.getExtension("ANGLE_instanced_arrays");i!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=i.drawArraysInstancedANGLE.bind(i),this._gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i),this._gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const i=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),r=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);i&&r&&(this._caps.highPrecisionShaderSupported=i.precision!==0&&r.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const i=this._gl.getExtension("EXT_blend_minmax");i!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=i.MAX_EXT,this._gl.MIN=i.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const i=this._gl.getExtension("EXT_sRGB");i!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:i.SRGB_EXT,SRGB8:i.SRGB_ALPHA_EXT,SRGB8_ALPHA8:i.SRGB_ALPHA_EXT})}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let i=0;i<this._maxSimultaneousTextures;i++)this._nextFreeTextureSlots.push(i);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0;return}const t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)}_renderLoop(){if(!this._contextWasLost){let e=!0;if((this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e){this.beginFrame();for(let t=0;t<this._activeRenderLoops.length;t++){const i=this._activeRenderLoops[t];i()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return IsWindowObjectExist()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(e,t){return ThinEngine.QueueNewFrame(e,t)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(e,t,i,r=!1){const s=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=s;let n=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),n|=this._gl.COLOR_BUFFER_BIT),i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)}_viewport(e,t,i,r){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||r!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r,this._gl.viewport(e,t,i,r))}setViewport(e,t,i){const r=t||this.getRenderWidth(),s=i||this.getRenderHeight(),n=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(n*r,o*s,r*e.width,s*e.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const r=IsWindowObjectExist()&&window.devicePixelRatio||1,s=this._lastDevicePixelRatio/r;this._lastDevicePixelRatio=r,this._hardwareScalingLevel*=s}if(IsWindowObjectExist()&&IsDocumentAvailable())if(this._renderingCanvas){const r=this._renderingCanvas.getBoundingClientRect?this._renderingCanvas.getBoundingClientRect():{width:this._renderingCanvas.width*this._hardwareScalingLevel,height:this._renderingCanvas.height*this._hardwareScalingLevel};t=this._renderingCanvas.clientWidth||r.width||this._renderingCanvas.width||100,i=this._renderingCanvas.clientHeight||r.height||this._renderingCanvas.height||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){return!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0)}bindFramebuffer(e,t=0,i,r,s,n=0,o=0){var l,h,u,c,d;const f=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(f._MSAAFramebuffer?f._MSAAFramebuffer:f._framebuffer);const _=this._gl;e.isMulti||(e.is2DArray?_.framebufferTextureLayer(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,(l=e.texture._hardwareTexture)===null||l===void 0?void 0:l.underlyingResource,n,o):e.isCube&&_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,(h=e.texture._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,n));const g=e._depthStencilTexture;if(g){const p=e._depthStencilTextureWithStencil?_.DEPTH_STENCIL_ATTACHMENT:_.DEPTH_ATTACHMENT;e.is2DArray?_.framebufferTextureLayer(_.FRAMEBUFFER,p,(u=g._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,n,o):e.isCube?_.framebufferTexture2D(_.FRAMEBUFFER,p,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,(c=g._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,n):_.framebufferTexture2D(_.FRAMEBUFFER,p,_.TEXTURE_2D,(d=g._hardwareTexture)===null||d===void 0?void 0:d.underlyingResource,n)}this._cachedViewport&&!s?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,n&&(i=i/Math.pow(2,n))),r||(r=e.height,n&&(r=r/Math.pow(2,n))),this._viewport(0,0,i,r)),this.wipeCaches()}setState(e,t=0,i,r=!1,s,n,o=0){var l,h;(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const u=!((h=(l=this.cullBackFaces)!==null&&l!==void 0?l:s)!==null&&h!==void 0)||h?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==u||i)&&(this._depthCullingState.cullFace=u),this.setZOffset(t),this.setZOffsetUnits(o);const c=r?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==c||i)&&(this._depthCullingState.frontFace=c),this._stencilStateComposer.stencilMaterial=n}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(e,t=!1,i){var r;const s=e;this._currentRenderTarget=null;const n=this._gl;if(s._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,i);return}n.bindFramebuffer(n.READ_FRAMEBUFFER,s._MSAAFramebuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,s._framebuffer),n.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,n.COLOR_BUFFER_BIT,n.NEAREST)}!((r=e.texture)===null||r===void 0)&&r.generateMipMaps&&!t&&!e.isCube&&this.generateMipmaps(e.texture),i&&(s._MSAAFramebuffer&&this._bindUnboundFramebuffer(s._framebuffer),i()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const r=new WebGLDataBuffer(i);return this.bindArrayBuffer(r),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),r.references=1,r}createDynamicVertexBuffer(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t){const i=this._gl.createBuffer(),r=new WebGLDataBuffer(i);if(!i)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);const s=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,s,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=s.BYTES_PER_ELEMENT===4,r}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const r=e.program,s=this._gl.getUniformBlockIndex(r,t);this._gl.uniformBlockBinding(r,s,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,r,s,n,o){const l=this._currentBufferPointers[t];if(!l)return;let h=!1;l.active?(l.buffer!==e&&(l.buffer=e,h=!0),l.size!==i&&(l.size=i,h=!0),l.type!==r&&(l.type=r,h=!0),l.normalized!==s&&(l.normalized=s,h=!0),l.stride!==n&&(l.stride=n,h=!0),l.offset!==o&&(l.offset=o,h=!0)):(h=!0,l.active=!0,l.index=t,l.size=i,l.type=r,l.normalized=s,l.stride=n,l.offset=o,l.buffer=e),(h||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),r===this._gl.UNSIGNED_INT||r===this._gl.INT?this._gl.vertexAttribIPointer(t,i,r,n,o):this._gl.vertexAttribPointer(t,i,r,s,n,o))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let s=0;s<r.length;s++){const n=t.getAttributeLocation(s);if(n>=0){const o=r[s];let l=null;if(i&&(l=i[o]),l||(l=e[o]),!l)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);const h=l.getBuffer();h&&(this._vertexAttribPointer(h,n,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(h))))}}}recordVertexArrayObject(e,t,i,r){const s=this._gl.createVertexArray();if(!s)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(s),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),s}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,r,s){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==s){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=s;const n=s.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let o=0;for(let l=0;l<n;l++)if(l<i.length){const h=s.getAttributeLocation(l);h>=0&&(this._gl.enableVertexAttribArray(h),this._vertexAttribArraysEnabled[h]=!0,this._vertexAttribPointer(e,h,i[l],this._gl.FLOAT,!1,r,o)),o+=i[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,r){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,r)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const r=this._currentInstanceBuffers[t];e!=r&&r.references&&(e=r,this.bindArrayBuffer(r));const s=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(s,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(let r=0;r<4;r++){const s=i[r];this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0),this._vertexAttribPointer(e,s,4,this._gl.FLOAT,!1,64,r*16),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let r=0;if(i)for(let s=0;s<t.length;s++){const n=t[s];r+=n.attributeSize*4}for(let s=0;s<t.length;s++){const n=t[s];n.index===void 0&&(n.index=this._currentEffect.getAttributeLocationByName(n.attributeName)),!(n.index<0)&&(this._vertexAttribArraysEnabled[n.index]||(this._gl.enableVertexAttribArray(n.index),this._vertexAttribArraysEnabled[n.index]=!0),this._vertexAttribPointer(e,n.index,n.attributeSize,n.attributeType||this._gl.FLOAT,n.normalized||!1,r,n.offset),this._gl.vertexAttribDivisor(n.index,n.divisor===void 0?1:n.divisor),this._currentInstanceLocations.push(n.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,i;for(;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,r){this.drawElementsType(e?0:1,t,i,r)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,r){this.drawArraysType(e?0:1,t,i,r)}drawElementsType(e,t,i,r){this.applyStates(),this._reportDrawCall();const s=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(s,i,n,t*o,r):this._gl.drawElements(s,i,n,t*o)}drawArraysType(e,t,i,r){this.applyStates(),this._reportDrawCall();const s=this._drawMode(e);r?this._gl.drawArraysInstanced(s,t,i,r):this._gl.drawArrays(s,t,i)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_reportDrawCall(){}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}createEffect(e,t,i,r,s,n,o,l,h,u=ShaderLanguage.GLSL){var c;const d=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,f=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,_=this._getGlobalDefines();let g=(c=s??t.defines)!==null&&c!==void 0?c:"";_&&(g+=_);const p=d+"+"+f+"@"+g;if(this._compiledEffects[p]){const E=this._compiledEffects[p];return o&&E.isReady()&&o(E),E}const m=new Effect(e,t,i,r,this,s,n,o,l,h,p,u);return this._compiledEffects[p]=m,m}static _ConcatenateShader(e,t,i=""){return i+(t?t+`
`:"")+e}_compileShader(e,t,i,r){return this._compileRawShader(ThinEngine._ConcatenateShader(e,i,r),t)}_compileRawShader(e,t){const i=this._gl,r=i.createShader(t==="vertex"?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!r){let s=i.NO_ERROR,n=i.NO_ERROR;for(;(n=i.getError())!==i.NO_ERROR;)s=n;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${s}, gl isContextLost=${i.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return i.shaderSource(r,e),i.compileShader(r),r}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,r,s=null){r=r||this._gl;const n=this._compileRawShader(t,"vertex"),o=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,n,o,r,s)}createShaderProgram(e,t,i,r,s,n=null){s=s||this._gl;const o=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",l=this._compileShader(t,"vertex",r,o),h=this._compileShader(i,"fragment",r,o);return this._createShaderProgram(e,l,h,s,n)}inlineShaderCode(e){return e}createPipelineContext(e){const t=new WebGLPipelineContext;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t}createMaterialContext(){}createDrawContext(){}_createShaderProgram(e,t,i,r,s=null){const n=r.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");return r.attachShader(n,t),r.attachShader(n,i),r.linkProgram(n),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_finalizePipelineContext(e){const t=e.context,i=e.vertexShader,r=e.fragmentShader,s=e.program;if(!t.getProgramParameter(s,t.LINK_STATUS)){if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)){const l=this._gl.getShaderInfoLog(i);if(l)throw e.vertexCompilationError=l,new Error("VERTEX SHADER "+l)}if(!this._gl.getShaderParameter(r,this._gl.COMPILE_STATUS)){const l=this._gl.getShaderInfoLog(r);if(l)throw e.fragmentCompilationError=l,new Error("FRAGMENT SHADER "+l)}const o=t.getProgramInfoLog(s);if(o)throw e.programLinkError=o,new Error(o)}if(this.validateShaderPrograms&&(t.validateProgram(s),!t.getProgramParameter(s,t.VALIDATE_STATUS))){const l=t.getProgramInfoLog(s);if(l)throw e.programValidationError=l,new Error(l)}t.deleteShader(i),t.deleteShader(r),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}_preparePipelineContext(e,t,i,r,s,n,o,l,h,u){const c=e;r?c.program=this.createRawShaderProgram(c,t,i,void 0,h):c.program=this.createShaderProgram(c,t,i,l,void 0,h),c.program.__SPECTOR_rebuildProgram=o}_isRenderingStateCompiled(e){const t=e;return this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(!i.isParallelCompiled){t();return}const r=i.onCompiled;r?i.onCompiled=()=>{r(),t()}:i.onCompiled=t}getUniforms(e,t){const i=new Array,r=e;for(let s=0;s<t.length;s++)i.push(this._gl.getUniformLocation(r.program,t[s]));return i}getAttributes(e,t){const i=[],r=e;for(let s=0;s<t.length;s++)try{i.push(this._gl.getAttribLocation(r.program,t[s]))}catch{i.push(-1)}return i}enableEffect(e){e=e!==null&&DrawWrapper.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1}setInt3(e,t,i,r){return e?(this._gl.uniform3i(e,t,i,r),!0):!1}setInt4(e,t,i,r,s){return e?(this._gl.uniform4i(e,t,i,r,s),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,i){return e?(this._gl.uniform2ui(e,t,i),!0):!1}setUInt3(e,t,i,r){return e?(this._gl.uniform3ui(e,t,i,r),!0):!1}setUInt4(e,t,i,r,s){return e?(this._gl.uniform4ui(e,t,i,r,s),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1}setFloat3(e,t,i,r){return e?(this._gl.uniform3f(e,t,i,r),!0):!1}setFloat4(e,t,i,r,s){return e?(this._gl.uniform4f(e,t,i,r,s),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let r=i.NEAREST,s=i.NEAREST;switch(e){case 11:r=i.LINEAR,t?s=i.LINEAR_MIPMAP_NEAREST:s=i.LINEAR;break;case 3:r=i.LINEAR,t?s=i.LINEAR_MIPMAP_LINEAR:s=i.LINEAR;break;case 8:r=i.NEAREST,t?s=i.NEAREST_MIPMAP_LINEAR:s=i.NEAREST;break;case 4:r=i.NEAREST,t?s=i.NEAREST_MIPMAP_NEAREST:s=i.NEAREST;break;case 5:r=i.NEAREST,t?s=i.LINEAR_MIPMAP_NEAREST:s=i.LINEAR;break;case 6:r=i.NEAREST,t?s=i.LINEAR_MIPMAP_LINEAR:s=i.LINEAR;break;case 7:r=i.NEAREST,s=i.LINEAR;break;case 1:r=i.NEAREST,s=i.NEAREST;break;case 9:r=i.LINEAR,t?s=i.NEAREST_MIPMAP_NEAREST:s=i.NEAREST;break;case 10:r=i.LINEAR,t?s=i.NEAREST_MIPMAP_LINEAR:s=i.NEAREST;break;case 2:r=i.LINEAR,s=i.LINEAR;break;case 12:r=i.LINEAR,s=i.NEAREST;break}return{min:s,mag:r}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new WebGLHardwareTexture(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,r=InternalTextureSource.Unknown){var s;let n=!1,o=0,l=3,h=5,u=!1,c=1,d;t!==void 0&&typeof t=="object"?(n=!!t.generateMipMaps,o=t.type===void 0?0:t.type,l=t.samplingMode===void 0?3:t.samplingMode,h=t.format===void 0?5:t.format,u=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,c=(s=t.samples)!==null&&s!==void 0?s:1,d=t.label):n=!!t,u&&(u=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(o===1&&!this._caps.textureFloatLinearFiltering||o===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),o===1&&!this._caps.textureFloat&&(o=0,Logger.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const f=this._gl,_=new InternalTexture(this,r),g=e.width||e,p=e.height||e,m=e.layers||0,E=this._getSamplingParameters(l,n),M=m!==0?f.TEXTURE_2D_ARRAY:f.TEXTURE_2D,x=this._getRGBABufferInternalSizedFormat(o,h,u),A=this._getInternalFormat(h),T=this._getWebGLTextureType(o);return this._bindTextureDirectly(M,_),m!==0?(_.is2DArray=!0,f.texImage3D(M,0,x,g,p,m,0,A,T,null)):f.texImage2D(M,0,x,g,p,0,A,T,null),f.texParameteri(M,f.TEXTURE_MAG_FILTER,E.mag),f.texParameteri(M,f.TEXTURE_MIN_FILTER,E.min),f.texParameteri(M,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(M,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),n&&this._gl.generateMipmap(M),this._bindTextureDirectly(M,null),_._useSRGBBuffer=u,_.baseWidth=g,_.baseHeight=p,_.width=g,_.height=p,_.depth=m,_.isReady=!0,_.samples=c,_.generateMipMaps=n,_.samplingMode=l,_.type=o,_.format=h,_.label=d,this._internalTexturesCache.push(_),_}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)}_createTextureBase(e,t,i,r,s=3,n=null,o=null,l,h,u=null,c=null,d=null,f=null,_,g,p){e=e||"";const m=e.substr(0,5)==="data:",E=e.substr(0,5)==="blob:",M=m&&e.indexOf(";base64,")!==-1,x=c||new InternalTexture(this,InternalTextureSource.Url);x!==c&&(x.label=e.substring(0,60));const A=e;this._transformTextureUrl&&!M&&!c&&!u&&(e=this._transformTextureUrl(e)),A!==e&&(x._originalUrl=A);const T=e.lastIndexOf(".");let C=f||(T>-1?e.substring(T).toLowerCase():""),b=null;C.indexOf("?")>-1&&(C=C.split("?")[0]);for(const P of ThinEngine._TextureLoaders)if(P.canLoad(C,_)){b=P;break}r&&r.addPendingData(x),x.url=e,x.generateMipMaps=!t,x.samplingMode=s,x.invertY=i,x._useSRGBBuffer=this._getUseSRGBBuffer(!!p,t),this._doNotHandleContextLost||(x._buffer=u);let S=null;n&&!c&&(S=x.onLoadedObservable.add(n)),c||this._internalTexturesCache.push(x);const R=(P,N)=>{r&&r.removePendingData(x),e===A?(S&&x.onLoadedObservable.remove(S),EngineStore.UseFallbackTexture&&this._createTextureBase(EngineStore.FallbackTexture,t,x.invertY,r,s,null,o,l,h,u,x),P=(P||"Unknown error")+(EngineStore.UseFallbackTexture?" - Fallback texture was used":""),x.onErrorObservable.notifyObservers({message:P,exception:N}),o&&o(P,N)):(Logger.Warn(`Failed to load ${e}, falling back to ${A}`),this._createTextureBase(A,t,x.invertY,r,s,n,o,l,h,u,x,d,f,_,g,p))};if(b){const P=N=>{b.loadData(N,x,(V,F,U,H,X,w)=>{w?R("TextureLoader failed to load data"):l(x,C,r,{width:V,height:F},x.invertY,!U,H,()=>(X(),!1),s)},g)};u?u instanceof ArrayBuffer?P(new Uint8Array(u)):ArrayBuffer.isView(u)?P(u):o&&o("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,N=>P(new Uint8Array(N)),void 0,r?r.offlineProvider:void 0,!0,(N,V)=>{R("Unable to load "+(N&&N.responseURL,V))})}else{const P=N=>{E&&!this._doNotHandleContextLost&&(x._buffer=N),l(x,C,r,N,x.invertY,t,!1,h,s)};!m||M?u&&(typeof u.decoding=="string"||u.close)?P(u):ThinEngine._FileToolsLoadImage(e,P,R,r?r.offlineProvider:null,_,x.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof u=="string"||u instanceof ArrayBuffer||ArrayBuffer.isView(u)||u instanceof Blob?ThinEngine._FileToolsLoadImage(u,P,R,r?r.offlineProvider:null,_,x.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):u&&P(u)}return x}createTexture(e,t,i,r,s=3,n=null,o=null,l=null,h=null,u=null,c=null,d,f,_,g){return this._createTextureBase(e,t,i,r,s,n,o,this._prepareWebGLTexture.bind(this),(p,m,E,M,x,A)=>{const T=this._gl,C=E.width===p&&E.height===m,b=u?this._getInternalFormat(u,x._useSRGBBuffer):M===".jpg"&&!x._useSRGBBuffer?T.RGB:x._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:T.RGBA;let y=u?this._getInternalFormat(u):M===".jpg"&&!x._useSRGBBuffer?T.RGB:T.RGBA;if(x._useSRGBBuffer&&this.webGLVersion===1&&(y=b),C)return T.texImage2D(T.TEXTURE_2D,0,b,y,T.UNSIGNED_BYTE,E),!1;const S=this._caps.maxTextureSize;if(E.width>S||E.height>S||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=p,this._workingCanvas.height=m,this._workingContext.drawImage(E,0,0,E.width,E.height,0,0,p,m),T.texImage2D(T.TEXTURE_2D,0,b,y,T.UNSIGNED_BYTE,this._workingCanvas),x.width=p,x.height=m),!1;{const R=new InternalTexture(this,InternalTextureSource.Temp);this._bindTextureDirectly(T.TEXTURE_2D,R,!0),T.texImage2D(T.TEXTURE_2D,0,b,y,T.UNSIGNED_BYTE,E),this._rescaleTexture(R,x,r,b,()=>{this._releaseTexture(R),this._bindTextureDirectly(T.TEXTURE_2D,x,!0),A()})}return!0},l,h,u,c,d,f,g)}static _FileToolsLoadImage(e,t,i,r,s,n){throw _WarnImport("FileTools")}_rescaleTexture(e,t,i,r,s){}createRawTexture(e,t,i,r,s,n,o,l=null,h=0,u=0,c=!1){throw _WarnImport("Engine.RawTexture")}createRawCubeTexture(e,t,i,r,s,n,o,l=null){throw _WarnImport("Engine.RawTexture")}createRawTexture3D(e,t,i,r,s,n,o,l,h=null,u=0){throw _WarnImport("Engine.RawTexture")}createRawTexture2DArray(e,t,i,r,s,n,o,l,h=null,u=0){throw _WarnImport("Engine.RawTexture")}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const r=this._getTextureTarget(t),s=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,s.mag,t),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,s.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),t.samplingMode=e}updateTextureDimensions(e,t,i,r=1){}updateTextureWrappingMode(e,t,i=null,r=null){const s=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(s,null)}_setupDepthStencilTexture(e,t,i,r,s,n=1){const o=t.width||t,l=t.height||t,h=t.layers||0;e.baseWidth=o,e.baseHeight=l,e.width=o,e.height=l,e.is2DArray=h>0,e.depth=h,e.isReady=!0,e.samples=n,e.generateMipMaps=!1,e.samplingMode=r?2:1,e.type=0,e._comparisonFunction=s;const u=this._gl,c=this._getTextureTarget(e),d=this._getSamplingParameters(e.samplingMode,!1);u.texParameteri(c,u.TEXTURE_MAG_FILTER,d.mag),u.texParameteri(c,u.TEXTURE_MIN_FILTER,d.min),u.texParameteri(c,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(c,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),this.webGLVersion>1&&(s===0?(u.texParameteri(c,u.TEXTURE_COMPARE_FUNC,515),u.texParameteri(c,u.TEXTURE_COMPARE_MODE,u.NONE)):(u.texParameteri(c,u.TEXTURE_COMPARE_FUNC,s),u.texParameteri(c,u.TEXTURE_COMPARE_MODE,u.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,n=0,o=0){const l=this._gl;let h=l.TEXTURE_2D;if(e.isCube&&(h=l.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(h,o,t,i,r,0,s)}_uploadDataToTextureDirectly(e,t,i=0,r=0,s,n=!1){const o=this._gl,l=this._getWebGLTextureType(e.type),h=this._getInternalFormat(e.format),u=s===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(s,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let c=o.TEXTURE_2D;e.isCube&&(c=o.TEXTURE_CUBE_MAP_POSITIVE_X+i);const d=Math.round(Math.log(e.width)*Math.LOG2E),f=Math.round(Math.log(e.height)*Math.LOG2E),_=n?e.width:Math.pow(2,Math.max(d-r,0)),g=n?e.height:Math.pow(2,Math.max(f-r,0));o.texImage2D(c,r,u,_,g,0,h,l,t)}updateTextureData(e,t,i,r,s,n,o=0,l=0,h=!1){const u=this._gl,c=this._getWebGLTextureType(e.type),d=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let f=u.TEXTURE_2D,_=u.TEXTURE_2D;e.isCube&&(_=u.TEXTURE_CUBE_MAP_POSITIVE_X+o,f=u.TEXTURE_CUBE_MAP),this._bindTextureDirectly(f,e,!0),u.texSubImage2D(_,l,i,r,s,n,d,c,t),h&&this._gl.generateMipmap(_),this._bindTextureDirectly(f,null)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){const s=this._gl,n=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,r),this._bindTextureDirectly(n,null,!0)}_prepareWebGLTextureContinuation(e,t,i,r,s){const n=this._gl;if(!n)return;const o=this._getSamplingParameters(s,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,o.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,o.min),!i&&!r&&n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,r,s,n,o,l,h=3){const u=this.getCaps().maxTextureSize,c=Math.min(u,this.needPOTTextures?ThinEngine.GetExponentOfTwo(r.width,u):r.width),d=Math.min(u,this.needPOTTextures?ThinEngine.GetExponentOfTwo(r.height,u):r.height),f=this._gl;if(f){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(f.TEXTURE_2D,e,!0),this._unpackFlipY(s===void 0?!0:!!s),e.baseWidth=r.width,e.baseHeight=r.height,e.width=c,e.height=d,e.isReady=!0,!l(c,d,r,t,e,()=>{this._prepareWebGLTextureContinuation(e,i,n,o,h)})&&this._prepareWebGLTextureContinuation(e,i,n,o,h)}}_setupFramebufferDepthAttachments(e,t,i,r,s=1){const n=this._gl;if(e&&t)return this._createRenderBuffer(i,r,s,n.DEPTH_STENCIL,n.DEPTH24_STENCIL8,n.DEPTH_STENCIL_ATTACHMENT);if(t){let o=n.DEPTH_COMPONENT16;return this._webGLVersion>1&&(o=n.DEPTH_COMPONENT32F),this._createRenderBuffer(i,r,s,o,o,n.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(i,r,s,n.STENCIL_INDEX8,n.STENCIL_INDEX8,n.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,r,s,n,o=!0){const h=this._gl.createRenderbuffer();return this._updateRenderBuffer(h,e,t,i,r,s,n,o)}_updateRenderBuffer(e,t,i,r,s,n,o,l=!0){const h=this._gl;return h.bindRenderbuffer(h.RENDERBUFFER,e),r>1&&h.renderbufferStorageMultisample?h.renderbufferStorageMultisample(h.RENDERBUFFER,r,n,t,i):h.renderbufferStorage(h.RENDERBUFFER,s,t,i),h.framebufferRenderbuffer(h.FRAMEBUFFER,o,h.RENDERBUFFER,e),l&&h.bindRenderbuffer(h.RENDERBUFFER,null),e}_releaseTexture(e){var t;this._deleteTexture((t=e._hardwareTexture)===null||t===void 0?void 0:t.underlyingResource),this.unbindAllTextures();const i=this._internalTexturesCache.indexOf(e);i!==-1&&this._internalTexturesCache.splice(i,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}_deleteTexture(e){e&&this._gl.deleteTexture(e)}_setProgram(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let r=0;r<i.length;r++){const s=e.getUniform(i[r]);s&&(this._boundUniforms[r]=s)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,r=!1){var s,n;let o=!1;const l=t&&t._associatedChannel>-1;if(i&&l&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||r){if(this._activateCurrentTexture(),t&&t.isMultiview)throw console.error(e,t),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,(n=(s=t==null?void 0:t._hardwareTexture)===null||s===void 0?void 0:s.underlyingResource)!==null&&n!==void 0?n:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(o=!0,this._activateCurrentTexture());return l&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),o}_bindTexture(e,t,i){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;const r=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(r,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,r){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,r=!1,s=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const h=t.getInternalTexture();h&&(h._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let n;r?n=t.depthStencilTexture:t.isReady()?n=t.getInternalTexture():t.isCube?n=this.emptyCubeTexture:t.is3D?n=this.emptyTexture3D:t.is2DArray?n=this.emptyTexture2DArray:n=this.emptyTexture,!i&&n&&(n._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===n&&(i||this._bindSamplerUniformToChannel(n._associatedChannel,e),o=!1),this._activeChannel=e;const l=this._getTextureTarget(n);if(o&&this._bindTextureDirectly(l,n,i),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const h=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=h,t.wrapV=h}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(l,n,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,r){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(let s=0;s<i.length;s++){const n=i[s].getInternalTexture();n?(this._textureUnits[s]=e+s,n._associatedChannel=e+s):this._textureUnits[s]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let s=0;s<i.length;s++)this._setTexture(this._textureUnits[s],i[s],!0)}}_setAnisotropicLevel(e,t,i){const r=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),r&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}dispose(){var e;this._isDisposed=!0,this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)===null||e===void 0||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},IsWindowObjectExist()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,Effect.ResetCache();for(const t of this._activeRequests)t.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const s=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&n===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const o=t.RGBA,l=t.UNSIGNED_BYTE,h=new Uint8Array(4);t.readPixels(0,0,1,1,o,l,h),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(r),t.deleteFramebuffer(s),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}_getRGBAMultiSampleBufferFormat(e,t=5){switch(e){case 1:switch(t){case 6:return this._gl.R32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;default:return this._gl.RGBA16F}}return this._gl.RGBA8}_loadFile(e,t,i,r,s,n){const o=ThinEngine._FileToolsLoadFile(e,t,i,r,s,n);return this._activeRequests.push(o),o.onCompleteObservable.add(l=>{this._activeRequests.splice(this._activeRequests.indexOf(l),1)}),o}static _FileToolsLoadFile(e,t,i,r,s,n){throw _WarnImport("FileTools")}readPixels(e,t,i,r,s=!0,n=!0){const o=s?4:3,l=s?this._gl.RGBA:this._gl.RGB,h=new Uint8Array(r*i*o);return n&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,r,l,this._gl.UNSIGNED_BYTE,h),Promise.resolve(h)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}static FloorPOT(e){return e=e|e>>1,e=e|e>>2,e=e|e>>4,e=e|e>>8,e=e|e>>16,e-(e>>1)}static NearestPOT(e){const t=ThinEngine.CeilingPOT(e),i=ThinEngine.FloorPOT(e);return t-e>e-i?i:t}static GetExponentOfTwo(e,t,i=2){let r;switch(i){case 1:r=ThinEngine.FloorPOT(e);break;case 2:r=ThinEngine.NearestPOT(e);break;case 3:default:r=ThinEngine.CeilingPOT(e);break}return Math.min(r,t)}static QueueNewFrame(e,t){if(IsWindowObjectExist()){const{requestPostAnimationFrame:i,requestAnimationFrame:r}=t||window;if(typeof i=="function")return i(e);if(typeof r=="function")return r(e)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(e);return setTimeout(e,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:IsDocumentAvailable()?document:null}}ThinEngine.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];ThinEngine._TextureLoaders=[];ThinEngine.CollisionsEpsilon=.001;ThinEngine._IsSupported=null;ThinEngine._HasMajorPerformanceCaveat=null;class TimingTools{static SetImmediate(e){IsWindowObjectExist()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const Base64DataUrlRegEx=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class LoadFileError extends RuntimeError{constructor(e,t){super(e,ErrorCodes.LoadFileError),this.name="LoadFileError",BaseError._setPrototypeOf(this,LoadFileError.prototype),t instanceof WebRequest?this.request=t:this.file=t}}class RequestFileError extends RuntimeError{constructor(e,t){super(e,ErrorCodes.RequestFileError),this.request=t,this.name="RequestFileError",BaseError._setPrototypeOf(this,RequestFileError.prototype)}}class ReadFileError extends RuntimeError{constructor(e,t){super(e,ErrorCodes.ReadFileError),this.file=t,this.name="ReadFileError",BaseError._setPrototypeOf(this,ReadFileError.prototype)}}const FileToolsOptions={DefaultRetryStrategy:RetryStrategy.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:a=>a},_CleanUrl=a=>(a=a.replace(/#/gm,"%23"),a),SetCorsBehavior=(a,e)=>{if(!(a&&a.indexOf("data:")===0)&&FileToolsOptions.CorsBehavior)if(typeof FileToolsOptions.CorsBehavior=="string"||FileToolsOptions.CorsBehavior instanceof String)e.crossOrigin=FileToolsOptions.CorsBehavior;else{const t=FileToolsOptions.CorsBehavior(a);t&&(e.crossOrigin=t)}},LoadImage=(a,e,t,i,r="",s)=>{var n;let o,l=!1;a instanceof ArrayBuffer||ArrayBuffer.isView(a)?typeof Blob<"u"&&typeof URL<"u"?(o=URL.createObjectURL(new Blob([a],{type:r})),l=!0):o=`data:${r};base64,`+EncodeArrayBufferToBase64(a):a instanceof Blob?(o=URL.createObjectURL(a),l=!0):(o=_CleanUrl(a),o=FileToolsOptions.PreprocessUrl(a));const h=EngineStore.LastCreatedEngine,u=T=>{if(t){const C=o||a.toString();t(`Error while trying to load image: ${C.indexOf("http")===0||C.length<=128?C:C.slice(0,128)+"..."}`,T)}};if(typeof Image>"u"||(n=h==null?void 0:h._features.forceBitmapOverHTMLImageElement)!==null&&n!==void 0&&n)return LoadFile(o,T=>{h.createImageBitmap(new Blob([T],{type:r}),Object.assign({premultiplyAlpha:"none"},s)).then(C=>{e(C),l&&URL.revokeObjectURL(o)}).catch(C=>{t&&t("Error while trying to load image: "+a,C)})},void 0,i||void 0,!0,(T,C)=>{u(C)}),null;const c=new Image;SetCorsBehavior(o,c);const d=[],f=()=>{d.forEach(T=>{T.target.addEventListener(T.name,T.handler)})},_=()=>{d.forEach(T=>{T.target.removeEventListener(T.name,T.handler)}),d.length=0},g=()=>{_(),e(c),l&&c.src&&URL.revokeObjectURL(c.src)},p=T=>{_(),u(T),l&&c.src&&URL.revokeObjectURL(c.src)},m=T=>{if(T.blockedURI!==c.src)return;_();const C=new Error(`CSP violation of policy ${T.effectiveDirective} ${T.blockedURI}. Current policy is ${T.originalPolicy}`);EngineStore.UseFallbackTexture=!1,u(C),l&&c.src&&URL.revokeObjectURL(c.src),c.src=""};d.push({target:c,name:"load",handler:g}),d.push({target:c,name:"error",handler:p}),d.push({target:document,name:"securitypolicyviolation",handler:m}),f();const E=o.substring(0,5)==="blob:",M=o.substring(0,5)==="data:",x=()=>{E||M?c.src=o:LoadFile(o,(T,C,b)=>{const y=!r&&b?b:r,S=new Blob([T],{type:y}),R=URL.createObjectURL(S);l=!0,c.src=R},void 0,i||void 0,!0,(T,C)=>{u(C)})},A=()=>{i&&i.loadImage(o,c)};if(!E&&!M&&i&&i.enableTexturesOffline)i.open(A,x);else{if(o.indexOf("file:")!==-1){const T=decodeURIComponent(o.substring(5).toLowerCase());if(FilesInputStore.FilesToLoad[T]&&typeof URL<"u"){try{let C;try{C=URL.createObjectURL(FilesInputStore.FilesToLoad[T])}catch{C=URL.createObjectURL(FilesInputStore.FilesToLoad[T])}c.src=C,l=!0}catch{c.src=""}return c}}x()}return c},ReadFile=(a,e,t,i,r)=>{const s=new FileReader,n={onCompleteObservable:new Observable,abort:()=>s.abort()};return s.onloadend=()=>n.onCompleteObservable.notifyObservers(n),r&&(s.onerror=()=>{r(new ReadFileError(`Unable to read ${a.name}`,a))}),s.onload=o=>{e(o.target.result)},t&&(s.onprogress=t),i?s.readAsArrayBuffer(a):s.readAsText(a),n},LoadFile=(a,e,t,i,r,s,n)=>{if(a.name)return ReadFile(a,e,t,r,s?u=>{s(void 0,u)}:void 0);const o=a;if(o.indexOf("file:")!==-1){let u=decodeURIComponent(o.substring(5).toLowerCase());u.indexOf("./")===0&&(u=u.substring(2));const c=FilesInputStore.FilesToLoad[u];if(c)return ReadFile(c,e,t,r,s?d=>s(void 0,new LoadFileError(d.message,d.file)):void 0)}const{match:l,type:h}=TestBase64DataUrl(o);if(l){const u={onCompleteObservable:new Observable,abort:()=>()=>{}};try{const c=r?DecodeBase64UrlToBinary(o):DecodeBase64UrlToString(o);e(c,void 0,h)}catch(c){s?s(void 0,c):Logger.Error(c.message||"Failed to parse the Data URL")}return TimingTools.SetImmediate(()=>{u.onCompleteObservable.notifyObservers(u)}),u}return RequestFile(o,(u,c)=>{e(u,c==null?void 0:c.responseURL,c==null?void 0:c.getResponseHeader("content-type"))},t,i,r,s?u=>{s(u.request,new LoadFileError(u.message,u.request))}:void 0,n)},RequestFile=(a,e,t,i,r,s,n)=>{a=_CleanUrl(a),a=FileToolsOptions.PreprocessUrl(a);const o=FileToolsOptions.BaseUrl+a;let l=!1;const h={onCompleteObservable:new Observable,abort:()=>l=!0},u=()=>{let c=new WebRequest,d=null,f;const _=()=>{c&&(t&&c.removeEventListener("progress",t),f&&c.removeEventListener("readystatechange",f),c.removeEventListener("loadend",g))};let g=()=>{_(),h.onCompleteObservable.notifyObservers(h),h.onCompleteObservable.clear(),t=void 0,f=null,g=null,s=void 0,n=void 0,e=void 0};h.abort=()=>{l=!0,g&&g(),c&&c.readyState!==(XMLHttpRequest.DONE||4)&&c.abort(),d!==null&&(clearTimeout(d),d=null),c=null};const p=E=>{const M=E.message||"Unknown error";s&&c?s(new RequestFileError(M,c)):Logger.Error(M)},m=E=>{if(c){if(c.open("GET",o),n)try{n(c)}catch(M){p(M);return}r&&(c.responseType="arraybuffer"),t&&c.addEventListener("progress",t),g&&c.addEventListener("loadend",g),f=()=>{if(!(l||!c)&&c.readyState===(XMLHttpRequest.DONE||4)){if(f&&c.removeEventListener("readystatechange",f),c.status>=200&&c.status<300||c.status===0&&(!IsWindowObjectExist()||IsFileURL())){try{e&&e(r?c.response:c.responseText,c)}catch(A){p(A)}return}const M=FileToolsOptions.DefaultRetryStrategy;if(M){const A=M(o,c,E);if(A!==-1){_(),c=new WebRequest,d=setTimeout(()=>m(E+1),A);return}}const x=new RequestFileError("Error status: "+c.status+" "+c.statusText+" - Unable to load "+o,c);s&&s(x)}},c.addEventListener("readystatechange",f),c.send()}};m(0)};if(i&&i.enableSceneOffline){const c=f=>{f&&f.status>400?s&&s(f):u()},d=()=>{i&&i.loadFile(FileToolsOptions.BaseUrl+a,f=>{!l&&e&&e(f),h.onCompleteObservable.notifyObservers(h)},t?f=>{!l&&t&&t(f)}:void 0,c,r)};i.open(d,c)}else u();return h},IsFileURL=()=>typeof location<"u"&&location.protocol==="file:",IsBase64DataUrl=a=>Base64DataUrlRegEx.test(a),TestBase64DataUrl=a=>{const e=Base64DataUrlRegEx.exec(a);return e===null||e.length===0?{match:!1,type:""}:{match:!0,type:e[0].replace("data:","").replace("base64,","")}};function DecodeBase64UrlToBinary(a){return DecodeBase64ToBinary(a.split(",")[1])}const DecodeBase64UrlToString=a=>DecodeBase64ToString(a.split(",")[1]),initSideEffects=()=>{ThinEngine._FileToolsLoadImage=LoadImage,ThinEngine._FileToolsLoadFile=LoadFile,ShaderProcessor._FileToolsLoadFile=LoadFile};initSideEffects();let FileTools;const _injectLTSFileTools=(a,e,t,i,r,s,n,o,l,h)=>{FileTools={DecodeBase64UrlToBinary:a,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:r,LoadFile:s,LoadImage:n,ReadFile:o,RequestFile:l,SetCorsBehavior:h},Object.defineProperty(FileTools,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(u){t.DefaultRetryStrategy=u}}),Object.defineProperty(FileTools,"BaseUrl",{get:function(){return t.BaseUrl},set:function(u){t.BaseUrl=u}}),Object.defineProperty(FileTools,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(u){t.PreprocessUrl=u}}),Object.defineProperty(FileTools,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(u){t.CorsBehavior=u}})};_injectLTSFileTools(DecodeBase64UrlToBinary,DecodeBase64UrlToString,FileToolsOptions,IsBase64DataUrl,IsFileURL,LoadFile,LoadImage,ReadFile,RequestFile,SetCorsBehavior);class InstantiationTools{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=GetClass(e);if(t)return t;Logger.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let r=window||this;for(let s=0,n=i.length;s<n;s++)r=r[i[s]];return typeof r!="function"?null:r}}InstantiationTools.RegisteredExternalClasses={};function RandomGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const e=Math.random()*16|0;return(a==="x"?e:e&3|8).toString(16)})}class Tools{static get BaseUrl(){return FileToolsOptions.BaseUrl}static set BaseUrl(e){FileToolsOptions.BaseUrl=e}static get DefaultRetryStrategy(){return FileToolsOptions.DefaultRetryStrategy}static set DefaultRetryStrategy(e){FileToolsOptions.DefaultRetryStrategy=e}static get CorsBehavior(){return FileToolsOptions.CorsBehavior}static set CorsBehavior(e){FileToolsOptions.CorsBehavior=e}static get UseFallbackTexture(){return EngineStore.UseFallbackTexture}static set UseFallbackTexture(e){EngineStore.UseFallbackTexture=e}static get RegisteredExternalClasses(){return InstantiationTools.RegisteredExternalClasses}static set RegisteredExternalClasses(e){InstantiationTools.RegisteredExternalClasses=e}static get fallbackTexture(){return EngineStore.FallbackTexture}static set fallbackTexture(e){EngineStore.FallbackTexture=e}static FetchToRef(e,t,i,r,s,n){const o=Math.abs(e)*i%i|0,l=Math.abs(t)*r%r|0,h=(o+l*i)*4;n.r=s[h]/255,n.g=s[h+1]/255,n.b=s[h+2]/255,n.a=s[h+3]/255}static Mix(e,t,i){return e*(1-i)+t*i}static Instantiate(e){return InstantiationTools.Instantiate(e)}static SetImmediate(e){TimingTools.SetImmediate(e)}static IsExponentOfTwo(e){let t=1;do t*=2;while(t<e);return t===e}static FloatRound(e){return Math.fround?Math.fround(e):(Tools._TmpFloatArray[0]=e,Tools._TmpFloatArray[0])}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const r=this.ToRadians(e),s=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(s)+i*Math.sin(r),(1-i)*Math.cos(s)+i*Math.cos(r)))}static MakeArray(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){let t="pointer";return IsWindowObjectExist()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t}static SetCorsBehavior(e,t){SetCorsBehavior(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static CleanUrl(e){return e=e.replace(/#/gm,"%23"),e}static get PreprocessUrl(){return FileToolsOptions.PreprocessUrl}static set PreprocessUrl(e){FileToolsOptions.PreprocessUrl=e}static LoadImage(e,t,i,r,s,n){return LoadImage(e,t,i,r,s,n)}static LoadFile(e,t,i,r,s,n){return LoadFile(e,t,i,r,s,n)}static LoadFileAsync(e,t=!0){return new Promise((i,r)=>{LoadFile(e,s=>{i(s)},void 0,void 0,t,(s,n)=>{r(n)})})}static LoadScript(e,t,i,r){if(typeof importScripts=="function"){try{importScripts(e),t()}catch(o){i==null||i(`Unable to load script '${e}' in worker`,o)}return}else if(!IsWindowObjectExist()){i==null||i(`Cannot load script '${e}' outside of a window or a worker`);return}const s=document.getElementsByTagName("head")[0],n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",e),r&&(n.id=r),n.onload=()=>{t&&t()},n.onerror=o=>{i&&i(`Unable to load script '${e}'`,o)},s.appendChild(n)}static LoadScriptAsync(e){return new Promise((t,i)=>{this.LoadScript(e,()=>{t()},(r,s)=>{i(s||new Error(r))})})}static ReadFileAsDataURL(e,t,i){const r=new FileReader,s={onCompleteObservable:new Observable,abort:()=>r.abort()};return r.onloadend=()=>{s.onCompleteObservable.notifyObservers(s)},r.onload=n=>{t(n.target.result)},r.onprogress=i,r.readAsDataURL(e),s}static ReadFile(e,t,i,r,s){return ReadFile(e,t,i,r,s)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,r){DeepCopier.DeepCopy(e,t,i,r)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const r=t[i];e.addEventListener(r.name,r.handler,!1);try{window.parent&&window.parent.addEventListener(r.name,r.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const r=t[i];e.removeEventListener(r.name,r.handler);try{e.parent&&e.parent.removeEventListener(r.name,r.handler)}catch{}}}static async DumpFramebuffer(e,t,i,r,s="image/png",n,o){throw _WarnImport("DumpTools")}static DumpData(e,t,i,r,s="image/png",n,o=!1,l=!1,h){throw _WarnImport("DumpTools")}static DumpDataAsync(e,t,i,r="image/png",s,n=!1,o=!1,l){throw _WarnImport("DumpTools")}static _IsOffScreenCanvas(e){return e.convertToBlob!==void 0}static ToBlob(e,t,i="image/png",r){!Tools._IsOffScreenCanvas(e)&&!e.toBlob&&(e.toBlob=function(s,n,o){setTimeout(()=>{const l=atob(this.toDataURL(n,o).split(",")[1]),h=l.length,u=new Uint8Array(h);for(let c=0;c<h;c++)u[c]=l.charCodeAt(c);s(new Blob([u]))})}),Tools._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:r}).then(s=>t(s)):e.toBlob(function(s){t(s)},i,r)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const i=new Date;t="screenshot_"+((i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2))+".png"}Tools.Download(e,t)}else if(e&&typeof URL<"u"){const i=URL.createObjectURL(e),r=window.open("");if(!r)return;const s=r.document.createElement("img");s.onload=function(){URL.revokeObjectURL(i)},s.src=i,r.document.body.appendChild(s)}}static EncodeScreenshotCanvasData(e,t,i="image/png",r,s){if(typeof r=="string"||!t)this.ToBlob(e,function(n){n&&Tools.DownloadBlob(n,r),t&&t("")},i,s);else if(t){if(Tools._IsOffScreenCanvas(e)){e.convertToBlob({type:i,quality:s}).then(o=>{const l=new FileReader;l.readAsDataURL(o),l.onloadend=()=>{const h=l.result;t(h)}});return}const n=e.toDataURL(i,s);t(n)}}static Download(e,t){if(typeof URL>"u")return;const i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.style.display="none",r.href=i,r.download=t,r.addEventListener("click",()=>{r.parentElement&&r.parentElement.removeChild(r)}),r.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1}static CreateScreenshot(e,t,i,r,s="image/png",n=!1,o){throw _WarnImport("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,r="image/png",s){throw _WarnImport("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,r,s="image/png",n=1,o=!1,l,h=!1,u=!1,c=!0,d){throw _WarnImport("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,r="image/png",s=1,n=!1,o,l=!1,h=!1,u=!0,c){throw _WarnImport("ScreenshotTools")}static RandomId(){return RandomGUID()}static IsBase64(e){return IsBase64DataUrl(e)}static DecodeBase64(e){return DecodeBase64UrlToBinary(e)}static get errorsCount(){return Logger.errorsCount}static Log(e){Logger.Log(e)}static Warn(e){Logger.Warn(e)}static Error(e){Logger.Error(e)}static get LogCache(){return Logger.LogCache}static ClearLogCache(){Logger.ClearLogCache()}static set LogLevels(e){Logger.LogLevels=e}static set PerformanceLogLevel(e){if((e&Tools.PerformanceUserMarkLogLevel)===Tools.PerformanceUserMarkLogLevel){Tools.StartPerformanceCounter=Tools._StartUserMark,Tools.EndPerformanceCounter=Tools._EndUserMark;return}if((e&Tools.PerformanceConsoleLogLevel)===Tools.PerformanceConsoleLogLevel){Tools.StartPerformanceCounter=Tools._StartPerformanceConsole,Tools.EndPerformanceCounter=Tools._EndPerformanceConsole;return}Tools.StartPerformanceCounter=Tools._StartPerformanceCounterDisabled,Tools.EndPerformanceCounter=Tools._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!Tools._Performance){if(!IsWindowObjectExist())return;Tools._Performance=window.performance}!t||!Tools._Performance.mark||Tools._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!Tools._Performance.mark||(Tools._Performance.mark(e+"-End"),Tools._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(Tools._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(Tools._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return PrecisionDate.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,r=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const s=t?e:Object.getPrototypeOf(e);i=s.constructor.__bjsclassName__,r=s.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(r!=null?r+".":"")+i:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return IsNavigatorAvailable()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}}Tools.UseCustomRequestHeaders=!1;Tools.CustomRequestHeaders=WebRequest.CustomRequestHeaders;Tools._TmpFloatArray=new Float32Array(1);Tools.GetDOMTextContent=GetDOMTextContent;Tools.GetAbsoluteUrl=typeof document=="object"?a=>{const e=document.createElement("a");return e.href=a,e.href}:typeof URL=="function"&&typeof location=="object"?a=>new URL(a,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")};Tools.NoneLogLevel=Logger.NoneLogLevel;Tools.MessageLogLevel=Logger.MessageLogLevel;Tools.WarningLogLevel=Logger.WarningLogLevel;Tools.ErrorLogLevel=Logger.ErrorLogLevel;Tools.AllLogLevel=Logger.AllLogLevel;Tools.IsWindowObjectExist=IsWindowObjectExist;Tools.PerformanceNoneLogLevel=0;Tools.PerformanceUserMarkLogLevel=1;Tools.PerformanceConsoleLogLevel=2;Tools.StartPerformanceCounter=Tools._StartPerformanceCounterDisabled;Tools.EndPerformanceCounter=Tools._EndPerformanceCounterDisabled;class AsyncLoop{constructor(e,t,i,r=0){this.iterations=e,this.index=r-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,r=0){const s=new AsyncLoop(e,t,i,r);return s.executeNext(),s}static SyncAsyncForLoop(e,t,i,r,s,n=0){return AsyncLoop.Run(Math.ceil(e/t),o=>{s&&s()?o.breakLoop():setTimeout(()=>{for(let l=0;l<t;++l){const h=o.index*t+l;if(h>=e)break;if(i(h),s&&s()){o.breakLoop();break}}o.executeNext()},n)},r)}}EngineStore.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";class SmartArray{constructor(e){this.length=0,this.data=new Array(e),this._id=SmartArray._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}}SmartArray._GlobalId=0;class SmartArrayNoDuplicate extends SmartArray{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}class StringDictionary{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){const t=this._data[e];if(t!==void 0)return t}getOrAddWithFactory(e,t){let i=this.get(e);return i!==void 0||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return i!==void 0?i:(this.add(e,t),t)}contains(e){return this._data[e]!==void 0}add(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)}set(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data){const i=this._data[t];e(t,i)}}first(e){for(const t in this._data){const i=this._data[t],r=e(t,i);if(r)return r}return null}}class AndOrNotEvaluator{static Eval(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),AndOrNotEvaluator._HandleParenthesisContent(i,t))):e=AndOrNotEvaluator._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:AndOrNotEvaluator.Eval(e,t)}static _HandleParenthesisContent(e,t){t=t||(s=>s==="true");let i;const r=e.split("||");for(const s in r)if(Object.prototype.hasOwnProperty.call(r,s)){let n=AndOrNotEvaluator._SimplifyNegation(r[s].trim());const o=n.split("&&");if(o.length>1)for(let l=0;l<o.length;++l){const h=AndOrNotEvaluator._SimplifyNegation(o[l].trim());if(h!=="true"&&h!=="false"?h[0]==="!"?i=!t(h.substring(1)):i=t(h):i=h==="true",!i){n="false";break}}if(i||n==="true"){i=!0;break}n!=="true"&&n!=="false"?n[0]==="!"?i=!t(n.substring(1)):i=t(n):i=n==="true"}return i?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>""),t.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}}class Tags{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>Tags.HasTags(e),e.addTags=t=>Tags.AddTagsTo(e,t),e.removeTags=t=>Tags.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>Tags.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const i=[];for(const r in e._tags)Object.prototype.hasOwnProperty.call(e._tags,r)&&e._tags[r]===!0&&i.push(r);return i.join(" ")}else return e._tags}static AddTagsTo(e,t){if(!t||typeof t!="string")return;t.split(" ").forEach(function(r){Tags._AddTagTo(e,r)})}static _AddTagTo(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(Tags.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!Tags.HasTags(e))return;const i=t.split(" ");for(const r in i)Tags._RemoveTagFrom(e,i[r])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return t===void 0?!0:t===""?Tags.HasTags(e):AndOrNotEvaluator.Eval(t,i=>Tags.HasTags(e)&&e._tags[i])}}class AbstractScene{constructor(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}static AddParser(e,t){this._BabylonFileParsers[e]=t}static GetParser(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}static AddIndividualParser(e,t){this._IndividualBabylonFileParsers[e]=t}static GetIndividualParser(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}static Parse(e,t,i,r){for(const s in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,s)&&this._BabylonFileParsers[s](e,t,i,r)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=new Array;return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}}AbstractScene._BabylonFileParsers={};AbstractScene._IndividualBabylonFileParsers={};function __decorate(a,e,t,i){var r=arguments.length,s=r<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,n;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(a,e,t,i);else for(var o=a.length-1;o>=0;o--)(n=a[o])&&(s=(r<3?n(s):r>3?n(e,t,s):n(e,t))||s);return r>3&&s&&Object.defineProperty(e,t,s),s}function colorChannelToLinearSpace(a){return Math.pow(a,ToLinearSpace)}function colorChannelToLinearSpaceExact(a){return a<=.04045?.0773993808*a:Math.pow(.947867299*(a+.055),2.4)}function colorChannelToGammaSpace(a){return Math.pow(a,ToGammaSpace)}function colorChannelToGammaSpaceExact(a){return a<=.0031308?12.92*a:1.055*Math.pow(a,.41666)-.055}class Color3{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return Color3.FromArrayToRef(e,t,this),this}toColor4(e=1){return new Color4(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new Color3(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}scale(e){return new Color3(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}clampToRef(e=0,t=1,i){return i.r=Scalar.Clamp(this.r,e,t),i.g=Scalar.Clamp(this.g,e,t),i.b=Scalar.Clamp(this.b,e,t),this}add(e){return new Color3(this.r+e.r,this.g+e.g,this.b+e.b)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}subtract(e){return new Color3(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}clone(){return new Color3(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}toHexString(){const e=Math.round(this.r*255),t=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+Scalar.ToHex(e)+Scalar.ToHex(t)+Scalar.ToHex(i)}toHSV(){const e=new Color3;return this.toHSVToRef(e),e}toHSVToRef(e){const t=this.r,i=this.g,r=this.b,s=Math.max(t,i,r),n=Math.min(t,i,r);let o=0,l=0;const h=s,u=s-n;s!==0&&(l=u/s),s!=n&&(s==t?(o=(i-r)/u,i<r&&(o+=6)):s==i?o=(r-t)/u+2:s==r&&(o=(t-i)/u+4),o*=60),e.r=o,e.g=l,e.b=h}toLinearSpace(e=!1){const t=new Color3;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=colorChannelToLinearSpaceExact(this.r),e.g=colorChannelToLinearSpaceExact(this.g),e.b=colorChannelToLinearSpaceExact(this.b)):(e.r=colorChannelToLinearSpace(this.r),e.g=colorChannelToLinearSpace(this.g),e.b=colorChannelToLinearSpace(this.b)),this}toGammaSpace(e=!1){const t=new Color3;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=colorChannelToGammaSpaceExact(this.r),e.g=colorChannelToGammaSpaceExact(this.g),e.b=colorChannelToGammaSpaceExact(this.b)):(e.r=colorChannelToGammaSpace(this.r),e.g=colorChannelToGammaSpace(this.g),e.b=colorChannelToGammaSpace(this.b)),this}static HSVtoRGBToRef(e,t,i,r){const s=i*t,n=e/60,o=s*(1-Math.abs(n%2-1));let l=0,h=0,u=0;n>=0&&n<=1?(l=s,h=o):n>=1&&n<=2?(l=o,h=s):n>=2&&n<=3?(h=s,u=o):n>=3&&n<=4?(h=o,u=s):n>=4&&n<=5?(l=o,u=s):n>=5&&n<=6&&(l=s,u=o);const c=i-s;r.set(l+c,h+c,u+c)}static FromHSV(e,t,i){const r=new Color3(0,0,0);return Color3.HSVtoRGBToRef(e,t,i,r),r}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==7)return new Color3(0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),r=parseInt(e.substring(5,7),16);return Color3.FromInts(t,i,r)}static FromArray(e,t=0){return new Color3(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new Color3(e/255,t/255,i/255)}static Lerp(e,t,i){const r=new Color3(0,0,0);return Color3.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,h=-2*o+3*n,u=o-2*n+s,c=o-n,d=e.r*l+i.r*h+t.r*u+r.r*c,f=e.g*l+i.g*h+t.g*u+r.g*c,_=e.b*l+i.b*h+t.b*u+r.b*c;return new Color3(d,f,_)}static Hermite1stDerivative(e,t,i,r,s){const n=Color3.Black();return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const o=s*s;n.r=(o-s)*6*e.r+(3*o-4*s+1)*t.r+(-o+s)*6*i.r+(3*o-2*s)*r.r,n.g=(o-s)*6*e.g+(3*o-4*s+1)*t.g+(-o+s)*6*i.g+(3*o-2*s)*r.g,n.b=(o-s)*6*e.b+(3*o-4*s+1)*t.b+(-o+s)*6*i.b+(3*o-2*s)*r.b}static Red(){return new Color3(1,0,0)}static Green(){return new Color3(0,1,0)}static Blue(){return new Color3(0,0,1)}static Black(){return new Color3(0,0,0)}static get BlackReadOnly(){return Color3._BlackReadOnly}static White(){return new Color3(1,1,1)}static Purple(){return new Color3(.5,0,.5)}static Magenta(){return new Color3(1,0,1)}static Yellow(){return new Color3(1,1,0)}static Gray(){return new Color3(.5,.5,.5)}static Teal(){return new Color3(0,1,1)}static Random(){return new Color3(Math.random(),Math.random(),Math.random())}}Color3._BlackReadOnly=Color3.Black();class Color4{constructor(e=0,t=0,i=0,r=1){this.r=e,this.g=t,this.b=i,this.a=r}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return Color4.FromArrayToRef(e,t,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new Color4(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new Color4(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}scale(e){return new Color4(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}clampToRef(e=0,t=1,i){return i.r=Scalar.Clamp(this.r,e,t),i.g=Scalar.Clamp(this.g,e,t),i.b=Scalar.Clamp(this.b,e,t),i.a=Scalar.Clamp(this.a,e,t),this}multiply(e){return new Color4(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new Color4(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,r){return this.r=e,this.g=t,this.b=i,this.a=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}toHexString(e=!1){const t=Math.round(this.r*255),i=Math.round(this.g*255),r=Math.round(this.b*255);if(e)return"#"+Scalar.ToHex(t)+Scalar.ToHex(i)+Scalar.ToHex(r);const s=Math.round(this.a*255);return"#"+Scalar.ToHex(t)+Scalar.ToHex(i)+Scalar.ToHex(r)+Scalar.ToHex(s)}toLinearSpace(e=!1){const t=new Color4;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=colorChannelToLinearSpaceExact(this.r),e.g=colorChannelToLinearSpaceExact(this.g),e.b=colorChannelToLinearSpaceExact(this.b)):(e.r=colorChannelToLinearSpace(this.r),e.g=colorChannelToLinearSpace(this.g),e.b=colorChannelToLinearSpace(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new Color4;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=colorChannelToGammaSpaceExact(this.r),e.g=colorChannelToGammaSpaceExact(this.g),e.b=colorChannelToGammaSpaceExact(this.b)):(e.r=colorChannelToGammaSpace(this.r),e.g=colorChannelToGammaSpace(this.g),e.b=colorChannelToGammaSpace(this.b)),e.a=this.a,this}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==9&&e.length!==7)return new Color4(0,0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),r=parseInt(e.substring(5,7),16),s=e.length===9?parseInt(e.substring(7,9),16):255;return Color4.FromInts(t,i,r,s)}static Lerp(e,t,i){const r=new Color4(0,0,0,0);return Color4.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i,r.a=e.a+(t.a-e.a)*i}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,h=-2*o+3*n,u=o-2*n+s,c=o-n,d=e.r*l+i.r*h+t.r*u+r.r*c,f=e.g*l+i.g*h+t.g*u+r.g*c,_=e.b*l+i.b*h+t.b*u+r.b*c,g=e.a*l+i.a*h+t.a*u+r.a*c;return new Color4(d,f,_,g)}static Hermite1stDerivative(e,t,i,r,s){const n=new Color4;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const o=s*s;n.r=(o-s)*6*e.r+(3*o-4*s+1)*t.r+(-o+s)*6*i.r+(3*o-2*s)*r.r,n.g=(o-s)*6*e.g+(3*o-4*s+1)*t.g+(-o+s)*6*i.g+(3*o-2*s)*r.g,n.b=(o-s)*6*e.b+(3*o-4*s+1)*t.b+(-o+s)*6*i.b+(3*o-2*s)*r.b,n.a=(o-s)*6*e.a+(3*o-4*s+1)*t.a+(-o+s)*6*i.a+(3*o-2*s)*r.a}static FromColor3(e,t=1){return new Color4(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new Color4(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,r){return new Color4(e/255,t/255,i/255,r/255)}static CheckColors4(e,t){if(e.length===t*3){const i=[];for(let r=0;r<e.length;r+=3){const s=r/3*4;i[s]=e[r],i[s+1]=e[r+1],i[s+2]=e[r+2],i[s+3]=1}return i}return e}}class TmpColors{}TmpColors.Color3=ArrayTools.BuildArray(3,Color3.Black);TmpColors.Color4=ArrayTools.BuildArray(3,()=>new Color4(0,0,0,0));RegisterClass("BABYLON.Color3",Color3);RegisterClass("BABYLON.Color4",Color4);const __decoratorInitialStore={},__mergedStore={},_copySource=function(a,e,t,i={}){const r=a();Tags&&Tags.HasTags(e)&&Tags.AddTagsTo(r,Tags.GetTags(e,!0));const s=getMergedStore(r),n={};for(const o in s){const l=s[o],h=e[o],u=l.type;if(h!=null&&(o!=="uniqueId"||SerializationHelper.AllowLoadingUniqueId))switch(u){case 0:case 6:case 11:r[o]=h;break;case 1:i.cloneTexturesOnlyOnce&&n[h.uniqueId]?r[o]=n[h.uniqueId]:(r[o]=t||h.isRenderTarget?h:h.clone(),n[h.uniqueId]=r[o]);break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:r[o]=t?h:h.clone();break}}return r};function getDirectStore(a){const e=a.getClassName();return __decoratorInitialStore[e]||(__decoratorInitialStore[e]={}),__decoratorInitialStore[e]}function getMergedStore(a){const e=a.getClassName();if(__mergedStore[e])return __mergedStore[e];__mergedStore[e]={};const t=__mergedStore[e];let i=a,r=e;for(;r;){const s=__decoratorInitialStore[r];for(const l in s)t[l]=s[l];let n,o=!1;do{if(n=Object.getPrototypeOf(i),!n.getClassName){o=!0;break}if(n.getClassName()!==r)break;i=n}while(n);if(o)break;r=n.getClassName(),i=n}return t}function generateSerializableMember(a,e){return(t,i)=>{const r=getDirectStore(t);r[i]||(r[i]={type:a,sourceName:e})}}function generateExpandMember(a,e=null){return(t,i)=>{const r=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[r]},set:function(s){typeof this.equals=="function"&&this.equals(s)||this[r]!==s&&(this[r]=s,t[a].apply(this))},enumerable:!0,configurable:!0})}}function expandToProperty(a,e=null){return generateExpandMember(a,e)}function serialize(a){return generateSerializableMember(0,a)}function serializeAsTexture(a){return generateSerializableMember(1,a)}function serializeAsColor3(a){return generateSerializableMember(2,a)}function serializeAsFresnelParameters(a){return generateSerializableMember(3,a)}function serializeAsVector2(a){return generateSerializableMember(4,a)}function serializeAsVector3(a){return generateSerializableMember(5,a)}function serializeAsMeshReference(a){return generateSerializableMember(6,a)}function serializeAsColorCurves(a){return generateSerializableMember(7,a)}function serializeAsColor4(a){return generateSerializableMember(8,a)}function serializeAsImageProcessingConfiguration(a){return generateSerializableMember(9,a)}function serializeAsQuaternion(a){return generateSerializableMember(10,a)}function serializeAsMatrix(a){return generateSerializableMember(12,a)}class SerializationHelper{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const r=e.animations[i];t.animations.push(r.serialize())}}}static Serialize(e,t){t||(t={}),Tags&&(t.tags=Tags.GetTags(e));const i=getMergedStore(e);for(const r in i){const s=i[r],n=s.sourceName||r,o=s.type,l=e[r];if(l!=null&&(r!=="uniqueId"||SerializationHelper.AllowLoadingUniqueId))switch(o){case 0:t[n]=l;break;case 1:t[n]=l.serialize();break;case 2:t[n]=l.asArray();break;case 3:t[n]=l.serialize();break;case 4:t[n]=l.asArray();break;case 5:t[n]=l.asArray();break;case 6:t[n]=l.id;break;case 7:t[n]=l.serialize();break;case 8:t[n]=l.asArray();break;case 9:t[n]=l.serialize();break;case 10:t[n]=l.asArray();break;case 11:t[n]=l.id;break;case 12:t[n]=l.asArray();break}}return t}static ParseProperties(e,t,i,r){r||(r="");const s=getMergedStore(t);for(const n in s){const o=s[n],l=e[o.sourceName||n],h=o.type;if(l!=null&&(n!=="uniqueId"||SerializationHelper.AllowLoadingUniqueId)){const u=t;switch(h){case 0:u[n]=l;break;case 1:i&&(u[n]=SerializationHelper._TextureParser(l,i,r));break;case 2:u[n]=Color3.FromArray(l);break;case 3:u[n]=SerializationHelper._FresnelParametersParser(l);break;case 4:u[n]=Vector2.FromArray(l);break;case 5:u[n]=Vector3.FromArray(l);break;case 6:i&&(u[n]=i.getLastMeshById(l));break;case 7:u[n]=SerializationHelper._ColorCurvesParser(l);break;case 8:u[n]=Color4.FromArray(l);break;case 9:u[n]=SerializationHelper._ImageProcessingConfigurationParser(l);break;case 10:u[n]=Quaternion.FromArray(l);break;case 11:i&&(u[n]=i.getCameraById(l));break;case 12:u[n]=Matrix.FromArray(l);break}}}}static Parse(e,t,i,r=null){const s=e();return Tags&&Tags.AddTagsTo(s,t.tags),SerializationHelper.ParseProperties(t,s,i,r),s}static Clone(e,t,i={}){return _copySource(e,t,!1,i)}static Instanciate(e,t){return _copySource(e,t,!0)}}SerializationHelper.AllowLoadingUniqueId=!1;SerializationHelper._ImageProcessingConfigurationParser=a=>{throw _WarnImport("ImageProcessingConfiguration")};SerializationHelper._FresnelParametersParser=a=>{throw _WarnImport("FresnelParameters")};SerializationHelper._ColorCurvesParser=a=>{throw _WarnImport("ColorCurves")};SerializationHelper._TextureParser=(a,e,t)=>{throw _WarnImport("Texture")};function nativeOverride(a,e,t,i){const r=t.value;t.value=(...s)=>{let n=r;if(typeof _native<"u"&&_native[e]){const o=_native[e];i?n=(...l)=>i(...l)?o(...l):r(...l):n=o}return a[e]=n,n(...s)}}nativeOverride.filter=function(a){return(e,t,i)=>nativeOverride(e,t,i,a)};class MaterialDefines{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!1,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))e[0]!=="_"&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)this._keys.indexOf(e)===-1&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var t,i,r,s,n;const o=(r=(i=(t=this._externalProperties)===null||t===void 0?void 0:t[e])===null||i===void 0?void 0:i.type)!==null&&r!==void 0?r:typeof this[e],l=(n=(s=this._externalProperties)===null||s===void 0?void 0:s[e])===null||n===void 0?void 0:n.default;switch(o){case"number":this[e]=l??0;break;case"string":this[e]=l??"";break;default:this[e]=l??!1;break}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=this[i];switch(typeof r){case"number":case"string":e+="#define "+i+" "+r+`
`;break;default:r&&(e+="#define "+i+`
`);break}}return e}}class ColorCurves{constructor(){this._dirty=!0,this._tempColor=new Color4(0,0,0,0),this._globalCurve=new Color4(0,0,0,0),this._highlightsCurve=new Color4(0,0,0,0),this._midtonesCurve=new Color4(0,0,0,0),this._shadowsCurve=new Color4(0,0,0,0),this._positiveCurve=new Color4(0,0,0,0),this._negativeCurve=new Color4(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",r="vCameraColorCurveNeutral",s="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(s,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(e,t,i,r,s){e!=null&&(e=ColorCurves._Clamp(e,0,360),t=ColorCurves._Clamp(t,-100,100),i=ColorCurves._Clamp(i,-100,100),r=ColorCurves._Clamp(r,-100,100),t=ColorCurves._ApplyColorGradingSliderNonlinear(t),t*=.5,r=ColorCurves._ApplyColorGradingSliderNonlinear(r),t<0&&(t*=-1,e=(e+180)%360),ColorCurves._FromHSBToRef(e,t,50+.25*r,s),s.scaleToRef(2,s),s.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,r){let s=ColorCurves._Clamp(e,0,360);const n=ColorCurves._Clamp(t/100,0,1),o=ColorCurves._Clamp(i/100,0,1);if(n===0)r.r=o,r.g=o,r.b=o;else{s/=60;const l=Math.floor(s),h=s-l,u=o*(1-n),c=o*(1-n*h),d=o*(1-n*(1-h));switch(l){case 0:r.r=o,r.g=d,r.b=u;break;case 1:r.r=c,r.g=o,r.b=u;break;case 2:r.r=u,r.g=o,r.b=d;break;case 3:r.r=u,r.g=c,r.b=o;break;case 4:r.r=d,r.g=u,r.b=o;break;default:r.r=o,r.g=u,r.b=c;break}}r.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return SerializationHelper.Clone(()=>new ColorCurves,this)}serialize(){return SerializationHelper.Serialize(this)}static Parse(e){return SerializationHelper.Parse(()=>new ColorCurves,e,null,null)}}__decorate([serialize()],ColorCurves.prototype,"_globalHue",void 0);__decorate([serialize()],ColorCurves.prototype,"_globalDensity",void 0);__decorate([serialize()],ColorCurves.prototype,"_globalSaturation",void 0);__decorate([serialize()],ColorCurves.prototype,"_globalExposure",void 0);__decorate([serialize()],ColorCurves.prototype,"_highlightsHue",void 0);__decorate([serialize()],ColorCurves.prototype,"_highlightsDensity",void 0);__decorate([serialize()],ColorCurves.prototype,"_highlightsSaturation",void 0);__decorate([serialize()],ColorCurves.prototype,"_highlightsExposure",void 0);__decorate([serialize()],ColorCurves.prototype,"_midtonesHue",void 0);__decorate([serialize()],ColorCurves.prototype,"_midtonesDensity",void 0);__decorate([serialize()],ColorCurves.prototype,"_midtonesSaturation",void 0);__decorate([serialize()],ColorCurves.prototype,"_midtonesExposure",void 0);SerializationHelper._ColorCurvesParser=ColorCurves.Parse;class ImageProcessingConfiguration{constructor(){this.colorCurves=new ColorCurves,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=ImageProcessingConfiguration.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new Color4(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=ImageProcessingConfiguration.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new Observable}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&ColorCurves.PrepareUniforms(e),t.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,t){t.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===ImageProcessingConfiguration._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case ImageProcessingConfiguration.TONEMAPPING_ACES:e.TONEMAPPING_ACES=!0;break;default:e.TONEMAPPING_ACES=!1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&ColorCurves.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),r=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,r),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const s=t??r/i;let n=Math.tan(this.vignetteCameraFov*.5),o=n*s;const l=Math.sqrt(o*n);o=Tools.Mix(o,l,this.vignetteStretch),n=Tools.Mix(n,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",o,n,-o*this.vignetteCenterX,-n*this.vignetteCenterY);const h=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,h)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return SerializationHelper.Clone(()=>new ImageProcessingConfiguration,this)}serialize(){return SerializationHelper.Serialize(this)}static Parse(e){const t=SerializationHelper.Parse(()=>new ImageProcessingConfiguration,e,null,null);return e.vignetteCentreX!==void 0&&(t.vignetteCenterX=e.vignetteCentreX),e.vignetteCentreY!==void 0&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}ImageProcessingConfiguration.TONEMAPPING_STANDARD=0;ImageProcessingConfiguration.TONEMAPPING_ACES=1;ImageProcessingConfiguration._VIGNETTEMODE_MULTIPLY=0;ImageProcessingConfiguration._VIGNETTEMODE_OPAQUE=1;__decorate([serializeAsColorCurves()],ImageProcessingConfiguration.prototype,"colorCurves",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_colorCurvesEnabled",void 0);__decorate([serializeAsTexture("colorGradingTexture")],ImageProcessingConfiguration.prototype,"_colorGradingTexture",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_colorGradingEnabled",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_colorGradingWithGreenDepth",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_colorGradingBGR",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_exposure",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_toneMappingEnabled",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_toneMappingType",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_contrast",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"vignetteStretch",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"vignetteCenterX",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"vignetteCenterY",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"vignetteWeight",void 0);__decorate([serializeAsColor4()],ImageProcessingConfiguration.prototype,"vignetteColor",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"vignetteCameraFov",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_vignetteBlendMode",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_vignetteEnabled",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_ditheringEnabled",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_ditheringIntensity",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_skipFinalColorClamp",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_applyByPostProcess",void 0);__decorate([serialize()],ImageProcessingConfiguration.prototype,"_isEnabled",void 0);SerializationHelper._ImageProcessingConfigurationParser=ImageProcessingConfiguration.Parse;ThinEngine.prototype.createUniformBuffer=function(a){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create uniform buffer");const t=new WebGLDataBuffer(e);return this.bindUniformBuffer(t),a instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,a,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(a),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};ThinEngine.prototype.createDynamicUniformBuffer=function(a){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create dynamic uniform buffer");const t=new WebGLDataBuffer(e);return this.bindUniformBuffer(t),a instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,a,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(a),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};ThinEngine.prototype.updateUniformBuffer=function(a,e,t,i){this.bindUniformBuffer(a),t===void 0&&(t=0),i===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)};ThinEngine.prototype.bindUniformBuffer=function(a){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,a?a.underlyingResource:null)};ThinEngine.prototype.bindUniformBufferBase=function(a,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,a?a.underlyingResource:null)};ThinEngine.prototype.bindUniformBlock=function(a,e,t){const i=a.program,r=this._gl.getUniformBlockIndex(i,e);r!==4294967295&&this._gl.uniformBlockBinding(i,r,t)};class UniformBuffer{constructor(e,t,i,r,s=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||s,this._dynamic=i,this._name=r??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){const i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const r=this._uniformLocationPointer-i;for(let s=0;s<r;s++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let r;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},t==16)t=t*i;else{const n=(4-t)*i;t=t*i+n}r=[];for(let s=0;s<t;s++)r.push(0)}else{if(t instanceof Array)r=t,t=r.length;else{t=t,r=[];for(let s=0;s<t;s++)r.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let s=0;s<t;s++)this._data.push(r[s]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}addFloat2(e,t,i){const r=[t,i];this.addUniform(e,r)}addFloat3(e,t,i,r){const s=[t,i,r];this.addUniform(e,s)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const r=[t.r,t.g,t.b,i];this.addUniform(e,r)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(UniformBuffer._UpdatedUbosInFrame[this._name]||(UniformBuffer._UpdatedUbosInFrame[this._name]=0),UniformBuffer._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let r=this._uniformLocations[e];if(r===void 0){if(this._buffer){Logger.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let s=0;s<i;s++)this._bufferData[r+s]=t[s];else{let s=!1;for(let n=0;n<i;n++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[r+n]!==Tools.FloatRound(t[n]))&&(s=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+n]=t[n]);this._needSync=this._needSync||s}}updateUniformArray(e,t,i){this._checkNewFrame();const r=this._uniformLocations[e];if(r===void 0){Logger.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();const s=this._uniformArraySizes[e];if(this._dynamic)for(let n=0;n<i;n++)this._bufferData[r+n]=t[n];else{let n=!1,o=0,l=0;for(let h=0;h<i;h++)if(this._bufferData[r+l*4+o]!==Tools.FloatRound(t[h])&&(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+l*4+o]=t[h]),o++,o===s.strideSize){for(;o<4;o++)this._bufferData[r+l*4+o]=0;o=0,l++}this._needSync=this._needSync||n}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)UniformBuffer._TempBuffer[i*4]=t[i*3],UniformBuffer._TempBuffer[i*4+1]=t[i*3+1],UniformBuffer._TempBuffer[i*4+2]=t[i*3+2],UniformBuffer._TempBuffer[i*4+3]=0;this.updateUniform(e,UniformBuffer._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)UniformBuffer._TempBuffer[i*4]=t[i*2],UniformBuffer._TempBuffer[i*4+1]=t[i*2+1],UniformBuffer._TempBuffer[i*4+2]=0,UniformBuffer._TempBuffer[i*4+3]=0;this.updateUniform(e,UniformBuffer._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){UniformBuffer._TempBuffer[0]=t,this.updateUniform(e,UniformBuffer._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,r=""){this._currentEffect.setFloat2(e+r,t,i)}_updateFloat2ForUniform(e,t,i){UniformBuffer._TempBuffer[0]=t,UniformBuffer._TempBuffer[1]=i,this.updateUniform(e,UniformBuffer._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,r,s=""){this._currentEffect.setFloat3(e+s,t,i,r)}_updateFloat3ForUniform(e,t,i,r){UniformBuffer._TempBuffer[0]=t,UniformBuffer._TempBuffer[1]=i,UniformBuffer._TempBuffer[2]=r,this.updateUniform(e,UniformBuffer._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setFloat4(e+n,t,i,r,s)}_updateFloat4ForUniform(e,t,i,r,s){UniformBuffer._TempBuffer[0]=t,UniformBuffer._TempBuffer[1]=i,UniformBuffer._TempBuffer[2]=r,UniformBuffer._TempBuffer[3]=s,this.updateUniform(e,UniformBuffer._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){UniformBuffer._TempBufferInt32View.set(t),this.updateUniformArray(e,UniformBuffer._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){UniformBuffer._TempBufferUInt32View.set(t),this.updateUniformArray(e,UniformBuffer._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){UniformBuffer._TempBuffer[0]=t.x,UniformBuffer._TempBuffer[1]=t.y,UniformBuffer._TempBuffer[2]=t.z,this.updateUniform(e,UniformBuffer._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){UniformBuffer._TempBuffer[0]=t.x,UniformBuffer._TempBuffer[1]=t.y,UniformBuffer._TempBuffer[2]=t.z,UniformBuffer._TempBuffer[3]=t.w,this.updateUniform(e,UniformBuffer._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){UniformBuffer._TempBuffer[0]=t.r,UniformBuffer._TempBuffer[1]=t.g,UniformBuffer._TempBuffer[2]=t.b,this.updateUniform(e,UniformBuffer._TempBuffer,3)}_updateColor4ForEffect(e,t,i,r=""){this._currentEffect.setColor4(e+r,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){UniformBuffer._TempBuffer[0]=t.r,UniformBuffer._TempBuffer[1]=t.g,UniformBuffer._TempBuffer[2]=t.b,UniformBuffer._TempBuffer[3]=i,this.updateUniform(e,UniformBuffer._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){UniformBuffer._TempBuffer[0]=t.r,UniformBuffer._TempBuffer[1]=t.g,UniformBuffer._TempBuffer[2]=t.b,UniformBuffer._TempBuffer[3]=t.a,this.updateUniform(e,UniformBuffer._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){UniformBuffer._TempBufferInt32View[0]=t,this.updateUniform(e,UniformBuffer._TempBuffer,1)}_updateInt2ForEffect(e,t,i,r=""){this._currentEffect.setInt2(e+r,t,i)}_updateInt2ForUniform(e,t,i){UniformBuffer._TempBufferInt32View[0]=t,UniformBuffer._TempBufferInt32View[1]=i,this.updateUniform(e,UniformBuffer._TempBuffer,2)}_updateInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setInt3(e+s,t,i,r)}_updateInt3ForUniform(e,t,i,r){UniformBuffer._TempBufferInt32View[0]=t,UniformBuffer._TempBufferInt32View[1]=i,UniformBuffer._TempBufferInt32View[2]=r,this.updateUniform(e,UniformBuffer._TempBuffer,3)}_updateInt4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setInt4(e+n,t,i,r,s)}_updateInt4ForUniform(e,t,i,r,s){UniformBuffer._TempBufferInt32View[0]=t,UniformBuffer._TempBufferInt32View[1]=i,UniformBuffer._TempBufferInt32View[2]=r,UniformBuffer._TempBufferInt32View[3]=s,this.updateUniform(e,UniformBuffer._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){UniformBuffer._TempBufferUInt32View[0]=t,this.updateUniform(e,UniformBuffer._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,r=""){this._currentEffect.setUInt2(e+r,t,i)}_updateUInt2ForUniform(e,t,i){UniformBuffer._TempBufferUInt32View[0]=t,UniformBuffer._TempBufferUInt32View[1]=i,this.updateUniform(e,UniformBuffer._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setUInt3(e+s,t,i,r)}_updateUInt3ForUniform(e,t,i,r){UniformBuffer._TempBufferUInt32View[0]=t,UniformBuffer._TempBufferUInt32View[1]=i,UniformBuffer._TempBufferUInt32View[2]=r,this.updateUniform(e,UniformBuffer._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setUInt4(e+n,t,i,r,s)}_updateUInt4ForUniform(e,t,i,r,s){UniformBuffer._TempBufferUInt32View[0]=t,UniformBuffer._TempBufferUInt32View[1]=i,UniformBuffer._TempBufferUInt32View[2]=r,UniformBuffer._TempBufferUInt32View[3]=s,this.updateUniform(e,UniformBuffer._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i){const r=this._buffers[i][0];this._engine._releaseBuffer(r)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}UniformBuffer._UpdatedUbosInFrame={};UniformBuffer._MAX_UNIFORM_SIZE=256;UniformBuffer._TempBuffer=new Float32Array(UniformBuffer._MAX_UNIFORM_SIZE);UniformBuffer._TempBufferInt32View=new Int32Array(UniformBuffer._TempBuffer.buffer);UniformBuffer._TempBufferUInt32View=new Uint32Array(UniformBuffer._TempBuffer.buffer);class ActionEvent{constructor(e,t,i,r,s,n){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=r,this.sourceEvent=s,this.additionalData=n}static CreateNew(e,t,i){const r=e.getScene();return new ActionEvent(e,r.pointerX,r.pointerY,r.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,r){return new ActionEvent(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,r)}static CreateNewFromScene(e,t){return new ActionEvent(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,r){return new ActionEvent(e,t.x,t.y,null,i,r)}}class PostProcessManager{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[VertexBuffer.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[VertexBuffer.PositionKind]=new VertexBuffer(this._scene.getEngine(),e,VertexBuffer.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[VertexBuffer.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!i||(t=t||i._postProcesses.filter(r=>r!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(i,e,t!=null),!0)}directRender(e,t=null,i=!1,r=0,s=0,n=!1){var o;const l=this._scene.getEngine();for(let h=0;h<e.length;h++){h<e.length-1?e[h+1].activate(this._scene.activeCamera,t==null?void 0:t.texture):(t?l.bindFramebuffer(t,r,void 0,void 0,i,s):n||l.restoreDefaultFramebuffer(),(o=l._debugInsertMarker)===null||o===void 0||o.call(l,`post process ${e[h].name} output`));const u=e[h],c=u.apply();c&&(u.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,c),l.drawElementsType(0,0,6),u.onAfterRenderObservable.notifyObservers(c))}l.setDepthBuffer(!0),l.setDepthWrite(!0)}_finalizeFrame(e,t,i,r,s=!1){var n;const o=this._scene.activeCamera;if(!o||(r=r||o._postProcesses.filter(h=>h!=null),r.length===0||!this._scene.postProcessesEnabled))return;const l=this._scene.getEngine();for(let h=0,u=r.length;h<u;h++){const c=r[h];if(h<u-1?c._outputTexture=r[h+1].activate(o,t==null?void 0:t.texture):(t?(l.bindFramebuffer(t,i,void 0,void 0,s),c._outputTexture=t):(l.restoreDefaultFramebuffer(),c._outputTexture=null),(n=l._debugInsertMarker)===null||n===void 0||n.call(l,`post process ${r[h].name} output`)),e)break;const d=c.apply();d&&(c.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,d),l.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(d))}l.setDepthBuffer(!0),l.setDepthWrite(!0),l.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class RenderingGroup{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=RenderingGroup.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=RenderingGroup.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=RenderingGroup.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,r=null,s=null){this.index=e,this._opaqueSubMeshes=new SmartArray(256),this._transparentSubMeshes=new SmartArray(256),this._alphaTestSubMeshes=new SmartArray(256),this._depthOnlySubMeshes=new SmartArray(256),this._particleSystems=new SmartArray(256),this._spriteManagers=new SmartArray(256),this._empty=!0,this._edgesRenderers=new SmartArrayNoDuplicate(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=s}render(e,t,i,r){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}const s=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(s.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),s.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=s.getStencilBuffer();if(s.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(s.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const o=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);o.length&&this._renderTransparent(o)}else this._renderTransparent(this._transparentSubMeshes);s.setAlphaMode(0)}if(s.setStencilBuffer(!1),this._edgesRenderers.length){for(let o=0;o<this._edgesRenderers.length;o++)this._edgesRenderers.data[o].render();s.setAlphaMode(0)}s.setStencilBuffer(n)}_renderOpaqueSorted(e){return RenderingGroup._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){return RenderingGroup._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){return RenderingGroup._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,r){let s=0,n;const o=i?i.globalPosition:RenderingGroup._ZeroVector;if(r)for(;s<e.length;s++)n=e.data[s],n._alphaIndex=n.getMesh().alphaIndex,n._distanceToCamera=Vector3.Distance(n.getBoundingInfo().boundingSphere.centerWorld,o);const l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);const h=l[0].getMesh().getScene();for(s=0;s<l.length;s++)if(n=l[s],!(h._activeMeshesFrozenButKeepClipping&&!n.isInFrustum(h._frustumPlanes))){if(r){const u=n.getMaterial();if(u&&u.needDepthPrePass){const c=u.getScene().getEngine();c.setColorWrite(!1),c.setAlphaMode(0),n.render(!1),c.setColorWrite(!0)}}n.render(r)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:RenderingGroup.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),r=t.getMesh();return i.material&&r.material?i.material.uniqueId-r.material.uniqueId:i.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const r=this._particleSystems.data[i];if((t&&t.layerMask&r.layerMask)===0)continue;const s=r.emitter;(!s.position||!e||e.indexOf(s)!==-1)&&this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}RenderingGroup._ZeroVector=Vector3.Zero();class RenderingGroupInfo{}class RenderingManager{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){if(e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,!this._maintainStateBetweenFrames)){for(const t of this._scene.meshes)if(t.subMeshes)for(const i of t.subMeshes)i._wasDispatched=!1;if(this._scene.spriteManagers)for(const t of this._scene.spriteManagers)t._wasDispatched=!1;for(const t of this._scene.particleSystems)t._wasDispatched=!1}}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new RenderingGroupInfo,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=RenderingManager.MIN_RENDERINGGROUPS;t<RenderingManager.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,r){const s=this._renderingGroupInfo;if(s.scene=this._scene,s.camera=this._scene.activeCamera,this._scene.spriteManagers&&r)for(let n=0;n<this._scene.spriteManagers.length;n++){const o=this._scene.spriteManagers[n];this.dispatchSprites(o)}for(let n=RenderingManager.MIN_RENDERINGGROUPS;n<RenderingManager.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===RenderingManager.MIN_RENDERINGGROUPS;const o=this._renderingGroups[n];if(!o||o._empty)continue;const l=Math.pow(2,n);if(s.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(s,l),RenderingManager.AUTOCLEAR){const h=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];h&&h.autoClear&&this._clearDepthStencilBuffer(h.depth,h.stencil)}for(const h of this._scene._beforeRenderingGroupDrawStage)h.action(n);o.render(e,r,i,t);for(const h of this._scene._afterRenderingGroupDrawStage)h.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(s,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=RenderingManager.MIN_RENDERINGGROUPS;e<RenderingManager.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=RenderingManager.MIN_RENDERINGGROUPS;e<RenderingManager.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=RenderingManager.MIN_RENDERINGGROUPS;e<RenderingManager.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new RenderingGroup(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,r=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]){const s=this._renderingGroups[e];s.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],s.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],s.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:r}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}RenderingManager.MAX_RENDERINGGROUPS=4;RenderingManager.MIN_RENDERINGGROUPS=0;RenderingManager.AUTOCLEAR=!0;class SceneComponentConstants{}SceneComponentConstants.NAME_EFFECTLAYER="EffectLayer";SceneComponentConstants.NAME_LAYER="Layer";SceneComponentConstants.NAME_LENSFLARESYSTEM="LensFlareSystem";SceneComponentConstants.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer";SceneComponentConstants.NAME_PARTICLESYSTEM="ParticleSystem";SceneComponentConstants.NAME_GAMEPAD="Gamepad";SceneComponentConstants.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue";SceneComponentConstants.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer";SceneComponentConstants.NAME_PREPASSRENDERER="PrePassRenderer";SceneComponentConstants.NAME_DEPTHRENDERER="DepthRenderer";SceneComponentConstants.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer";SceneComponentConstants.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager";SceneComponentConstants.NAME_SPRITE="Sprite";SceneComponentConstants.NAME_SUBSURFACE="SubSurface";SceneComponentConstants.NAME_OUTLINERENDERER="Outline";SceneComponentConstants.NAME_PROCEDURALTEXTURE="ProceduralTexture";SceneComponentConstants.NAME_SHADOWGENERATOR="ShadowGenerator";SceneComponentConstants.NAME_OCTREE="Octree";SceneComponentConstants.NAME_PHYSICSENGINE="PhysicsEngine";SceneComponentConstants.NAME_AUDIO="Audio";SceneComponentConstants.NAME_FLUIDRENDERER="FluidRenderer";SceneComponentConstants.STEP_ISREADYFORMESH_EFFECTLAYER=0;SceneComponentConstants.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0;SceneComponentConstants.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0;SceneComponentConstants.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0;SceneComponentConstants.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1;SceneComponentConstants.STEP_BEFORECAMERADRAW_PREPASS=0;SceneComponentConstants.STEP_BEFORECAMERADRAW_EFFECTLAYER=1;SceneComponentConstants.STEP_BEFORECAMERADRAW_LAYER=2;SceneComponentConstants.STEP_BEFORERENDERTARGETDRAW_PREPASS=0;SceneComponentConstants.STEP_BEFORERENDERTARGETDRAW_LAYER=1;SceneComponentConstants.STEP_BEFORERENDERINGMESH_PREPASS=0;SceneComponentConstants.STEP_BEFORERENDERINGMESH_OUTLINE=1;SceneComponentConstants.STEP_AFTERRENDERINGMESH_PREPASS=0;SceneComponentConstants.STEP_AFTERRENDERINGMESH_OUTLINE=1;SceneComponentConstants.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0;SceneComponentConstants.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1;SceneComponentConstants.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0;SceneComponentConstants.STEP_BEFORECAMERAUPDATE_GAMEPAD=1;SceneComponentConstants.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0;SceneComponentConstants.STEP_BEFORECLEAR_PREPASS=1;SceneComponentConstants.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0;SceneComponentConstants.STEP_AFTERRENDERTARGETDRAW_PREPASS=0;SceneComponentConstants.STEP_AFTERRENDERTARGETDRAW_LAYER=1;SceneComponentConstants.STEP_AFTERCAMERADRAW_PREPASS=0;SceneComponentConstants.STEP_AFTERCAMERADRAW_EFFECTLAYER=1;SceneComponentConstants.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2;SceneComponentConstants.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3;SceneComponentConstants.STEP_AFTERCAMERADRAW_LAYER=4;SceneComponentConstants.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5;SceneComponentConstants.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0;SceneComponentConstants.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0;SceneComponentConstants.STEP_AFTERRENDER_AUDIO=0;SceneComponentConstants.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0;SceneComponentConstants.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1;SceneComponentConstants.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2;SceneComponentConstants.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3;SceneComponentConstants.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0;SceneComponentConstants.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1;SceneComponentConstants.STEP_POINTERMOVE_SPRITE=0;SceneComponentConstants.STEP_POINTERDOWN_SPRITE=0;SceneComponentConstants.STEP_POINTERUP_SPRITE=0;class Stage extends Array{constructor(e){super(...e)}static Create(){return Object.create(Stage.prototype)}registerStep(e,t,i){let r=0,s=Number.MAX_VALUE;for(;r<this.length&&(s=this[r].index,!(e<s));r++);this.splice(r,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}class PointerEventTypes{}PointerEventTypes.POINTERDOWN=1;PointerEventTypes.POINTERUP=2;PointerEventTypes.POINTERMOVE=4;PointerEventTypes.POINTERWHEEL=8;PointerEventTypes.POINTERPICK=16;PointerEventTypes.POINTERTAP=32;PointerEventTypes.POINTERDOUBLETAP=64;class PointerInfoBase{constructor(e,t){this.type=e,this.event=t}}class PointerInfoPre extends PointerInfoBase{constructor(e,t,i,r){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new Vector2(i,r)}}class PointerInfo extends PointerInfoBase{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,r=null){super(e,t),this._pickInfo=i,this._inputManager=r}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}class AbstractActionManager{constructor(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}static get HasTriggers(){for(const e in AbstractActionManager.Triggers)if(Object.prototype.hasOwnProperty.call(AbstractActionManager.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in AbstractActionManager.Triggers)if(Object.prototype.hasOwnProperty.call(AbstractActionManager.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in AbstractActionManager.Triggers)if(Object.prototype.hasOwnProperty.call(AbstractActionManager.Triggers,t)&&parseInt(t)===e)return!0;return!1}}AbstractActionManager.Triggers={};class KeyboardEventTypes{}KeyboardEventTypes.KEYDOWN=1;KeyboardEventTypes.KEYUP=2;class KeyboardInfo{constructor(e,t){this.type=e,this.event=t}}class KeyboardInfoPre extends KeyboardInfo{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}var DeviceType;(function(a){a[a.Generic=0]="Generic",a[a.Keyboard=1]="Keyboard",a[a.Mouse=2]="Mouse",a[a.Touch=3]="Touch",a[a.DualShock=4]="DualShock",a[a.Xbox=5]="Xbox",a[a.Switch=6]="Switch",a[a.DualSense=7]="DualSense"})(DeviceType||(DeviceType={}));var PointerInput;(function(a){a[a.Horizontal=0]="Horizontal",a[a.Vertical=1]="Vertical",a[a.LeftClick=2]="LeftClick",a[a.MiddleClick=3]="MiddleClick",a[a.RightClick=4]="RightClick",a[a.BrowserBack=5]="BrowserBack",a[a.BrowserForward=6]="BrowserForward",a[a.MouseWheelX=7]="MouseWheelX",a[a.MouseWheelY=8]="MouseWheelY",a[a.MouseWheelZ=9]="MouseWheelZ",a[a.Move=12]="Move"})(PointerInput||(PointerInput={}));var NativePointerInput;(function(a){a[a.Horizontal=0]="Horizontal",a[a.Vertical=1]="Vertical",a[a.LeftClick=2]="LeftClick",a[a.MiddleClick=3]="MiddleClick",a[a.RightClick=4]="RightClick",a[a.BrowserBack=5]="BrowserBack",a[a.BrowserForward=6]="BrowserForward",a[a.MouseWheelX=7]="MouseWheelX",a[a.MouseWheelY=8]="MouseWheelY",a[a.MouseWheelZ=9]="MouseWheelZ",a[a.DeltaHorizontal=10]="DeltaHorizontal",a[a.DeltaVertical=11]="DeltaVertical"})(NativePointerInput||(NativePointerInput={}));var DualShockInput;(function(a){a[a.Cross=0]="Cross",a[a.Circle=1]="Circle",a[a.Square=2]="Square",a[a.Triangle=3]="Triangle",a[a.L1=4]="L1",a[a.R1=5]="R1",a[a.L2=6]="L2",a[a.R2=7]="R2",a[a.Share=8]="Share",a[a.Options=9]="Options",a[a.L3=10]="L3",a[a.R3=11]="R3",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.TouchPad=17]="TouchPad",a[a.LStickXAxis=18]="LStickXAxis",a[a.LStickYAxis=19]="LStickYAxis",a[a.RStickXAxis=20]="RStickXAxis",a[a.RStickYAxis=21]="RStickYAxis"})(DualShockInput||(DualShockInput={}));var DualSenseInput;(function(a){a[a.Cross=0]="Cross",a[a.Circle=1]="Circle",a[a.Square=2]="Square",a[a.Triangle=3]="Triangle",a[a.L1=4]="L1",a[a.R1=5]="R1",a[a.L2=6]="L2",a[a.R2=7]="R2",a[a.Create=8]="Create",a[a.Options=9]="Options",a[a.L3=10]="L3",a[a.R3=11]="R3",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.TouchPad=17]="TouchPad",a[a.LStickXAxis=18]="LStickXAxis",a[a.LStickYAxis=19]="LStickYAxis",a[a.RStickXAxis=20]="RStickXAxis",a[a.RStickYAxis=21]="RStickYAxis"})(DualSenseInput||(DualSenseInput={}));var XboxInput;(function(a){a[a.A=0]="A",a[a.B=1]="B",a[a.X=2]="X",a[a.Y=3]="Y",a[a.LB=4]="LB",a[a.RB=5]="RB",a[a.LT=6]="LT",a[a.RT=7]="RT",a[a.Back=8]="Back",a[a.Start=9]="Start",a[a.LS=10]="LS",a[a.RS=11]="RS",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.LStickXAxis=17]="LStickXAxis",a[a.LStickYAxis=18]="LStickYAxis",a[a.RStickXAxis=19]="RStickXAxis",a[a.RStickYAxis=20]="RStickYAxis"})(XboxInput||(XboxInput={}));var SwitchInput;(function(a){a[a.B=0]="B",a[a.A=1]="A",a[a.Y=2]="Y",a[a.X=3]="X",a[a.L=4]="L",a[a.R=5]="R",a[a.ZL=6]="ZL",a[a.ZR=7]="ZR",a[a.Minus=8]="Minus",a[a.Plus=9]="Plus",a[a.LS=10]="LS",a[a.RS=11]="RS",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.Capture=17]="Capture",a[a.LStickXAxis=18]="LStickXAxis",a[a.LStickYAxis=19]="LStickYAxis",a[a.RStickXAxis=20]="RStickXAxis",a[a.RStickYAxis=21]="RStickYAxis"})(SwitchInput||(SwitchInput={}));var DeviceInputEventType;(function(a){a[a.PointerMove=0]="PointerMove",a[a.PointerDown=1]="PointerDown",a[a.PointerUp=2]="PointerUp"})(DeviceInputEventType||(DeviceInputEventType={}));class EventConstants{}EventConstants.DOM_DELTA_PIXEL=0;EventConstants.DOM_DELTA_LINE=1;EventConstants.DOM_DELTA_PAGE=2;class DeviceEventFactory{static CreateDeviceEvent(e,t,i,r,s,n,o){switch(e){case DeviceType.Keyboard:return this._CreateKeyboardEvent(i,r,s,n);case DeviceType.Mouse:if(i===PointerInput.MouseWheelX||i===PointerInput.MouseWheelY||i===PointerInput.MouseWheelZ)return this._CreateWheelEvent(e,t,i,r,s,n);case DeviceType.Touch:return this._CreatePointerEvent(e,t,i,r,s,n,o);default:throw`Unable to generate event for device ${DeviceType[e]}`}}static _CreatePointerEvent(e,t,i,r,s,n,o){const l=this._CreateMouseEvent(e,t,i,r,s,n);return e===DeviceType.Mouse?(l.deviceType=DeviceType.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=DeviceType.Touch,l.pointerId=o??t,l.pointerType="touch"),i===PointerInput.Move?l.type="pointermove":i>=PointerInput.LeftClick&&i<=PointerInput.RightClick&&(l.type=r===1?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,r,s,n){const o=this._CreateMouseEvent(e,t,i,r,s,n);switch(o.pointerId=1,o.type="wheel",o.deltaMode=EventConstants.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case PointerInput.MouseWheelX:o.deltaX=r;break;case PointerInput.MouseWheelY:o.deltaY=r;break;case PointerInput.MouseWheelZ:o.deltaZ=r;break}return o}static _CreateMouseEvent(e,t,i,r,s,n){const o=this._CreateEvent(n),l=s.pollInput(e,t,PointerInput.Horizontal),h=s.pollInput(e,t,PointerInput.Vertical);return n?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-n.getBoundingClientRect().x,o.offsetY=o.movementY-n.getBoundingClientRect().y):(o.movementX=s.pollInput(e,t,NativePointerInput.DeltaHorizontal),o.movementY=s.pollInput(e,t,NativePointerInput.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,s),o.clientX=l,o.clientY=h,o.x=l,o.y=h,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,r){const s=this._CreateEvent(r);return this._CheckNonCharacterKeys(s,i),s.deviceType=DeviceType.Keyboard,s.deviceSlot=0,s.inputIndex=e,s.type=t===1?"keydown":"keyup",s.key=String.fromCharCode(e),s.keyCode=e,s}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(DeviceType.Keyboard),r=i&&t.pollInput(DeviceType.Keyboard,0,18)===1,s=i&&t.pollInput(DeviceType.Keyboard,0,17)===1,n=i&&(t.pollInput(DeviceType.Keyboard,0,91)===1||t.pollInput(DeviceType.Keyboard,0,92)===1||t.pollInput(DeviceType.Keyboard,0,93)===1),o=i&&t.pollInput(DeviceType.Keyboard,0,16)===1;e.altKey=r,e.ctrlKey=s,e.metaKey=n,e.shiftKey=o}static _CreateEvent(e){const t={};return t.preventDefault=()=>{},t.target=e,t}}class NativeDeviceInputSystem{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(r,s,n,o)=>{const l=DeviceEventFactory.CreateDeviceEvent(r,s,n,o,this);i(r,s,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===DeviceType.Mouse||e===DeviceType.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const MAX_KEYCODES=255,MAX_POINTER_INPUTS=Object.keys(PointerInput).length/2;class WebDeviceInputSystem{constructor(e,t,i,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=Tools.IsSafari(),this._usingMacOS=IsNavigatorAvailable()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=s=>{},this._keyboardUpEvent=s=>{},this._keyboardBlurEvent=s=>{},this._pointerMoveEvent=s=>{},this._pointerDownEvent=s=>{},this._pointerUpEvent=s=>{},this._pointerCancelEvent=s=>{},this._pointerWheelEvent=s=>{},this._pointerBlurEvent=s=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=DomManagement.IsNavigatorAvailable()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=s=>{},this._gamepadDisconnectedEvent=s=>{},this._eventPrefix=Tools.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=r,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const r=this._inputs[e][t];if(!r)throw`Unable to find device ${DeviceType[e]}`;e>=DeviceType.DualShock&&e<=DeviceType.DualSense&&this._updateDevice(e,t,i);const s=r[i];if(s===void 0)throw`Unable to find input ${i} for device ${DeviceType[e]} in slot ${t}`;return i===PointerInput.Move&&Tools.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),s}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=this===null||this===void 0?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(const t of this._inputs)if(t)for(const i in t){const r=+i,s=t[r];if(s)for(let n=0;n<s.length;n++)s[n]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(DeviceType.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,r){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,MAX_POINTER_INPUTS);const s=this._inputs[e][t];s[0]=i,s[1]=r}_registerDevice(e,t,i){if(t===void 0)throw`Unable to register device ${DeviceType[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const r=new Array(i);r.fill(0),this._inputs[e][t]=r,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(DeviceType.Keyboard,0,MAX_KEYCODES));const t=this._inputs[DeviceType.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&e.key!=="Meta"&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(DeviceType.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(DeviceType.Keyboard,0,MAX_KEYCODES));const t=this._inputs[DeviceType.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&e.key==="Meta"&&this._metaKeys.length>0){for(const r of this._metaKeys){const s=DeviceEventFactory.CreateDeviceEvent(DeviceType.Keyboard,0,r,0,this,this._elementToAttachTo);t[r]=0,this._onInputChanged(DeviceType.Keyboard,0,s)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(DeviceType.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[DeviceType.Keyboard][0];for(let t=0;t<e.length;t++)if(e[t]!==0){e[t]=0;const i=DeviceEventFactory.CreateDeviceEvent(DeviceType.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(DeviceType.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=DomManagement.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{const r=this._getPointerType(i),s=r===DeviceType.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);this._inputs[r]||(this._inputs[r]={}),this._inputs[r][s]||this._addPointerDevice(r,s,i.clientX,i.clientY);const n=this._inputs[r][s];if(n){const o=i;o.inputIndex=PointerInput.Move,n[PointerInput.Horizontal]=i.clientX,n[PointerInput.Vertical]=i.clientY,i.pointerId===void 0&&(i.pointerId=this._mouseId),this._onInputChanged(r,s,o),!this._usingSafari&&i.button!==-1&&(o.inputIndex=i.button+2,n[i.button+2]=n[i.button+2]?0:1,this._onInputChanged(r,s,o))}},this._pointerDownEvent=i=>{const r=this._getPointerType(i);let s=r===DeviceType.Mouse?0:i.pointerId;if(r===DeviceType.Touch){const o=this._activeTouchIds.indexOf(-1);if(o>=0)s=o,this._activeTouchIds[o]=i.pointerId;else{Tools.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[r]||(this._inputs[r]={}),this._inputs[r][s]?r===DeviceType.Touch&&this._onDeviceConnected(r,s):this._addPointerDevice(r,s,i.clientX,i.clientY);const n=this._inputs[r][s];if(n){const o=n[PointerInput.Horizontal],l=n[PointerInput.Vertical];if(r===DeviceType.Mouse){if(i.pointerId===void 0&&(i.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch{}n[PointerInput.Horizontal]=i.clientX,n[PointerInput.Vertical]=i.clientY,n[i.button+2]=1;const h=i;h.inputIndex=i.button+2,this._onInputChanged(r,s,h),(o!==i.clientX||l!==i.clientY)&&(h.inputIndex=PointerInput.Move,this._onInputChanged(r,s,h))}},this._pointerUpEvent=i=>{var r,s,n,o,l;const h=this._getPointerType(i),u=h===DeviceType.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(h===DeviceType.Touch){if(u===-1)return;this._activeTouchIds[u]=-1}const c=(r=this._inputs[h])===null||r===void 0?void 0:r[u];if(c&&c[i.button+2]!==0){const d=c[PointerInput.Horizontal],f=c[PointerInput.Vertical];c[PointerInput.Horizontal]=i.clientX,c[PointerInput.Vertical]=i.clientY,c[i.button+2]=0;const _=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),(d!==i.clientX||f!==i.clientY)&&(_.inputIndex=PointerInput.Move,this._onInputChanged(h,u,_)),_.inputIndex=i.button+2,h===DeviceType.Mouse&&this._mouseId>=0&&(!((n=(s=this._elementToAttachTo).hasPointerCapture)===null||n===void 0)&&n.call(s,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&(!((l=(o=this._elementToAttachTo).hasPointerCapture)===null||l===void 0)&&l.call(o,i.pointerId))&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(h,u,_),h===DeviceType.Touch&&this._onDeviceDisconnected(h,u)}},this._pointerCancelEvent=i=>{var r,s,n,o;if(i.pointerType==="mouse"){const l=this._inputs[DeviceType.Mouse][0];this._mouseId>=0&&(!((s=(r=this._elementToAttachTo).hasPointerCapture)===null||s===void 0)&&s.call(r,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let h=PointerInput.LeftClick;h<=PointerInput.BrowserForward;h++)if(l[h]===1){l[h]=0;const u=DeviceEventFactory.CreateDeviceEvent(DeviceType.Mouse,0,h,0,this,this._elementToAttachTo);this._onInputChanged(DeviceType.Mouse,0,u)}}else{const l=this._activeTouchIds.indexOf(i.pointerId);!((o=(n=this._elementToAttachTo).hasPointerCapture)===null||o===void 0)&&o.call(n,i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._inputs[DeviceType.Touch][l][PointerInput.LeftClick]=0;const h=DeviceEventFactory.CreateDeviceEvent(DeviceType.Touch,l,PointerInput.LeftClick,0,this,this._elementToAttachTo,i.pointerId);this._onInputChanged(DeviceType.Touch,l,h),this._activeTouchIds[l]=-1,this._onDeviceDisconnected(DeviceType.Touch,l)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch{}this._pointerBlurEvent=()=>{var i,r,s,n,o;if(this.isDeviceAvailable(DeviceType.Mouse)){const l=this._inputs[DeviceType.Mouse][0];this._mouseId>=0&&(!((r=(i=this._elementToAttachTo).hasPointerCapture)===null||r===void 0)&&r.call(i,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let h=PointerInput.LeftClick;h<=PointerInput.BrowserForward;h++)if(l[h]===1){l[h]=0;const u=DeviceEventFactory.CreateDeviceEvent(DeviceType.Mouse,0,h,0,this,this._elementToAttachTo);this._onInputChanged(DeviceType.Mouse,0,u)}}if(this.isDeviceAvailable(DeviceType.Touch)){const l=this._inputs[DeviceType.Touch];for(let h=0;h<this._activeTouchIds.length;h++){const u=this._activeTouchIds[h];if(!((n=(s=this._elementToAttachTo).hasPointerCapture)===null||n===void 0)&&n.call(s,u)&&this._elementToAttachTo.releasePointerCapture(u),u!==-1&&((o=l[h])===null||o===void 0?void 0:o[PointerInput.LeftClick])===1){l[h][PointerInput.LeftClick]=0;const c=DeviceEventFactory.CreateDeviceEvent(DeviceType.Touch,h,PointerInput.LeftClick,0,this,this._elementToAttachTo,u);this._onInputChanged(DeviceType.Touch,h,c),this._activeTouchIds[h]=-1,this._onDeviceDisconnected(DeviceType.Touch,h)}}}},this._pointerWheelEvent=i=>{const r=DeviceType.Mouse,s=0;this._inputs[r]||(this._inputs[r]=[]),this._inputs[r][s]||(this._pointerActive=!0,this._registerDevice(r,s,MAX_POINTER_INPUTS));const n=this._inputs[r][s];if(n){n[PointerInput.MouseWheelX]=i.deltaX||0,n[PointerInput.MouseWheelY]=i.deltaY||i.wheelDelta||0,n[PointerInput.MouseWheelZ]=i.deltaZ||0;const o=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),n[PointerInput.MouseWheelX]!==0&&(o.inputIndex=PointerInput.MouseWheelX,this._onInputChanged(r,s,o)),n[PointerInput.MouseWheelY]!==0&&(o.inputIndex=PointerInput.MouseWheelY,this._onInputChanged(r,s,o)),n[PointerInput.MouseWheelZ]!==0&&(o.inputIndex=PointerInput.MouseWheelZ,this._onInputChanged(r,s,o))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(DeviceType.Mouse)){const i=this._inputs[DeviceType.Mouse][0];i[PointerInput.MouseWheelX]=0,i[PointerInput.MouseWheelY]=0,i[PointerInput.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const r=navigator.getGamepads()[t];if(r&&e===this._gamepads[t]){const s=this._inputs[e][t];i>=r.buttons.length?s[i]=r.axes[i-r.buttons.length].valueOf():s[i]=r.buttons[i].value}}_getGamepadDeviceType(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?DeviceType.DualSense:DeviceType.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?DeviceType.Xbox:e.indexOf("057e")!==-1?DeviceType.Switch:DeviceType.Generic}_getPointerType(e){let t=DeviceType.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=DeviceType.Touch),t}}class DeviceSource{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new Observable,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class InternalDeviceSourceManager{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=n=>{for(let o=0;o<this._devices.length;o++){const l=this._devices[o];for(const h in l){const u=+h;n._addDevice(new DeviceSource(this._deviceInputSystem,o,u))}}this._registeredManagers.push(n)},this.unregisterManager=n=>{const o=this._registeredManagers.indexOf(n);o>-1&&this._registeredManagers.splice(o,1)};const t=Object.keys(DeviceType).length/2;this._devices=new Array(t);const i=(n,o)=>{this._devices[n]||(this._devices[n]=new Array),this._devices[n][o]||(this._devices[n][o]=o);for(const l of this._registeredManagers){const h=new DeviceSource(this._deviceInputSystem,n,o);l._addDevice(h)}},r=(n,o)=>{var l;!((l=this._devices[n])===null||l===void 0)&&l[o]&&delete this._devices[n][o];for(const h of this._registeredManagers)h._removeDevice(n,o)},s=(n,o,l)=>{if(l)for(const h of this._registeredManagers)h._onInputChanged(n,o,l)};typeof _native<"u"?this._deviceInputSystem=new NativeDeviceInputSystem(i,r,s):this._deviceInputSystem=new WebDeviceInputSystem(e,i,r,s)}dispose(){this._deviceInputSystem.dispose()}}class DeviceSourceManager{getDeviceSource(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}constructor(e){const t=Object.keys(DeviceType).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new InternalDeviceSourceManager(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new Observable(i=>{for(const r of this._devices)if(r)for(const s of r)s&&this.onDeviceConnectedObservable.notifyObserver(i,s)}),this.onDeviceDisconnectedObservable=new Observable,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var i,r;const s=(i=this._devices[e])===null||i===void 0?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(s),!((r=this._devices[e])===null||r===void 0)&&r[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var r,s;(s=(r=this._devices[e])===null||r===void 0?void 0:r[t])===null||s===void 0||s.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case DeviceType.Keyboard:case DeviceType.Mouse:this._firstDevice[e]=0;break;case DeviceType.Touch:case DeviceType.DualSense:case DeviceType.DualShock:case DeviceType.Xbox:case DeviceType.Switch:case DeviceType.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}break}}}}class _ClickInfo{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class InputManager{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new Vector2(0,0),this._previousStartingPointerPosition=new Vector2(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||EngineStore.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new Vector2(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,r=i.getEngine(),s=r.getInputElement();s&&(s.tabIndex=r.canvasTabIndex,i.doNotHandleCursors||(s.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const l of i._pointerMoveStage){e=e||this._pickMove(t);const h=!!(e!=null&&e.pickedMesh);e=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,h,s)}const n=t.inputIndex>=PointerInput.MouseWheelX&&t.inputIndex<=PointerInput.MouseWheelZ?PointerEventTypes.POINTERWHEEL:PointerEventTypes.POINTERMOVE;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,n));let o;e?(o=new PointerInfo(n,t,e),this._setRayOnPointerInfo(e,t)):(o=new PointerInfo(n,t,null,this),this._movePointerInfo=o),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(o,n)}_setRayOnPointerInfo(e,t){const i=this._scene;e&&i._pickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,Matrix.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const r=this._scene,s=new PointerInfoPre(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(s.originalPickingInfo=e,s.ray=e.ray,e.originMesh&&(s.nearInteractionPickingInfo=e)),r.onPrePointerObservable.notifyObservers(s,i),!!s.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,!1,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const s=i.getEngine().getInputElement();if(e!=null&&e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&s&&this._pointerOverMesh){const n=this._pointerOverMesh._getActionManagerForTrigger();n&&n.hasPointerTriggers&&(s.style.cursor=n.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=PointerInput.Move,!this._checkPrePointerObservable(e,i,PointerEventTypes.POINTERMOVE)&&this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,!this._checkPrePointerObservable(e,i,PointerEventTypes.POINTERDOWN)&&this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(e!=null&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;const n=e.pickedMesh._getActionManagerForTrigger();if(n){if(n.hasPickTriggers)switch(n.processTrigger(5,ActionEvent.CreateNew(e.pickedMesh,t)),t.button){case 0:n.processTrigger(2,ActionEvent.CreateNew(e.pickedMesh,t));break;case 1:n.processTrigger(4,ActionEvent.CreateNew(e.pickedMesh,t));break;case 2:n.processTrigger(3,ActionEvent.CreateNew(e.pickedMesh,t));break}n.hasSpecificTrigger(8)&&window.setTimeout(()=>{const o=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,l=>l.isPickable&&l.isVisible&&l.isReady()&&l.actionManager&&l.actionManager.hasSpecificTrigger(8)&&l===this._pickedDownMesh,!1,i.cameraToUseForPointers);o!=null&&o.pickedMesh&&n&&this._totalPointersPressed!==0&&Date.now()-this._startingPointerTime>InputManager.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,n.processTrigger(8,ActionEvent.CreateNew(o.pickedMesh,t)))},InputManager.LongPressDelay)}}else for(const n of i._pointerDownStage)e=n.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let r;const s=PointerEventTypes.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,s),r=new PointerInfo(s,t,e),this._setRayOnPointerInfo(e,t)):r=new PointerInfo(s,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(r,s)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const r=new PointerEvent("pointerup",t);r.inputIndex=PointerInput.Move;const s=new _ClickInfo;i?s.doubleClick=!0:s.singleClick=!0,!this._checkPrePointerObservable(e,r,PointerEventTypes.POINTERUP)&&this._processPointerUp(e,r,s)}_processPointerUp(e,t,i){const r=this._scene;if(e!=null&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(r.onPointerPick&&r.onPointerPick(t,e),i.singleClick&&!i.ignore&&r.onPointerObservable.observers.length>this._cameraObserverCount)){const n=PointerEventTypes.POINTERPICK,o=new PointerInfo(n,t,e);this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(o,n)}const s=e.pickedMesh._getActionManagerForTrigger();if(s&&!i.ignore){s.processTrigger(7,ActionEvent.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&s.processTrigger(1,ActionEvent.CreateNew(e.pickedMesh,t,e));const n=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&n&&n.processTrigger(6,ActionEvent.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const s of r._pointerUpStage)e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const s=this._pickedDownMesh._getActionManagerForTrigger(16);s&&s.processTrigger(16,ActionEvent.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){const s=new PointerInfo(PointerEventTypes.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(s,PointerEventTypes.POINTERUP),r.onPointerUp&&r.onPointerUp(t,e,PointerEventTypes.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let n=0;if(i.singleClick?n=PointerEventTypes.POINTERTAP:i.doubleClick&&(n=PointerEventTypes.POINTERDOUBLETAP),n){const o=new PointerInfo(n,t,e);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(n)&&r.onPointerObservable.notifyObservers(o,n)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,r=null){const s=this._scene,n=s.getEngine();r||(r=n.getInputElement()),this._alreadyAttached&&this.detachControl(),r&&(this._alreadyAttachedTo=r),this._deviceSourceManager=new DeviceSourceManager(n),this._initActionManager=o=>{if(!this._meshPickProceed){const l=s.skipPointerUpPicking||s._registeredActions===0&&!this._checkForPicking()&&!s.onPointerUp?null:s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,s.pointerUpPredicate,!1,s.cameraToUseForPointers);this._currentPickResult=l,l&&(o=l.hit&&l.pickedMesh?l.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return o},this._delayedSimpleClick=(o,l,h)=>{if((Date.now()-this._previousStartingPointerTime>InputManager.DoubleClickDelay&&!this._doubleClickOccured||o!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,l.singleClick=!0,l.ignore=!1,this._delayedClicks[o])){const u=this._delayedClicks[o].evt,c=PointerEventTypes.POINTERTAP,d=new PointerInfo(c,u,this._currentPickResult);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(c)&&s.onPointerObservable.notifyObservers(d,c),this._delayedClicks[o]=null}},this._initClickEvent=(o,l,h,u)=>{var c,d;const f=new _ClickInfo;this._currentPickResult=null;let _=null,g=o.hasSpecificMask(PointerEventTypes.POINTERPICK)||l.hasSpecificMask(PointerEventTypes.POINTERPICK)||o.hasSpecificMask(PointerEventTypes.POINTERTAP)||l.hasSpecificMask(PointerEventTypes.POINTERTAP)||o.hasSpecificMask(PointerEventTypes.POINTERDOUBLETAP)||l.hasSpecificMask(PointerEventTypes.POINTERDOUBLETAP);!g&&AbstractActionManager&&(_=this._initActionManager(_,f),_&&(g=_.hasPickTriggers));let p=!1;if(g){const m=h.button;if(f.hasSwiped=this._isPointerSwiping(),!f.hasSwiped){let E=!InputManager.ExclusiveDoubleClickMode;if(E||(E=!o.hasSpecificMask(PointerEventTypes.POINTERDOUBLETAP)&&!l.hasSpecificMask(PointerEventTypes.POINTERDOUBLETAP),E&&!AbstractActionManager.HasSpecificTrigger(6)&&(_=this._initActionManager(_,f),_&&(E=!_.hasSpecificTrigger(6)))),E)(Date.now()-this._previousStartingPointerTime>InputManager.DoubleClickDelay||m!==this._previousButtonPressed)&&(f.singleClick=!0,u(f,this._currentPickResult),p=!0);else{const x={evt:h,clickInfo:f,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,m,f,u),InputManager.DoubleClickDelay)};this._delayedClicks[m]=x}let M=o.hasSpecificMask(PointerEventTypes.POINTERDOUBLETAP)||l.hasSpecificMask(PointerEventTypes.POINTERDOUBLETAP);!M&&AbstractActionManager.HasSpecificTrigger(6)&&(_=this._initActionManager(_,f),_&&(M=_.hasSpecificTrigger(6))),M&&(m===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<InputManager.DoubleClickDelay&&!this._doubleClickOccured?(!f.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,f.doubleClick=!0,f.ignore=!1,InputManager.ExclusiveDoubleClickMode&&this._delayedClicks[m]&&(clearTimeout((c=this._delayedClicks[m])===null||c===void 0?void 0:c.timeoutId),this._delayedClicks[m]=null),u(f,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=m,InputManager.ExclusiveDoubleClickMode?(this._delayedClicks[m]&&(clearTimeout((d=this._delayedClicks[m])===null||d===void 0?void 0:d.timeoutId),this._delayedClicks[m]=null),u(f,this._previousPickResult)):u(f,this._currentPickResult)),p=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=m))}}p||u(f,this._currentPickResult)},this._onPointerMove=o=>{if(this._updatePointerPosition(o),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>InputManager.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>InputManager.DragMovementThreshold),n.isPointerLock&&n._verifyPointerLock(),this._checkPrePointerObservable(null,o,o.inputIndex>=PointerInput.MouseWheelX&&o.inputIndex<=PointerInput.MouseWheelZ?PointerEventTypes.POINTERWHEEL:PointerEventTypes.POINTERMOVE)||!s.cameraToUseForPointers&&!s.activeCamera)return;if(s.skipPointerMovePicking){this._processPointerMove(new PickingInfo,o);return}s.pointerMovePredicate||(s.pointerMovePredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(h.enablePointerMoveEvents||s.constantlyUpdateMeshUnderPointer||h._getActionManagerForTrigger()!==null)&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&h.layerMask)!==0));const l=s._registeredActions>0||s.constantlyUpdateMeshUnderPointer?this._pickMove(o):null;this._processPointerMove(l,o)},this._onPointerDown=o=>{var l;if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,InputManager.ExclusiveDoubleClickMode){for(let u=0;u<this._delayedClicks.length;u++)if(this._delayedClicks[u])if(o.button===u)clearTimeout((l=this._delayedClicks[u])===null||l===void 0?void 0:l.timeoutId);else{const c=this._delayedClicks[u].clickInfo;this._doubleClickOccured=!1,c.singleClick=!0,c.ignore=!1;const d=this._delayedClicks[u].evt,f=PointerEventTypes.POINTERTAP,_=new PointerInfo(f,d,this._currentPickResult);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(f)&&s.onPointerObservable.notifyObservers(_,f),this._delayedClicks[u]=null}}if(this._updatePointerPosition(o),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=o.button),s.preventDefaultOnPointerDown&&r&&(o.preventDefault(),r.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,o,PointerEventTypes.POINTERDOWN)||!s.cameraToUseForPointers&&!s.activeCamera)return;this._pointerCaptures[o.pointerId]=!0,s.pointerDownPredicate||(s.pointerDownPredicate=u=>u.isPickable&&u.isVisible&&u.isReady()&&u.isEnabled()&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&u.layerMask)!==0)),this._pickedDownMesh=null;let h;s.skipPointerDownPicking||s._registeredActions===0&&!this._checkForPicking()&&!s.onPointerDown?h=new PickingInfo:h=s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,s.pointerDownPredicate,!1,s.cameraToUseForPointers),this._processPointerDown(h,o)},this._onPointerUp=o=>{this._totalPointersPressed!==0&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(o),s.preventDefaultOnPointerUp&&r&&(o.preventDefault(),r.focus()),this._initClickEvent(s.onPrePointerObservable,s.onPointerObservable,o,(l,h)=>{if(s.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!l.ignore)){if(this._checkPrePointerObservable(null,o,PointerEventTypes.POINTERUP)){this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}l.hasSwiped||(l.singleClick&&s.onPrePointerObservable.hasSpecificMask(PointerEventTypes.POINTERTAP)&&this._checkPrePointerObservable(null,o,PointerEventTypes.POINTERTAP)&&(this._skipPointerTap=!0),l.doubleClick&&s.onPrePointerObservable.hasSpecificMask(PointerEventTypes.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,o,PointerEventTypes.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}if(!this._pointerCaptures[o.pointerId]){this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}o.buttons===0&&(this._pointerCaptures[o.pointerId]=!1),!(!s.cameraToUseForPointers&&!s.activeCamera)&&(s.pointerUpPredicate||(s.pointerUpPredicate=u=>u.isPickable&&u.isVisible&&u.isReady()&&u.isEnabled()&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&u.layerMask)!==0)),!this._meshPickProceed&&(AbstractActionManager&&AbstractActionManager.HasTriggers||this._checkForPicking()||s.onPointerUp)&&this._initActionManager(null,l),h||(h=this._currentPickResult),this._processPointerUp(h,o,l),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=o=>{const l=KeyboardEventTypes.KEYDOWN;if(s.onPreKeyboardObservable.hasObservers()){const h=new KeyboardInfoPre(l,o);if(s.onPreKeyboardObservable.notifyObservers(h,l),h.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){const h=new KeyboardInfo(l,o);s.onKeyboardObservable.notifyObservers(h,l)}s.actionManager&&s.actionManager.processTrigger(14,ActionEvent.CreateNewFromScene(s,o))},this._onKeyUp=o=>{const l=KeyboardEventTypes.KEYUP;if(s.onPreKeyboardObservable.hasObservers()){const h=new KeyboardInfoPre(l,o);if(s.onPreKeyboardObservable.notifyObservers(h,l),h.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){const h=new KeyboardInfo(l,o);s.onKeyboardObservable.notifyObservers(h,l)}s.actionManager&&s.actionManager.processTrigger(15,ActionEvent.CreateNewFromScene(s,o))},this._deviceSourceManager.onDeviceConnectedObservable.add(o=>{o.deviceType===DeviceType.Mouse?o.onInputChangedObservable.add(l=>{l.inputIndex===PointerInput.LeftClick||l.inputIndex===PointerInput.MiddleClick||l.inputIndex===PointerInput.RightClick||l.inputIndex===PointerInput.BrowserBack||l.inputIndex===PointerInput.BrowserForward?t&&o.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&o.getInput(l.inputIndex)===0&&this._onPointerUp(l):i&&(l.inputIndex===PointerInput.Move?this._onPointerMove(l):(l.inputIndex===PointerInput.MouseWheelX||l.inputIndex===PointerInput.MouseWheelY||l.inputIndex===PointerInput.MouseWheelZ)&&this._onPointerMove(l))}):o.deviceType===DeviceType.Touch?o.onInputChangedObservable.add(l=>{l.inputIndex===PointerInput.LeftClick&&(t&&o.getInput(l.inputIndex)===1?(this._onPointerDown(l),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):e&&o.getInput(l.inputIndex)===0&&(this._onPointerUp(l),this._totalPointersPressed===0&&(this._isMultiTouchGesture=!1))),i&&l.inputIndex===PointerInput.Move&&this._onPointerMove(l)}):o.deviceType===DeviceType.Keyboard&&o.onInputChangedObservable.add(l=>{l.type==="keydown"?this._onKeyDown(l):l.type==="keyup"&&this._onKeyUp(l)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,r){if(this._meshUnderPointerId[t]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const s=this._meshUnderPointerId[t];let n;s&&(n=s._getActionManagerForTrigger(10),n&&n.processTrigger(10,ActionEvent.CreateNew(s,r,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,n=e._getActionManagerForTrigger(9),n&&n.processTrigger(9,ActionEvent.CreateNew(e,r,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}InputManager.DragMovementThreshold=10;InputManager.LongPressDelay=500;InputManager.DoubleClickDelay=300;InputManager.ExclusiveDoubleClickMode=!1;class PerfCounter{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){PerfCounter.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){PerfCounter.Enabled&&(this._startMonitoringTime=PrecisionDate.Now)}endMonitoring(e=!0){if(!PerfCounter.Enabled)return;e&&this.fetchNewFrame();const t=PrecisionDate.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=PrecisionDate.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}PerfCounter.Enabled=!0;class Plane{constructor(e,t,i,r){this.normal=new Vector3(e,t,i),this.d=r}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new Plane(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=Plane._TmpMatrix;e.invertToRef(t);const i=t.m,r=this.normal.x,s=this.normal.y,n=this.normal.z,o=this.d,l=r*i[0]+s*i[1]+n*i[2]+o*i[3],h=r*i[4]+s*i[5]+n*i[6]+o*i[7],u=r*i[8]+s*i[9]+n*i[10]+o*i[11],c=r*i[12]+s*i[13]+n*i[14]+o*i[15];return new Plane(l,h,u,c)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const r=t.x-e.x,s=t.y-e.y,n=t.z-e.z,o=i.x-e.x,l=i.y-e.y,h=i.z-e.z,u=s*h-n*l,c=n*o-r*h,d=r*l-s*o,f=Math.sqrt(u*u+c*c+d*d);let _;return f!==0?_=1/f:_=0,this.normal.x=u*_,this.normal.y=c*_,this.normal.z=d*_,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return Vector3.Dot(this.normal,e)<=t}signedDistanceTo(e){return Vector3.Dot(e,this.normal)+this.d}static FromArray(e){return new Plane(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const r=new Plane(0,0,0,0);return r.copyFromPoints(e,t,i),r}static FromPositionAndNormal(e,t){const i=new Plane(0,0,0,0);return t.normalize(),i.normal=t,i.d=-(t.x*e.x+t.y*e.y+t.z*e.z),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const r=-(t.x*e.x+t.y*e.y+t.z*e.z);return Vector3.Dot(i,t)+r}}Plane._TmpMatrix=Matrix.Identity();class Frustum{static GetPlanes(e){const t=[];for(let i=0;i<6;i++)t.push(new Plane(0,0,0,0));return Frustum.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){Frustum.GetNearPlaneToRef(e,t[0]),Frustum.GetFarPlaneToRef(e,t[1]),Frustum.GetLeftPlaneToRef(e,t[2]),Frustum.GetRightPlaneToRef(e,t[3]),Frustum.GetTopPlaneToRef(e,t[4]),Frustum.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}class UniqueIdGenerator{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}UniqueIdGenerator._UniqueIdCounter=1;class LightConstants{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}LightConstants.FALLOFF_DEFAULT=0;LightConstants.FALLOFF_PHYSICAL=1;LightConstants.FALLOFF_GLTF=2;LightConstants.FALLOFF_STANDARD=3;LightConstants.LIGHTMAP_DEFAULT=0;LightConstants.LIGHTMAP_SPECULAR=1;LightConstants.LIGHTMAP_SHADOWSONLY=2;LightConstants.INTENSITYMODE_AUTOMATIC=0;LightConstants.INTENSITYMODE_LUMINOUSPOWER=1;LightConstants.INTENSITYMODE_LUMINOUSINTENSITY=2;LightConstants.INTENSITYMODE_ILLUMINANCE=3;LightConstants.INTENSITYMODE_LUMINANCE=4;LightConstants.LIGHTTYPEID_POINTLIGHT=0;LightConstants.LIGHTTYPEID_DIRECTIONALLIGHT=1;LightConstants.LIGHTTYPEID_SPOTLIGHT=2;LightConstants.LIGHTTYPEID_HEMISPHERICLIGHT=3;var ScenePerformancePriority;(function(a){a[a.BackwardCompatible=0]="BackwardCompatible",a[a.Intermediate=1]="Intermediate",a[a.Aggressive=2]="Aggressive"})(ScenePerformancePriority||(ScenePerformancePriority={}));class Scene extends AbstractScene{static DefaultMaterialFactory(e){throw _WarnImport("StandardMaterial")}static CollisionCoordinatorFactory(){throw _WarnImport("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case ScenePerformancePriority.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case ScenePerformancePriority.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case ScenePerformancePriority.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return InputManager.DragMovementThreshold}static set DragMovementThreshold(e){InputManager.DragMovementThreshold=e}static get LongPressDelay(){return InputManager.LongPressDelay}static set LongPressDelay(e){InputManager.LongPressDelay=e}static get DoubleClickDelay(){return InputManager.DoubleClickDelay}static set DoubleClickDelay(e){InputManager.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return InputManager.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){InputManager.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){var r;const s=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:(r=this.activeCamera.globalPosition)!==null&&r!==void 0?r:this.activeCamera.devicePosition,n=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return TmpVectors.Vector4[0].set(s.x,s.y,s.z,n?-1:1),e&&(i?e.setFloat3(t,TmpVectors.Vector4[0].x,TmpVectors.Vector4[0].y,TmpVectors.Vector4[0].z):e.setVector4(t,TmpVectors.Vector4[0])),TmpVectors.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=_ObserveArray(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=Scene.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=Scene.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}constructor(e,t){super(),this._inputManager=new InputManager(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new Color4(.2,.2,.3,1),this.ambientColor=new Color3(0,0,0),this.environmentIntensity=1,this._performancePriority=ScenePerformancePriority.BackwardCompatible,this.onScenePerformancePriorityChangedObservable=new Observable,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=new Array,this.onDisposeObservable=new Observable,this._onDisposeObserver=null,this.onBeforeRenderObservable=new Observable,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new Observable,this.onAfterRenderCameraObservable=new Observable,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new Observable,this.onAfterAnimationsObservable=new Observable,this.onBeforeDrawPhaseObservable=new Observable,this.onAfterDrawPhaseObservable=new Observable,this.onReadyObservable=new Observable,this.onBeforeCameraRenderObservable=new Observable,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new Observable,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new Observable,this.onAfterActiveMeshesEvaluationObservable=new Observable,this.onBeforeParticlesRenderingObservable=new Observable,this.onAfterParticlesRenderingObservable=new Observable,this.onDataLoadedObservable=new Observable,this.onNewCameraAddedObservable=new Observable,this.onCameraRemovedObservable=new Observable,this.onNewLightAddedObservable=new Observable,this.onLightRemovedObservable=new Observable,this.onNewGeometryAddedObservable=new Observable,this.onGeometryRemovedObservable=new Observable,this.onNewTransformNodeAddedObservable=new Observable,this.onTransformNodeRemovedObservable=new Observable,this.onNewMeshAddedObservable=new Observable,this.onMeshRemovedObservable=new Observable,this.onNewSkeletonAddedObservable=new Observable,this.onSkeletonRemovedObservable=new Observable,this.onNewMaterialAddedObservable=new Observable,this.onNewMultiMaterialAddedObservable=new Observable,this.onMaterialRemovedObservable=new Observable,this.onMultiMaterialRemovedObservable=new Observable,this.onNewTextureAddedObservable=new Observable,this.onTextureRemovedObservable=new Observable,this.onBeforeRenderTargetsRenderObservable=new Observable,this.onAfterRenderTargetsRenderObservable=new Observable,this.onBeforeStepObservable=new Observable,this.onAfterStepObservable=new Observable,this.onActiveCameraChanged=new Observable,this.onActiveCamerasChanged=new Observable,this.onBeforeRenderingGroupObservable=new Observable,this.onAfterRenderingGroupObservable=new Observable,this.onMeshImportedObservable=new Observable,this.onAnimationFileImportedObservable=new Observable,this._registeredForLateAnimationBindings=new SmartArrayNoDuplicate(256),this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1,this.onPrePointerObservable=new Observable,this.onPointerObservable=new Observable,this.onPreKeyboardObservable=new Observable,this.onKeyboardObservable=new Observable,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=Scene.FOGMODE_NONE,this.fogColor=new Color3(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new Vector3(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this._meshesForIntersections=new SmartArrayNoDuplicate(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new PerfCounter,this._activeIndices=new PerfCounter,this._activeParticles=new PerfCounter,this._activeBones=new PerfCounter,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new SmartArray(256),this._processedMaterials=new SmartArray(256),this._renderTargets=new SmartArrayNoDuplicate(256),this._materialsRenderTargets=new SmartArrayNoDuplicate(256),this._activeParticleSystems=new SmartArray(256),this._activeSkeletons=new SmartArrayNoDuplicate(32),this._softwareSkinnedMeshes=new SmartArrayNoDuplicate(32),this._activeAnimatables=new Array,this._transformMatrix=Matrix.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=Stage.Create(),this._beforeClearStage=Stage.Create(),this._beforeRenderTargetClearStage=Stage.Create(),this._gatherRenderTargetsStage=Stage.Create(),this._gatherActiveCameraRenderTargetsStage=Stage.Create(),this._isReadyForMeshStage=Stage.Create(),this._beforeEvaluateActiveMeshStage=Stage.Create(),this._evaluateSubMeshStage=Stage.Create(),this._preActiveMeshStage=Stage.Create(),this._cameraDrawRenderTargetStage=Stage.Create(),this._beforeCameraDrawStage=Stage.Create(),this._beforeRenderTargetDrawStage=Stage.Create(),this._beforeRenderingGroupDrawStage=Stage.Create(),this._beforeRenderingMeshStage=Stage.Create(),this._afterRenderingMeshStage=Stage.Create(),this._afterRenderingGroupDrawStage=Stage.Create(),this._afterCameraDrawStage=Stage.Create(),this._afterCameraPostProcessStage=Stage.Create(),this._afterRenderTargetDrawStage=Stage.Create(),this._afterRenderTargetPostProcessStage=Stage.Create(),this._afterRenderStage=Stage.Create(),this._pointerMoveStage=Stage.Create(),this._pointerDownStage=Stage.Create(),this._pointerUpStage=Stage.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=new Array;const i=Object.assign({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},t);this._engine=e||EngineStore.LastCreatedEngine,i.virtual?this._engine._virtualScenes.push(this):(EngineStore._LastCreatedScene=this,this._engine.scenes.push(this)),this._uid=null,this._renderingManager=new RenderingManager(this),PostProcessManager&&(this.postProcessManager=new PostProcessManager(this)),IsWindowObjectExist()&&this.attachControl(),this._createUbo(),ImageProcessingConfiguration&&(this._imageProcessingConfiguration=new ImageProcessingConfiguration),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,(!t||!t.virtual)&&this._engine.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){var t,i,r;if(this._isDisposed)return!1;let s;const n=this.getEngine(),o=n.currentRenderPassId;n.currentRenderPassId=(i=(t=this.activeCamera)===null||t===void 0?void 0:t.renderPassId)!==null&&i!==void 0?i:o;let l=!0;for(this._pendingData.length>0&&(l=!1),(r=this.prePassRenderer)===null||r===void 0||r.update(),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),s=0;s<this.meshes.length;s++){const h=this.meshes[s];if(!h.subMeshes||h.subMeshes.length===0)continue;if(!h.isReady(!0)){l=!1;continue}const u=h.hasThinInstances||h.getClassName()==="InstancedMesh"||h.getClassName()==="InstancedLinesMesh"||n.getCaps().instancedArrays&&h.instances.length>0;for(const d of this._isReadyForMeshStage)d.action(h,u)||(l=!1);if(!e)continue;const c=h.material||this.defaultMaterial;if(c)if(c._storeEffectOnSubMeshes)for(const d of h.subMeshes){const f=d.getMaterial();f&&f.hasRenderTargetTextures&&f.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(f)===-1&&(this._processedMaterials.push(f),this._materialsRenderTargets.concatWithNoDuplicate(f.getRenderTargetTextures()))}else c.hasRenderTargetTextures&&c.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(c)===-1&&(this._processedMaterials.push(c),this._materialsRenderTargets.concatWithNoDuplicate(c.getRenderTargetTextures()))}if(e)for(s=0;s<this._materialsRenderTargets.length;++s)this._materialsRenderTargets.data[s].isReadyForRendering()||(l=!1);for(s=0;s<this.geometries.length;s++)this.geometries[s].delayLoadState===2&&(l=!1);if(this.activeCameras&&this.activeCameras.length>0)for(const h of this.activeCameras)h.isReady(!0)||(l=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(l=!1));for(const h of this.particleSystems)h.isReady()||(l=!1);if(this.layers)for(const h of this.layers)h.isReady()||(l=!1);return n.areAllEffectsReady()||(l=!1),n.currentRenderPassId=o,l}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){t!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);i!==-1&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=PrecisionDate.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,r){!i&&!r&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Frustum.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,r):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new UniformBuffer(this._engine,void 0,!1,e??"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return UniqueIdGenerator.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(i=>{this.addMesh(i)}))}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);return i!==-1&&(this.meshes[i]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(r=>{this.removeMesh(r)}),i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(t!==-1){if(t!==this.transformNodes.length-1){const i=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=i,i._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return t!==-1&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return t!==-1&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(t!==-1){for(const i of this.meshes)i._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(t!==-1&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const i=this.activeCameras.indexOf(e);i!==-1&&this.activeCameras.splice(i,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return t!==-1&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return t!==-1&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return t!==-1&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return t!==-1&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(t!==-1&&t<this.materials.length){if(t!==this.materials.length-1){const i=this.materials[this.materials.length-1];this.materials[t]=i,i._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return t!==-1&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return t!==-1&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)t.lightSources.indexOf(e)===-1&&(t.lightSources.push(e),t._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(LightConstants.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let i=0;i<this.materials.length;i++){const r=this.materials[i];if(t(r))return r}if(e)for(let i=0;i<this.multiMaterials.length;i++){const r=this.multiMaterials[i];if(t(r))return r}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,i=>i.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,i=>i.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,i=>i.name===e)}getLastMaterialById(e,t=!1){for(let i=this.materials.length-1;i>=0;i--)if(this.materials[i].id===e)return this.materials[i];if(t){for(let i=this.multiMaterials.length-1;i>=0;i--)if(this.multiMaterials[i].id===e)return this.multiMaterials[i]}return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let r=0;r<i.bones.length;r++)if(i.bones[r].id===e)return i.bones[r]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let r=0;r<i.bones.length;r++)if(i.bones[r].name===e)return i.bones[r]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(t!==void 0)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!t&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],t===void 0)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const i=this.geometries[this.geometries.length-1];i&&(this.geometries[t]=i,this._geometriesByUniqueId&&(this._geometriesByUniqueId[i.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const r=this.getLightById(e);if(r)return r;const s=this.getCameraById(e);if(s)return s;const n=this.getBoneById(e);return n||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const r=this.getLightByName(e);if(r)return r;const s=this.getCameraByName(e);if(s)return s;const n=this.getBoneByName(e);return n||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let r=0;r<i.numTargets;++r){const s=i.getTarget(r);if(s.id===e)return s}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let r=0;r<i.numTargets;++r){const s=i.getTarget(r);if(s.name===e)return s}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||(this._uid=Tools.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new StringDictionary),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new StringDictionary),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,r){if(r||e.isInFrustum(this._frustumPlanes)){for(const n of this._evaluateSubMeshStage)n.action(t,e);const s=e.getMaterial();s!=null&&(s.hasRenderTargetTextures&&s.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(s)===-1&&(this._processedMaterials.push(s),this._materialsRenderTargets.concatWithNoDuplicate(s.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,s))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,r=!0,s=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){i&&i("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=s,this._skipEvaluateActiveMeshesCompletely=e,r)for(let n=0;n<this._activeMeshes.length;n++)this._activeMeshes.data[n]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((e=this.activeCamera)===null||e===void 0||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const r=this._activeMeshes.length;for(let s=0;s<r;s++)this._activeMeshes.data[s].computeWorldMatrix()}if(this._activeParticleSystems){const r=this._activeParticleSystems.length;for(let s=0;s<r;s++)this._activeParticleSystems.data[s].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const r of this._beforeEvaluateActiveMeshStage)r.action();const t=this.getActiveMeshCandidates(),i=t.length;for(let r=0;r<i;r++){const s=t.data[r];if(s._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,s.isBlocked||(this._totalVertices.addCount(s.getTotalVertices(),!1),!s.isReady()||!s.isEnabled()||s.scaling.hasAZeroComponent))continue;s.computeWorldMatrix(),s.actionManager&&s.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(s);let n=this.customLODSelector?this.customLODSelector(s,this.activeCamera):s.getLOD(this.activeCamera);if(s._internalAbstractMeshDataInfo._currentLOD=n,s._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,n!=null&&(n!==s&&n.billboardMode!==0&&n.computeWorldMatrix(),s._preActivate(),s.isVisible&&s.visibility>0&&s.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||s.alwaysSelectAsActiveMesh||s.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(s),this.activeCamera._activeMeshes.push(s),n!==s&&n._activate(this._renderId,!1);for(const o of this._preActiveMeshStage)o.action(s);s._activate(this._renderId,!1)&&(s.isAnInstance?s._internalAbstractMeshDataInfo._actAsRegularMesh&&(n=s):n._internalAbstractMeshDataInfo._onlyForInstances=!1,n._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(s,n)),s._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let r=0;r<this.particleSystems.length;r++){const s=this.particleSystems[r];if(!s.isStarted()||!s.emitter)continue;const n=s.emitter;(!n.position||n.isEnabled())&&(this._activeParticleSystems.push(s),s.animate(),this._renderingManager.dispatchParticles(s))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,t){this._skeletonsEnabled&&t.skeleton!==null&&t.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t));let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const r=this.getActiveSubMeshCandidates(t),s=r.length;i=i||s===1;for(let n=0;n<s;n++){const o=r.data[n];this._evaluateSubMesh(o,t,e,i)}}}updateTransformMatrix(e){if(this.activeCamera)if(this.activeCamera._renderingMultiview){const t=this.activeCamera._rigCameras[0],i=this.activeCamera._rigCameras[1];this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e),i.getViewMatrix(),i.getProjectionMatrix(e))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||(this.autoClear&&this._engine.clear(t.clearColor||this.clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){var r,s,n;if(e&&e._skipRendering)return;const o=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(o.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let h=!0;e._renderingMultiview&&e.outputRenderTarget&&(h=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=h)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let h=0;h<this._softwareSkinnedMeshes.length;h++){const u=this._softwareSkinnedMeshes.data[h];u.applySkeleton(u.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const h of this._gatherActiveCameraRenderTargetsStage)h.action(this._renderTargets);let l=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){Tools.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let h=0;h<this._renderTargets.length;h++){const u=this._renderTargets.data[h];if(u._shouldRender()){this._renderId++;const c=u.activeCamera&&u.activeCamera!==this.activeCamera;u.render(c,this.dumpNextRenderTargets),l=!0}}Tools.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const h of this._cameraDrawRenderTargetStage)l=h.action(this.activeCamera)||l;this._intermediateRendering=!1}this._engine.currentRenderPassId=(n=(s=(r=e.outputRenderTarget)===null||r===void 0?void 0:r.renderPassId)!==null&&s!==void 0?s:e.renderPassId)!==null&&n!==void 0?n:0,l&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(const h of this._beforeCameraDrawStage)h.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),o.snapshotRendering&&o.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const h of this._afterCameraDrawStage)h.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const h=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,h)}for(const h of this._afterCameraPostProcessStage)h.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let i=0;t.actionManager&&i<t.actionManager.actions.length;i++){const r=t.actionManager.actions[i];if(r.trigger===12||r.trigger===13){const s=r.getTriggerParameter(),n=s.mesh?s.mesh:s,o=n.intersectsMesh(t,s.usePreciseIntersection),l=t._intersectionsInProgress.indexOf(n);o&&l===-1?r.trigger===12?(r._executeCurrent(ActionEvent.CreateNew(t,void 0,n)),t._intersectionsInProgress.push(n)):r.trigger===13&&t._intersectionsInProgress.push(n):!o&&l>-1&&(r.trigger===13&&r._executeCurrent(ActionEvent.CreateNew(t,void 0,n)),(!t.actionManager.hasSpecificTrigger(13,h=>{const u=h.mesh?h.mesh:h;return n===u})||r.trigger===13)&&t._intersectionsInProgress.splice(l,1))}}}}_advancePhysicsEngineStep(e){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(Scene.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Scene.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let r=0;const s=this._engine.getLockstepMaxSteps();let n=Math.floor(e/t);for(n=Math.min(n,s);e>0&&r<n;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,r++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(Scene.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Scene.MaxDeltaTime));this._animationRatio=e*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if(e!=null&&e.outputRenderTarget&&!(e!=null&&e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),!((t=e==null?void 0:e.rigCameras)===null||t===void 0)&&t.length)for(let i=0;i<e.rigCameras.length;++i){const r=e.rigCameras[i].outputRenderTarget;r&&(r._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}render(e=!0,t=!1){var i,r,s;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!((i=this.activeCameras)===null||i===void 0)&&i.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const l of this._beforeCameraUpdateStage)l.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let l=0;l<this.activeCameras.length;l++){const h=this.activeCameras[l];if(h.update(),h.cameraRigMode!==0)for(let u=0;u<h._rigCameras.length;u++)h._rigCameras[u].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let l=0;l<this.activeCamera._rigCameras.length;l++)this.activeCamera._rigCameras[l].update()}this.onBeforeRenderObservable.notifyObservers(this);const n=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const o=!((r=this.activeCameras)===null||r===void 0)&&r.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){Tools.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let l=0;l<this.customRenderTargets.length;l++){const h=this.customRenderTargets[l];if(h._shouldRender()){if(this._renderId++,this.activeCamera=h.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");n.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),h.render(o!==this.activeCamera,this.dumpNextRenderTargets)}}Tools.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(s=o==null?void 0:o.renderPassId)!==null&&s!==void 0?s:0,this.activeCamera=o,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const l of this._beforeClearStage)l.action();this._clearFrameBuffer(this.activeCamera);for(const l of this._gatherRenderTargetsStage)l.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let l=0;l<this.activeCameras.length;l++)this._processSubCameras(this.activeCameras[l],l>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(const l of this._afterRenderStage)l.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let l=0;l<this._toBeDisposed.length;l++){const h=this._toBeDisposed[l];h&&h.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const s of e)s.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(s){console.error("An error occurred while calling onDisposeObservable!",s)}if(this.detachControl(),this._engine.getInputElement())for(let s=0;s<this.cameras.length;s++)this.cameras[s].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,s=>s.dispose(!0)),this._disposeList(this.transformNodes,s=>s.dispose(!0));const i=this.cameras;this._disposeList(i),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let r=this._engine.scenes.indexOf(this);r>-1&&this._engine.scenes.splice(r,1),EngineStore._LastCreatedScene===this&&(this._engine.scenes.length>0?EngineStore._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:EngineStore._LastCreatedScene=null),r=this._engine._virtualScenes.indexOf(this),r>-1&&this._engine._virtualScenes.splice(r,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=t??(r=>r.dispose());for(const r of i)t(r);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const i=this.meshes[e].geometry;i&&i.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach(r=>{if(r.computeWorldMatrix(!0),!r.subMeshes||r.subMeshes.length===0||r.infiniteDistance)return;const s=r.getBoundingInfo(),n=s.boundingBox.minimumWorld,o=s.boundingBox.maximumWorld;Vector3.CheckExtends(n,t,i),Vector3.CheckExtends(o,t,i)}),{min:t,max:i}}createPickingRay(e,t,i,r,s=!1){throw _WarnImport("Ray")}createPickingRayToRef(e,t,i,r,s,n=!1,o=!1){throw _WarnImport("Ray")}createPickingRayInCameraSpace(e,t,i){throw _WarnImport("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,r){throw _WarnImport("Ray")}get _pickingAvailable(){return!1}pick(e,t,i,r,s,n){return new PickingInfo}pickWithBoundingInfo(e,t,i,r,s){return new PickingInfo}pickWithRay(e,t,i,r){throw _WarnImport("Ray")}multiPick(e,t,i,r,s){throw _WarnImport("Ray")}multiPickWithRay(e,t,i){throw _WarnImport("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(t===void 0)return e;const r=[];i=i||(s=>{});for(const s in e){const n=e[s];Tags&&Tags.MatchesQuery(n,t)&&(r.push(n),i(n))}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,r)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,r,s,n,o){const l=LoadFile(e,t,i,r?this.offlineProvider:void 0,s,n,o);return this._activeRequests.push(l),l.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),l}_loadFileAsync(e,t,i,r,s){return new Promise((n,o)=>{this._loadFile(e,l=>{n(l)},t,i,r,(l,h)=>{o(h)},s)})}_requestFile(e,t,i,r,s,n,o){const l=RequestFile(e,t,i,r?this.offlineProvider:void 0,s,n,o);return this._activeRequests.push(l),l.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),l}_requestFileAsync(e,t,i,r,s){return new Promise((n,o)=>{this._requestFile(e,l=>{n(l)},t,i,r,l=>{o(l)},s)})}_readFile(e,t,i,r,s){const n=ReadFile(e,t,i,r,s);return this._activeRequests.push(n),n.onCompleteObservable.add(o=>{this._activeRequests.splice(this._activeRequests.indexOf(o),1)}),n}_readFileAsync(e,t,i){return new Promise((r,s)=>{this._readFile(e,n=>{r(n)},t,i,n=>{s(n)})})}getPerfCollector(){throw _WarnImport("performanceViewerSceneExtension")}}Scene.FOGMODE_NONE=0;Scene.FOGMODE_EXP=1;Scene.FOGMODE_EXP2=2;Scene.FOGMODE_LINEAR=3;Scene.MinDeltaTime=1;Scene.MaxDeltaTime=1e3;Scene.prototype.setActiveCameraByID=function(a){return this.setActiveCameraById(a)};Scene.prototype.getLastMaterialByID=function(a){return this.getLastMaterialById(a)};Scene.prototype.getMaterialByID=function(a){return this.getMaterialById(a)};Scene.prototype.getTextureByUniqueID=function(a){return this.getTextureByUniqueId(a)};Scene.prototype.getCameraByID=function(a){return this.getCameraById(a)};Scene.prototype.getCameraByUniqueID=function(a){return this.getCameraByUniqueId(a)};Scene.prototype.getBoneByID=function(a){return this.getBoneById(a)};Scene.prototype.getLightByID=function(a){return this.getLightById(a)};Scene.prototype.getLightByUniqueID=function(a){return this.getLightByUniqueId(a)};Scene.prototype.getParticleSystemByID=function(a){return this.getParticleSystemById(a)};Scene.prototype.getGeometryByID=function(a){return this.getGeometryById(a)};Scene.prototype.getMeshByID=function(a){return this.getMeshById(a)};Scene.prototype.getMeshesByID=function(a){return this.getMeshesById(a)};Scene.prototype.getTransformNodeByID=function(a){return this.getTransformNodeById(a)};Scene.prototype.getTransformNodeByUniqueID=function(a){return this.getTransformNodeByUniqueId(a)};Scene.prototype.getTransformNodesByID=function(a){return this.getTransformNodesById(a)};Scene.prototype.getMeshByUniqueID=function(a){return this.getMeshByUniqueId(a)};Scene.prototype.getLastMeshByID=function(a){return this.getLastMeshById(a)};Scene.prototype.getLastEntryByID=function(a){return this.getLastEntryById(a)};Scene.prototype.getNodeByID=function(a){return this.getNodeById(a)};Scene.prototype.getLastSkeletonByID=function(a){return this.getLastSkeletonById(a)};class _InternalNodeDataInfo{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new Observable,this._onClonedObservable=new Observable}}class Node{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,r){const s=this._NodeConstructors[e];return s?s(t,i,r):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){const i=this._parentNode._children.indexOf(this);i!==-1&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null){this._isDirty=!1,this._nodeDataStorage=new _InternalNodeDataInfo,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new Observable,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=Matrix.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new Observable,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||EngineStore.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){const t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,t=!1,i){if(this._children)for(let r=0;r<this._children.length;r++){const s=this._children[r];(!i||i(s))&&e.push(s),t||s._getDescendants(e,!1,i)}}getDescendants(e,t){const i=new Array;return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r.cullingStrategy!==void 0),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=Node._AnimationRangeFactory(e,t,i);for(let r=0,s=this.animations.length;r<s;r++)this.animations[r]&&this.animations[r].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.animations.length;i<r;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){const r=SerializationHelper.Clone(()=>new Node(e,this.getScene()),this);if(t&&(r.parent=t),!i){const s=this.getDescendants(!0);for(let n=0;n<s.length;n++){const o=s[n];o.clone(e+"."+o.name,r)}}return r}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,r){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,r):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const r={};r.name=t,r.from=i.from,r.to=i.to,e.push(r)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=Matrix.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const r of i)r.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let r=0;r<t.ranges.length;r++){const s=t.ranges[r];e.createAnimationRange(s.name,s.from,s.to)}}getHierarchyBoundingVectors(e=!0,t=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let i,r;const s=this;if(s.getBoundingInfo&&s.subMeshes){const n=s.getBoundingInfo();i=n.boundingBox.minimumWorld.clone(),r=n.boundingBox.maximumWorld.clone()}else i=new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const n=this.getDescendants(!1);for(const o of n){const l=o;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||l.getTotalVertices()===0)continue;const u=l.getBoundingInfo().boundingBox,c=u.minimumWorld,d=u.maximumWorld;Vector3.CheckExtends(c,i,r),Vector3.CheckExtends(d,i,r)}}return{min:i,max:r}}}Node._AnimationRangeFactory=(a,e,t)=>{throw _WarnImport("AnimationRange")};Node._NodeConstructors={};__decorate([serialize()],Node.prototype,"name",void 0);__decorate([serialize()],Node.prototype,"id",void 0);__decorate([serialize()],Node.prototype,"uniqueId",void 0);__decorate([serialize()],Node.prototype,"state",void 0);__decorate([serialize()],Node.prototype,"metadata",void 0);class Viewport{constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}toGlobal(e,t){return new Viewport(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new Viewport(this.x,this.y,this.width,this.height)}}class Camera extends Node{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,t,i,r;let s=0,n=0;if(this.mode===Camera.PERSPECTIVE_CAMERA)this.fovMode===Camera.FOVMODE_VERTICAL_FIXED?(n=this.minZ*2*Math.tan(this.fov/2),s=this.getEngine().getAspectRatio(this)*n):(s=this.minZ*2*Math.tan(this.fov/2),n=s/this.getEngine().getAspectRatio(this));else{const o=this.getEngine().getRenderWidth()/2,l=this.getEngine().getRenderHeight()/2;s=((e=this.orthoRight)!==null&&e!==void 0?e:o)-((t=this.orthoLeft)!==null&&t!==void 0?t:-o),n=((i=this.orthoTop)!==null&&i!==void 0?i:l)-((r=this.orthoBottom)!==null&&r!==void 0?r:-l)}return s*n}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}constructor(e,t,i,r=!0){super(e,i),this._position=Vector3.Zero(),this._upVector=Vector3.Up(),this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=Camera.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Viewport(0,0,1,1),this.layerMask=268435455,this.fovMode=Camera.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=Camera.RIG_MODE_NONE,this.customRenderTargets=new Array,this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new Observable,this.onProjectionMatrixChangedObservable=new Observable,this.onAfterCheckInputsObservable=new Observable,this.onRestoreStateObservable=new Observable,this.isRigCamera=!1,this._rigCameras=new Array,this._webvrViewMatrix=Matrix.Identity(),this._skipRendering=!1,this._projectionMatrix=new Matrix,this._postProcesses=new Array,this._activeMeshes=new SmartArray(256),this._globalPosition=Vector3.Zero(),this._computedViewMatrix=Matrix.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=Matrix.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=Quaternion.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),r&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(const t of this._postProcesses)if(t&&!t.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===Camera.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),e}attachControl(e,t){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==Camera.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){const r=this._rigCameras[t],s=r._rigPostProcess;s?(s.getEffectName()==="pass"&&(r.isIntermediate=this._postProcesses.length===0),r._postProcesses=this._postProcesses.slice(0).concat(s),s.markTextureDirty()):r._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(Logger.Error("You're trying to reuse a post process not defined as reusable."),0):(t==null||t<0?this._postProcesses.push(e):this._postProcesses[t]===null?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return Matrix.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var t,i,r,s,n,o,l,h;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const u=this.getEngine(),c=this.getScene(),d=u.useReverseDepthBuffer;if(this.mode===Camera.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=u.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let f;c.useRightHandedSystem?f=Matrix.PerspectiveFovRHToRef:f=Matrix.PerspectiveFovLHToRef,f(this.fov,u.getAspectRatio(this),d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===Camera.FOVMODE_VERTICAL_FIXED,u.isNDCHalfZRange,this.projectionPlaneTilt,d)}else{const f=u.getRenderWidth()/2,_=u.getRenderHeight()/2;c.useRightHandedSystem?Matrix.OrthoOffCenterRHToRef((t=this.orthoLeft)!==null&&t!==void 0?t:-f,(i=this.orthoRight)!==null&&i!==void 0?i:f,(r=this.orthoBottom)!==null&&r!==void 0?r:-_,(s=this.orthoTop)!==null&&s!==void 0?s:_,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,u.isNDCHalfZRange):Matrix.OrthoOffCenterLHToRef((n=this.orthoLeft)!==null&&n!==void 0?n:-f,(o=this.orthoRight)!==null&&o!==void 0?o:f,(l=this.orthoBottom)!==null&&l!==void 0?l:-_,(h=this.orthoTop)!==null&&h!==void 0?h:_,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,u.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=u.getRenderWidth(),this._cache.renderHeight=u.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Frustum.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach(r=>{r._updateFrustumPlanes(),i=i||e.isInFrustum(r._frustumPlanes)}),i}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw _WarnImport("Ray")}getForwardRayToRef(e,t=100,i,r){throw _WarnImport("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const r=this._rigCameras.pop();r&&r.dispose()}if(this._parentContainer){const r=this._parentContainer.cameras.indexOf(this);r>-1&&this._parentContainer.cameras.splice(r,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==Camera.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let r=this._postProcesses.length;for(;--r>=0;){const s=this._postProcesses[r];s&&s.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=Tools.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==Camera.RIG_MODE_NONE){const i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);const r=this.createRigCamera(this.name+"_R",1);r&&(r._isRightCamera=!0),i&&r&&(this._rigCameras.push(i),this._rigCameras.push(r))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return Matrix.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}_updateCameraRotationMatrix(){}_updateWebVRCameraRotationMatrix(){}_getWebVRProjectionMatrix(){return Matrix.Identity()}_getWebVRViewMatrix(){return Matrix.Identity()}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=Tools.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=SerializationHelper.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),SerializationHelper.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=SerializationHelper.Clone(Camera.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=Vector3.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){Vector3.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,r=0,s=!0){const n=Node.Construct(e,t,i,{interaxial_distance:r,isStereoscopicSideBySide:s});return n||(()=>Camera._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,r=Camera.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),s=SerializationHelper.Parse(r,e,t);if(e.parentId!==void 0&&(s._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s.inputs&&(s.inputs.parse(e),s._setupInputs()),e.upVector&&(s.upVector=Vector3.FromArray(e.upVector)),s.setPosition&&(s.position.copyFromFloats(0,0,0),s.setPosition(Vector3.FromArray(e.position))),e.target&&s.setTarget&&s.setTarget(Vector3.FromArray(e.target)),e.cameraRigMode){const n=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};s.setCameraRigMode(e.cameraRigMode,n)}if(e.animations){for(let n=0;n<e.animations.length;n++){const o=e.animations[n],l=GetClass("BABYLON.Animation");l&&s.animations.push(l.Parse(o))}Node.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&s.setEnabled(e.isEnabled),s}}Camera._CreateDefaultParsedCamera=(a,e)=>{throw _WarnImport("UniversalCamera")};Camera.PERSPECTIVE_CAMERA=0;Camera.ORTHOGRAPHIC_CAMERA=1;Camera.FOVMODE_VERTICAL_FIXED=0;Camera.FOVMODE_HORIZONTAL_FIXED=1;Camera.RIG_MODE_NONE=0;Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;Camera.RIG_MODE_STEREOSCOPIC_INTERLACED=14;Camera.RIG_MODE_VR=20;Camera.RIG_MODE_WEBVR=21;Camera.RIG_MODE_CUSTOM=22;Camera.ForceAttachControlToAlwaysPreventDefault=!1;__decorate([serializeAsVector3("position")],Camera.prototype,"_position",void 0);__decorate([serializeAsVector3("upVector")],Camera.prototype,"_upVector",void 0);__decorate([serialize()],Camera.prototype,"orthoLeft",null);__decorate([serialize()],Camera.prototype,"orthoRight",null);__decorate([serialize()],Camera.prototype,"orthoBottom",null);__decorate([serialize()],Camera.prototype,"orthoTop",null);__decorate([serialize()],Camera.prototype,"fov",void 0);__decorate([serialize()],Camera.prototype,"projectionPlaneTilt",void 0);__decorate([serialize()],Camera.prototype,"minZ",void 0);__decorate([serialize()],Camera.prototype,"maxZ",void 0);__decorate([serialize()],Camera.prototype,"inertia",void 0);__decorate([serialize()],Camera.prototype,"mode",null);__decorate([serialize()],Camera.prototype,"layerMask",void 0);__decorate([serialize()],Camera.prototype,"fovMode",void 0);__decorate([serialize()],Camera.prototype,"cameraRigMode",void 0);__decorate([serialize()],Camera.prototype,"interaxialDistance",void 0);__decorate([serialize()],Camera.prototype,"isStereoscopicSideBySide",void 0);class Ray{constructor(e,t,i=Number.MAX_VALUE){this.origin=e,this.direction=t,this.length=i}clone(){return new Ray(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const r=Ray._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),s=Ray._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let n=0,o=Number.MAX_VALUE,l,h,u,c;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<r.x||this.origin.x>s.x)return!1}else if(l=1/this.direction.x,h=(r.x-this.origin.x)*l,u=(s.x-this.origin.x)*l,u===-1/0&&(u=1/0),h>u&&(c=h,h=u,u=c),n=Math.max(h,n),o=Math.min(u,o),n>o)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<r.y||this.origin.y>s.y)return!1}else if(l=1/this.direction.y,h=(r.y-this.origin.y)*l,u=(s.y-this.origin.y)*l,u===-1/0&&(u=1/0),h>u&&(c=h,h=u,u=c),n=Math.max(h,n),o=Math.min(u,o),n>o)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<r.z||this.origin.z>s.z)return!1}else if(l=1/this.direction.z,h=(r.z-this.origin.z)*l,u=(s.z-this.origin.z)*l,u===-1/0&&(u=1/0),h>u&&(c=h,h=u,u=c),n=Math.max(h,n),o=Math.min(u,o),n>o)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,s=e.center.z-this.origin.z,n=i*i+r*r+s*s,o=e.radius+t,l=o*o;if(n<=l)return!0;const h=i*this.direction.x+r*this.direction.y+s*this.direction.z;return h<0?!1:n-h*h<=l}intersectsTriangle(e,t,i){const r=Ray._TmpVector3[0],s=Ray._TmpVector3[1],n=Ray._TmpVector3[2],o=Ray._TmpVector3[3],l=Ray._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,s),Vector3.CrossToRef(this.direction,s,n);const h=Vector3.Dot(r,n);if(h===0)return null;const u=1/h;this.origin.subtractToRef(e,o);const c=Vector3.Dot(o,n)*u;if(c<0||c>1)return null;Vector3.CrossToRef(o,r,l);const d=Vector3.Dot(this.direction,l)*u;if(d<0||c+d>1)return null;const f=Vector3.Dot(s,l)*u;return f>this.length?null:new IntersectionInfo(1-c-d,c,f)}intersectsPlane(e){let t;const i=Vector3.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{const r=Vector3.Dot(e.normal,this.origin);return t=(-e.d-r)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const i=(this.origin.y-t)/this.direction.y;return i>0?null:new Vector3(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{const i=(this.origin.x-t)/this.direction.x;return i>0?null:new Vector3(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{const i=(this.origin.z-t)/this.direction.z;return i>0?null:new Vector3(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t,i,r=!1,s,n=!1){const o=TmpVectors.Matrix[0];return e.getWorldMatrix().invertToRef(o),this._tmpRay?Ray.TransformToRef(this,o,this._tmpRay):this._tmpRay=Ray.Transform(this,o),e.intersects(this._tmpRay,t,i,r,s,n)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){const s=this.intersectsMesh(e[r],t);s.hit&&i.push(s)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const r=this.origin,s=TmpVectors.Vector3[0],n=TmpVectors.Vector3[1],o=TmpVectors.Vector3[2],l=TmpVectors.Vector3[3];t.subtractToRef(e,s),this.direction.scaleToRef(Ray._Rayl,o),r.addToRef(o,n),e.subtractToRef(r,l);const h=Vector3.Dot(s,s),u=Vector3.Dot(s,o),c=Vector3.Dot(o,o),d=Vector3.Dot(s,l),f=Vector3.Dot(o,l),_=h*c-u*u;let g,p=_,m,E=_;_<Ray._Smallnum?(g=0,p=1,m=f,E=c):(g=u*f-c*d,m=h*f-u*d,g<0?(g=0,m=f,E=c):g>p&&(g=p,m=f+u,E=c)),m<0?(m=0,-d<0?g=0:-d>h?g=p:(g=-d,p=h)):m>E&&(m=E,-d+u<0?g=0:-d+u>h?g=p:(g=-d+u,p=h));const M=Math.abs(g)<Ray._Smallnum?0:g/p,x=Math.abs(m)<Ray._Smallnum?0:m/E,A=TmpVectors.Vector3[4];o.scaleToRef(x,A);const T=TmpVectors.Vector3[5];s.scaleToRef(M,T),T.addInPlace(l);const C=TmpVectors.Vector3[6];return T.subtractToRef(A,C),x>0&&x<=this.length&&C.lengthSquared()<i*i?T.length():-1}update(e,t,i,r,s,n,o,l=!1){if(l){Ray._RayDistant||(Ray._RayDistant=Ray.Zero()),Ray._RayDistant.unprojectRayToRef(e,t,i,r,Matrix.IdentityReadOnly,n,o);const h=TmpVectors.Matrix[0];s.invertToRef(h),Ray.TransformToRef(Ray._RayDistant,h,this)}else this.unprojectRayToRef(e,t,i,r,s,n,o);return this}static Zero(){return new Ray(Vector3.Zero(),Vector3.Zero())}static CreateNew(e,t,i,r,s,n,o){return Ray.Zero().update(e,t,i,r,s,n,o)}static CreateNewFromTo(e,t,i=Matrix.IdentityReadOnly){const r=t.subtract(e),s=Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);return r.normalize(),Ray.Transform(new Ray(e,r,s),i)}static Transform(e,t){const i=new Ray(new Vector3(0,0,0),new Vector3(0,0,0));return Ray.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){Vector3.TransformCoordinatesToRef(e.origin,t,i.origin),Vector3.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;const r=i.direction,s=r.length();if(!(s===0||s===1)){const n=1/s;r.x*=n,r.y*=n,r.z*=n,i.length*=s}}unprojectRayToRef(e,t,i,r,s,n,o){var l;const h=TmpVectors.Matrix[0];s.multiplyToRef(n,h),h.multiplyToRef(o,h),h.invert();const u=TmpVectors.Vector3[0];u.x=e/i*2-1,u.y=-(t/r*2-1),u.z=!((l=EngineStore.LastCreatedEngine)===null||l===void 0)&&l.isNDCHalfZRange?0:-1;const c=TmpVectors.Vector3[1].copyFromFloats(u.x,u.y,1-1e-8),d=TmpVectors.Vector3[2],f=TmpVectors.Vector3[3];Vector3._UnprojectFromInvertedMatrixToRef(u,h,d),Vector3._UnprojectFromInvertedMatrixToRef(c,h,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}}Ray._TmpVector3=ArrayTools.BuildArray(6,Vector3.Zero);Ray._RayDistant=Ray.Zero();Ray._Smallnum=1e-8;Ray._Rayl=1e9;Scene.prototype.createPickingRay=function(a,e,t,i,r=!1){const s=Ray.Zero();return this.createPickingRayToRef(a,e,t,s,i,r),s};Scene.prototype.createPickingRayToRef=function(a,e,t,i,r,s=!1,n=!1){const o=this.getEngine();if(!r){if(!this.activeCamera)return this;r=this.activeCamera}const h=r.viewport.toGlobal(o.getRenderWidth(),o.getRenderHeight());return a=a/o.getHardwareScalingLevel()-h.x,e=e/o.getHardwareScalingLevel()-(o.getRenderHeight()-h.y-h.height),i.update(a,e,h.width,h.height,t||Matrix.IdentityReadOnly,s?Matrix.IdentityReadOnly:r.getViewMatrix(),r.getProjectionMatrix(),n),this};Scene.prototype.createPickingRayInCameraSpace=function(a,e,t){const i=Ray.Zero();return this.createPickingRayInCameraSpaceToRef(a,e,i,t),i};Scene.prototype.createPickingRayInCameraSpaceToRef=function(a,e,t,i){if(!PickingInfo)return this;const r=this.getEngine();if(!i){if(!this.activeCamera)throw new Error("Active camera not set");i=this.activeCamera}const n=i.viewport.toGlobal(r.getRenderWidth(),r.getRenderHeight()),o=Matrix.Identity();return a=a/r.getHardwareScalingLevel()-n.x,e=e/r.getHardwareScalingLevel()-(r.getRenderHeight()-n.y-n.height),t.update(a,e,n.width,n.height,o,o,i.getProjectionMatrix()),this};Scene.prototype._internalPickForMesh=function(a,e,t,i,r,s,n,o){const l=e(i,t.enableDistantPicking),h=t.intersects(l,r,n,s,i,o);return!h||!h.hit||!r&&a!=null&&h.distance>=a.distance?null:h};Scene.prototype._internalPick=function(a,e,t,i,r){let s=null;const n=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),o=this.cameraToUseForPointers||this.activeCamera;for(let l=0;l<this.meshes.length;l++){const h=this.meshes[l];if(e){if(!e(h))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;const u=n&&h.isWorldMatrixCameraDependent(),c=h.computeWorldMatrix(u,o);if(h.hasThinInstances&&h.thinInstanceEnablePicking){const d=this._internalPickForMesh(s,a,h,c,!0,!0,r);if(d){if(i)return d;const f=TmpVectors.Matrix[1],_=h.thinInstanceGetWorldMatrices();for(let g=0;g<_.length;g++){_[g].multiplyToRef(c,f);const m=this._internalPickForMesh(s,a,h,f,t,i,r,!0);if(m&&(s=m,s.thinInstanceIndex=g,t))return s}}}else{const d=this._internalPickForMesh(s,a,h,c,t,i,r);if(d&&(s=d,t))return s}}return s||new PickingInfo};Scene.prototype._internalMultiPick=function(a,e,t){if(!PickingInfo)return null;const i=new Array,r=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),s=this.cameraToUseForPointers||this.activeCamera;for(let n=0;n<this.meshes.length;n++){const o=this.meshes[n];if(e){if(!e(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;const l=r&&o.isWorldMatrixCameraDependent(),h=o.computeWorldMatrix(l,s);if(o.hasThinInstances&&o.thinInstanceEnablePicking){if(this._internalPickForMesh(null,a,o,h,!0,!0,t)){const c=TmpVectors.Matrix[1],d=o.thinInstanceGetWorldMatrices();for(let f=0;f<d.length;f++){d[f].multiplyToRef(h,c);const g=this._internalPickForMesh(null,a,o,c,!1,!1,t,!0);g&&(g.thinInstanceIndex=f,i.push(g))}}}else{const u=this._internalPickForMesh(null,a,o,h,!1,!1,t);u&&i.push(u)}}return i};Scene.prototype.pickWithBoundingInfo=function(a,e,t,i,r){if(!PickingInfo)return null;const s=this._internalPick(n=>(this._tempPickingRay||(this._tempPickingRay=Ray.Zero()),this.createPickingRayToRef(a,e,n,this._tempPickingRay,r||null),this._tempPickingRay),t,i,!0);return s&&(s.ray=this.createPickingRay(a,e,Matrix.Identity(),r||null)),s};Object.defineProperty(Scene.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1});Scene.prototype.pick=function(a,e,t,i,r,s,n=!1){const o=this._internalPick((l,h)=>(this._tempPickingRay||(this._tempPickingRay=Ray.Zero()),this.createPickingRayToRef(a,e,l,this._tempPickingRay,r||null,!1,h),this._tempPickingRay),t,i,!1,s);return o&&(o.ray=this.createPickingRay(a,e,Matrix.Identity(),r||null)),o};Scene.prototype.pickWithRay=function(a,e,t,i){const r=this._internalPick(s=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=Matrix.Identity()),s.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=Ray.Zero()),Ray.TransformToRef(a,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t,!1,i);return r&&(r.ray=a),r};Scene.prototype.multiPick=function(a,e,t,i,r){return this._internalMultiPick(s=>this.createPickingRay(a,e,s,i||null),t,r)};Scene.prototype.multiPickWithRay=function(a,e,t){return this._internalMultiPick(i=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=Matrix.Identity()),i.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=Ray.Zero()),Ray.TransformToRef(a,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t)};Camera.prototype.getForwardRay=function(a=100,e,t){return this.getForwardRayToRef(new Ray(Vector3.Zero(),Vector3.Zero(),a),a,e,t)};Camera.prototype.getForwardRayToRef=function(a,e=100,t,i){return t||(t=this.getWorldMatrix()),a.length=e,i?a.origin.copyFrom(i):a.origin.copyFrom(this.position),TmpVectors.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),Vector3.TransformNormalToRef(TmpVectors.Vector3[2],t,TmpVectors.Vector3[3]),Vector3.NormalizeToRef(TmpVectors.Vector3[3],a.direction),a};var Space;(function(a){a[a.LOCAL=0]="LOCAL",a[a.WORLD=1]="WORLD",a[a.BONE=2]="BONE"})(Space||(Space={}));class Axis{}Axis.X=new Vector3(1,0,0);Axis.Y=new Vector3(0,1,0);Axis.Z=new Vector3(0,0,1);var Coordinate;(function(a){a[a.X=0]="X",a[a.Y=1]="Y",a[a.Z=2]="Z"})(Coordinate||(Coordinate={}));class PerformanceMonitor{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new RollingAverage(e)}sampleFrame(e=PrecisionDate.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class RollingAverage{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}ThinEngine.prototype.setAlphaConstants=function(a,e,t,i){this._alphaState.setAlphaBlendConstants(a,e,t,i)};ThinEngine.prototype.setAlphaMode=function(a,e=!1){if(this._alphaMode===a){if(!e){const t=a===0;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}return}switch(a){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=a===0),this._alphaMode=a};ThinEngine.prototype.getAlphaMode=function(){return this._alphaMode};ThinEngine.prototype.setAlphaEquation=function(a){if(this._alphaEquation!==a){switch(a){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=a}};ThinEngine.prototype.getAlphaEquation=function(){return this._alphaEquation};function allocateAndCopyTypedBuffer(a,e,t=!1,i){switch(a){case 3:{const s=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return i&&s.set(new Int8Array(i)),s}case 0:{const s=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&s.set(new Uint8Array(i)),s}case 4:{const s=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&s.set(new Int16Array(i)),s}case 5:case 8:case 9:case 10:case 2:{const s=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&s.set(new Uint16Array(i)),s}case 6:{const s=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&s.set(new Int32Array(i)),s}case 7:case 11:case 12:case 13:case 14:case 15:{const s=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&s.set(new Uint32Array(i)),s}case 1:{const s=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&s.set(new Float32Array(i)),s}}const r=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&r.set(new Uint8Array(i)),r}ThinEngine.prototype._readTexturePixelsSync=function(a,e,t,i=-1,r=0,s=null,n=!0,o=!1,l=0,h=0){var u,c;const d=this._gl;if(!d)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const _=d.createFramebuffer();if(!_)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=_}d.bindFramebuffer(d.FRAMEBUFFER,this._dummyFramebuffer),i>-1?d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+i,(u=a._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,r):d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,(c=a._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,r);let f=a.type!==void 0?this._getWebGLTextureType(a.type):d.UNSIGNED_BYTE;if(o)s||(s=allocateAndCopyTypedBuffer(a.type,4*e*t));else switch(f){case d.UNSIGNED_BYTE:s||(s=new Uint8Array(4*e*t)),f=d.UNSIGNED_BYTE;break;default:s||(s=new Float32Array(4*e*t)),f=d.FLOAT;break}return n&&this.flushFramebuffer(),d.readPixels(l,h,e,t,d.RGBA,f,s),d.bindFramebuffer(d.FRAMEBUFFER,this._currentFramebuffer),s};ThinEngine.prototype._readTexturePixels=function(a,e,t,i=-1,r=0,s=null,n=!0,o=!1,l=0,h=0){return Promise.resolve(this._readTexturePixelsSync(a,e,t,i,r,s,n,o,l,h))};ThinEngine.prototype.updateDynamicIndexBuffer=function(a,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(a);let i;a.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};ThinEngine.prototype.updateDynamicVertexBuffer=function(a,e,t,i){this.bindArrayBuffer(a),t===void 0&&(t=0);const r=e.byteLength||e.length;i===void 0||i>=r&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e instanceof ArrayBuffer?e=new Uint8Array(e,t,i):e=new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};class Engine extends ThinEngine{static get NpmPackage(){return ThinEngine.NpmPackage}static get Version(){return ThinEngine.Version}static get Instances(){return EngineStore.Instances}static get LastCreatedEngine(){return EngineStore.LastCreatedEngine}static get LastCreatedScene(){return EngineStore.LastCreatedScene}_createImageBitmapFromSource(e,t){return new Promise((r,s)=>{const n=new Image;n.onload=()=>{n.decode().then(()=>{this.createImageBitmap(n,t).then(o=>{r(o)})})},n.onerror=()=>{s(`Error loading image ${n.src}`)},n.src=e})}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){const s=this.createCanvas(t,i).getContext("2d");if(!s)throw new Error("Unable to get 2d context for resizeImageBitmap");return s.drawImage(e,0,0),s.getImageData(0,0,t,i).data}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<Engine.Instances.length;i++){const r=Engine.Instances[i];for(let s=0;s<r.scenes.length;s++)r.scenes[s].markAllMaterialsAsDirty(e,t)}}static DefaultLoadingScreenFactory(e){throw _WarnImport("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!Engine._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(e,t,i,r=!1){if(super(e,t,i,r),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=new Array,this._virtualScenes=new Array,this.onNewSceneAddedObservable=new Observable,this.postProcesses=new Array,this.isPointerLock=!1,this.onResizeObservable=new Observable,this.onCanvasBlurObservable=new Observable,this.onCanvasFocusObservable=new Observable,this.onCanvasPointerOutObservable=new Observable,this.onBeginFrameObservable=new Observable,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new Observable,this.onBeforeShaderCompilationObservable=new Observable,this.onAfterShaderCompilationObservable=new Observable,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new PerfCounter,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new PerformanceMonitor,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],Engine.Instances.push(this),!!e){if(this._features.supportRenderPasses=!0,i=this._creationOptions,e.getContext){const s=e;this._sharedInit(s),this._connectVREvents()}this._prepareVRComponent(),i.autoEnableWebVR&&this.initWebVR()}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=i=>{this.disableContextMenu&&i.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=i=>{document.elementFromPoint(i.clientX,i.clientY)!==e&&this.onCanvasPointerOutObservable.notifyObservers(i)};const t=this.getHostWindow();t&&typeof t.addEventListener=="function"&&(t.addEventListener("blur",this._onBlur),t.addEventListener("focus",this._onFocus)),e.addEventListener("pointerout",this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!Engine.audioEngine&&this._creationOptions.audioEngine&&Engine.AudioEngineFactory&&(Engine.audioEngine=Engine.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),IsDocumentAvailable()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&e&&Engine._RequestPointerlock(e)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)),this.enableOfflineSupport=Engine.OfflineProviderFactory!==void 0,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}_verifyPointerLock(){var e;(e=this._onPointerLockChange)===null||e===void 0||e.call(this)}getAspectRatio(e,t=!1){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}generateMipMapsForCubemap(e,t=!0){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,t,i,r){const s=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,r),s}scissorClear(e,t,i,r,s){this.enableScissor(e,t,i,r),this.clear(s,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,r){const s=this._gl;s.enable(s.SCISSOR_TEST),s.scissor(e,t,i,r)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}initWebVR(){throw _WarnImport("WebVRCamera")}_prepareVRComponent(){}_connectVREvents(e,t){}_submitVRFrame(){}disableVR(){}isVRPresenting(){return!1}_requestVRFrame(){}_loadFileAsync(e,t,i){return new Promise((r,s)=>{this._loadFile(e,n=>{r(n)},void 0,t,i,(n,o)=>{s(o)})})}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}setDepthStencilTexture(e,t,i,r){e!==void 0&&(t&&(this._boundUniforms[e]=t),!i||!i.depthStencilTexture?this._setTexture(e,null,void 0,void 0,r):this._setTexture(e,i,!1,!0,r))}setTextureFromPostProcess(e,t,i){var r;let s=null;t&&(t._forcedOutputTexture?s=t._forcedOutputTexture:t._textures.data[t._currentRenderTextureInd]&&(s=t._textures.data[t._currentRenderTextureInd])),this._bindTexture(e,(r=s==null?void 0:s.texture)!==null&&r!==void 0?r:null,i)}setTextureFromPostProcessOutput(e,t,i){var r,s;this._bindTexture(e,(s=(r=t==null?void 0:t._outputTexture)===null||r===void 0?void 0:r.texture)!==null&&s!==void 0?s:null,i)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){const t=this._activeRenderLoops[e];t()}}_renderLoop(){if(!this._contextWasLost){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&Engine._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&Engine._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&Engine._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){Engine._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}resize(e=!1){this.isVRPresenting()||super.resize(e)}setSize(e,t,i=!1){if(!this._renderingCanvas||!super.setSize(e,t,i))return!1;if(this.scenes){for(let r=0;r<this.scenes.length;r++){const s=this.scenes[r];for(let n=0;n<s.cameras.length;n++){const o=s.cameras[n];o._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,r,s,n=null){s=s||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const o=super.createShaderProgram(e,t,i,r,s,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}_createShaderProgram(e,t,i,r,s=null){const n=r.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");if(r.attachShader(n,t),r.attachShader(n,i),this.webGLVersion>1&&s){const o=this.createTransformFeedback();this.bindTransformFeedback(o),this.setTranformFeedbackVaryings(n,s),e.transformFeedback=o}return r.linkProgram(n),this.webGLVersion>1&&s&&this.bindTransformFeedback(null),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(t=>{t.postProcesses.forEach(i=>{i._outputTexture===e&&(i._outputTexture=null)}),t.cameras.forEach(i=>{i._postProcesses.forEach(r=>{r&&r._outputTexture===e&&(r._outputTexture=null)})})})}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(e){const t=++Engine._RenderPassIdCounter;return this._renderPassNames[t]=e??"NONAME",t}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let r=0;r<i.meshes.length;++r){const s=i.meshes[r];if(s.subMeshes)for(let n=0;n<s.subMeshes.length;++n)s.subMeshes[n]._removeDrawWrapper(e)}}}_rescaleTexture(e,t,i,r,s){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const n=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&Engine._RescalePostProcessFactory&&(this._rescalePostProcess=Engine._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(l){l._bindTexture("textureSampler",e)};let o=i;o||(o=this.scenes[this.scenes.length-1]),o.postProcessManager.directRender([this._rescalePostProcess],n,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,r,0,0,t.width,t.height,0),this.unBindFramebuffer(n),n.dispose(),s&&s()}))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e,t=!1,i=3){const r=new WebGLHardwareTexture(e,this._gl),s=new InternalTexture(this,InternalTextureSource.Unknown,!0);return s._hardwareTexture=r,s.isReady=!0,s.useMipMaps=t,this.updateTextureSamplingMode(i,s),s}_uploadImageToTexture(e,t,i=0,r=0){const s=this._gl,n=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),l=this._getRGBABufferInternalSizedFormat(e.type,o),h=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(h,e,!0),this._unpackFlipY(e.invertY);let u=s.TEXTURE_2D;e.isCube&&(u=s.TEXTURE_CUBE_MAP_POSITIVE_X+i),s.texImage2D(u,r,l,o,n,t),this._bindTextureDirectly(h,null,!0)}updateTextureComparisonFunction(e,t){if(this.webGLVersion===1){Logger.Error("WebGL 1 does not support texture comparison.");return}const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),t===0?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),t===0?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new WebGLDataBuffer(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const r=this._gl;return new Promise((s,n)=>{const o=()=>{const l=r.clientWaitSync(e,t,0);if(l==r.WAIT_FAILED){n();return}if(l==r.TIMEOUT_EXPIRED){setTimeout(o,i);return}s()};o()})}_readPixelsAsync(e,t,i,r,s,n,o){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const l=this._gl,h=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,h),l.bufferData(l.PIXEL_PACK_BUFFER,o.byteLength,l.STREAM_READ),l.readPixels(e,t,i,r,s,n,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);const u=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return u?(l.flush(),this._clientWaitAsync(u,0,10).then(()=>(l.deleteSync(u),l.bindBuffer(l.PIXEL_PACK_BUFFER,h),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,o),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(h),o))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();EngineStore.Instances.length===1&&Engine.audioEngine&&(Engine.audioEngine.dispose(),Engine.audioEngine=null),this.disableVR();const e=this.getHostWindow();e&&typeof e.removeEventListener=="function"&&(e.removeEventListener("blur",this._onBlur),e.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),IsDocumentAvailable()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();const t=EngineStore.Instances.indexOf(this);t>=0&&EngineStore.Instances.splice(t,1),Engine.Instances.length||EngineStore.OnEnginesDisposedObservable.notifyObservers(this),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!IsWindowObjectExist())return;const e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!IsWindowObjectExist())return;const e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=Engine.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement("video")}static _RequestPointerlock(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then(()=>{e.focus()}).catch(()=>{}):e.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}static _ExitFullscreen(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){const t=document.createElement("span");t.innerHTML="Hg",t.setAttribute("style",`font: ${e} !important`);const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const r=document.createElement("div");r.style.whiteSpace="nowrap",r.appendChild(t),r.appendChild(i),document.body.appendChild(r);let s=0,n=0;try{n=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",s=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(r)}return{ascent:s,height:n,descent:n-s}}}Engine.ALPHA_DISABLE=0;Engine.ALPHA_ADD=1;Engine.ALPHA_COMBINE=2;Engine.ALPHA_SUBTRACT=3;Engine.ALPHA_MULTIPLY=4;Engine.ALPHA_MAXIMIZED=5;Engine.ALPHA_ONEONE=6;Engine.ALPHA_PREMULTIPLIED=7;Engine.ALPHA_PREMULTIPLIED_PORTERDUFF=8;Engine.ALPHA_INTERPOLATE=9;Engine.ALPHA_SCREENMODE=10;Engine.DELAYLOADSTATE_NONE=0;Engine.DELAYLOADSTATE_LOADED=1;Engine.DELAYLOADSTATE_LOADING=2;Engine.DELAYLOADSTATE_NOTLOADED=4;Engine.NEVER=512;Engine.ALWAYS=519;Engine.LESS=513;Engine.EQUAL=514;Engine.LEQUAL=515;Engine.GREATER=516;Engine.GEQUAL=518;Engine.NOTEQUAL=517;Engine.KEEP=7680;Engine.REPLACE=7681;Engine.INCR=7682;Engine.DECR=7683;Engine.INVERT=5386;Engine.INCR_WRAP=34055;Engine.DECR_WRAP=34056;Engine.TEXTURE_CLAMP_ADDRESSMODE=0;Engine.TEXTURE_WRAP_ADDRESSMODE=1;Engine.TEXTURE_MIRROR_ADDRESSMODE=2;Engine.TEXTUREFORMAT_ALPHA=0;Engine.TEXTUREFORMAT_LUMINANCE=1;Engine.TEXTUREFORMAT_LUMINANCE_ALPHA=2;Engine.TEXTUREFORMAT_RGB=4;Engine.TEXTUREFORMAT_RGBA=5;Engine.TEXTUREFORMAT_RED=6;Engine.TEXTUREFORMAT_R=6;Engine.TEXTUREFORMAT_RG=7;Engine.TEXTUREFORMAT_RED_INTEGER=8;Engine.TEXTUREFORMAT_R_INTEGER=8;Engine.TEXTUREFORMAT_RG_INTEGER=9;Engine.TEXTUREFORMAT_RGB_INTEGER=10;Engine.TEXTUREFORMAT_RGBA_INTEGER=11;Engine.TEXTURETYPE_UNSIGNED_BYTE=0;Engine.TEXTURETYPE_UNSIGNED_INT=0;Engine.TEXTURETYPE_FLOAT=1;Engine.TEXTURETYPE_HALF_FLOAT=2;Engine.TEXTURETYPE_BYTE=3;Engine.TEXTURETYPE_SHORT=4;Engine.TEXTURETYPE_UNSIGNED_SHORT=5;Engine.TEXTURETYPE_INT=6;Engine.TEXTURETYPE_UNSIGNED_INTEGER=7;Engine.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;Engine.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;Engine.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;Engine.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;Engine.TEXTURETYPE_UNSIGNED_INT_24_8=12;Engine.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;Engine.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;Engine.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;Engine.TEXTURE_NEAREST_SAMPLINGMODE=1;Engine.TEXTURE_BILINEAR_SAMPLINGMODE=2;Engine.TEXTURE_TRILINEAR_SAMPLINGMODE=3;Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;Engine.TEXTURE_NEAREST_LINEAR=7;Engine.TEXTURE_NEAREST_NEAREST=1;Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;Engine.TEXTURE_LINEAR_LINEAR=2;Engine.TEXTURE_LINEAR_NEAREST=12;Engine.TEXTURE_EXPLICIT_MODE=0;Engine.TEXTURE_SPHERICAL_MODE=1;Engine.TEXTURE_PLANAR_MODE=2;Engine.TEXTURE_CUBIC_MODE=3;Engine.TEXTURE_PROJECTION_MODE=4;Engine.TEXTURE_SKYBOX_MODE=5;Engine.TEXTURE_INVCUBIC_MODE=6;Engine.TEXTURE_EQUIRECTANGULAR_MODE=7;Engine.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;Engine.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;Engine.SCALEMODE_FLOOR=1;Engine.SCALEMODE_NEAREST=2;Engine.SCALEMODE_CEILING=3;Engine._RescalePostProcessFactory=null;Engine._RenderPassIdCounter=0;var AnimationKeyInterpolation;(function(a){a[a.NONE=0]="NONE",a[a.STEP=1]="STEP"})(AnimationKeyInterpolation||(AnimationKeyInterpolation={}));class AnimationRange{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new AnimationRange(this.name,this.from,this.to)}}class Size{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new Size(this.width*e,this.height*t)}clone(){return new Size(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new Size(0,0)}add(e){return new Size(this.width+e.width,this.height+e.height)}subtract(e){return new Size(this.width-e.width,this.height-e.height)}static Lerp(e,t,i){const r=e.width+(t.width-e.width)*i,s=e.height+(t.height-e.height)*i;return new Size(r,s)}}class Animation{static _PrepareAnimation(e,t,i,r,s,n,o,l){let h;if(!isNaN(parseFloat(s))&&isFinite(s)?h=Animation.ANIMATIONTYPE_FLOAT:s instanceof Quaternion?h=Animation.ANIMATIONTYPE_QUATERNION:s instanceof Vector3?h=Animation.ANIMATIONTYPE_VECTOR3:s instanceof Vector2?h=Animation.ANIMATIONTYPE_VECTOR2:s instanceof Color3?h=Animation.ANIMATIONTYPE_COLOR3:s instanceof Color4?h=Animation.ANIMATIONTYPE_COLOR4:s instanceof Size&&(h=Animation.ANIMATIONTYPE_SIZE),h==null)return null;const u=new Animation(e,t,i,h,o),c=[{frame:0,value:s},{frame:r,value:n}];return u.setKeys(c),l!==void 0&&u.setEasingFunction(l),u}static CreateAnimation(e,t,i,r){const s=new Animation(e+"Animation",e,i,t,Animation.ANIMATIONLOOPMODE_CONSTANT);return s.setEasingFunction(r),s}static CreateAndStartAnimation(e,t,i,r,s,n,o,l,h,u,c){const d=Animation._PrepareAnimation(e,i,r,s,n,o,l,h);return!d||(t.getScene&&(c=t.getScene()),!c)?null:c.beginDirectAnimation(t,[d],0,s,d.loopMode===1,1,u)}static CreateAndStartHierarchyAnimation(e,t,i,r,s,n,o,l,h,u,c){const d=Animation._PrepareAnimation(e,r,s,n,o,l,h,u);return d?t.getScene().beginDirectHierarchyAnimation(t,i,[d],0,n,d.loopMode===1,1,c):null}static CreateMergeAndStartAnimation(e,t,i,r,s,n,o,l,h,u){const c=Animation._PrepareAnimation(e,i,r,s,n,o,l,h);return c?(t.animations.push(c),t.getScene().beginAnimation(t,0,s,c.loopMode===1,1,u)):null}static MakeAnimationAdditive(e,t=0,i,r=!1,s){let n=e;if(r&&(n=e.clone(),n.name=s||n.name),!n._keys.length)return n;t=t>=0?t:0;let o=0;const l=n._keys[0];let h=n._keys.length-1;const u=n._keys[h],c={referenceValue:l.value,referencePosition:TmpVectors.Vector3[0],referenceQuaternion:TmpVectors.Quaternion[0],referenceScaling:TmpVectors.Vector3[1],keyPosition:TmpVectors.Vector3[2],keyQuaternion:TmpVectors.Quaternion[1],keyScaling:TmpVectors.Vector3[3]};let d=!1,f=l.frame,_=u.frame;if(i){const E=n.getRange(i);E&&(f=E.from,_=E.to)}let g=l.frame===f,p=u.frame===_;if(n._keys.length===1){const E=n._getKeyValue(n._keys[0]);c.referenceValue=E.clone?E.clone():E,d=!0}else if(t<=l.frame){const E=n._getKeyValue(l.value);c.referenceValue=E.clone?E.clone():E,d=!0}else if(t>=u.frame){const E=n._getKeyValue(u.value);c.referenceValue=E.clone?E.clone():E,d=!0}let m=0;for(;!d||!g||!p&&m<n._keys.length-1;){const E=n._keys[m],M=n._keys[m+1];if(!d&&t>=E.frame&&t<=M.frame){let x;if(t===E.frame)x=n._getKeyValue(E.value);else if(t===M.frame)x=n._getKeyValue(M.value);else{const A={key:m,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT};x=n._interpolate(t,A)}c.referenceValue=x.clone?x.clone():x,d=!0}if(!g&&f>=E.frame&&f<=M.frame){if(f===E.frame)o=m;else if(f===M.frame)o=m+1;else{const x={key:m,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},A=n._interpolate(f,x),T={frame:f,value:A.clone?A.clone():A};n._keys.splice(m+1,0,T),o=m+1}g=!0}if(!p&&_>=E.frame&&_<=M.frame){if(_===E.frame)h=m;else if(_===M.frame)h=m+1;else{const x={key:m,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},A=n._interpolate(_,x),T={frame:_,value:A.clone?A.clone():A};n._keys.splice(m+1,0,T),h=m+1}p=!0}m++}for(n.dataType===Animation.ANIMATIONTYPE_QUATERNION?c.referenceValue.normalize().conjugateInPlace():n.dataType===Animation.ANIMATIONTYPE_MATRIX&&(c.referenceValue.decompose(c.referenceScaling,c.referenceQuaternion,c.referencePosition),c.referenceQuaternion.normalize().conjugateInPlace()),m=o;m<=h;m++){const E=n._keys[m];if(!(m&&n.dataType!==Animation.ANIMATIONTYPE_FLOAT&&E.value===l.value))switch(n.dataType){case Animation.ANIMATIONTYPE_MATRIX:E.value.decompose(c.keyScaling,c.keyQuaternion,c.keyPosition),c.keyPosition.subtractInPlace(c.referencePosition),c.keyScaling.divideInPlace(c.referenceScaling),c.referenceQuaternion.multiplyToRef(c.keyQuaternion,c.keyQuaternion),Matrix.ComposeToRef(c.keyScaling,c.keyQuaternion,c.keyPosition,E.value);break;case Animation.ANIMATIONTYPE_QUATERNION:c.referenceValue.multiplyToRef(E.value,E.value);break;case Animation.ANIMATIONTYPE_VECTOR2:case Animation.ANIMATIONTYPE_VECTOR3:case Animation.ANIMATIONTYPE_COLOR3:case Animation.ANIMATIONTYPE_COLOR4:E.value.subtractToRef(c.referenceValue,E.value);break;case Animation.ANIMATIONTYPE_SIZE:E.value.width-=c.referenceValue.width,E.value.height-=c.referenceValue.height;break;default:E.value-=c.referenceValue}}return n}static TransitionTo(e,t,i,r,s,n,o,l=null){if(o<=0)return i[e]=t,l&&l(),null;const h=s*(o/1e3);n.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:h,value:t}]),i.animations||(i.animations=[]),i.animations.push(n);const u=r.beginAnimation(i,0,h,!1);return u.onAnimationEnd=l,u}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,r,s,n){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=r,this.loopMode=s,this.enableBlending=n,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=r,this.loopMode=s===void 0?Animation.ANIMATIONLOOPMODE_CYCLE:s,this.uniqueId=Animation._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(const r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new AnimationRange(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const r=i.from,s=i.to;for(let n=this._keys.length-1;n>=0;n--)this._keys[n].frame>=r&&this._keys[n].frame<=s&&this._keys.splice(n,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return Scalar.Lerp(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,r,s){return Scalar.Hermite(e,t,i,r,s)}quaternionInterpolateFunction(e,t,i){return Quaternion.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,r,s){return Quaternion.Hermite(e,t,i,r,s).normalize()}vector3InterpolateFunction(e,t,i){return Vector3.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,r,s){return Vector3.Hermite(e,t,i,r,s)}vector2InterpolateFunction(e,t,i){return Vector2.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,r,s){return Vector2.Hermite(e,t,i,r,s)}sizeInterpolateFunction(e,t,i){return Size.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return Color3.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,r,s){return Color3.Hermite(e,t,i,r,s)}color4InterpolateFunction(e,t,i){return Color4.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,r,s){return Color4.Hermite(e,t,i,r,s)}_getKeyValue(e){return typeof e=="function"?e():e}evaluate(e){return this._interpolate(e,{key:0,repeatCount:0,loopMode:Animation.ANIMATIONLOOPMODE_CONSTANT})}_interpolate(e,t){if(t.loopMode===Animation.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const i=this._keys,r=i.length;let s=t.key;for(;s>=0&&e<i[s].frame;)--s;for(;s+1<=r-1&&e>=i[s+1].frame;)++s;if(t.key=s,s<0)return this._getKeyValue(i[0].value);if(s+1>r-1)return this._getKeyValue(i[r-1].value);const n=i[s],o=i[s+1],l=this._getKeyValue(n.value),h=this._getKeyValue(o.value);if(n.interpolation===AnimationKeyInterpolation.STEP)return o.frame>e?l:h;const u=n.outTangent!==void 0&&o.inTangent!==void 0,c=o.frame-n.frame;let d=(e-n.frame)/c;const f=this.getEasingFunction();switch(f!==null&&(d=f.ease(d)),this.dataType){case Animation.ANIMATIONTYPE_FLOAT:{const _=u?this.floatInterpolateFunctionWithTangents(l,n.outTangent*c,h,o.inTangent*c,d):this.floatInterpolateFunction(l,h,d);switch(t.loopMode){case Animation.ANIMATIONLOOPMODE_CYCLE:case Animation.ANIMATIONLOOPMODE_CONSTANT:case Animation.ANIMATIONLOOPMODE_YOYO:return _;case Animation.ANIMATIONLOOPMODE_RELATIVE:return t.offsetValue*t.repeatCount+_}break}case Animation.ANIMATIONTYPE_QUATERNION:{const _=u?this.quaternionInterpolateFunctionWithTangents(l,n.outTangent.scale(c),h,o.inTangent.scale(c),d):this.quaternionInterpolateFunction(l,h,d);switch(t.loopMode){case Animation.ANIMATIONLOOPMODE_CYCLE:case Animation.ANIMATIONLOOPMODE_CONSTANT:case Animation.ANIMATIONLOOPMODE_YOYO:return _;case Animation.ANIMATIONLOOPMODE_RELATIVE:return _.addInPlace(t.offsetValue.scale(t.repeatCount))}return _}case Animation.ANIMATIONTYPE_VECTOR3:{const _=u?this.vector3InterpolateFunctionWithTangents(l,n.outTangent.scale(c),h,o.inTangent.scale(c),d):this.vector3InterpolateFunction(l,h,d);switch(t.loopMode){case Animation.ANIMATIONLOOPMODE_CYCLE:case Animation.ANIMATIONLOOPMODE_CONSTANT:case Animation.ANIMATIONLOOPMODE_YOYO:return _;case Animation.ANIMATIONLOOPMODE_RELATIVE:return _.add(t.offsetValue.scale(t.repeatCount))}break}case Animation.ANIMATIONTYPE_VECTOR2:{const _=u?this.vector2InterpolateFunctionWithTangents(l,n.outTangent.scale(c),h,o.inTangent.scale(c),d):this.vector2InterpolateFunction(l,h,d);switch(t.loopMode){case Animation.ANIMATIONLOOPMODE_CYCLE:case Animation.ANIMATIONLOOPMODE_CONSTANT:case Animation.ANIMATIONLOOPMODE_YOYO:return _;case Animation.ANIMATIONLOOPMODE_RELATIVE:return _.add(t.offsetValue.scale(t.repeatCount))}break}case Animation.ANIMATIONTYPE_SIZE:{switch(t.loopMode){case Animation.ANIMATIONLOOPMODE_CYCLE:case Animation.ANIMATIONLOOPMODE_CONSTANT:case Animation.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(l,h,d);case Animation.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(l,h,d).add(t.offsetValue.scale(t.repeatCount))}break}case Animation.ANIMATIONTYPE_COLOR3:{const _=u?this.color3InterpolateFunctionWithTangents(l,n.outTangent.scale(c),h,o.inTangent.scale(c),d):this.color3InterpolateFunction(l,h,d);switch(t.loopMode){case Animation.ANIMATIONLOOPMODE_CYCLE:case Animation.ANIMATIONLOOPMODE_CONSTANT:case Animation.ANIMATIONLOOPMODE_YOYO:return _;case Animation.ANIMATIONLOOPMODE_RELATIVE:return _.add(t.offsetValue.scale(t.repeatCount))}break}case Animation.ANIMATIONTYPE_COLOR4:{const _=u?this.color4InterpolateFunctionWithTangents(l,n.outTangent.scale(c),h,o.inTangent.scale(c),d):this.color4InterpolateFunction(l,h,d);switch(t.loopMode){case Animation.ANIMATIONLOOPMODE_CYCLE:case Animation.ANIMATIONLOOPMODE_CONSTANT:case Animation.ANIMATIONLOOPMODE_YOYO:return _;case Animation.ANIMATIONLOOPMODE_RELATIVE:return _.add(t.offsetValue.scale(t.repeatCount))}break}case Animation.ANIMATIONTYPE_MATRIX:{switch(t.loopMode){case Animation.ANIMATIONLOOPMODE_CYCLE:case Animation.ANIMATIONLOOPMODE_CONSTANT:case Animation.ANIMATIONLOOPMODE_YOYO:return Animation.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,h,d,t.workValue):l;case Animation.ANIMATIONLOOPMODE_RELATIVE:return l}break}}return 0}matrixInterpolateFunction(e,t,i,r){return Animation.AllowMatrixDecomposeForInterpolation?r?(Matrix.DecomposeLerpToRef(e,t,i,r),r):Matrix.DecomposeLerp(e,t,i):r?(Matrix.LerpToRef(e,t,i,r),r):Matrix.Lerp(e,t,i)}clone(){const e=new Animation(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e){this._keys=e.slice(0)}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let r=0;r<i.length;r++){const s=i[r],n={};switch(n.frame=s.frame,t){case Animation.ANIMATIONTYPE_FLOAT:n.values=[s.value],s.inTangent!==void 0&&n.values.push(s.inTangent),s.outTangent!==void 0&&(s.inTangent===void 0&&n.values.push(void 0),n.values.push(s.outTangent)),s.interpolation!==void 0&&(s.inTangent===void 0&&n.values.push(void 0),s.outTangent===void 0&&n.values.push(void 0),n.values.push(s.interpolation));break;case Animation.ANIMATIONTYPE_QUATERNION:case Animation.ANIMATIONTYPE_MATRIX:case Animation.ANIMATIONTYPE_VECTOR3:case Animation.ANIMATIONTYPE_COLOR3:case Animation.ANIMATIONTYPE_COLOR4:n.values=s.value.asArray(),s.inTangent!=null&&n.values.push(s.inTangent.asArray()),s.outTangent!=null&&(s.inTangent===void 0&&n.values.push(void 0),n.values.push(s.outTangent.asArray())),s.interpolation!==void 0&&(s.inTangent===void 0&&n.values.push(void 0),s.outTangent===void 0&&n.values.push(void 0),n.values.push(s.interpolation));break}e.keys.push(n)}e.ranges=[];for(const r in this._ranges){const s=this._ranges[r];if(!s)continue;const n={};n.name=r,n.from=s.from,n.to=s.to,e.ranges.push(n)}return e}static _UniversalLerp(e,t,i){const r=e.constructor;return r.Lerp?r.Lerp(e,t,i):r.Slerp?r.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new Animation(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,r=[];let s,n;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),n=0;n<e.keys.length;n++){const o=e.keys[n];let l,h,u;switch(i){case Animation.ANIMATIONTYPE_FLOAT:s=o.values[0],o.values.length>=2&&(l=o.values[1]),o.values.length>=3&&(h=o.values[2]),o.values.length>=4&&(u=o.values[3]);break;case Animation.ANIMATIONTYPE_QUATERNION:if(s=Quaternion.FromArray(o.values),o.values.length>=8){const d=Quaternion.FromArray(o.values.slice(4,8));d.equals(Quaternion.Zero())||(l=d)}if(o.values.length>=12){const d=Quaternion.FromArray(o.values.slice(8,12));d.equals(Quaternion.Zero())||(h=d)}o.values.length>=13&&(u=o.values[12]);break;case Animation.ANIMATIONTYPE_MATRIX:s=Matrix.FromArray(o.values),o.values.length>=17&&(u=o.values[16]);break;case Animation.ANIMATIONTYPE_COLOR3:s=Color3.FromArray(o.values),o.values[3]&&(l=Color3.FromArray(o.values[3])),o.values[4]&&(h=Color3.FromArray(o.values[4])),o.values[5]&&(u=o.values[5]);break;case Animation.ANIMATIONTYPE_COLOR4:s=Color4.FromArray(o.values),o.values[4]&&(l=Color4.FromArray(o.values[4])),o.values[5]&&(h=Color4.FromArray(o.values[5])),o.values[6]&&(u=Color4.FromArray(o.values[6]));break;case Animation.ANIMATIONTYPE_VECTOR3:default:s=Vector3.FromArray(o.values),o.values[3]&&(l=Vector3.FromArray(o.values[3])),o.values[4]&&(h=Vector3.FromArray(o.values[4])),o.values[5]&&(u=o.values[5]);break}const c={};c.frame=o.frame,c.value=s,l!=null&&(c.inTangent=l),h!=null&&(c.outTangent=h),u!=null&&(c.interpolation=u),r.push(c)}if(t.setKeys(r),e.ranges)for(n=0;n<e.ranges.length;n++)s=e.ranges[n],t.createRange(s.name,s.from,s.to);return t}static AppendSerializedAnimations(e,t){SerializationHelper.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,r)=>{const s=new WebRequest;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){let n=JSON.parse(s.responseText);if(n.animations&&(n=n.animations),n.length){const o=new Array;for(const l of n)o.push(this.Parse(l));i(o)}else{const o=this.Parse(n);e&&(o.name=e),i(o)}}else r("Unable to load the animation")}),s.open("GET",t),s.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{const r=new WebRequest;r.addEventListener("readystatechange",()=>{if(r.readyState==4)if(r.status==200){const s=JSON.parse(JSON.parse(r.responseText).jsonPayload);if(s.animations){const n=JSON.parse(s.animations),o=new Array;for(const l of n.animations){const h=this.Parse(l);h.snippetId=e,o.push(h)}t(o)}else{const n=JSON.parse(s.animation),o=this.Parse(n);o.snippetId=e,t(o)}}else i("Unable to load the snippet "+e)}),r.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),r.send()})}}Animation._UniqueIdGenerator=0;Animation.AllowMatricesInterpolation=!1;Animation.AllowMatrixDecomposeForInterpolation=!0;Animation.SnippetUrl="https://snippet.babylonjs.com";Animation.ANIMATIONTYPE_FLOAT=0;Animation.ANIMATIONTYPE_VECTOR3=1;Animation.ANIMATIONTYPE_QUATERNION=2;Animation.ANIMATIONTYPE_MATRIX=3;Animation.ANIMATIONTYPE_COLOR3=4;Animation.ANIMATIONTYPE_COLOR4=7;Animation.ANIMATIONTYPE_VECTOR2=5;Animation.ANIMATIONTYPE_SIZE=6;Animation.ANIMATIONLOOPMODE_RELATIVE=0;Animation.ANIMATIONLOOPMODE_CYCLE=1;Animation.ANIMATIONLOOPMODE_CONSTANT=2;Animation.ANIMATIONLOOPMODE_YOYO=4;Animation.CreateFromSnippetAsync=Animation.ParseFromSnippetAsync;RegisterClass("BABYLON.Animation",Animation);Node._AnimationRangeFactory=(a,e,t)=>new AnimationRange(a,e,t);const _staticOffsetValueQuaternion=Object.freeze(new Quaternion(0,0,0,0)),_staticOffsetValueVector3=Object.freeze(Vector3.Zero()),_staticOffsetValueVector2=Object.freeze(Vector2.Zero()),_staticOffsetValueSize=Object.freeze(Size.Zero()),_staticOffsetValueColor3=Object.freeze(Color3.Black());class RuntimeAnimation{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,r){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=r,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===Animation.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=Matrix.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){const n={frame:0,value:this._minValue};this._keys.splice(0,0,n)}if(this._target instanceof Array){let n=0;for(const o of this._target)this._preparePath(o,n),this._getOriginalValues(n),n++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const s=t.getEvents();s&&s.length>0&&s.forEach(n=>{this._events.push(n._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let r=e[i[0]];for(let s=1;s<i.length-1;s++)r=r[i[s]];this._targetPath=i[i.length-1],this._activeTargets[t]=r}else this._targetPath=i[0],this._activeTargets[t]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){const r=this._target[i];this._setValue(r,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];i.getRestPose&&this._targetPath==="_matrix"?t=i.getRestPose():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_setValue(e,t,i,r,s){if(this._currentActiveTarget=t,this._weight=r,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const o=t[this._targetPath];o.clone?this._originalBlendValue=o.clone():this._originalBlendValue=o}this._originalBlendValue.m?Animation.AllowMatrixDecomposeForInterpolation?this._currentValue?Matrix.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=Matrix.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?Matrix.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=Matrix.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=Animation._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const n=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=n}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i!=null&&i.clone?this._currentValue=i.clone():this._currentValue=i;r!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[s]):t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const t=this._animation.getKeys();e<t[0].frame?e=t[0].frame:e>t[t.length-1].frame&&(e=t[t.length-1].frame);const i=this._events;if(i.length)for(let s=0;s<i.length;s++)i[s].onlyOnce||(i[s].isDone=i[s].frame<e);this._currentFrame=e;const r=this._animation._interpolate(e,this._animationState);this.setValue(r,-1)}_prepareForSpeedRatioChange(e){const t=this._previousDelay*(this._animation.framePerSecond*e)/1e3;this._ratioOffset=this._previousRatio-t}animate(e,t,i,r,s,n=-1){const o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let h=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const u=i-t;let c,d=e*(o.framePerSecond*s)/1e3+this._ratioOffset,f=0;if(r&&this._animationState.loopMode===Animation.ANIMATIONLOOPMODE_YOYO){const m=(d-t)/u;d=Math.abs(Math.sin(m*Math.PI))*u+t}if(this._previousDelay=e,this._previousRatio=d,!r&&i>=t&&d>=u)h=!1,f=o._getKeyValue(this._maxValue);else if(!r&&t>=i&&d<=u)h=!1,f=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==Animation.ANIMATIONLOOPMODE_CYCLE){const m=i.toString()+t.toString();if(!this._offsetsCache[m]){this._animationState.repeatCount=0,this._animationState.loopMode=Animation.ANIMATIONLOOPMODE_CYCLE;const E=o._interpolate(t,this._animationState),M=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case Animation.ANIMATIONTYPE_FLOAT:this._offsetsCache[m]=M-E;break;case Animation.ANIMATIONTYPE_QUATERNION:this._offsetsCache[m]=M.subtract(E);break;case Animation.ANIMATIONTYPE_VECTOR3:this._offsetsCache[m]=M.subtract(E);break;case Animation.ANIMATIONTYPE_VECTOR2:this._offsetsCache[m]=M.subtract(E);break;case Animation.ANIMATIONTYPE_SIZE:this._offsetsCache[m]=M.subtract(E);break;case Animation.ANIMATIONTYPE_COLOR3:this._offsetsCache[m]=M.subtract(E);break}this._highLimitsCache[m]=M}f=this._highLimitsCache[m],c=this._offsetsCache[m]}if(c===void 0)switch(o.dataType){case Animation.ANIMATIONTYPE_FLOAT:c=0;break;case Animation.ANIMATIONTYPE_QUATERNION:c=_staticOffsetValueQuaternion;break;case Animation.ANIMATIONTYPE_VECTOR3:c=_staticOffsetValueVector3;break;case Animation.ANIMATIONTYPE_VECTOR2:c=_staticOffsetValueVector2;break;case Animation.ANIMATIONTYPE_SIZE:c=_staticOffsetValueSize;break;case Animation.ANIMATIONTYPE_COLOR3:c=_staticOffsetValueColor3}let _;if(this._host&&this._host.syncRoot){const m=this._host.syncRoot,E=(m.masterFrame-m.fromFrame)/(m.toFrame-m.fromFrame);_=t+(i-t)*E}else d>0&&t>i||d<0&&t<i?_=h&&u!==0?i+d%u:t:_=h&&u!==0?t+d%u:i;const g=this._events;if(s>0&&this.currentFrame>_||s<0&&this.currentFrame<_){this._onLoop();for(let m=0;m<g.length;m++)g[m].onlyOnce||(g[m].isDone=!1);this._animationState.key=s>0?0:o.getKeys().length-1}this._currentFrame=_,this._animationState.repeatCount=u===0?0:d/u>>0,this._animationState.highLimitValue=f,this._animationState.offsetValue=c;const p=o._interpolate(_,this._animationState);if(this.setValue(p,n),g.length){for(let m=0;m<g.length;m++)if(u>0&&_>=g[m].frame&&g[m].frame>=t||u<0&&_<=g[m].frame&&g[m].frame<=t){const E=g[m];E.isDone||(E.onlyOnce&&(g.splice(m,1),m--),E.isDone=!0,E.action(_))}}return h||(this._stopped=!0),h}}class Bone extends Node{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){this._needToCompose=!1,e.updateFlag!==this._localMatrix.updateFlag&&(this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,r=null,s=null,n=null,o=null){super(e,t.getScene()),this.name=e,this.children=new Array,this.animations=new Array,this._index=null,this._absoluteTransform=new Matrix,this._invertedAbsoluteTransform=new Matrix,this._scalingDeterminant=1,this._worldTransform=new Matrix,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=r?r.clone():Matrix.Identity(),this._restPose=s||this._localMatrix.clone(),this._baseMatrix=n||this._localMatrix.clone(),this._index=o,t.bones.push(this),this.setParent(i,!1),(n||r)&&this._updateDifferenceMatrix()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateDifferenceMatrix(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBaseMatrix(){return this._baseMatrix}getRestPose(){return this._restPose}setRestPose(e){this._restPose.copyFrom(e)}getBindPose(){return this._baseMatrix}setBindPose(e){this.updateMatrix(e)}getWorldMatrix(){return this._worldTransform}returnToRest(){var e;if(this._linkedTransformNode){const t=TmpVectors.Vector3[0],i=TmpVectors.Quaternion[0],r=TmpVectors.Vector3[1];this.getRestPose().decompose(t,i,r),this._linkedTransformNode.position.copyFrom(r),this._linkedTransformNode.rotationQuaternion=(e=this._linkedTransformNode.rotationQuaternion)!==null&&e!==void 0?e:Quaternion.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restPose}getInvertedAbsoluteTransform(){return this._invertedAbsoluteTransform}getAbsoluteTransform(){return this._absoluteTransform}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=Vector3.Zero(),this._localRotation=Quaternion.Zero(),this._localPosition=Vector3.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,Matrix.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._baseMatrix.copyFrom(e),t&&this._updateDifferenceMatrix(),i?this._matrix=e:this.markAsDirty()}_updateDifferenceMatrix(e,t=!0){if(e||(e=this._baseMatrix),this.parent?e.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(e),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}translate(e,t=Space.LOCAL,i){const r=this.getLocalMatrix();if(t==Space.LOCAL)r.addAtIndex(12,e.x),r.addAtIndex(13,e.y),r.addAtIndex(14,e.z);else{let s=null;i&&(s=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const n=Bone._TmpMats[0],o=Bone._TmpVecs[0];this.parent?i&&s?(n.copyFrom(this.parent.getAbsoluteTransform()),n.multiplyToRef(s,n)):n.copyFrom(this.parent.getAbsoluteTransform()):Matrix.IdentityToRef(n),n.setTranslationFromFloats(0,0,0),n.invert(),Vector3.TransformCoordinatesToRef(e,n,o),r.addAtIndex(12,o.x),r.addAtIndex(13,o.y),r.addAtIndex(14,o.z)}this._markAsDirtyAndDecompose()}setPosition(e,t=Space.LOCAL,i){const r=this.getLocalMatrix();if(t==Space.LOCAL)r.setTranslationFromFloats(e.x,e.y,e.z);else{let s=null;i&&(s=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const n=Bone._TmpMats[0],o=Bone._TmpVecs[0];this.parent?(i&&s?(n.copyFrom(this.parent.getAbsoluteTransform()),n.multiplyToRef(s,n)):n.copyFrom(this.parent.getAbsoluteTransform()),n.invert()):Matrix.IdentityToRef(n),Vector3.TransformCoordinatesToRef(e,n,o),r.setTranslationFromFloats(o.x,o.y,o.z)}this._markAsDirtyAndDecompose()}setAbsolutePosition(e,t){this.setPosition(e,Space.WORLD,t)}scale(e,t,i,r=!1){const s=this.getLocalMatrix(),n=Bone._TmpMats[0];Matrix.ScalingToRef(e,t,i,n),n.multiplyToRef(s,s),n.invert();for(const o of this.children){const l=o.getLocalMatrix();l.multiplyToRef(n,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),r)for(const o of this.children)o.scale(e,t,i,r)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,r=Space.LOCAL,s){if(r===Space.LOCAL){const l=Bone._TmpQuat;Quaternion.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,r,s);return}const n=Bone._TmpMats[0];if(!this._getNegativeRotationToRef(n,s))return;const o=Bone._TmpMats[1];Matrix.RotationYawPitchRollToRef(e,t,i,o),n.multiplyToRef(o,o),this._rotateWithMatrix(o,r,s)}rotate(e,t,i=Space.LOCAL,r){const s=Bone._TmpMats[0];s.setTranslationFromFloats(0,0,0),Matrix.RotationAxisToRef(e,t,s),this._rotateWithMatrix(s,i,r)}setAxisAngle(e,t,i=Space.LOCAL,r){if(i===Space.LOCAL){const o=Bone._TmpQuat;Quaternion.RotationAxisToRef(e,t,o),this.setRotationQuaternion(o,i,r);return}const s=Bone._TmpMats[0];if(!this._getNegativeRotationToRef(s,r))return;const n=Bone._TmpMats[1];Matrix.RotationAxisToRef(e,t,n),s.multiplyToRef(n,n),this._rotateWithMatrix(n,i,r)}setRotation(e,t=Space.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=Space.LOCAL,i){if(t===Space.LOCAL){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}const r=Bone._TmpMats[0];if(!this._getNegativeRotationToRef(r,i))return;const s=Bone._TmpMats[1];Matrix.FromQuaternionToRef(e,s),r.multiplyToRef(s,s),this._rotateWithMatrix(s,t,i)}setRotationMatrix(e,t=Space.LOCAL,i){if(t===Space.LOCAL){const n=Bone._TmpQuat;Quaternion.FromRotationMatrixToRef(e,n),this.setRotationQuaternion(n,t,i);return}const r=Bone._TmpMats[0];if(!this._getNegativeRotationToRef(r,i))return;const s=Bone._TmpMats[1];s.copyFrom(e),r.multiplyToRef(e,s),this._rotateWithMatrix(s,t,i)}_rotateWithMatrix(e,t=Space.LOCAL,i){const r=this.getLocalMatrix(),s=r.m[12],n=r.m[13],o=r.m[14],l=this.getParent(),h=Bone._TmpMats[3],u=Bone._TmpMats[4];l&&t==Space.WORLD?(i?(h.copyFrom(i.getWorldMatrix()),l.getAbsoluteTransform().multiplyToRef(h,h)):h.copyFrom(l.getAbsoluteTransform()),u.copyFrom(h),u.invert(),r.multiplyToRef(h,r),r.multiplyToRef(e,r),r.multiplyToRef(u,r)):t==Space.WORLD&&i?(h.copyFrom(i.getWorldMatrix()),u.copyFrom(h),u.invert(),r.multiplyToRef(h,r),r.multiplyToRef(e,r),r.multiplyToRef(u,r)):r.multiplyToRef(e,r),r.setTranslationFromFloats(s,n,o),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()}_getNegativeRotationToRef(e,t){const i=Bone._TmpMats[2];return e.copyFrom(this.getAbsoluteTransform()),t?(e.multiplyToRef(t.getWorldMatrix(),e),Matrix.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):Matrix.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=Space.LOCAL,t=null){const i=Vector3.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=Space.LOCAL,t,i){if(e==Space.LOCAL){const r=this.getLocalMatrix();i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}else{let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let s=Bone._TmpMats[0];t&&r?(s.copyFrom(this.getAbsoluteTransform()),s.multiplyToRef(r,s)):s=this.getAbsoluteTransform(),i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}}getAbsolutePosition(e=null){const t=Vector3.Zero();return this.getPositionToRef(Space.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(Space.WORLD,e,t)}computeAbsoluteTransforms(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteTransform.multiplyToRef(i,this._absoluteTransform)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteTransforms()}getDirection(e,t=null){const i=Vector3.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const s=Bone._TmpMats[0];s.copyFrom(this.getAbsoluteTransform()),t&&r&&s.multiplyToRef(r,s),Vector3.TransformNormalToRef(e,s,i),i.normalize()}getRotation(e=Space.LOCAL,t=null){const i=Vector3.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=Space.LOCAL,t=null,i){const r=Bone._TmpQuat;this.getRotationQuaternionToRef(e,t,r),r.toEulerAnglesToRef(i)}getRotationQuaternion(e=Space.LOCAL,t=null){const i=Quaternion.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=Space.LOCAL,t=null,i){if(e==Space.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{const r=Bone._TmpMats[0],s=this.getAbsoluteTransform();t?s.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(s),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.decompose(void 0,i,void 0)}}getRotationMatrix(e=Space.LOCAL,t){const i=Matrix.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=Space.LOCAL,t,i){if(e==Space.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{const r=Bone._TmpMats[0],s=this.getAbsoluteTransform();t?s.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(s),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=Vector3.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let s=Bone._TmpMats[0];t&&r?(s.copyFrom(this.getAbsoluteTransform()),s.multiplyToRef(r,s)):s=this.getAbsoluteTransform(),Vector3.TransformCoordinatesToRef(e,s,i)}getLocalPositionFromAbsolute(e,t=null){const i=Vector3.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const s=Bone._TmpMats[0];s.copyFrom(this.getAbsoluteTransform()),t&&r&&s.multiplyToRef(r,s),s.invert(),Vector3.TransformCoordinatesToRef(e,s,i)}setCurrentPoseAsRest(){this.setRestPose(this.getLocalMatrix())}}Bone._TmpVecs=ArrayTools.BuildArray(2,Vector3.Zero);Bone._TmpQuat=Quaternion.Identity();Bone._TmpMats=ArrayTools.BuildArray(5,Matrix.Identity);class Animatable{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}constructor(e,t,i=0,r=100,s=!1,n=1,o,l,h,u=!1){this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=s,this.onAnimationEnd=o,this.onAnimationLoop=h,this.isAdditive=u,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new Observable,this.onAnimationLoopObservable=new Observable,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=n,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const r=t[i],s=new RuntimeAnimation(e,r,this._scene,this);s._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(s)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const r=i[0].animation.framePerSecond;this._frameToSyncFromJump=(t=this._frameToSyncFromJump)!==null&&t!==void 0?t:i[0].currentFrame;const s=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/r*1e3/this.speedRatio;this._manualJumpDelay=-s}for(let r=0;r<i.length;r++)i[r].goToFrame(e);this._goToFrame=e}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1){if(e||t){const r=this._scene._activeAnimatables.indexOf(this);if(r>-1){const s=this._runtimeAnimations;for(let n=s.length-1;n>=0;n--){const o=s[n];e&&o.animation.name!=e||t&&!t(o.target)||(o.dispose(),s.splice(n,1))}s.length==0&&(i||this._scene._activeAnimatables.splice(r,1),this._raiseOnAnimationEnd())}}else{const r=this._scene._activeAnimatables.indexOf(this);if(r>-1){i||this._scene._activeAnimatables.splice(r,1);const s=this._runtimeAnimations;for(let n=0;n<s.length;n++)s[n].dispose();this._runtimeAnimations.length=0,this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,this._weight===0)return!0;let t=!1;const i=this._runtimeAnimations;let r;for(r=0;r<i.length;r++){const n=i[r].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||n}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(r=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(r,1),r=0;r<i.length;r++)i[r].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}Scene.prototype._animate=function(){if(!this.animationsEnabled)return;const a=PrecisionDate.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=a}this.deltaTime=this.useConstantAnimationDeltaTime?16:(a-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=a;const e=this._activeAnimatables;if(e.length===0)return;this._animationTime+=this.deltaTime;const t=this._animationTime;for(let i=0;i<e.length;i++){const r=e[i];!r._animate(t)&&r.disposeOnEnd&&i--}this._processLateAnimationBindings()};Scene.prototype.beginWeightedAnimation=function(a,e,t,i=1,r,s=1,n,o,l,h,u=!1){const c=this.beginAnimation(a,e,t,r,s,n,o,!1,l,h,u);return c.weight=i,c};Scene.prototype.beginAnimation=function(a,e,t,i,r=1,s,n,o=!0,l,h,u=!1){e>t&&r>0&&(r*=-1),o&&this.stopAnimation(a,void 0,l),n||(n=new Animatable(this,a,e,t,i,r,s,void 0,h,u));const c=l?l(a):!0;if(a.animations&&c&&n.appendAnimations(a,a.animations),a.getAnimatables){const d=a.getAnimatables();for(let f=0;f<d.length;f++)this.beginAnimation(d[f],e,t,i,r,s,n,o,l,h)}return n.reset(),n};Scene.prototype.beginHierarchyAnimation=function(a,e,t,i,r,s=1,n,o,l=!0,h,u,c=!1){const d=a.getDescendants(e),f=[];f.push(this.beginAnimation(a,t,i,r,s,n,o,l,h,void 0,c));for(const _ of d)f.push(this.beginAnimation(_,t,i,r,s,n,o,l,h,void 0,c));return f};Scene.prototype.beginDirectAnimation=function(a,e,t,i,r,s,n,o,l=!1){if(s===void 0&&(s=1),t>i&&s>0)s*=-1;else if(i>t&&s<0){const u=i;i=t,t=u}return new Animatable(this,a,t,i,r,s,n,e,o,l)};Scene.prototype.beginDirectHierarchyAnimation=function(a,e,t,i,r,s,n,o,l,h=!1){const u=a.getDescendants(e),c=[];c.push(this.beginDirectAnimation(a,t,i,r,s,n,o,l,h));for(const d of u)c.push(this.beginDirectAnimation(d,t,i,r,s,n,o,l,h));return c};Scene.prototype.getAnimatableByTarget=function(a){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===a)return this._activeAnimatables[e];return null};Scene.prototype.getAllAnimatablesByTarget=function(a){const e=[];for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===a&&e.push(this._activeAnimatables[t]);return e};Scene.prototype.stopAnimation=function(a,e,t){const i=this.getAllAnimatablesByTarget(a);for(const r of i)r.stop(e,t)};Scene.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let a=0;a<this._activeAnimatables.length;a++)this._activeAnimatables[a].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const a of this.animationGroups)a.stop()};Scene.prototype._registerTargetForLateAnimationBinding=function(a,e){const t=a.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[a.targetPath]||(t._lateAnimationHolders[a.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),a.isAdditive?(t._lateAnimationHolders[a.targetPath].additiveAnimations.push(a),t._lateAnimationHolders[a.targetPath].totalAdditiveWeight+=a.weight):(t._lateAnimationHolders[a.targetPath].animations.push(a),t._lateAnimationHolders[a.targetPath].totalWeight+=a.weight)};Scene.prototype._processLateAnimationBindingsForMatrices=function(a){if(a.totalWeight===0&&a.totalAdditiveWeight===0)return a.originalValue;let e=1;const t=TmpVectors.Vector3[0],i=TmpVectors.Vector3[1],r=TmpVectors.Quaternion[0];let s=0;const n=a.animations[0],o=a.originalValue;let l=1,h=!1;if(a.totalWeight<1)l=1-a.totalWeight,o.decompose(i,r,t);else{if(s=1,e=a.totalWeight,l=n.weight/e,l==1)if(a.totalAdditiveWeight)h=!0;else return n.currentValue;n.currentValue.decompose(i,r,t)}if(!h){i.scaleInPlace(l),t.scaleInPlace(l),r.scaleInPlace(l);for(let c=s;c<a.animations.length;c++){const d=a.animations[c];if(d.weight===0)continue;l=d.weight/e;const f=TmpVectors.Vector3[2],_=TmpVectors.Vector3[3],g=TmpVectors.Quaternion[1];d.currentValue.decompose(_,g,f),_.scaleAndAddToRef(l,i),g.scaleAndAddToRef(Quaternion.Dot(r,g)>0?l:-l,r),f.scaleAndAddToRef(l,t)}r.normalize()}for(let c=0;c<a.additiveAnimations.length;c++){const d=a.additiveAnimations[c];if(d.weight===0)continue;const f=TmpVectors.Vector3[2],_=TmpVectors.Vector3[3],g=TmpVectors.Quaternion[1];d.currentValue.decompose(_,g,f),_.multiplyToRef(i,_),Vector3.LerpToRef(i,_,d.weight,i),r.multiplyToRef(g,g),Quaternion.SlerpToRef(r,g,d.weight,r),f.scaleAndAddToRef(d.weight,t)}const u=n?n._animationState.workValue:TmpVectors.Matrix[0].clone();return Matrix.ComposeToRef(i,r,t,u),u};Scene.prototype._processLateAnimationBindingsForQuaternions=function(a,e){if(a.totalWeight===0&&a.totalAdditiveWeight===0)return e;const t=a.animations[0],i=a.originalValue;let r=e;if(a.totalWeight===0&&a.totalAdditiveWeight>0)r.copyFrom(i);else if(a.animations.length===1){if(Quaternion.SlerpToRef(i,t.currentValue,Math.min(1,a.totalWeight),r),a.totalAdditiveWeight===0)return r}else if(a.animations.length>1){let s=1,n,o;if(a.totalWeight<1){const h=1-a.totalWeight;n=[],o=[],n.push(i),o.push(h)}else{if(a.animations.length===2&&(Quaternion.SlerpToRef(a.animations[0].currentValue,a.animations[1].currentValue,a.animations[1].weight/a.totalWeight,e),a.totalAdditiveWeight===0))return e;n=[],o=[],s=a.totalWeight}for(let h=0;h<a.animations.length;h++){const u=a.animations[h];n.push(u.currentValue),o.push(u.weight/s)}let l=0;for(let h=0;h<n.length;){if(!h){Quaternion.SlerpToRef(n[h],n[h+1],o[h+1]/(o[h]+o[h+1]),e),r=e,l=o[h]+o[h+1],h+=2;continue}l+=o[h],Quaternion.SlerpToRef(r,n[h],o[h]/l,r),h++}}for(let s=0;s<a.additiveAnimations.length;s++){const n=a.additiveAnimations[s];n.weight!==0&&(r.multiplyToRef(n.currentValue,TmpVectors.Quaternion[0]),Quaternion.SlerpToRef(r,TmpVectors.Quaternion[0],n.weight,r))}return r};Scene.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let a=0;a<this._registeredForLateAnimationBindings.length;a++){const e=this._registeredForLateAnimationBindings.data[a];for(const t in e._lateAnimationHolders){const i=e._lateAnimationHolders[t],r=i.animations[0],s=i.originalValue;if(s==null)continue;const n=Animation.AllowMatrixDecomposeForInterpolation&&s.m;let o=e[t];if(n)o=this._processLateAnimationBindingsForMatrices(i);else if(s.w!==void 0)o=this._processLateAnimationBindingsForQuaternions(i,o||Quaternion.Identity());else{let h=0,u=1;if(i.totalWeight<1)r&&s.scale?o=s.scale(1-i.totalWeight):r?o=s*(1-i.totalWeight):s.clone?o=s.clone():o=s;else if(r){u=i.totalWeight;const c=r.weight/u;c!==1?r.currentValue.scale?o=r.currentValue.scale(c):o=r.currentValue*c:o=r.currentValue,h=1}for(let c=h;c<i.animations.length;c++){const d=i.animations[c],f=d.weight/u;if(f)d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,o):o+=d.currentValue*f;else continue}for(let c=0;c<i.additiveAnimations.length;c++){const d=i.additiveAnimations[c],f=d.weight;if(f)d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,o):o+=d.currentValue*f;else continue}}e[t]=o}e._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}};Bone.prototype.copyAnimationRange=function(a,e,t,i=!1,r=null){this.animations.length===0&&(this.animations.push(new Animation(this.name,"_matrix",a.animations[0].framePerSecond,Animation.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const s=a.animations[0].getRange(e);if(!s)return!1;const n=s.from,o=s.to,l=a.animations[0].getKeys(),h=a.length,u=a.getParent(),c=this.getParent(),d=i&&u&&h&&this.length&&h!==this.length,f=d&&c&&u?c.length/u.length:1,_=i&&!c&&r&&(r.x!==1||r.y!==1||r.z!==1),g=this.animations[0].getKeys();let p,m,E;for(let M=0,x=l.length;M<x;M++)p=l[M],p.frame>=n&&p.frame<=o&&(i?(E=p.value.clone(),d?(m=E.getTranslation(),E.setTranslation(m.scaleInPlace(f))):_&&r?(m=E.getTranslation(),E.setTranslation(m.multiplyInPlace(r))):E=p.value):E=p.value,g.push({frame:p.frame+t,value:E}));return this.animations[0].createRange(e,n+t,o+t),!0};class Light extends Node{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}constructor(e,t){super(e,t),this.diffuse=new Color3(1,1,1),this.specular=new Color3(1,1,1),this.falloffType=Light.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=Light.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new UniformBuffer(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=new Array,this.excludedMeshes=new Array,this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,r,s=!0){var n;const o=e.toString();let l=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+o),this._renderId!==t.getRenderId()||this._lastUseSpecular!==r||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=r;const h=this.getScaledIntensity();this.transferToEffect(i,o),this.diffuse.scaleToRef(h,TmpColors.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",TmpColors.Color3[0],this.range,o),r&&(this.specular.scaleToRef(h,TmpColors.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",TmpColors.Color3[1],this.radius,o)),l=!0}if(this.transferTexturesToEffect(i,o),t.shadowsEnabled&&this.shadowEnabled&&s){const h=(n=this.getShadowGenerator(t.activeCamera))!==null&&n!==void 0?n:this.getShadowGenerator();h&&(h.bindShadowLight(o,i),l=!0)}l?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){var t;return this._shadowGenerators===null?null:(t=this._shadowGenerators.get(e))!==null&&t!==void 0?t:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return Vector3.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&!(this.includeOnlyWithLayerMask&e.layerMask)||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerators){const i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(const i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=Light.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const r=SerializationHelper.Clone(i,this);return e&&(r.name=e),t&&(r.parent=t),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r}serialize(){const e=SerializationHelper.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),SerializationHelper.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){const r=Node.Construct("Light_Type_"+e,t,i);return r||null}static Parse(e,t){const i=Light.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const r=SerializationHelper.Parse(i,e,t);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(r.falloffType=e.falloffType),e.lightmapMode!==void 0&&(r.lightmapMode=e.lightmapMode),e.animations){for(let s=0;s<e.animations.length;s++){const n=e.animations[s],o=GetClass("BABYLON.Animation");o&&r.animations.push(o.Parse(n))}Node.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r}_hookArrayForExcluded(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);for(const n of r)n._resyncLightSource(this);return s};const i=e.splice;e.splice=(r,s)=>{const n=i.apply(e,[r,s]);for(const o of n)o._resyncLightSource(this);return n};for(const r of e)r._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);return this._resyncMeshes(),s};const i=e.splice;e.splice=(r,s)=>{const n=i.apply(e,[r,s]);return this._resyncMeshes(),n},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===Light.INTENSITYMODE_AUTOMATIC&&(t===Light.LIGHTTYPEID_DIRECTIONALLIGHT?i=Light.INTENSITYMODE_ILLUMINANCE:i=Light.INTENSITYMODE_LUMINOUSINTENSITY),t){case Light.LIGHTTYPEID_POINTLIGHT:case Light.LIGHTTYPEID_SPOTLIGHT:switch(i){case Light.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case Light.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case Light.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case Light.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case Light.INTENSITYMODE_ILLUMINANCE:e=1;break;case Light.INTENSITYMODE_LUMINANCE:{let r=this.radius;r=Math.max(r,.001),e=2*Math.PI*(1-Math.cos(r));break}}break;case Light.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){const e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}Light.FALLOFF_DEFAULT=LightConstants.FALLOFF_DEFAULT;Light.FALLOFF_PHYSICAL=LightConstants.FALLOFF_PHYSICAL;Light.FALLOFF_GLTF=LightConstants.FALLOFF_GLTF;Light.FALLOFF_STANDARD=LightConstants.FALLOFF_STANDARD;Light.LIGHTMAP_DEFAULT=LightConstants.LIGHTMAP_DEFAULT;Light.LIGHTMAP_SPECULAR=LightConstants.LIGHTMAP_SPECULAR;Light.LIGHTMAP_SHADOWSONLY=LightConstants.LIGHTMAP_SHADOWSONLY;Light.INTENSITYMODE_AUTOMATIC=LightConstants.INTENSITYMODE_AUTOMATIC;Light.INTENSITYMODE_LUMINOUSPOWER=LightConstants.INTENSITYMODE_LUMINOUSPOWER;Light.INTENSITYMODE_LUMINOUSINTENSITY=LightConstants.INTENSITYMODE_LUMINOUSINTENSITY;Light.INTENSITYMODE_ILLUMINANCE=LightConstants.INTENSITYMODE_ILLUMINANCE;Light.INTENSITYMODE_LUMINANCE=LightConstants.INTENSITYMODE_LUMINANCE;Light.LIGHTTYPEID_POINTLIGHT=LightConstants.LIGHTTYPEID_POINTLIGHT;Light.LIGHTTYPEID_DIRECTIONALLIGHT=LightConstants.LIGHTTYPEID_DIRECTIONALLIGHT;Light.LIGHTTYPEID_SPOTLIGHT=LightConstants.LIGHTTYPEID_SPOTLIGHT;Light.LIGHTTYPEID_HEMISPHERICLIGHT=LightConstants.LIGHTTYPEID_HEMISPHERICLIGHT;__decorate([serializeAsColor3()],Light.prototype,"diffuse",void 0);__decorate([serializeAsColor3()],Light.prototype,"specular",void 0);__decorate([serialize()],Light.prototype,"falloffType",void 0);__decorate([serialize()],Light.prototype,"intensity",void 0);__decorate([serialize()],Light.prototype,"range",null);__decorate([serialize()],Light.prototype,"intensityMode",null);__decorate([serialize()],Light.prototype,"radius",null);__decorate([serialize()],Light.prototype,"_renderPriority",void 0);__decorate([expandToProperty("_reorderLightsInScene")],Light.prototype,"renderPriority",void 0);__decorate([serialize("shadowEnabled")],Light.prototype,"_shadowEnabled",void 0);__decorate([serialize("excludeWithLayerMask")],Light.prototype,"_excludeWithLayerMask",void 0);__decorate([serialize("includeOnlyWithLayerMask")],Light.prototype,"_includeOnlyWithLayerMask",void 0);__decorate([serialize("lightmapMode")],Light.prototype,"_lightmapMode",void 0);Node.AddNodeConstructor("Light_Type_3",(a,e)=>()=>new HemisphericLight(a,Vector3.Zero(),e));class HemisphericLight extends Light{constructor(e,t,i){super(e,i),this.groundColor=new Color3(0,0,0),this.direction=t||Vector3.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=Vector3.Normalize(e.subtract(Vector3.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=Vector3.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=Vector3.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=Matrix.Identity()),this._worldMatrix}getTypeID(){return Light.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}__decorate([serializeAsColor3()],HemisphericLight.prototype,"groundColor",void 0);__decorate([serializeAsVector3()],HemisphericLight.prototype,"direction",void 0);const convertRHSToLHS=Matrix.Compose(Vector3.One(),Quaternion.FromEulerAngles(0,Math.PI,0),Vector3.Zero());class TransformNode extends Node{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&TransformNode.BILLBOARDMODE_USE_POSITION)!==0,this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==TransformNode.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t),this._forward=new Vector3(0,0,1),this._up=new Vector3(0,1,0),this._right=new Vector3(1,0,0),this._position=Vector3.Zero(),this._rotation=Vector3.Zero(),this._rotationQuaternion=null,this._scaling=Vector3.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=TransformNode.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=Matrix.Zero(),this._usePivotMatrix=!1,this._absolutePosition=Vector3.Zero(),this._absoluteScaling=Vector3.Zero(),this._absoluteRotationQuaternion=Quaternion.Identity(),this._pivotMatrix=Matrix.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new Observable,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return Vector3.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return Vector3.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return Vector3.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=Matrix.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==TransformNode.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=Matrix.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);r&&i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.instantiateHierarchy(r,t,i);return r}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||Quaternion.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,r;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],r=arguments[2]}else t=e.x,i=e.y,r=e.z;if(this.parent){const s=TmpVectors.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),Vector3.TransformCoordinatesFromFloatsToRef(t,i,r,s,this.position)}else this.position.x=t,this.position.y=i,this.position.z=r;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=Vector3.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=TmpVectors.Matrix[0];return this._localMatrix.invertToRef(e),Vector3.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=Vector3.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,r=0,s=Space.LOCAL){const n=TransformNode._LookAtVectorCache,o=s===Space.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,n),this.setDirection(n,t,i,r),s===Space.WORLD&&this.parent)if(this.rotationQuaternion){const l=TmpVectors.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);const h=TmpVectors.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(h),h.invert(),l.multiplyToRef(h,l),this.rotationQuaternion.fromRotationMatrix(l)}else{const l=TmpVectors.Quaternion[0];Quaternion.FromEulerVectorToRef(this.rotation,l);const h=TmpVectors.Matrix[0];l.toRotationMatrix(h);const u=TmpVectors.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(u),u.invert(),h.multiplyToRef(u,h),l.fromRotationMatrix(h),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=Vector3.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return Vector3.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,r=0){const s=-Math.atan2(e.z,e.x)+Math.PI/2,n=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,n);return this.rotationQuaternion?Quaternion.RotationYawPitchRollToRef(s+t,o+i,r,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=s+t,this.rotation.z=r),this}setPivotPoint(e,t=Space.LOCAL){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==Space.WORLD){const r=TmpVectors.Matrix[0];i.invertToRef(r),e=Vector3.TransformCoordinates(e,r)}return this.setPivotMatrix(Matrix.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=Vector3.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=Vector3.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),Vector3.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const r=TmpVectors.Quaternion[0],s=TmpVectors.Vector3[0],n=TmpVectors.Vector3[1],o=TmpVectors.Matrix[1];Matrix.IdentityToRef(o);const l=TmpVectors.Matrix[0];this.computeWorldMatrix(!0);let h=this.rotationQuaternion;return h||(h=TransformNode._TmpRotation,Quaternion.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,h)),Matrix.ComposeToRef(this.scaling,h,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(n,r,s,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(n),this.position.copyFrom(s),this.parent=e,i&&this.setPivotMatrix(Matrix.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(),e.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let r;if(!i||i===Space.LOCAL)r=Quaternion.RotationAxisToRef(e,t,TransformNode._RotationAxisCache),this.rotationQuaternion.multiplyToRef(r,this.rotationQuaternion);else{if(this.parent){const s=TmpVectors.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),e=Vector3.TransformNormal(e,s)}r=Quaternion.RotationAxisToRef(e,t,TransformNode._RotationAxisCache),r.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const r=TmpVectors.Vector3[0],s=TmpVectors.Vector3[1],n=TmpVectors.Vector3[2],o=TmpVectors.Quaternion[0],l=TmpVectors.Matrix[0],h=TmpVectors.Matrix[1],u=TmpVectors.Matrix[2],c=TmpVectors.Matrix[3];return e.subtractToRef(this.position,r),Matrix.TranslationToRef(r.x,r.y,r.z,l),Matrix.TranslationToRef(-r.x,-r.y,-r.z,h),Matrix.RotationAxisToRef(t,i,u),h.multiplyToRef(u,c),c.multiplyToRef(l,c),c.decompose(s,o,n),this.position.addInPlace(n),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const r=e.scale(t);if(!i||i===Space.LOCAL){const s=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(s)}else this.setAbsolutePosition(this.getAbsolutePosition().add(r));return this}addRotation(e,t,i){let r;this.rotationQuaternion?r=this.rotationQuaternion:(r=TmpVectors.Quaternion[1],Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,r));const s=TmpVectors.Quaternion[0];return Quaternion.RotationYawPitchRollToRef(t,e,i,s),r.multiplyInPlace(s),this.rotationQuaternion||r.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==TransformNode.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const r=this._cache;r.pivotMatrixUpdated=!1,r.billboardMode=this.billboardMode,r.infiniteDistance=this.infiniteDistance,r.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const s=this._getEffectiveParent(),n=TransformNode._TmpScaling;let o=this._position;if(this._infiniteDistance&&!this.parent&&t){const h=t.getWorldMatrix(),u=new Vector3(h.m[12],h.m[13],h.m[14]);o=TransformNode._TmpTranslation,o.copyFromFloats(this._position.x+u.x,this._position.y+u.y,this._position.z+u.z)}n.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let l;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,l=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(Quaternion.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(l=TransformNode._TmpRotation,Quaternion.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),this._usePivotMatrix){const h=TmpVectors.Matrix[1];Matrix.ScalingToRef(n.x,n.y,n.z,h);const u=TmpVectors.Matrix[0];l.toRotationMatrix(u),this._pivotMatrix.multiplyToRef(h,TmpVectors.Matrix[4]),TmpVectors.Matrix[4].multiplyToRef(u,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(o.x,o.y,o.z)}else Matrix.ComposeToRef(n,l,o,this._localMatrix);if(s&&s.getWorldMatrix){if(e&&s.computeWorldMatrix(e),r.useBillboardPath){this._transformToBoneReferal?s.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),TmpVectors.Matrix[7]):TmpVectors.Matrix[7].copyFrom(s.getWorldMatrix());const h=TmpVectors.Vector3[5],u=TmpVectors.Vector3[6],c=TmpVectors.Quaternion[0];TmpVectors.Matrix[7].decompose(u,c,h),Matrix.ScalingToRef(u.x,u.y,u.z,TmpVectors.Matrix[7]),TmpVectors.Matrix[7].setTranslation(h),TransformNode.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(c,h),this._localMatrix.setTranslation(h)),this._localMatrix.multiplyToRef(TmpVectors.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(s.getWorldMatrix(),TmpVectors.Matrix[6]),TmpVectors.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(s.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(r.useBillboardPath&&t&&this.billboardMode&&!r.useBillboardPosition){const h=TmpVectors.Vector3[0];if(this._worldMatrix.getTranslationToRef(h),TmpVectors.Matrix[1].copyFrom(t.getViewMatrix()),this._scene.useRightHandedSystem&&TmpVectors.Matrix[1].multiplyToRef(convertRHSToLHS,TmpVectors.Matrix[1]),TmpVectors.Matrix[1].setTranslationFromFloats(0,0,0),TmpVectors.Matrix[1].invertToRef(TmpVectors.Matrix[0]),(this.billboardMode&TransformNode.BILLBOARDMODE_ALL)!==TransformNode.BILLBOARDMODE_ALL){TmpVectors.Matrix[0].decompose(void 0,TmpVectors.Quaternion[0],void 0);const u=TmpVectors.Vector3[1];TmpVectors.Quaternion[0].toEulerAnglesToRef(u),(this.billboardMode&TransformNode.BILLBOARDMODE_X)!==TransformNode.BILLBOARDMODE_X&&(u.x=0),(this.billboardMode&TransformNode.BILLBOARDMODE_Y)!==TransformNode.BILLBOARDMODE_Y&&(u.y=0),(this.billboardMode&TransformNode.BILLBOARDMODE_Z)!==TransformNode.BILLBOARDMODE_Z&&(u.z=0),Matrix.RotationYawPitchRollToRef(u.y,u.x,u.z,TmpVectors.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(TmpVectors.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(TmpVectors.Vector3[0])}else if(r.useBillboardPath&&t&&r.useBillboardPosition){const h=TmpVectors.Vector3[0];this._worldMatrix.getTranslationToRef(h);const u=t.globalPosition;this._worldMatrix.invertToRef(TmpVectors.Matrix[1]);const c=TmpVectors.Vector3[1];Vector3.TransformCoordinatesToRef(u,TmpVectors.Matrix[1],c),c.normalize();const d=-Math.atan2(c.z,c.x)+Math.PI/2,f=Math.sqrt(c.x*c.x+c.z*c.z),_=-Math.atan2(c.y,f);if(Quaternion.RotationYawPitchRollToRef(d,_,0,TmpVectors.Quaternion[0]),(this.billboardMode&TransformNode.BILLBOARDMODE_ALL)!==TransformNode.BILLBOARDMODE_ALL){const g=TmpVectors.Vector3[1];TmpVectors.Quaternion[0].toEulerAnglesToRef(g),(this.billboardMode&TransformNode.BILLBOARDMODE_X)!==TransformNode.BILLBOARDMODE_X&&(g.x=0),(this.billboardMode&TransformNode.BILLBOARDMODE_Y)!==TransformNode.BILLBOARDMODE_Y&&(g.y=0),(this.billboardMode&TransformNode.BILLBOARDMODE_Z)!==TransformNode.BILLBOARDMODE_Z&&(g.z=0),Matrix.RotationYawPitchRollToRef(g.y,g.x,g.z,TmpVectors.Matrix[0])}else Matrix.FromQuaternionToRef(TmpVectors.Quaternion[0],TmpVectors.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(TmpVectors.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(TmpVectors.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):s&&s._nonUniformScaling?this._updateNonUniformScalingState(s._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=Matrix.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const t=this.getChildren();for(let i=0;i<t.length;++i){const r=t[i];if(r){r.computeWorldMatrix();const s=TmpVectors.Matrix[0];r._localMatrix.multiplyToRef(this._localMatrix,s);const n=TmpVectors.Quaternion[0];s.decompose(r.scaling,n,r.position),r.rotationQuaternion?r.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(r.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=Quaternion.Identity()),this._worldMatrix=Matrix.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),Vector3.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const r=SerializationHelper.Clone(()=>new TransformNode(e,this.getScene()),this);if(r.name=e,r.id=e,t&&(r.parent=t),!i){const s=this.getDescendants(!0);for(let n=0;n<s.length;n++){const o=s[n];o.clone&&o.clone(e+"."+o.name,r)}}return r}serialize(e){const t=SerializationHelper.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}static Parse(e,t,i){const r=SerializationHelper.Parse(()=>new TransformNode(e.name,t),e,t,i);return e.localMatrix?r.setPreTransformMatrix(Matrix.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(Matrix.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),r}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r instanceof TransformNode),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const i=this.getChildTransformNodes(!0);for(const r of i)r.parent=null,r.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let r=null,s=null;t&&(this.rotationQuaternion?(s=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(r=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const n=this.getHierarchyBoundingVectors(e,i),o=n.max.subtract(n.min),l=Math.max(o.x,o.y,o.z);if(l===0)return this;const h=1/l;return this.scaling.scaleInPlace(h),t&&(this.rotationQuaternion&&s?this.rotationQuaternion.copyFrom(s):this.rotation&&r&&this.rotation.copyFrom(r)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}TransformNode.BILLBOARDMODE_NONE=0;TransformNode.BILLBOARDMODE_X=1;TransformNode.BILLBOARDMODE_Y=2;TransformNode.BILLBOARDMODE_Z=4;TransformNode.BILLBOARDMODE_ALL=7;TransformNode.BILLBOARDMODE_USE_POSITION=128;TransformNode.BillboardUseParentOrientation=!1;TransformNode._TmpRotation=Quaternion.Zero();TransformNode._TmpScaling=Vector3.Zero();TransformNode._TmpTranslation=Vector3.Zero();TransformNode._LookAtVectorCache=new Vector3(0,0,0);TransformNode._RotationAxisCache=new Quaternion;__decorate([serializeAsVector3("position")],TransformNode.prototype,"_position",void 0);__decorate([serializeAsVector3("rotation")],TransformNode.prototype,"_rotation",void 0);__decorate([serializeAsQuaternion("rotationQuaternion")],TransformNode.prototype,"_rotationQuaternion",void 0);__decorate([serializeAsVector3("scaling")],TransformNode.prototype,"_scaling",void 0);__decorate([serialize("billboardMode")],TransformNode.prototype,"_billboardMode",void 0);__decorate([serialize()],TransformNode.prototype,"scalingDeterminant",void 0);__decorate([serialize("infiniteDistance")],TransformNode.prototype,"_infiniteDistance",void 0);__decorate([serialize()],TransformNode.prototype,"ignoreNonUniformScaling",void 0);__decorate([serialize()],TransformNode.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class ValueAndUnit{constructor(e,t=ValueAndUnit.UNITMODE_PIXEL,i=!0){this.negativeValueAllowed=i,this._value=1,this._unit=ValueAndUnit.UNITMODE_PIXEL,this.ignoreAdaptiveScaling=!1,this.onChangedObservable=new Observable,this._value=e,this._unit=t,this._originalUnit=t}get isPercentage(){return this._unit===ValueAndUnit.UNITMODE_PERCENTAGE}get isPixel(){return this._unit===ValueAndUnit.UNITMODE_PIXEL}get internalValue(){return this._value}get value(){return this._value}set value(e){e!==this._value&&(this._value=e,this.onChangedObservable.notifyObservers())}get unit(){return this._unit}set unit(e){e!==this._unit&&(this._unit=e,this.onChangedObservable.notifyObservers())}getValueInPixel(e,t){return this.isPixel?this.getValue(e):this.getValue(e)*t}updateInPlace(e,t=ValueAndUnit.UNITMODE_PIXEL){return(this.value!==e||this.unit!==t)&&(this._value=e,this._unit=t,this.onChangedObservable.notifyObservers()),this}getValue(e){if(e&&!this.ignoreAdaptiveScaling&&this.unit!==ValueAndUnit.UNITMODE_PERCENTAGE){let t=0,i=0;if(e.idealWidth&&(t=Math.ceil(this._value*e.getSize().width/e.idealWidth)),e.idealHeight&&(i=Math.ceil(this._value*e.getSize().height/e.idealHeight)),e.useSmallestIdeal&&e.idealWidth&&e.idealHeight)return window.innerWidth<window.innerHeight?t:i;if(e.idealWidth)return t;if(e.idealHeight)return i}return this._value}toString(e,t){switch(this._unit){case ValueAndUnit.UNITMODE_PERCENTAGE:{const i=this.getValue(e)*100;return(t?i.toFixed(t):i)+"%"}case ValueAndUnit.UNITMODE_PIXEL:{const i=this.getValue(e);return(t?i.toFixed(t):i)+"px"}}return this._unit.toString()}fromString(e){const t=ValueAndUnit._Regex.exec(e.toString());if(!t||t.length===0)return!1;let i=parseFloat(t[1]),r=this._originalUnit;if(this.negativeValueAllowed||i<0&&(i=0),t.length===4)switch(t[3]){case"px":r=ValueAndUnit.UNITMODE_PIXEL;break;case"%":r=ValueAndUnit.UNITMODE_PERCENTAGE,i/=100;break}return i===this._value&&r===this._unit?!1:(this._value=i,this._unit=r,this.onChangedObservable.notifyObservers(),!0)}static get UNITMODE_PERCENTAGE(){return ValueAndUnit._UNITMODE_PERCENTAGE}static get UNITMODE_PIXEL(){return ValueAndUnit._UNITMODE_PIXEL}}ValueAndUnit._Regex=/(^-?\d*(\.\d+)?)(%|px)?/;ValueAndUnit._UNITMODE_PERCENTAGE=0;ValueAndUnit._UNITMODE_PIXEL=1;const tmpRect=[new Vector2(0,0),new Vector2(0,0),new Vector2(0,0),new Vector2(0,0)],tmpRect2=[new Vector2(0,0),new Vector2(0,0),new Vector2(0,0),new Vector2(0,0)],tmpV1=new Vector2(0,0),tmpV2=new Vector2(0,0);class Measure{constructor(e,t,i,r){this.left=e,this.top=t,this.width=i,this.height=r}copyFrom(e){this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height}copyFromFloats(e,t,i,r){this.left=e,this.top=t,this.width=i,this.height=r}static CombineToRef(e,t,i){const r=Math.min(e.left,t.left),s=Math.min(e.top,t.top),n=Math.max(e.left+e.width,t.left+t.width),o=Math.max(e.top+e.height,t.top+t.height);i.left=r,i.top=s,i.width=n-r,i.height=o-s}addAndTransformToRef(e,t,i,r,s,n){const o=this.left+t,l=this.top+i,h=this.width+r,u=this.height+s;tmpRect[0].copyFromFloats(o,l),tmpRect[1].copyFromFloats(o+h,l),tmpRect[2].copyFromFloats(o+h,l+u),tmpRect[3].copyFromFloats(o,l+u),tmpV1.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE),tmpV2.copyFromFloats(0,0);for(let c=0;c<4;c++)e.transformCoordinates(tmpRect[c].x,tmpRect[c].y,tmpRect2[c]),tmpV1.x=Math.floor(Math.min(tmpV1.x,tmpRect2[c].x)),tmpV1.y=Math.floor(Math.min(tmpV1.y,tmpRect2[c].y)),tmpV2.x=Math.ceil(Math.max(tmpV2.x,tmpRect2[c].x)),tmpV2.y=Math.ceil(Math.max(tmpV2.y,tmpRect2[c].y));n.left=tmpV1.x,n.top=tmpV1.y,n.width=tmpV2.x-tmpV1.x,n.height=tmpV2.y-tmpV1.y}transformToRef(e,t){this.addAndTransformToRef(e,0,0,0,0,t)}isEqualsTo(e){return!(this.left!==e.left||this.top!==e.top||this.width!==e.width||this.height!==e.height)}static Empty(){return new Measure(0,0,0,0)}}class Vector2WithInfo extends Vector2{constructor(e,t=0){super(e.x,e.y),this.buttonIndex=t}}class Matrix2D{constructor(e,t,i,r,s,n){this.m=new Float32Array(6),this.fromValues(e,t,i,r,s,n)}fromValues(e,t,i,r,s,n){return this.m[0]=e,this.m[1]=t,this.m[2]=i,this.m[3]=r,this.m[4]=s,this.m[5]=n,this}determinant(){return this.m[0]*this.m[3]-this.m[1]*this.m[2]}invertToRef(e){const t=this.m[0],i=this.m[1],r=this.m[2],s=this.m[3],n=this.m[4],o=this.m[5],l=this.determinant();if(l<Epsilon*Epsilon)return e.m[0]=0,e.m[1]=0,e.m[2]=0,e.m[3]=0,e.m[4]=0,e.m[5]=0,this;const h=1/l,u=r*o-s*n,c=i*n-t*o;return e.m[0]=s*h,e.m[1]=-i*h,e.m[2]=-r*h,e.m[3]=t*h,e.m[4]=u*h,e.m[5]=c*h,this}multiplyToRef(e,t){const i=this.m[0],r=this.m[1],s=this.m[2],n=this.m[3],o=this.m[4],l=this.m[5],h=e.m[0],u=e.m[1],c=e.m[2],d=e.m[3],f=e.m[4],_=e.m[5];return t.m[0]=i*h+r*c,t.m[1]=i*u+r*d,t.m[2]=s*h+n*c,t.m[3]=s*u+n*d,t.m[4]=o*h+l*c+f,t.m[5]=o*u+l*d+_,this}transformCoordinates(e,t,i){return i.x=e*this.m[0]+t*this.m[2]+this.m[4],i.y=e*this.m[1]+t*this.m[3]+this.m[5],this}static Identity(){return new Matrix2D(1,0,0,1,0,0)}static IdentityToRef(e){e.m[0]=1,e.m[1]=0,e.m[2]=0,e.m[3]=1,e.m[4]=0,e.m[5]=0}static TranslationToRef(e,t,i){i.fromValues(1,0,0,1,e,t)}static ScalingToRef(e,t,i){i.fromValues(e,0,0,t,0,0)}static RotationToRef(e,t){const i=Math.sin(e),r=Math.cos(e);t.fromValues(r,i,-i,r,0,0)}static ComposeToRef(e,t,i,r,s,n,o){Matrix2D.TranslationToRef(e,t,Matrix2D._TempPreTranslationMatrix),Matrix2D.ScalingToRef(r,s,Matrix2D._TempScalingMatrix),Matrix2D.RotationToRef(i,Matrix2D._TempRotationMatrix),Matrix2D.TranslationToRef(-e,-t,Matrix2D._TempPostTranslationMatrix),Matrix2D._TempPreTranslationMatrix.multiplyToRef(Matrix2D._TempScalingMatrix,Matrix2D._TempCompose0),Matrix2D._TempCompose0.multiplyToRef(Matrix2D._TempRotationMatrix,Matrix2D._TempCompose1),n?(Matrix2D._TempCompose1.multiplyToRef(Matrix2D._TempPostTranslationMatrix,Matrix2D._TempCompose2),Matrix2D._TempCompose2.multiplyToRef(n,o)):Matrix2D._TempCompose1.multiplyToRef(Matrix2D._TempPostTranslationMatrix,o)}}Matrix2D._TempPreTranslationMatrix=Matrix2D.Identity();Matrix2D._TempPostTranslationMatrix=Matrix2D.Identity();Matrix2D._TempRotationMatrix=Matrix2D.Identity();Matrix2D._TempScalingMatrix=Matrix2D.Identity();Matrix2D._TempCompose0=Matrix2D.Identity();Matrix2D._TempCompose1=Matrix2D.Identity();Matrix2D._TempCompose2=Matrix2D.Identity();class Control{get isReadOnly(){return this._isReadOnly}set isReadOnly(e){this._isReadOnly=e}get transformedMeasure(){return this._evaluatedMeasure}set clipChildren(e){this._clipChildren=e}get clipChildren(){return this._clipChildren}set clipContent(e){this._clipContent=e}get clipContent(){return this._clipContent}get shadowOffsetX(){return this._shadowOffsetX}set shadowOffsetX(e){this._shadowOffsetX!==e&&(this._shadowOffsetX=e,this._markAsDirty())}get shadowOffsetY(){return this._shadowOffsetY}set shadowOffsetY(e){this._shadowOffsetY!==e&&(this._shadowOffsetY=e,this._markAsDirty())}get shadowBlur(){return this._shadowBlur}set shadowBlur(e){this._shadowBlur!==e&&(this._previousShadowBlur=this._shadowBlur,this._shadowBlur=e,this._markAsDirty())}get shadowColor(){return this._shadowColor}set shadowColor(e){this._shadowColor!==e&&(this._shadowColor=e,this._markAsDirty())}get typeName(){return this._getTypeName()}getClassName(){return this._getTypeName()}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get host(){return this._host}get fontOffset(){return this._fontOffset}set fontOffset(e){this._fontOffset=e}get alpha(){return this._alpha}set alpha(e){this._alpha!==e&&(this._alphaSet=!0,this._alpha=e,this._markAsDirty())}get highlightLineWidth(){return this._highlightLineWidth}set highlightLineWidth(e){this._highlightLineWidth!==e&&(this._highlightLineWidth=e,this._markAsDirty())}get isHighlighted(){return this._isHighlighted}set isHighlighted(e){this._isHighlighted!==e&&(this._isHighlighted=e,this._markAsDirty())}get highlightColor(){return this._highlightColor}set highlightColor(e){this._highlightColor!==e&&(this._highlightColor=e,this._markAsDirty())}get scaleX(){return this._scaleX}set scaleX(e){this._scaleX!==e&&(this._scaleX=e,this._markAsDirty(),this._markMatrixAsDirty())}get scaleY(){return this._scaleY}set scaleY(e){this._scaleY!==e&&(this._scaleY=e,this._markAsDirty(),this._markMatrixAsDirty())}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._markAsDirty(),this._markMatrixAsDirty())}get transformCenterY(){return this._transformCenterY}set transformCenterY(e){this._transformCenterY!==e&&(this._transformCenterY=e,this._markAsDirty(),this._markMatrixAsDirty())}get transformCenterX(){return this._transformCenterX}set transformCenterX(e){this._transformCenterX!==e&&(this._transformCenterX=e,this._markAsDirty(),this._markMatrixAsDirty())}get horizontalAlignment(){return this._horizontalAlignment}set horizontalAlignment(e){this._horizontalAlignment!==e&&(this._horizontalAlignment=e,this._markAsDirty())}get verticalAlignment(){return this._verticalAlignment}set verticalAlignment(e){this._verticalAlignment!==e&&(this._verticalAlignment=e,this._markAsDirty())}set fixedRatio(e){this._fixedRatio!==e&&(this._fixedRatio=e,this._markAsDirty())}get fixedRatio(){return this._fixedRatio}set fixedRatioMasterIsWidth(e){this._fixedRatioMasterIsWidth!==e&&(this._fixedRatioMasterIsWidth=e,this._markAsDirty())}get fixedRatioMasterIsWidth(){return this._fixedRatioMasterIsWidth}get width(){return this._width.toString(this._host)}set width(e){this._fixedRatioMasterIsWidth=!0,this._width.toString(this._host)!==e&&this._width.fromString(e)&&this._markAsDirty()}get widthInPixels(){return this._width.getValueInPixel(this._host,this._cachedParentMeasure.width)}set widthInPixels(e){isNaN(e)||(this._fixedRatioMasterIsWidth=!0,this.width=e+"px")}get height(){return this._height.toString(this._host)}set height(e){this._fixedRatioMasterIsWidth=!1,this._height.toString(this._host)!==e&&this._height.fromString(e)&&this._markAsDirty()}get heightInPixels(){return this._height.getValueInPixel(this._host,this._cachedParentMeasure.height)}set heightInPixels(e){isNaN(e)||(this._fixedRatioMasterIsWidth=!1,this.height=e+"px")}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this._resetFontCache())}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle!==e&&(this._fontStyle=e,this._resetFontCache())}get fontWeight(){return this._fontWeight}set fontWeight(e){this._fontWeight!==e&&(this._fontWeight=e,this._resetFontCache())}get style(){return this._style}set style(e){this._style&&(this._style.onChangedObservable.remove(this._styleObserver),this._styleObserver=null),this._style=e,this._style&&(this._styleObserver=this._style.onChangedObservable.add(()=>{this._markAsDirty(),this._resetFontCache()})),this._markAsDirty(),this._resetFontCache()}get _isFontSizeInPercentage(){return this._fontSize.isPercentage}get fontSizeInPixels(){const e=this._style?this._style._fontSize:this._fontSize;return e.isPixel?e.getValue(this._host):e.getValueInPixel(this._host,this._tempParentMeasure.height||this._cachedParentMeasure.height)}set fontSizeInPixels(e){isNaN(e)||(this.fontSize=e+"px")}get fontSize(){return this._fontSize.toString(this._host)}set fontSize(e){this._fontSize.toString(this._host)!==e&&this._fontSize.fromString(e)&&(this._markAsDirty(),this._resetFontCache())}get color(){return this._color}set color(e){this._color!==e&&(this._color=e,this._markAsDirty())}get gradient(){return this._gradient}set gradient(e){this._gradient!==e&&(this._gradient=e,this._markAsDirty())}get zIndex(){return this._zIndex}set zIndex(e){this.zIndex!==e&&(this._zIndex=e,this.parent&&this.parent._reOrderControl(this))}get notRenderable(){return this._doNotRender}set notRenderable(e){this._doNotRender!==e&&(this._doNotRender=e,this._markAsDirty())}get isVisible(){return this._isVisible}set isVisible(e){this._isVisible!==e&&(this._isVisible=e,this._markAsDirty(!0),this.onIsVisibleChangedObservable.notifyObservers(e))}get isDirty(){return this._isDirty}get linkedMesh(){return this._linkedMesh}get descendantsOnlyPadding(){return this._descendantsOnlyPadding}set descendantsOnlyPadding(e){this._descendantsOnlyPadding!==e&&(this._descendantsOnlyPadding=e,this._markAsDirty())}get paddingLeft(){return this._paddingLeft.toString(this._host)}set paddingLeft(e){this._paddingLeft.fromString(e)&&this._markAsDirty()}get paddingLeftInPixels(){return this._paddingLeft.getValueInPixel(this._host,this._cachedParentMeasure.width)}set paddingLeftInPixels(e){isNaN(e)||(this.paddingLeft=e+"px")}get _paddingLeftInPixels(){return this._descendantsOnlyPadding?0:this.paddingLeftInPixels}get paddingRight(){return this._paddingRight.toString(this._host)}set paddingRight(e){this._paddingRight.fromString(e)&&this._markAsDirty()}get paddingRightInPixels(){return this._paddingRight.getValueInPixel(this._host,this._cachedParentMeasure.width)}set paddingRightInPixels(e){isNaN(e)||(this.paddingRight=e+"px")}get _paddingRightInPixels(){return this._descendantsOnlyPadding?0:this.paddingRightInPixels}get paddingTop(){return this._paddingTop.toString(this._host)}set paddingTop(e){this._paddingTop.fromString(e)&&this._markAsDirty()}get paddingTopInPixels(){return this._paddingTop.getValueInPixel(this._host,this._cachedParentMeasure.height)}set paddingTopInPixels(e){isNaN(e)||(this.paddingTop=e+"px")}get _paddingTopInPixels(){return this._descendantsOnlyPadding?0:this.paddingTopInPixels}get paddingBottom(){return this._paddingBottom.toString(this._host)}set paddingBottom(e){this._paddingBottom.fromString(e)&&this._markAsDirty()}get paddingBottomInPixels(){return this._paddingBottom.getValueInPixel(this._host,this._cachedParentMeasure.height)}set paddingBottomInPixels(e){isNaN(e)||(this.paddingBottom=e+"px")}get _paddingBottomInPixels(){return this._descendantsOnlyPadding?0:this.paddingBottomInPixels}get left(){return this._left.toString(this._host)}set left(e){this._left.fromString(e)&&this._markAsDirty()}get leftInPixels(){return this._left.getValueInPixel(this._host,this._cachedParentMeasure.width)}set leftInPixels(e){isNaN(e)||(this.left=e+"px")}get top(){return this._top.toString(this._host)}set top(e){this._top.fromString(e)&&this._markAsDirty()}get topInPixels(){return this._top.getValueInPixel(this._host,this._cachedParentMeasure.height)}set topInPixels(e){isNaN(e)||(this.top=e+"px")}get linkOffsetX(){return this._linkOffsetX.toString(this._host)}set linkOffsetX(e){this._linkOffsetX.fromString(e)&&this._markAsDirty()}get linkOffsetXInPixels(){return this._linkOffsetX.getValueInPixel(this._host,this._cachedParentMeasure.width)}set linkOffsetXInPixels(e){isNaN(e)||(this.linkOffsetX=e+"px")}get linkOffsetY(){return this._linkOffsetY.toString(this._host)}set linkOffsetY(e){this._linkOffsetY.fromString(e)&&this._markAsDirty()}get linkOffsetYInPixels(){return this._linkOffsetY.getValueInPixel(this._host,this._cachedParentMeasure.height)}set linkOffsetYInPixels(e){isNaN(e)||(this.linkOffsetY=e+"px")}get centerX(){return this._currentMeasure.left+this._currentMeasure.width/2}get centerY(){return this._currentMeasure.top+this._currentMeasure.height/2}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled===e)return;this._isEnabled=e,this._markAsDirty();const t=i=>{if(i.host){for(const r in i.host._lastControlOver)i===this.host._lastControlOver[r]&&(i._onPointerOut(i,null,!0),delete i.host._lastControlOver[r]);i.children!==void 0&&i.children.forEach(t)}};t(this)}get disabledColor(){return this._disabledColor}set disabledColor(e){this._disabledColor!==e&&(this._disabledColor=e,this._markAsDirty())}get disabledColorItem(){return this._disabledColorItem}set disabledColorItem(e){this._disabledColorItem!==e&&(this._disabledColorItem=e,this._markAsDirty())}constructor(e){this.name=e,this._alpha=1,this._alphaSet=!1,this._zIndex=0,this._currentMeasure=Measure.Empty(),this._tempPaddingMeasure=Measure.Empty(),this._fontFamily="Arial",this._fontStyle="",this._fontWeight="",this._fontSize=new ValueAndUnit(18,ValueAndUnit.UNITMODE_PIXEL,!1),this._width=new ValueAndUnit(1,ValueAndUnit.UNITMODE_PERCENTAGE,!1),this._height=new ValueAndUnit(1,ValueAndUnit.UNITMODE_PERCENTAGE,!1),this._color="",this._style=null,this._horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,this._verticalAlignment=Control.VERTICAL_ALIGNMENT_CENTER,this._isDirty=!0,this._wasDirty=!1,this._tempParentMeasure=Measure.Empty(),this._prevCurrentMeasureTransformedIntoGlobalSpace=Measure.Empty(),this._cachedParentMeasure=Measure.Empty(),this._descendantsOnlyPadding=!1,this._paddingLeft=new ValueAndUnit(0),this._paddingRight=new ValueAndUnit(0),this._paddingTop=new ValueAndUnit(0),this._paddingBottom=new ValueAndUnit(0),this._left=new ValueAndUnit(0),this._top=new ValueAndUnit(0),this._scaleX=1,this._scaleY=1,this._rotation=0,this._transformCenterX=.5,this._transformCenterY=.5,this._transformMatrix=Matrix2D.Identity(),this._invertTransformMatrix=Matrix2D.Identity(),this._transformedPosition=Vector2.Zero(),this._isMatrixDirty=!0,this._isVisible=!0,this._isHighlighted=!1,this._highlightColor="#4affff",this._highlightLineWidth=2,this._fontSet=!1,this._dummyVector2=Vector2.Zero(),this._downCount=0,this._enterCount=-1,this._doNotRender=!1,this._downPointerIds={},this._evaluatedMeasure=new Measure(0,0,0,0),this._evaluatedParentMeasure=new Measure(0,0,0,0),this._isEnabled=!0,this._disabledColor="#9a9a9a",this._disabledColorItem="#6a6a6a",this._isReadOnly=!1,this._gradient=null,this._rebuildLayout=!1,this._customData={},this._isClipped=!1,this._automaticSize=!1,this.metadata=null,this.isHitTestVisible=!0,this.isPointerBlocker=!1,this.isFocusInvisible=!1,this._clipChildren=!0,this._clipContent=!0,this.useBitmapCache=!1,this._shadowOffsetX=0,this._shadowOffsetY=0,this._shadowBlur=0,this._previousShadowBlur=0,this._shadowColor="black",this.hoverCursor="",this._linkOffsetX=new ValueAndUnit(0),this._linkOffsetY=new ValueAndUnit(0),this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new Observable,this.onWheelObservable=new Observable,this.onPointerMoveObservable=new Observable,this.onPointerOutObservable=new Observable,this.onPointerDownObservable=new Observable,this.onPointerUpObservable=new Observable,this.onPointerClickObservable=new Observable,this.onPointerEnterObservable=new Observable,this.onDirtyObservable=new Observable,this.onBeforeDrawObservable=new Observable,this.onAfterDrawObservable=new Observable,this.onDisposeObservable=new Observable,this.onIsVisibleChangedObservable=new Observable,this._fixedRatio=0,this._fixedRatioMasterIsWidth=!0,this.animations=null,this._tmpMeasureA=new Measure(0,0,0,0)}_getTypeName(){return"Control"}getAscendantOfClass(e){return this.parent?this.parent.getClassName()===e?this.parent:this.parent.getAscendantOfClass(e):null}markAsDirty(e=!1){this._markAsDirty(e)}markAllAsDirty(){this._markAllAsDirty()}_resetFontCache(){this._fontSet=!0,this._markAsDirty()}isAscendant(e){return this.parent?this.parent===e?!0:this.parent.isAscendant(e):!1}getLocalCoordinates(e){const t=Vector2.Zero();return this.getLocalCoordinatesToRef(e,t),t}getLocalCoordinatesToRef(e,t){return t.x=e.x-this._currentMeasure.left,t.y=e.y-this._currentMeasure.top,this}getParentLocalCoordinates(e){const t=Vector2.Zero();return t.x=e.x-this._cachedParentMeasure.left,t.y=e.y-this._cachedParentMeasure.top,t}moveToVector3(e,t){if(!this._host||this.parent!==this._host._rootContainer){Tools.Error("Cannot move a control to a vector3 if the control is not at root level");return}this.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,this.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP;const i=this._host._getGlobalViewport(),r=Vector3.Project(e,Matrix.IdentityReadOnly,t.getTransformMatrix(),i);if(this._moveToProjectedPosition(r),r.z<0||r.z>1){this.notRenderable=!0;return}this.notRenderable=!1}getDescendantsToRef(e,t=!1,i){}getDescendants(e,t){const i=new Array;return this.getDescendantsToRef(i,e,t),i}linkWithMesh(e){if(!this._host||this.parent&&this.parent!==this._host._rootContainer){e&&Tools.Error("Cannot link a control to a mesh if the control is not at root level");return}const t=this._host._linkedControls.indexOf(this);if(t!==-1){this._linkedMesh=e,e||this._host._linkedControls.splice(t,1);return}else if(!e)return;this.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,this.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP,this._linkedMesh=e,this._host._linkedControls.push(this)}setPadding(e,t,i,r){const s=e,n=t??s,o=i??s,l=r??n;this.paddingTop=s,this.paddingRight=n,this.paddingBottom=o,this.paddingLeft=l}setPaddingInPixels(e,t,i,r){const s=e,n=t??s,o=i??s,l=r??n;this.paddingTopInPixels=s,this.paddingRightInPixels=n,this.paddingBottomInPixels=o,this.paddingLeftInPixels=l}_moveToProjectedPosition(e){var t;const i=this._left.getValue(this._host),r=this._top.getValue(this._host),s=(t=this.parent)===null||t===void 0?void 0:t._currentMeasure;s&&this._processMeasures(s,this._host.getContext());let n=e.x+this._linkOffsetX.getValue(this._host)-this._currentMeasure.width/2,o=e.y+this._linkOffsetY.getValue(this._host)-this._currentMeasure.height/2;const l=this._left.ignoreAdaptiveScaling&&this._top.ignoreAdaptiveScaling;l&&(Math.abs(n-i)<.5&&(n=i),Math.abs(o-r)<.5&&(o=r)),!(!l&&i===n&&r===o)&&(this.left=n+"px",this.top=o+"px",this._left.ignoreAdaptiveScaling=!0,this._top.ignoreAdaptiveScaling=!0,this._markAsDirty())}_offsetLeft(e){this._isDirty=!0,this._currentMeasure.left+=e}_offsetTop(e){this._isDirty=!0,this._currentMeasure.top+=e}_markMatrixAsDirty(){this._isMatrixDirty=!0,this._flagDescendantsAsMatrixDirty()}_flagDescendantsAsMatrixDirty(){}_intersectsRect(e,t){return this._transform(t),!(this._evaluatedMeasure.left>=e.left+e.width||this._evaluatedMeasure.top>=e.top+e.height||this._evaluatedMeasure.left+this._evaluatedMeasure.width<=e.left||this._evaluatedMeasure.top+this._evaluatedMeasure.height<=e.top)}_computeAdditionnalOffsetX(){return 0}_computeAdditionnalOffsetY(){return 0}invalidateRect(){if(this._transform(),this.host&&this.host.useInvalidateRectOptimization){this._currentMeasure.transformToRef(this._transformMatrix,this._tmpMeasureA),Measure.CombineToRef(this._tmpMeasureA,this._prevCurrentMeasureTransformedIntoGlobalSpace,this._tmpMeasureA);const e=this.shadowOffsetX,t=this.shadowOffsetY,i=Math.max(this._previousShadowBlur,this.shadowBlur),r=Math.min(Math.min(e,0)-i*2,0),s=Math.max(Math.max(e,0)+i*2,0),n=Math.min(Math.min(t,0)-i*2,0),o=Math.max(Math.max(t,0)+i*2,0),l=this._computeAdditionnalOffsetX(),h=this._computeAdditionnalOffsetY();this.host.invalidateRect(Math.floor(this._tmpMeasureA.left+r-l),Math.floor(this._tmpMeasureA.top+n-h),Math.ceil(this._tmpMeasureA.left+this._tmpMeasureA.width+s+l),Math.ceil(this._tmpMeasureA.top+this._tmpMeasureA.height+o+h))}}_markAsDirty(e=!1){!this._isVisible&&!e||(this._isDirty=!0,this._markMatrixAsDirty(),this._host&&this._host.markAsDirty())}_markAllAsDirty(){this._markAsDirty(),this._font&&this._prepareFont()}_link(e){this._host=e,this._host&&(this.uniqueId=this._host.getScene().getUniqueId())}_transform(e){if(!this._isMatrixDirty&&this._scaleX===1&&this._scaleY===1&&this._rotation===0)return;const t=this._currentMeasure.width*this._transformCenterX+this._currentMeasure.left,i=this._currentMeasure.height*this._transformCenterY+this._currentMeasure.top;e&&(e.translate(t,i),e.rotate(this._rotation),e.scale(this._scaleX,this._scaleY),e.translate(-t,-i)),(this._isMatrixDirty||this._cachedOffsetX!==t||this._cachedOffsetY!==i)&&(this._cachedOffsetX=t,this._cachedOffsetY=i,this._isMatrixDirty=!1,this._flagDescendantsAsMatrixDirty(),Matrix2D.ComposeToRef(-t,-i,this._rotation,this._scaleX,this._scaleY,this.parent?this.parent._transformMatrix:null,this._transformMatrix),this._transformMatrix.invertToRef(this._invertTransformMatrix),this._currentMeasure.transformToRef(this._transformMatrix,this._evaluatedMeasure))}_renderHighlight(e){this.isHighlighted&&(e.save(),e.strokeStyle=this._highlightColor,e.lineWidth=this._highlightLineWidth,this._renderHighlightSpecific(e),e.restore())}_renderHighlightSpecific(e){e.strokeRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)}_getColor(e){return this.gradient?this.gradient.getCanvasGradient(e):this.color}_applyStates(e){this._isFontSizeInPercentage&&(this._fontSet=!0),this._host&&this._host.useSmallestIdeal&&!this._font&&(this._fontSet=!0),this._fontSet&&(this._prepareFont(),this._fontSet=!1),this._font&&(e.font=this._font),(this._color||this.gradient)&&(e.fillStyle=this._getColor(e)),Control.AllowAlphaInheritance?e.globalAlpha*=this._alpha:this._alphaSet&&(e.globalAlpha=this.parent&&!this.parent.renderToIntermediateTexture?this.parent.alpha*this._alpha:this._alpha)}_layout(e,t){if(!this.isDirty&&(!this.isVisible||this.notRenderable))return!1;if(this._isDirty||!this._cachedParentMeasure.isEqualsTo(e)){this.host._numLayoutCalls++,this._currentMeasure.addAndTransformToRef(this._transformMatrix,-this._paddingLeftInPixels|0,-this._paddingTopInPixels|0,this._paddingRightInPixels|0,this._paddingBottomInPixels|0,this._prevCurrentMeasureTransformedIntoGlobalSpace),t.save(),this._applyStates(t);let i=0;do this._rebuildLayout=!1,this._processMeasures(e,t),i++;while(this._rebuildLayout&&i<3);i>=3&&Logger.Error(`Layout cycle detected in GUI (Control name=${this.name}, uniqueId=${this.uniqueId})`),t.restore(),this.invalidateRect(),this._evaluateClippingState(e)}return this._wasDirty=this._isDirty,this._isDirty=!1,!0}_processMeasures(e,t){this._tempPaddingMeasure.copyFrom(e),this.parent&&this.parent.descendantsOnlyPadding&&(this._tempPaddingMeasure.left+=this.parent.paddingLeftInPixels,this._tempPaddingMeasure.top+=this.parent.paddingTopInPixels,this._tempPaddingMeasure.width-=this.parent.paddingLeftInPixels+this.parent.paddingRightInPixels,this._tempPaddingMeasure.height-=this.parent.paddingTopInPixels+this.parent.paddingBottomInPixels),this._currentMeasure.copyFrom(this._tempPaddingMeasure),this._preMeasure(this._tempPaddingMeasure,t),this._measure(),this._computeAlignment(this._tempPaddingMeasure,t),this._currentMeasure.left=this._currentMeasure.left|0,this._currentMeasure.top=this._currentMeasure.top|0,this._currentMeasure.width=this._currentMeasure.width|0,this._currentMeasure.height=this._currentMeasure.height|0,this._additionalProcessing(this._tempPaddingMeasure,t),this._cachedParentMeasure.copyFrom(this._tempPaddingMeasure),this._currentMeasure.transformToRef(this._transformMatrix,this._evaluatedMeasure),this.onDirtyObservable.hasObservers()&&this.onDirtyObservable.notifyObservers(this)}_evaluateClippingState(e){if(this._transform(),this._currentMeasure.transformToRef(this._transformMatrix,this._evaluatedMeasure),this.parent&&this.parent.clipChildren){if(e.transformToRef(this.parent._transformMatrix,this._evaluatedParentMeasure),this._evaluatedMeasure.left>this._evaluatedParentMeasure.left+this._evaluatedParentMeasure.width){this._isClipped=!0;return}if(this._evaluatedMeasure.left+this._evaluatedMeasure.width<this._evaluatedParentMeasure.left){this._isClipped=!0;return}if(this._evaluatedMeasure.top>this._evaluatedParentMeasure.top+this._evaluatedParentMeasure.height){this._isClipped=!0;return}if(this._evaluatedMeasure.top+this._evaluatedMeasure.height<this._evaluatedParentMeasure.top){this._isClipped=!0;return}}this._isClipped=!1}_measure(){this._width.isPixel?this._currentMeasure.width=this._width.getValue(this._host):this._currentMeasure.width*=this._width.getValue(this._host),this._height.isPixel?this._currentMeasure.height=this._height.getValue(this._host):this._currentMeasure.height*=this._height.getValue(this._host),this._fixedRatio!==0&&(this._fixedRatioMasterIsWidth?this._currentMeasure.height=this._currentMeasure.width*this._fixedRatio:this._currentMeasure.width=this._currentMeasure.height*this._fixedRatio)}_computeAlignment(e,t){const i=this._currentMeasure.width,r=this._currentMeasure.height,s=e.width,n=e.height;let o=0,l=0;switch(this.horizontalAlignment){case Control.HORIZONTAL_ALIGNMENT_LEFT:o=0;break;case Control.HORIZONTAL_ALIGNMENT_RIGHT:o=s-i;break;case Control.HORIZONTAL_ALIGNMENT_CENTER:o=(s-i)/2;break}switch(this.verticalAlignment){case Control.VERTICAL_ALIGNMENT_TOP:l=0;break;case Control.VERTICAL_ALIGNMENT_BOTTOM:l=n-r;break;case Control.VERTICAL_ALIGNMENT_CENTER:l=(n-r)/2;break}this.descendantsOnlyPadding||(this._paddingLeft.isPixel?(this._currentMeasure.left+=this._paddingLeft.getValue(this._host),this._currentMeasure.width-=this._paddingLeft.getValue(this._host)):(this._currentMeasure.left+=s*this._paddingLeft.getValue(this._host),this._currentMeasure.width-=s*this._paddingLeft.getValue(this._host)),this._paddingRight.isPixel?this._currentMeasure.width-=this._paddingRight.getValue(this._host):this._currentMeasure.width-=s*this._paddingRight.getValue(this._host),this._paddingTop.isPixel?(this._currentMeasure.top+=this._paddingTop.getValue(this._host),this._currentMeasure.height-=this._paddingTop.getValue(this._host)):(this._currentMeasure.top+=n*this._paddingTop.getValue(this._host),this._currentMeasure.height-=n*this._paddingTop.getValue(this._host)),this._paddingBottom.isPixel?this._currentMeasure.height-=this._paddingBottom.getValue(this._host):this._currentMeasure.height-=n*this._paddingBottom.getValue(this._host)),this._left.isPixel?this._currentMeasure.left+=this._left.getValue(this._host):this._currentMeasure.left+=s*this._left.getValue(this._host),this._top.isPixel?this._currentMeasure.top+=this._top.getValue(this._host):this._currentMeasure.top+=n*this._top.getValue(this._host),this._currentMeasure.left+=o,this._currentMeasure.top+=l}_preMeasure(e,t){}_additionalProcessing(e,t){}_clipForChildren(e){}_clip(e,t){if(e.beginPath(),Control._ClipMeasure.copyFrom(this._currentMeasure),t){t.transformToRef(this._invertTransformMatrix,this._tmpMeasureA);const i=new Measure(0,0,0,0);i.left=Math.max(this._tmpMeasureA.left,this._currentMeasure.left),i.top=Math.max(this._tmpMeasureA.top,this._currentMeasure.top),i.width=Math.min(this._tmpMeasureA.left+this._tmpMeasureA.width,this._currentMeasure.left+this._currentMeasure.width)-i.left,i.height=Math.min(this._tmpMeasureA.top+this._tmpMeasureA.height,this._currentMeasure.top+this._currentMeasure.height)-i.top,Control._ClipMeasure.copyFrom(i)}if(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY){const i=this.shadowOffsetX,r=this.shadowOffsetY,s=this.shadowBlur,n=Math.min(Math.min(i,0)-s*2,0),o=Math.max(Math.max(i,0)+s*2,0),l=Math.min(Math.min(r,0)-s*2,0),h=Math.max(Math.max(r,0)+s*2,0);e.rect(Control._ClipMeasure.left+n,Control._ClipMeasure.top+l,Control._ClipMeasure.width+o-n,Control._ClipMeasure.height+h-l)}else e.rect(Control._ClipMeasure.left,Control._ClipMeasure.top,Control._ClipMeasure.width,Control._ClipMeasure.height);e.clip()}_render(e,t){return!this.isVisible||this.notRenderable||this._isClipped?(this._isDirty=!1,!1):(this.host._numRenderCalls++,e.save(),this._applyStates(e),this._transform(e),this.clipContent&&this._clip(e,t),this.onBeforeDrawObservable.hasObservers()&&this.onBeforeDrawObservable.notifyObservers(this),this.useBitmapCache&&!this._wasDirty&&this._cacheData?e.putImageData(this._cacheData,this._currentMeasure.left,this._currentMeasure.top):this._draw(e,t),this.useBitmapCache&&this._wasDirty&&(this._cacheData=e.getImageData(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),this._renderHighlight(e),this.onAfterDrawObservable.hasObservers()&&this.onAfterDrawObservable.notifyObservers(this),e.restore(),!0)}_draw(e,t){}contains(e,t){return this._invertTransformMatrix.transformCoordinates(e,t,this._transformedPosition),e=this._transformedPosition.x,t=this._transformedPosition.y,e<this._currentMeasure.left||e>this._currentMeasure.left+this._currentMeasure.width||t<this._currentMeasure.top||t>this._currentMeasure.top+this._currentMeasure.height?!1:(this.isPointerBlocker&&(this._host._shouldBlockPointer=!0),!0)}_processPicking(e,t,i,r,s,n,o,l){return!this._isEnabled||!this.isHitTestVisible||!this.isVisible||this._doNotRender||!this.contains(e,t)?!1:(this._processObservables(r,e,t,i,s,n,o,l),!0)}_onPointerMove(e,t,i,r){this.onPointerMoveObservable.notifyObservers(t,-1,e,this,r)&&this.parent!=null&&!this.isPointerBlocker&&this.parent._onPointerMove(e,t,i,r)}_onPointerEnter(e,t){return!this._isEnabled||this._enterCount>0?!1:(this._enterCount===-1&&(this._enterCount=0),this._enterCount++,this.onPointerEnterObservable.notifyObservers(this,-1,e,this,t)&&this.parent!=null&&!this.isPointerBlocker&&this.parent._onPointerEnter(e,t),!0)}_onPointerOut(e,t,i=!1){if(!i&&(!this._isEnabled||e===this))return;this._enterCount=0;let r=!0;e.isAscendant(this)||(r=this.onPointerOutObservable.notifyObservers(this,-1,e,this,t)),r&&this.parent!=null&&!this.isPointerBlocker&&this.parent._onPointerOut(e,t,i)}_onPointerDown(e,t,i,r,s){return this._onPointerEnter(this,s),this._downCount!==0?!1:(this._downCount++,this._downPointerIds[i]=!0,this.onPointerDownObservable.notifyObservers(new Vector2WithInfo(t,r),-1,e,this,s)&&this.parent!=null&&!this.isPointerBlocker&&this.parent._onPointerDown(e,t,i,r,s),s&&this.uniqueId!==this._host.rootContainer.uniqueId&&this._host._capturedPointerIds.add(s.event.pointerId),!0)}_onPointerUp(e,t,i,r,s,n){if(!this._isEnabled)return;this._downCount=0,delete this._downPointerIds[i];let o=s;s&&(this._enterCount>0||this._enterCount===-1)&&(o=this.onPointerClickObservable.notifyObservers(new Vector2WithInfo(t,r),-1,e,this,n)),this.onPointerUpObservable.notifyObservers(new Vector2WithInfo(t,r),-1,e,this,n)&&this.parent!=null&&!this.isPointerBlocker&&this.parent._onPointerUp(e,t,i,r,o,n),n&&this.uniqueId!==this._host.rootContainer.uniqueId&&this._host._capturedPointerIds.delete(n.event.pointerId)}_forcePointerUp(e=null){if(e!==null)this._onPointerUp(this,Vector2.Zero(),e,0,!0);else for(const t in this._downPointerIds)this._onPointerUp(this,Vector2.Zero(),+t,0,!0)}_onWheelScroll(e,t){if(!this._isEnabled)return;this.onWheelObservable.notifyObservers(new Vector2(e,t))&&this.parent!=null&&this.parent._onWheelScroll(e,t)}_onCanvasBlur(){}_processObservables(e,t,i,r,s,n,o,l){if(!this._isEnabled)return!1;if(this._dummyVector2.copyFromFloats(t,i),e===PointerEventTypes.POINTERMOVE){this._onPointerMove(this,this._dummyVector2,s,r);const h=this._host._lastControlOver[s];return h&&h!==this&&h._onPointerOut(this,r),h!==this&&this._onPointerEnter(this,r),this._host._lastControlOver[s]=this,!0}return e===PointerEventTypes.POINTERDOWN?(this._onPointerDown(this,this._dummyVector2,s,n,r),this._host._registerLastControlDown(this,s),this._host._lastPickedControl=this,!0):e===PointerEventTypes.POINTERUP?(this._host._lastControlDown[s]&&this._host._lastControlDown[s]._onPointerUp(this,this._dummyVector2,s,n,!0,r),delete this._host._lastControlDown[s],!0):e===PointerEventTypes.POINTERWHEEL&&this._host._lastControlOver[s]?(this._host._lastControlOver[s]._onWheelScroll(o,l),!0):!1}_prepareFont(){!this._font&&!this._fontSet||(this._style?this._font=this._style.fontStyle+" "+this._style.fontWeight+" "+this.fontSizeInPixels+"px "+this._style.fontFamily:this._font=this._fontStyle+" "+this._fontWeight+" "+this.fontSizeInPixels+"px "+this._fontFamily,this._fontOffset=Control._GetFontOffset(this._font),this.getDescendants().forEach(e=>e._markAllAsDirty()))}clone(e){const t={};this.serialize(t);const i=Tools.Instantiate("BABYLON.GUI."+t.className),r=new i;return r.parse(t,e),r}parse(e,t){return SerializationHelper.Parse(()=>this,e,null),this.name=e.name,this._parseFromContent(e,t??this._host),this}serialize(e){SerializationHelper.Serialize(this,e),e.name=this.name,e.className=this.getClassName(),this._prepareFont(),this._font&&(e.fontFamily=this._fontFamily,e.fontSize=this.fontSize,e.fontWeight=this.fontWeight,e.fontStyle=this.fontStyle),this._gradient&&(e.gradient={},this._gradient.serialize(e.gradient)),SerializationHelper.AppendSerializedAnimations(this,e)}_parseFromContent(e,t){var i,r;if(e.fontFamily&&(this.fontFamily=e.fontFamily),e.fontSize&&(this.fontSize=e.fontSize),e.fontWeight&&(this.fontWeight=e.fontWeight),e.fontStyle&&(this.fontStyle=e.fontStyle),e.gradient){const s=Tools.Instantiate("BABYLON.GUI."+e.gradient.className);this._gradient=new s,(i=this._gradient)===null||i===void 0||i.parse(e.gradient)}if(e.animations){this.animations=[];for(let s=0;s<e.animations.length;s++){const n=e.animations[s],o=GetClass("BABYLON.Animation");o&&this.animations.push(o.Parse(n))}e.autoAnimate&&this._host&&this._host.getScene()&&this._host.getScene().beginAnimation(this,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}this.fixedRatioMasterIsWidth=(r=e.fixedRatioMasterIsWidth)!==null&&r!==void 0?r:this.fixedRatioMasterIsWidth}dispose(){this.onDirtyObservable.clear(),this.onBeforeDrawObservable.clear(),this.onAfterDrawObservable.clear(),this.onPointerDownObservable.clear(),this.onPointerEnterObservable.clear(),this.onPointerMoveObservable.clear(),this.onPointerOutObservable.clear(),this.onPointerUpObservable.clear(),this.onPointerClickObservable.clear(),this.onWheelObservable.clear(),this._styleObserver&&this._style&&(this._style.onChangedObservable.remove(this._styleObserver),this._styleObserver=null),this.parent&&(this.parent.removeControl(this),this.parent=null),this._host&&this._host._linkedControls.indexOf(this)>-1&&this.linkWithMesh(null),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}static get HORIZONTAL_ALIGNMENT_LEFT(){return Control._HORIZONTAL_ALIGNMENT_LEFT}static get HORIZONTAL_ALIGNMENT_RIGHT(){return Control._HORIZONTAL_ALIGNMENT_RIGHT}static get HORIZONTAL_ALIGNMENT_CENTER(){return Control._HORIZONTAL_ALIGNMENT_CENTER}static get VERTICAL_ALIGNMENT_TOP(){return Control._VERTICAL_ALIGNMENT_TOP}static get VERTICAL_ALIGNMENT_BOTTOM(){return Control._VERTICAL_ALIGNMENT_BOTTOM}static get VERTICAL_ALIGNMENT_CENTER(){return Control._VERTICAL_ALIGNMENT_CENTER}static _GetFontOffset(e){if(Control._FontHeightSizes[e])return Control._FontHeightSizes[e];const t=EngineStore.LastCreatedEngine;if(!t)throw new Error("Invalid engine. Unable to create a canvas.");const i=t.getFontOffset(e);return Control._FontHeightSizes[e]=i,i}static Parse(e,t){const i=Tools.Instantiate("BABYLON.GUI."+e.className),r=SerializationHelper.Parse(()=>new i,e,null);return r.name=e.name,r._parseFromContent(e,t),r}static drawEllipse(e,t,i,r,s){s.translate(e,t),s.scale(i,r),s.beginPath(),s.arc(0,0,1,0,2*Math.PI),s.closePath(),s.scale(1/i,1/r),s.translate(-e,-t)}isReady(){return!0}}Control.AllowAlphaInheritance=!1;Control._ClipMeasure=new Measure(0,0,0,0);Control._HORIZONTAL_ALIGNMENT_LEFT=0;Control._HORIZONTAL_ALIGNMENT_RIGHT=1;Control._HORIZONTAL_ALIGNMENT_CENTER=2;Control._VERTICAL_ALIGNMENT_TOP=0;Control._VERTICAL_ALIGNMENT_BOTTOM=1;Control._VERTICAL_ALIGNMENT_CENTER=2;Control._FontHeightSizes={};Control.AddHeader=()=>{};__decorate([serialize()],Control.prototype,"metadata",void 0);__decorate([serialize()],Control.prototype,"isHitTestVisible",void 0);__decorate([serialize()],Control.prototype,"isPointerBlocker",void 0);__decorate([serialize()],Control.prototype,"isFocusInvisible",void 0);__decorate([serialize()],Control.prototype,"clipChildren",null);__decorate([serialize()],Control.prototype,"clipContent",null);__decorate([serialize()],Control.prototype,"useBitmapCache",void 0);__decorate([serialize()],Control.prototype,"shadowOffsetX",null);__decorate([serialize()],Control.prototype,"shadowOffsetY",null);__decorate([serialize()],Control.prototype,"shadowBlur",null);__decorate([serialize()],Control.prototype,"shadowColor",null);__decorate([serialize()],Control.prototype,"hoverCursor",void 0);__decorate([serialize()],Control.prototype,"fontOffset",null);__decorate([serialize()],Control.prototype,"alpha",null);__decorate([serialize()],Control.prototype,"scaleX",null);__decorate([serialize()],Control.prototype,"scaleY",null);__decorate([serialize()],Control.prototype,"rotation",null);__decorate([serialize()],Control.prototype,"transformCenterY",null);__decorate([serialize()],Control.prototype,"transformCenterX",null);__decorate([serialize()],Control.prototype,"horizontalAlignment",null);__decorate([serialize()],Control.prototype,"verticalAlignment",null);__decorate([serialize()],Control.prototype,"fixedRatio",null);__decorate([serialize()],Control.prototype,"fixedRatioMasterIsWidth",null);__decorate([serialize()],Control.prototype,"width",null);__decorate([serialize()],Control.prototype,"height",null);__decorate([serialize()],Control.prototype,"style",null);__decorate([serialize()],Control.prototype,"color",null);__decorate([serialize()],Control.prototype,"gradient",null);__decorate([serialize()],Control.prototype,"zIndex",null);__decorate([serialize()],Control.prototype,"notRenderable",null);__decorate([serialize()],Control.prototype,"isVisible",null);__decorate([serialize()],Control.prototype,"descendantsOnlyPadding",null);__decorate([serialize()],Control.prototype,"paddingLeft",null);__decorate([serialize()],Control.prototype,"paddingRight",null);__decorate([serialize()],Control.prototype,"paddingTop",null);__decorate([serialize()],Control.prototype,"paddingBottom",null);__decorate([serialize()],Control.prototype,"left",null);__decorate([serialize()],Control.prototype,"top",null);__decorate([serialize()],Control.prototype,"linkOffsetX",null);__decorate([serialize()],Control.prototype,"linkOffsetY",null);__decorate([serialize()],Control.prototype,"isEnabled",null);__decorate([serialize()],Control.prototype,"disabledColor",null);__decorate([serialize()],Control.prototype,"disabledColorItem",null);__decorate([serialize()],Control.prototype,"overlapGroup",void 0);__decorate([serialize()],Control.prototype,"overlapDeltaMultiplier",void 0);RegisterClass("BABYLON.GUI.Control",Control);class ThinTexture{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return(e==null?void 0:e._shareDepth)!==void 0}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=Size.Zero(),this._cachedBaseSize=Size.Zero(),this._initialSamplingMode=2,this._texture=ThinTexture._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class BaseTexture extends ThinTexture{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this._markAllSubMeshesAsTexturesDirty()}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){this._texture&&(this._texture._isRGBD=e)}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=RandomGUID()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=BaseTexture.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=new Array,this.onDisposeObservable=new Observable,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?BaseTexture._IsScene(e)?this._scene=e:this._engine=e:this._scene=EngineStore.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return e!==null}getTextureMatrix(){return Matrix.IdentityReadOnly}getReflectionTextureMatrix(){return Matrix.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,r,s,n){const o=this._getEngine();if(!o)return null;const l=o._getUseSRGBBuffer(!!s,t),h=o.getLoadedTexturesCache();for(let u=0;u<h.length;u++){const c=h[u];if((s===void 0||l===c._useSRGBBuffer)&&(r===void 0||r===c.invertY)&&c.url===e&&c.generateMipMaps===!t&&(!i||i===c.samplingMode)&&(n===void 0||n===c.isCube))return c.incrementReferences(),c}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,r=!0,s=!1,n=0,o=0,l=Number.MAX_VALUE,h=Number.MAX_VALUE){if(!this._texture)return null;const u=this._getEngine();if(!u)return null;const c=this.getSize();let d=c.width,f=c.height;t!==0&&(d=d/Math.pow(2,t),f=f/Math.pow(2,t),d=Math.round(d),f=Math.round(f)),l=Math.min(d,l),h=Math.min(f,h);try{return this._texture.isCube?u._readTexturePixels(this._texture,l,h,e,t,i,r,s,n,o):u._readTexturePixels(this._texture,l,h,-1,t,i,r,s,n,o)}catch{return null}}_readPixelsSync(e=0,t=0,i=null,r=!0,s=!1){if(!this._texture)return null;const n=this.getSize();let o=n.width,l=n.height;const h=this._getEngine();if(!h)return null;t!=0&&(o=o/Math.pow(2,t),l=l/Math.pow(2,t),o=Math.round(o),l=Math.round(l));try{return this._texture.isCube?h._readTexturePixelsSync(this._texture,o,l,e,t,i,r,s):h._readTexturePixelsSync(this._texture,o,l,-1,t,i,r,s)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=SerializationHelper.Serialize(this);return SerializationHelper.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(i===0){t();return}for(let r=0;r<e.length;r++){const s=e[r];if(s.isReady())--i===0&&t();else{const n=s.onLoadObservable;n?n.addOnce(()=>{--i===0&&t()}):--i===0&&t()}}}static _IsScene(e){return e.getClassName()==="Scene"}}BaseTexture.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;__decorate([serialize()],BaseTexture.prototype,"uniqueId",void 0);__decorate([serialize()],BaseTexture.prototype,"name",void 0);__decorate([serialize()],BaseTexture.prototype,"metadata",void 0);__decorate([serialize("hasAlpha")],BaseTexture.prototype,"_hasAlpha",void 0);__decorate([serialize("getAlphaFromRGB")],BaseTexture.prototype,"_getAlphaFromRGB",void 0);__decorate([serialize()],BaseTexture.prototype,"level",void 0);__decorate([serialize("coordinatesIndex")],BaseTexture.prototype,"_coordinatesIndex",void 0);__decorate([serialize()],BaseTexture.prototype,"optimizeUVAllocation",void 0);__decorate([serialize("coordinatesMode")],BaseTexture.prototype,"_coordinatesMode",void 0);__decorate([serialize()],BaseTexture.prototype,"wrapU",null);__decorate([serialize()],BaseTexture.prototype,"wrapV",null);__decorate([serialize()],BaseTexture.prototype,"wrapR",void 0);__decorate([serialize()],BaseTexture.prototype,"anisotropicFilteringLevel",void 0);__decorate([serialize()],BaseTexture.prototype,"isCube",null);__decorate([serialize()],BaseTexture.prototype,"is3D",null);__decorate([serialize()],BaseTexture.prototype,"is2DArray",null);__decorate([serialize()],BaseTexture.prototype,"gammaSpace",null);__decorate([serialize()],BaseTexture.prototype,"invertZ",void 0);__decorate([serialize()],BaseTexture.prototype,"lodLevelInAlpha",void 0);__decorate([serialize()],BaseTexture.prototype,"lodGenerationOffset",null);__decorate([serialize()],BaseTexture.prototype,"lodGenerationScale",null);__decorate([serialize()],BaseTexture.prototype,"linearSpecularLOD",null);__decorate([serializeAsTexture()],BaseTexture.prototype,"irradianceTexture",null);__decorate([serialize()],BaseTexture.prototype,"isRenderTarget",void 0);function GenerateBase64StringFromPixelData(a,e,t=!1){const i=e.width,r=e.height;if(a instanceof Float32Array){let h=a.byteLength/a.BYTES_PER_ELEMENT;const u=new Uint8Array(h);for(;--h>=0;){let c=a[h];c<0?c=0:c>1&&(c=1),u[h]=c*255}a=u}const s=document.createElement("canvas");s.width=i,s.height=r;const n=s.getContext("2d");if(!n)return null;const o=n.createImageData(i,r);if(o.data.set(a),n.putImageData(o,0,0),t){const h=document.createElement("canvas");h.width=i,h.height=r;const u=h.getContext("2d");return u?(u.translate(0,r),u.scale(1,-1),u.drawImage(s,0,0),h.toDataURL("image/png")):null}return s.toDataURL("image/png")}function GenerateBase64StringFromTexture(a,e=0,t=0){const i=a.getInternalTexture();if(!i)return null;const r=a._readPixelsSync(e,t);return r?GenerateBase64StringFromPixelData(r,a.getSize(),i.invertY):null}async function GenerateBase64StringFromTextureAsync(a,e=0,t=0){const i=a.getInternalTexture();if(!i)return null;const r=await a.readPixels(e,t);return r?GenerateBase64StringFromPixelData(r,a.getSize(),i.invertY):null}class CompatibilityOptions{}CompatibilityOptions.UseOpenGLOrientationForUV=!1;class Texture extends BaseTexture{get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,r,s=Texture.TRILINEAR_SAMPLINGMODE,n=null,o=null,l=null,h=!1,u,c,d,f,_){var g,p,m,E,M,x,A,T,C;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new Observable,this._isBlocking=!0,this.name=e||"",this.url=e;let b,y=!1,S=null;typeof i=="object"&&i!==null?(b=(g=i.noMipmap)!==null&&g!==void 0?g:!1,r=(p=i.invertY)!==null&&p!==void 0?p:!CompatibilityOptions.UseOpenGLOrientationForUV,s=(m=i.samplingMode)!==null&&m!==void 0?m:Texture.TRILINEAR_SAMPLINGMODE,n=(E=i.onLoad)!==null&&E!==void 0?E:null,o=(M=i.onError)!==null&&M!==void 0?M:null,l=(x=i.buffer)!==null&&x!==void 0?x:null,h=(A=i.deleteBuffer)!==null&&A!==void 0?A:!1,u=i.format,c=i.mimeType,d=i.loaderOptions,f=i.creationFlags,y=(T=i.useSRGBBuffer)!==null&&T!==void 0?T:!1,S=(C=i.internalTexture)!==null&&C!==void 0?C:null):b=!!i,this._noMipmap=b,this._invertY=r===void 0?!CompatibilityOptions.UseOpenGLOrientationForUV:r,this._initialSamplingMode=s,this._buffer=l,this._deleteBuffer=h,this._mimeType=c,this._loaderOptions=d,this._creationFlags=f,this._useSRGBBuffer=y,this._forcedExtension=_,u&&(this._format=u);const R=this.getScene(),P=this._getEngine();if(!P)return;P.onBeforeTextureInitObservable.notifyObservers(this);const N=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),n&&n(),!this.isBlocking&&R&&R.resetCachedMaterial()},V=(F,U)=>{this._loadingError=!0,this._errorObject={message:F,exception:U},o&&o(F,U),Texture.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!S){this._delayedOnLoad=N,this._delayedOnError=V;return}if(this._texture=S??this._getFromCache(this.url,b,s,this._invertY,y),this._texture)if(this._texture.isReady)TimingTools.SetImmediate(()=>N());else{const F=this._texture.onLoadedObservable.add(N);this._texture.onErrorObservable.add(U=>{var H;V(U.message,U.exception),(H=this._texture)===null||H===void 0||H.onLoadedObservable.remove(F)})}else if(!R||!R.useDelayedTextureLoading){try{this._texture=P.createTexture(this.url,b,this._invertY,R,s,N,V,this._buffer,void 0,this._format,this._forcedExtension,c,d,f,y)}catch(F){throw V("error loading",F),F}h&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=N,this._delayedOnError=V}updateURL(e,t=null,i,r){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=r,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?TimingTools.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,r){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,Vector3.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,r),r.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,r.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,r.z+=this.wRotationCenter}checkTransformsAreIdentical(e){return e!==null&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=Matrix.Zero(),this._rowGenerationMatrix=new Matrix,this._t0=Vector3.Zero(),this._t1=Vector3.Zero(),this._t2=Vector3.Zero()),Matrix.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(Matrix.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,TmpVectors.Matrix[0]),Matrix.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,TmpVectors.Matrix[1]),Matrix.ScalingToRef(this._cachedUScale,this._cachedVScale,0,TmpVectors.Matrix[2]),Matrix.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,TmpVectors.Matrix[3]),TmpVectors.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(TmpVectors.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(TmpVectors.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(TmpVectors.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),Matrix.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();return t?(this.optimizeUVAllocation&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===Texture.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=Matrix.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=Matrix.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case Texture.PLANAR_MODE:{Matrix.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case Texture.PROJECTION_MODE:{Matrix.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:Matrix.IdentityToRef(this._cachedReflectionTextureMatrix);break}return t&&e.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return SerializationHelper.Clone(()=>new Texture(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){var e,t;const i=this.name;Texture.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const r=super.serialize(Texture._SerializeInternalTextureUniqueId);return r?((Texture.SerializeBuffers||Texture.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(r.base64String=this._buffer,r.name=r.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?r.base64String="data:image/png;base64,"+EncodeArrayBufferToBase64(this._buffer):(Texture.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(r.base64String=!this._engine||this._engine._features.supportSyncTextureRead?GenerateBase64StringFromTexture(this):GenerateBase64StringFromTextureAsync(this))),r.invertY=this._invertY,r.samplingMode=this.samplingMode,r._creationFlags=this._creationFlags,r._useSRGBBuffer=this._useSRGBBuffer,Texture._SerializeInternalTextureUniqueId&&(r.internalTextureUniqueId=(t=(e=this._texture)===null||e===void 0?void 0:e.uniqueId)!==null&&t!==void 0?t:void 0),this.name=i,r):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const h=InstantiationTools.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&h.updateSamplingMode&&h._samplingMode&&h._samplingMode!==e.samplingMode&&h.updateSamplingMode(e.samplingMode),h}if(e.isCube&&!e.isRenderTarget)return Texture._CubeTextureParser(e,t,i);const r=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!r)return null;let s;if(r){const l=t.getEngine().getLoadedTexturesCache();for(const h of l)if(h.uniqueId===e.internalTextureUniqueId){s=h;break}}const n=l=>{var h;if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),e.samplingMode){const u=e.samplingMode;l&&l.samplingMode!==u&&l.updateSamplingMode(u)}if(l&&e.animations)for(let u=0;u<e.animations.length;u++){const c=e.animations[u],d=GetClass("BABYLON.Animation");d&&l.animations.push(d.Parse(c))}r&&!s&&((h=l==null?void 0:l._texture)===null||h===void 0||h._setUniqueId(e.internalTextureUniqueId))};return SerializationHelper.Parse(()=>{var l,h,u;let c=!0;if(e.noMipmap&&(c=!1),e.mirrorPlane){const d=Texture._CreateMirror(e.name,e.renderTargetSize,t,c);return d._waitingRenderList=e.renderList,d.mirrorPlane=Plane.FromArray(e.mirrorPlane),n(d),d}else if(e.isRenderTarget){let d=null;if(e.isCube){if(t.reflectionProbes)for(let f=0;f<t.reflectionProbes.length;f++){const _=t.reflectionProbes[f];if(_.name===e.name)return _.cubeTexture}}else d=Texture._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,c,(l=e._creationFlags)!==null&&l!==void 0?l:0),d._waitingRenderList=e.renderList;return n(d),d}else{let d;if(e.base64String&&!s)d=Texture.CreateFromBase64String(e.base64String,e.base64String,t,!c,e.invertY,e.samplingMode,()=>{n(d)},(h=e._creationFlags)!==null&&h!==void 0?h:0,(u=e._useSRGBBuffer)!==null&&u!==void 0?u:!1),d.name=e.name;else{let f;e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?f=e.name:f=i+e.name,e.url&&(e.url.startsWith("data:")||Texture.UseSerializedUrlIfAny)&&(f=e.url);const _={noMipmap:!c,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{n(d)},internalTexture:s};d=new Texture(f,t,_)}return d}},e,t)}static CreateFromBase64String(e,t,i,r,s,n=Texture.TRILINEAR_SAMPLINGMODE,o=null,l=null,h=5,u){return new Texture("data:"+t,i,r,s,n,o,l,e,!1,h,void 0,void 0,u)}static LoadFromDataString(e,t,i,r=!1,s,n=!0,o=Texture.TRILINEAR_SAMPLINGMODE,l=null,h=null,u=5,c){return e.substr(0,5)!=="data:"&&(e="data:"+e),new Texture(e,i,s,n,o,l,h,t,r,u,void 0,void 0,c)}}Texture.SerializeBuffers=!0;Texture.ForceSerializeBuffers=!1;Texture.OnTextureLoadErrorObservable=new Observable;Texture._SerializeInternalTextureUniqueId=!1;Texture._CubeTextureParser=(a,e,t)=>{throw _WarnImport("CubeTexture")};Texture._CreateMirror=(a,e,t,i)=>{throw _WarnImport("MirrorTexture")};Texture._CreateRenderTargetTexture=(a,e,t,i,r)=>{throw _WarnImport("RenderTargetTexture")};Texture.NEAREST_SAMPLINGMODE=1;Texture.NEAREST_NEAREST_MIPLINEAR=8;Texture.BILINEAR_SAMPLINGMODE=2;Texture.LINEAR_LINEAR_MIPNEAREST=11;Texture.TRILINEAR_SAMPLINGMODE=3;Texture.LINEAR_LINEAR_MIPLINEAR=3;Texture.NEAREST_NEAREST_MIPNEAREST=4;Texture.NEAREST_LINEAR_MIPNEAREST=5;Texture.NEAREST_LINEAR_MIPLINEAR=6;Texture.NEAREST_LINEAR=7;Texture.NEAREST_NEAREST=1;Texture.LINEAR_NEAREST_MIPNEAREST=9;Texture.LINEAR_NEAREST_MIPLINEAR=10;Texture.LINEAR_LINEAR=2;Texture.LINEAR_NEAREST=12;Texture.EXPLICIT_MODE=0;Texture.SPHERICAL_MODE=1;Texture.PLANAR_MODE=2;Texture.CUBIC_MODE=3;Texture.PROJECTION_MODE=4;Texture.SKYBOX_MODE=5;Texture.INVCUBIC_MODE=6;Texture.EQUIRECTANGULAR_MODE=7;Texture.FIXED_EQUIRECTANGULAR_MODE=8;Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;Texture.CLAMP_ADDRESSMODE=0;Texture.WRAP_ADDRESSMODE=1;Texture.MIRROR_ADDRESSMODE=2;Texture.UseSerializedUrlIfAny=!1;__decorate([serialize()],Texture.prototype,"url",void 0);__decorate([serialize()],Texture.prototype,"uOffset",void 0);__decorate([serialize()],Texture.prototype,"vOffset",void 0);__decorate([serialize()],Texture.prototype,"uScale",void 0);__decorate([serialize()],Texture.prototype,"vScale",void 0);__decorate([serialize()],Texture.prototype,"uAng",void 0);__decorate([serialize()],Texture.prototype,"vAng",void 0);__decorate([serialize()],Texture.prototype,"wAng",void 0);__decorate([serialize()],Texture.prototype,"uRotationCenter",void 0);__decorate([serialize()],Texture.prototype,"vRotationCenter",void 0);__decorate([serialize()],Texture.prototype,"wRotationCenter",void 0);__decorate([serialize()],Texture.prototype,"homogeneousRotationInUVTransform",void 0);__decorate([serialize()],Texture.prototype,"isBlocking",null);RegisterClass("BABYLON.Texture",Texture);SerializationHelper._TextureParser=Texture.Parse;ThinEngine.prototype.createDynamicTexture=function(a,e,t,i){const r=new InternalTexture(this,InternalTextureSource.Dynamic);return r.baseWidth=a,r.baseHeight=e,t&&(a=this.needPOTTextures?ThinEngine.GetExponentOfTwo(a,this._caps.maxTextureSize):a,e=this.needPOTTextures?ThinEngine.GetExponentOfTwo(e,this._caps.maxTextureSize):e),r.width=a,r.height=e,r.isReady=!1,r.generateMipMaps=t,r.samplingMode=i,this.updateTextureSamplingMode(i,r),this._internalTexturesCache.push(r),r};ThinEngine.prototype.updateDynamicTexture=function(a,e,t,i=!1,r,s=!1,n=!1){if(!a)return;const o=this._gl,l=o.TEXTURE_2D,h=this._bindTextureDirectly(l,a,!0,s);this._unpackFlipY(t===void 0?a.invertY:t),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const u=this._getWebGLTextureType(a.type),c=this._getInternalFormat(r||a.format),d=this._getRGBABufferInternalSizedFormat(a.type,c);o.texImage2D(l,0,d,c,u,e),a.generateMipMaps&&o.generateMipmap(l),h||this._bindTextureDirectly(l,null),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),a.isReady=!0};class DynamicTexture extends Texture{constructor(e,t,i=null,r=!1,s=3,n=5,o){super(null,i,!r,o,s,void 0,void 0,void 0,void 0,n),this.name=e,this.wrapU=Texture.CLAMP_ADDRESSMODE,this.wrapV=Texture.CLAMP_ADDRESSMODE,this._generateMipMaps=r;const l=this._getEngine();if(!l)return;t.getContext?(this._canvas=t,this._texture=l.createDynamicTexture(t.width,t.height,r,s)):(this._canvas=l.createCanvas(1,1),t.width||t.width===0?this._texture=l.createDynamicTexture(t.width,t.height,r,s):this._texture=l.createDynamicTexture(t,t,r,s));const h=this.getSize();this._canvas.width!==h.width&&(this._canvas.width=h.width),this._canvas.height!==h.height&&(this._canvas.height=h.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){const i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(){const e=this.getSize();this._context.fillRect(0,0,e.width,e.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,e===void 0?!0:e,t,this._format||void 0,void 0,i)}drawText(e,t,i,r,s,n,o,l=!0){const h=this.getSize();if(n&&(this._context.fillStyle=n,this._context.fillRect(0,0,h.width,h.height)),this._context.font=r,t==null){const u=this._context.measureText(e);t=(h.width-u.width)/2}if(i==null){const u=parseInt(r.replace(/\D/g,""));i=h.height/2+u/3.65}this._context.fillStyle=s||"",this._context.fillText(e,t,i),l&&this.update(o)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new DynamicTexture(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){const e=this.getScene();e&&!e.isReady()&&Logger.Warn("The scene must be ready before serializing the dynamic texture");const t=super.serialize();return DynamicTexture._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return e.toDataURL!==void 0}_rebuild(){this.update()}}class Constants{}Constants.ALPHA_DISABLE=0;Constants.ALPHA_ADD=1;Constants.ALPHA_COMBINE=2;Constants.ALPHA_SUBTRACT=3;Constants.ALPHA_MULTIPLY=4;Constants.ALPHA_MAXIMIZED=5;Constants.ALPHA_ONEONE=6;Constants.ALPHA_PREMULTIPLIED=7;Constants.ALPHA_PREMULTIPLIED_PORTERDUFF=8;Constants.ALPHA_INTERPOLATE=9;Constants.ALPHA_SCREENMODE=10;Constants.ALPHA_ONEONE_ONEONE=11;Constants.ALPHA_ALPHATOCOLOR=12;Constants.ALPHA_REVERSEONEMINUS=13;Constants.ALPHA_SRC_DSTONEMINUSSRCALPHA=14;Constants.ALPHA_ONEONE_ONEZERO=15;Constants.ALPHA_EXCLUSION=16;Constants.ALPHA_LAYER_ACCUMULATE=17;Constants.ALPHA_EQUATION_ADD=0;Constants.ALPHA_EQUATION_SUBSTRACT=1;Constants.ALPHA_EQUATION_REVERSE_SUBTRACT=2;Constants.ALPHA_EQUATION_MAX=3;Constants.ALPHA_EQUATION_MIN=4;Constants.ALPHA_EQUATION_DARKEN=5;Constants.DELAYLOADSTATE_NONE=0;Constants.DELAYLOADSTATE_LOADED=1;Constants.DELAYLOADSTATE_LOADING=2;Constants.DELAYLOADSTATE_NOTLOADED=4;Constants.NEVER=512;Constants.ALWAYS=519;Constants.LESS=513;Constants.EQUAL=514;Constants.LEQUAL=515;Constants.GREATER=516;Constants.GEQUAL=518;Constants.NOTEQUAL=517;Constants.KEEP=7680;Constants.ZERO=0;Constants.REPLACE=7681;Constants.INCR=7682;Constants.DECR=7683;Constants.INVERT=5386;Constants.INCR_WRAP=34055;Constants.DECR_WRAP=34056;Constants.TEXTURE_CLAMP_ADDRESSMODE=0;Constants.TEXTURE_WRAP_ADDRESSMODE=1;Constants.TEXTURE_MIRROR_ADDRESSMODE=2;Constants.TEXTURE_CREATIONFLAG_STORAGE=1;Constants.TEXTUREFORMAT_ALPHA=0;Constants.TEXTUREFORMAT_LUMINANCE=1;Constants.TEXTUREFORMAT_LUMINANCE_ALPHA=2;Constants.TEXTUREFORMAT_RGB=4;Constants.TEXTUREFORMAT_RGBA=5;Constants.TEXTUREFORMAT_RED=6;Constants.TEXTUREFORMAT_R=6;Constants.TEXTUREFORMAT_RG=7;Constants.TEXTUREFORMAT_RED_INTEGER=8;Constants.TEXTUREFORMAT_R_INTEGER=8;Constants.TEXTUREFORMAT_RG_INTEGER=9;Constants.TEXTUREFORMAT_RGB_INTEGER=10;Constants.TEXTUREFORMAT_RGBA_INTEGER=11;Constants.TEXTUREFORMAT_BGRA=12;Constants.TEXTUREFORMAT_DEPTH24_STENCIL8=13;Constants.TEXTUREFORMAT_DEPTH32_FLOAT=14;Constants.TEXTUREFORMAT_DEPTH16=15;Constants.TEXTUREFORMAT_DEPTH24=16;Constants.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17;Constants.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18;Constants.TEXTUREFORMAT_STENCIL8=19;Constants.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492;Constants.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493;Constants.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495;Constants.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494;Constants.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779;Constants.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919;Constants.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778;Constants.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918;Constants.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777;Constants.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776;Constants.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917;Constants.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916;Constants.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808;Constants.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840;Constants.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196;Constants.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492;Constants.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493;Constants.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494;Constants.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495;Constants.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496;Constants.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497;Constants.TEXTURETYPE_UNSIGNED_BYTE=0;Constants.TEXTURETYPE_UNSIGNED_INT=0;Constants.TEXTURETYPE_FLOAT=1;Constants.TEXTURETYPE_HALF_FLOAT=2;Constants.TEXTURETYPE_BYTE=3;Constants.TEXTURETYPE_SHORT=4;Constants.TEXTURETYPE_UNSIGNED_SHORT=5;Constants.TEXTURETYPE_INT=6;Constants.TEXTURETYPE_UNSIGNED_INTEGER=7;Constants.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;Constants.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;Constants.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;Constants.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;Constants.TEXTURETYPE_UNSIGNED_INT_24_8=12;Constants.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;Constants.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;Constants.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;Constants.TEXTURETYPE_UNDEFINED=16;Constants.TEXTURE_2D=3553;Constants.TEXTURE_2D_ARRAY=35866;Constants.TEXTURE_CUBE_MAP=34067;Constants.TEXTURE_CUBE_MAP_ARRAY=3735928559;Constants.TEXTURE_3D=32879;Constants.TEXTURE_NEAREST_SAMPLINGMODE=1;Constants.TEXTURE_NEAREST_NEAREST=1;Constants.TEXTURE_BILINEAR_SAMPLINGMODE=2;Constants.TEXTURE_LINEAR_LINEAR=2;Constants.TEXTURE_TRILINEAR_SAMPLINGMODE=3;Constants.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;Constants.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;Constants.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;Constants.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;Constants.TEXTURE_NEAREST_LINEAR=7;Constants.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;Constants.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;Constants.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;Constants.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;Constants.TEXTURE_LINEAR_NEAREST=12;Constants.TEXTURE_EXPLICIT_MODE=0;Constants.TEXTURE_SPHERICAL_MODE=1;Constants.TEXTURE_PLANAR_MODE=2;Constants.TEXTURE_CUBIC_MODE=3;Constants.TEXTURE_PROJECTION_MODE=4;Constants.TEXTURE_SKYBOX_MODE=5;Constants.TEXTURE_INVCUBIC_MODE=6;Constants.TEXTURE_EQUIRECTANGULAR_MODE=7;Constants.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;Constants.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;Constants.TEXTURE_FILTERING_QUALITY_OFFLINE=4096;Constants.TEXTURE_FILTERING_QUALITY_HIGH=64;Constants.TEXTURE_FILTERING_QUALITY_MEDIUM=16;Constants.TEXTURE_FILTERING_QUALITY_LOW=8;Constants.SCALEMODE_FLOOR=1;Constants.SCALEMODE_NEAREST=2;Constants.SCALEMODE_CEILING=3;Constants.MATERIAL_TextureDirtyFlag=1;Constants.MATERIAL_LightDirtyFlag=2;Constants.MATERIAL_FresnelDirtyFlag=4;Constants.MATERIAL_AttributesDirtyFlag=8;Constants.MATERIAL_MiscDirtyFlag=16;Constants.MATERIAL_PrePassDirtyFlag=32;Constants.MATERIAL_AllDirtyFlag=63;Constants.MATERIAL_TriangleFillMode=0;Constants.MATERIAL_WireFrameFillMode=1;Constants.MATERIAL_PointFillMode=2;Constants.MATERIAL_PointListDrawMode=3;Constants.MATERIAL_LineListDrawMode=4;Constants.MATERIAL_LineLoopDrawMode=5;Constants.MATERIAL_LineStripDrawMode=6;Constants.MATERIAL_TriangleStripDrawMode=7;Constants.MATERIAL_TriangleFanDrawMode=8;Constants.MATERIAL_ClockWiseSideOrientation=0;Constants.MATERIAL_CounterClockWiseSideOrientation=1;Constants.ACTION_NothingTrigger=0;Constants.ACTION_OnPickTrigger=1;Constants.ACTION_OnLeftPickTrigger=2;Constants.ACTION_OnRightPickTrigger=3;Constants.ACTION_OnCenterPickTrigger=4;Constants.ACTION_OnPickDownTrigger=5;Constants.ACTION_OnDoublePickTrigger=6;Constants.ACTION_OnPickUpTrigger=7;Constants.ACTION_OnPickOutTrigger=16;Constants.ACTION_OnLongPressTrigger=8;Constants.ACTION_OnPointerOverTrigger=9;Constants.ACTION_OnPointerOutTrigger=10;Constants.ACTION_OnEveryFrameTrigger=11;Constants.ACTION_OnIntersectionEnterTrigger=12;Constants.ACTION_OnIntersectionExitTrigger=13;Constants.ACTION_OnKeyDownTrigger=14;Constants.ACTION_OnKeyUpTrigger=15;Constants.PARTICLES_BILLBOARDMODE_Y=2;Constants.PARTICLES_BILLBOARDMODE_ALL=7;Constants.PARTICLES_BILLBOARDMODE_STRETCHED=8;Constants.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9;Constants.MESHES_CULLINGSTRATEGY_STANDARD=0;Constants.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;Constants.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;Constants.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;Constants.SCENELOADER_NO_LOGGING=0;Constants.SCENELOADER_MINIMAL_LOGGING=1;Constants.SCENELOADER_SUMMARY_LOGGING=2;Constants.SCENELOADER_DETAILED_LOGGING=3;Constants.PREPASS_IRRADIANCE_TEXTURE_TYPE=0;Constants.PREPASS_POSITION_TEXTURE_TYPE=1;Constants.PREPASS_VELOCITY_TEXTURE_TYPE=2;Constants.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3;Constants.PREPASS_COLOR_TEXTURE_TYPE=4;Constants.PREPASS_DEPTH_TEXTURE_TYPE=5;Constants.PREPASS_NORMAL_TEXTURE_TYPE=6;Constants.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7;Constants.BUFFER_CREATIONFLAG_READ=1;Constants.BUFFER_CREATIONFLAG_WRITE=2;Constants.BUFFER_CREATIONFLAG_READWRITE=3;Constants.BUFFER_CREATIONFLAG_UNIFORM=4;Constants.BUFFER_CREATIONFLAG_VERTEX=8;Constants.BUFFER_CREATIONFLAG_INDEX=16;Constants.BUFFER_CREATIONFLAG_STORAGE=32;Constants.RENDERPASS_MAIN=0;Constants.INPUT_ALT_KEY=18;Constants.INPUT_CTRL_KEY=17;Constants.INPUT_META_KEY1=91;Constants.INPUT_META_KEY2=92;Constants.INPUT_META_KEY3=93;Constants.INPUT_SHIFT_KEY=16;Constants.SNAPSHOTRENDERING_STANDARD=0;Constants.SNAPSHOTRENDERING_FAST=1;Constants.PERSPECTIVE_CAMERA=0;Constants.ORTHOGRAPHIC_CAMERA=1;Constants.FOVMODE_VERTICAL_FIXED=0;Constants.FOVMODE_HORIZONTAL_FIXED=1;Constants.RIG_MODE_NONE=0;Constants.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;Constants.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;Constants.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;Constants.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;Constants.RIG_MODE_STEREOSCOPIC_INTERLACED=14;Constants.RIG_MODE_VR=20;Constants.RIG_MODE_WEBVR=21;Constants.RIG_MODE_CUSTOM=22;Constants.MAX_SUPPORTED_UV_SETS=6;Constants.GL_ALPHA_EQUATION_ADD=32774;Constants.GL_ALPHA_EQUATION_MIN=32775;Constants.GL_ALPHA_EQUATION_MAX=32776;Constants.GL_ALPHA_EQUATION_SUBTRACT=32778;Constants.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779;Constants.GL_ALPHA_FUNCTION_SRC=768;Constants.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769;Constants.GL_ALPHA_FUNCTION_SRC_ALPHA=770;Constants.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771;Constants.GL_ALPHA_FUNCTION_DST_ALPHA=772;Constants.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773;Constants.GL_ALPHA_FUNCTION_DST_COLOR=774;Constants.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775;Constants.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776;Constants.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769;Constants.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770;Constants.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771;Constants.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772;Constants.SnippetUrl="https://snippet.babylonjs.com";class Container extends Control{get renderToIntermediateTexture(){return this._renderToIntermediateTexture}set renderToIntermediateTexture(e){this._renderToIntermediateTexture!==e&&(this._renderToIntermediateTexture=e,this._markAsDirty())}get adaptHeightToChildren(){return this._adaptHeightToChildren}set adaptHeightToChildren(e){this._adaptHeightToChildren!==e&&(this._adaptHeightToChildren=e,e&&(this.height="100%"),this._markAsDirty())}get adaptWidthToChildren(){return this._adaptWidthToChildren}set adaptWidthToChildren(e){this._adaptWidthToChildren!==e&&(this._adaptWidthToChildren=e,e&&(this.width="100%"),this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get backgroundGradient(){return this._backgroundGradient}set backgroundGradient(e){this._backgroundGradient!==e&&(this._backgroundGradient=e,this._markAsDirty())}get children(){return this._children}get isReadOnly(){return this._isReadOnly}set isReadOnly(e){this._isReadOnly=e;for(const t of this._children)t.isReadOnly=e}constructor(e){super(e),this.name=e,this._children=new Array,this._measureForChildren=Measure.Empty(),this._background="",this._backgroundGradient=null,this._adaptWidthToChildren=!1,this._adaptHeightToChildren=!1,this._renderToIntermediateTexture=!1,this._intermediateTexture=null,this.logLayoutCycleErrors=!1,this.maxLayoutCycle=3,this.onControlAddedObservable=new Observable,this.onControlRemovedObservable=new Observable,this._inverseTransformMatrix=Matrix2D.Identity(),this._inverseMeasure=new Measure(0,0,0,0)}_getTypeName(){return"Container"}_flagDescendantsAsMatrixDirty(){for(const e of this.children)e._isClipped=!1,e._markMatrixAsDirty()}getChildByName(e){for(const t of this.children)if(t.name===e)return t;return null}getChildByType(e,t){for(const i of this.children)if(i.typeName===t)return i;return null}containsControl(e){return this.children.indexOf(e)!==-1}addControl(e){return e?this._children.indexOf(e)!==-1?this:(e._link(this._host),e._markAllAsDirty(),this._reOrderControl(e),this._markAsDirty(),this.onControlAddedObservable.notifyObservers(e),this):this}clearControls(){const e=this.children.slice();for(const t of e)this.removeControl(t);return this}removeControl(e){const t=this._children.indexOf(e);return t!==-1&&(this._children.splice(t,1),e.parent=null),e.linkWithMesh(null),this._host&&this._host._cleanControlAfterRemoval(e),this._markAsDirty(),this.onControlRemovedObservable.notifyObservers(e),this}_reOrderControl(e){const t=e.linkedMesh;this.removeControl(e);let i=!1;for(let r=0;r<this._children.length;r++)if(this._children[r].zIndex>e.zIndex){this._children.splice(r,0,e),i=!0;break}i||this._children.push(e),e.parent=this,t&&e.linkWithMesh(t),this._markAsDirty()}_offsetLeft(e){super._offsetLeft(e);for(const t of this._children)t._offsetLeft(e)}_offsetTop(e){super._offsetTop(e);for(const t of this._children)t._offsetTop(e)}_markAllAsDirty(){super._markAllAsDirty();for(let e=0;e<this._children.length;e++)this._children[e]._markAllAsDirty()}_getBackgroundColor(e){return this._backgroundGradient?this._backgroundGradient.getCanvasGradient(e):this._background}_localDraw(e){(this._background||this._backgroundGradient)&&(e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),e.fillStyle=this._getBackgroundColor(e),e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height),e.restore())}_link(e){super._link(e);for(const t of this._children)t._link(e)}_beforeLayout(){}_processMeasures(e,t){(this._isDirty||!this._cachedParentMeasure.isEqualsTo(e))&&(super._processMeasures(e,t),this._evaluateClippingState(e),this._renderToIntermediateTexture&&(this._intermediateTexture&&this._host.getScene()!=this._intermediateTexture.getScene()&&(this._intermediateTexture.dispose(),this._intermediateTexture=null),this._intermediateTexture?this._intermediateTexture.scaleTo(this._currentMeasure.width,this._currentMeasure.height):(this._intermediateTexture=new DynamicTexture("",{width:this._currentMeasure.width,height:this._currentMeasure.height},this._host.getScene(),!1,Texture.NEAREST_SAMPLINGMODE,Constants.TEXTUREFORMAT_RGBA,!1),this._intermediateTexture.hasAlpha=!0)))}_layout(e,t){var i,r;if(!this.isDirty&&(!this.isVisible||this.notRenderable))return!1;this.host._numLayoutCalls++,this._isDirty&&this._currentMeasure.transformToRef(this._transformMatrix,this._prevCurrentMeasureTransformedIntoGlobalSpace);let s=0;t.save(),this._applyStates(t),this._beforeLayout();do{let n=-1,o=-1;if(this._rebuildLayout=!1,this._processMeasures(e,t),!this._isClipped){for(const l of this._children)l._tempParentMeasure.copyFrom(this._measureForChildren),l._layout(this._measureForChildren,t)&&l.isVisible&&!l.notRenderable&&(this.adaptWidthToChildren&&l._width.isPixel&&(n=Math.max(n,l._currentMeasure.width+l._paddingLeftInPixels+l._paddingRightInPixels)),this.adaptHeightToChildren&&l._height.isPixel&&(o=Math.max(o,l._currentMeasure.height+l._paddingTopInPixels+l._paddingBottomInPixels)));this.adaptWidthToChildren&&n>=0&&(n+=this.paddingLeftInPixels+this.paddingRightInPixels,this.width!==n+"px"&&((i=this.parent)===null||i===void 0||i._markAsDirty(),this.width=n+"px",this._width.ignoreAdaptiveScaling=!0,this._rebuildLayout=!0)),this.adaptHeightToChildren&&o>=0&&(o+=this.paddingTopInPixels+this.paddingBottomInPixels,this.height!==o+"px"&&((r=this.parent)===null||r===void 0||r._markAsDirty(),this.height=o+"px",this._height.ignoreAdaptiveScaling=!0,this._rebuildLayout=!0)),this._postMeasure()}s++}while(this._rebuildLayout&&s<this.maxLayoutCycle);return s>=3&&this.logLayoutCycleErrors&&Logger.Error(`Layout cycle detected in GUI (Container name=${this.name}, uniqueId=${this.uniqueId})`),t.restore(),this._isDirty&&(this.invalidateRect(),this._isDirty=!1),!0}_postMeasure(){}_draw(e,t){const i=this._renderToIntermediateTexture&&this._intermediateTexture,r=i?this._intermediateTexture.getContext():e;i&&(r.save(),r.translate(-this._currentMeasure.left,-this._currentMeasure.top),t?(this._transformMatrix.invertToRef(this._inverseTransformMatrix),t.transformToRef(this._inverseTransformMatrix,this._inverseMeasure),r.clearRect(this._inverseMeasure.left,this._inverseMeasure.top,this._inverseMeasure.width,this._inverseMeasure.height)):r.clearRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),this._localDraw(r),e.save(),this.clipChildren&&this._clipForChildren(r);for(const s of this._children)t&&!s._intersectsRect(t)||s._render(r,t);i&&(r.restore(),e.save(),e.globalAlpha=this.alpha,e.drawImage(r.canvas,this._currentMeasure.left,this._currentMeasure.top),e.restore()),e.restore()}getDescendantsToRef(e,t=!1,i){if(this.children)for(let r=0;r<this.children.length;r++){const s=this.children[r];(!i||i(s))&&e.push(s),t||s.getDescendantsToRef(e,!1,i)}}_processPicking(e,t,i,r,s,n,o,l){if(!this._isEnabled||!this.isVisible||this.notRenderable)return!1;const h=super.contains(e,t);if(!h&&this.clipChildren)return!1;for(let u=this._children.length-1;u>=0;u--){const c=this._children[u];if(c._processPicking(e,t,i,r,s,n,o,l))return c.hoverCursor&&this._host._changeCursor(c.hoverCursor),!0}return!h||!this.isHitTestVisible?!1:this._processObservables(r,e,t,i,s,n,o,l)}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.copyFrom(this._currentMeasure)}serialize(e){if(super.serialize(e),this.backgroundGradient&&(e.backgroundGradient={},this.backgroundGradient.serialize(e.backgroundGradient)),!!this.children.length){e.children=[];for(const t of this.children){const i={};t.serialize(i),e.children.push(i)}}}dispose(){var e;super.dispose();for(let t=this.children.length-1;t>=0;t--)this.children[t].dispose();(e=this._intermediateTexture)===null||e===void 0||e.dispose()}_parseFromContent(e,t){var i;if(super._parseFromContent(e,t),this._link(t),e.backgroundGradient){const r=Tools.Instantiate("BABYLON.GUI."+e.backgroundGradient.className);this._backgroundGradient=new r,(i=this._backgroundGradient)===null||i===void 0||i.parse(e.backgroundGradient)}if(e.children)for(const r of e.children)this.addControl(Control.Parse(r,t))}isReady(){for(const e of this.children)if(!e.isReady())return!1;return!0}}__decorate([serialize()],Container.prototype,"renderToIntermediateTexture",null);__decorate([serialize()],Container.prototype,"maxLayoutCycle",void 0);__decorate([serialize()],Container.prototype,"adaptHeightToChildren",null);__decorate([serialize()],Container.prototype,"adaptWidthToChildren",null);__decorate([serialize()],Container.prototype,"background",null);__decorate([serialize()],Container.prototype,"backgroundGradient",null);RegisterClass("BABYLON.GUI.Container",Container);class Rectangle extends Container{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get cornerRadius(){return this._cornerRadius[0]}set cornerRadius(e){e<0&&(e=0),!(this._cornerRadius[0]===e&&this._cornerRadius[1]===e&&this._cornerRadius[2]===e&&this._cornerRadius[3]===e)&&(this._cornerRadius[0]=this._cornerRadius[1]=this._cornerRadius[2]=this._cornerRadius[3]=e,this._markAsDirty())}get cornerRadiusX(){return this._cornerRadius[0]}set cornerRadiusX(e){this._cornerRadius[0]!==e&&(this._cornerRadius[0]=e)}get cornerRadiusY(){return this._cornerRadius[1]}set cornerRadiusY(e){this._cornerRadius[1]!==e&&(this._cornerRadius[1]=e)}get cornerRadiusZ(){return this._cornerRadius[2]}set cornerRadiusZ(e){this._cornerRadius[2]!==e&&(this._cornerRadius[2]=e)}get cornerRadiusW(){return this._cornerRadius[3]}set cornerRadiusW(e){this._cornerRadius[3]!==e&&(this._cornerRadius[3]=e)}constructor(e){super(e),this.name=e,this._thickness=1,this._cornerRadius=[0,0,0,0],this._cachedRadius=[0,0,0,0]}_getTypeName(){return"Rectangle"}_computeAdditionnalOffsetX(){return this._cornerRadius[0]!==0||this._cornerRadius[1]!==0||this._cornerRadius[2]!==0||this._cornerRadius[3]!==0?1:0}_computeAdditionnalOffsetY(){return this._cornerRadius[0]!==0||this._cornerRadius[1]!==0||this._cornerRadius[2]!==0||this._cornerRadius[3]!==0?1:0}_getRectangleFill(e){return this._getBackgroundColor(e)}_localDraw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),(this._background||this._backgroundGradient)&&(e.fillStyle=this._getRectangleFill(e),this._cornerRadius[0]!==0||this._cornerRadius[1]!==0||this._cornerRadius[2]!==0||this._cornerRadius[3]!==0?(this._drawRoundedRect(e,this._thickness/2),e.fill()):e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),this._thickness&&((this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),(this.color||this.gradient)&&(e.strokeStyle=this.gradient?this.gradient.getCanvasGradient(e):this.color),e.lineWidth=this._thickness,this._cornerRadius[0]!==0||this._cornerRadius[1]!==0||this._cornerRadius[2]!==0||this._cornerRadius[3]!==0?(this._drawRoundedRect(e,this._thickness/2),e.stroke()):e.strokeRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,this._currentMeasure.width-this._thickness,this._currentMeasure.height-this._thickness)),e.restore()}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.width-=2*this._thickness,this._measureForChildren.height-=2*this._thickness,this._measureForChildren.left+=this._thickness,this._measureForChildren.top+=this._thickness}_drawRoundedRect(e,t=0){const i=this._currentMeasure.left+t,r=this._currentMeasure.top+t,s=this._currentMeasure.width-t*2,n=this._currentMeasure.height-t*2;for(let o=0;o<this._cornerRadius.length;o++)this._cachedRadius[o]=Math.abs(Math.min(n/2,Math.min(s/2,this._cornerRadius[o])));e.beginPath(),e.moveTo(i+this._cachedRadius[0],r),e.lineTo(i+s-this._cachedRadius[1],r),e.arc(i+s-this._cachedRadius[1],r+this._cachedRadius[1],this._cachedRadius[1],3*Math.PI/2,Math.PI*2),e.lineTo(i+s,r+n-this._cachedRadius[2]),e.arc(i+s-this._cachedRadius[2],r+n-this._cachedRadius[2],this._cachedRadius[2],0,Math.PI/2),e.lineTo(i+this._cachedRadius[3],r+n),e.arc(i+this._cachedRadius[3],r+n-this._cachedRadius[3],this._cachedRadius[3],Math.PI/2,Math.PI),e.lineTo(i,r+this._cachedRadius[0]),e.arc(i+this._cachedRadius[0],r+this._cachedRadius[0],this._cachedRadius[0],Math.PI,3*Math.PI/2),e.closePath()}_clipForChildren(e){(this._cornerRadius[0]!==0||this._cornerRadius[1]!==0||this._cornerRadius[2]!==0||this._cornerRadius[3]!==0)&&(this._drawRoundedRect(e,this._thickness),e.clip())}}__decorate([serialize()],Rectangle.prototype,"thickness",null);__decorate([serialize()],Rectangle.prototype,"cornerRadius",null);__decorate([serialize()],Rectangle.prototype,"cornerRadiusX",null);__decorate([serialize()],Rectangle.prototype,"cornerRadiusY",null);__decorate([serialize()],Rectangle.prototype,"cornerRadiusZ",null);__decorate([serialize()],Rectangle.prototype,"cornerRadiusW",null);RegisterClass("BABYLON.GUI.Rectangle",Rectangle);var TextWrapping;(function(a){a[a.Clip=0]="Clip",a[a.WordWrap=1]="WordWrap",a[a.Ellipsis=2]="Ellipsis",a[a.WordWrapEllipsis=3]="WordWrapEllipsis"})(TextWrapping||(TextWrapping={}));class TextBlock extends Control{get lines(){return this._lines}get resizeToFit(){return this._resizeToFit}set resizeToFit(e){this._resizeToFit!==e&&(this._resizeToFit=e,this._resizeToFit&&(this._width.ignoreAdaptiveScaling=!0,this._height.ignoreAdaptiveScaling=!0),this._markAsDirty())}get textWrapping(){return this._textWrapping}set textWrapping(e){this._textWrapping!==e&&(this._textWrapping=+e,this._markAsDirty())}get text(){return this._text}set text(e){this._text!==e&&(this._text=e+"",this._markAsDirty(),this.onTextChangedObservable.notifyObservers(this))}get textHorizontalAlignment(){return this._textHorizontalAlignment}set textHorizontalAlignment(e){this._textHorizontalAlignment!==e&&(this._textHorizontalAlignment=e,this._markAsDirty())}get textVerticalAlignment(){return this._textVerticalAlignment}set textVerticalAlignment(e){this._textVerticalAlignment!==e&&(this._textVerticalAlignment=e,this._markAsDirty())}set lineSpacing(e){this._lineSpacing.fromString(e)&&this._markAsDirty()}get lineSpacing(){return this._lineSpacing.toString(this._host)}get outlineWidth(){return this._outlineWidth}set outlineWidth(e){this._outlineWidth!==e&&(this._outlineWidth=e,this._markAsDirty())}get underline(){return this._underline}set underline(e){this._underline!==e&&(this._underline=e,this._markAsDirty())}get lineThrough(){return this._lineThrough}set lineThrough(e){this._lineThrough!==e&&(this._lineThrough=e,this._markAsDirty())}get applyOutlineToUnderline(){return this._applyOutlineToUnderline}set applyOutlineToUnderline(e){this._applyOutlineToUnderline!==e&&(this._applyOutlineToUnderline=e,this._markAsDirty())}get outlineColor(){return this._outlineColor}set outlineColor(e){this._outlineColor!==e&&(this._outlineColor=e,this._markAsDirty())}get wordDivider(){return this._wordDivider}set wordDivider(e){this._wordDivider!==e&&(this._wordDivider=e,this._markAsDirty())}get forceResizeWidth(){return this._forceResizeWidth}set forceResizeWidth(e){this._forceResizeWidth!==e&&(this._forceResizeWidth=e,this._markAsDirty())}constructor(e,t=""){super(e),this.name=e,this._text="",this._textWrapping=TextWrapping.Clip,this._textHorizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,this._textVerticalAlignment=Control.VERTICAL_ALIGNMENT_CENTER,this._resizeToFit=!1,this._lineSpacing=new ValueAndUnit(0),this._outlineWidth=0,this._outlineColor="white",this._underline=!1,this._lineThrough=!1,this._wordDivider=" ",this._forceResizeWidth=!1,this._applyOutlineToUnderline=!1,this.onTextChangedObservable=new Observable,this.onLinesReadyObservable=new Observable,this._linesTemp=[],this.text=t}_getTypeName(){return"TextBlock"}_processMeasures(e,t){(!this._fontOffset||this.isDirty)&&(this._fontOffset=Control._GetFontOffset(t.font)),super._processMeasures(e,t),this._lines=this._breakLines(this._currentMeasure.width,this._currentMeasure.height,t),this.onLinesReadyObservable.notifyObservers(this);let i=0;for(let r=0;r<this._lines.length;r++){const s=this._lines[r];s.width>i&&(i=s.width)}if(this._resizeToFit){if(this._textWrapping===TextWrapping.Clip||this._forceResizeWidth){const s=Math.ceil(this._paddingLeftInPixels)+Math.ceil(this._paddingRightInPixels)+Math.ceil(i);s!==this._width.getValueInPixel(this._host,this._tempParentMeasure.width)&&(this._width.updateInPlace(s,ValueAndUnit.UNITMODE_PIXEL),this._rebuildLayout=!0)}let r=this._paddingTopInPixels+this._paddingBottomInPixels+this._fontOffset.height*this._lines.length|0;if(this._lines.length>0&&this._lineSpacing.internalValue!==0){let s=0;this._lineSpacing.isPixel?s=this._lineSpacing.getValue(this._host):s=this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height),r+=(this._lines.length-1)*s}r!==this._height.internalValue&&(this._height.updateInPlace(r,ValueAndUnit.UNITMODE_PIXEL),this._rebuildLayout=!0)}}_drawText(e,t,i,r){const s=this._currentMeasure.width;let n=0;switch(this._textHorizontalAlignment){case Control.HORIZONTAL_ALIGNMENT_LEFT:n=0;break;case Control.HORIZONTAL_ALIGNMENT_RIGHT:n=s-t;break;case Control.HORIZONTAL_ALIGNMENT_CENTER:n=(s-t)/2;break}(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(r.shadowColor=this.shadowColor,r.shadowBlur=this.shadowBlur,r.shadowOffsetX=this.shadowOffsetX,r.shadowOffsetY=this.shadowOffsetY),this.outlineWidth&&r.strokeText(e,this._currentMeasure.left+n,i),r.fillText(e,this._currentMeasure.left+n,i),this._underline&&this._drawLine(this._currentMeasure.left+n,i+3,this._currentMeasure.left+n+t,i+3,r),this._lineThrough&&this._drawLine(this._currentMeasure.left+n,i-this.fontSizeInPixels/3,this._currentMeasure.left+n+t,i-this.fontSizeInPixels/3,r)}_drawLine(e,t,i,r,s){if(s.beginPath(),s.lineWidth=Math.round(this.fontSizeInPixels*.05),s.moveTo(e,t),s.lineTo(i,r),this.outlineWidth&&this.applyOutlineToUnderline)s.stroke(),s.fill();else{const n=s.strokeStyle;s.strokeStyle=s.fillStyle,s.stroke(),s.strokeStyle=n}s.closePath()}_draw(e){e.save(),this._applyStates(e),this._renderLines(e),e.restore()}_applyStates(e){super._applyStates(e),this.outlineWidth&&(e.lineWidth=this.outlineWidth,e.strokeStyle=this.outlineColor,e.lineJoin="miter",e.miterLimit=2)}_breakLines(e,t,i){this._linesTemp.length=0;const r=this.text.split(`
`);if(this._textWrapping===TextWrapping.Ellipsis)for(const s of r)this._linesTemp.push(this._parseLineEllipsis(s,e,i));else if(this._textWrapping===TextWrapping.WordWrap)for(const s of r)this._linesTemp.push(...this._parseLineWordWrap(s,e,i));else if(this._textWrapping===TextWrapping.WordWrapEllipsis)for(const s of r)this._linesTemp.push(...this._parseLineWordWrapEllipsis(s,e,t,i));else for(const s of r)this._linesTemp.push(this._parseLine(s,i));return this._linesTemp}_parseLine(e="",t){return{text:e,width:this._getTextMetricsWidth(t.measureText(e))}}_getCharsToRemove(e,t,i){const r=e>t?e-t:0,s=e/i;return Math.max(Math.floor(r/s),1)}_parseLineEllipsis(e="",t,i){let r=this._getTextMetricsWidth(i.measureText(e)),s=this._getCharsToRemove(r,t,e.length);const n=Array.from&&Array.from(e);if(n)for(;n.length&&r>t;)n.splice(n.length-s,s),e=`${n.join("")}…`,r=this._getTextMetricsWidth(i.measureText(e)),s=this._getCharsToRemove(r,t,e.length);else{for(;e.length>2&&r>t;)e=e.slice(0,-s),r=this._getTextMetricsWidth(i.measureText(e+"…")),s=this._getCharsToRemove(r,t,e.length);e+="…"}return{text:e,width:r}}_getTextMetricsWidth(e){return e.actualBoundingBoxLeft!==void 0?Math.abs(e.actualBoundingBoxLeft)+Math.abs(e.actualBoundingBoxRight):e.width}_parseLineWordWrap(e="",t,i){const r=[],s=this.wordSplittingFunction?this.wordSplittingFunction(e):e.split(this._wordDivider);let n=this._getTextMetricsWidth(i.measureText(e));for(let o=0;o<s.length;o++){const l=o>0?e+this._wordDivider+s[o]:s[0],h=this._getTextMetricsWidth(i.measureText(l));h>t&&o>0?(r.push({text:e,width:n}),e=s[o],n=this._getTextMetricsWidth(i.measureText(e))):(n=h,e=l)}return r.push({text:e,width:n}),r}_parseLineWordWrapEllipsis(e="",t,i,r){const s=this._parseLineWordWrap(e,t,r);for(let n=1;n<=s.length;n++)if(this._computeHeightForLinesOf(n)>i&&n>1){const l=s[n-2],h=s[n-1];s[n-2]=this._parseLineEllipsis(l.text+this._wordDivider+h.text,t,r);const u=s.length-n+1;for(let c=0;c<u;c++)s.pop();return s}return s}_renderLines(e){if(!this._fontOffset||!this._lines)return;const t=this._currentMeasure.height;let i=0;switch(this._textVerticalAlignment){case Control.VERTICAL_ALIGNMENT_TOP:i=this._fontOffset.ascent;break;case Control.VERTICAL_ALIGNMENT_BOTTOM:i=t-this._fontOffset.height*(this._lines.length-1)-this._fontOffset.descent;break;case Control.VERTICAL_ALIGNMENT_CENTER:i=this._fontOffset.ascent+(t-this._fontOffset.height*this._lines.length)/2;break}i+=this._currentMeasure.top;for(let r=0;r<this._lines.length;r++){const s=this._lines[r];r!==0&&this._lineSpacing.internalValue!==0&&(this._lineSpacing.isPixel?i+=this._lineSpacing.getValue(this._host):i=i+this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height)),this._drawText(s.text,s.width,i,e),i+=this._fontOffset.height}}_computeHeightForLinesOf(e){let t=this._paddingTopInPixels+this._paddingBottomInPixels+this._fontOffset.height*e;if(e>0&&this._lineSpacing.internalValue!==0){let i=0;this._lineSpacing.isPixel?i=this._lineSpacing.getValue(this._host):i=this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height),t+=(e-1)*i}return t}computeExpectedHeight(){var e;if(this.text&&this.widthInPixels){const t=(e=EngineStore.LastCreatedEngine)===null||e===void 0?void 0:e.createCanvas(0,0).getContext("2d");if(t){this._applyStates(t),this._fontOffset||(this._fontOffset=Control._GetFontOffset(t.font));const i=this._lines?this._lines:this._breakLines(this.widthInPixels-this._paddingLeftInPixels-this._paddingRightInPixels,this.heightInPixels-this._paddingTopInPixels-this._paddingBottomInPixels,t);return this._computeHeightForLinesOf(i.length)}}return 0}dispose(){super.dispose(),this.onTextChangedObservable.clear()}}__decorate([serialize()],TextBlock.prototype,"resizeToFit",null);__decorate([serialize()],TextBlock.prototype,"textWrapping",null);__decorate([serialize()],TextBlock.prototype,"text",null);__decorate([serialize()],TextBlock.prototype,"textHorizontalAlignment",null);__decorate([serialize()],TextBlock.prototype,"textVerticalAlignment",null);__decorate([serialize()],TextBlock.prototype,"lineSpacing",null);__decorate([serialize()],TextBlock.prototype,"outlineWidth",null);__decorate([serialize()],TextBlock.prototype,"underline",null);__decorate([serialize()],TextBlock.prototype,"lineThrough",null);__decorate([serialize()],TextBlock.prototype,"applyOutlineToUnderline",null);__decorate([serialize()],TextBlock.prototype,"outlineColor",null);__decorate([serialize()],TextBlock.prototype,"wordDivider",null);__decorate([serialize()],TextBlock.prototype,"forceResizeWidth",null);RegisterClass("BABYLON.GUI.TextBlock",TextBlock);let Image$1=class se extends Control{get isLoaded(){return this._loaded}isReady(){return this.isLoaded}get detectPointerOnOpaqueOnly(){return this._detectPointerOnOpaqueOnly}set detectPointerOnOpaqueOnly(e){this._detectPointerOnOpaqueOnly!==e&&(this._detectPointerOnOpaqueOnly=e)}get sliceLeft(){return this._sliceLeft}set sliceLeft(e){this._sliceLeft!==e&&(this._sliceLeft=e,this._markAsDirty())}get sliceRight(){return this._sliceRight}set sliceRight(e){this._sliceRight!==e&&(this._sliceRight=e,this._markAsDirty())}get sliceTop(){return this._sliceTop}set sliceTop(e){this._sliceTop!==e&&(this._sliceTop=e,this._markAsDirty())}get sliceBottom(){return this._sliceBottom}set sliceBottom(e){this._sliceBottom!==e&&(this._sliceBottom=e,this._markAsDirty())}get sourceLeft(){return this._sourceLeft}set sourceLeft(e){this._sourceLeft!==e&&(this._sourceLeft=e,this._markAsDirty())}get sourceTop(){return this._sourceTop}set sourceTop(e){this._sourceTop!==e&&(this._sourceTop=e,this._markAsDirty())}get sourceWidth(){return this._sourceWidth}set sourceWidth(e){this._sourceWidth!==e&&(this._sourceWidth=e,this._markAsDirty())}get sourceHeight(){return this._sourceHeight}set sourceHeight(e){this._sourceHeight!==e&&(this._sourceHeight=e,this._markAsDirty())}get imageWidth(){return this._imageWidth}get imageHeight(){return this._imageHeight}get populateNinePatchSlicesFromImage(){return this._populateNinePatchSlicesFromImage}set populateNinePatchSlicesFromImage(e){this._populateNinePatchSlicesFromImage!==e&&(this._populateNinePatchSlicesFromImage=e,this._populateNinePatchSlicesFromImage&&this._loaded&&this._extractNinePatchSliceDataFromImage())}get isSVG(){return this._isSVG}get svgAttributesComputationCompleted(){return this._svgAttributesComputationCompleted}get autoScale(){return this._autoScale}set autoScale(e){this._autoScale!==e&&(this._autoScale=e,e&&this._loaded&&this.synchronizeSizeWithContent())}get stretch(){return this._stretch}set stretch(e){this._stretch!==e&&(this._stretch=e,this._markAsDirty())}_rotate90(e,t=!1){var i,r;const s=this._domImage.width,n=this._domImage.height,o=((r=(i=this._host)===null||i===void 0?void 0:i.getScene())===null||r===void 0?void 0:r.getEngine())||EngineStore.LastCreatedEngine;if(!o)throw new Error("Invalid engine. Unable to create a canvas.");const l=o.createCanvas(n,s),h=l.getContext("2d");h.translate(l.width/2,l.height/2),h.rotate(e*Math.PI/2),h.drawImage(this._domImage,0,0,s,n,-s/2,-n/2,s,n);const u=l.toDataURL("image/jpg"),c=new se(this.name+"rotated",u);return t&&(c._stretch=this._stretch,c._autoScale=this._autoScale,c._cellId=this._cellId,c._cellWidth=e%1?this._cellHeight:this._cellWidth,c._cellHeight=e%1?this._cellWidth:this._cellHeight),this._handleRotationForSVGImage(this,c,e),this._imageDataCache.data=null,c}_handleRotationForSVGImage(e,t,i){e._isSVG&&(e._svgAttributesComputationCompleted?(this._rotate90SourceProperties(e,t,i),this._markAsDirty()):e.onSVGAttributesComputedObservable.addOnce(()=>{this._rotate90SourceProperties(e,t,i),this._markAsDirty()}))}_rotate90SourceProperties(e,t,i){let r=e.sourceLeft,s=e.sourceTop,n=e.domImage.width,o=e.domImage.height,l=r,h=s,u=e.sourceWidth,c=e.sourceHeight;if(i!=0){const d=i<0?-1:1;i=i%4;for(let f=0;f<Math.abs(i);++f)l=-(s-o/2)*d+o/2,h=(r-n/2)*d+n/2,[u,c]=[c,u],i<0?h-=c:l-=u,r=l,s=h,[n,o]=[o,n]}t.sourceLeft=l,t.sourceTop=h,t.sourceWidth=u,t.sourceHeight=c}_extractNinePatchSliceDataFromImage(){var e,t;const i=this._domImage.width,r=this._domImage.height;if(!this._workingCanvas){const l=((t=(e=this._host)===null||e===void 0?void 0:e.getScene())===null||t===void 0?void 0:t.getEngine())||EngineStore.LastCreatedEngine;if(!l)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=l.createCanvas(i,r)}const n=this._workingCanvas.getContext("2d");n.drawImage(this._domImage,0,0,i,r);const o=n.getImageData(0,0,i,r);this._sliceLeft=-1,this._sliceRight=-1;for(let l=0;l<i;l++){const h=o.data[l*4+3];if(h>127&&this._sliceLeft===-1){this._sliceLeft=l;continue}if(h<127&&this._sliceLeft>-1){this._sliceRight=l;break}}this._sliceTop=-1,this._sliceBottom=-1;for(let l=0;l<r;l++){const h=o.data[l*i*4+3];if(h>127&&this._sliceTop===-1){this._sliceTop=l;continue}if(h<127&&this._sliceTop>-1){this._sliceBottom=l;break}}}set domImage(e){this._domImage=e,this._loaded=!1,this._imageDataCache.data=null,this._domImage.width?this._onImageLoaded():this._domImage.onload=()=>{this._onImageLoaded()}}get domImage(){return this._domImage}_onImageLoaded(){this._imageDataCache.data=null,this._imageWidth=this._domImage.width,this._imageHeight=this._domImage.height,this._loaded=!0,this._populateNinePatchSlicesFromImage&&this._extractNinePatchSliceDataFromImage(),this._autoScale&&this.synchronizeSizeWithContent(),this.onImageLoadedObservable.notifyObservers(this),this._markAsDirty()}get source(){return this._source}static ResetImageCache(){se.SourceImgCache.clear()}_removeCacheUsage(e){const t=e&&se.SourceImgCache.get(e);t&&(t.timesUsed-=1,t.timesUsed===0&&se.SourceImgCache.delete(e))}set source(e){var t,i;if(this._source===e)return;this._removeCacheUsage(this._source),this._loaded=!1,this._source=e,this._imageDataCache.data=null,e&&(e=this._svgCheck(e));const r=((i=(t=this._host)===null||t===void 0?void 0:t.getScene())===null||i===void 0?void 0:i.getEngine())||EngineStore.LastCreatedEngine;if(!r)throw new Error("Invalid engine. Unable to create a canvas.");if(e&&se.SourceImgCache.has(e)){const s=se.SourceImgCache.get(e);this._domImage=s.img,s.timesUsed+=1,s.loaded?this._onImageLoaded():s.waitingForLoadCallback.push(this._onImageLoaded.bind(this));return}this._domImage=r.createCanvasImage(),e&&se.SourceImgCache.set(e,{img:this._domImage,timesUsed:1,loaded:!1,waitingForLoadCallback:[this._onImageLoaded.bind(this)]}),this._domImage.onload=()=>{if(e){const s=se.SourceImgCache.get(e);if(s){s.loaded=!0;for(const n of s.waitingForLoadCallback)n();s.waitingForLoadCallback.length=0;return}}this._onImageLoaded()},e&&(Tools.SetCorsBehavior(e,this._domImage),Tools.SetReferrerPolicyBehavior(this.referrerPolicy,this._domImage),this._domImage.src=e)}_svgCheck(e){if(window.SVGSVGElement&&e.search(/.svg#/gi)!==-1&&e.indexOf("#")===e.lastIndexOf("#")){this._isSVG=!0;const t=e.split("#")[0],i=e.split("#")[1],r=document.body.querySelector('object[data="'+t+'"]');if(r){const s=r.contentDocument;if(s&&s.documentElement){const n=s.documentElement.getAttribute("viewBox"),o=Number(s.documentElement.getAttribute("width")),l=Number(s.documentElement.getAttribute("height"));if(s.getElementById(i)&&n&&o&&l)return this._getSVGAttribs(r,i),e}r.addEventListener("load",()=>{this._getSVGAttribs(r,i)})}else{const s=document.createElement("object");s.data=t,s.type="image/svg+xml",s.width="0%",s.height="0%",document.body.appendChild(s),s.onload=()=>{const n=document.body.querySelector('object[data="'+t+'"]');n&&this._getSVGAttribs(n,i)}}return t}else return e}_getSVGAttribs(e,t){const i=e.contentDocument;if(i&&i.documentElement){const r=i.documentElement.getAttribute("viewBox"),s=Number(i.documentElement.getAttribute("width")),n=Number(i.documentElement.getAttribute("height")),o=i.getElementById(t);if(r&&s&&n&&o){const l=Number(r.split(" ")[2]),h=Number(r.split(" ")[3]),u=o.getBBox();let c=1,d=1,f=0,_=0;const g=o.transform.baseVal.consolidate().matrix;o.transform&&o.transform.baseVal.consolidate()&&(c=g.a,d=g.d,f=g.e,_=g.f),this.sourceLeft=(c*u.x+f)*s/l,this.sourceTop=(d*u.y+_)*n/h,this.sourceWidth=u.width*c*(s/l),this.sourceHeight=u.height*d*(n/h),this._svgAttributesComputationCompleted=!0,this.onSVGAttributesComputedObservable.notifyObservers(this)}}}get cellWidth(){return this._cellWidth}set cellWidth(e){this._cellWidth!==e&&(this._cellWidth=e,this._markAsDirty())}get cellHeight(){return this._cellHeight}set cellHeight(e){this._cellHeight!==e&&(this._cellHeight=e,this._markAsDirty())}get cellId(){return this._cellId}set cellId(e){this._cellId!==e&&(this._cellId=e,this._markAsDirty())}constructor(e,t=null){super(e),this.name=e,this._workingCanvas=null,this._loaded=!1,this._stretch=se.STRETCH_FILL,this._autoScale=!1,this._sourceLeft=0,this._sourceTop=0,this._sourceWidth=0,this._sourceHeight=0,this._svgAttributesComputationCompleted=!1,this._isSVG=!1,this._cellWidth=0,this._cellHeight=0,this._cellId=-1,this._populateNinePatchSlicesFromImage=!1,this._imageDataCache={data:null,key:""},this.onImageLoadedObservable=new Observable,this.onSVGAttributesComputedObservable=new Observable,this.source=t}contains(e,t){if(!super.contains(e,t))return!1;if(!this._detectPointerOnOpaqueOnly||!this._workingCanvas)return!0;const i=this._currentMeasure.width|0,r=this._currentMeasure.height|0,s=i+"_"+r;let n=this._imageDataCache.data;if(!n||this._imageDataCache.key!==s){const h=this._workingCanvas.getContext("2d");this._imageDataCache.data=n=h.getImageData(0,0,i,r).data,this._imageDataCache.key=s}return e=e-this._currentMeasure.left|0,t=t-this._currentMeasure.top|0,n[(e+t*i)*4+3]>0}_getTypeName(){return"Image"}synchronizeSizeWithContent(){this._loaded&&(this.width=this._domImage.width+"px",this.height=this._domImage.height+"px")}_processMeasures(e,t){if(this._loaded)switch(this._stretch){case se.STRETCH_NONE:break;case se.STRETCH_FILL:break;case se.STRETCH_UNIFORM:break;case se.STRETCH_NINE_PATCH:break;case se.STRETCH_EXTEND:this._autoScale&&this.synchronizeSizeWithContent(),this.parent&&this.parent.parent&&(this.parent.adaptWidthToChildren=!0,this.parent.adaptHeightToChildren=!0);break}super._processMeasures(e,t)}_prepareWorkingCanvasForOpaqueDetection(){var e,t;if(!this._detectPointerOnOpaqueOnly)return;const i=this._currentMeasure.width,r=this._currentMeasure.height;if(!this._workingCanvas){const o=((t=(e=this._host)===null||e===void 0?void 0:e.getScene())===null||t===void 0?void 0:t.getEngine())||EngineStore.LastCreatedEngine;if(!o)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=o.createCanvas(i,r)}this._workingCanvas.getContext("2d").clearRect(0,0,i,r)}_drawImage(e,t,i,r,s,n,o,l,h){if(e.drawImage(this._domImage,t,i,r,s,n,o,l,h),!this._detectPointerOnOpaqueOnly)return;e=this._workingCanvas.getContext("2d"),e.drawImage(this._domImage,t,i,r,s,n-this._currentMeasure.left,o-this._currentMeasure.top,l,h)}_draw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY);let t,i,r,s;if(this.cellId==-1)t=this._sourceLeft,i=this._sourceTop,r=this._sourceWidth?this._sourceWidth:this._imageWidth,s=this._sourceHeight?this._sourceHeight:this._imageHeight;else{const n=this._domImage.naturalWidth/this.cellWidth,o=this.cellId/n>>0,l=this.cellId%n;t=this.cellWidth*l,i=this.cellHeight*o,r=this.cellWidth,s=this.cellHeight}if(this._prepareWorkingCanvasForOpaqueDetection(),this._applyStates(e),this._loaded)switch(this._stretch){case se.STRETCH_NONE:this._drawImage(e,t,i,r,s,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height);break;case se.STRETCH_FILL:this._drawImage(e,t,i,r,s,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height);break;case se.STRETCH_UNIFORM:{const n=this._currentMeasure.width/r,o=this._currentMeasure.height/s,l=Math.min(n,o),h=(this._currentMeasure.width-r*l)/2,u=(this._currentMeasure.height-s*l)/2;this._drawImage(e,t,i,r,s,this._currentMeasure.left+h,this._currentMeasure.top+u,r*l,s*l);break}case se.STRETCH_EXTEND:this._drawImage(e,t,i,r,s,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height);break;case se.STRETCH_NINE_PATCH:this._renderNinePatch(e);break}e.restore()}_renderNinePatch(e){const t=this._sliceLeft,i=this._sliceTop,r=this._imageHeight-this._sliceBottom,s=this._imageWidth-this._sliceRight,n=this._sliceRight-this._sliceLeft,o=this._sliceBottom-this._sliceTop,l=this._currentMeasure.width-s-t+2,h=this._currentMeasure.height-r-i+2,u=this._currentMeasure.left+t-1,c=this._currentMeasure.top+i-1,d=this._currentMeasure.left+this._currentMeasure.width-s,f=this._currentMeasure.top+this._currentMeasure.height-r;this._drawImage(e,0,0,t,i,this._currentMeasure.left,this._currentMeasure.top,t,i),e.clearRect(u,this._currentMeasure.top,l,i),this._drawImage(e,this._sliceLeft,0,n,i,u,this._currentMeasure.top,l,i),e.clearRect(d,this._currentMeasure.top,s,i),this._drawImage(e,this._sliceRight,0,s,i,d,this._currentMeasure.top,s,i),e.clearRect(this._currentMeasure.left,c,t,h),this._drawImage(e,0,this._sliceTop,t,o,this._currentMeasure.left,c,t,h),e.clearRect(u,c,l,h),this._drawImage(e,this._sliceLeft,this._sliceTop,n,o,u,c,l,h),e.clearRect(d,c,s,h),this._drawImage(e,this._sliceRight,this._sliceTop,s,o,d,c,s,h),e.clearRect(this._currentMeasure.left,f,t,r),this._drawImage(e,0,this._sliceBottom,t,r,this._currentMeasure.left,f,t,r),e.clearRect(u,f,l,r),this._drawImage(e,this.sliceLeft,this._sliceBottom,n,r,u,f,l,r),e.clearRect(d,f,s,r),this._drawImage(e,this._sliceRight,this._sliceBottom,s,r,d,f,s,r)}dispose(){super.dispose(),this.onImageLoadedObservable.clear(),this.onSVGAttributesComputedObservable.clear(),this._removeCacheUsage(this._source)}};Image$1.SourceImgCache=new Map;Image$1.STRETCH_NONE=0;Image$1.STRETCH_FILL=1;Image$1.STRETCH_UNIFORM=2;Image$1.STRETCH_EXTEND=3;Image$1.STRETCH_NINE_PATCH=4;__decorate([serialize()],Image$1.prototype,"detectPointerOnOpaqueOnly",null);__decorate([serialize()],Image$1.prototype,"sliceLeft",null);__decorate([serialize()],Image$1.prototype,"sliceRight",null);__decorate([serialize()],Image$1.prototype,"sliceTop",null);__decorate([serialize()],Image$1.prototype,"sliceBottom",null);__decorate([serialize()],Image$1.prototype,"sourceLeft",null);__decorate([serialize()],Image$1.prototype,"sourceTop",null);__decorate([serialize()],Image$1.prototype,"sourceWidth",null);__decorate([serialize()],Image$1.prototype,"sourceHeight",null);__decorate([serialize()],Image$1.prototype,"populateNinePatchSlicesFromImage",null);__decorate([serialize()],Image$1.prototype,"autoScale",null);__decorate([serialize()],Image$1.prototype,"stretch",null);__decorate([serialize()],Image$1.prototype,"source",null);__decorate([serialize()],Image$1.prototype,"cellWidth",null);__decorate([serialize()],Image$1.prototype,"cellHeight",null);__decorate([serialize()],Image$1.prototype,"cellId",null);RegisterClass("BABYLON.GUI.Image",Image$1);class Button extends Rectangle{get image(){return this._image}get textBlock(){return this._textBlock}constructor(e){super(e),this.name=e,this.delegatePickingToChildren=!1,this.thickness=1,this.isPointerBlocker=!0;let t=null;this.pointerEnterAnimation=()=>{t=this.alpha,this.alpha-=.1},this.pointerOutAnimation=()=>{t!==null&&(this.alpha=t)},this.pointerDownAnimation=()=>{this.scaleX-=.05,this.scaleY-=.05},this.pointerUpAnimation=()=>{this.scaleX+=.05,this.scaleY+=.05}}_getTypeName(){return"Button"}_processPicking(e,t,i,r,s,n,o,l){if(!this._isEnabled||!this.isHitTestVisible||!this.isVisible||this.notRenderable||!super.contains(e,t))return!1;if(this.delegatePickingToChildren){let h=!1;for(let u=this._children.length-1;u>=0;u--){const c=this._children[u];if(c.isEnabled&&c.isHitTestVisible&&c.isVisible&&!c.notRenderable&&c.contains(e,t)){h=!0;break}}if(!h)return!1}return this._processObservables(r,e,t,i,s,n,o,l),!0}_onPointerEnter(e,t){return super._onPointerEnter(e,t)?(!this.isReadOnly&&this.pointerEnterAnimation&&this.pointerEnterAnimation(),!0):!1}_onPointerOut(e,t,i=!1){!this.isReadOnly&&this.pointerOutAnimation&&this.pointerOutAnimation(),super._onPointerOut(e,t,i)}_onPointerDown(e,t,i,r,s){return super._onPointerDown(e,t,i,r,s)?(!this.isReadOnly&&this.pointerDownAnimation&&this.pointerDownAnimation(),!0):!1}_getRectangleFill(e){return this.isEnabled?this._getBackgroundColor(e):this._disabledColor}_onPointerUp(e,t,i,r,s,n){!this.isReadOnly&&this.pointerUpAnimation&&this.pointerUpAnimation(),super._onPointerUp(e,t,i,r,s,n)}serialize(e){super.serialize(e),this._textBlock&&(e.textBlockName=this._textBlock.name),this._image&&(e.imageName=this._image.name)}_parseFromContent(e,t){super._parseFromContent(e,t),e.textBlockName&&(this._textBlock=this.getChildByName(e.textBlockName)),e.imageName&&(this._image=this.getChildByName(e.imageName))}static CreateImageButton(e,t,i){const r=new this(e),s=new TextBlock(e+"_button",t);s.textWrapping=!0,s.textHorizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,s.paddingLeft="20%",r.addControl(s);const n=new Image$1(e+"_icon",i);return n.width="20%",n.stretch=Image$1.STRETCH_UNIFORM,n.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,r.addControl(n),r._image=n,r._textBlock=s,r}static CreateImageOnlyButton(e,t){const i=new this(e),r=new Image$1(e+"_icon",t);return r.stretch=Image$1.STRETCH_FILL,r.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,i.addControl(r),i._image=r,i}static CreateSimpleButton(e,t){const i=new this(e),r=new TextBlock(e+"_button",t);return r.textWrapping=!0,r.textHorizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,i.addControl(r),i._textBlock=r,i}static CreateImageWithCenterTextButton(e,t,i){const r=new this(e),s=new Image$1(e+"_icon",i);s.stretch=Image$1.STRETCH_FILL,r.addControl(s);const n=new TextBlock(e+"_button",t);return n.textWrapping=!0,n.textHorizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,r.addControl(n),r._image=s,r._textBlock=n,r}}RegisterClass("BABYLON.GUI.Button",Button);class Ellipse extends Container{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}constructor(e){super(e),this.name=e,this._thickness=1}_getTypeName(){return"Ellipse"}_localDraw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),Control.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2-this._thickness/2,this._currentMeasure.height/2-this._thickness/2,e),(this._backgroundGradient||this._background)&&(e.fillStyle=this._getBackgroundColor(e),e.fill()),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this._thickness&&(this.color&&(e.strokeStyle=this.color),e.lineWidth=this._thickness,e.stroke()),e.restore()}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.width-=2*this._thickness,this._measureForChildren.height-=2*this._thickness,this._measureForChildren.left+=this._thickness,this._measureForChildren.top+=this._thickness}_clipForChildren(e){Control.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2,this._currentMeasure.height/2,e),e.clip()}_renderHighlightSpecific(e){Control.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2-this._highlightLineWidth/2,this._currentMeasure.height/2-this._highlightLineWidth/2,e),e.stroke()}}__decorate([serialize()],Ellipse.prototype,"thickness",null);RegisterClass("BABYLON.GUI.Ellipse",Ellipse);class Grid extends Container{set clipContent(e){this._clipContent=e;for(const t in this._cells)this._cells[t].clipContent=e}get clipContent(){return this._clipContent}set clipChildren(e){this._clipChildren=e;for(const t in this._cells)this._cells[t].clipChildren=e}get clipChildren(){return this._clipChildren}get columnCount(){return this._columnDefinitions.length}get rowCount(){return this._rowDefinitions.length}get children(){return this._childControls}get cells(){return this._cells}getRowDefinition(e){return e<0||e>=this._rowDefinitions.length?null:this._rowDefinitions[e]}getColumnDefinition(e){return e<0||e>=this._columnDefinitions.length?null:this._columnDefinitions[e]}addRowDefinition(e,t=!1){return this._rowDefinitions.push(new ValueAndUnit(e,t?ValueAndUnit.UNITMODE_PIXEL:ValueAndUnit.UNITMODE_PERCENTAGE)),this._rowDefinitionObservers.push(this._rowDefinitions[this.rowCount-1].onChangedObservable.add(()=>this._markAsDirty())),this._markAsDirty(),this}addColumnDefinition(e,t=!1){return this._columnDefinitions.push(new ValueAndUnit(e,t?ValueAndUnit.UNITMODE_PIXEL:ValueAndUnit.UNITMODE_PERCENTAGE)),this._columnDefinitionObservers.push(this._columnDefinitions[this.columnCount-1].onChangedObservable.add(()=>this._markAsDirty())),this._markAsDirty(),this}setRowDefinition(e,t,i=!1){if(e<0||e>=this._rowDefinitions.length)return this;const r=this._rowDefinitions[e];return r&&r.isPixel===i&&r.value===t?this:(this._rowDefinitions[e].onChangedObservable.remove(this._rowDefinitionObservers[e]),this._rowDefinitions[e]=new ValueAndUnit(t,i?ValueAndUnit.UNITMODE_PIXEL:ValueAndUnit.UNITMODE_PERCENTAGE),this._rowDefinitionObservers[e]=this._rowDefinitions[e].onChangedObservable.add(()=>this._markAsDirty()),this._markAsDirty(),this)}setColumnDefinition(e,t,i=!1){if(e<0||e>=this._columnDefinitions.length)return this;const r=this._columnDefinitions[e];return r&&r.isPixel===i&&r.value===t?this:(this._columnDefinitions[e].onChangedObservable.remove(this._columnDefinitionObservers[e]),this._columnDefinitions[e]=new ValueAndUnit(t,i?ValueAndUnit.UNITMODE_PIXEL:ValueAndUnit.UNITMODE_PERCENTAGE),this._columnDefinitionObservers[e]=this._columnDefinitions[e].onChangedObservable.add(()=>this._markAsDirty()),this._markAsDirty(),this)}getChildrenAt(e,t){const i=this._cells[`${e}:${t}`];return i?i.children:null}getChildCellInfo(e){return e._tag}_removeCell(e,t){if(e){super.removeControl(e);for(const i of e.children){const r=this._childControls.indexOf(i);r!==-1&&this._childControls.splice(r,1)}delete this._cells[t]}}_offsetCell(e,t){if(this._cells[t]){this._cells[e]=this._cells[t];for(const i of this._cells[e].children)i._tag=e;delete this._cells[t]}}removeColumnDefinition(e){if(e<0||e>=this._columnDefinitions.length)return this;for(let t=0;t<this._rowDefinitions.length;t++){const i=`${t}:${e}`,r=this._cells[i];this._removeCell(r,i)}for(let t=0;t<this._rowDefinitions.length;t++)for(let i=e+1;i<this._columnDefinitions.length;i++){const r=`${t}:${i-1}`,s=`${t}:${i}`;this._offsetCell(r,s)}return this._columnDefinitions[e].onChangedObservable.remove(this._columnDefinitionObservers[e]),this._columnDefinitions.splice(e,1),this._columnDefinitionObservers.splice(e,1),this._markAsDirty(),this}removeRowDefinition(e){if(e<0||e>=this._rowDefinitions.length)return this;for(let t=0;t<this._columnDefinitions.length;t++){const i=`${e}:${t}`,r=this._cells[i];this._removeCell(r,i)}for(let t=0;t<this._columnDefinitions.length;t++)for(let i=e+1;i<this._rowDefinitions.length;i++){const r=`${i-1}:${t}`,s=`${i}:${t}`;this._offsetCell(r,s)}return this._rowDefinitions[e].onChangedObservable.remove(this._rowDefinitionObservers[e]),this._rowDefinitions.splice(e,1),this._rowDefinitionObservers.splice(e,1),this._markAsDirty(),this}addControl(e,t=0,i=0){if(this._rowDefinitions.length===0&&this.addRowDefinition(1,!1),this._columnDefinitions.length===0&&this.addColumnDefinition(1,!1),this._childControls.indexOf(e)!==-1)return Tools.Warn(`Control (Name:${e.name}, UniqueId:${e.uniqueId}) is already associated with this grid. You must remove it before reattaching it`),this;const r=Math.min(t,this._rowDefinitions.length-1),s=Math.min(i,this._columnDefinitions.length-1),n=`${r}:${s}`;let o=this._cells[n];return o||(o=new Container(n),this._cells[n]=o,o.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,o.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP,o.clipContent=this.clipContent,o.clipChildren=this.clipChildren,super.addControl(o)),o.addControl(e),this._childControls.push(e),e._tag=n,e.parent=this,this._markAsDirty(),this}removeControl(e){const t=this._childControls.indexOf(e);t!==-1&&this._childControls.splice(t,1);const i=this._cells[e._tag];return i&&(i.removeControl(e),e._tag=null),this._markAsDirty(),this}constructor(e){super(e),this.name=e,this._rowDefinitions=new Array,this._rowDefinitionObservers=[],this._columnDefinitions=new Array,this._columnDefinitionObservers=[],this._cells={},this._childControls=new Array}_getTypeName(){return"Grid"}_getGridDefinitions(e){const t=[],i=[],r=[],s=[];let n=this._currentMeasure.width,o=0,l=this._currentMeasure.height,h=0,u=0;for(const f of this._rowDefinitions){if(f.isPixel){const _=f.getValue(this._host);l-=_,i[u]=_}else h+=f.value;u++}let c=0;u=0;for(const f of this._rowDefinitions){if(s.push(c),f.isPixel)c+=f.getValue(this._host);else{const _=Math.round(f.value/h*l);c+=_,i[u]=_}u++}u=0;for(const f of this._columnDefinitions){if(f.isPixel){const _=f.getValue(this._host);n-=_,t[u]=_}else o+=f.value;u++}let d=0;u=0;for(const f of this._columnDefinitions){if(r.push(d),f.isPixel)d+=f.getValue(this._host);else{const _=Math.round(f.value/o*n);d+=_,t[u]=_}u++}e(r,s,t,i)}_additionalProcessing(e,t){this._getGridDefinitions((i,r,s,n)=>{for(const o in this._cells){if(!Object.prototype.hasOwnProperty.call(this._cells,o))continue;const l=o.split(":"),h=parseInt(l[0]),u=parseInt(l[1]),c=this._cells[o];c.leftInPixels=i[u],c.topInPixels=r[h],c.widthInPixels=s[u],c.heightInPixels=n[h],c._left.ignoreAdaptiveScaling=!0,c._top.ignoreAdaptiveScaling=!0,c._width.ignoreAdaptiveScaling=!0,c._height.ignoreAdaptiveScaling=!0}}),super._additionalProcessing(e,t)}_flagDescendantsAsMatrixDirty(){for(const e in this._cells){if(!Object.prototype.hasOwnProperty.call(this._cells,e))continue;this._cells[e]._markMatrixAsDirty()}}_renderHighlightSpecific(e){super._renderHighlightSpecific(e),this._getGridDefinitions((t,i,r,s)=>{for(let n=0;n<t.length;n++){const o=this._currentMeasure.left+t[n]+r[n];e.beginPath(),e.moveTo(o,this._currentMeasure.top),e.lineTo(o,this._currentMeasure.top+this._currentMeasure.height),e.stroke()}for(let n=0;n<i.length;n++){const o=this._currentMeasure.top+i[n]+s[n];e.beginPath(),e.moveTo(this._currentMeasure.left,o),e.lineTo(this._currentMeasure.left+this._currentMeasure.width,o),e.stroke()}}),e.restore()}dispose(){super.dispose();for(const e of this._childControls)e.dispose();for(let e=0;e<this._rowDefinitions.length;e++)this._rowDefinitions[e].onChangedObservable.remove(this._rowDefinitionObservers[e]);for(let e=0;e<this._columnDefinitions.length;e++)this._columnDefinitions[e].onChangedObservable.remove(this._columnDefinitionObservers[e]);this._rowDefinitionObservers.length=0,this._rowDefinitions.length=0,this._columnDefinitionObservers.length=0,this._columnDefinitions.length=0,this._cells={},this._childControls.length=0}serialize(e){super.serialize(e),e.columnCount=this.columnCount,e.rowCount=this.rowCount,e.columns=[],e.rows=[],e.tags=[];for(let t=0;t<this.columnCount;++t){const i=this.getColumnDefinition(t),r={value:i==null?void 0:i.getValue(this.host),unit:i==null?void 0:i.unit};e.columns.push(r)}for(let t=0;t<this.rowCount;++t){const i=this.getRowDefinition(t),r={value:i==null?void 0:i.getValue(this.host),unit:i==null?void 0:i.unit};e.rows.push(r)}this.children.forEach(t=>{e.tags.push(t._tag)})}_parseFromContent(e,t){super._parseFromContent(e,t);const i=[];this.children.forEach(r=>{i.push(r)}),this.removeRowDefinition(0),this.removeColumnDefinition(0);for(let r=0;r<e.columnCount;++r){const s=e.columns[r].value,n=e.columns[r].unit;this.addColumnDefinition(s,n===1)}for(let r=0;r<e.rowCount;++r){const s=e.rows[r].value,n=e.rows[r].unit;this.addRowDefinition(s,n===1)}for(let r=0;r<i.length;++r){const s=e.tags[r];let n=parseInt(s.substring(0,s.search(":")));isNaN(n)&&(n=0);let o=parseInt(s.substring(s.search(":")+1));isNaN(o)&&(o=0),this.addControl(i[r],n,o)}}}__decorate([serialize()],Grid.prototype,"clipContent",null);RegisterClass("BABYLON.GUI.Grid",Grid);class Line extends Control{get dash(){return this._dash}set dash(e){this._dash!==e&&(this._dash=e,this._markAsDirty())}get connectedControl(){return this._connectedControl}set connectedControl(e){this._connectedControl!==e&&(this._connectedControlDirtyObserver&&this._connectedControl&&(this._connectedControl.onDirtyObservable.remove(this._connectedControlDirtyObserver),this._connectedControlDirtyObserver=null),e&&(this._connectedControlDirtyObserver=e.onDirtyObservable.add(()=>this._markAsDirty())),this._connectedControl=e,this._markAsDirty())}get x1(){return this._x1.toString(this._host)}set x1(e){this._x1.toString(this._host)!==e&&this._x1.fromString(e)&&this._markAsDirty()}get y1(){return this._y1.toString(this._host)}set y1(e){this._y1.toString(this._host)!==e&&this._y1.fromString(e)&&this._markAsDirty()}get x2(){return this._x2.toString(this._host)}set x2(e){this._x2.toString(this._host)!==e&&this._x2.fromString(e)&&this._markAsDirty()}get y2(){return this._y2.toString(this._host)}set y2(e){this._y2.toString(this._host)!==e&&this._y2.fromString(e)&&this._markAsDirty()}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth!==e&&(this._lineWidth=e,this._markAsDirty())}set horizontalAlignment(e){}set verticalAlignment(e){}get _effectiveX2(){return(this._connectedControl?this._connectedControl.centerX:0)+this._x2.getValue(this._host)}get _effectiveY2(){return(this._connectedControl?this._connectedControl.centerY:0)+this._y2.getValue(this._host)}constructor(e){super(e),this.name=e,this._lineWidth=1,this._x1=new ValueAndUnit(0),this._y1=new ValueAndUnit(0),this._x2=new ValueAndUnit(0),this._y2=new ValueAndUnit(0),this._dash=new Array,this._automaticSize=!0,this.isHitTestVisible=!1,this._horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,this._verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP}_getTypeName(){return"Line"}_draw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._applyStates(e),e.strokeStyle=this._getColor(e),e.lineWidth=this._lineWidth,e.setLineDash(this._dash),e.beginPath(),e.moveTo(this._cachedParentMeasure.left+this._x1.getValue(this._host),this._cachedParentMeasure.top+this._y1.getValue(this._host)),e.lineTo(this._cachedParentMeasure.left+this._effectiveX2,this._cachedParentMeasure.top+this._effectiveY2),e.stroke(),e.restore()}_measure(){this._currentMeasure.width=Math.abs(this._x1.getValue(this._host)-this._effectiveX2)+this._lineWidth,this._currentMeasure.height=Math.abs(this._y1.getValue(this._host)-this._effectiveY2)+this._lineWidth}_computeAlignment(e){this._currentMeasure.left=e.left+Math.min(this._x1.getValue(this._host),this._effectiveX2)-this._lineWidth/2,this._currentMeasure.top=e.top+Math.min(this._y1.getValue(this._host),this._effectiveY2)-this._lineWidth/2}moveToVector3(e,t,i=!1){if(!this._host||this.parent!==this._host._rootContainer){Tools.Error("Cannot move a control to a vector3 if the control is not at root level");return}const r=this._host._getGlobalViewport(),s=Vector3.Project(e,Matrix.IdentityReadOnly,t.getTransformMatrix(),r);if(this._moveToProjectedPosition(s,i),s.z<0||s.z>1){this.notRenderable=!0;return}this.notRenderable=!1}_moveToProjectedPosition(e,t=!1){const i=e.x+this._linkOffsetX.getValue(this._host)+"px",r=e.y+this._linkOffsetY.getValue(this._host)+"px";t?(this.x2=i,this.y2=r,this._x2.ignoreAdaptiveScaling=!0,this._y2.ignoreAdaptiveScaling=!0):(this.x1=i,this.y1=r,this._x1.ignoreAdaptiveScaling=!0,this._y1.ignoreAdaptiveScaling=!0)}}__decorate([serialize()],Line.prototype,"dash",null);__decorate([serialize()],Line.prototype,"x1",null);__decorate([serialize()],Line.prototype,"y1",null);__decorate([serialize()],Line.prototype,"x2",null);__decorate([serialize()],Line.prototype,"y2",null);__decorate([serialize()],Line.prototype,"lineWidth",null);RegisterClass("BABYLON.GUI.Line",Line);class StackPanel extends Container{get isVertical(){return this._isVertical}set isVertical(e){this._isVertical!==e&&(this._isVertical=e,this._markAsDirty())}get spacing(){return this._spacing}set spacing(e){this._spacing!==e&&(this._spacing=e,this._markAsDirty())}set width(e){this._doNotTrackManualChanges||(this._manualWidth=!0),this._width.toString(this._host)!==e&&this._width.fromString(e)&&this._markAsDirty()}get width(){return this._width.toString(this._host)}set height(e){this._doNotTrackManualChanges||(this._manualHeight=!0),this._height.toString(this._host)!==e&&this._height.fromString(e)&&this._markAsDirty()}get height(){return this._height.toString(this._host)}constructor(e){super(e),this.name=e,this._isVertical=!0,this._manualWidth=!1,this._manualHeight=!1,this._doNotTrackManualChanges=!1,this._spacing=0,this.ignoreLayoutWarnings=!1}_getTypeName(){return"StackPanel"}_preMeasure(e,t){for(const i of this._children)this._isVertical?i.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP:i.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT;super._preMeasure(e,t)}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.copyFrom(e),this._measureForChildren.left=this._currentMeasure.left,this._measureForChildren.top=this._currentMeasure.top,(!this.isVertical||this._manualWidth)&&(this._measureForChildren.width=this._currentMeasure.width),(this.isVertical||this._manualHeight)&&(this._measureForChildren.height=this._currentMeasure.height)}_postMeasure(){let e=0,t=0;const i=this._children.length;for(let n=0;n<i;n++){const o=this._children[n];!o.isVisible||o.notRenderable||(this._isVertical?(o.top!==t+"px"&&(o.top=t+"px",this._rebuildLayout=!0,o._top.ignoreAdaptiveScaling=!0),o._height.isPercentage&&!o._automaticSize?this.ignoreLayoutWarnings||Tools.Warn(`Control (Name:${o.name}, UniqueId:${o.uniqueId}) is using height in percentage mode inside a vertical StackPanel`):t+=o._currentMeasure.height+o._paddingTopInPixels+o._paddingBottomInPixels+(n<i-1?this._spacing:0)):(o.left!==e+"px"&&(o.left=e+"px",this._rebuildLayout=!0,o._left.ignoreAdaptiveScaling=!0),o._width.isPercentage&&!o._automaticSize&&o.getClassName()==="TextBlock"&&o.textWrapping!==TextWrapping.Clip&&!o.forceResizeWidth?this.ignoreLayoutWarnings||Tools.Warn(`Control (Name:${o.name}, UniqueId:${o.uniqueId}) is using width in percentage mode inside a horizontal StackPanel`):e+=o._currentMeasure.width+o._paddingLeftInPixels+o._paddingRightInPixels+(n<i-1?this._spacing:0)))}e+=this._paddingLeftInPixels+this._paddingRightInPixels,t+=this._paddingTopInPixels+this._paddingBottomInPixels,this._doNotTrackManualChanges=!0;let r=!1,s=!1;if((!this._manualHeight||this.adaptHeightToChildren)&&this._isVertical){const n=this.height;this.height=t+"px",s=n!==this.height||!this._height.ignoreAdaptiveScaling}if((!this._manualWidth||this.adaptWidthToChildren)&&!this._isVertical){const n=this.width;this.width=e+"px",r=n!==this.width||!this._width.ignoreAdaptiveScaling}s&&(this._height.ignoreAdaptiveScaling=!0),r&&(this._width.ignoreAdaptiveScaling=!0),this._doNotTrackManualChanges=!1,(r||s)&&(this._rebuildLayout=!0),super._postMeasure()}serialize(e){super.serialize(e),e.manualWidth=this._manualWidth,e.manualHeight=this._manualHeight}_parseFromContent(e,t){this._manualWidth=e.manualWidth,this._manualHeight=e.manualHeight,super._parseFromContent(e,t)}}__decorate([serialize()],StackPanel.prototype,"ignoreLayoutWarnings",void 0);__decorate([serialize()],StackPanel.prototype,"isVertical",null);__decorate([serialize()],StackPanel.prototype,"spacing",null);__decorate([serialize()],StackPanel.prototype,"width",null);__decorate([serialize()],StackPanel.prototype,"height",null);RegisterClass("BABYLON.GUI.StackPanel",StackPanel);const AnchorDiameter="15px",LineWidth=5,HeaderHeight="40px",MessageBoxWidth="300px",MessageBoxCornerRadius=6,MessageBoxThickness=3,MessageBoxPadding="10px",SeparatorHeight="5px",TextSize=16,TitleWeight="800";var Se,Ie,Re,Ge,We,ot,me;class Description{constructor(e,t){Q(this,Se,void 0);Q(this,Ie,void 0);Q(this,Re,void 0);Q(this,Ge,void 0);Q(this,We,void 0);Q(this,ot,void 0);Q(this,me,void 0);$(this,Se,t);const i=new Container;e.addControl(i);const r=new Ellipse("gui_anchor");r.isVisible=!1,r.width=AnchorDiameter,r.height=AnchorDiameter,r.background="orange",r.thickness=0,e.addControl(r),$(this,Ie,r);const s=new Line("gui_line");s.isVisible=!1,s.lineWidth=LineWidth,s.color="orange",e.addControl(s),$(this,Re,s);const n=new Rectangle("gui_messagebox");n.isVisible=!1,n.isPointerBlocker=!0,n.adaptHeightToChildren=!0,n.width=MessageBoxWidth,n.left=100,n.top=100,n.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,n.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP,n.cornerRadius=MessageBoxCornerRadius,n.thickness=MessageBoxThickness,n.color="orange",n.background="white",e.addControl(n),$(this,Ge,n),s.connectedControl=n;const o=new StackPanel("gui_stack");o.isVertical=!0,o.paddingLeft=MessageBoxPadding,o.paddingRight=MessageBoxPadding,o.paddingBottom=MessageBoxPadding,o.color="black",n.addControl(o);const l=new Grid("gui_header");l.height=HeaderHeight,l.addColumnDefinition(1),l.addColumnDefinition(50,!0),l.addRowDefinition(1),o.addControl(l);const h=new TextBlock("gui_title");h.resizeToFit=!0,h.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,h.fontWeight=TitleWeight,l.addControl(h,0,0),$(this,ot,h);const u=Button.CreateSimpleButton("gui_closeButton","X"),c=this;u.onPointerUpObservable.add(()=>c.clear()),l.addControl(u,0,1);const d=new Rectangle("gui_separator");d.width=1,d.height=SeparatorHeight,d.cornerRadius=5,d.background="orange",o.addControl(d),$(this,We,d);const f=new TextBlock("gui_description");f.resizeToFit=!0,f.paddingTop=MessageBoxPadding,f.fontSize=TextSize,f.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,f.textHorizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,o.addControl(f),$(this,me,f);let _=!1,g=NaN,p=NaN;n.onPointerDownObservable.add(m=>{g=parseFloat(n.left)-m.x,p=parseFloat(n.top)-m.y,_=!0,i.zIndex=9e3}),n.onPointerUpObservable.add(()=>{_=!1,i.zIndex=-1}),i.onPointerMoveObservable.add(m=>{if(!_)return!1;n.left=g+m.x,n.top=p+m.y})}showDescription(e,t,i){I(this,Se).removeText(I(this,me)),I(this,ot).text=t,I(this,Se).addText(I(this,me),i),i.length==0?(I(this,me).isVisible=!1,I(this,We).isVisible=!1):(I(this,me).isVisible=!0,I(this,We).isVisible=!0),I(this,Ie).linkWithMesh(e),I(this,Re).linkWithMesh(e),I(this,Ie).isVisible=!0,I(this,Re).isVisible=!0,I(this,Ge).isVisible=!0}clear(){I(this,Ie).isVisible=!1,I(this,Re).isVisible=!1,I(this,Ge).isVisible=!1,I(this,Se).removeText(I(this,me))}}Se=new WeakMap,Ie=new WeakMap,Re=new WeakMap,Ge=new WeakMap,We=new WeakMap,ot=new WeakMap,me=new WeakMap;function inlineScheduler(a,e,t){try{const i=a.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function createYieldingScheduler(a=25){let e;return(t,i,r)=>{const s=performance.now();e===void 0||s-e>a?(e=s,setTimeout(()=>{inlineScheduler(t,i,r)},0)):inlineScheduler(t,i,r)}}function runCoroutine(a,e,t,i,r){const s=()=>{let n;const o=l=>{l.done?t(l.value):n===void 0?n=!0:s()};do n=void 0,!r||!r.aborted?e(a,o,i):i(new Error("Aborted")),n===void 0&&(n=!1);while(n)};s()}function runCoroutineSync(a,e){let t;return runCoroutine(a,inlineScheduler,i=>t=i,i=>{throw i},e),t}function runCoroutineAsync(a,e,t){return new Promise((i,r)=>{runCoroutine(a,e,i,r,t)})}function makeSyncFunction(a,e){return(...t)=>runCoroutineSync(a(...t),e)}class VertexData{constructor(){this._applyTo=makeSyncFunction(this._applyToCoroutine.bind(this))}set(e,t){switch(e.length||Logger.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case VertexBuffer.PositionKind:this.positions=e;break;case VertexBuffer.NormalKind:this.normals=e;break;case VertexBuffer.TangentKind:this.tangents=e;break;case VertexBuffer.UVKind:this.uvs=e;break;case VertexBuffer.UV2Kind:this.uvs2=e;break;case VertexBuffer.UV3Kind:this.uvs3=e;break;case VertexBuffer.UV4Kind:this.uvs4=e;break;case VertexBuffer.UV5Kind:this.uvs5=e;break;case VertexBuffer.UV6Kind:this.uvs6=e;break;case VertexBuffer.ColorKind:this.colors=e;break;case VertexBuffer.MatricesIndicesKind:this.matricesIndices=e;break;case VertexBuffer.MatricesWeightsKind:this.matricesWeights=e;break;case VertexBuffer.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case VertexBuffer.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){return this.positions&&(e.setVerticesData(VertexBuffer.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(VertexBuffer.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(VertexBuffer.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(VertexBuffer.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(VertexBuffer.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(VertexBuffer.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(VertexBuffer.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(VertexBuffer.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(VertexBuffer.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(VertexBuffer.ColorKind,this.colors,t),i&&(yield)),this.matricesIndices&&(e.setVerticesData(VertexBuffer.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(VertexBuffer.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),this}_update(e,t,i){return this.positions&&e.updateVerticesData(VertexBuffer.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(VertexBuffer.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(VertexBuffer.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(VertexBuffer.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(VertexBuffer.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(VertexBuffer.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(VertexBuffer.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(VertexBuffer.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(VertexBuffer.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(VertexBuffer.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(VertexBuffer.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(VertexBuffer.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,r=e.length){const s=TmpVectors.Vector3[0],n=TmpVectors.Vector3[1];for(let o=i;o<i+r;o+=3)Vector3.FromArrayToRef(e,o,s),Vector3.TransformCoordinatesToRef(s,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z}static _TransformVector3Normals(e,t,i=0,r=e.length){const s=TmpVectors.Vector3[0],n=TmpVectors.Vector3[1];for(let o=i;o<i+r;o+=3)Vector3.FromArrayToRef(e,o,s),Vector3.TransformNormalToRef(s,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z}static _TransformVector4Normals(e,t,i=0,r=e.length){const s=TmpVectors.Vector4[0],n=TmpVectors.Vector4[1];for(let o=i;o<i+r;o+=4)Vector4.FromArrayToRef(e,o,s),Vector4.TransformNormalToRef(s,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z,e[o+3]=n.w}static _FlipFaces(e,t=0,i=e.length){for(let r=t;r<t+i;r+=3){const s=e[r+1];e[r+1]=e[r+2],e[r+2]=s}}transform(e){const t=e.determinant()<0;return this.positions&&VertexData._TransformVector3Coordinates(this.positions,e),this.normals&&VertexData._TransformVector3Normals(this.normals,e),this.tangents&&VertexData._TransformVector4Normals(this.tangents,e),t&&this.indices&&VertexData._FlipFaces(this.indices),this}merge(e,t=!1,i=!1){const r=Array.isArray(e)?e.map(s=>({vertexData:s})):[{vertexData:e}];return runCoroutineSync(this._mergeCoroutine(void 0,r,t,!1,i))}*_mergeCoroutine(e,t,i=!1,r,s){var n,o,l,h;this._validate();const u=t.map(_=>_.vertexData);for(const _ of u)if(_._validate(),!this.normals!=!_.normals||!this.tangents!=!_.tangents||!this.uvs!=!_.uvs||!this.uvs2!=!_.uvs2||!this.uvs3!=!_.uvs3||!this.uvs4!=!_.uvs4||!this.uvs5!=!_.uvs5||!this.uvs6!=!_.uvs6||!this.colors!=!_.colors||!this.matricesIndices!=!_.matricesIndices||!this.matricesWeights!=!_.matricesWeights||!this.matricesIndicesExtra!=!_.matricesIndicesExtra||!this.matricesWeightsExtra!=!_.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");const c=u.reduce((_,g)=>{var p,m;return _+((m=(p=g.indices)===null||p===void 0?void 0:p.length)!==null&&m!==void 0?m:0)},(o=(n=this.indices)===null||n===void 0?void 0:n.length)!==null&&o!==void 0?o:0);let f=s||u.some(_=>_.indices===this.indices)?(l=this.indices)===null||l===void 0?void 0:l.slice():this.indices;if(c>0){let _=(h=f==null?void 0:f.length)!==null&&h!==void 0?h:0;if(f||(f=new Array(c)),f.length!==c){if(Array.isArray(f))f.length=c;else{const p=i||f instanceof Uint32Array?new Uint32Array(c):new Uint16Array(c);p.set(f),f=p}e&&e.determinant()<0&&VertexData._FlipFaces(f,0,_)}let g=this.positions?this.positions.length/3:0;for(const{vertexData:p,transform:m}of t)if(p.indices){for(let E=0;E<p.indices.length;E++)f[_+E]=p.indices[E]+g;m&&m.determinant()<0&&VertexData._FlipFaces(f,_,p.indices.length),g+=p.positions.length/3,_+=p.indices.length,r&&(yield)}}return this.indices=f,this.positions=VertexData._MergeElement(VertexBuffer.PositionKind,this.positions,e,t.map(_=>[_.vertexData.positions,_.transform])),r&&(yield),this.normals=VertexData._MergeElement(VertexBuffer.NormalKind,this.normals,e,t.map(_=>[_.vertexData.normals,_.transform])),r&&(yield),this.tangents=VertexData._MergeElement(VertexBuffer.TangentKind,this.tangents,e,t.map(_=>[_.vertexData.tangents,_.transform])),r&&(yield),this.uvs=VertexData._MergeElement(VertexBuffer.UVKind,this.uvs,e,t.map(_=>[_.vertexData.uvs,_.transform])),r&&(yield),this.uvs2=VertexData._MergeElement(VertexBuffer.UV2Kind,this.uvs2,e,t.map(_=>[_.vertexData.uvs2,_.transform])),r&&(yield),this.uvs3=VertexData._MergeElement(VertexBuffer.UV3Kind,this.uvs3,e,t.map(_=>[_.vertexData.uvs3,_.transform])),r&&(yield),this.uvs4=VertexData._MergeElement(VertexBuffer.UV4Kind,this.uvs4,e,t.map(_=>[_.vertexData.uvs4,_.transform])),r&&(yield),this.uvs5=VertexData._MergeElement(VertexBuffer.UV5Kind,this.uvs5,e,t.map(_=>[_.vertexData.uvs5,_.transform])),r&&(yield),this.uvs6=VertexData._MergeElement(VertexBuffer.UV6Kind,this.uvs6,e,t.map(_=>[_.vertexData.uvs6,_.transform])),r&&(yield),this.colors=VertexData._MergeElement(VertexBuffer.ColorKind,this.colors,e,t.map(_=>[_.vertexData.colors,_.transform])),r&&(yield),this.matricesIndices=VertexData._MergeElement(VertexBuffer.MatricesIndicesKind,this.matricesIndices,e,t.map(_=>[_.vertexData.matricesIndices,_.transform])),r&&(yield),this.matricesWeights=VertexData._MergeElement(VertexBuffer.MatricesWeightsKind,this.matricesWeights,e,t.map(_=>[_.vertexData.matricesWeights,_.transform])),r&&(yield),this.matricesIndicesExtra=VertexData._MergeElement(VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,t.map(_=>[_.vertexData.matricesIndicesExtra,_.transform])),r&&(yield),this.matricesWeightsExtra=VertexData._MergeElement(VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,t.map(_=>[_.vertexData.matricesWeightsExtra,_.transform])),this}static _MergeElement(e,t,i,r){const s=r.filter(l=>l[0]!==null&&l[0]!==void 0);if(!t&&s.length==0)return t;if(!t)return this._MergeElement(e,s[0][0],s[0][1],s.slice(1));const n=s.reduce((l,h)=>l+h[0].length,t.length),o=e===VertexBuffer.PositionKind?VertexData._TransformVector3Coordinates:e===VertexBuffer.NormalKind?VertexData._TransformVector3Normals:e===VertexBuffer.TangentKind?VertexData._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const l=new Float32Array(n);l.set(t),i&&o(l,i,0,t.length);let h=t.length;for(const[u,c]of s)l.set(u,h),c&&o(l,c,h,u.length),h+=u.length;return l}else{const l=new Array(n);for(let u=0;u<t.length;u++)l[u]=t[u];i&&o(l,i,0,t.length);let h=t.length;for(const[u,c]of s){for(let d=0;d<u.length;d++)l[h+d]=u[d];c&&o(l,c,h,u.length),h+=u.length}return l}}_validate(){if(!this.positions)throw new RuntimeError("Positions are required",ErrorCodes.MeshInvalidPositionsError);const e=(r,s)=>{const n=VertexBuffer.DeduceStride(r);if(s.length%n!==0)throw new Error("The "+r+"s array count must be a multiple of "+n);return s.length/n},t=e(VertexBuffer.PositionKind,this.positions),i=(r,s)=>{const n=e(r,s);if(n!==t)throw new Error("The "+r+"s element count ("+n+") does not match the positions count ("+t+")")};this.normals&&i(VertexBuffer.NormalKind,this.normals),this.tangents&&i(VertexBuffer.TangentKind,this.tangents),this.uvs&&i(VertexBuffer.UVKind,this.uvs),this.uvs2&&i(VertexBuffer.UV2Kind,this.uvs2),this.uvs3&&i(VertexBuffer.UV3Kind,this.uvs3),this.uvs4&&i(VertexBuffer.UV4Kind,this.uvs4),this.uvs5&&i(VertexBuffer.UV5Kind,this.uvs5),this.uvs6&&i(VertexBuffer.UV6Kind,this.uvs6),this.colors&&i(VertexBuffer.ColorKind,this.colors),this.matricesIndices&&i(VertexBuffer.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(VertexBuffer.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra)}serialize(){const e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e}static ExtractFromMesh(e,t,i){return VertexData._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return VertexData._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const r=new VertexData;return e.isVerticesDataPresent(VertexBuffer.PositionKind)&&(r.positions=e.getVerticesData(VertexBuffer.PositionKind,t,i)),e.isVerticesDataPresent(VertexBuffer.NormalKind)&&(r.normals=e.getVerticesData(VertexBuffer.NormalKind,t,i)),e.isVerticesDataPresent(VertexBuffer.TangentKind)&&(r.tangents=e.getVerticesData(VertexBuffer.TangentKind,t,i)),e.isVerticesDataPresent(VertexBuffer.UVKind)&&(r.uvs=e.getVerticesData(VertexBuffer.UVKind,t,i)),e.isVerticesDataPresent(VertexBuffer.UV2Kind)&&(r.uvs2=e.getVerticesData(VertexBuffer.UV2Kind,t,i)),e.isVerticesDataPresent(VertexBuffer.UV3Kind)&&(r.uvs3=e.getVerticesData(VertexBuffer.UV3Kind,t,i)),e.isVerticesDataPresent(VertexBuffer.UV4Kind)&&(r.uvs4=e.getVerticesData(VertexBuffer.UV4Kind,t,i)),e.isVerticesDataPresent(VertexBuffer.UV5Kind)&&(r.uvs5=e.getVerticesData(VertexBuffer.UV5Kind,t,i)),e.isVerticesDataPresent(VertexBuffer.UV6Kind)&&(r.uvs6=e.getVerticesData(VertexBuffer.UV6Kind,t,i)),e.isVerticesDataPresent(VertexBuffer.ColorKind)&&(r.colors=e.getVerticesData(VertexBuffer.ColorKind,t,i)),e.isVerticesDataPresent(VertexBuffer.MatricesIndicesKind)&&(r.matricesIndices=e.getVerticesData(VertexBuffer.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(VertexBuffer.MatricesWeightsKind)&&(r.matricesWeights=e.getVerticesData(VertexBuffer.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(VertexBuffer.MatricesIndicesExtraKind)&&(r.matricesIndicesExtra=e.getVerticesData(VertexBuffer.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(VertexBuffer.MatricesWeightsExtraKind)&&(r.matricesWeightsExtra=e.getVerticesData(VertexBuffer.MatricesWeightsExtraKind,t,i)),r.indices=e.getIndices(t,i),r}static CreateRibbon(e){throw _WarnImport("ribbonBuilder")}static CreateBox(e){throw _WarnImport("boxBuilder")}static CreateTiledBox(e){throw _WarnImport("tiledBoxBuilder")}static CreateTiledPlane(e){throw _WarnImport("tiledPlaneBuilder")}static CreateSphere(e){throw _WarnImport("sphereBuilder")}static CreateCylinder(e){throw _WarnImport("cylinderBuilder")}static CreateTorus(e){throw _WarnImport("torusBuilder")}static CreateLineSystem(e){throw _WarnImport("linesBuilder")}static CreateDashedLines(e){throw _WarnImport("linesBuilder")}static CreateGround(e){throw _WarnImport("groundBuilder")}static CreateTiledGround(e){throw _WarnImport("groundBuilder")}static CreateGroundFromHeightMap(e){throw _WarnImport("groundBuilder")}static CreatePlane(e){throw _WarnImport("planeBuilder")}static CreateDisc(e){throw _WarnImport("discBuilder")}static CreatePolygon(e,t,i,r,s,n,o){throw _WarnImport("polygonBuilder")}static CreateIcoSphere(e){throw _WarnImport("icoSphereBuilder")}static CreatePolyhedron(e){throw _WarnImport("polyhedronBuilder")}static CreateCapsule(e={orientation:Vector3.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw _WarnImport("capsuleBuilder")}static CreateTorusKnot(e){throw _WarnImport("torusKnotBuilder")}static ComputeNormals(e,t,i,r){let s=0,n=0,o=0,l=0,h=0,u=0,c=0,d=0,f=0,_=0,g=0,p=0,m=0,E=0,M=0,x=0,A=0,T=0,C=0,b=0,y=!1,S=!1,R=!1,P=!1,N=1,V=0,F=null;r&&(y=!!r.facetNormals,S=!!r.facetPositions,R=!!r.facetPartitioning,N=r.useRightHandedSystem===!0?-1:1,V=r.ratio||0,P=!!r.depthSort,F=r.distanceTo,P&&F===void 0&&(F=Vector3.Zero()));let U=0,H=0,X=0,w=0;for(R&&r&&r.bbSize&&(U=r.subDiv.X*V/r.bbSize.x,H=r.subDiv.Y*V/r.bbSize.y,X=r.subDiv.Z*V/r.bbSize.z,w=r.subDiv.max*r.subDiv.max,r.facetPartitioning.length=0),s=0;s<e.length;s++)i[s]=0;const O=t.length/3|0;for(s=0;s<O;s++){if(p=t[s*3]*3,m=p+1,E=p+2,M=t[s*3+1]*3,x=M+1,A=M+2,T=t[s*3+2]*3,C=T+1,b=T+2,n=e[p]-e[M],o=e[m]-e[x],l=e[E]-e[A],h=e[T]-e[M],u=e[C]-e[x],c=e[b]-e[A],d=N*(o*c-l*u),f=N*(l*h-n*c),_=N*(n*u-o*h),g=Math.sqrt(d*d+f*f+_*_),g=g===0?1:g,d/=g,f/=g,_/=g,y&&r&&(r.facetNormals[s].x=d,r.facetNormals[s].y=f,r.facetNormals[s].z=_),S&&r&&(r.facetPositions[s].x=(e[p]+e[M]+e[T])/3,r.facetPositions[s].y=(e[m]+e[x]+e[C])/3,r.facetPositions[s].z=(e[E]+e[A]+e[b])/3),R&&r){const v=Math.floor((r.facetPositions[s].x-r.bInfo.minimum.x*V)*U),D=Math.floor((r.facetPositions[s].y-r.bInfo.minimum.y*V)*H),B=Math.floor((r.facetPositions[s].z-r.bInfo.minimum.z*V)*X),k=Math.floor((e[p]-r.bInfo.minimum.x*V)*U),j=Math.floor((e[m]-r.bInfo.minimum.y*V)*H),K=Math.floor((e[E]-r.bInfo.minimum.z*V)*X),L=Math.floor((e[M]-r.bInfo.minimum.x*V)*U),G=Math.floor((e[x]-r.bInfo.minimum.y*V)*H),Z=Math.floor((e[A]-r.bInfo.minimum.z*V)*X),z=Math.floor((e[T]-r.bInfo.minimum.x*V)*U),Y=Math.floor((e[C]-r.bInfo.minimum.y*V)*H),W=Math.floor((e[b]-r.bInfo.minimum.z*V)*X),J=k+r.subDiv.max*j+w*K,ee=L+r.subDiv.max*G+w*Z,te=z+r.subDiv.max*Y+w*W,ie=v+r.subDiv.max*D+w*B;r.facetPartitioning[ie]=r.facetPartitioning[ie]?r.facetPartitioning[ie]:new Array,r.facetPartitioning[J]=r.facetPartitioning[J]?r.facetPartitioning[J]:new Array,r.facetPartitioning[ee]=r.facetPartitioning[ee]?r.facetPartitioning[ee]:new Array,r.facetPartitioning[te]=r.facetPartitioning[te]?r.facetPartitioning[te]:new Array,r.facetPartitioning[J].push(s),ee!=J&&r.facetPartitioning[ee].push(s),te==ee||te==J||r.facetPartitioning[te].push(s),ie==J||ie==ee||ie==te||r.facetPartitioning[ie].push(s)}if(P&&r&&r.facetPositions){const v=r.depthSortedFacets[s];v.ind=s*3,v.sqDistance=Vector3.DistanceSquared(r.facetPositions[s],F)}i[p]+=d,i[m]+=f,i[E]+=_,i[M]+=d,i[x]+=f,i[A]+=_,i[T]+=d,i[C]+=f,i[b]+=_}for(s=0;s<i.length/3;s++)d=i[s*3],f=i[s*3+1],_=i[s*3+2],g=Math.sqrt(d*d+f*f+_*_),g=g===0?1:g,d/=g,f/=g,_/=g,i[s*3]=d,i[s*3+1]=f,i[s*3+2]=_}static _ComputeSides(e,t,i,r,s,n,o){const l=i.length,h=r.length;let u,c;switch(e=e||VertexData.DEFAULTSIDE,e){case VertexData.FRONTSIDE:break;case VertexData.BACKSIDE:for(u=0;u<l;u+=3){const d=i[u];i[u]=i[u+2],i[u+2]=d}for(c=0;c<h;c++)r[c]=-r[c];break;case VertexData.DOUBLESIDE:{const d=t.length,f=d/3;for(let p=0;p<d;p++)t[d+p]=t[p];for(u=0;u<l;u+=3)i[u+l]=i[u+2]+f,i[u+1+l]=i[u+1]+f,i[u+2+l]=i[u]+f;for(c=0;c<h;c++)r[h+c]=-r[c];const _=s.length;let g=0;for(g=0;g<_;g++)s[g+_]=s[g];for(n=n||new Vector4(0,0,1,1),o=o||new Vector4(0,0,1,1),g=0,u=0;u<_/2;u++)s[g]=n.x+(n.z-n.x)*s[g],s[g+1]=n.y+(n.w-n.y)*s[g+1],s[g+_]=o.x+(o.z-o.x)*s[g+_],s[g+_+1]=o.y+(o.w-o.y)*s[g+_+1],g+=2;break}}}static ImportVertexData(e,t){const i=new VertexData,r=e.positions;r&&i.set(r,VertexBuffer.PositionKind);const s=e.normals;s&&i.set(s,VertexBuffer.NormalKind);const n=e.tangents;n&&i.set(n,VertexBuffer.TangentKind);const o=e.uvs;o&&i.set(o,VertexBuffer.UVKind);const l=e.uv2s;l&&i.set(l,VertexBuffer.UV2Kind);const h=e.uv3s;h&&i.set(h,VertexBuffer.UV3Kind);const u=e.uv4s;u&&i.set(u,VertexBuffer.UV4Kind);const c=e.uv5s;c&&i.set(c,VertexBuffer.UV5Kind);const d=e.uv6s;d&&i.set(d,VertexBuffer.UV6Kind);const f=e.colors;f&&i.set(Color4.CheckColors4(f,r.length/3),VertexBuffer.ColorKind);const _=e.matricesIndices;_&&i.set(_,VertexBuffer.MatricesIndicesKind);const g=e.matricesWeights;g&&i.set(g,VertexBuffer.MatricesWeightsKind);const p=e.indices;p&&(i.indices=p),t.setAllVerticesData(i,e.updatable)}}VertexData.FRONTSIDE=0;VertexData.BACKSIDE=1;VertexData.DOUBLESIDE=2;VertexData.DEFAULTSIDE=0;__decorate([nativeOverride.filter((...[a])=>!Array.isArray(a))],VertexData,"_TransformVector3Coordinates",null);__decorate([nativeOverride.filter((...[a])=>!Array.isArray(a))],VertexData,"_TransformVector3Normals",null);__decorate([nativeOverride.filter((...[a])=>!Array.isArray(a))],VertexData,"_TransformVector4Normals",null);__decorate([nativeOverride.filter((...[a])=>!Array.isArray(a))],VertexData,"_FlipFaces",null);class BoundingBox{constructor(e,t,i){this.vectors=ArrayTools.BuildArray(8,Vector3.Zero),this.center=Vector3.Zero(),this.centerWorld=Vector3.Zero(),this.extendSize=Vector3.Zero(),this.extendSizeWorld=Vector3.Zero(),this.directions=ArrayTools.BuildArray(3,Vector3.Zero),this.vectorsWorld=ArrayTools.BuildArray(8,Vector3.Zero),this.minimumWorld=Vector3.Zero(),this.maximumWorld=Vector3.Zero(),this.minimum=Vector3.Zero(),this.maximum=Vector3.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const r=e.x,s=e.y,n=e.z,o=t.x,l=t.y,h=t.z,u=this.vectors;this.minimum.copyFromFloats(r,s,n),this.maximum.copyFromFloats(o,l,h),u[0].copyFromFloats(r,s,n),u[1].copyFromFloats(o,l,h),u[2].copyFromFloats(o,s,n),u[3].copyFromFloats(r,l,n),u[4].copyFromFloats(r,s,h),u[5].copyFromFloats(o,l,n),u[6].copyFromFloats(r,l,h),u[7].copyFromFloats(o,s,h),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||Matrix.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=BoundingBox._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),r=i.length();i.normalizeFromLength(r);const s=r*e,n=i.scaleInPlace(s*.5),o=this.center.subtractToRef(n,t[1]),l=this.center.addToRef(n,t[2]);return this.reConstruct(o,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,r=this.directions,s=this.vectorsWorld,n=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let o=0;o<8;++o)s[o].copyFrom(n[o]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let o=0;o<8;++o){const l=s[o];Vector3.TransformCoordinatesToRef(n[o],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}Vector3.FromArrayToRef(e.m,0,r[0]),Vector3.FromArrayToRef(e.m,4,r[1]),Vector3.FromArrayToRef(e.m,8,r[2]),this._worldMatrix=e}isInFrustum(e){return BoundingBox.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return BoundingBox.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,r=t.x,s=t.y,n=t.z,o=i.x,l=i.y,h=i.z,u=e.x,c=e.y,d=e.z,f=-Epsilon;return!(o-u<f||f>u-r||l-c<f||f>c-s||h-d<f||f>d-n)}intersectsSphere(e){return BoundingBox.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,r=this.maximumWorld,s=i.x,n=i.y,o=i.z,l=r.x,h=r.y,u=r.z,c=e.x,d=e.y,f=e.z,_=t.x,g=t.y,p=t.z;return!(l<c||s>_||h<d||n>g||u<f||o>p)}dispose(){var e,t;(e=this._drawWrapperFront)===null||e===void 0||e.dispose(),(t=this._drawWrapperBack)===null||t===void 0||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,r){const s=BoundingBox._TmpVector3[0];return Vector3.ClampToRef(i,e,t,s),Vector3.DistanceSquared(i,s)<=r*r}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const r=t[i];for(let s=0;s<8;++s)if(r.dotCoordinate(e[s])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let r=!0;const s=t[i];for(let n=0;n<8;++n)if(s.dotCoordinate(e[n])>=0){r=!1;break}if(r)return!1}return!0}}BoundingBox._TmpVector3=ArrayTools.BuildArray(3,Vector3.Zero);class BoundingSphere{constructor(e,t,i){this.center=Vector3.Zero(),this.centerWorld=Vector3.Zero(),this.minimum=Vector3.Zero(),this.maximum=Vector3.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const r=Vector3.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=r*.5,this._update(i||Matrix.IdentityReadOnly)}scale(e){const t=this.radius*e,i=BoundingSphere._TmpVector3,r=i[0].setAll(t),s=this.center.subtractToRef(r,i[1]),n=this.center.addToRef(r,i[2]);return this.reConstruct(s,n,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{Vector3.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=BoundingSphere._TmpVector3[0];Vector3.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let r=0;r<6;r++)if(e[r].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=Vector3.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=Vector3.DistanceSquared(e.centerWorld,t.centerWorld),r=e.radiusWorld+t.radiusWorld;return!(r*r<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const r=new BoundingSphere(this._TmpVector3[0],this._TmpVector3[2]);return i?r._worldMatrix=i:r._worldMatrix=Matrix.Identity(),r}}BoundingSphere._TmpVector3=ArrayTools.BuildArray(3,Vector3.Zero);const _result0={min:0,max:0},_result1={min:0,max:0},computeBoxExtents=(a,e,t)=>{const i=Vector3.Dot(e.centerWorld,a),r=Math.abs(Vector3.Dot(e.directions[0],a))*e.extendSize.x,s=Math.abs(Vector3.Dot(e.directions[1],a))*e.extendSize.y,n=Math.abs(Vector3.Dot(e.directions[2],a))*e.extendSize.z,o=r+s+n;t.min=i-o,t.max=i+o},axisOverlap=(a,e,t)=>(computeBoxExtents(a,e,_result0),computeBoxExtents(a,t,_result1),!(_result0.min>_result1.max||_result1.min>_result0.max));class BoundingInfo{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new BoundingBox(e,t,i),this.boundingSphere=new BoundingSphere(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=BoundingInfo._TmpVector3[0].copyFrom(e).subtractInPlace(t),r=BoundingInfo._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=Vector3.Minimize(this.minimum,e),i=Vector3.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=TmpVectors.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const i=TmpVectors.Vector3[0];return Vector3.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),Vector3.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,BoundingInfo._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!BoundingSphere.Intersects(this.boundingSphere,e.boundingSphere)||!BoundingBox.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,r=e.boundingBox;return!(!axisOverlap(i.directions[0],i,r)||!axisOverlap(i.directions[1],i,r)||!axisOverlap(i.directions[2],i,r)||!axisOverlap(r.directions[0],i,r)||!axisOverlap(r.directions[1],i,r)||!axisOverlap(r.directions[2],i,r)||!axisOverlap(Vector3.Cross(i.directions[0],r.directions[0]),i,r)||!axisOverlap(Vector3.Cross(i.directions[0],r.directions[1]),i,r)||!axisOverlap(Vector3.Cross(i.directions[0],r.directions[2]),i,r)||!axisOverlap(Vector3.Cross(i.directions[1],r.directions[0]),i,r)||!axisOverlap(Vector3.Cross(i.directions[1],r.directions[1]),i,r)||!axisOverlap(Vector3.Cross(i.directions[1],r.directions[2]),i,r)||!axisOverlap(Vector3.Cross(i.directions[2],r.directions[0]),i,r)||!axisOverlap(Vector3.Cross(i.directions[2],r.directions[1]),i,r)||!axisOverlap(Vector3.Cross(i.directions[2],r.directions[2]),i,r))}}BoundingInfo._TmpVector3=ArrayTools.BuildArray(2,Vector3.Zero);class MathHelpers{static extractMinAndMaxIndexed(e,t,i,r,s,n){for(let o=i;o<i+r;o++){const l=t[o]*3,h=e[l],u=e[l+1],c=e[l+2];s.minimizeInPlaceFromFloats(h,u,c),n.maximizeInPlaceFromFloats(h,u,c)}}static extractMinAndMax(e,t,i,r,s,n){for(let o=t,l=t*r;o<t+i;o++,l+=r){const h=e[l],u=e[l+1],c=e[l+2];s.minimizeInPlaceFromFloats(h,u,c),n.maximizeInPlaceFromFloats(h,u,c)}}}__decorate([nativeOverride.filter((...[a,e])=>!Array.isArray(a)&&!Array.isArray(e))],MathHelpers,"extractMinAndMaxIndexed",null);__decorate([nativeOverride.filter((...[a])=>!Array.isArray(a))],MathHelpers,"extractMinAndMax",null);function extractMinAndMaxIndexed(a,e,t,i,r=null){const s=new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return MathHelpers.extractMinAndMaxIndexed(a,e,t,i,s,n),r&&(s.x-=s.x*r.x+r.y,s.y-=s.y*r.x+r.y,s.z-=s.z*r.x+r.y,n.x+=n.x*r.x+r.y,n.y+=n.y*r.x+r.y,n.z+=n.z*r.x+r.y),{minimum:s,maximum:n}}function extractMinAndMax(a,e,t,i=null,r){const s=new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return r||(r=3),MathHelpers.extractMinAndMax(a,e,t,r,s,n),i&&(s.x-=s.x*i.x+i.y,s.y-=s.y*i.x+i.y,s.z-=s.z*i.x+i.y,n.x+=n.x*i.x+i.y,n.y+=n.y*i.x+i.y,n.z+=n.z*i.x+i.y),{minimum:s,maximum:n}}class SubMesh{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(e=this._getDrawWrapper())===null||e===void 0?void 0:e.defines}set materialDefines(e){var t;const i=(t=this._mainDrawWrapperOverride)!==null&&t!==void 0?t:this._getDrawWrapper(void 0,!0);i.defines=e}_getDrawWrapper(e,t=!1){e=e??this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new DrawWrapper(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){var i;t&&((i=this._drawWrappers[e])===null||i===void 0||i.dispose()),this._drawWrappers[e]=void 0}get effect(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:(t=(e=this._getDrawWrapper())===null||e===void 0?void 0:e.effect)!==null&&t!==void 0?t:null}get _drawWrapper(){var e;return(e=this._mainDrawWrapperOverride)!==null&&e!==void 0?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,r=!0){const s=this._drawWrapper;s.setEffect(e,t,r),i!==void 0&&(s.materialContext=i),e||(s.defines=null,s.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(const t of this._drawWrappers)t==null||t.dispose();this._drawWrappers=[]}static AddToMesh(e,t,i,r,s,n,o,l=!0){return new SubMesh(e,t,i,r,s,n,o,l)}constructor(e,t,i,r,s,n,o,l=!0,h=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=r,this.indexCount=s,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=n,this._renderingMesh=o||n,h&&n.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=n.subMeshes.length-1,l&&(this.refreshBoundingInfo(),n.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){const e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){var t;const i=(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))!==null&&t!==void 0?t:this._renderingMesh.material;if(i){if(this._isMultiMaterial(i)){const r=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==r&&(this._currentMaterial=r,this.resetDrawCache()),r}}else return e?this._mesh.getScene().defaultMaterial:null;return i}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(VertexBuffer.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(this.indexStart===0&&this.indexCount===t.length){const r=this._renderingMesh.getBoundingInfo();i={minimum:r.minimum.clone(),maximum:r.maximum.clone()}}else i=extractMinAndMaxIndexed(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new BoundingInfo(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let r=this.indexStart;r<this.indexStart+this.indexCount;r+=3)i.push(e[r],e[r+1],e[r+1],e[r+2],e[r+2],e[r]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,i,r,s){const n=this.getMaterial();if(!n)return null;let o=3,l=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,l=!0;break}return n.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,r):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,r):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,r,s):this._intersectTriangles(e,t,i,o,l,r,s)}_intersectLines(e,t,i,r,s){let n=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){const l=t[i[o]],h=t[i[o+1]],u=e.intersectionSegment(l,h,r);if(!(u<0)&&(s||!n||u<n.distance)&&(n=new IntersectionInfo(null,null,u),n.faceId=o/2,s))break}return n}_intersectUnIndexedLines(e,t,i,r,s){let n=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=2){const l=t[o],h=t[o+1],u=e.intersectionSegment(l,h,r);if(!(u<0)&&(s||!n||u<n.distance)&&(n=new IntersectionInfo(null,null,u),n.faceId=o/2,s))break}return n}_intersectTriangles(e,t,i,r,s,n,o){let l=null,h=-1;for(let u=this.indexStart;u<this.indexStart+this.indexCount-(3-r);u+=r){h++;const c=i[u],d=i[u+1],f=i[u+2];if(s&&f===4294967295){u+=2;continue}const _=t[c],g=t[d],p=t[f];if(!_||!g||!p||o&&!o(_,g,p,e,c,d,f))continue;const m=e.intersectsTriangle(_,g,p);if(m){if(m.distance<0)continue;if((n||!l||m.distance<l.distance)&&(l=m,l.faceId=h,n))break}}return l}_intersectUnIndexedTriangles(e,t,i,r,s){let n=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const l=t[o],h=t[o+1],u=t[o+2];if(s&&!s(l,h,u,e,-1,-1,-1))continue;const c=e.intersectsTriangle(l,h,u);if(c){if(c.distance<0)continue;if((r||!n||c.distance<n.distance)&&(n=c,n.faceId=o/3,r))break}}return n}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new SubMesh(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const r=this.getBoundingInfo();if(!r)return i;i._boundingInfo=new BoundingInfo(r.minimum,r.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,r,s,n=!0){let o=Number.MAX_VALUE,l=-Number.MAX_VALUE;const u=(s||r).getIndices();for(let c=t;c<t+i;c++){const d=u[c];d<o&&(o=d),d>l&&(l=d)}return new SubMesh(e,o,l-o+1,t,i,r,s,n)}}class SceneLoaderFlags{static get ForceFullSceneLoadingForIncremental(){return SceneLoaderFlags._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){SceneLoaderFlags._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return SceneLoaderFlags._ShowLoadingScreen}static set ShowLoadingScreen(e){SceneLoaderFlags._ShowLoadingScreen=e}static get loggingLevel(){return SceneLoaderFlags._LoggingLevel}static set loggingLevel(e){SceneLoaderFlags._LoggingLevel=e}static get CleanBoneMatrixWeights(){return SceneLoaderFlags._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){SceneLoaderFlags._CleanBoneMatrixWeights=e}}SceneLoaderFlags._ForceFullSceneLoadingForIncremental=!1;SceneLoaderFlags._ShowLoadingScreen=!0;SceneLoaderFlags._CleanBoneMatrixWeights=!1;SceneLoaderFlags._LoggingLevel=0;class Geometry{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new Geometry(Geometry.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,r=!1,s=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||EngineStore.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,i?this.setAllVerticesData(i,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),s&&(this.applyToMesh(s),s.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,r){i&&Array.isArray(t)&&(t=new Float32Array(t));const s=new VertexBuffer(this._engine,t,e,i,this._meshes.length===0,r);this.setVerticesBuffer(s)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const r=e.getKind();this._vertexBuffers[r]&&i&&this._vertexBuffers[r].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[r]=e;const s=this._meshes,n=s.length;if(r===VertexBuffer.PositionKind){const o=e.getData();t!=null?this._totalVertices=t:o!=null&&(this._totalVertices=o.length/(e.type===VertexBuffer.BYTE?e.byteStride:e.byteStride/4)),this._updateExtend(o),this._resetPointsArrayCache();for(let l=0;l<n;l++){const h=s[l];h.buildBoundingInfo(this._extend.minimum,this._extend.maximum),h._createGlobalSubMesh(h.isUnIndexed),h.computeWorldMatrix(!0),h.synchronizeInstances()}}this._notifyUpdate(r)}updateVerticesDataDirectly(e,t,i,r=!1){const s=this.getVertexBuffer(e);s&&(s.updateDirectly(t,i,r),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const r=this.getVertexBuffer(e);r&&(r.update(t),e===VertexBuffer.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const i=this._meshes;for(const r of i){r.hasBoundingInfo?r.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):r.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const s=r.subMeshes;for(const n of s)n.refreshBoundingInfo()}}}_bind(e,t,i,r){if(!e)return;t===void 0&&(t=this._indexBuffer);const s=this.getVertexBuffers();if(!s)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!r){this._engine.bindBuffers(s,t,e,i);return}const n=r||this._vertexArrayObjects;n[e.key]||(n[e.key]=this._engine.recordVertexArrayObject(s,t,e,i)),this._engine.bindVertexArrayObject(n[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const r=this.getVertexBuffer(e);return r?r.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{const r=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),r)for(const s of this._meshes)s._createGlobalSubMesh(!0)}}setIndices(e,t=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),t!=null&&(this._totalVertices=t);for(const r of this._meshes)r._createGlobalSubMesh(!0),r.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,r=i.indexOf(e);r!==-1&&(i.splice(r,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(VertexBuffer.PositionKind),!e))return;this._extend=extractMinAndMax(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)t===1&&this._vertexBuffers[i].create(),i===VertexBuffer.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const r=this._meshes,s=r.length;for(let n=0;n<s;n++)this._applyToMesh(r[n]);t&&t()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(e!=null&&e.length>0){for(let r=0;r<e.length;r+=3){const s=e[r+0];e[r+0]=e[r+2],e[r+2]=s}this.setIndices(e)}const t=this.getVerticesData(VertexBuffer.PositionKind,!1);if(t!=null&&t.length>0){for(let r=0;r<t.length;r+=3)t[r+2]=-t[r+2];this.setVerticesData(VertexBuffer.PositionKind,t,!1)}const i=this.getVerticesData(VertexBuffer.NormalKind,!1);if(i!=null&&i.length>0){for(let r=0;r<i.length;r+=3)i[r+2]=-i[r+2];this.setVerticesData(VertexBuffer.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(VertexBuffer.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=Vector3.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const r in this._vertexBuffers)this._vertexBuffers[r].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const r=this._parentContainer.geometries.indexOf(this);r>-1&&this._parentContainer.geometries.splice(r,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new VertexData;t.indices=[];const i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let r=!1,s=!1,n;for(n in this._vertexBuffers){const l=this.getVerticesData(n);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),n):t.set(l.slice(0),n),!s)){const h=this.getVertexBuffer(n);h&&(r=h.isUpdatable(),s=!r)}}const o=new Geometry(e,this._scene,t,r);o.delayLoadState=this.delayLoadState,o.delayLoadingFile=this.delayLoadingFile,o._delayLoadingFunction=this._delayLoadingFunction;for(n in this._delayInfo)o._delayInfo=o._delayInfo||[],o._delayInfo.push(n);return o._boundingInfo=new BoundingInfo(this._extend.minimum,this._extend.maximum),o}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Tags&&Tags.HasTags(this)&&(e.tags=Tags.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(VertexBuffer.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(VertexBuffer.PositionKind)),this.isVertexBufferUpdatable(VertexBuffer.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(VertexBuffer.NormalKind)),this.isVertexBufferUpdatable(VertexBuffer.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(VertexBuffer.TangentKind)),this.isVertexBufferUpdatable(VertexBuffer.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(VertexBuffer.UVKind)),this.isVertexBufferUpdatable(VertexBuffer.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(VertexBuffer.UV2Kind)),this.isVertexBufferUpdatable(VertexBuffer.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(VertexBuffer.UV3Kind)),this.isVertexBufferUpdatable(VertexBuffer.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(VertexBuffer.UV4Kind)),this.isVertexBufferUpdatable(VertexBuffer.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(VertexBuffer.UV5Kind)),this.isVertexBufferUpdatable(VertexBuffer.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(VertexBuffer.UV6Kind)),this.isVertexBufferUpdatable(VertexBuffer.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(VertexBuffer.ColorKind)),this.isVertexBufferUpdatable(VertexBuffer.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(VertexBuffer.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(VertexBuffer.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(VertexBuffer.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(VertexBuffer.MatricesWeightsKind)),this.isVertexBufferUpdatable(VertexBuffer.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return Tools.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),r=e.geometryUniqueId,s=e.geometryId;if(r||s){const n=r?this._GetGeometryByLoadedUniqueId(r,i):i.getGeometryById(s);n&&n.applyToMesh(t)}else if(e instanceof ArrayBuffer){const n=t._binaryInfo;if(n.positionsAttrDesc&&n.positionsAttrDesc.count>0){const o=new Float32Array(e,n.positionsAttrDesc.offset,n.positionsAttrDesc.count);t.setVerticesData(VertexBuffer.PositionKind,o,!1)}if(n.normalsAttrDesc&&n.normalsAttrDesc.count>0){const o=new Float32Array(e,n.normalsAttrDesc.offset,n.normalsAttrDesc.count);t.setVerticesData(VertexBuffer.NormalKind,o,!1)}if(n.tangetsAttrDesc&&n.tangetsAttrDesc.count>0){const o=new Float32Array(e,n.tangetsAttrDesc.offset,n.tangetsAttrDesc.count);t.setVerticesData(VertexBuffer.TangentKind,o,!1)}if(n.uvsAttrDesc&&n.uvsAttrDesc.count>0){const o=new Float32Array(e,n.uvsAttrDesc.offset,n.uvsAttrDesc.count);if(CompatibilityOptions.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(VertexBuffer.UVKind,o,!1)}if(n.uvs2AttrDesc&&n.uvs2AttrDesc.count>0){const o=new Float32Array(e,n.uvs2AttrDesc.offset,n.uvs2AttrDesc.count);if(CompatibilityOptions.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(VertexBuffer.UV2Kind,o,!1)}if(n.uvs3AttrDesc&&n.uvs3AttrDesc.count>0){const o=new Float32Array(e,n.uvs3AttrDesc.offset,n.uvs3AttrDesc.count);if(CompatibilityOptions.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(VertexBuffer.UV3Kind,o,!1)}if(n.uvs4AttrDesc&&n.uvs4AttrDesc.count>0){const o=new Float32Array(e,n.uvs4AttrDesc.offset,n.uvs4AttrDesc.count);if(CompatibilityOptions.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(VertexBuffer.UV4Kind,o,!1)}if(n.uvs5AttrDesc&&n.uvs5AttrDesc.count>0){const o=new Float32Array(e,n.uvs5AttrDesc.offset,n.uvs5AttrDesc.count);if(CompatibilityOptions.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(VertexBuffer.UV5Kind,o,!1)}if(n.uvs6AttrDesc&&n.uvs6AttrDesc.count>0){const o=new Float32Array(e,n.uvs6AttrDesc.offset,n.uvs6AttrDesc.count);if(CompatibilityOptions.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(VertexBuffer.UV6Kind,o,!1)}if(n.colorsAttrDesc&&n.colorsAttrDesc.count>0){const o=new Float32Array(e,n.colorsAttrDesc.offset,n.colorsAttrDesc.count);t.setVerticesData(VertexBuffer.ColorKind,o,!1,n.colorsAttrDesc.stride)}if(n.matricesIndicesAttrDesc&&n.matricesIndicesAttrDesc.count>0){const o=new Int32Array(e,n.matricesIndicesAttrDesc.offset,n.matricesIndicesAttrDesc.count),l=[];for(let h=0;h<o.length;h++){const u=o[h];l.push(u&255),l.push((u&65280)>>8),l.push((u&16711680)>>16),l.push(u>>24&255)}t.setVerticesData(VertexBuffer.MatricesIndicesKind,l,!1)}if(n.matricesIndicesExtraAttrDesc&&n.matricesIndicesExtraAttrDesc.count>0){const o=new Int32Array(e,n.matricesIndicesExtraAttrDesc.offset,n.matricesIndicesExtraAttrDesc.count),l=[];for(let h=0;h<o.length;h++){const u=o[h];l.push(u&255),l.push((u&65280)>>8),l.push((u&16711680)>>16),l.push(u>>24&255)}t.setVerticesData(VertexBuffer.MatricesIndicesExtraKind,l,!1)}if(n.matricesWeightsAttrDesc&&n.matricesWeightsAttrDesc.count>0){const o=new Float32Array(e,n.matricesWeightsAttrDesc.offset,n.matricesWeightsAttrDesc.count);t.setVerticesData(VertexBuffer.MatricesWeightsKind,o,!1)}if(n.indicesAttrDesc&&n.indicesAttrDesc.count>0){const o=new Int32Array(e,n.indicesAttrDesc.offset,n.indicesAttrDesc.count);t.setIndices(o,null)}if(n.subMeshesAttrDesc&&n.subMeshesAttrDesc.count>0){const o=new Int32Array(e,n.subMeshesAttrDesc.offset,n.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<n.subMeshesAttrDesc.count;l++){const h=o[l*5+0],u=o[l*5+1],c=o[l*5+2],d=o[l*5+3],f=o[l*5+4];SubMesh.AddToMesh(h,u,c,d,f,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(VertexBuffer.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(VertexBuffer.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(VertexBuffer.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(VertexBuffer.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(VertexBuffer.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(VertexBuffer.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(VertexBuffer.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(VertexBuffer.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(VertexBuffer.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(VertexBuffer.ColorKind,Color4.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(VertexBuffer.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const n=[];for(let o=0;o<e.matricesIndices.length;o++){const l=e.matricesIndices[o];n.push(l&255),n.push((l&65280)>>8),n.push((l&16711680)>>16),n.push(l>>24&255)}t.setVerticesData(VertexBuffer.MatricesIndicesKind,n,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(VertexBuffer.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const n=[];for(let o=0;o<e.matricesIndicesExtra.length;o++){const l=e.matricesIndicesExtra[o];n.push(l&255),n.push((l&65280)>>8),n.push((l&16711680)>>16),n.push(l>>24&255)}t.setVerticesData(VertexBuffer.MatricesIndicesExtraKind,n,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(Geometry._CleanMatricesWeights(e,t),t.setVerticesData(VertexBuffer.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(VertexBuffer.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let n=0;n<e.subMeshes.length;n++){const o=e.subMeshes[n];SubMesh.AddToMesh(o.materialIndex,o.verticesStart,o.verticesCount,o.indexStart,o.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!SceneLoaderFlags.CleanBoneMatrixWeights)return;let r=0;if(e.skeletonId>-1){const c=t.getScene().getLastSkeletonById(e.skeletonId);if(!c)return;r=c.bones.length}else return;const s=t.getVerticesData(VertexBuffer.MatricesIndicesKind),n=t.getVerticesData(VertexBuffer.MatricesIndicesExtraKind),o=e.matricesWeights,l=e.matricesWeightsExtra,h=e.numBoneInfluencer,u=o.length;for(let c=0;c<u;c+=4){let d=0,f=-1;for(let _=0;_<4;_++){const g=o[c+_];d+=g,g<.001&&f<0&&(f=_)}if(l)for(let _=0;_<4;_++){const g=l[c+_];d+=g,g<.001&&f<0&&(f=_+4)}if((f<0||f>h-1)&&(f=h-1),d>.001){const _=1/d;for(let g=0;g<4;g++)o[c+g]*=_;if(l)for(let g=0;g<4;g++)l[c+g]*=_}else f>=4?(l[c+f-4]=1-d,n[c+f-4]=r):(o[c+f]=1-d,s[c+f]=r)}t.setVerticesData(VertexBuffer.MatricesIndicesKind,s),e.matricesWeightsExtra&&t.setVerticesData(VertexBuffer.MatricesIndicesExtraKind,n)}static Parse(e,t,i){const r=new Geometry(e.id,t,void 0,e.updatable);return r._loadedUniqueId=e.uniqueId,Tags&&Tags.AddTagsTo(r,e.tags),e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r._boundingInfo=new BoundingInfo(Vector3.FromArray(e.boundingBoxMinimum),Vector3.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(VertexBuffer.UVKind),e.hasUVs2&&r._delayInfo.push(VertexBuffer.UV2Kind),e.hasUVs3&&r._delayInfo.push(VertexBuffer.UV3Kind),e.hasUVs4&&r._delayInfo.push(VertexBuffer.UV4Kind),e.hasUVs5&&r._delayInfo.push(VertexBuffer.UV5Kind),e.hasUVs6&&r._delayInfo.push(VertexBuffer.UV6Kind),e.hasColors&&r._delayInfo.push(VertexBuffer.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(VertexBuffer.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(VertexBuffer.MatricesWeightsKind),r._delayLoadingFunction=VertexData.ImportVertexData):VertexData.ImportVertexData(e,r),t.pushGeometry(r,!0),r}}class _MeshCollisionData{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new Vector3(0,0,0),this._diffPositionForCollisions=new Vector3(0,0,0),this._collisionResponse=!0}}class _FacetDataStorage{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=Vector3.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class _InternalAbstractMeshDataInfo{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new _FacetDataStorage,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new _MeshCollisionData,this._enableDistantPicking=!1,this._rawBoundingInfo=null}}class AbstractMesh extends TransformNode{static get BILLBOARDMODE_NONE(){return TransformNode.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return TransformNode.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return TransformNode.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return TransformNode.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return TransformNode.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return TransformNode.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(t===1&&e!==1||t!==1&&e===1)&&this._markSubMeshesAsDirty(i=>{i.markAsMiscDirty(),i.markAsPrePassDirty()})}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){var t;return(t=this._internalAbstractMeshDataInfo._materialForRenderPass)===null||t===void 0?void 0:t[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new _InternalAbstractMeshDataInfo,this._waitingMaterialId=null,this.cullingStrategy=AbstractMesh.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new Observable,this.onCollisionPositionChangeObservable=new Observable,this.onMaterialChangedObservable=new Observable,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=Color3.Red(),this.outlineWidth=.02,this.overlayColor=Color3.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new Vector3(.5,1,.5),this.ellipsoidOffset=new Vector3(0,0,0),this.edgesWidth=1,this.edgesColor=new Color4(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new Observable,this._onCollisionPositionChange=(i,r,s=null)=>{r.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>Engine.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),s&&this.onCollideObservable.notifyObservers(s),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},t=this.getScene(),t.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new UniformBuffer(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case ScenePerformancePriority.Aggressive:this.doNotSyncBoundingInfo=!0;case ScenePerformancePriority.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==TransformNode.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes)for(const t of this.subMeshes)t._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let r=!1;if(i===-1){if(!t)return;this._lightSources.push(e)}else{if(t)return;r=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(r)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const r=t._drawWrappers[i];!r||!r.defines||!r.defines.markAllAsDirty||e(r.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(this.subMeshes)for(const t of this.subMeshes)t.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,r){return this}updateVerticesData(e,t,i,r){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){var e;return(e=this.rawBoundingInfo)!==null&&e!==void 0?e:this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,t,i){return this._boundingInfo=new BoundingInfo(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(VertexBuffer.MatricesIndicesKind)&&this.isVerticesDataPresent(VertexBuffer.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===TransformNode.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const r=new Matrix;(this.rotationQuaternion?this.rotationQuaternion:Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(r);const n=Vector3.Zero(),o=this.definedFacingForward?-1:1;return Vector3.TransformCoordinatesFromFloatsToRef(e*o,t,i*o,r,n),n}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const r=this.definedFacingForward?1:-1;return new Vector3(e*r,t,i*r)}refreshBoundingInfo(e=!1,t=!1){return this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(e,t),null),this)}_refreshBoundingInfo(e,t){if(e){const i=extractMinAndMax(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new BoundingInfo(i.minimum,i.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(e);this._updateBoundingInfo()}_getData(e=!1,t=!1,i,r=VertexBuffer.PositionKind){if(i=i??this.getVerticesData(r).slice(),i&&t&&this.morphTargetManager){let s=0,n=0;for(let o=0;o<i.length;o++){for(let l=0;l<this.morphTargetManager.numTargets;l++){const h=this.morphTargetManager.getTarget(l),u=h.influence;if(u>0){const c=h.getPositions();c&&(i[o]+=(c[o]-i[o])*u)}}if(s++,r===VertexBuffer.PositionKind&&this._positions&&s===3){s=0;const l=n*3;this._positions[n++].copyFromFloats(i[l],i[l+1],i[l+2])}}}if(i&&e&&this.skeleton){const s=this.getVerticesData(VertexBuffer.MatricesIndicesKind),n=this.getVerticesData(VertexBuffer.MatricesWeightsKind);if(n&&s){const o=this.numBoneInfluencers>4,l=o?this.getVerticesData(VertexBuffer.MatricesIndicesExtraKind):null,h=o?this.getVerticesData(VertexBuffer.MatricesWeightsExtraKind):null,u=this.skeleton.getTransformMatrices(this),c=TmpVectors.Vector3[0],d=TmpVectors.Matrix[0],f=TmpVectors.Matrix[1];let _=0;for(let g=0;g<i.length;g+=3,_+=4){d.reset();let p,m;for(p=0;p<4;p++)m=n[_+p],m>0&&(Matrix.FromFloat32ArrayToRefScaled(u,Math.floor(s[_+p]*16),m,f),d.addToSelf(f));if(o)for(p=0;p<4;p++)m=h[_+p],m>0&&(Matrix.FromFloat32ArrayToRefScaled(u,Math.floor(l[_+p]*16),m,f),d.addToSelf(f));r===VertexBuffer.NormalKind?Vector3.TransformNormalFromFloatsToRef(i[g],i[g+1],i[g+2],d,c):Vector3.TransformCoordinatesFromFloatsToRef(i[g],i[g+1],i[g+2],d,c),c.toArray(i,g),r===VertexBuffer.PositionKind&&this._positions&&this._positions[g/3].copyFrom(c)}}}return i}getNormalsData(e=!1,t=!1){return this._getData(e,t,null,VertexBuffer.NormalKind)}getPositionData(e=!1,t=!1,i){return this._getData(e,t,i,VertexBuffer.PositionKind)}_getPositionData(e,t){var i;let r=this.getVerticesData(VertexBuffer.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),r&&(e&&this.skeleton||t&&this.morphTargetManager)){if(r=r.slice(),this._generatePointsArray(),this._positions){const s=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(s.length);for(let n=0;n<s.length;n++)this._internalAbstractMeshDataInfo._positions[n]=((i=s[n])===null||i===void 0?void 0:i.clone())||new Vector3}return this.getPositionData(e,t,r)}return r}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new BoundingInfo(Vector3.Zero(),Vector3.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const r=this.subMeshes[i];(t>1||!r.IsGlobal)&&r.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){const r=this.getBoundingInfo(),s=e.getBoundingInfo();if(r.intersects(s,t))return!0;if(i){for(const n of this.getChildMeshes())if(n.intersectsMesh(e,t,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const i=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=i.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,i.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,i){var r;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const s=e.verticesStart,n=e.verticesStart+e.verticesCount;for(let o=s;o<n;o++)e._lastColliderWorldVertices.push(Vector3.TransformCoordinates(this._positions[o],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),((r=e.getMaterial())===null||r===void 0?void 0:r.fillMode)===7),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),r=i.length;for(let s=0;s<r;s++){const n=i.data[s];r>1&&!n._checkCollision(e)||this._collideForSubMesh(n,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=TmpVectors.Matrix[0],i=TmpVectors.Matrix[1];return Matrix.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,r=!1,s,n=!1){const o=new PickingInfo,l=this.getClassName(),h=l==="InstancedLinesMesh"||l==="LinesMesh"||l==="GreasedLineMesh"?this.intersectionThreshold:0,u=this.getBoundingInfo();if(!this.subMeshes||!n&&(!e.intersectsSphere(u.boundingSphere,h)||!e.intersectsBox(u.boundingBox,h)))return o;if(r)return o.hit=!n,o.pickedMesh=n?null:this,o.distance=n?0:Vector3.Distance(e.origin,u.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let c=null;const d=this._scene.getIntersectingSubMeshCandidates(this,e),f=d.length;let _=!1;for(let g=0;g<f;g++){const m=d.data[g].getMaterial();if(m&&(m.fillMode==7||m.fillMode==0||m.fillMode==1||m.fillMode==2||m.fillMode==4)){_=!0;break}}if(!_)return o.hit=!0,o.pickedMesh=this,o.distance=Vector3.Distance(e.origin,u.boundingSphere.center),o.subMeshId=-1,o;for(let g=0;g<f;g++){const p=d.data[g];if(f>1&&!p.canIntersects(e))continue;const m=p.intersects(e,this._positions,this.getIndices(),t,i);if(m&&(t||!c||m.distance<c.distance)&&(c=m,c.subMeshId=g,t))break}if(c){const g=s??this.getWorldMatrix(),p=TmpVectors.Vector3[0],m=TmpVectors.Vector3[1];Vector3.TransformCoordinatesToRef(e.origin,g,p),e.direction.scaleToRef(c.distance,m);const M=Vector3.TransformNormal(m,g).addInPlace(p);return o.hit=!0,o.distance=Vector3.Distance(p,M),o.pickedPoint=M,o.pickedMesh=this,o.bu=c.bu||0,o.bv=c.bv||0,o.subMeshFaceId=c.faceId,o.faceId=c.faceId+d.data[c.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),o.subMeshId=c.subMeshId,o}return o}clone(e,t,i){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this}dispose(e,t=!1){let i;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const n=this._intersectionsInProgress[i],o=n._intersectionsInProgress.indexOf(this);n._intersectionsInProgress.splice(o,1)}this._intersectionsInProgress.length=0,this.getScene().lights.forEach(n=>{let o=n.includedOnlyMeshes.indexOf(this);o!==-1&&n.includedOnlyMeshes.splice(o,1),o=n.excludedMeshes.indexOf(this),o!==-1&&n.excludedMeshes.splice(o,1);const l=n.getShadowGenerators();if(l){const h=l.values();for(let u=h.next();u.done!==!0;u=h.next()){const d=u.value.getShadowMap();d&&d.renderList&&(o=d.renderList.indexOf(this),o!==-1&&d.renderList.splice(o,1))}}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();const s=this.getScene().getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,s.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),s.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){const n=this._parentContainer.meshes.indexOf(this);n>-1&&this._parentContainer.meshes.splice(n,1),this._parentContainer=null}if(t&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<this.getScene().particleSystems.length;i++)this.getScene().particleSystems[i].emitter===this&&(this.getScene().particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=new Array),e.facetPositions||(e.facetPositions=new Array),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=Vector3.Zero(),e.facetPositions[t]=Vector3.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(VertexBuffer.PositionKind),i=this.getIndices(),r=this.getVerticesData(VertexBuffer.NormalKind),s=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let o=!1;for(let l=0;l<i.length;l++)if(i[l]>65535){o=!0;break}o?e.depthSortedIndices=new Uint32Array(i):e.depthSortedIndices=new Uint16Array(i)}if(e.facetDepthSortFunction=function(o,l){return l.sqDistance-o.sqDistance},!e.facetDepthSortFrom){const o=this.getScene().activeCamera;e.facetDepthSortFrom=o?o.position:Vector3.Zero()}e.depthSortedFacets=[];for(let o=0;o<e.facetNb;o++){const l={ind:o*3,sqDistance:0};e.depthSortedFacets.push(l)}e.invertedMatrix=Matrix.Identity(),e.facetDepthSortOrigin=Vector3.Zero()}e.bbSize.x=s.maximum.x-s.minimum.x>Epsilon?s.maximum.x-s.minimum.x:Epsilon,e.bbSize.y=s.maximum.y-s.minimum.y>Epsilon?s.maximum.y-s.minimum.y:Epsilon,e.bbSize.z=s.maximum.z-s.minimum.z>Epsilon?s.maximum.z-s.minimum.z:Epsilon;let n=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(n=n>e.bbSize.z?n:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/n),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/n),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/n),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=s,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),Vector3.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,r&&VertexData.ComputeNormals(t,i,r,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const o=e.depthSortedIndices.length/3|0;for(let l=0;l<o;l++){const h=e.depthSortedFacets[l].ind;e.depthSortedIndices[l*3]=i[h],e.depthSortedIndices[l*3+1]=i[h+1],e.depthSortedIndices[l*3+2]=i[h+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=Vector3.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],r=this.getWorldMatrix();return Vector3.TransformCoordinatesToRef(i,r,t),this}getFacetNormal(e){const t=Vector3.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return Vector3.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const r=this.getBoundingInfo(),s=this._internalAbstractMeshDataInfo._facetData,n=Math.floor((e-r.minimum.x*s.partitioningBBoxRatio)*s.subDiv.X*s.partitioningBBoxRatio/s.bbSize.x),o=Math.floor((t-r.minimum.y*s.partitioningBBoxRatio)*s.subDiv.Y*s.partitioningBBoxRatio/s.bbSize.y),l=Math.floor((i-r.minimum.z*s.partitioningBBoxRatio)*s.subDiv.Z*s.partitioningBBoxRatio/s.bbSize.z);return n<0||n>s.subDiv.max||o<0||o>s.subDiv.max||l<0||l>s.subDiv.max?null:s.facetPartitioning[n+s.subDiv.max*o+s.subDiv.max*s.subDiv.max*l]}getClosestFacetAtCoordinates(e,t,i,r,s=!1,n=!0){const o=this.getWorldMatrix(),l=TmpVectors.Matrix[5];o.invertToRef(l);const h=TmpVectors.Vector3[8];Vector3.TransformCoordinatesFromFloatsToRef(e,t,i,l,h);const u=this.getClosestFacetAtLocalCoordinates(h.x,h.y,h.z,r,s,n);return r&&Vector3.TransformCoordinatesFromFloatsToRef(r.x,r.y,r.z,o,r),u}getClosestFacetAtLocalCoordinates(e,t,i,r,s=!1,n=!0){let o=null,l=0,h=0,u=0,c=0,d=0,f=0,_=0,g=0;const p=this.getFacetLocalPositions(),m=this.getFacetLocalNormals(),E=this.getFacetsAtLocalCoordinates(e,t,i);if(!E)return null;let M=Number.MAX_VALUE,x=M,A,T,C;for(let b=0;b<E.length;b++)A=E[b],T=m[A],C=p[A],c=(e-C.x)*T.x+(t-C.y)*T.y+(i-C.z)*T.z,(!s||s&&n&&c>=0||s&&!n&&c<=0)&&(c=T.x*C.x+T.y*C.y+T.z*C.z,d=-(T.x*e+T.y*t+T.z*i-c)/(T.x*T.x+T.y*T.y+T.z*T.z),f=e+T.x*d,_=t+T.y*d,g=i+T.z*d,l=f-e,h=_-t,u=g-i,x=l*l+h*h+u*u,x<M&&(M=x,o=A,r&&(r.x=f,r.y=_,r.z=g)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=new Array,e.facetNormals=new Array,e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){const t=this.getVerticesData(VertexBuffer.PositionKind),i=this.getIndices();let r;return this.isVerticesDataPresent(VertexBuffer.NormalKind)?r=this.getVerticesData(VertexBuffer.NormalKind):r=[],VertexData.ComputeNormals(t,i,r,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(VertexBuffer.NormalKind,r,e),this}alignWithNormal(e,t){t||(t=Axis.Y);const i=TmpVectors.Vector3[0],r=TmpVectors.Vector3[1];return Vector3.CrossToRef(t,e,r),Vector3.CrossToRef(e,r,i),this.rotationQuaternion?Quaternion.RotationQuaternionFromAxisToRef(i,e,r,this.rotationQuaternion):Vector3.RotationFromAxisToRef(i,e,r,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw _WarnImport("EdgesRenderer")}enableEdgesRendering(e,t,i){throw _WarnImport("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}}AbstractMesh.OCCLUSION_TYPE_NONE=0;AbstractMesh.OCCLUSION_TYPE_OPTIMISTIC=1;AbstractMesh.OCCLUSION_TYPE_STRICT=2;AbstractMesh.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;AbstractMesh.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;AbstractMesh.CULLINGSTRATEGY_STANDARD=0;AbstractMesh.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;AbstractMesh.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;AbstractMesh.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;RegisterClass("BABYLON.AbstractMesh",AbstractMesh);function addClipPlaneUniforms(a){a.indexOf("vClipPlane")===-1&&a.push("vClipPlane"),a.indexOf("vClipPlane2")===-1&&a.push("vClipPlane2"),a.indexOf("vClipPlane3")===-1&&a.push("vClipPlane3"),a.indexOf("vClipPlane4")===-1&&a.push("vClipPlane4"),a.indexOf("vClipPlane5")===-1&&a.push("vClipPlane5"),a.indexOf("vClipPlane6")===-1&&a.push("vClipPlane6")}function prepareStringDefinesForClipPlanes(a,e,t){var i,r,s,n,o,l;const h=!!((i=a.clipPlane)!==null&&i!==void 0?i:e.clipPlane),u=!!((r=a.clipPlane2)!==null&&r!==void 0?r:e.clipPlane2),c=!!((s=a.clipPlane3)!==null&&s!==void 0?s:e.clipPlane3),d=!!((n=a.clipPlane4)!==null&&n!==void 0?n:e.clipPlane4),f=!!((o=a.clipPlane5)!==null&&o!==void 0?o:e.clipPlane5),_=!!((l=a.clipPlane6)!==null&&l!==void 0?l:e.clipPlane6);h&&t.push("#define CLIPPLANE"),u&&t.push("#define CLIPPLANE2"),c&&t.push("#define CLIPPLANE3"),d&&t.push("#define CLIPPLANE4"),f&&t.push("#define CLIPPLANE5"),_&&t.push("#define CLIPPLANE6")}function prepareDefinesForClipPlanes(a,e,t){var i,r,s,n,o,l;let h=!1;const u=!!((i=a.clipPlane)!==null&&i!==void 0?i:e.clipPlane),c=!!((r=a.clipPlane2)!==null&&r!==void 0?r:e.clipPlane2),d=!!((s=a.clipPlane3)!==null&&s!==void 0?s:e.clipPlane3),f=!!((n=a.clipPlane4)!==null&&n!==void 0?n:e.clipPlane4),_=!!((o=a.clipPlane5)!==null&&o!==void 0?o:e.clipPlane5),g=!!((l=a.clipPlane6)!==null&&l!==void 0?l:e.clipPlane6);return t.CLIPPLANE!==u&&(t.CLIPPLANE=u,h=!0),t.CLIPPLANE2!==c&&(t.CLIPPLANE2=c,h=!0),t.CLIPPLANE3!==d&&(t.CLIPPLANE3=d,h=!0),t.CLIPPLANE4!==f&&(t.CLIPPLANE4=f,h=!0),t.CLIPPLANE5!==_&&(t.CLIPPLANE5=_,h=!0),t.CLIPPLANE6!==g&&(t.CLIPPLANE6=g,h=!0),h}function bindClipPlane(a,e,t){var i,r,s,n,o,l;let h=(i=e.clipPlane)!==null&&i!==void 0?i:t.clipPlane;setClipPlane(a,"vClipPlane",h),h=(r=e.clipPlane2)!==null&&r!==void 0?r:t.clipPlane2,setClipPlane(a,"vClipPlane2",h),h=(s=e.clipPlane3)!==null&&s!==void 0?s:t.clipPlane3,setClipPlane(a,"vClipPlane3",h),h=(n=e.clipPlane4)!==null&&n!==void 0?n:t.clipPlane4,setClipPlane(a,"vClipPlane4",h),h=(o=e.clipPlane5)!==null&&o!==void 0?o:t.clipPlane5,setClipPlane(a,"vClipPlane5",h),h=(l=e.clipPlane6)!==null&&l!==void 0?l:t.clipPlane6,setClipPlane(a,"vClipPlane6",h)}function setClipPlane(a,e,t){t&&a.setFloat4(e,t.normal.x,t.normal.y,t.normal.z,t.d)}class MaterialHelper{static BindSceneUniformBuffer(e,t){t.bindToEffect(e,"Scene")}static PrepareDefinesForMergedUV(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}static BindTextureMatrix(e,t,i){const r=e.getTextureMatrix();t.updateMatrix(i+"Matrix",r)}static GetFogState(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==Scene.FOGMODE_NONE}static PrepareDefinesForMisc(e,t,i,r,s,n,o){o._areMiscDirty&&(o.LOGARITHMICDEPTH=i,o.POINTSIZE=r,o.FOG=s&&this.GetFogState(e,t),o.NONUNIFORMSCALING=e.nonUniformScaling,o.ALPHATEST=n)}static PrepareDefinesForCamera(e,t){let i=!1;if(e.activeCamera){const r=t.CAMERA_ORTHOGRAPHIC?1:0,s=t.CAMERA_PERSPECTIVE?1:0,n=e.activeCamera.mode===Camera.ORTHOGRAPHIC_CAMERA?1:0,o=e.activeCamera.mode===Camera.PERSPECTIVE_CAMERA?1:0;(r^n||s^o)&&(t.CAMERA_ORTHOGRAPHIC=n===1,t.CAMERA_PERSPECTIVE=o===1,i=!0)}return i}static PrepareDefinesForFrameBoundValues(e,t,i,r,s,n=null,o=!1){let l=MaterialHelper.PrepareDefinesForCamera(e,r);n!==!1&&(l=prepareDefinesForClipPlanes(i,e,r)),r.DEPTHPREPASS!==!t.getColorWrite()&&(r.DEPTHPREPASS=!r.DEPTHPREPASS,l=!0),r.INSTANCES!==s&&(r.INSTANCES=s,l=!0),r.THIN_INSTANCES!==o&&(r.THIN_INSTANCES=o,l=!0),l&&r.markAsUnprocessed()}static PrepareDefinesForBones(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=t.BONETEXTURE!==void 0;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=i?!1:void 0;const r=e.getScene().prePassRenderer;if(r&&r.enabled){const s=r.excludedSkinnedMesh.indexOf(e)===-1;t.BONES_VELOCITY_ENABLED=s}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.BONETEXTURE!==void 0&&(t.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!!(i&&i.isEnabled)}static PrepareDefinesForAttributes(e,t,i,r,s=!1,n=!0,o=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(VertexBuffer.NormalKind),t._needNormals&&e.isVerticesDataPresent(VertexBuffer.TangentKind)&&(t.TANGENT=!0);for(let l=1;l<=6;++l)t["UV"+l]=t._needUVs?e.isVerticesDataPresent(`uv${l===1?"":l}`):!1;if(i){const l=e.useVertexColors&&e.isVerticesDataPresent(VertexBuffer.ColorKind);t.VERTEXCOLOR=l,t.VERTEXALPHA=e.hasVertexAlpha&&l&&n}return e.isVerticesDataPresent(VertexBuffer.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),r&&this.PrepareDefinesForBones(e,t),s&&this.PrepareDefinesForMorphTargets(e,t),o&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}static PrepareDefinesForMultiview(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=e.activeCamera.outputRenderTarget!==null&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}static PrepareDefinesForOIT(e,t,i){const r=t.ORDER_INDEPENDENT_TRANSPARENCY,s=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(r!==t.ORDER_INDEPENDENT_TRANSPARENCY||s!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()}static PrepareDefinesForPrePass(e,t,i){const r=t.PREPASS;if(!t._arePrePassDirty)return;const s=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(let n=0;n<s.length;n++){const o=e.prePassRenderer.getIndex(s[n].type);o!==-1?(t[s[n].define]=!0,t[s[n].index]=o):t[s[n].define]=!1}}else{t.PREPASS=!1;for(let n=0;n<s.length;n++)t[s[n].define]=!1}t.PREPASS!=r&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,t,i,r,s,n,o){var l;switch(o.needNormals=!0,s["LIGHT"+r]===void 0&&(o.needRebuild=!0),s["LIGHT"+r]=!0,s["SPOTLIGHT"+r]=!1,s["HEMILIGHT"+r]=!1,s["POINTLIGHT"+r]=!1,s["DIRLIGHT"+r]=!1,i.prepareLightSpecificDefines(s,r),s["LIGHT_FALLOFF_PHYSICAL"+r]=!1,s["LIGHT_FALLOFF_GLTF"+r]=!1,s["LIGHT_FALLOFF_STANDARD"+r]=!1,i.falloffType){case LightConstants.FALLOFF_GLTF:s["LIGHT_FALLOFF_GLTF"+r]=!0;break;case LightConstants.FALLOFF_PHYSICAL:s["LIGHT_FALLOFF_PHYSICAL"+r]=!0;break;case LightConstants.FALLOFF_STANDARD:s["LIGHT_FALLOFF_STANDARD"+r]=!0;break}if(n&&!i.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),s["SHADOW"+r]=!1,s["SHADOWCSM"+r]=!1,s["SHADOWCSMDEBUG"+r]=!1,s["SHADOWCSMNUM_CASCADES"+r]=!1,s["SHADOWCSMUSESHADOWMAXZ"+r]=!1,s["SHADOWCSMNOBLEND"+r]=!1,s["SHADOWCSM_RIGHTHANDED"+r]=!1,s["SHADOWPCF"+r]=!1,s["SHADOWPCSS"+r]=!1,s["SHADOWPOISSON"+r]=!1,s["SHADOWESM"+r]=!1,s["SHADOWCLOSEESM"+r]=!1,s["SHADOWCUBE"+r]=!1,s["SHADOWLOWQUALITY"+r]=!1,s["SHADOWMEDIUMQUALITY"+r]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const h=(l=i.getShadowGenerator(e.activeCamera))!==null&&l!==void 0?l:i.getShadowGenerator();if(h){const u=h.getShadowMap();u&&u.renderList&&u.renderList.length>0&&(o.shadowEnabled=!0,h.prepareDefines(s,r))}}i.lightmapMode!=LightConstants.LIGHTMAP_DEFAULT?(o.lightmapMode=!0,s["LIGHTMAPEXCLUDED"+r]=!0,s["LIGHTMAPNOSPECULAR"+r]=i.lightmapMode==LightConstants.LIGHTMAP_SHADOWSONLY):(s["LIGHTMAPEXCLUDED"+r]=!1,s["LIGHTMAPNOSPECULAR"+r]=!1)}static PrepareDefinesForLights(e,t,i,r,s=4,n=!1){if(!i._areLightsDirty)return i._needNormals;let o=0;const l={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!n){for(const u of t.lightSources)if(this.PrepareDefinesForLight(e,t,u,o,i,r,l),o++,o===s)break}i.SPECULARTERM=l.specularEnabled,i.SHADOWS=l.shadowEnabled;for(let u=o;u<s;u++)i["LIGHT"+u]!==void 0&&(i["LIGHT"+u]=!1,i["HEMILIGHT"+u]=!1,i["POINTLIGHT"+u]=!1,i["DIRLIGHT"+u]=!1,i["SPOTLIGHT"+u]=!1,i["SHADOW"+u]=!1,i["SHADOWCSM"+u]=!1,i["SHADOWCSMDEBUG"+u]=!1,i["SHADOWCSMNUM_CASCADES"+u]=!1,i["SHADOWCSMUSESHADOWMAXZ"+u]=!1,i["SHADOWCSMNOBLEND"+u]=!1,i["SHADOWCSM_RIGHTHANDED"+u]=!1,i["SHADOWPCF"+u]=!1,i["SHADOWPCSS"+u]=!1,i["SHADOWPOISSON"+u]=!1,i["SHADOWESM"+u]=!1,i["SHADOWCLOSEESM"+u]=!1,i["SHADOWCUBE"+u]=!1,i["SHADOWLOWQUALITY"+u]=!1,i["SHADOWMEDIUMQUALITY"+u]=!1);const h=e.getEngine().getCaps();return i.SHADOWFLOAT===void 0&&(l.needRebuild=!0),i.SHADOWFLOAT=l.shadowEnabled&&(h.textureFloatRender&&h.textureFloatLinearFiltering||h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=l.lightmapMode,l.needRebuild&&i.rebuild(),l.needNormals}static PrepareUniformsAndSamplersForLight(e,t,i,r,s=null,n=!1){s&&s.push("Light"+e),!n&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),r&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))}static PrepareUniformsAndSamplersList(e,t,i,r=4){let s,n=null;if(e.uniformsNames){const o=e;s=o.uniformsNames,n=o.uniformBuffersNames,t=o.samplers,i=o.defines,r=o.maxSimultaneousLights||0}else s=e,t||(t=[]);for(let o=0;o<r&&i["LIGHT"+o];o++)this.PrepareUniformsAndSamplersForLight(o,s,t,i["PROJECTEDLIGHTTEXTURE"+o],n);i.NUM_MORPH_INFLUENCERS&&s.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(s.push("bakedVertexAnimationSettings"),s.push("bakedVertexAnimationTextureSizeInverted"),s.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(e,t,i=4,r=0){let s=0;for(let n=0;n<i&&e["LIGHT"+n];n++)n>0&&(s=r+n,t.addFallback(s,"LIGHT"+n)),e.SHADOWS||(e["SHADOW"+n]&&t.addFallback(r,"SHADOW"+n),e["SHADOWPCF"+n]&&t.addFallback(r,"SHADOWPCF"+n),e["SHADOWPCSS"+n]&&t.addFallback(r,"SHADOWPCSS"+n),e["SHADOWPOISSON"+n]&&t.addFallback(r,"SHADOWPOISSON"+n),e["SHADOWESM"+n]&&t.addFallback(r,"SHADOWESM"+n),e["SHADOWCLOSEESM"+n]&&t.addFallback(r,"SHADOWCLOSEESM"+n));return s++}static PrepareAttributesForMorphTargetsInfluencers(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,t,i){const r=i.NUM_MORPH_INFLUENCERS;if(r>0&&EngineStore.LastCreatedEngine){const s=EngineStore.LastCreatedEngine.getCaps().maxVertexAttribs,n=t.morphTargetManager;if(n!=null&&n.isUsingTextureForTargets)return;const o=n&&n.supportsNormals&&i.NORMAL,l=n&&n.supportsTangents&&i.TANGENT,h=n&&n.supportsUVs&&i.UV1;for(let u=0;u<r;u++)e.push(VertexBuffer.PositionKind+u),o&&e.push(VertexBuffer.NormalKind+u),l&&e.push(VertexBuffer.TangentKind+u),h&&e.push(VertexBuffer.UVKind+"_"+u),e.length>s&&Logger.Error("Cannot add more vertex attributes for mesh "+t.name)}}static PrepareAttributesForBakedVertexAnimation(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(e,t,i,r){i.NUM_BONE_INFLUENCERS>0&&(r.addCPUSkinningFallback(0,t),e.push(VertexBuffer.MatricesIndicesKind),e.push(VertexBuffer.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(VertexBuffer.MatricesIndicesExtraKind),e.push(VertexBuffer.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(VertexBuffer.ColorInstanceKind)}static PushAttributesForInstances(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}static BindLightProperties(e,t,i){e.transferToEffect(t,i+"")}static BindLight(e,t,i,r,s,n=!0){e._bindLight(t,i,r,s,n)}static BindLights(e,t,i,r,s=4){const n=Math.min(t.lightSources.length,s);for(let o=0;o<n;o++){const l=t.lightSources[o];this.BindLight(l,o,e,i,typeof r=="boolean"?r:r.SPECULARTERM,t.receiveShadows)}}static BindFogParameters(e,t,i,r=!1){e.fogEnabled&&t.applyFog&&e.fogMode!==Scene.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),r?(e.fogColor.toLinearSpaceToRef(this._TempFogColor,e.getEngine().useExactSrgbConversions),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))}static BindBonesParameters(e,t,i){if(!(!t||!e)&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const r=e.skeleton;if(r.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const s=r.getTransformMatrixTexture(e);t.setTexture("boneSampler",s),t.setFloat("boneTextureWidth",4*(r.bones.length+1))}else{const s=r.getTransformMatrices(e);s&&(t.setMatrices("mBones",s),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=s.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),MaterialHelper._CopyBonesTransformationMatrices(s,i.previousBones[e.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,t){return t.set(e),t}static BindMorphTargetParameters(e,t){const i=e.morphTargetManager;!e||!i||t.setFloatArray("morphTargetInfluences",i.influences)}static BindLogDepth(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const r=i.activeCamera;r.mode===Camera.ORTHOGRAPHIC_CAMERA&&Logger.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(r.maxZ+1)/Math.LN2))}}}MaterialHelper._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0};MaterialHelper._TempFogColor=Color3.Black();class MaterialStencilState{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){SerializationHelper.Clone(()=>e,this)}serialize(){return SerializationHelper.Serialize(this)}parse(e,t,i){SerializationHelper.Parse(()=>this,e,t,i)}}__decorate([serialize()],MaterialStencilState.prototype,"func",null);__decorate([serialize()],MaterialStencilState.prototype,"funcRef",null);__decorate([serialize()],MaterialStencilState.prototype,"funcMask",null);__decorate([serialize()],MaterialStencilState.prototype,"opStencilFail",null);__decorate([serialize()],MaterialStencilState.prototype,"opDepthFail",null);__decorate([serialize()],MaterialStencilState.prototype,"opStencilDepthPass",null);__decorate([serialize()],MaterialStencilState.prototype,"mask",null);__decorate([serialize()],MaterialStencilState.prototype,"enabled",null);var MaterialPluginEvent;(function(a){a[a.Created=1]="Created",a[a.Disposed=2]="Disposed",a[a.GetDefineNames=4]="GetDefineNames",a[a.PrepareUniformBuffer=8]="PrepareUniformBuffer",a[a.IsReadyForSubMesh=16]="IsReadyForSubMesh",a[a.PrepareDefines=32]="PrepareDefines",a[a.BindForSubMesh=64]="BindForSubMesh",a[a.PrepareEffect=128]="PrepareEffect",a[a.GetAnimatables=256]="GetAnimatables",a[a.GetActiveTextures=512]="GetActiveTextures",a[a.HasTexture=1024]="HasTexture",a[a.FillRenderTargetTextures=2048]="FillRenderTargetTextures",a[a.HasRenderTargetTextures=4096]="HasRenderTargetTextures",a[a.HardBindForSubMesh=8192]="HardBindForSubMesh"})(MaterialPluginEvent||(MaterialPluginEvent={}));class Material{get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,(t===1||e===1)&&this.markAsDirty(Material.MiscDirtyFlag+Material.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(Material.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(Material.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new Observable),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new Observable),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new Observable),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(Material.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(Material.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case Material.WireFrameFillMode:case Material.LineListDrawMode:case Material.LineLoopDrawMode:case Material.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?Material.WireFrameFillMode:Material.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case Material.PointFillMode:case Material.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?Material.PointFillMode:Material.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(Material.MiscDirtyFlag))}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new Observable,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new MaterialStencilState,this._useUBO=!1,this._fillMode=Material.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const r=t||EngineStore.LastCreatedScene;r&&(this._scene=r,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||Tools.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new DrawWrapper(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=Material.ClockWiseSideOrientation:this.sideOrientation=Material.CounterClockWiseSideOrientation,this._uniformBuffer=new UniformBuffer(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),Material.OnEventObservable.notifyObservers(this,MaterialPluginEvent.Created))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const r=t.materialDefines;return r?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===Material.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===Material.MATERIAL_OPAQUE||this._transparencyMode===Material.MATERIAL_ALPHATEST}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const r of i.subMeshes)r.getMaterial()===this&&r.effect&&(r.effect._wasPreviouslyReady=!1,r.effect._wasPreviouslyUsingInstances=null,r.effect._forceRebindOnNextCall=e);e&&this.markAsDirty(Material.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),s=(t??this.sideOrientation)===Material.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,s,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(MaterialPluginEvent.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const r=i.effect;r&&(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),r._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,MaterialHelper.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}if(this.disableColorWrite){const i=this._scene.getEngine();this._cachedColorWriteState=i.getColorWrite(),i.setColorWrite(!1)}if(this.depthFunction!==0){const i=this._scene.getEngine();this._cachedDepthFunctionState=i.getDepthFunction()||0,i.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(MaterialPluginEvent.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(MaterialPluginEvent.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(MaterialPluginEvent.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){const i={};if(this._serializePlugins(i),Material._parsePlugins(i,e,this._scene,t),this.pluginManager)for(const r of this.pluginManager._plugins){const s=e.pluginManager.getPlugin(r.name);r.copyTo(s)}}getBindedMeshes(){if(this.meshMap){const e=new Array;for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}else return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,r){const s=Object.assign({clipPlane:!1,useInstances:!1},i),n=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const l=()=>{if(!this._scene||!this._scene.getEngine())return;const h=n.clipPlane;if(s.clipPlane&&(n.clipPlane=new Plane(0,0,0,1)),this._storeEffectOnSubMeshes){let u=!0,c=null;if(e.subMeshes){const d=new SubMesh(0,0,0,0,0,e,void 0,!1,!1);d.materialDefines&&(d.materialDefines._renderId=-1),this.isReadyForSubMesh(e,d,s.useInstances)||(d.effect&&d.effect.getCompilationError()&&d.effect.allFallbacksProcessed()?c=d.effect.getCompilationError():(u=!1,setTimeout(l,16)))}u&&(this.allowShaderHotSwapping=o,c&&r&&r(c),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=o,t&&t(this)):setTimeout(l,16);s.clipPlane&&(n.clipPlane=h)};l()}forceCompilationAsync(e,t){return new Promise((i,r)=>{this.forceCompilation(e,()=>{i()},t,s=>{r(s)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(Material._DirtyCallbackArray.length=0,e&Material.TextureDirtyFlag&&Material._DirtyCallbackArray.push(Material._TextureDirtyCallBack),e&Material.LightDirtyFlag&&Material._DirtyCallbackArray.push(Material._LightsDirtyCallBack),e&Material.FresnelDirtyFlag&&Material._DirtyCallbackArray.push(Material._FresnelDirtyCallBack),e&Material.AttributesDirtyFlag&&Material._DirtyCallbackArray.push(Material._AttributeDirtyCallBack),e&Material.MiscDirtyFlag&&Material._DirtyCallbackArray.push(Material._MiscDirtyCallBack),e&Material.PrePassDirtyFlag&&Material._DirtyCallbackArray.push(Material._PrePassDirtyCallBack),Material._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(Material._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(i.subMeshes){for(const r of i.subMeshes)if(r.getMaterial(!1)===this)for(const s of r._drawWrappers)!s||!s.defines||!s.defines.markAllAsDirty||this._materialContext===s.materialContext&&e(s.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(Material._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(Material._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(Material._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(Material._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(Material._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(Material._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(Material._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(Material._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(Material._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(Material._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==ScenePerformancePriority.BackwardCompatible){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,i){const r=this.getScene();if(r.stopAnimation(this),r.freeProcessedMaterials(),r.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(MaterialPluginEvent.Disposed,this._eventInfo),this._parentContainer){const s=this._parentContainer.materials.indexOf(this);s>-1&&this._parentContainer.materials.splice(s,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(const s in this.meshMap){const n=this.meshMap[s];n&&(n.material=null,this.releaseVertexArrayObject(n,e))}else{const s=r.meshes;for(const n of s)n.material===this&&!n.sourceMesh&&(n.material=null,this.releaseVertexArrayObject(n,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){if(e.geometry){const i=e.geometry;if(this._storeEffectOnSubMeshes)for(const r of e.subMeshes)i._releaseVertexArrayObject(r.effect),t&&r.effect&&r.effect.dispose();else i._releaseVertexArrayObject(this._drawWrapper.effect)}}serialize(){const e=SerializationHelper.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(const t of this.pluginManager._plugins)e.plugins[t.getClassName()]=t.serialize()}static Parse(e,t,i){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return Logger.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;const s=Tools.Instantiate(e.customType).Parse(e,t,i);return s._loadedUniqueId=e.uniqueId,s}static _parsePlugins(e,t,i,r){var s;if(e.plugins)for(const n in e.plugins){const o=e.plugins[n];let l=(s=t.pluginManager)===null||s===void 0?void 0:s.getPlugin(o.name);if(!l){const h=Tools.Instantiate("BABYLON."+n);h&&(l=new h(t))}l==null||l.parse(o,i,r)}}}Material.TriangleFillMode=0;Material.WireFrameFillMode=1;Material.PointFillMode=2;Material.PointListDrawMode=3;Material.LineListDrawMode=4;Material.LineLoopDrawMode=5;Material.LineStripDrawMode=6;Material.TriangleStripDrawMode=7;Material.TriangleFanDrawMode=8;Material.ClockWiseSideOrientation=0;Material.CounterClockWiseSideOrientation=1;Material.TextureDirtyFlag=1;Material.LightDirtyFlag=2;Material.FresnelDirtyFlag=4;Material.AttributesDirtyFlag=8;Material.MiscDirtyFlag=16;Material.PrePassDirtyFlag=32;Material.AllDirtyFlag=63;Material.MATERIAL_OPAQUE=0;Material.MATERIAL_ALPHATEST=1;Material.MATERIAL_ALPHABLEND=2;Material.MATERIAL_ALPHATESTANDBLEND=3;Material.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0;Material.MATERIAL_NORMALBLENDMETHOD_RNM=1;Material.OnEventObservable=new Observable;Material._AllDirtyCallBack=a=>a.markAllAsDirty();Material._ImageProcessingDirtyCallBack=a=>a.markAsImageProcessingDirty();Material._TextureDirtyCallBack=a=>a.markAsTexturesDirty();Material._FresnelDirtyCallBack=a=>a.markAsFresnelDirty();Material._MiscDirtyCallBack=a=>a.markAsMiscDirty();Material._PrePassDirtyCallBack=a=>a.markAsPrePassDirty();Material._LightsDirtyCallBack=a=>a.markAsLightDirty();Material._AttributeDirtyCallBack=a=>a.markAsAttributesDirty();Material._FresnelAndMiscDirtyCallBack=a=>{Material._FresnelDirtyCallBack(a),Material._MiscDirtyCallBack(a)};Material._TextureAndMiscDirtyCallBack=a=>{Material._TextureDirtyCallBack(a),Material._MiscDirtyCallBack(a)};Material._DirtyCallbackArray=[];Material._RunDirtyCallBacks=a=>{for(const e of Material._DirtyCallbackArray)e(a)};__decorate([serialize()],Material.prototype,"id",void 0);__decorate([serialize()],Material.prototype,"uniqueId",void 0);__decorate([serialize()],Material.prototype,"name",void 0);__decorate([serialize()],Material.prototype,"metadata",void 0);__decorate([serialize()],Material.prototype,"checkReadyOnEveryCall",void 0);__decorate([serialize()],Material.prototype,"checkReadyOnlyOnce",void 0);__decorate([serialize()],Material.prototype,"state",void 0);__decorate([serialize("alpha")],Material.prototype,"_alpha",void 0);__decorate([serialize("backFaceCulling")],Material.prototype,"_backFaceCulling",void 0);__decorate([serialize("cullBackFaces")],Material.prototype,"_cullBackFaces",void 0);__decorate([serialize()],Material.prototype,"sideOrientation",void 0);__decorate([serialize("alphaMode")],Material.prototype,"_alphaMode",void 0);__decorate([serialize()],Material.prototype,"_needDepthPrePass",void 0);__decorate([serialize()],Material.prototype,"disableDepthWrite",void 0);__decorate([serialize()],Material.prototype,"disableColorWrite",void 0);__decorate([serialize()],Material.prototype,"forceDepthWrite",void 0);__decorate([serialize()],Material.prototype,"depthFunction",void 0);__decorate([serialize()],Material.prototype,"separateCullingPass",void 0);__decorate([serialize("fogEnabled")],Material.prototype,"_fogEnabled",void 0);__decorate([serialize()],Material.prototype,"pointSize",void 0);__decorate([serialize()],Material.prototype,"zOffset",void 0);__decorate([serialize()],Material.prototype,"zOffsetUnits",void 0);__decorate([serialize()],Material.prototype,"pointsCloud",null);__decorate([serialize()],Material.prototype,"fillMode",null);__decorate([serialize()],Material.prototype,"transparencyMode",null);class MultiMaterial extends Material{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=new Array,this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);return this._markAllSubMeshesAsTexturesDirty(),s};const i=e.splice;e.splice=(r,s)=>{const n=i.apply(e,[r,s]);return this._markAllSubMeshesAsTexturesDirty(),n}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if(!((t=this.subMaterials[i])===null||t===void 0)&&t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let r=0;r<this.subMaterials.length;r++){const s=this.subMaterials[r];if(s){if(s._storeEffectOnSubMeshes){if(!s.isReadyForSubMesh(e,t,i))return!1;continue}if(!s.isReady(e))return!1}}return!0}clone(e,t){const i=new MultiMaterial(e,this.getScene());for(let r=0;r<this.subMaterials.length;r++){let s=null;const n=this.subMaterials[r];t&&n?s=n.clone(e+"-"+n.name):s=this.subMaterials[r],i.subMaterials.push(s)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,Tags&&(e.tags=Tags.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const r=this.getScene();if(!r)return;if(i)for(let n=0;n<this.subMaterials.length;n++){const o=this.subMaterials[n];o&&o.dispose(e,t)}const s=r.multiMaterials.indexOf(this);s>=0&&r.multiMaterials.splice(s,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new MultiMaterial(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,Tags&&Tags.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(r=>i.subMaterials.push(t.getLastMaterialById(r))),i}}RegisterClass("BABYLON.MultiMaterial",MultiMaterial);class MeshLODLevel{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class _CreationDataStorage{}class _InstanceDataStorage{constructor(){this.visibleInstances={},this.batchCache=new _InstancesBatch,this.batchCacheReplacementModeInFrozenMode=new _InstancesBatch,this.instancesBufferSize=32*16*4}}class _InstancesBatch{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}}class _ThinInstanceDataStorage{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class _InternalMeshDataInfo{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}class Mesh extends AbstractMesh{static _GetDefaultSideOrientation(e){return e||Mesh.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(VertexBuffer.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(VertexBuffer.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new Observable),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new Observable),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new Observable),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new Observable),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new Observable),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){var e;return((e=this._thinInstanceDataStorage.instancesCount)!==null&&e!==void 0?e:0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,t=null,i=null,r=null,s,n=!0){if(super(e,t),this._internalMeshDataInfo=new _InternalMeshDataInfo,this.delayLoadState=0,this.instances=new Array,this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new _InstanceDataStorage,this._thinInstanceDataStorage=new _ThinInstanceDataStorage,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=Mesh.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._onBeforeDraw=(o,l,h)=>{o&&h&&(this._uniformBuffer?this.transferToEffect(l):h.bindOnlyWorldMatrix(l))},r){if(r._geometry&&r._geometry.applyToMesh(this),DeepCopier.DeepCopy(r,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),this._internalMeshDataInfo._source=r,t.useClonedMeshMap&&(r._internalMeshDataInfo.meshMap||(r._internalMeshDataInfo.meshMap={}),r._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=r._originalBuilderSideOrientation,this._creationDataStorage=r._creationDataStorage,r._ranges){const o=r._ranges;for(const l in o)Object.prototype.hasOwnProperty.call(o,l)&&o[l]&&this.createAnimationRange(l,o[l].from,o[l].to)}if(r.metadata&&r.metadata.clone?this.metadata=r.metadata.clone():this.metadata=r.metadata,this._internalMetadata=r._internalMetadata,Tags&&Tags.HasTags(r)&&Tags.AddTagsTo(this,Tags.GetTags(r,!0)),this.setEnabled(r.isEnabled(!1)),this.parent=r.parent,this.setPivotMatrix(r.getPivotMatrix()),this.id=e+"."+r.id,this.material=r.material,!s){const o=r.getDescendants(!0);for(let l=0;l<o.length;l++){const h=o[l];h.clone&&h.clone(e+"."+h.name,this)}}if(r.morphTargetManager&&(this.morphTargetManager=r.morphTargetManager),t.getPhysicsEngine){const o=t.getPhysicsEngine();if(n&&o)if(o.getPluginVersion()===1){const l=o.getImpostorForPhysicsObject(r);l&&(this.physicsImpostor=l.clone(this))}else o.getPluginVersion()===2&&r.physicsBody&&r.physicsBody.clone(this)}for(let o=0;o<t.particleSystems.length;o++){const l=t.particleSystems[o];l.emitter===r&&l.clone(l.name,this)}this.skeleton=r.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}i!==null&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=o=>{o.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new Observable(this._internalMeshDataInfo._onMeshReadyObserverAdded),r&&r.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const r=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.getClassName()==="InstancedMesh"&&r.getClassName()==="Mesh"&&s.sourceMesh===this?s.instantiateHierarchy(r,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:r},i):s.instantiateHierarchy(r,t,i);return r}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const i=this.getIndices(),r=this.getVerticesData(VertexBuffer.PositionKind);r&&i&&(t+=", flat shading: "+(r.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return Logger.Warn("You cannot use a mesh as LOD level twice"),this;const i=new MeshLODLevel(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const r=t._LODLevels[i];if(r.distanceOrScreenCoverage===e)return r.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;const r=t||this.getBoundingInfo().boundingSphere,s=e.mode===Camera.ORTHOGRAPHIC_CAMERA?e.minZ:r.centerWorld.subtract(e.globalPosition).length();let n=s,o=1;if(i._useLODScreenCoverage){const l=e.screenArea;let h=r.radiusWorld*e.minZ/s;h=h*h*Math.PI,n=h/l,o=-1}if(o*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>o*n)return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this;for(let l=0;l<i._LODLevels.length;l++){const h=i._LODLevels[l];if(o*h.distanceOrScreenCoverage<o*n){if(h.mesh){if(h.mesh.delayLoadState===4)return h.mesh._checkDelayState(),this;if(h.mesh.delayLoadState===2)return this;h.mesh._preActivate(),h.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,h.mesh),h.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,r){var s,n;if(!this._geometry)return null;let o=r||(n=(s=this._userInstancedBuffersStorage)===null||s===void 0?void 0:s.vertexBuffers[e])===null||n===void 0?void 0:n.getFloatData(this.instances.length+1,i||t&&this._geometry.meshes.length!==1);return o||(o=this._geometry.getVerticesData(e,t,i)),o}getVertexBuffer(e,t){var i,r;return this._geometry?(r=t||(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e])!==null&&r!==void 0?r:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){var i;return this._geometry?!t&&((i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e])!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,t){var i;if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!t){const r=(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e];if(r)return r.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const i=new Array;return this._delayInfo&&this._delayInfo.forEach(function(r){i.push(r)}),i}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const i in this._userInstancedBuffersStorage.vertexBuffers)t.indexOf(i)===-1&&t.push(i);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){var i,r,s,n,o,l,h;if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;const u=this.getEngine(),c=this.getScene(),d=t||u.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const f=this.material||c.defaultMaterial;if(f){if(f._storeEffectOnSubMeshes)for(const g of this.subMeshes){const p=g.getMaterial();if(p){if(p._storeEffectOnSubMeshes){if(!p.isReadyForSubMesh(this,g,d))return!1}else if(!p.isReady(this,d))return!1}}else if(!f.isReady(this,d))return!1}const _=u.currentRenderPassId;for(const g of this.lightSources){const p=g.getShadowGenerators();if(!p)continue;const m=p.values();for(let E=m.next();E.done!==!0;E=m.next()){const M=E.value;if(M&&(!(!((i=M.getShadowMap())===null||i===void 0)&&i.renderList)||!((r=M.getShadowMap())===null||r===void 0)&&r.renderList&&((n=(s=M.getShadowMap())===null||s===void 0?void 0:s.renderList)===null||n===void 0?void 0:n.indexOf(this))!==-1)){const A=(o=M.getShadowMap().renderPassIds)!==null&&o!==void 0?o:[u.currentRenderPassId];for(let T=0;T<A.length;++T){u.currentRenderPassId=A[T];for(const C of this.subMeshes)if(!M.isReady(C,d,(h=(l=C.getMaterial())===null||l===void 0?void 0:l.needAlphaBlendingForMesh(this))!==null&&h!==void 0?h:!1))return u.currentRenderPassId=_,!1}u.currentRenderPassId=_}}}for(const g of this._internalMeshDataInfo._LODLevels)if(g.mesh&&!g.mesh.isReady(d))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const r=i.length;let s=!1;if(e)s=!0;else for(const n of this.subMeshes){if(n.indexStart+n.indexCount>r){s=!0;break}if(n.verticesStart+n.verticesCount>t){s=!0;break}}if(!s)return this.subMeshes[0]}return this.releaseSubMeshes(),new SubMesh(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,r=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let s=0;s<e&&!(r>=t);s++)SubMesh.CreateFromIndices(0,r,s===e-1?t-r:i,this),r+=i;this.synchronizeInstances()}setVerticesData(e,t,i=!1,r){if(this._geometry)this._geometry.setVerticesData(e,t,i,r);else{const s=new VertexData;s.set(t,e);const n=this.getScene();new Geometry(Geometry.RandomId(),n,s,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=Geometry.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,r){return this._geometry?(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(VertexBuffer.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(VertexBuffer.PositionKind,i,!1,!1),t){const r=this.getIndices(),s=this.getVerticesData(VertexBuffer.NormalKind);if(!s)return this;VertexData.ComputeNormals(i,r,s),this.updateVerticesData(VertexBuffer.NormalKind,s,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;const e=this._geometry,t=this._geometry.copy(Geometry.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{const r=new VertexData;r.indices=e;const s=this.getScene();new Geometry(Geometry.RandomId(),s,r,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,r=!0){if(!this._geometry)return this;const s=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t);let n;if(this._unIndexed)n=null;else switch(this._getRenderingFillMode(i)){case Material.PointFillMode:n=null;break;case Material.WireFrameFillMode:n=e._getLinesIndexBuffer(this.getIndices(),s);break;default:case Material.TriangleFillMode:n=this._geometry.getIndexBuffer();break}return!r||!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,n):this._geometry._bind(t,n,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const s=this.getScene().getEngine();return this._unIndexed||t==Material.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==Material.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),r=i._isInIntermediateRendering(),s=r?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,n=this._instanceDataStorage.batchCache;if(n.mustReturn=!1,n.renderSelf[e]=t||!s&&this.isEnabled()&&this.isVisible,n.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const o=this._instanceDataStorage.visibleInstances,l=i.getRenderId(),h=r?o.intermediateDefaultRenderId:o.defaultRenderId;n.visibleInstances[e]=o[l],!n.visibleInstances[e]&&h&&(n.visibleInstances[e]=o[h])}return n.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&n.visibleInstances[e]!==null&&n.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=n,n}_renderWithInstances(e,t,i,r,s){var n;const o=i.visibleInstances[e._id],l=o?o.length:0,h=this._instanceDataStorage,u=h.instancesBufferSize;let c=h.instancesBuffer,d=h.instancesPreviousBuffer;const _=(l+1)*16*4;for(;h.instancesBufferSize<_;)h.instancesBufferSize*=2;(!h.instancesData||u!=h.instancesBufferSize)&&(h.instancesData=new Float32Array(h.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!h.instancesPreviousData||u!=h.instancesBufferSize)&&(h.instancesPreviousData=new Float32Array(h.instancesBufferSize/4));let g=0,p=0;const m=i.renderSelf[e._id],E=!c||u!==h.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!h.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!h.isFrozen||E)){const M=this.getWorldMatrix();if(m&&(this._scene.needsPreviousWorldMatrices&&(h.masterMeshPreviousWorldMatrix?(h.masterMeshPreviousWorldMatrix.copyToArray(h.instancesPreviousData,g),h.masterMeshPreviousWorldMatrix.copyFrom(M)):(h.masterMeshPreviousWorldMatrix=M.clone(),h.masterMeshPreviousWorldMatrix.copyToArray(h.instancesPreviousData,g))),M.copyToArray(h.instancesData,g),g+=16,p++),o){if(Mesh.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&(!((n=e.getMaterial())===null||n===void 0)&&n.needAlphaBlendingForMesh(e.getRenderingMesh()))){const x=this._scene.activeCamera.globalPosition;for(let A=0;A<o.length;A++){const T=o[A];T._distanceToCamera=Vector3.Distance(T.getBoundingInfo().boundingSphere.centerWorld,x)}o.sort((A,T)=>A._distanceToCamera>T._distanceToCamera?-1:A._distanceToCamera<T._distanceToCamera?1:0)}for(let x=0;x<o.length;x++){const A=o[x],T=A.getWorldMatrix();T.copyToArray(h.instancesData,g),this._scene.needsPreviousWorldMatrices&&(A._previousWorldMatrix?(A._previousWorldMatrix.copyToArray(h.instancesPreviousData,g),A._previousWorldMatrix.copyFrom(T)):(A._previousWorldMatrix=T.clone(),A._previousWorldMatrix.copyToArray(h.instancesPreviousData,g))),g+=16,p++}}}else p=(m?1:0)+l;return E?(c&&c.dispose(),d&&d.dispose(),c=new Buffer(s,h.instancesData,!0,16,!1,!0),h.instancesBuffer=c,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=c.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=c.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=c.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=c.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new Buffer(s,h.instancesPreviousData,!0,16,!1,!0),h.instancesPreviousBuffer=d,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(c.updateDirectly(h.instancesData,0,p),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&d.updateDirectly(h.instancesPreviousData,0,p)),this._processInstancedBuffers(o,m),this.getScene()._activeIndices.addCount(e.indexCount*p,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,r,t),this._draw(e,t,p),this._scene.needsPreviousWorldMatrices&&!E&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&d.updateDirectly(h.instancesData,0,p),s.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,r){var s,n;const o=(n=(s=this._thinInstanceDataStorage)===null||s===void 0?void 0:s.instancesCount)!==null&&n!==void 0?n:0;this.getScene()._activeIndices.addCount(e.indexCount*o,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,o),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,o):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,r,s,n,o,l){const h=this.getScene(),u=h.getEngine();if(r=this._getRenderingFillMode(r),n&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,r,i,u),this;if(n)this._renderWithInstances(t,r,s,i,u);else{u._currentDrawContext&&(u._currentDrawContext.useInstancing=!1);let c=0;s.renderSelf[t._id]&&(o&&o(!1,e.getWorldMatrix(),l),c++,this._draw(t,r,this._instanceDataStorage.overridenInstanceCount));const d=s.visibleInstances[t._id];if(d){const f=d.length;c+=f;for(let _=0;_<f;_++){const p=d[_].getWorldMatrix();o&&o(!0,p,l),this._draw(t,r)}}h._activeIndices.addCount(t.indexCount*c,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}render(e,t,i){var r,s,n;const o=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const l=this._getInstancesRenderList(e._id,!!i);if(l.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const h=o.getEngine();let u=0,c=null;this.ignoreCameraMaxZ&&o.activeCamera&&!o._isInIntermediateRendering()&&(u=o.activeCamera.maxZ,c=o.activeCamera,o.activeCamera.maxZ=0,o.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const d=e.getRenderingMesh(),f=l.hardwareInstancedRendering[e._id]||d.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,_=this._instanceDataStorage,g=e.getMaterial();if(!g)return c&&(c.maxZ=u,o.updateTransformMatrix(!0)),this;if(!_.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==g){if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,e,f))return c&&(c.maxZ=u,o.updateTransformMatrix(!0)),this}else if(!g.isReady(this,f))return c&&(c.maxZ=u,o.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=g}else if(g._storeEffectOnSubMeshes&&!(!((r=e.effect)===null||r===void 0)&&r._wasPreviouslyReady)||!g._storeEffectOnSubMeshes&&!(!((s=g.getEffect())===null||s===void 0)&&s._wasPreviouslyReady))return c&&(c.maxZ=u,o.updateTransformMatrix(!0)),this;t&&h.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let p;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?p=e._drawWrapper:p=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const m=(n=p==null?void 0:p.effect)!==null&&n!==void 0?n:null;for(const b of o._beforeRenderingMeshStage)b.action(this,e,l,m);if(!p||!m)return c&&(c.maxZ=u,o.updateTransformMatrix(!0)),this;const E=i||this;let M;if(!_.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){const b=E._getWorldMatrixDeterminant();M=this.overrideMaterialSideOrientation,M==null&&(M=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),b<0&&(M=M===Material.ClockWiseSideOrientation?Material.CounterClockWiseSideOrientation:Material.ClockWiseSideOrientation),_.sideOrientation=M}else M=_.sideOrientation;const x=this._internalMeshDataInfo._effectiveMaterial._preBind(p,M);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&h.setDepthWrite(!0);const A=this._internalMeshDataInfo._effectiveMaterial,T=A.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,m,T,!1);const C=E.getWorldMatrix();A._storeEffectOnSubMeshes?A.bindForSubMesh(C,this,e):A.bind(C,this),!A.backFaceCulling&&A.separateCullingPass&&(h.setState(!0,A.zOffset,!1,!x,A.cullBackFaces,A.stencil,A.zOffsetUnits),this._processRendering(this,e,m,T,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),h.setState(!0,A.zOffset,!1,x,A.cullBackFaces,A.stencil,A.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,m,T,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const b of o._afterRenderingMeshStage)b.action(this,e,l,m);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),c&&(c.maxZ=u,o.updateTransformMatrix(!0)),o.performancePriority===ScenePerformancePriority.Aggressive&&!_.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(VertexBuffer.MatricesWeightsKind)&&(this.isVerticesDataPresent(VertexBuffer.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(VertexBuffer.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const r=e[i]+e[i+1]+e[i+2]+e[i+3];if(r===0)e[i]=1;else{const s=1/r;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s}}this.setVerticesData(VertexBuffer.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(VertexBuffer.MatricesWeightsExtraKind),t=this.getVerticesData(VertexBuffer.MatricesWeightsKind),i=t.length;for(let r=0;r<i;r+=4){let s=t[r]+t[r+1]+t[r+2]+t[r+3];if(s+=e[r]+e[r+1]+e[r+2]+e[r+3],s===0)t[r]=1;else{const n=1/s;t[r]*=n,t[r+1]*=n,t[r+2]*=n,t[r+3]*=n,e[r]*=n,e[r+1]*=n,e[r+2]*=n,e[r+3]*=n}}this.setVerticesData(VertexBuffer.MatricesWeightsKind,t),this.setVerticesData(VertexBuffer.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(VertexBuffer.MatricesWeightsExtraKind),t=this.getVerticesData(VertexBuffer.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let r=0,s=0,n=0,o=0;const l=e===null?4:8,h=new Array;for(let p=0;p<=l;p++)h[p]=0;const u=.001;for(let p=0;p<i;p+=4){let m=t[p],E=m,M=E===0?0:1;for(let x=1;x<l;x++){const A=x<4?t[p+x]:e[p+x-4];A>m&&r++,A!==0&&M++,E+=A,m=A}if(h[M]++,M>n&&(n=M),E===0)s++;else{const x=1/E;let A=0;for(let T=0;T<l;T++)T<4?A+=Math.abs(t[p+T]-t[p+T]*x):A+=Math.abs(e[p+T-4]-e[p+T-4]*x);A>u&&o++}}const c=this.skeleton.bones.length,d=this.getVerticesData(VertexBuffer.MatricesIndicesKind),f=this.getVerticesData(VertexBuffer.MatricesIndicesExtraKind);let _=0;for(let p=0;p<i;p+=4)for(let m=0;m<l;m++){const E=m<4?d[p+m]:f[p+m-4];(E>=c||E<0)&&_++}const g="Number of Weights = "+i/4+`
Maximum influences = `+n+`
Missing Weights = `+s+`
Not Sorted = `+r+`
Not Normalized = `+o+`
WeightCounts = [`+h+`]
Number of bones = `+c+`
Bad Bone Indices = `+_;return{skinned:!0,valid:s===0&&o===0&&_===0,report:g}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return Tools.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(r=>{r.refreshBoundingInfo(),r._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const r=this.getScene().multiMaterials;for(i=r.length-1;i>-1;i--)if(r[i].id===e)return this.material=r[i],this;return this}getAnimatables(){const e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(VertexBuffer.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(VertexBuffer.PositionKind);const r=Vector3.Zero();let s;for(s=0;s<i.length;s+=3)Vector3.TransformCoordinatesFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).toArray(i,s);if(this.setVerticesData(VertexBuffer.PositionKind,i,this.getVertexBuffer(VertexBuffer.PositionKind).isUpdatable()),this.isVerticesDataPresent(VertexBuffer.NormalKind)){for(i=this.getVerticesData(VertexBuffer.NormalKind),s=0;s<i.length;s+=3)Vector3.TransformNormalFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).normalize().toArray(i,s);this.setVerticesData(VertexBuffer.NormalKind,i,this.getVertexBuffer(VertexBuffer.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,i,r=!0){return new Mesh(e,this.getScene(),t,this,i,r)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const r in i.meshMap){const s=i.meshMap[r];s&&(s._internalMeshDataInfo._source=null,i.meshMap[r]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const r=this.getScene().meshes;for(const s of r){const n=s;n._internalMeshDataInfo&&n._internalMeshDataInfo._source&&n._internalMeshDataInfo._source===this&&(n._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,r,s,n,o=!1){const l=this.getScene(),h=u=>{const c=u.width,d=u.height,_=this.getEngine().createCanvas(c,d).getContext("2d");_.drawImage(u,0,0);const g=_.getImageData(0,0,c,d).data;this.applyDisplacementMapFromBuffer(g,c,d,t,i,s,n,o),r&&r(this)};return Tools.LoadImage(e,h,()=>{},l.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,r,s,n,o,l=!1){if(!this.isVerticesDataPresent(VertexBuffer.PositionKind)||!this.isVerticesDataPresent(VertexBuffer.NormalKind)||!this.isVerticesDataPresent(VertexBuffer.UVKind))return Logger.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const h=this.getVerticesData(VertexBuffer.PositionKind,!0,!0),u=this.getVerticesData(VertexBuffer.NormalKind),c=this.getVerticesData(VertexBuffer.UVKind);let d=Vector3.Zero();const f=Vector3.Zero(),_=Vector2.Zero();n=n||Vector2.Zero(),o=o||new Vector2(1,1);for(let g=0;g<h.length;g+=3){Vector3.FromArrayToRef(h,g,d),Vector3.FromArrayToRef(u,g,f),Vector2.FromArrayToRef(c,g/3*2,_);const p=Math.abs(_.x*o.x+n.x%1)*(t-1)%t|0,m=Math.abs(_.y*o.y+n.y%1)*(i-1)%i|0,E=(p+m*t)*4,M=e[E]/255,x=e[E+1]/255,A=e[E+2]/255,T=M*.3+x*.59+A*.11;f.normalize(),f.scaleInPlace(r+(s-r)*T),d=d.add(f),d.toArray(h,g)}return VertexData.ComputeNormals(h,this.getIndices(),u),l?(this.setVerticesData(VertexBuffer.PositionKind,h),this.setVerticesData(VertexBuffer.NormalKind,u),this.setVerticesData(VertexBuffer.UVKind,c)):(this.updateVerticesData(VertexBuffer.PositionKind,h),this.updateVerticesData(VertexBuffer.NormalKind,u)),this}convertToFlatShadedMesh(){const e=this.getVerticesDataKinds(),t={},i={},r={};let s=!1,n,o;for(n=0;n<e.length;n++){o=e[n];const p=this.getVertexBuffer(o),m=p.getData();if(!((m instanceof Array||m instanceof Float32Array)&&m.length===0)){if(o===VertexBuffer.NormalKind){s=p.isUpdatable(),e.splice(n,1),n--;continue}t[o]=p,i[o]=this.getVerticesData(o),r[o]=[]}}const l=this.subMeshes.slice(0),h=this.getIndices(),u=this.getTotalIndices();let c;for(c=0;c<u;c++){const p=h[c];for(n=0;n<e.length;n++){if(o=e[n],!t[o])continue;const m=t[o].getStrideSize();for(let E=0;E<m;E++)r[o].push(i[o][p*m+E])}}const d=[],f=r[VertexBuffer.PositionKind],_=this.getScene().useRightHandedSystem;let g;for(_?g=this.overrideMaterialSideOrientation===1:g=this.overrideMaterialSideOrientation===0,c=0;c<u;c+=3){h[c]=c,h[c+1]=c+1,h[c+2]=c+2;const p=Vector3.FromArray(f,c*3),m=Vector3.FromArray(f,(c+1)*3),E=Vector3.FromArray(f,(c+2)*3),M=p.subtract(m),x=E.subtract(m),A=Vector3.Normalize(Vector3.Cross(M,x));g&&A.scaleInPlace(-1);for(let T=0;T<3;T++)d.push(A.x),d.push(A.y),d.push(A.z)}for(this.setIndices(h),this.setVerticesData(VertexBuffer.NormalKind,d,s),n=0;n<e.length;n++)o=e[n],r[o]&&this.setVerticesData(o,r[o],t[o].isUpdatable());this.releaseSubMeshes();for(let p=0;p<l.length;p++){const m=l[p];SubMesh.AddToMesh(m.materialIndex,m.indexStart,m.indexCount,m.indexStart,m.indexCount,this)}return this.synchronizeInstances(),this}convertToUnIndexedMesh(){const e=this.getVerticesDataKinds(),t={},i={},r={};let s,n;for(s=0;s<e.length;s++){n=e[s];const c=this.getVertexBuffer(n);t[n]=c,i[n]=t[n].getData(),r[n]=[]}const o=this.subMeshes.slice(0),l=this.getIndices(),h=this.getTotalIndices();let u;for(u=0;u<h;u++){const c=l[u];for(s=0;s<e.length;s++){n=e[s];const d=t[n].getStrideSize();for(let f=0;f<d;f++)r[n].push(i[n][c*d+f])}}for(u=0;u<h;u+=3)l[u]=u,l[u+1]=u+1,l[u+2]=u+2;for(this.setIndices(l),s=0;s<e.length;s++)n=e[s],this.setVerticesData(n,r[n],t[n].isUpdatable(),t[n].getStrideSize());this.releaseSubMeshes();for(let c=0;c<o.length;c++){const d=o[c];SubMesh.AddToMesh(d.materialIndex,d.indexStart,d.indexCount,d.indexStart,d.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this}flipFaces(e=!1){const t=VertexData.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(VertexBuffer.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let r;for(i=0;i<t.indices.length;i+=3)r=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=r}return t.applyToMesh(this,this.isVertexBufferUpdatable(VertexBuffer.PositionKind)),this}increaseVertices(e=1){const t=VertexData.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,r=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,s=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,n=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!i||!r)Logger.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=i,t.positions=r,s&&(t.uvs=s),n&&(t.normals=n);const o=e+1,l=new Array;for(let A=0;A<o+1;A++)l[A]=new Array;let h,u;const c=new Vector3(0,0,0),d=new Vector3(0,0,0),f=new Vector2(0,0),_=new Array,g=new Array,p=new Array;let m,E=r.length,M;s&&(M=s.length);let x;n&&(x=n.length);for(let A=0;A<i.length;A+=3){g[0]=i[A],g[1]=i[A+1],g[2]=i[A+2];for(let T=0;T<3;T++)if(h=g[T],u=g[(T+1)%3],p[h]===void 0&&p[u]===void 0?(p[h]=new Array,p[u]=new Array):(p[h]===void 0&&(p[h]=new Array),p[u]===void 0&&(p[u]=new Array)),p[h][u]===void 0&&p[u][h]===void 0){p[h][u]=[],c.x=(r[3*u]-r[3*h])/o,c.y=(r[3*u+1]-r[3*h+1])/o,c.z=(r[3*u+2]-r[3*h+2])/o,n&&(d.x=(n[3*u]-n[3*h])/o,d.y=(n[3*u+1]-n[3*h+1])/o,d.z=(n[3*u+2]-n[3*h+2])/o),s&&(f.x=(s[2*u]-s[2*h])/o,f.y=(s[2*u+1]-s[2*h+1])/o),p[h][u].push(h);for(let C=1;C<o;C++)p[h][u].push(r.length/3),r[E++]=r[3*h]+C*c.x,r[E++]=r[3*h+1]+C*c.y,r[E++]=r[3*h+2]+C*c.z,n&&(n[x++]=n[3*h]+C*d.x,n[x++]=n[3*h+1]+C*d.y,n[x++]=n[3*h+2]+C*d.z),s&&(s[M++]=s[2*h]+C*f.x,s[M++]=s[2*h+1]+C*f.y);p[h][u].push(u),p[u][h]=new Array,m=p[h][u].length;for(let C=0;C<m;C++)p[u][h][C]=p[h][u][m-1-C]}l[0][0]=i[A],l[1][0]=p[i[A]][i[A+1]][1],l[1][1]=p[i[A]][i[A+2]][1];for(let T=2;T<o;T++){l[T][0]=p[i[A]][i[A+1]][T],l[T][T]=p[i[A]][i[A+2]][T],c.x=(r[3*l[T][T]]-r[3*l[T][0]])/T,c.y=(r[3*l[T][T]+1]-r[3*l[T][0]+1])/T,c.z=(r[3*l[T][T]+2]-r[3*l[T][0]+2])/T,n&&(d.x=(n[3*l[T][T]]-n[3*l[T][0]])/T,d.y=(n[3*l[T][T]+1]-n[3*l[T][0]+1])/T,d.z=(n[3*l[T][T]+2]-n[3*l[T][0]+2])/T),s&&(f.x=(s[2*l[T][T]]-s[2*l[T][0]])/T,f.y=(s[2*l[T][T]+1]-s[2*l[T][0]+1])/T);for(let C=1;C<T;C++)l[T][C]=r.length/3,r[E++]=r[3*l[T][0]]+C*c.x,r[E++]=r[3*l[T][0]+1]+C*c.y,r[E++]=r[3*l[T][0]+2]+C*c.z,n&&(n[x++]=n[3*l[T][0]]+C*d.x,n[x++]=n[3*l[T][0]+1]+C*d.y,n[x++]=n[3*l[T][0]+2]+C*d.z),s&&(s[M++]=s[2*l[T][0]]+C*f.x,s[M++]=s[2*l[T][0]+1]+C*f.y)}l[o]=p[i[A+1]][i[A+2]],_.push(l[0][0],l[1][0],l[1][1]);for(let T=1;T<o;T++){let C;for(C=0;C<T;C++)_.push(l[T][C],l[T+1][C],l[T+1][C+1]),_.push(l[T][C],l[T+1][C+1],l[T][C+1]);_.push(l[T][C],l[T+1][C],l[T+1][C+1])}}t.indices=_,t.applyToMesh(this,this.isVertexBufferUpdatable(VertexBuffer.PositionKind))}}forceSharedVertices(){const e=VertexData.ExtractFromMesh(this),t=e.uvs,i=e.indices,r=e.positions,s=e.colors,n=e.matricesIndices,o=e.matricesWeights,l=e.matricesIndicesExtra,h=e.matricesWeightsExtra;if(i===void 0||r===void 0||i===null||r===null)Logger.Warn("VertexData contains empty entries");else{const u=new Array,c=new Array,d=new Array,f=new Array,_=new Array,g=new Array,p=new Array,m=new Array;let E=new Array,M=0;const x={};let A,T;for(let b=0;b<i.length;b+=3){T=[i[b],i[b+1],i[b+2]],E=new Array;for(let y=0;y<3;y++){E[y]="";for(let S=0;S<3;S++)Math.abs(r[3*T[y]+S])<1e-8&&(r[3*T[y]+S]=0),E[y]+=r[3*T[y]+S]+"|"}if(!(E[0]==E[1]||E[0]==E[2]||E[1]==E[2]))for(let y=0;y<3;y++){if(A=x[E[y]],A===void 0){x[E[y]]=M,A=M++;for(let S=0;S<3;S++)u.push(r[3*T[y]+S]);if(s!=null)for(let S=0;S<4;S++)f.push(s[4*T[y]+S]);if(t!=null)for(let S=0;S<2;S++)d.push(t[2*T[y]+S]);if(n!=null)for(let S=0;S<4;S++)_.push(n[4*T[y]+S]);if(o!=null)for(let S=0;S<4;S++)g.push(o[4*T[y]+S]);if(l!=null)for(let S=0;S<4;S++)p.push(l[4*T[y]+S]);if(h!=null)for(let S=0;S<4;S++)m.push(h[4*T[y]+S])}c.push(A)}}const C=new Array;VertexData.ComputeNormals(u,c,C),e.positions=u,e.indices=c,e.normals=C,t!=null&&(e.uvs=d),s!=null&&(e.colors=f),n!=null&&(e.matricesIndices=_),o!=null&&(e.matricesWeights=g),l!=null&&(e.matricesIndicesExtra=p),o!=null&&(e.matricesWeightsExtra=m),e.applyToMesh(this,this.isVertexBufferUpdatable(VertexBuffer.PositionKind))}}static _instancedMeshFactory(e,t){throw _WarnImport("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw _WarnImport("PhysicsImpostor")}createInstance(e){return Mesh._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(VertexBuffer.PositionKind);if(!i||!t)return this;const r=new Array;for(let n=0;n<i.length;n=n+3)r.push(Vector3.FromArray(i,n));const s=new Array;return AsyncLoop.SyncAsyncForLoop(r.length,40,n=>{const o=r.length-1-n,l=r[o];for(let h=0;h<o;++h){const u=r[h];if(l.equals(u)){s[o]=h;break}}},()=>{for(let o=0;o<t.length;++o)t[o]=s[t[o]]||t[o];const n=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=n,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),Tags&&Tags.HasTags(this)&&(e.tags=Tags.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){const r=this.subMeshes[i];e.subMeshes.push({materialIndex:r.materialIndex,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(SceneComponentConstants.NAME_PHYSICSENGINE)){const i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){const r=this.instances[i];if(r.doNotSerialize)continue;const s={name:r.name,id:r.id,isEnabled:r.isEnabled(!1),isVisible:r.isVisible,isPickable:r.isPickable,checkCollisions:r.checkCollisions,position:r.position.asArray(),scaling:r.scaling.asArray()};if(r.parent&&r.parent._serializeAsParent(s),r.rotationQuaternion?s.rotationQuaternion=r.rotationQuaternion.asArray():r.rotation&&(s.rotation=r.rotation.asArray()),this.getScene()._getComponent(SceneComponentConstants.NAME_PHYSICSENGINE)){const n=r.getPhysicsImpostor();n&&(s.physicsMass=n.getParam("mass"),s.physicsFriction=n.getParam("friction"),s.physicsRestitution=n.getParam("mass"),s.physicsImpostor=n.type)}r.metadata&&(s.metadata=r.metadata),r.actionManager&&(s.actions=r.actionManager.serialize(r.name)),e.instances.push(s),SerializationHelper.AppendSerializedAnimations(r,s),s.ranges=r.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const i={data:{},sizes:{},strides:{}};for(const r in this._userThinInstanceBuffersStorage.data)i.data[r]=Array.from(this._userThinInstanceBuffersStorage.data[r]),i.sizes[r]=this._userThinInstanceBuffersStorage.sizes[r],i.strides[r]=this._userThinInstanceBuffersStorage.strides[r];e.thinInstances.userThinInstance=i}return SerializationHelper.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){Logger.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),r=i.getPositions();if(!r){Logger.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(VertexBuffer.PositionKind+t,r,!1,3);const s=i.getNormals();s&&this.geometry.setVerticesData(VertexBuffer.NormalKind+t,s,!1,3);const n=i.getTangents();n&&this.geometry.setVerticesData(VertexBuffer.TangentKind+t,n,!1,3);const o=i.getUVs();o&&this.geometry.setVerticesData(VertexBuffer.UVKind+"_"+t,o,!1,2)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(VertexBuffer.PositionKind+t);)this.geometry.removeVerticesData(VertexBuffer.PositionKind+t),this.geometry.isVerticesDataPresent(VertexBuffer.NormalKind+t)&&this.geometry.removeVerticesData(VertexBuffer.NormalKind+t),this.geometry.isVerticesDataPresent(VertexBuffer.TangentKind+t)&&this.geometry.removeVerticesData(VertexBuffer.TangentKind+t),this.geometry.isVerticesDataPresent(VertexBuffer.UVKind+t)&&this.geometry.removeVerticesData(VertexBuffer.UVKind+"_"+t),t++}}static Parse(e,t,i){let r;if(e.type&&e.type==="LinesMesh"?r=Mesh._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?r=Mesh._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?r=Mesh._GoldbergMeshParser(e,t):e.type&&e.type==="GreasedLineMesh"?r=Mesh._GreasedLineMeshParser(e,t):r=new Mesh(e.name,t),r.id=e.id,r._waitingParsedUniqueId=e.uniqueId,Tags&&Tags.AddTagsTo(r,e.tags),r.position=Vector3.FromArray(e.position),e.metadata!==void 0&&(r.metadata=e.metadata),e.rotationQuaternion?r.rotationQuaternion=Quaternion.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=Vector3.FromArray(e.rotation)),r.scaling=Vector3.FromArray(e.scaling),e.localMatrix?r.setPreTransformMatrix(Matrix.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(Matrix.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(r.applyFog=e.applyFog),e.pickable!==void 0&&(r.isPickable=e.pickable),e.alphaIndex!==void 0&&(r.alphaIndex=e.alphaIndex),r.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(r.billboardMode=e.billboardMode),e.visibility!==void 0&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,e.isBlocker!==void 0&&(r.isBlocker=e.isBlocker),r._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(r._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(r._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(r.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(r.overlayColor=Color3.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(r.renderOverlay=e.renderOverlay),r.isUnIndexed=!!e.isUnIndexed,r.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r.buildBoundingInfo(Vector3.FromArray(e.boundingBoxMinimum),Vector3.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(r._binaryInfo=e._binaryInfo),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(VertexBuffer.UVKind),e.hasUVs2&&r._delayInfo.push(VertexBuffer.UV2Kind),e.hasUVs3&&r._delayInfo.push(VertexBuffer.UV3Kind),e.hasUVs4&&r._delayInfo.push(VertexBuffer.UV4Kind),e.hasUVs5&&r._delayInfo.push(VertexBuffer.UV5Kind),e.hasUVs6&&r._delayInfo.push(VertexBuffer.UV6Kind),e.hasColors&&r._delayInfo.push(VertexBuffer.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(VertexBuffer.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(VertexBuffer.MatricesWeightsKind),r._delayLoadingFunction=Geometry._ImportGeometry,SceneLoaderFlags.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):Geometry._ImportGeometry(e,r),e.materialUniqueId?r._waitingMaterialId=e.materialUniqueId:e.materialId&&(r._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(r.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),e.skeletonId!==void 0&&e.skeletonId!==null&&(r.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(r.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let s=0;s<e.animations.length;s++){const n=e.animations[s],o=GetClass("BABYLON.Animation");o&&r.animations.push(o.Parse(n))}Node.ParseAnimationRanges(r,e,t)}if(e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?r.layerMask=Math.abs(parseInt(e.layerMask)):r.layerMask=268435455,e.physicsImpostor&&Mesh._PhysicsImpostorParser(t,r,e),e.lodMeshIds&&(r._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let s=0;s<e.instances.length;s++){const n=e.instances[s],o=r.createInstance(n.name);if(n.id&&(o.id=n.id),Tags&&(n.tags?Tags.AddTagsTo(o,n.tags):Tags.AddTagsTo(o,e.tags)),o.position=Vector3.FromArray(n.position),n.metadata!==void 0&&(o.metadata=n.metadata),n.parentId!==void 0&&(o._waitingParentId=n.parentId),n.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=n.parentInstanceIndex),n.isEnabled!==void 0&&n.isEnabled!==null&&o.setEnabled(n.isEnabled),n.isVisible!==void 0&&n.isVisible!==null&&(o.isVisible=n.isVisible),n.isPickable!==void 0&&n.isPickable!==null&&(o.isPickable=n.isPickable),n.rotationQuaternion?o.rotationQuaternion=Quaternion.FromArray(n.rotationQuaternion):n.rotation&&(o.rotation=Vector3.FromArray(n.rotation)),o.scaling=Vector3.FromArray(n.scaling),n.checkCollisions!=null&&n.checkCollisions!=null&&(o.checkCollisions=n.checkCollisions),n.pickable!=null&&n.pickable!=null&&(o.isPickable=n.pickable),n.showBoundingBox!=null&&n.showBoundingBox!=null&&(o.showBoundingBox=n.showBoundingBox),n.showSubMeshesBoundingBox!=null&&n.showSubMeshesBoundingBox!=null&&(o.showSubMeshesBoundingBox=n.showSubMeshesBoundingBox),n.alphaIndex!=null&&n.showSubMeshesBoundingBox!=null&&(o.alphaIndex=n.alphaIndex),n.physicsImpostor&&Mesh._PhysicsImpostorParser(t,o,n),n.actions!==void 0&&(o._waitingData.actions=n.actions),n.animations){for(let l=0;l<n.animations.length;l++){const h=n.animations[l],u=GetClass("BABYLON.Animation");u&&o.animations.push(u.Parse(h))}Node.ParseAnimationRanges(o,n,t),n.autoAnimate&&t.beginAnimation(o,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1)}}if(e.thinInstances){const s=e.thinInstances;if(r.thinInstanceEnablePicking=!!s.enablePicking,s.matrixData?(r.thinInstanceSetBuffer("matrix",new Float32Array(s.matrixData),16,!1),r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,r._thinInstanceDataStorage.instancesCount=s.instancesCount):r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,e.thinInstances.userThinInstance){const n=e.thinInstances.userThinInstance;for(const o in n.data)r.thinInstanceSetBuffer(o,new Float32Array(n.data[o]),n.strides[o],!1),r._userThinInstanceBuffersStorage.sizes[o]=n.sizes[o]}}return r}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(VertexBuffer.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(VertexBuffer.PositionKind)||this.setVerticesData(VertexBuffer.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(VertexBuffer.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(VertexBuffer.NormalKind)||this.setVerticesData(VertexBuffer.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(VertexBuffer.PositionKind))return this;if(!this.isVerticesDataPresent(VertexBuffer.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(VertexBuffer.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(VertexBuffer.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const m=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=m}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(VertexBuffer.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let s=this.getVerticesData(VertexBuffer.NormalKind);if(t){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}const n=this.getVerticesData(VertexBuffer.MatricesIndicesKind),o=this.getVerticesData(VertexBuffer.MatricesWeightsKind);if(!o||!n)return this;const l=this.numBoneInfluencers>4,h=l?this.getVerticesData(VertexBuffer.MatricesIndicesExtraKind):null,u=l?this.getVerticesData(VertexBuffer.MatricesWeightsExtraKind):null,c=e.getTransformMatrices(this),d=Vector3.Zero(),f=new Matrix,_=new Matrix;let g=0,p;for(let m=0;m<r.length;m+=3,g+=4){let E;for(p=0;p<4;p++)E=o[g+p],E>0&&(Matrix.FromFloat32ArrayToRefScaled(c,Math.floor(n[g+p]*16),E,_),f.addToSelf(_));if(l)for(p=0;p<4;p++)E=u[g+p],E>0&&(Matrix.FromFloat32ArrayToRefScaled(c,Math.floor(h[g+p]*16),E,_),f.addToSelf(_));Vector3.TransformCoordinatesFromFloatsToRef(i._sourcePositions[m],i._sourcePositions[m+1],i._sourcePositions[m+2],f,d),d.toArray(r,m),t&&(Vector3.TransformNormalFromFloatsToRef(i._sourceNormals[m],i._sourceNormals[m+1],i._sourceNormals[m+2],f,d),d.toArray(s,m)),f.reset()}return this.updateVerticesData(VertexBuffer.PositionKind,r),t&&this.updateVerticesData(VertexBuffer.NormalKind,s),this}static MinMax(e){let t=null,i=null;return e.forEach(function(r){const n=r.getBoundingInfo().boundingBox;!t||!i?(t=n.minimumWorld,i=n.maximumWorld):(t.minimizeInPlace(n.minimumWorld),i.maximizeInPlace(n.maximumWorld))}),!t||!i?{min:Vector3.Zero(),max:Vector3.Zero()}:{min:t,max:i}}static Center(e){const t=e instanceof Array?Mesh.MinMax(e):e;return Vector3.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,r,s,n){return runCoroutineSync(Mesh._MergeMeshesCoroutine(e,t,i,r,s,n,!1))}static MergeMeshesAsync(e,t=!0,i,r,s,n){return runCoroutineAsync(Mesh._MergeMeshesCoroutine(e,t,i,r,s,n,!0),createYieldingScheduler())}static*_MergeMeshesCoroutine(e,t=!0,i,r,s,n,o){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!i){let C=0;for(l=0;l<e.length;l++)if(C+=e[l].getTotalVertices(),C>=65536)return Logger.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}n&&(s=!1);const h=new Array,u=new Array,c=new Array,d=e[0].overrideMaterialSideOrientation;for(l=0;l<e.length;l++){const C=e[l];if(C.isAnInstance)return Logger.Warn("Cannot merge instance meshes."),null;if(d!==C.overrideMaterialSideOrientation)return Logger.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(s&&c.push(C.getTotalIndices()),n)if(C.material){const b=C.material;if(b instanceof MultiMaterial){for(let y=0;y<b.subMaterials.length;y++)h.indexOf(b.subMaterials[y])<0&&h.push(b.subMaterials[y]);for(let y=0;y<C.subMeshes.length;y++)u.push(h.indexOf(b.subMaterials[C.subMeshes[y].materialIndex])),c.push(C.subMeshes[y].indexCount)}else{h.indexOf(b)<0&&h.push(b);for(let y=0;y<C.subMeshes.length;y++)u.push(h.indexOf(b)),c.push(C.subMeshes[y].indexCount)}}else for(let b=0;b<C.subMeshes.length;b++)u.push(0),c.push(C.subMeshes[b].indexCount)}const f=e[0],_=C=>{const b=C.computeWorldMatrix(!0);return{vertexData:VertexData.ExtractFromMesh(C,!1,!1),transform:b}},{vertexData:g,transform:p}=_(f);o&&(yield);const m=new Array(e.length-1);for(let C=1;C<e.length;C++)m[C-1]=_(e[C]),o&&(yield);const E=g._mergeCoroutine(p,m,i,o,!t);let M=E.next();for(;!M.done;)o&&(yield),M=E.next();const x=M.value;r||(r=new Mesh(f.name+"_merged",f.getScene()));const A=x._applyToCoroutine(r,void 0,o);let T=A.next();for(;!T.done;)o&&(yield),T=A.next();if(r.checkCollisions=f.checkCollisions,r.overrideMaterialSideOrientation=f.overrideMaterialSideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(s||n){r.releaseSubMeshes(),l=0;let C=0;for(;l<c.length;)SubMesh.CreateFromIndices(0,C,c[l],r,void 0,!1),C+=c[l],l++;for(const b of r.subMeshes)b.refreshBoundingInfo();r.computeWorldMatrix(!0)}if(n){const C=new MultiMaterial(f.name+"_merged",f.getScene());C.subMaterials=h;for(let b=0;b<r.subMeshes.length;b++)r.subMeshes[b].materialIndex=u[b];r.material=C}else r.material=f.material;return r}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){const i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===Material.CounterClockWiseSideOrientation}_getRenderingFillMode(e){var t;const i=this.getScene();return i.forcePointsCloud?Material.PointFillMode:i.forceWireframe?Material.WireFrameFillMode:(t=this.overrideRenderingFillMode)!==null&&t!==void 0?t:e}}Mesh.FRONTSIDE=VertexData.FRONTSIDE;Mesh.BACKSIDE=VertexData.BACKSIDE;Mesh.DOUBLESIDE=VertexData.DOUBLESIDE;Mesh.DEFAULTSIDE=VertexData.DEFAULTSIDE;Mesh.NO_CAP=0;Mesh.CAP_START=1;Mesh.CAP_END=2;Mesh.CAP_ALL=3;Mesh.NO_FLIP=0;Mesh.FLIP_TILE=1;Mesh.ROTATE_TILE=2;Mesh.FLIP_ROW=3;Mesh.ROTATE_ROW=4;Mesh.FLIP_N_ROTATE_TILE=5;Mesh.FLIP_N_ROTATE_ROW=6;Mesh.CENTER=0;Mesh.LEFT=1;Mesh.RIGHT=2;Mesh.TOP=3;Mesh.BOTTOM=4;Mesh.INSTANCEDMESH_SORT_TRANSPARENT=!1;Mesh._GroundMeshParser=(a,e)=>{throw _WarnImport("GroundMesh")};Mesh._GoldbergMeshParser=(a,e)=>{throw _WarnImport("GoldbergMesh")};Mesh._LinesMeshParser=(a,e)=>{throw _WarnImport("LinesMesh")};Mesh._GreasedLineMeshParser=(a,e)=>{throw _WarnImport("GreasedLineMesh")};RegisterClass("BABYLON.Mesh",Mesh);Mesh.prototype.setMaterialByID=function(a){return this.setMaterialById(a)};Mesh.CreateDisc=Mesh.CreateDisc||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateBox=Mesh.CreateBox||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateSphere=Mesh.CreateSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateCylinder=Mesh.CreateCylinder||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateTorusKnot=Mesh.CreateTorusKnot||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateTorus=Mesh.CreateTorus||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreatePlane=Mesh.CreatePlane||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateGround=Mesh.CreateGround||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateTiledGround=Mesh.CreateTiledGround||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateGroundFromHeightMap=Mesh.CreateGroundFromHeightMap||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateTube=Mesh.CreateTube||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreatePolyhedron=Mesh.CreatePolyhedron||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateIcoSphere=Mesh.CreateIcoSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateDecal=Mesh.CreateDecal||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.CreateCapsule=Mesh.CreateCapsule||(()=>{throw new Error("Import MeshBuilder to populate this function")});Mesh.ExtendToGoldberg=Mesh.ExtendToGoldberg||(()=>{throw new Error("Import MeshBuilder to populate this function")});function CreateRibbonVertexData(a){let e=a.pathArray;const t=a.closeArray||!1,i=a.closePath||!1,r=a.invertUV||!1,s=Math.floor(e[0].length/2);let n=a.offset||s;n=n>s?s:Math.floor(n);const o=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE,l=a.uvs,h=a.colors,u=[],c=[],d=[],f=[],_=[],g=[],p=[],m=[];let E;const M=[],x=[];let A,T,C;if(e.length<2){const Y=[],W=[];for(T=0;T<e[0].length-n;T++)Y.push(e[0][T]),W.push(e[0][T+n]);e=[Y,W]}let b=0;const y=i?1:0;let S,R;E=e[0].length;let P,N;for(A=0;A<e.length;A++){for(p[A]=0,_[A]=[0],S=e[A],R=S.length,E=E<R?E:R,C=0;C<R;)u.push(S[C].x,S[C].y,S[C].z),C>0&&(P=S[C].subtract(S[C-1]).length(),N=P+p[A],_[A].push(N),p[A]=N),C++;i&&(C--,u.push(S[0].x,S[0].y,S[0].z),P=S[C].subtract(S[0]).length(),N=P+p[A],_[A].push(N),p[A]=N),M[A]=R+y,x[A]=b,b+=R+y}let V,F,U=null,H=null;for(T=0;T<E+y;T++){for(m[T]=0,g[T]=[0],A=0;A<e.length-1;A++)V=e[A],F=e[A+1],T===E?(U=V[0],H=F[0]):(U=V[T],H=F[T]),P=H.subtract(U).length(),N=P+m[T],g[T].push(N),m[T]=N;t&&H&&U&&(V=e[A],F=e[0],T===E&&(H=F[0]),P=H.subtract(U).length(),N=P+m[T],m[T]=N)}let X,w;if(l)for(A=0;A<l.length;A++)f.push(l[A].x,CompatibilityOptions.UseOpenGLOrientationForUV?1-l[A].y:l[A].y);else for(A=0;A<e.length;A++)for(T=0;T<E+y;T++)X=p[A]!=0?_[A][T]/p[A]:0,w=m[T]!=0?g[T][A]/m[T]:0,r?f.push(w,X):f.push(X,CompatibilityOptions.UseOpenGLOrientationForUV?1-w:w);A=0;let O=0,v=M[A]-1,D=M[A+1]-1,B=v<D?v:D,k=x[1]-x[0];const j=t?M.length:M.length-1;for(;O<=B&&A<j;)c.push(O,O+k,O+1),c.push(O+k+1,O+1,O+k),O+=1,O===B&&(A++,A===M.length-1?(k=x[0]-x[A],v=M[A]-1,D=M[0]-1):(k=x[A+1]-x[A],v=M[A]-1,D=M[A+1]-1),O=x[A],B=v<D?v+O:D+O);if(VertexData.ComputeNormals(u,c,d),i){let Y=0,W=0;for(A=0;A<e.length;A++)Y=x[A]*3,A+1<e.length?W=(x[A+1]-1)*3:W=d.length-3,d[Y]=(d[Y]+d[W])*.5,d[Y+1]=(d[Y+1]+d[W+1])*.5,d[Y+2]=(d[Y+2]+d[W+2])*.5,d[W]=d[Y],d[W+1]=d[Y+1],d[W+2]=d[Y+2]}VertexData._ComputeSides(o,u,c,d,f,a.frontUVs,a.backUVs);let K=null;if(h){K=new Float32Array(h.length*4);for(let Y=0;Y<h.length;Y++)K[Y*4]=h[Y].r,K[Y*4+1]=h[Y].g,K[Y*4+2]=h[Y].b,K[Y*4+3]=h[Y].a}const L=new VertexData,G=new Float32Array(u),Z=new Float32Array(d),z=new Float32Array(f);return L.indices=c,L.positions=G,L.normals=Z,L.uvs=z,K&&L.set(K,VertexBuffer.ColorKind),i&&(L._idx=x),L}function CreateRibbon(a,e,t=null){const i=e.pathArray,r=e.closeArray,s=e.closePath,n=Mesh._GetDefaultSideOrientation(e.sideOrientation),o=e.instance,l=e.updatable;if(o){const h=TmpVectors.Vector3[0].setAll(Number.MAX_VALUE),u=TmpVectors.Vector3[1].setAll(-Number.MAX_VALUE),c=f=>{let _=i[0].length;const g=o;let p=0;const m=g._originalBuilderSideOrientation===Mesh.DOUBLESIDE?2:1;for(let E=1;E<=m;++E)for(let M=0;M<i.length;++M){const x=i[M],A=x.length;_=_<A?_:A;for(let T=0;T<_;++T){const C=x[T];f[p]=C.x,f[p+1]=C.y,f[p+2]=C.z,h.minimizeInPlaceFromFloats(C.x,C.y,C.z),u.maximizeInPlaceFromFloats(C.x,C.y,C.z),p+=3}if(g._creationDataStorage&&g._creationDataStorage.closePath){const T=x[0];f[p]=T.x,f[p+1]=T.y,f[p+2]=T.z,p+=3}}},d=o.getVerticesData(VertexBuffer.PositionKind);if(c(d),o.hasBoundingInfo?o.getBoundingInfo().reConstruct(h,u,o._worldMatrix):o.buildBoundingInfo(h,u,o._worldMatrix),o.updateVerticesData(VertexBuffer.PositionKind,d,!1,!1),e.colors){const f=o.getVerticesData(VertexBuffer.ColorKind);for(let _=0,g=0;_<e.colors.length;_++,g+=4){const p=e.colors[_];f[g]=p.r,f[g+1]=p.g,f[g+2]=p.b,f[g+3]=p.a}o.updateVerticesData(VertexBuffer.ColorKind,f,!1,!1)}if(e.uvs){const f=o.getVerticesData(VertexBuffer.UVKind);for(let _=0;_<e.uvs.length;_++)f[_*2]=e.uvs[_].x,f[_*2+1]=CompatibilityOptions.UseOpenGLOrientationForUV?1-e.uvs[_].y:e.uvs[_].y;o.updateVerticesData(VertexBuffer.UVKind,f,!1,!1)}if(!o.areNormalsFrozen||o.isFacetDataEnabled){const f=o.getIndices(),_=o.getVerticesData(VertexBuffer.NormalKind),g=o.isFacetDataEnabled?o.getFacetDataParameters():null;if(VertexData.ComputeNormals(d,f,_,g),o._creationDataStorage&&o._creationDataStorage.closePath){let p=0,m=0;for(let E=0;E<i.length;E++)p=o._creationDataStorage.idx[E]*3,E+1<i.length?m=(o._creationDataStorage.idx[E+1]-1)*3:m=_.length-3,_[p]=(_[p]+_[m])*.5,_[p+1]=(_[p+1]+_[m+1])*.5,_[p+2]=(_[p+2]+_[m+2])*.5,_[m]=_[p],_[m+1]=_[p+1],_[m+2]=_[p+2]}o.areNormalsFrozen||o.updateVerticesData(VertexBuffer.NormalKind,_,!1,!1)}return o}else{const h=new Mesh(a,t);h._originalBuilderSideOrientation=n,h._creationDataStorage=new _CreationDataStorage;const u=CreateRibbonVertexData(e);return s&&(h._creationDataStorage.idx=u._idx),h._creationDataStorage.closePath=s,h._creationDataStorage.closeArray=r,u.applyToMesh(h,l),h}}VertexData.CreateRibbon=CreateRibbonVertexData;Mesh.CreateRibbon=(a,e,t=!1,i,r,s,n=!1,o,l)=>CreateRibbon(a,{pathArray:e,closeArray:t,closePath:i,offset:r,updatable:n,sideOrientation:o,instance:l},s);function CreateDiscVertexData(a){const e=new Array,t=new Array,i=new Array,r=new Array,s=a.radius||.5,n=a.tessellation||64,o=a.arc&&(a.arc<=0||a.arc>1)?1:a.arc||1,l=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE;e.push(0,0,0),r.push(.5,.5);const h=Math.PI*2*o,u=o===1?h/n:h/(n-1);let c=0;for(let _=0;_<n;_++){const g=Math.cos(c),p=Math.sin(c),m=(g+1)/2,E=(1-p)/2;e.push(s*g,s*p,0),r.push(m,CompatibilityOptions.UseOpenGLOrientationForUV?1-E:E),c+=u}o===1&&(e.push(e[3],e[4],e[5]),r.push(r[2],CompatibilityOptions.UseOpenGLOrientationForUV?1-r[3]:r[3]));const d=e.length/3;for(let _=1;_<d-1;_++)t.push(_+1,0,_);VertexData.ComputeNormals(e,t,i),VertexData._ComputeSides(l,e,t,i,r,a.frontUVs,a.backUVs);const f=new VertexData;return f.indices=t,f.positions=e,f.normals=i,f.uvs=r,f}function CreateDisc(a,e={},t=null){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreateDiscVertexData(e).applyToMesh(i,e.updatable),i}VertexData.CreateDisc=CreateDiscVertexData;Mesh.CreateDisc=(a,e,t,i=null,r,s)=>CreateDisc(a,{radius:e,tessellation:t,sideOrientation:s,updatable:r},i);function CreateBoxVertexData(a){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],r=[];let s=[];const n=a.width||a.size||1,o=a.height||a.size||1,l=a.depth||a.size||1,h=a.wrap||!1;let u=a.topBaseAt===void 0?1:a.topBaseAt,c=a.bottomBaseAt===void 0?0:a.bottomBaseAt;u=(u+4)%4,c=(c+4)%4;const d=[2,0,3,1],f=[2,0,1,3];let _=d[u],g=f[c],p=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(h){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],p=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let C=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],b=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const y=[17,18,19,16],S=[22,23,20,21];for(;_>0;)C.unshift(C.pop()),y.unshift(y.pop()),_--;for(;g>0;)b.unshift(b.pop()),S.unshift(S.pop()),g--;C=C.flat(),b=b.flat(),p=p.concat(C).concat(b),t.push(y[0],y[2],y[3],y[0],y[1],y[2]),t.push(S[0],S[2],S[3],S[0],S[1],S[2])}const m=[n/2,o/2,l/2];s=p.reduce((C,b,y)=>C.concat(b*m[y%3]),[]);const E=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE,M=a.faceUV||new Array(6),x=a.faceColors,A=[];for(let C=0;C<6;C++)M[C]===void 0&&(M[C]=new Vector4(0,0,1,1)),x&&x[C]===void 0&&(x[C]=new Color4(1,1,1,1));for(let C=0;C<6;C++)if(r.push(M[C].z,CompatibilityOptions.UseOpenGLOrientationForUV?1-M[C].w:M[C].w),r.push(M[C].x,CompatibilityOptions.UseOpenGLOrientationForUV?1-M[C].w:M[C].w),r.push(M[C].x,CompatibilityOptions.UseOpenGLOrientationForUV?1-M[C].y:M[C].y),r.push(M[C].z,CompatibilityOptions.UseOpenGLOrientationForUV?1-M[C].y:M[C].y),x)for(let b=0;b<4;b++)A.push(x[C].r,x[C].g,x[C].b,x[C].a);VertexData._ComputeSides(E,s,t,i,r,a.frontUVs,a.backUVs);const T=new VertexData;if(T.indices=t,T.positions=s,T.normals=i,T.uvs=r,x){const C=E===VertexData.DOUBLESIDE?A.concat(A):A;T.colors=C}return T}function CreateBox(a,e={},t=null){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreateBoxVertexData(e).applyToMesh(i,e.updatable),i}VertexData.CreateBox=CreateBoxVertexData;Mesh.CreateBox=(a,e,t=null,i,r)=>CreateBox(a,{size:e,sideOrientation:r,updatable:i},t);function CreateTiledPlaneVertexData(a){const e=a.pattern||Mesh.NO_FLIP,t=a.tileWidth||a.tileSize||1,i=a.tileHeight||a.tileSize||1,r=a.alignHorizontal||0,s=a.alignVertical||0,n=a.width||a.size||1,o=Math.floor(n/t);let l=n-o*t;const h=a.height||a.size||1,u=Math.floor(h/i);let c=h-u*i;const d=t*o/2,f=i*u/2;let _=0,g=0,p=0,m=0,E=0,M=0;if(l>0||c>0){switch(p=-d,m=-f,E=d,M=f,r){case Mesh.CENTER:l/=2,p-=l,E+=l;break;case Mesh.LEFT:E+=l,_=-l/2;break;case Mesh.RIGHT:p-=l,_=l/2;break}switch(s){case Mesh.CENTER:c/=2,m-=c,M+=c;break;case Mesh.BOTTOM:M+=c,g=-c/2;break;case Mesh.TOP:m-=c,g=c/2;break}}const x=[],A=[],T=[];T[0]=[0,0,1,0,1,1,0,1],T[1]=[0,0,1,0,1,1,0,1],(e===Mesh.ROTATE_TILE||e===Mesh.ROTATE_ROW)&&(T[1]=[1,1,0,1,0,0,1,0]),(e===Mesh.FLIP_TILE||e===Mesh.FLIP_ROW)&&(T[1]=[1,0,0,0,0,1,1,1]),(e===Mesh.FLIP_N_ROTATE_TILE||e===Mesh.FLIP_N_ROTATE_ROW)&&(T[1]=[0,1,1,1,1,0,0,0]);let C=[];const b=[],y=[];let S=0;for(let V=0;V<u;V++)for(let F=0;F<o;F++)x.push(-d+F*t+_,-f+V*i+g,0),x.push(-d+(F+1)*t+_,-f+V*i+g,0),x.push(-d+(F+1)*t+_,-f+(V+1)*i+g,0),x.push(-d+F*t+_,-f+(V+1)*i+g,0),y.push(S,S+1,S+3,S+1,S+2,S+3),e===Mesh.FLIP_TILE||e===Mesh.ROTATE_TILE||e===Mesh.FLIP_N_ROTATE_TILE?C=C.concat(T[(F%2+V%2)%2]):e===Mesh.FLIP_ROW||e===Mesh.ROTATE_ROW||e===Mesh.FLIP_N_ROTATE_ROW?C=C.concat(T[V%2]):C=C.concat(T[0]),b.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),S+=4;if(l>0||c>0){const V=c>0&&(s===Mesh.CENTER||s===Mesh.TOP),F=c>0&&(s===Mesh.CENTER||s===Mesh.BOTTOM),U=l>0&&(r===Mesh.CENTER||r===Mesh.RIGHT),H=l>0&&(r===Mesh.CENTER||r===Mesh.LEFT);let X=[],w,O,v,D;if(V&&U&&(x.push(p+_,m+g,0),x.push(-d+_,m+g,0),x.push(-d+_,m+c+g,0),x.push(p+_,m+c+g,0),y.push(S,S+1,S+3,S+1,S+2,S+3),S+=4,w=1-l/t,O=1-c/i,v=1,D=1,X=[w,O,v,O,v,D,w,D],e===Mesh.ROTATE_ROW&&(X=[1-w,1-O,1-v,1-O,1-v,1-D,1-w,1-D]),e===Mesh.FLIP_ROW&&(X=[1-w,O,1-v,O,1-v,D,1-w,D]),e===Mesh.FLIP_N_ROTATE_ROW&&(X=[w,1-O,v,1-O,v,1-D,w,1-D]),C=C.concat(X),b.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),V&&H&&(x.push(d+_,m+g,0),x.push(E+_,m+g,0),x.push(E+_,m+c+g,0),x.push(d+_,m+c+g,0),y.push(S,S+1,S+3,S+1,S+2,S+3),S+=4,w=0,O=1-c/i,v=l/t,D=1,X=[w,O,v,O,v,D,w,D],(e===Mesh.ROTATE_ROW||e===Mesh.ROTATE_TILE&&o%2===0)&&(X=[1-w,1-O,1-v,1-O,1-v,1-D,1-w,1-D]),(e===Mesh.FLIP_ROW||e===Mesh.FLIP_TILE&&o%2===0)&&(X=[1-w,O,1-v,O,1-v,D,1-w,D]),(e===Mesh.FLIP_N_ROTATE_ROW||e===Mesh.FLIP_N_ROTATE_TILE&&o%2===0)&&(X=[w,1-O,v,1-O,v,1-D,w,1-D]),C=C.concat(X),b.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),F&&U&&(x.push(p+_,f+g,0),x.push(-d+_,f+g,0),x.push(-d+_,M+g,0),x.push(p+_,M+g,0),y.push(S,S+1,S+3,S+1,S+2,S+3),S+=4,w=1-l/t,O=0,v=1,D=c/i,X=[w,O,v,O,v,D,w,D],(e===Mesh.ROTATE_ROW&&u%2===1||e===Mesh.ROTATE_TILE&&u%1===0)&&(X=[1-w,1-O,1-v,1-O,1-v,1-D,1-w,1-D]),(e===Mesh.FLIP_ROW&&u%2===1||e===Mesh.FLIP_TILE&&u%2===0)&&(X=[1-w,O,1-v,O,1-v,D,1-w,D]),(e===Mesh.FLIP_N_ROTATE_ROW&&u%2===1||e===Mesh.FLIP_N_ROTATE_TILE&&u%2===0)&&(X=[w,1-O,v,1-O,v,1-D,w,1-D]),C=C.concat(X),b.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),F&&H&&(x.push(d+_,f+g,0),x.push(E+_,f+g,0),x.push(E+_,M+g,0),x.push(d+_,M+g,0),y.push(S,S+1,S+3,S+1,S+2,S+3),S+=4,w=0,O=0,v=l/t,D=c/i,X=[w,O,v,O,v,D,w,D],(e===Mesh.ROTATE_ROW&&u%2===1||e===Mesh.ROTATE_TILE&&(u+o)%2===1)&&(X=[1-w,1-O,1-v,1-O,1-v,1-D,1-w,1-D]),(e===Mesh.FLIP_ROW&&u%2===1||e===Mesh.FLIP_TILE&&(u+o)%2===1)&&(X=[1-w,O,1-v,O,1-v,D,1-w,D]),(e===Mesh.FLIP_N_ROTATE_ROW&&u%2===1||e===Mesh.FLIP_N_ROTATE_TILE&&(u+o)%2===1)&&(X=[w,1-O,v,1-O,v,1-D,w,1-D]),C=C.concat(X),b.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),V){const B=[];w=0,O=1-c/i,v=1,D=1,B[0]=[w,O,v,O,v,D,w,D],B[1]=[w,O,v,O,v,D,w,D],(e===Mesh.ROTATE_TILE||e===Mesh.ROTATE_ROW)&&(B[1]=[1-w,1-O,1-v,1-O,1-v,1-D,1-w,1-D]),(e===Mesh.FLIP_TILE||e===Mesh.FLIP_ROW)&&(B[1]=[1-w,O,1-v,O,1-v,D,1-w,D]),(e===Mesh.FLIP_N_ROTATE_TILE||e===Mesh.FLIP_N_ROTATE_ROW)&&(B[1]=[w,1-O,v,1-O,v,1-D,w,1-D]);for(let k=0;k<o;k++)x.push(-d+k*t+_,m+g,0),x.push(-d+(k+1)*t+_,m+g,0),x.push(-d+(k+1)*t+_,m+c+g,0),x.push(-d+k*t+_,m+c+g,0),y.push(S,S+1,S+3,S+1,S+2,S+3),S+=4,e===Mesh.FLIP_TILE||e===Mesh.ROTATE_TILE||e===Mesh.FLIP_N_ROTATE_TILE?C=C.concat(B[(k+1)%2]):e===Mesh.FLIP_ROW||e===Mesh.ROTATE_ROW||e===Mesh.FLIP_N_ROTATE_ROW?C=C.concat(B[1]):C=C.concat(B[0]),b.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(F){const B=[];w=0,O=0,v=1,D=c/i,B[0]=[w,O,v,O,v,D,w,D],B[1]=[w,O,v,O,v,D,w,D],(e===Mesh.ROTATE_TILE||e===Mesh.ROTATE_ROW)&&(B[1]=[1-w,1-O,1-v,1-O,1-v,1-D,1-w,1-D]),(e===Mesh.FLIP_TILE||e===Mesh.FLIP_ROW)&&(B[1]=[1-w,O,1-v,O,1-v,D,1-w,D]),(e===Mesh.FLIP_N_ROTATE_TILE||e===Mesh.FLIP_N_ROTATE_ROW)&&(B[1]=[w,1-O,v,1-O,v,1-D,w,1-D]);for(let k=0;k<o;k++)x.push(-d+k*t+_,M-c+g,0),x.push(-d+(k+1)*t+_,M-c+g,0),x.push(-d+(k+1)*t+_,M+g,0),x.push(-d+k*t+_,M+g,0),y.push(S,S+1,S+3,S+1,S+2,S+3),S+=4,e===Mesh.FLIP_TILE||e===Mesh.ROTATE_TILE||e===Mesh.FLIP_N_ROTATE_TILE?C=C.concat(B[(k+u)%2]):e===Mesh.FLIP_ROW||e===Mesh.ROTATE_ROW||e===Mesh.FLIP_N_ROTATE_ROW?C=C.concat(B[u%2]):C=C.concat(B[0]),b.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(U){const B=[];w=1-l/t,O=0,v=1,D=1,B[0]=[w,O,v,O,v,D,w,D],B[1]=[w,O,v,O,v,D,w,D],(e===Mesh.ROTATE_TILE||e===Mesh.ROTATE_ROW)&&(B[1]=[1-w,1-O,1-v,1-O,1-v,1-D,1-w,1-D]),(e===Mesh.FLIP_TILE||e===Mesh.FLIP_ROW)&&(B[1]=[1-w,O,1-v,O,1-v,D,1-w,D]),(e===Mesh.FLIP_N_ROTATE_TILE||e===Mesh.FLIP_N_ROTATE_ROW)&&(B[1]=[w,1-O,v,1-O,v,1-D,w,1-D]);for(let k=0;k<u;k++)x.push(p+_,-f+k*i+g,0),x.push(p+l+_,-f+k*i+g,0),x.push(p+l+_,-f+(k+1)*i+g,0),x.push(p+_,-f+(k+1)*i+g,0),y.push(S,S+1,S+3,S+1,S+2,S+3),S+=4,e===Mesh.FLIP_TILE||e===Mesh.ROTATE_TILE||e===Mesh.FLIP_N_ROTATE_TILE?C=C.concat(B[(k+1)%2]):e===Mesh.FLIP_ROW||e===Mesh.ROTATE_ROW||e===Mesh.FLIP_N_ROTATE_ROW?C=C.concat(B[k%2]):C=C.concat(B[0]),b.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(H){const B=[];w=0,O=0,v=l/i,D=1,B[0]=[w,O,v,O,v,D,w,D],B[1]=[w,O,v,O,v,D,w,D],(e===Mesh.ROTATE_TILE||e===Mesh.ROTATE_ROW)&&(B[1]=[1-w,1-O,1-v,1-O,1-v,1-D,1-w,1-D]),(e===Mesh.FLIP_TILE||e===Mesh.FLIP_ROW)&&(B[1]=[1-w,O,1-v,O,1-v,D,1-w,D]),(e===Mesh.FLIP_N_ROTATE_TILE||e===Mesh.FLIP_N_ROTATE_ROW)&&(B[1]=[w,1-O,v,1-O,v,1-D,w,1-D]);for(let k=0;k<u;k++)x.push(E-l+_,-f+k*i+g,0),x.push(E+_,-f+k*i+g,0),x.push(E+_,-f+(k+1)*i+g,0),x.push(E-l+_,-f+(k+1)*i+g,0),y.push(S,S+1,S+3,S+1,S+2,S+3),S+=4,e===Mesh.FLIP_TILE||e===Mesh.ROTATE_TILE||e===Mesh.FLIP_N_ROTATE_TILE?C=C.concat(B[(k+o)%2]):e===Mesh.FLIP_ROW||e===Mesh.ROTATE_ROW||e===Mesh.FLIP_N_ROTATE_ROW?C=C.concat(B[k%2]):C=C.concat(B[0]),b.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}const R=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE;VertexData._ComputeSides(R,x,y,A,C,a.frontUVs,a.backUVs);const P=new VertexData;P.indices=y,P.positions=x,P.normals=A,P.uvs=C;const N=R===VertexData.DOUBLESIDE?b.concat(b):b;return P.colors=N,P}function CreateTiledPlane(a,e,t=null){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreateTiledPlaneVertexData(e).applyToMesh(i,e.updatable),i}VertexData.CreateTiledPlane=CreateTiledPlaneVertexData;function CreateTiledBoxVertexData(a){const t=a.faceUV||new Array(6),i=a.faceColors,r=a.pattern||Mesh.NO_FLIP,s=a.width||a.size||1,n=a.height||a.size||1,o=a.depth||a.size||1,l=a.tileWidth||a.tileSize||1,h=a.tileHeight||a.tileSize||1,u=a.alignHorizontal||0,c=a.alignVertical||0,d=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE;for(let v=0;v<6;v++)t[v]===void 0&&(t[v]=new Vector4(0,0,1,1)),i&&i[v]===void 0&&(i[v]=new Color4(1,1,1,1));const f=s/2,_=n/2,g=o/2,p=[];for(let v=0;v<2;v++)p[v]=CreateTiledPlaneVertexData({pattern:r,tileWidth:l,tileHeight:h,width:s,height:n,alignVertical:c,alignHorizontal:u,sideOrientation:d});for(let v=2;v<4;v++)p[v]=CreateTiledPlaneVertexData({pattern:r,tileWidth:l,tileHeight:h,width:o,height:n,alignVertical:c,alignHorizontal:u,sideOrientation:d});let m=c;c===Mesh.BOTTOM?m=Mesh.TOP:c===Mesh.TOP&&(m=Mesh.BOTTOM);for(let v=4;v<6;v++)p[v]=CreateTiledPlaneVertexData({pattern:r,tileWidth:l,tileHeight:h,width:s,height:o,alignVertical:m,alignHorizontal:u,sideOrientation:d});let E=[],M=[],x=[],A=[];const T=[],C=[],b=[],y=[];let S=0,R=0;for(let v=0;v<6;v++){const D=p[v].positions.length;C[v]=[],b[v]=[];for(let B=0;B<D/3;B++)C[v].push(new Vector3(p[v].positions[3*B],p[v].positions[3*B+1],p[v].positions[3*B+2])),b[v].push(new Vector3(p[v].normals[3*B],p[v].normals[3*B+1],p[v].normals[3*B+2]));S=p[v].uvs.length,y[v]=[];for(let B=0;B<S;B+=2)y[v][B]=t[v].x+(t[v].z-t[v].x)*p[v].uvs[B],y[v][B+1]=t[v].y+(t[v].w-t[v].y)*p[v].uvs[B+1],CompatibilityOptions.UseOpenGLOrientationForUV&&(y[v][B+1]=1-y[v][B+1]);if(x=x.concat(y[v]),A=A.concat(p[v].indices.map(B=>B+R)),R+=C[v].length,i)for(let B=0;B<4;B++)T.push(i[v].r,i[v].g,i[v].b,i[v].a)}const P=new Vector3(0,0,g),N=Matrix.RotationY(Math.PI);E=C[0].map(v=>Vector3.TransformNormal(v,N).add(P)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[]),M=b[0].map(v=>Vector3.TransformNormal(v,N)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[]),E=E.concat(C[1].map(v=>v.subtract(P)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[])),M=M.concat(b[1].map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[]));const V=new Vector3(f,0,0),F=Matrix.RotationY(-Math.PI/2);E=E.concat(C[2].map(v=>Vector3.TransformNormal(v,F).add(V)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[])),M=M.concat(b[2].map(v=>Vector3.TransformNormal(v,F)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[]));const U=Matrix.RotationY(Math.PI/2);E=E.concat(C[3].map(v=>Vector3.TransformNormal(v,U).subtract(V)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[])),M=M.concat(b[3].map(v=>Vector3.TransformNormal(v,U)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[]));const H=new Vector3(0,_,0),X=Matrix.RotationX(Math.PI/2);E=E.concat(C[4].map(v=>Vector3.TransformNormal(v,X).add(H)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[])),M=M.concat(b[4].map(v=>Vector3.TransformNormal(v,X)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[]));const w=Matrix.RotationX(-Math.PI/2);E=E.concat(C[5].map(v=>Vector3.TransformNormal(v,w).subtract(H)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[])),M=M.concat(b[5].map(v=>Vector3.TransformNormal(v,w)).map(v=>[v.x,v.y,v.z]).reduce((v,D)=>v.concat(D),[])),VertexData._ComputeSides(d,E,A,M,x);const O=new VertexData;if(O.indices=A,O.positions=E,O.normals=M,O.uvs=x,i){const v=d===VertexData.DOUBLESIDE?T.concat(T):T;O.colors=v}return O}function CreateTiledBox(a,e,t=null){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreateTiledBoxVertexData(e).applyToMesh(i,e.updatable),i}VertexData.CreateTiledBox=CreateTiledBoxVertexData;function CreateSphereVertexData(a){const e=a.segments||32,t=a.diameterX||a.diameter||1,i=a.diameterY||a.diameter||1,r=a.diameterZ||a.diameter||1,s=a.arc&&(a.arc<=0||a.arc>1)?1:a.arc||1,n=a.slice&&a.slice<=0?1:a.slice||1,o=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE,l=!!a.dedupTopBottomIndices,h=new Vector3(t/2,i/2,r/2),u=2+e,c=2*u,d=[],f=[],_=[],g=[];for(let m=0;m<=u;m++){const E=m/u,M=E*Math.PI*n;for(let x=0;x<=c;x++){const A=x/c,T=A*Math.PI*2*s,C=Matrix.RotationZ(-M),b=Matrix.RotationY(T),y=Vector3.TransformCoordinates(Vector3.Up(),C),S=Vector3.TransformCoordinates(y,b),R=S.multiply(h),P=S.divide(h).normalize();f.push(R.x,R.y,R.z),_.push(P.x,P.y,P.z),g.push(A,CompatibilityOptions.UseOpenGLOrientationForUV?1-E:E)}if(m>0){const x=f.length/3;for(let A=x-2*(c+1);A+c+2<x;A++)l?(m>1&&(d.push(A),d.push(A+1),d.push(A+c+1)),(m<u||n<1)&&(d.push(A+c+1),d.push(A+1),d.push(A+c+2))):(d.push(A),d.push(A+1),d.push(A+c+1),d.push(A+c+1),d.push(A+1),d.push(A+c+2))}}VertexData._ComputeSides(o,f,d,_,g,a.frontUVs,a.backUVs);const p=new VertexData;return p.indices=d,p.positions=f,p.normals=_,p.uvs=g,p}function CreateSphere(a,e={},t=null){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreateSphereVertexData(e).applyToMesh(i,e.updatable),i}VertexData.CreateSphere=CreateSphereVertexData;Mesh.CreateSphere=(a,e,t,i,r,s)=>CreateSphere(a,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:s,updatable:r},i);function CreateCylinderVertexData(a){const e=a.height||2;let t=a.diameterTop===0?0:a.diameterTop||a.diameter||1,i=a.diameterBottom===0?0:a.diameterBottom||a.diameter||1;t=t||1e-5,i=i||1e-5;const r=a.tessellation||24,s=a.subdivisions||1,n=!!a.hasRings,o=!!a.enclose,l=a.cap===0?0:a.cap||Mesh.CAP_ALL,h=a.arc&&(a.arc<=0||a.arc>1)?1:a.arc||1,u=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE,c=a.faceUV||new Array(3),d=a.faceColors,f=h!==1&&o?2:0,_=n?s:1,g=2+(1+f)*_;let p;for(p=0;p<g;p++)d&&d[p]===void 0&&(d[p]=new Color4(1,1,1,1));for(p=0;p<g;p++)c&&c[p]===void 0&&(c[p]=new Vector4(0,0,1,1));const m=new Array,E=new Array,M=new Array,x=new Array,A=new Array,T=Math.PI*2*h/r;let C,b,y;const S=(i-t)/2/e,R=Vector3.Zero(),P=Vector3.Zero(),N=Vector3.Zero(),V=Vector3.Zero(),F=Vector3.Zero(),U=Axis.Y;let H,X,w,O=1,v=1,D=0,B=0;for(H=0;H<=s;H++)for(b=H/s,y=(b*(t-i)+i)/2,O=n&&H!==0&&H!==s?2:1,w=0;w<O;w++){for(n&&(v+=w),o&&(v+=2*w),X=0;X<=r;X++)C=X*T,R.x=Math.cos(-C)*y,R.y=-e/2+b*e,R.z=Math.sin(-C)*y,t===0&&H===s?(P.x=M[M.length-(r+1)*3],P.y=M[M.length-(r+1)*3+1],P.z=M[M.length-(r+1)*3+2]):(P.x=R.x,P.z=R.z,P.y=Math.sqrt(P.x*P.x+P.z*P.z)*S,P.normalize()),X===0&&(N.copyFrom(R),V.copyFrom(P)),E.push(R.x,R.y,R.z),M.push(P.x,P.y,P.z),n?B=D!==v?c[v].y:c[v].w:B=c[v].y+(c[v].w-c[v].y)*b,x.push(c[v].x+(c[v].z-c[v].x)*X/r,CompatibilityOptions.UseOpenGLOrientationForUV?1-B:B),d&&A.push(d[v].r,d[v].g,d[v].b,d[v].a);h!==1&&o&&(E.push(R.x,R.y,R.z),E.push(0,R.y,0),E.push(0,R.y,0),E.push(N.x,N.y,N.z),Vector3.CrossToRef(U,P,F),F.normalize(),M.push(F.x,F.y,F.z,F.x,F.y,F.z),Vector3.CrossToRef(V,U,F),F.normalize(),M.push(F.x,F.y,F.z,F.x,F.y,F.z),n?B=D!==v?c[v+1].y:c[v+1].w:B=c[v+1].y+(c[v+1].w-c[v+1].y)*b,x.push(c[v+1].x,CompatibilityOptions.UseOpenGLOrientationForUV?1-B:B),x.push(c[v+1].z,CompatibilityOptions.UseOpenGLOrientationForUV?1-B:B),n?B=D!==v?c[v+2].y:c[v+2].w:B=c[v+2].y+(c[v+2].w-c[v+2].y)*b,x.push(c[v+2].x,CompatibilityOptions.UseOpenGLOrientationForUV?1-B:B),x.push(c[v+2].z,CompatibilityOptions.UseOpenGLOrientationForUV?1-B:B),d&&(A.push(d[v+1].r,d[v+1].g,d[v+1].b,d[v+1].a),A.push(d[v+1].r,d[v+1].g,d[v+1].b,d[v+1].a),A.push(d[v+2].r,d[v+2].g,d[v+2].b,d[v+2].a),A.push(d[v+2].r,d[v+2].g,d[v+2].b,d[v+2].a))),D!==v&&(D=v)}const k=h!==1&&o?r+4:r;for(H=0,v=0;v<s;v++){let L=0,G=0,Z=0,z=0;for(X=0;X<r;X++)L=H*(k+1)+X,G=(H+1)*(k+1)+X,Z=H*(k+1)+(X+1),z=(H+1)*(k+1)+(X+1),m.push(L,G,Z),m.push(z,Z,G);h!==1&&o&&(m.push(L+2,G+2,Z+2),m.push(z+2,Z+2,G+2),m.push(L+4,G+4,Z+4),m.push(z+4,Z+4,G+4)),H=n?H+2:H+1}const j=L=>{const G=L?t/2:i/2;if(G===0)return;let Z,z,Y;const W=L?c[g-1]:c[0];let J=null;d&&(J=L?d[g-1]:d[0]);const ee=E.length/3,te=L?e/2:-e/2,ie=new Vector3(0,te,0);E.push(ie.x,ie.y,ie.z),M.push(0,L?1:-1,0);const he=W.y+(W.w-W.y)*.5;x.push(W.x+(W.z-W.x)*.5,CompatibilityOptions.UseOpenGLOrientationForUV?1-he:he),J&&A.push(J.r,J.g,J.b,J.a);const oe=new Vector2(.5,.5);for(Y=0;Y<=r;Y++){Z=Math.PI*2*Y*h/r;const Ve=Math.cos(-Z),Ue=Math.sin(-Z);z=new Vector3(Ve*G,te,Ue*G);const ke=new Vector2(Ve*oe.x+.5,Ue*oe.y+.5);E.push(z.x,z.y,z.z),M.push(0,L?1:-1,0);const ze=W.y+(W.w-W.y)*ke.y;x.push(W.x+(W.z-W.x)*ke.x,CompatibilityOptions.UseOpenGLOrientationForUV?1-ze:ze),J&&A.push(J.r,J.g,J.b,J.a)}for(Y=0;Y<r;Y++)L?(m.push(ee),m.push(ee+(Y+2)),m.push(ee+(Y+1))):(m.push(ee),m.push(ee+(Y+1)),m.push(ee+(Y+2)))};(l===Mesh.CAP_START||l===Mesh.CAP_ALL)&&j(!1),(l===Mesh.CAP_END||l===Mesh.CAP_ALL)&&j(!0),VertexData._ComputeSides(u,E,m,M,x,a.frontUVs,a.backUVs);const K=new VertexData;return K.indices=m,K.positions=E,K.normals=M,K.uvs=x,d&&(K.colors=A),K}function CreateCylinder(a,e={},t){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreateCylinderVertexData(e).applyToMesh(i,e.updatable),i}VertexData.CreateCylinder=CreateCylinderVertexData;Mesh.CreateCylinder=(a,e,t,i,r,s,n,o,l)=>((n===void 0||!(n instanceof Scene))&&(n!==void 0&&(l=o||Mesh.DEFAULTSIDE,o=n),n=s,s=1),CreateCylinder(a,{height:e,diameterTop:t,diameterBottom:i,tessellation:r,subdivisions:s,sideOrientation:l,updatable:o},n));function CreateTorusVertexData(a){const e=[],t=[],i=[],r=[],s=a.diameter||1,n=a.thickness||.5,o=a.tessellation||16,l=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE,h=o+1;for(let c=0;c<=o;c++){const d=c/o,f=c*Math.PI*2/o-Math.PI/2,_=Matrix.Translation(s/2,0,0).multiply(Matrix.RotationY(f));for(let g=0;g<=o;g++){const p=1-g/o,m=g*Math.PI*2/o+Math.PI,E=Math.cos(m),M=Math.sin(m);let x=new Vector3(E,M,0),A=x.scale(n/2);const T=new Vector2(d,p);A=Vector3.TransformCoordinates(A,_),x=Vector3.TransformNormal(x,_),t.push(A.x,A.y,A.z),i.push(x.x,x.y,x.z),r.push(T.x,CompatibilityOptions.UseOpenGLOrientationForUV?1-T.y:T.y);const C=(c+1)%h,b=(g+1)%h;e.push(c*h+g),e.push(c*h+b),e.push(C*h+g),e.push(c*h+b),e.push(C*h+b),e.push(C*h+g)}}VertexData._ComputeSides(l,t,e,i,r,a.frontUVs,a.backUVs);const u=new VertexData;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function CreateTorus(a,e={},t){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreateTorusVertexData(e).applyToMesh(i,e.updatable),i}VertexData.CreateTorus=CreateTorusVertexData;Mesh.CreateTorus=(a,e,t,i,r,s,n)=>CreateTorus(a,{diameter:e,thickness:t,tessellation:i,sideOrientation:n,updatable:s},r);function CreateTorusKnotVertexData(a){const e=new Array,t=new Array,i=new Array,r=new Array,s=a.radius||2,n=a.tube||.5,o=a.radialSegments||32,l=a.tubularSegments||32,h=a.p||2,u=a.q||3,c=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE,d=p=>{const m=Math.cos(p),E=Math.sin(p),M=u/h*p,x=Math.cos(M),A=s*(2+x)*.5*m,T=s*(2+x)*E*.5,C=s*Math.sin(M)*.5;return new Vector3(A,T,C)};let f,_;for(f=0;f<=o;f++){const m=f%o/o*2*h*Math.PI,E=d(m),M=d(m+.01),x=M.subtract(E);let A=M.add(E);const T=Vector3.Cross(x,A);for(A=Vector3.Cross(T,x),T.normalize(),A.normalize(),_=0;_<l;_++){const b=_%l/l*2*Math.PI,y=-n*Math.cos(b),S=n*Math.sin(b);t.push(E.x+y*A.x+S*T.x),t.push(E.y+y*A.y+S*T.y),t.push(E.z+y*A.z+S*T.z),r.push(f/o),r.push(CompatibilityOptions.UseOpenGLOrientationForUV?1-_/l:_/l)}}for(f=0;f<o;f++)for(_=0;_<l;_++){const p=(_+1)%l,m=f*l+_,E=(f+1)*l+_,M=(f+1)*l+p,x=f*l+p;e.push(x),e.push(E),e.push(m),e.push(x),e.push(M),e.push(E)}VertexData.ComputeNormals(t,e,i),VertexData._ComputeSides(c,t,e,i,r,a.frontUVs,a.backUVs);const g=new VertexData;return g.indices=e,g.positions=t,g.normals=i,g.uvs=r,g}function CreateTorusKnot(a,e={},t){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreateTorusKnotVertexData(e).applyToMesh(i,e.updatable),i}VertexData.CreateTorusKnot=CreateTorusKnotVertexData;Mesh.CreateTorusKnot=(a,e,t,i,r,s,n,o,l,h)=>CreateTorusKnot(a,{radius:e,tube:t,radialSegments:i,tubularSegments:r,p:s,q:n,sideOrientation:h,updatable:l},o);Mesh._instancedMeshFactory=(a,e)=>{const t=new InstancedMesh(a,e);if(e.instancedBuffers){t.instancedBuffers={};for(const i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};class InstancedMesh extends AbstractMesh{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const i of t.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.receiveShadows)!==e&&Tools.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.material)!==e&&Tools.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.visibility)!==e&&Tools.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.skeleton)!==e&&Tools.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||Logger.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}setVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,r),this.sourceMesh}updateVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,r),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||Logger.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==TransformNode.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new Matrix);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,TmpVectors.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(TmpVectors.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{const i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,r){const s=(r||this._sourceMesh).createInstance(e);if(DeepCopier.DeepCopy(this,s,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(s.parent=t),!i)for(let n=0;n<this.getScene().meshes.length;n++){const o=this.getScene().meshes[n];o.parent===this&&o.clone(o.name,s)}return s.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(s),s}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);r&&i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.instantiateHierarchy(r,t,i);return r}}Mesh.prototype.registerInstancedBuffer=function(a,e){var t,i;if((i=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[a])===null||i===void 0||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const r of this.instances)r.instancedBuffers={};this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[a]=null,this._userInstancedBuffersStorage.strides[a]=e,this._userInstancedBuffersStorage.sizes[a]=e*32,this._userInstancedBuffersStorage.data[a]=new Float32Array(this._userInstancedBuffersStorage.sizes[a]),this._userInstancedBuffersStorage.vertexBuffers[a]=new VertexBuffer(this.getEngine(),this._userInstancedBuffersStorage.data[a],a,!0,!1,e,!0);for(const r of this.instances)r.instancedBuffers[a]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};Mesh.prototype._processInstancedBuffers=function(a,e){const t=a?a.length:0;for(const i in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[i];const s=this._userInstancedBuffersStorage.strides[i],n=(t+1)*s;for(;r<n;)r*=2;this._userInstancedBuffersStorage.data[i].length!=r&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[i]=r,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));const o=this._userInstancedBuffersStorage.data[i];let l=0;if(e){const h=this.instancedBuffers[i];h.toArray?h.toArray(o,l):h.copyToArray?h.copyToArray(o,l):o[l]=h,l+=s}for(let h=0;h<t;h++){const c=a[h].instancedBuffers[i];c.toArray?c.toArray(o,l):c.copyToArray?c.copyToArray(o,l):o[l]=c,l+=s}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new VertexBuffer(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,s,!0),this._invalidateInstanceVertexArrayObject())}};Mesh.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(const a in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[a]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};Mesh.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const a in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[a]&&this._userInstancedBuffersStorage.vertexBuffers[a].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};class EffectFallbacks{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let r=0;r<i.meshes.length;r++){const s=i.meshes[r];if(!s.material){!this._mesh.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=!1);continue}if(!(!s.computeBonesUsingShaders||s.numBoneInfluencers===0)){if(s.material.getEffect()===t)s.computeBonesUsingShaders=!1;else if(s.subMeshes){for(const n of s.subMeshes)if(n.effect===t){s.computeBonesUsingShaders=!1;break}}}}}else{const i=this._defines[this._currentRank];if(i)for(let r=0;r<i.length;r++)e=e.replace("#define "+i[r],"");this._currentRank++}return e}}class PushMaterial extends Material{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new Matrix,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],t):!1}_isReadyForSubMesh(e){const t=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&t&&t._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null){super._afterBind(e,t),this.getScene()._cachedEffect=t,t&&(t._forceRebindOnNextCall=!1)}_mustRebind(e,t,i=1){return e.isCachedMaterialInvalid(this,t,i)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}const onCreatedEffectParameters$1={effect:null,subMesh:null};class ShaderMaterial extends PushMaterial{constructor(e,t,i,r={},s=!0){super(e,t,s),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new Matrix,this._cachedWorldViewProjectionMatrix=new Matrix,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options=Object.assign({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},r)}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this}setTextureArray(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(t.length*16);for(let r=0;r<t.length;r++)t[r].copyToArray(i,r*16);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){const i=e.trimEnd()+" ",r=this.options.defines.findIndex(s=>s===e||s.startsWith(i));return r>=0&&this.options.defines.splice(r,1),(typeof t!="boolean"||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){var r,s,n,o;const l=i&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(l){if(i.effect&&i.effect._wasPreviouslyReady)return!0}else{const y=this._drawWrapper.effect;if(y&&y._wasPreviouslyReady&&y._wasPreviouslyUsingInstances===t)return!0}const h=this.getScene(),u=h.getEngine(),c=[],d=[],f=new EffectFallbacks;let _=this._shaderPath,g=this._options.uniforms,p=this._options.uniformBuffers,m=this._options.samplers;u.getCaps().multiview&&h.activeCamera&&h.activeCamera.outputRenderTarget&&h.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,c.push("#define MULTIVIEW"),this._options.uniforms.indexOf("viewProjection")!==-1&&this._options.uniforms.indexOf("viewProjectionR")===-1&&this._options.uniforms.push("viewProjectionR"));for(let y=0;y<this._options.defines.length;y++){const S=this._options.defines[y].indexOf("#define")===0?this._options.defines[y]:`#define ${this._options.defines[y]}`;c.push(S)}for(let y=0;y<this._options.attributes.length;y++)d.push(this._options.attributes[y]);if(e&&e.isVerticesDataPresent(VertexBuffer.ColorKind)&&(d.push(VertexBuffer.ColorKind),c.push("#define VERTEXCOLOR")),t&&(c.push("#define INSTANCES"),MaterialHelper.PushAttributesForInstances(d,this._materialHelperNeedsPreviousMatrices),e!=null&&e.hasThinInstances&&(c.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(VertexBuffer.ColorInstanceKind)&&(d.push(VertexBuffer.ColorInstanceKind),c.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){d.push(VertexBuffer.MatricesIndicesKind),d.push(VertexBuffer.MatricesWeightsKind),e.numBoneInfluencers>4&&(d.push(VertexBuffer.MatricesIndicesExtraKind),d.push(VertexBuffer.MatricesWeightsExtraKind));const y=e.skeleton;c.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),f.addCPUSkinningFallback(0,e),y.isUsingTextureForMatrices?(c.push("#define BONETEXTURE"),this._options.uniforms.indexOf("boneTextureWidth")===-1&&this._options.uniforms.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(c.push("#define BonesPerMesh "+(y.bones.length+1)),this._options.uniforms.indexOf("mBones")===-1&&this._options.uniforms.push("mBones"))}else c.push("#define NUM_BONE_INFLUENCERS 0");let E=0;const M=e?e.morphTargetManager:null;if(M){const y=M.supportsUVs&&c.indexOf("#define UV1")!==-1,S=M.supportsTangents&&c.indexOf("#define TANGENT")!==-1,R=M.supportsNormals&&c.indexOf("#define NORMAL")!==-1;E=M.numInfluencers,y&&c.push("#define MORPHTARGETS_UV"),S&&c.push("#define MORPHTARGETS_TANGENT"),R&&c.push("#define MORPHTARGETS_NORMAL"),E>0&&c.push("#define MORPHTARGETS"),M.isUsingTextureForTargets&&(c.push("#define MORPHTARGETS_TEXTURE"),this._options.uniforms.indexOf("morphTargetTextureIndices")===-1&&this._options.uniforms.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),c.push("#define NUM_MORPH_INFLUENCERS "+E);for(let P=0;P<E;P++)d.push(VertexBuffer.PositionKind+P),R&&d.push(VertexBuffer.NormalKind+P),S&&d.push(VertexBuffer.TangentKind+P),y&&d.push(VertexBuffer.UVKind+"_"+P);E>0&&(g=g.slice(),g.push("morphTargetInfluences"),g.push("morphTargetTextureInfo"),g.push("morphTargetTextureIndices"))}else c.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const y=e.bakedVertexAnimationManager;y&&y.isEnabled&&(c.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),this._options.uniforms.indexOf("bakedVertexAnimationSettings")===-1&&this._options.uniforms.push("bakedVertexAnimationSettings"),this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),this._options.uniforms.indexOf("bakedVertexAnimationTime")===-1&&this._options.uniforms.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),MaterialHelper.PrepareAttributesForBakedVertexAnimation(d,e,c)}for(const y in this._textures)if(!this._textures[y].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&c.push("#define ALPHATEST"),this._options.useClipPlane!==!1&&(addClipPlaneUniforms(g),prepareStringDefinesForClipPlanes(this,h,c)),this.customShaderNameResolve&&(g=g.slice(),p=p.slice(),m=m.slice(),_=this.customShaderNameResolve(_,g,p,m,c,d));const x=l?i._getDrawWrapper():this._drawWrapper,A=(r=x==null?void 0:x.effect)!==null&&r!==void 0?r:null,T=(s=x==null?void 0:x.defines)!==null&&s!==void 0?s:null,C=c.join(`
`);let b=A;return T!==C&&(b=u.createEffect(_,{attributes:d,uniformsNames:g,uniformBuffersNames:p,samplers:m,defines:C,fallbacks:f,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:E},shaderLanguage:this._options.shaderLanguage},u),l?i.setEffect(b,C,this._materialContext):x&&x.setEffect(b,C),this._onEffectCreatedObservable&&(onCreatedEffectParameters$1.effect=b,onCreatedEffectParameters$1.subMesh=(n=i??(e==null?void 0:e.subMeshes[0]))!==null&&n!==void 0?n:null,this._onEffectCreatedObservable.notifyObservers(onCreatedEffectParameters$1))),b._wasPreviouslyUsingInstances=!!t,!((o=!(b!=null&&b.isReady()))!==null&&o!==void 0)||o?!1:(A!==b&&h.resetCachedMaterial(),b._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,t){const i=this.getScene(),r=t??this.getEffect();r&&(this._options.uniforms.indexOf("world")!==-1&&r.setMatrix("world",e),this._options.uniforms.indexOf("worldView")!==-1&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),r.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),r.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))}bindForSubMesh(e,t,i){var r;this.bind(e,t,(r=i._drawWrapperOverride)===null||r===void 0?void 0:r.effect,i)}bind(e,t,i,r){var s;const n=r&&this._storeEffectOnSubMeshes,o=i??(n?r.effect:this.getEffect());if(!o)return;this._activeEffect=o,this.bindOnlyWorldMatrix(e,i);const l=this._options.uniformBuffers;let h=!1;if(o&&l&&l.length>0&&this.getScene().getEngine().supportsUniformBuffers)for(let c=0;c<l.length;++c)switch(l[c]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e));break;case"Scene":MaterialHelper.BindSceneUniformBuffer(o,this.getScene().getSceneUniformBuffer()),this.getScene().finalizeSceneUbo(),h=!0;break}const u=t&&n?this._mustRebind(this.getScene(),o,t.visibility):this.getScene().getCachedMaterial()!==this;if(o&&u){!h&&this._options.uniforms.indexOf("view")!==-1&&o.setMatrix("view",this.getScene().getViewMatrix()),!h&&this._options.uniforms.indexOf("projection")!==-1&&o.setMatrix("projection",this.getScene().getProjectionMatrix()),!h&&this._options.uniforms.indexOf("viewProjection")!==-1&&(o.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._multiview&&o.setMatrix("viewProjectionR",this.getScene()._transformMatrixR)),this.getScene().activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&o.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),MaterialHelper.BindBonesParameters(t,o),bindClipPlane(o,this,this.getScene());let c;for(c in this._textures)o.setTexture(c,this._textures[c]);for(c in this._textureArrays)o.setTextureArray(c,this._textureArrays[c]);for(c in this._externalTextures)o.setExternalTexture(c,this._externalTextures[c]);for(c in this._ints)o.setInt(c,this._ints[c]);for(c in this._uints)o.setUInt(c,this._uints[c]);for(c in this._floats)o.setFloat(c,this._floats[c]);for(c in this._floatsArrays)o.setArray(c,this._floatsArrays[c]);for(c in this._colors3)o.setColor3(c,this._colors3[c]);for(c in this._colors3Arrays)o.setArray3(c,this._colors3Arrays[c]);for(c in this._colors4){const d=this._colors4[c];o.setFloat4(c,d.r,d.g,d.b,d.a)}for(c in this._colors4Arrays)o.setArray4(c,this._colors4Arrays[c]);for(c in this._vectors2)o.setVector2(c,this._vectors2[c]);for(c in this._vectors3)o.setVector3(c,this._vectors3[c]);for(c in this._vectors4)o.setVector4(c,this._vectors4[c]);for(c in this._quaternions)o.setQuaternion(c,this._quaternions[c]);for(c in this._matrices)o.setMatrix(c,this._matrices[c]);for(c in this._matrixArrays)o.setMatrices(c,this._matrixArrays[c]);for(c in this._matrices3x3)o.setMatrix3x3(c,this._matrices3x3[c]);for(c in this._matrices2x2)o.setMatrix2x2(c,this._matrices2x2[c]);for(c in this._vectors2Arrays)o.setArray2(c,this._vectors2Arrays[c]);for(c in this._vectors3Arrays)o.setArray3(c,this._vectors3Arrays[c]);for(c in this._vectors4Arrays)o.setArray4(c,this._vectors4Arrays[c]);for(c in this._quaternionsArrays)o.setArray4(c,this._quaternionsArrays[c]);for(c in this._uniformBuffers){const d=this._uniformBuffers[c].getBuffer();d&&o.bindUniformBuffer(d,c)}for(c in this._textureSamplers)o.setTextureSampler(c,this._textureSamplers[c]);for(c in this._storageBuffers)o.setStorageBuffer(c,this._storageBuffers[c])}if(o&&t&&(u||!this.isFrozen)){const c=t.morphTargetManager;c&&c.numInfluencers>0&&MaterialHelper.BindMorphTargetParameters(t,o);const d=t.bakedVertexAnimationManager;d&&d.isEnabled&&((s=t.bakedVertexAnimationManager)===null||s===void 0||s.bind(o,!!o._wasPreviouslyUsingInstances))}this._afterBind(t,o)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.push(i[r])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let r=0;r<i.length;r++)if(i[r]===e)return!0}return!1}clone(e){const t=SerializationHelper.Clone(()=>new ShaderMaterial(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,typeof t._shaderPath=="object"&&(t._shaderPath=Object.assign({},t._shaderPath)),this._options=Object.assign({},this._options),Object.keys(this._options).forEach(i=>{const r=this._options[i];Array.isArray(r)&&(this._options[i]=r.slice(0))}),this.stencil.copyTo(t.stencil);for(const i in this._textures)t.setTexture(i,this._textures[i]);for(const i in this._textureArrays)t.setTextureArray(i,this._textureArrays[i]);for(const i in this._externalTextures)t.setExternalTexture(i,this._externalTextures[i]);for(const i in this._ints)t.setInt(i,this._ints[i]);for(const i in this._uints)t.setUInt(i,this._uints[i]);for(const i in this._floats)t.setFloat(i,this._floats[i]);for(const i in this._floatsArrays)t.setFloats(i,this._floatsArrays[i]);for(const i in this._colors3)t.setColor3(i,this._colors3[i]);for(const i in this._colors3Arrays)t._colors3Arrays[i]=this._colors3Arrays[i];for(const i in this._colors4)t.setColor4(i,this._colors4[i]);for(const i in this._colors4Arrays)t._colors4Arrays[i]=this._colors4Arrays[i];for(const i in this._vectors2)t.setVector2(i,this._vectors2[i]);for(const i in this._vectors3)t.setVector3(i,this._vectors3[i]);for(const i in this._vectors4)t.setVector4(i,this._vectors4[i]);for(const i in this._quaternions)t.setQuaternion(i,this._quaternions[i]);for(const i in this._quaternionsArrays)t._quaternionsArrays[i]=this._quaternionsArrays[i];for(const i in this._matrices)t.setMatrix(i,this._matrices[i]);for(const i in this._matrixArrays)t._matrixArrays[i]=this._matrixArrays[i].slice();for(const i in this._matrices3x3)t.setMatrix3x3(i,this._matrices3x3[i]);for(const i in this._matrices2x2)t.setMatrix2x2(i,this._matrices2x2[i]);for(const i in this._vectors2Arrays)t.setArray2(i,this._vectors2Arrays[i]);for(const i in this._vectors3Arrays)t.setArray3(i,this._vectors3Arrays[i]);for(const i in this._vectors4Arrays)t.setArray4(i,this._vectors4Arrays[i]);for(const i in this._uniformBuffers)t.setUniformBuffer(i,this._uniformBuffers[i]);for(const i in this._textureSamplers)t.setTextureSampler(i,this._textureSamplers[i]);for(const i in this._storageBuffers)t.setStorageBuffer(i,this._storageBuffers[i]);return t}dispose(e,t,i){if(t){let r;for(r in this._textures)this._textures[r].dispose();for(r in this._textureArrays){const s=this._textureArrays[r];for(let n=0;n<s.length;n++)s[n].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=SerializationHelper.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.textureArrays[t].push(i[r].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.uints={};for(t in this._uints)e.uints[t]=this._uints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.FloatArrays={};for(t in this._floatsArrays)e.FloatArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3)e.colors3[t]=this._colors3[t].asArray();e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4)e.colors4[t]=this._colors4[t].asArray();e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();e.vectors3={};for(t in this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();e.vectors4={};for(t in this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const r=SerializationHelper.Parse(()=>new ShaderMaterial(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i);let s;e.stencil&&r.stencil.parse(e.stencil,t,i);for(s in e.textures)r.setTexture(s,Texture.Parse(e.textures[s],t,i));for(s in e.textureArrays){const n=e.textureArrays[s],o=new Array;for(let l=0;l<n.length;l++)o.push(Texture.Parse(n[l],t,i));r.setTextureArray(s,o)}for(s in e.ints)r.setInt(s,e.ints[s]);for(s in e.uints)r.setUInt(s,e.uints[s]);for(s in e.floats)r.setFloat(s,e.floats[s]);for(s in e.floatsArrays)r.setFloats(s,e.floatsArrays[s]);for(s in e.colors3)r.setColor3(s,Color3.FromArray(e.colors3[s]));for(s in e.colors3Arrays){const n=e.colors3Arrays[s].reduce((o,l,h)=>(h%3===0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>Color3.FromArray(o));r.setColor3Array(s,n)}for(s in e.colors4)r.setColor4(s,Color4.FromArray(e.colors4[s]));for(s in e.colors4Arrays){const n=e.colors4Arrays[s].reduce((o,l,h)=>(h%4===0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>Color4.FromArray(o));r.setColor4Array(s,n)}for(s in e.vectors2)r.setVector2(s,Vector2.FromArray(e.vectors2[s]));for(s in e.vectors3)r.setVector3(s,Vector3.FromArray(e.vectors3[s]));for(s in e.vectors4)r.setVector4(s,Vector4.FromArray(e.vectors4[s]));for(s in e.quaternions)r.setQuaternion(s,Quaternion.FromArray(e.quaternions[s]));for(s in e.matrices)r.setMatrix(s,Matrix.FromArray(e.matrices[s]));for(s in e.matrixArray)r._matrixArrays[s]=new Float32Array(e.matrixArray[s]);for(s in e.matrices3x3)r.setMatrix3x3(s,e.matrices3x3[s]);for(s in e.matrices2x2)r.setMatrix2x2(s,e.matrices2x2[s]);for(s in e.vectors2Arrays)r.setArray2(s,e.vectors2Arrays[s]);for(s in e.vectors3Arrays)r.setArray3(s,e.vectors3Arrays[s]);for(s in e.vectors4Arrays)r.setArray4(s,e.vectors4Arrays[s]);for(s in e.quaternionsArrays)r.setArray4(s,e.quaternionsArrays[s]);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise((s,n)=>{const o=new WebRequest;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){const l=JSON.parse(o.responseText),h=this.Parse(l,i||EngineStore.LastCreatedScene,r);e&&(h.name=e),s(h)}else n("Unable to load the ShaderMaterial")}),o.open("GET",t),o.send()})}static ParseFromSnippetAsync(e,t,i=""){return new Promise((r,s)=>{const n=new WebRequest;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){const o=JSON.parse(JSON.parse(n.responseText).jsonPayload),l=JSON.parse(o.shaderMaterial),h=this.Parse(l,t||EngineStore.LastCreatedScene,i);h.snippetId=e,r(h)}else s("Unable to load the snippet "+e)}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}ShaderMaterial.SnippetUrl="https://snippet.babylonjs.com";ShaderMaterial.CreateFromSnippetAsync=ShaderMaterial.ParseFromSnippetAsync;RegisterClass("BABYLON.ShaderMaterial",ShaderMaterial);const name$15="clipPlaneFragmentDeclaration",shader$15=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;ShaderStore.IncludesShadersStore[name$15]=shader$15;const name$14="clipPlaneFragment",shader$14=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{
discard;
}
#endif
`;ShaderStore.IncludesShadersStore[name$14]=shader$14;const name$13="colorPixelShader",shader$13=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}`;ShaderStore.ShadersStore[name$13]=shader$13;const name$12="bonesDeclaration",shader$12=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;
attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;
attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform sampler2D boneSampler;
uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{
float offset=index *4.0;
float dx=1.0/boneTextureWidth;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));
return mat4(m0,m1,m2,m3);
}
#endif
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$12]=shader$12;const name$11="bakedVertexAnimationDeclaration",shader$11=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;
uniform vec2 bakedVertexAnimationTextureSizeInverted;
uniform vec4 bakedVertexAnimationSettings;
uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{
float offset=index*4.0;
float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;
float dx=bakedVertexAnimationTextureSizeInverted.x;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));
return mat4(m0,m1,m2,m3);
}
#endif
`;ShaderStore.IncludesShadersStore[name$11]=shader$11;const name$10="clipPlaneVertexDeclaration",shader$10=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
varying float fClipDistance6;
#endif
`;ShaderStore.IncludesShadersStore[name$10]=shader$10;const name$$="instancesDeclaration",shader$$=`#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute vec4 previousWorld0;
attribute vec4 previousWorld1;
attribute vec4 previousWorld2;
attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform mat4 previousWorld;
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$$]=shader$$;const name$_="instancesVertex",shader$_=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$_]=shader$_;const name$Z="bonesVertex",shader$Z=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$Z]=shader$Z;const name$Y="bakedVertexAnimation",shader$Y=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;
float VATEndFrame=BVASNAME.y;
float VATOffsetFrame=BVASNAME.z;
float VATSpeed=BVASNAME.w;
float totalFrames=VATEndFrame-VATStartFrame+1.0;
float time=bakedVertexAnimationTime*VATSpeed/totalFrames;
float frameCorrection=time<1.0 ? 0.0 : 1.0;
float numOfFrames=totalFrames-frameCorrection;
float VATFrameNum=fract(time)*numOfFrames;
VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);
VATFrameNum=floor(VATFrameNum);
VATFrameNum+=VATStartFrame+frameCorrection;
mat4 VATInfluence;
VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;
}
#endif
`;ShaderStore.IncludesShadersStore[name$Y]=shader$Y;const name$X="clipPlaneVertex",shader$X=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;ShaderStore.IncludesShadersStore[name$X]=shader$X;const name$W="vertexColorMixing",shader$W=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=color;
#else
vColor.rgb*=color.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$W]=shader$W;const name$V="colorVertexShader",shader$V=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;ShaderStore.ShadersStore[name$V]=shader$V;Mesh._LinesMeshParser=(a,e)=>LinesMesh.Parse(a,e);class LinesMesh extends Mesh{_isShaderMaterial(e){return e.getClassName()==="ShaderMaterial"}constructor(e,t=null,i=null,r=null,s,n,o,l){super(e,t,i,r,s),this.useVertexColor=n,this.useVertexAlpha=o,this.color=new Color3(1,1,1),this.alpha=1,r&&(this.color=r.color.clone(),this.alpha=r.alpha,this.useVertexColor=r.useVertexColor,this.useVertexAlpha=r.useVertexAlpha),this.intersectionThreshold=.1;const h=[],u={attributes:[VertexBuffer.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:h,useClipPlane:null};o===!1?u.needAlphaBlending=!1:u.defines.push("#define VERTEXALPHA"),n?(u.defines.push("#define VERTEXCOLOR"),u.attributes.push(VertexBuffer.ColorKind)):(u.uniforms.push("color"),this._color4=new Color4),l?this.material=l:(this.material=new ShaderMaterial("colorShader",this.getScene(),"color",u,!1),this.material.doNotSerialize=!0)}isReady(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage)?super.isReady():!1}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=Material.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(this._userInstancedBuffersStorage?this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,i),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r,g:s,b:n}=this.color;this._color4.set(r,s,n,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const r=this.getScene().getEngine();return this._unIndexed?r.drawArraysType(Material.LineListDrawMode,e.verticesStart,e.verticesCount,i):r.drawElementsType(Material.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new LinesMesh(e,this.getScene(),t,this,i)}createInstance(e){const t=new InstancedLinesMesh(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const i in this.instancedBuffers)t.instancedBuffers[i]=this.instancedBuffers[i]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new LinesMesh(e.name,t);return i.color=Color3.FromArray(e.color),i.alpha=e.alpha,i}}class InstancedLinesMesh extends InstancedMesh{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function CreateLineSystemVertexData(a){const e=[],t=[],i=a.lines,r=a.colors,s=[];let n=0;for(let l=0;l<i.length;l++){const h=i[l];for(let u=0;u<h.length;u++){if(t.push(h[u].x,h[u].y,h[u].z),r){const c=r[l];s.push(c[u].r,c[u].g,c[u].b,c[u].a)}u>0&&(e.push(n-1),e.push(n)),n++}}const o=new VertexData;return o.indices=e,o.positions=t,r&&(o.colors=s),o}function CreateDashedLinesVertexData(a){const e=a.dashSize||3,t=a.gapSize||1,i=a.dashNb||200,r=a.points,s=new Array,n=new Array,o=Vector3.Zero();let l=0,h=0,u=0,c=0,d=0,f=0,_=0;for(_=0;_<r.length-1;_++)r[_+1].subtractToRef(r[_],o),l+=o.length();for(u=l/i,c=e*u/(e+t),_=0;_<r.length-1;_++){r[_+1].subtractToRef(r[_],o),h=Math.floor(o.length()/u),o.normalize();for(let p=0;p<h;p++)d=u*p,s.push(r[_].x+d*o.x,r[_].y+d*o.y,r[_].z+d*o.z),s.push(r[_].x+(d+c)*o.x,r[_].y+(d+c)*o.y,r[_].z+(d+c)*o.z),n.push(f,f+1),f+=2}const g=new VertexData;return g.positions=s,g.indices=n,g}function CreateLineSystem(a,e,t){const i=e.instance,r=e.lines,s=e.colors;if(i){const h=i.getVerticesData(VertexBuffer.PositionKind);let u,c;s&&(u=i.getVerticesData(VertexBuffer.ColorKind));let d=0,f=0;for(let _=0;_<r.length;_++){const g=r[_];for(let p=0;p<g.length;p++)h[d]=g[p].x,h[d+1]=g[p].y,h[d+2]=g[p].z,s&&u&&(c=s[_],u[f]=c[p].r,u[f+1]=c[p].g,u[f+2]=c[p].b,u[f+3]=c[p].a,f+=4),d+=3}return i.updateVerticesData(VertexBuffer.PositionKind,h,!1,!1),s&&u&&i.updateVerticesData(VertexBuffer.ColorKind,u,!1,!1),i}const n=!!s,o=new LinesMesh(a,t,null,void 0,void 0,n,e.useVertexAlpha,e.material);return CreateLineSystemVertexData(e).applyToMesh(o,e.updatable),o}function CreateLines(a,e,t=null){const i=e.colors?[e.colors]:null;return CreateLineSystem(a,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:i,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}function CreateDashedLines(a,e,t=null){const i=e.points,r=e.instance,s=e.gapSize||1,n=e.dashSize||3;if(r){const h=u=>{const c=Vector3.Zero(),d=u.length/6;let f=0,_=0,g=0,p=0,m=0,E=0,M=0,x=0;for(M=0;M<i.length-1;M++)i[M+1].subtractToRef(i[M],c),f+=c.length();g=f/d;const A=r._creationDataStorage.dashSize,T=r._creationDataStorage.gapSize;for(p=A*g/(A+T),M=0;M<i.length-1;M++)for(i[M+1].subtractToRef(i[M],c),_=Math.floor(c.length()/g),c.normalize(),x=0;x<_&&E<u.length;)m=g*x,u[E]=i[M].x+m*c.x,u[E+1]=i[M].y+m*c.y,u[E+2]=i[M].z+m*c.z,u[E+3]=i[M].x+(m+p)*c.x,u[E+4]=i[M].y+(m+p)*c.y,u[E+5]=i[M].z+(m+p)*c.z,E+=6,x++;for(;E<u.length;)u[E]=i[M].x,u[E+1]=i[M].y,u[E+2]=i[M].z,E+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&Logger.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),r.updateMeshPositions(h,!1),r}const o=new LinesMesh(a,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return CreateDashedLinesVertexData(e).applyToMesh(o,e.updatable),o._creationDataStorage=new _CreationDataStorage,o._creationDataStorage.dashSize=n,o._creationDataStorage.gapSize=s,o}VertexData.CreateLineSystem=CreateLineSystemVertexData;VertexData.CreateDashedLines=CreateDashedLinesVertexData;Mesh.CreateLines=(a,e,t=null,i=!1,r=null)=>CreateLines(a,{points:e,updatable:i,instance:r},t);Mesh.CreateDashedLines=(a,e,t,i,r,s=null,n,o)=>CreateDashedLines(a,{points:e,dashSize:t,gapSize:i,dashNb:r,updatable:n,instance:o},s);var Orientation;(function(a){a[a.CW=0]="CW",a[a.CCW=1]="CCW"})(Orientation||(Orientation={}));class Angle{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return this._radians*180/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){const i=t.subtract(e),r=Math.atan2(i.y,i.x);return new Angle(r)}static FromRadians(e){return new Angle(e)}static FromDegrees(e){return new Angle(e*Math.PI/180)}}class Arc2{constructor(e,t,i){this.startPoint=e,this.midPoint=t,this.endPoint=i;const r=Math.pow(t.x,2)+Math.pow(t.y,2),s=(Math.pow(e.x,2)+Math.pow(e.y,2)-r)/2,n=(r-Math.pow(i.x,2)-Math.pow(i.y,2))/2,o=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new Vector2((s*(t.y-i.y)-n*(e.y-t.y))/o,((e.x-t.x)*n-(t.x-i.x)*s)/o),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=Angle.BetweenTwoPoints(this.centerPoint,this.startPoint);const l=this.startAngle.degrees();let h=Angle.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),u=Angle.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();h-l>180&&(h-=360),h-l<-180&&(h+=360),u-h>180&&(u-=360),u-h<-180&&(u+=360),this.orientation=h-l<0?Orientation.CW:Orientation.CCW,this.angle=Angle.FromDegrees(this.orientation===Orientation.CW?l-u:u-l)}}class Path2{constructor(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new Vector2(e,t))}addLineTo(e,t){if(this.closed)return this;const i=new Vector2(e,t),r=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(r).length(),this}addArcTo(e,t,i,r,s=36){if(this.closed)return this;const n=this._points[this._points.length-1],o=new Vector2(e,t),l=new Vector2(i,r),h=new Arc2(n,o,l);let u=h.angle.radians()/s;h.orientation===Orientation.CW&&(u*=-1);let c=h.startAngle.radians()+u;for(let d=0;d<s;d++){const f=Math.cos(c)*h.radius+h.centerPoint.x,_=Math.sin(c)*h.radius+h.centerPoint.y;this.addLineTo(f,_),c+=u}return this}addQuadraticCurveTo(e,t,i,r,s=36){if(this.closed)return this;const n=(l,h,u,c)=>(1-l)*(1-l)*h+2*l*(1-l)*u+l*l*c,o=this._points[this._points.length-1];for(let l=0;l<=s;l++){const h=l/s,u=n(h,o.x,e,i),c=n(h,o.y,t,r);this.addLineTo(u,c)}return this}addBezierCurveTo(e,t,i,r,s,n,o=36){if(this.closed)return this;const l=(u,c,d,f,_)=>(1-u)*(1-u)*(1-u)*c+3*u*(1-u)*(1-u)*d+3*u*u*(1-u)*f+u*u*u*_,h=this._points[this._points.length-1];for(let u=0;u<=o;u++){const c=u/o,d=l(c,h.x,e,i,s),f=l(c,h.y,t,r,n);this.addLineTo(d,f)}return this}isPointInside(e){let t=!1;const i=this._points.length;for(let r=i-1,s=0;s<i;r=s++){let n=this._points[r],o=this._points[s],l=o.x-n.x,h=o.y-n.y;if(Math.abs(h)>Number.EPSILON){if(h<0&&(n=this._points[s],l=-l,o=this._points[r],h=-h),e.y<n.y||e.y>o.y)continue;if(e.y===n.y&&e.x===n.x)return!0;{const u=h*(e.x-n.x)-l*(e.y-n.y);if(u===0)return!0;if(u<0)continue;t=!t}}else{if(e.y!==n.y)continue;if(o.x<=e.x&&e.x<=n.x||n.x<=e.x&&e.x<=o.x)return!0}}return t}close(){return this.closed=!0,this}length(){let e=this._length;if(this.closed){const t=this._points[this._points.length-1],i=this._points[0];e+=i.subtract(t).length()}return e}area(){const e=this._points.length;let t=0;for(let i=e-1,r=0;r<e;i=r++)t+=this._points[i].x*this._points[r].y-this._points[r].x*this._points[i].y;return t*.5}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return Vector2.Zero();const t=e*this.length();let i=0;for(let r=0;r<this._points.length;r++){const s=(r+1)%this._points.length,n=this._points[r],l=this._points[s].subtract(n),h=l.length()+i;if(t>=i&&t<=h){const u=l.normalize(),c=t-i;return new Vector2(n.x+u.x*c,n.y+u.y*c)}i=h}return Vector2.Zero()}static StartingAt(e,t){return new Path2(e,t)}}class Path3D{constructor(e,t=null,i,r=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:Vector3.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:Matrix.Identity()};for(let s=0;s<e.length;s++)this._curve[s]=e[s].clone();this._raw=i||!1,this._alignTangentsWithPath=r,this._compute(t,r)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?Vector3.TransformCoordinates(Vector3.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?Vector3.TransformCoordinates(Vector3.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?Vector3.TransformCoordinates(Vector3.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,i=0;for(let r=0;r<this._curve.length-1;r++){const s=this._curve[r+0],n=this._curve[r+1].subtract(s).normalize(),o=this._distances[r+1]-this._distances[r+0],l=Math.min(Math.max(Vector3.Dot(n,e.subtract(s).normalize()),0)*Vector3.Distance(s,e)/o,1),h=Vector3.Distance(s.add(n.scale(l*o)),e);h<t&&(t=h,i=(this._distances[r+0]+o*l)/this.length())}return i}slice(e=0,t=1){if(e<0&&(e=1-e*-1%1),t<0&&(t=1-t*-1%1),e>t){const h=e;e=t,t=h}const i=this.getCurve(),r=this.getPointAt(e);let s=this.getPreviousPointIndexAt(e);const n=this.getPointAt(t),o=this.getPreviousPointIndexAt(t)+1,l=[];return e!==0&&(s++,l.push(r)),l.push(...i.slice(s,o)),(t!==1||e===1)&&l.push(n),new Path3D(l,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,i=!1){for(let r=0;r<e.length;r++)this._curve[r].x=e[r].x,this._curve[r].y=e[r].y,this._curve[r].z=e[r].z;return this._compute(t,i),this}_compute(e,t=!1){const i=this._curve.length;if(i<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();const r=this._tangents[0],s=this._normalVector(r,e);this._normals[0]=s,this._raw||this._normals[0].normalize(),this._binormals[0]=Vector3.Cross(r,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;let n,o,l,h,u;for(let c=1;c<i;c++)n=this._getLastNonNullVector(c),c<i-1&&(o=this._getFirstNonNullVector(c),this._tangents[c]=t?o:n.add(o),this._tangents[c].normalize()),this._distances[c]=this._distances[c-1]+this._curve[c].subtract(this._curve[c-1]).length(),l=this._tangents[c],u=this._binormals[c-1],this._normals[c]=Vector3.Cross(u,l),this._raw||(this._normals[c].length()===0?(h=this._normals[c-1],this._normals[c]=h.clone()):this._normals[c].normalize()),this._binormals[c]=Vector3.Cross(l,this._normals[c]),this._raw||this._binormals[c].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,i=this._curve[e+t].subtract(this._curve[e]);for(;i.length()===0&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i}_getLastNonNullVector(e){let t=1,i=this._curve[e].subtract(this._curve[e-t]);for(;i.length()===0&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i}_normalVector(e,t){let i,r=e.length();if(r===0&&(r=1),t==null){let s;Scalar.WithinEpsilon(Math.abs(e.y)/r,1,Epsilon)?Scalar.WithinEpsilon(Math.abs(e.x)/r,1,Epsilon)?Scalar.WithinEpsilon(Math.abs(e.z)/r,1,Epsilon)?s=Vector3.Zero():s=new Vector3(0,0,1):s=new Vector3(1,0,0):s=new Vector3(0,-1,0),i=Vector3.Cross(e,s)}else i=Vector3.Cross(e,t),Vector3.CrossToRef(i,e,i);return i.normalize(),i}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;const i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let r=i[0],s,n=0;const o=e*this.length();for(let l=1;l<i.length;l++){s=i[l];const h=Vector3.Distance(r,s);if(n+=h,n===o)return this._setPointAtData(e,1,s,l,t);if(n>o){const c=(n-o)/h,d=r.subtract(s),f=s.add(d.scaleInPlace(c));return this._setPointAtData(e,1-c,f,l-1,t)}r=s}return this._pointAtData}_setPointAtData(e,t,i,r,s){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=r,this._pointAtData.interpolateReady=s,s&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=Matrix.Identity();const e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){const t=e+1,i=this._tangents[e].clone(),r=this._normals[e].clone(),s=this._binormals[e].clone(),n=this._tangents[t].clone(),o=this._normals[t].clone(),l=this._binormals[t].clone(),h=Quaternion.RotationQuaternionFromAxis(r,s,i),u=Quaternion.RotationQuaternionFromAxis(o,l,n);Quaternion.Slerp(h,u,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class IndexedVector2 extends Vector2{constructor(e,t){super(e.x,e.y),this.index=t}}class PolygonPoints{constructor(){this.elements=new Array}add(e){const t=new Array;return e.forEach(i=>{const r=new IndexedVector2(i,this.elements.length);t.push(r),this.elements.push(r)}),t}computeBounds(){const e=new Vector2(this.elements[0].x,this.elements[0].y),t=new Vector2(this.elements[0].x,this.elements[0].y);return this.elements.forEach(i=>{i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y)}),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}}class PolygonMeshBuilder{_addToepoint(e){for(const t of e)this._epoints.push(t.x,t.y)}constructor(e,t,i,r=earcut){this._points=new PolygonPoints,this._outlinepoints=new PolygonPoints,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=r,this._name=e,this._scene=i||EngineStore.LastCreatedScene;let s;t instanceof Path2?s=t.getPoints():s=t,this._addToepoint(s),this._points.add(s),this._outlinepoints.add(s),typeof this.bjsEarcut>"u"&&Logger.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);const t=new PolygonPoints;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){const r=new Mesh(this._name,this._scene),s=this.buildVertexData(t,i);return r.setVerticesData(VertexBuffer.PositionKind,s.positions,e),r.setVerticesData(VertexBuffer.NormalKind,s.normals,e),r.setVerticesData(VertexBuffer.UVKind,s.uvs,e),r.setIndices(s.indices),r}buildVertexData(e=0,t=2){const i=new VertexData,r=new Array,s=new Array,n=new Array,o=this._points.computeBounds();this._points.elements.forEach(u=>{r.push(0,1,0),s.push(u.x,0,u.y),n.push((u.x-o.min.x)/o.width,(u.y-o.min.y)/o.height)});const l=new Array,h=this.bjsEarcut(this._epoints,this._eholes,2);for(let u=0;u<h.length;u++)l.push(h[u]);if(e>0){const u=s.length/3;this._points.elements.forEach(d=>{r.push(0,-1,0),s.push(d.x,-e,d.y),n.push(1-(d.x-o.min.x)/o.width,1-(d.y-o.min.y)/o.height)});const c=l.length;for(let d=0;d<c;d+=3){const f=l[d+0],_=l[d+1],g=l[d+2];l.push(g+u),l.push(_+u),l.push(f+u)}this._addSide(s,r,n,l,o,this._outlinepoints,e,!1,t),this._holes.forEach(d=>{this._addSide(s,r,n,l,o,d,e,!0,t)})}return i.indices=l,i.positions=s,i.normals=r,i.uvs=n,i}_addSide(e,t,i,r,s,n,o,l,h){let u=e.length/3,c=0;for(let d=0;d<n.elements.length;d++){const f=n.elements[d],_=n.elements[(d+1)%n.elements.length];e.push(f.x,0,f.y),e.push(f.x,-o,f.y),e.push(_.x,0,_.y),e.push(_.x,-o,_.y);const g=n.elements[(d+n.elements.length-1)%n.elements.length],p=n.elements[(d+2)%n.elements.length];let m=new Vector3(-(_.y-f.y),0,_.x-f.x),E=new Vector3(-(f.y-g.y),0,f.x-g.x),M=new Vector3(-(p.y-_.y),0,p.x-_.x);l||(m=m.scale(-1),E=E.scale(-1),M=M.scale(-1));const x=m.normalizeToNew();let A=E.normalizeToNew(),T=M.normalizeToNew();const C=Vector3.Dot(A,x);C>h?C<Epsilon-1?A=new Vector3(f.x,0,f.y).subtract(new Vector3(_.x,0,_.y)).normalize():A=E.add(m).normalize():A=x;const b=Vector3.Dot(M,m);b>h?b<Epsilon-1?T=new Vector3(_.x,0,_.y).subtract(new Vector3(f.x,0,f.y)).normalize():T=M.add(m).normalize():T=x,i.push(c/s.width,0),i.push(c/s.width,1),c+=m.length(),i.push(c/s.width,0),i.push(c/s.width,1),t.push(A.x,A.y,A.z),t.push(A.x,A.y,A.z),t.push(T.x,T.y,T.z),t.push(T.x,T.y,T.z),l?(r.push(u),r.push(u+2),r.push(u+1),r.push(u+1),r.push(u+2),r.push(u+3)):(r.push(u),r.push(u+1),r.push(u+2),r.push(u+1),r.push(u+3),r.push(u+2)),u+=4}}}function CreatePolygonVertexData(a,e,t,i,r,s,n){const o=t||new Array(3),l=i,h=[],u=n||!1;for(let y=0;y<3;y++)o[y]===void 0&&(o[y]=new Vector4(0,0,1,1)),l&&l[y]===void 0&&(l[y]=new Color4(1,1,1,1));const c=a.getVerticesData(VertexBuffer.PositionKind),d=a.getVerticesData(VertexBuffer.NormalKind),f=a.getVerticesData(VertexBuffer.UVKind),_=a.getIndices(),g=c.length/9;let p=0,m=0,E=0,M=0,x=0;const A=[0];if(u)for(let y=g;y<c.length/3;y+=4)m=c[3*(y+2)]-c[3*y],E=c[3*(y+2)+2]-c[3*y+2],M=Math.sqrt(m*m+E*E),x+=M,A.push(x);let T=0,C=0;for(let y=0;y<d.length;y+=3)Math.abs(d[y+1])<.001&&(C=1),Math.abs(d[y+1]-1)<.001&&(C=0),Math.abs(d[y+1]+1)<.001&&(C=2),T=y/3,C===1?(p=T-g,p%4<1.5?u?f[2*T]=o[C].x+(o[C].z-o[C].x)*A[Math.floor(p/4)]/x:f[2*T]=o[C].x:u?f[2*T]=o[C].x+(o[C].z-o[C].x)*A[Math.floor(p/4)+1]/x:f[2*T]=o[C].z,p%2===0?f[2*T+1]=CompatibilityOptions.UseOpenGLOrientationForUV?1-o[C].w:o[C].w:f[2*T+1]=CompatibilityOptions.UseOpenGLOrientationForUV?1-o[C].y:o[C].y):(f[2*T]=(1-f[2*T])*o[C].x+f[2*T]*o[C].z,f[2*T+1]=(1-f[2*T+1])*o[C].y+f[2*T+1]*o[C].w,CompatibilityOptions.UseOpenGLOrientationForUV&&(f[2*T+1]=1-f[2*T+1])),l&&h.push(l[C].r,l[C].g,l[C].b,l[C].a);VertexData._ComputeSides(e,c,_,d,f,r,s);const b=new VertexData;if(b.indices=_,b.positions=c,b.normals=d,b.uvs=f,l){const y=e===VertexData.DOUBLESIDE?h.concat(h):h;b.colors=y}return b}function CreatePolygon(a,e,t=null,i=earcut){e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation);const r=e.shape,s=e.holes||[],n=e.depth||0,o=e.smoothingThreshold||2,l=[];let h=[];for(let _=0;_<r.length;_++)l[_]=new Vector2(r[_].x,r[_].z);const u=1e-8;l[0].equalsWithEpsilon(l[l.length-1],u)&&l.pop();const c=new PolygonMeshBuilder(a,l,t||EngineStore.LastCreatedScene,i);for(let _=0;_<s.length;_++){h=[];for(let g=0;g<s[_].length;g++)h.push(new Vector2(s[_][g].x,s[_][g].z));c.addHole(h)}const d=c.build(!1,n,o);return d._originalBuilderSideOrientation=e.sideOrientation,CreatePolygonVertexData(d,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap).applyToMesh(d,e.updatable),d}function ExtrudePolygon(a,e,t=null,i=earcut){return CreatePolygon(a,e,t,i)}VertexData.CreatePolygon=CreatePolygonVertexData;Mesh.CreatePolygon=(a,e,t,i,r,s,n=earcut)=>CreatePolygon(a,{shape:e,holes:i,updatable:r,sideOrientation:s},t,n);Mesh.ExtrudePolygon=(a,e,t,i,r,s,n,o=earcut)=>ExtrudePolygon(a,{shape:e,holes:r,depth:t,updatable:s,sideOrientation:n},i,o);function ExtrudeShape(a,e,t=null){const i=e.path,r=e.shape,s=e.scale||1,n=e.rotation||0,o=e.cap===0?0:e.cap||Mesh.NO_CAP,l=e.updatable,h=Mesh._GetDefaultSideOrientation(e.sideOrientation),u=e.instance||null,c=e.invertUV||!1,d=e.closeShape||!1,f=e.closePath||!1;return _ExtrudeShapeGeneric(a,r,i,s,n,null,null,f,d,o,!1,t,!!l,h,u,c,e.frontUVs||null,e.backUVs||null,e.firstNormal||null,!!e.adjustFrame)}function ExtrudeShapeCustom(a,e,t=null){const i=e.path,r=e.shape,s=e.scaleFunction||(()=>1),n=e.rotationFunction||(()=>0),o=e.closePath||e.ribbonCloseArray||!1,l=e.closeShape||e.ribbonClosePath||!1,h=e.cap===0?0:e.cap||Mesh.NO_CAP,u=e.updatable,c=e.firstNormal||null,d=e.adjustFrame||!1,f=Mesh._GetDefaultSideOrientation(e.sideOrientation),_=e.instance,g=e.invertUV||!1;return _ExtrudeShapeGeneric(a,r,i,null,null,s,n,o,l,h,!0,t,!!u,f,_||null,g,e.frontUVs||null,e.backUVs||null,c,d)}function _ExtrudeShapeGeneric(a,e,t,i,r,s,n,o,l,h,u,c,d,f,_,g,p,m,E,M){const x=(y,S,R,P,N,V,F,U,H,X,w)=>{const O=R.getTangents(),v=R.getNormals(),D=R.getBinormals(),B=R.getDistances();if(w){for(let W=0;W<O.length;W++)if(O[W].x==0&&O[W].y==0&&O[W].z==0&&O[W].copyFrom(O[W-1]),v[W].x==0&&v[W].y==0&&v[W].z==0&&v[W].copyFrom(v[W-1]),D[W].x==0&&D[W].y==0&&D[W].z==0&&D[W].copyFrom(D[W-1]),W>0){let J=O[W-1];Vector3.Dot(J,O[W])<0&&O[W].scaleInPlace(-1),J=v[W-1],Vector3.Dot(J,v[W])<0&&v[W].scaleInPlace(-1),J=D[W-1],Vector3.Dot(J,D[W])<0&&D[W].scaleInPlace(-1)}}let k=0;const j=()=>N!==null?N:1,L=X&&U?U:()=>V!==null?V:0,G=X&&F?F:j;let Z=H===Mesh.NO_CAP||H===Mesh.CAP_END?0:2;const z=TmpVectors.Matrix[0];for(let W=0;W<S.length;W++){const J=new Array,ee=L(W,B[W]),te=G(W,B[W]);Matrix.RotationAxisToRef(O[W],k,z);for(let ie=0;ie<y.length;ie++){const he=O[W].scale(y[ie].z).add(v[W].scale(y[ie].x)).add(D[W].scale(y[ie].y)),oe=Vector3.Zero();Vector3.TransformCoordinatesToRef(he,z,oe),oe.scaleInPlace(te).addInPlace(S[W]),J[ie]=oe}P[Z]=J,k+=ee,Z++}const Y=W=>{const J=Array(),ee=Vector3.Zero();let te;for(te=0;te<W.length;te++)ee.addInPlace(W[te]);for(ee.scaleInPlace(1/W.length),te=0;te<W.length;te++)J.push(ee);return J};switch(H){case Mesh.NO_CAP:break;case Mesh.CAP_START:P[0]=Y(P[2]),P[1]=P[2];break;case Mesh.CAP_END:P[Z]=P[Z-1],P[Z+1]=Y(P[Z-1]);break;case Mesh.CAP_ALL:P[0]=Y(P[2]),P[1]=P[2],P[Z]=P[Z-1],P[Z+1]=Y(P[Z-1]);break}return P};let A,T;if(_){const y=_._creationDataStorage;return A=E?y.path3D.update(t,E):y.path3D.update(t),T=x(e,t,y.path3D,y.pathArray,i,r,s,n,y.cap,u,M),_=CreateRibbon("",{pathArray:T,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:_},c||void 0),_}A=E?new Path3D(t,E):new Path3D(t);const C=new Array;h=h<0||h>3?0:h,T=x(e,t,A,C,i,r,s,n,h,u,M);const b=CreateRibbon(a,{pathArray:T,closeArray:o,closePath:l,updatable:d,sideOrientation:f,invertUV:g,frontUVs:p||void 0,backUVs:m||void 0},c);return b._creationDataStorage.pathArray=T,b._creationDataStorage.path3D=A,b._creationDataStorage.cap=h,b}Mesh.ExtrudeShape=(a,e,t,i,r,s,n=null,o,l,h)=>{const u={shape:e,path:t,scale:i,rotation:r,cap:s===0?0:s||Mesh.NO_CAP,sideOrientation:l,instance:h,updatable:o};return ExtrudeShape(a,u,n)};Mesh.ExtrudeShapeCustom=(a,e,t,i,r,s,n,o,l,h,u,c)=>{const d={shape:e,path:t,scaleFunction:i,rotationFunction:r,ribbonCloseArray:s,ribbonClosePath:n,cap:o===0?0:o||Mesh.NO_CAP,sideOrientation:u,instance:c,updatable:h};return ExtrudeShapeCustom(a,d,l)};function CreateLathe(a,e,t=null){const i=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,r=e.closed===void 0?!0:e.closed,s=e.shape,n=e.radius||1,o=e.tessellation||64,l=e.clip||0,h=e.updatable,u=Mesh._GetDefaultSideOrientation(e.sideOrientation),c=e.cap||Mesh.NO_CAP,d=Math.PI*2,f=new Array,_=e.invertUV||!1;let g=0,p=0;const m=d/o*i;let E,M;for(g=0;g<=o-l;g++){for(M=[],(c==Mesh.CAP_START||c==Mesh.CAP_ALL)&&(M.push(new Vector3(0,s[0].y,0)),M.push(new Vector3(Math.cos(g*m)*s[0].x*n,s[0].y,Math.sin(g*m)*s[0].x*n))),p=0;p<s.length;p++)E=new Vector3(Math.cos(g*m)*s[p].x*n,s[p].y,Math.sin(g*m)*s[p].x*n),M.push(E);(c==Mesh.CAP_END||c==Mesh.CAP_ALL)&&(M.push(new Vector3(Math.cos(g*m)*s[s.length-1].x*n,s[s.length-1].y,Math.sin(g*m)*s[s.length-1].x*n)),M.push(new Vector3(0,s[s.length-1].y,0))),f.push(M)}return CreateRibbon(a,{pathArray:f,closeArray:r,sideOrientation:u,updatable:h,invertUV:_,frontUVs:e.frontUVs,backUVs:e.backUVs},t)}Mesh.CreateLathe=(a,e,t,i,r,s,n)=>CreateLathe(a,{shape:e,radius:t,tessellation:i,sideOrientation:n,updatable:s},r);function CreatePlaneVertexData(a){const e=[],t=[],i=[],r=[],s=a.width||a.size||1,n=a.height||a.size||1,o=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE,l=s/2,h=n/2;t.push(-l,-h,0),i.push(0,0,-1),r.push(0,CompatibilityOptions.UseOpenGLOrientationForUV?1:0),t.push(l,-h,0),i.push(0,0,-1),r.push(1,CompatibilityOptions.UseOpenGLOrientationForUV?1:0),t.push(l,h,0),i.push(0,0,-1),r.push(1,CompatibilityOptions.UseOpenGLOrientationForUV?0:1),t.push(-l,h,0),i.push(0,0,-1),r.push(0,CompatibilityOptions.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),VertexData._ComputeSides(o,t,e,i,r,a.frontUVs,a.backUVs);const u=new VertexData;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function CreatePlane(a,e={},t=null){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreatePlaneVertexData(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}VertexData.CreatePlane=CreatePlaneVertexData;Mesh.CreatePlane=(a,e,t,i,r)=>CreatePlane(a,{size:e,width:e,height:e,sideOrientation:r,updatable:i},t);Mesh._GroundMeshParser=(a,e)=>GroundMesh.Parse(a,e);class GroundMesh extends Mesh{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);const i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),r=TmpVectors.Matrix[5];i.invertToRef(r);const s=TmpVectors.Vector3[8];if(Vector3.TransformCoordinatesFromFloatsToRef(e,0,t,r,s),e=s.x,t=s.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const n=this._getFacetAt(e,t),o=-(n.x*e+n.z*t+n.w)/n.y;return Vector3.TransformCoordinatesFromFloatsToRef(0,o,0,i,s),s.y}getNormalAtCoordinates(e,t){const i=new Vector3(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const r=this.getWorldMatrix(),s=TmpVectors.Matrix[5];r.invertToRef(s);const n=TmpVectors.Vector3[8];if(Vector3.TransformCoordinatesFromFloatsToRef(e,0,t,s,n),e=n.x,t=n.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const o=this._getFacetAt(e,t);return Vector3.TransformNormalFromFloatsToRef(o.x,o.y,o.z,r,i),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),r=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),s=this._heightQuads[r*this._subdivisionsX+i];let n;return t<s.slope.x*e+s.slope.y?n=s.facet1:n=s.facet2,n}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let r=0;r<e;r++){const s={slope:Vector2.Zero(),facet1:new Vector4(0,0,0,0),facet2:new Vector4(0,0,0,0)};this._heightQuads[i*e+r]=s}return this}_computeHeightQuads(){const e=this.getVerticesData(VertexBuffer.PositionKind);if(!e)return this;const t=TmpVectors.Vector3[3],i=TmpVectors.Vector3[2],r=TmpVectors.Vector3[1],s=TmpVectors.Vector3[0],n=TmpVectors.Vector3[4],o=TmpVectors.Vector3[5],l=TmpVectors.Vector3[6],h=TmpVectors.Vector3[7],u=TmpVectors.Vector3[8];let c=0,d=0,f=0,_=0,g=0,p=0,m=0;const E=this._subdivisionsX,M=this._subdivisionsY;for(let x=0;x<M;x++)for(let A=0;A<E;A++){c=A*3,d=x*(E+1)*3,f=(x+1)*(E+1)*3,t.x=e[d+c],t.y=e[d+c+1],t.z=e[d+c+2],i.x=e[d+c+3],i.y=e[d+c+4],i.z=e[d+c+5],r.x=e[f+c],r.y=e[f+c+1],r.z=e[f+c+2],s.x=e[f+c+3],s.y=e[f+c+4],s.z=e[f+c+5],_=(s.z-t.z)/(s.x-t.x),g=t.z-_*t.x,i.subtractToRef(t,n),r.subtractToRef(t,o),s.subtractToRef(t,l),Vector3.CrossToRef(l,o,h),Vector3.CrossToRef(n,l,u),h.normalize(),u.normalize(),p=-(h.x*t.x+h.y*t.y+h.z*t.z),m=-(u.x*i.x+u.y*i.y+u.z*i.z);const T=this._heightQuads[x*E+A];T.slope.copyFromFloats(_,g),T.facet1.copyFromFloats(h.x,h.y,h.z,p),T.facet2.copyFromFloats(u.x,u.y,u.z,m)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new GroundMesh(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function CreateGroundVertexData(a){const e=[],t=[],i=[],r=[];let s,n;const o=a.width||1,l=a.height||1,h=a.subdivisionsX||a.subdivisions||1,u=a.subdivisionsY||a.subdivisions||1;for(s=0;s<=u;s++)for(n=0;n<=h;n++){const d=new Vector3(n*o/h-o/2,0,(u-s)*l/u-l/2),f=new Vector3(0,1,0);t.push(d.x,d.y,d.z),i.push(f.x,f.y,f.z),r.push(n/h,CompatibilityOptions.UseOpenGLOrientationForUV?s/u:1-s/u)}for(s=0;s<u;s++)for(n=0;n<h;n++)e.push(n+1+(s+1)*(h+1)),e.push(n+1+s*(h+1)),e.push(n+s*(h+1)),e.push(n+(s+1)*(h+1)),e.push(n+1+(s+1)*(h+1)),e.push(n+s*(h+1));const c=new VertexData;return c.indices=e,c.positions=t,c.normals=i,c.uvs=r,c}function CreateTiledGroundVertexData(a){const e=a.xmin!==void 0&&a.xmin!==null?a.xmin:-1,t=a.zmin!==void 0&&a.zmin!==null?a.zmin:-1,i=a.xmax!==void 0&&a.xmax!==null?a.xmax:1,r=a.zmax!==void 0&&a.zmax!==null?a.zmax:1,s=a.subdivisions||{w:1,h:1},n=a.precision||{w:1,h:1},o=new Array,l=new Array,h=new Array,u=new Array;let c,d,f,_;s.h=s.h<1?1:s.h,s.w=s.w<1?1:s.w,n.w=n.w<1?1:n.w,n.h=n.h<1?1:n.h;const g={w:(i-e)/s.w,h:(r-t)/s.h};function p(E,M,x,A){const T=l.length/3,C=n.w+1;for(c=0;c<n.h;c++)for(d=0;d<n.w;d++){const S=[T+d+c*C,T+(d+1)+c*C,T+(d+1)+(c+1)*C,T+d+(c+1)*C];o.push(S[1]),o.push(S[2]),o.push(S[3]),o.push(S[0]),o.push(S[1]),o.push(S[3])}const b=Vector3.Zero(),y=new Vector3(0,1,0);for(c=0;c<=n.h;c++)for(b.z=c*(A-M)/n.h+M,d=0;d<=n.w;d++)b.x=d*(x-E)/n.w+E,b.y=0,l.push(b.x,b.y,b.z),h.push(y.x,y.y,y.z),u.push(d/n.w,c/n.h)}for(f=0;f<s.h;f++)for(_=0;_<s.w;_++)p(e+_*g.w,t+f*g.h,e+(_+1)*g.w,t+(f+1)*g.h);const m=new VertexData;return m.indices=o,m.positions=l,m.normals=h,m.uvs=u,m}function CreateGroundFromHeightMapVertexData(a){const e=[],t=[],i=[],r=[];let s,n;const o=a.colorFilter||new Color3(.3,.59,.11),l=a.alphaFilter||0;let h=!1;if(a.minHeight>a.maxHeight){h=!0;const c=a.maxHeight;a.maxHeight=a.minHeight,a.minHeight=c}for(s=0;s<=a.subdivisions;s++)for(n=0;n<=a.subdivisions;n++){const c=new Vector3(n*a.width/a.subdivisions-a.width/2,0,(a.subdivisions-s)*a.height/a.subdivisions-a.height/2),d=(c.x+a.width/2)/a.width*(a.bufferWidth-1)|0,f=(1-(c.z+a.height/2)/a.height)*(a.bufferHeight-1)|0,_=(d+f*a.bufferWidth)*4;let g=a.buffer[_]/255,p=a.buffer[_+1]/255,m=a.buffer[_+2]/255;const E=a.buffer[_+3]/255;h&&(g=1-g,p=1-p,m=1-m);const M=g*o.r+p*o.g+m*o.b;E>=l?c.y=a.minHeight+(a.maxHeight-a.minHeight)*M:c.y=a.minHeight-Epsilon,t.push(c.x,c.y,c.z),i.push(0,0,0),r.push(n/a.subdivisions,1-s/a.subdivisions)}for(s=0;s<a.subdivisions;s++)for(n=0;n<a.subdivisions;n++){const c=n+1+(s+1)*(a.subdivisions+1),d=n+1+s*(a.subdivisions+1),f=n+s*(a.subdivisions+1),_=n+(s+1)*(a.subdivisions+1),g=t[c*3+1]>=a.minHeight,p=t[d*3+1]>=a.minHeight,m=t[f*3+1]>=a.minHeight;g&&p&&m&&(e.push(c),e.push(d),e.push(f)),t[_*3+1]>=a.minHeight&&g&&m&&(e.push(_),e.push(c),e.push(f))}VertexData.ComputeNormals(t,e,i);const u=new VertexData;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function CreateGround(a,e={},t){const i=new GroundMesh(a,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,CreateGroundVertexData(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function CreateTiledGround(a,e,t=null){const i=new Mesh(a,t);return CreateTiledGroundVertexData(e).applyToMesh(i,e.updatable),i}function CreateGroundFromHeightMap(a,e,t={},i=null){const r=t.width||10,s=t.height||10,n=t.subdivisions||1,o=t.minHeight||0,l=t.maxHeight||1,h=t.colorFilter||new Color3(.3,.59,.11),u=t.alphaFilter||0,c=t.updatable,d=t.onReady;i=i||EngineStore.LastCreatedScene;const f=new GroundMesh(a,i);f._subdivisionsX=n,f._subdivisionsY=n,f._width=r,f._height=s,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1);const _=g=>{const p=g.width,m=g.height;if(i.isDisposed)return;const E=i==null?void 0:i.getEngine().resizeImageBitmap(g,p,m);CreateGroundFromHeightMapVertexData({width:r,height:s,subdivisions:n,minHeight:o,maxHeight:l,colorFilter:h,buffer:E,bufferWidth:p,bufferHeight:m,alphaFilter:u}).applyToMesh(f,c),d&&d(f),f._setReady(!0)};return Tools.LoadImage(e,_,()=>{},i.offlineProvider),f}VertexData.CreateGround=CreateGroundVertexData;VertexData.CreateTiledGround=CreateTiledGroundVertexData;VertexData.CreateGroundFromHeightMap=CreateGroundFromHeightMapVertexData;Mesh.CreateGround=(a,e,t,i,r,s)=>CreateGround(a,{width:e,height:t,subdivisions:i,updatable:s},r);Mesh.CreateTiledGround=(a,e,t,i,r,s,n,o,l)=>CreateTiledGround(a,{xmin:e,zmin:t,xmax:i,zmax:r,subdivisions:s,precision:n,updatable:l},o);Mesh.CreateGroundFromHeightMap=(a,e,t,i,r,s,n,o,l,h,u)=>CreateGroundFromHeightMap(a,e,{width:t,height:i,subdivisions:r,minHeight:s,maxHeight:n,updatable:l,onReady:h,alphaFilter:u},o);function CreateTube(a,e,t=null){const i=e.path;let r=e.instance,s=1;e.radius!==void 0?s=e.radius:r&&(s=r._creationDataStorage.radius);const n=e.tessellation||64,o=e.radiusFunction||null;let l=e.cap||Mesh.NO_CAP;const h=e.invertUV||!1,u=e.updatable,c=Mesh._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;const d=(m,E,M,x,A,T,C,b)=>{const y=E.getTangents(),S=E.getNormals(),R=E.getDistances(),N=Math.PI*2/A*b,F=T||(()=>x);let U,H,X,w;const O=TmpVectors.Matrix[0];let v=C===Mesh.NO_CAP||C===Mesh.CAP_END?0:2;for(let B=0;B<m.length;B++){H=F(B,R[B]),U=Array(),X=S[B];for(let k=0;k<A;k++)Matrix.RotationAxisToRef(y[B],N*k,O),w=U[k]?U[k]:Vector3.Zero(),Vector3.TransformCoordinatesToRef(X,O,w),w.scaleInPlace(H).addInPlace(m[B]),U[k]=w;M[v]=U,v++}const D=(B,k)=>{const j=Array();for(let K=0;K<B;K++)j.push(m[k]);return j};switch(C){case Mesh.NO_CAP:break;case Mesh.CAP_START:M[0]=D(A,0),M[1]=M[2].slice(0);break;case Mesh.CAP_END:M[v]=M[v-1].slice(0),M[v+1]=D(A,m.length-1);break;case Mesh.CAP_ALL:M[0]=D(A,0),M[1]=M[2].slice(0),M[v]=M[v-1].slice(0),M[v+1]=D(A,m.length-1);break}return M};let f,_;if(r){const m=r._creationDataStorage,E=e.arc||m.arc;return f=m.path3D.update(i),_=d(i,f,m.pathArray,s,m.tessellation,o,m.cap,E),r=CreateRibbon("",{pathArray:_,instance:r}),m.path3D=f,m.pathArray=_,m.arc=E,m.radius=s,r}f=new Path3D(i);const g=new Array;l=l<0||l>3?0:l,_=d(i,f,g,s,n,o,l,e.arc);const p=CreateRibbon(a,{pathArray:_,closePath:!0,closeArray:!1,updatable:u,sideOrientation:c,invertUV:h,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return p._creationDataStorage.pathArray=_,p._creationDataStorage.path3D=f,p._creationDataStorage.tessellation=n,p._creationDataStorage.cap=l,p._creationDataStorage.arc=e.arc,p._creationDataStorage.radius=s,p}Mesh.CreateTube=(a,e,t,i,r,s,n,o,l,h)=>CreateTube(a,{path:e,radius:t,tessellation:i,radiusFunction:r,arc:1,cap:s,updatable:o,sideOrientation:l,instance:h},n);function CreatePolyhedronVertexData(a){const e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const t=a.type&&(a.type<0||a.type>=e.length)?0:a.type||0,i=a.size,r=a.sizeX||i||1,s=a.sizeY||i||1,n=a.sizeZ||i||1,o=a.custom||e[t],l=o.face.length,h=a.faceUV||new Array(l),u=a.faceColors,c=a.flat===void 0?!0:a.flat,d=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE,f=new Array,_=new Array,g=new Array,p=new Array,m=new Array;let E=0,M=0;const x=new Array;let A=0,T=0,C,b,y,S,R,P;if(c)for(T=0;T<l;T++)u&&u[T]===void 0&&(u[T]=new Color4(1,1,1,1)),h&&h[T]===void 0&&(h[T]=new Vector4(0,0,1,1));if(c)for(T=0;T<l;T++){const V=o.face[T].length;for(y=2*Math.PI/V,S=.5*Math.tan(y/2),R=.5,A=0;A<V;A++)f.push(o.vertex[o.face[T][A]][0]*r,o.vertex[o.face[T][A]][1]*s,o.vertex[o.face[T][A]][2]*n),x.push(E),E++,C=h[T].x+(h[T].z-h[T].x)*(.5+S),b=h[T].y+(h[T].w-h[T].y)*(R-.5),p.push(C,CompatibilityOptions.UseOpenGLOrientationForUV?1-b:b),P=S*Math.cos(y)-R*Math.sin(y),R=S*Math.sin(y)+R*Math.cos(y),S=P,u&&m.push(u[T].r,u[T].g,u[T].b,u[T].a);for(A=0;A<V-2;A++)_.push(x[0+M],x[A+2+M],x[A+1+M]);M+=V}else{for(A=0;A<o.vertex.length;A++)f.push(o.vertex[A][0]*r,o.vertex[A][1]*s,o.vertex[A][2]*n),p.push(0,CompatibilityOptions.UseOpenGLOrientationForUV?1:0);for(T=0;T<l;T++)for(A=0;A<o.face[T].length-2;A++)_.push(o.face[T][0],o.face[T][A+2],o.face[T][A+1])}VertexData.ComputeNormals(f,_,g),VertexData._ComputeSides(d,f,_,g,p,a.frontUVs,a.backUVs);const N=new VertexData;return N.positions=f,N.indices=_,N.normals=g,N.uvs=p,u&&c&&(N.colors=m),N}function CreatePolyhedron(a,e={},t=null){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreatePolyhedronVertexData(e).applyToMesh(i,e.updatable),i}VertexData.CreatePolyhedron=CreatePolyhedronVertexData;Mesh.CreatePolyhedron=(a,e,t)=>CreatePolyhedron(a,e,t);function CreateIcoSphereVertexData(a){const e=a.sideOrientation||VertexData.DEFAULTSIDE,t=a.radius||1,i=a.flat===void 0?!0:a.flat,r=a.subdivisions||4,s=a.radiusX||t,n=a.radiusY||t,o=a.radiusZ||t,l=(1+Math.sqrt(5))/2,h=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],u=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],c=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],d=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],f=138/1024,_=239/1024,g=60/1024,p=26/1024,m=-40/1024,E=20/1024,M=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],x=new Array,A=new Array,T=new Array,C=new Array;let b=0;const y=new Array(3),S=new Array(3);let R;for(R=0;R<3;R++)y[R]=Vector3.Zero(),S[R]=Vector2.Zero();for(let N=0;N<20;N++){for(R=0;R<3;R++){const F=u[3*N+R];y[R].copyFromFloats(h[3*c[F]],h[3*c[F]+1],h[3*c[F]+2]),y[R].normalize(),S[R].copyFromFloats(d[2*F]*f+g+M[N]*m,d[2*F+1]*_+p+M[N]*E)}const V=(F,U,H,X)=>{const w=Vector3.Lerp(y[0],y[2],U/r),O=Vector3.Lerp(y[1],y[2],U/r),v=r===U?y[2]:Vector3.Lerp(w,O,F/(r-U));v.normalize();let D;if(i){const K=Vector3.Lerp(y[0],y[2],X/r),L=Vector3.Lerp(y[1],y[2],X/r);D=Vector3.Lerp(K,L,H/(r-X))}else D=new Vector3(v.x,v.y,v.z);D.x/=s,D.y/=n,D.z/=o,D.normalize();const B=Vector2.Lerp(S[0],S[2],U/r),k=Vector2.Lerp(S[1],S[2],U/r),j=r===U?S[2]:Vector2.Lerp(B,k,F/(r-U));A.push(v.x*s,v.y*n,v.z*o),T.push(D.x,D.y,D.z),C.push(j.x,CompatibilityOptions.UseOpenGLOrientationForUV?1-j.y:j.y),x.push(b),b++};for(let F=0;F<r;F++)for(let U=0;U+F<r;U++)V(U,F,U+1/3,F+1/3),V(U+1,F,U+1/3,F+1/3),V(U,F+1,U+1/3,F+1/3),U+F+1<r&&(V(U+1,F,U+2/3,F+2/3),V(U+1,F+1,U+2/3,F+2/3),V(U,F+1,U+2/3,F+2/3))}VertexData._ComputeSides(e,A,x,T,C,a.frontUVs,a.backUVs);const P=new VertexData;return P.indices=x,P.positions=A,P.normals=T,P.uvs=C,P}function CreateIcoSphere(a,e={},t=null){const i=new Mesh(a,t);return e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CreateIcoSphereVertexData(e).applyToMesh(i,e.updatable),i}VertexData.CreateIcoSphere=CreateIcoSphereVertexData;Mesh.CreateIcoSphere=(a,e,t)=>CreateIcoSphere(a,e,t);const xpAxis=new Vector3(1,0,0),xnAxis=new Vector3(-1,0,0),ypAxis=new Vector3(0,1,0),ynAxis=new Vector3(0,-1,0),zpAxis=new Vector3(0,0,1),znAxis=new Vector3(0,0,-1);class DecalVertex{constructor(e=Vector3.Zero(),t=Vector3.Up(),i=Vector2.Zero(),r=0,s=0,n=null,o=null,l=null,h=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=r,this.vertexIdxForBones=s,this.localPositionOverride=n,this.localNormalOverride=o,this.matrixIndicesOverride=l,this.matrixWeightsOverride=h}clone(){var e,t,i,r;return new DecalVertex(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,(e=this.localPositionOverride)===null||e===void 0?void 0:e.slice(),(t=this.localNormalOverride)===null||t===void 0?void 0:t.slice(),(i=this.matrixIndicesOverride)===null||i===void 0?void 0:i.slice(),(r=this.matrixWeightsOverride)===null||r===void 0?void 0:r.slice())}}function CreateDecal(a,e,t){var i,r,s,n;const o=!!e.skeleton,l=t.localMode||o,h=e.overrideMaterialSideOrientation!==null&&e.overrideMaterialSideOrientation!==void 0,u=e.getIndices(),c=o?e.getPositionData(!0,!0):e.getVerticesData(VertexBuffer.PositionKind),d=o?e.getNormalsData(!0,!0):e.getVerticesData(VertexBuffer.NormalKind),f=l?o?e.getVerticesData(VertexBuffer.PositionKind):c:null,_=l?o?e.getVerticesData(VertexBuffer.NormalKind):d:null,g=e.getVerticesData(VertexBuffer.UVKind),p=o?e.getVerticesData(VertexBuffer.MatricesIndicesKind):null,m=o?e.getVerticesData(VertexBuffer.MatricesWeightsKind):null,E=o?e.getVerticesData(VertexBuffer.MatricesIndicesExtraKind):null,M=o?e.getVerticesData(VertexBuffer.MatricesWeightsExtraKind):null,x=t.position||Vector3.Zero();let A=t.normal||Vector3.Up();const T=t.size||Vector3.One(),C=t.angle||0;if(!A){const v=new Vector3(0,0,1),D=e.getScene().activeCamera,B=Vector3.TransformCoordinates(v,D.getWorldMatrix());A=D.globalPosition.subtract(B)}const b=-Math.atan2(A.z,A.x)-Math.PI/2,y=Math.sqrt(A.x*A.x+A.z*A.z),S=Math.atan2(A.y,y),R=new VertexData;R.indices=[],R.positions=[],R.normals=[],R.uvs=[],R.matricesIndices=o?[]:null,R.matricesWeights=o?[]:null,R.matricesIndicesExtra=E?[]:null,R.matricesWeightsExtra=M?[]:null;let P=0;const N=(v,D)=>{const B=new DecalVertex;if(!u||!c||!d)return B;const k=u[v];if(B.vertexIdx=k*3,B.vertexIdxForBones=k*4,B.position=new Vector3(c[k*3],c[k*3+1],c[k*3+2]),Vector3.TransformCoordinatesToRef(B.position,D,B.position),B.normal=new Vector3(d[k*3],d[k*3+1],d[k*3+2]),Vector3.TransformNormalToRef(B.normal,D,B.normal),t.captureUVS&&g){const j=g[k*2+1];B.uv=new Vector2(g[k*2],CompatibilityOptions.UseOpenGLOrientationForUV?1-j:j)}return B},V=[0,0,0,0],F=(v,D)=>{if(v.length===0)return v;const B=.5*Math.abs(Vector3.Dot(T,D)),k=(L,G,Z,z)=>{for(let Y=0;Y<z;++Y)if(L[Z+Y]===G)return Z+Y;return-1},j=(L,G)=>{var Z,z,Y,W,J,ee,te,ie,he,oe,Ve,Ue,ke,ze,Lt,Ft;const _e=Vector3.GetClipFactor(L.position,G.position,D,B);let yt=V,fe=V;if(p&&m){const nt=L.matrixIndicesOverride?0:L.vertexIdxForBones,zt=(Z=L.matrixIndicesOverride)!==null&&Z!==void 0?Z:p,ti=(z=L.matrixWeightsOverride)!==null&&z!==void 0?z:m,Gt=G.matrixIndicesOverride?0:G.vertexIdxForBones,ii=(Y=G.matrixIndicesOverride)!==null&&Y!==void 0?Y:p,ri=(W=G.matrixWeightsOverride)!==null&&W!==void 0?W:m;yt=[0,0,0,0],fe=[0,0,0,0];let be=0;for(let ge=0;ge<4;++ge)if(ti[nt+ge]>0){const at=k(ii,zt[nt+ge],Gt,4);yt[be]=zt[nt+ge],fe[be]=Scalar.Lerp(ti[nt+ge],at>=0?ri[at]:0,_e),be++}for(let ge=0;ge<4&&be<4;++ge){const at=ii[Gt+ge];k(zt,at,nt,4)===-1&&(yt[be]=at,fe[be]=Scalar.Lerp(0,ri[Gt+ge],_e),be++)}const bt=fe[0]+fe[1]+fe[2]+fe[3];fe[0]/=bt,fe[1]/=bt,fe[2]/=bt,fe[3]/=bt}const Zt=L.localPositionOverride?L.localPositionOverride[0]:(J=f==null?void 0:f[L.vertexIdx])!==null&&J!==void 0?J:0,qt=L.localPositionOverride?L.localPositionOverride[1]:(ee=f==null?void 0:f[L.vertexIdx+1])!==null&&ee!==void 0?ee:0,$t=L.localPositionOverride?L.localPositionOverride[2]:(te=f==null?void 0:f[L.vertexIdx+2])!==null&&te!==void 0?te:0,di=G.localPositionOverride?G.localPositionOverride[0]:(ie=f==null?void 0:f[G.vertexIdx])!==null&&ie!==void 0?ie:0,fi=G.localPositionOverride?G.localPositionOverride[1]:(he=f==null?void 0:f[G.vertexIdx+1])!==null&&he!==void 0?he:0,_i=G.localPositionOverride?G.localPositionOverride[2]:(oe=f==null?void 0:f[G.vertexIdx+2])!==null&&oe!==void 0?oe:0,jt=L.localNormalOverride?L.localNormalOverride[0]:(Ve=_==null?void 0:_[L.vertexIdx])!==null&&Ve!==void 0?Ve:0,Jt=L.localNormalOverride?L.localNormalOverride[1]:(Ue=_==null?void 0:_[L.vertexIdx+1])!==null&&Ue!==void 0?Ue:0,ei=L.localNormalOverride?L.localNormalOverride[2]:(ke=_==null?void 0:_[L.vertexIdx+2])!==null&&ke!==void 0?ke:0,gi=G.localNormalOverride?G.localNormalOverride[0]:(ze=_==null?void 0:_[G.vertexIdx])!==null&&ze!==void 0?ze:0,pi=G.localNormalOverride?G.localNormalOverride[1]:(Lt=_==null?void 0:_[G.vertexIdx+1])!==null&&Lt!==void 0?Lt:0,mi=G.localNormalOverride?G.localNormalOverride[2]:(Ft=_==null?void 0:_[G.vertexIdx+2])!==null&&Ft!==void 0?Ft:0,Nt=jt+(gi-jt)*_e,Vt=Jt+(pi-Jt)*_e,Ut=ei+(mi-ei)*_e,kt=Math.sqrt(Nt*Nt+Vt*Vt+Ut*Ut);return new DecalVertex(Vector3.Lerp(L.position,G.position,_e),Vector3.Lerp(L.normal,G.normal,_e).normalize(),Vector2.Lerp(L.uv,G.uv,_e),-1,-1,f?[Zt+(di-Zt)*_e,qt+(fi-qt)*_e,$t+(_i-$t)*_e]:null,_?[Nt/kt,Vt/kt,Ut/kt]:null,yt,fe)};let K=null;v.length>3&&(K=new Array);for(let L=0;L<v.length;L+=3){let G=0,Z=null,z=null,Y=null,W=null;const J=Vector3.Dot(v[L].position,D)-B,ee=Vector3.Dot(v[L+1].position,D)-B,te=Vector3.Dot(v[L+2].position,D)-B,ie=J>0,he=ee>0,oe=te>0;switch(G=(ie?1:0)+(he?1:0)+(oe?1:0),G){case 0:v.length>3?(K.push(v[L]),K.push(v[L+1]),K.push(v[L+2])):K=v;break;case 1:if(K=K??new Array,ie&&(Z=v[L+1],z=v[L+2],Y=j(v[L],Z),W=j(v[L],z)),he){Z=v[L],z=v[L+2],Y=j(v[L+1],Z),W=j(v[L+1],z),K.push(Y),K.push(z.clone()),K.push(Z.clone()),K.push(z.clone()),K.push(Y.clone()),K.push(W);break}oe&&(Z=v[L],z=v[L+1],Y=j(v[L+2],Z),W=j(v[L+2],z)),Z&&z&&Y&&W&&(K.push(Z.clone()),K.push(z.clone()),K.push(Y),K.push(W),K.push(Y.clone()),K.push(z.clone()));break;case 2:K=K??new Array,ie||(Z=v[L].clone(),z=j(Z,v[L+1]),Y=j(Z,v[L+2]),K.push(Z),K.push(z),K.push(Y)),he||(Z=v[L+1].clone(),z=j(Z,v[L+2]),Y=j(Z,v[L]),K.push(Z),K.push(z),K.push(Y)),oe||(Z=v[L+2].clone(),z=j(Z,v[L]),Y=j(Z,v[L+1]),K.push(Z),K.push(z),K.push(Y));break}}return K},U=e instanceof Mesh?e:null,H=U==null?void 0:U._thinInstanceDataStorage.matrixData,X=(U==null?void 0:U.thinInstanceCount)||1,w=TmpVectors.Matrix[0];w.copyFrom(Matrix.IdentityReadOnly);for(let v=0;v<X;++v){if(U!=null&&U.hasThinInstances&&H){const L=v*16;w.setRowFromFloats(0,H[L+0],H[L+1],H[L+2],H[L+3]),w.setRowFromFloats(1,H[L+4],H[L+5],H[L+6],H[L+7]),w.setRowFromFloats(2,H[L+8],H[L+9],H[L+10],H[L+11]),w.setRowFromFloats(3,H[L+12],H[L+13],H[L+14],H[L+15])}const D=Matrix.RotationYawPitchRoll(b,S,C).multiply(Matrix.Translation(x.x,x.y,x.z)),B=Matrix.Invert(D),k=e.getWorldMatrix(),j=w.multiply(k).multiply(B),K=new Array(3);for(let L=0;L<u.length;L+=3){let G=K;if(G[0]=N(L,j),h&&l?(G[1]=N(L+2,j),G[2]=N(L+1,j)):(G[1]=N(L+1,j),G[2]=N(L+2,j)),!(t.cullBackFaces&&-G[0].normal.z<=0&&-G[1].normal.z<=0&&-G[2].normal.z<=0)&&(G=F(G,xpAxis),!!G&&(G=F(G,xnAxis),!!G&&(G=F(G,ypAxis),!!G&&(G=F(G,ynAxis),!!G&&(G=F(G,zpAxis),!!G&&(G=F(G,znAxis),!!G)))))))for(let Z=0;Z<G.length;Z++){const z=G[Z];if(R.indices.push(P),l?(z.localPositionOverride?(R.positions[P*3]=z.localPositionOverride[0],R.positions[P*3+1]=z.localPositionOverride[1],R.positions[P*3+2]=z.localPositionOverride[2]):f&&(R.positions[P*3]=f[z.vertexIdx],R.positions[P*3+1]=f[z.vertexIdx+1],R.positions[P*3+2]=f[z.vertexIdx+2]),z.localNormalOverride?(R.normals[P*3]=z.localNormalOverride[0],R.normals[P*3+1]=z.localNormalOverride[1],R.normals[P*3+2]=z.localNormalOverride[2]):_&&(R.normals[P*3]=_[z.vertexIdx],R.normals[P*3+1]=_[z.vertexIdx+1],R.normals[P*3+2]=_[z.vertexIdx+2])):(z.position.toArray(R.positions,P*3),z.normal.toArray(R.normals,P*3)),R.matricesIndices&&R.matricesWeights&&(z.matrixIndicesOverride?(R.matricesIndices[P*4]=z.matrixIndicesOverride[0],R.matricesIndices[P*4+1]=z.matrixIndicesOverride[1],R.matricesIndices[P*4+2]=z.matrixIndicesOverride[2],R.matricesIndices[P*4+3]=z.matrixIndicesOverride[3]):(p&&(R.matricesIndices[P*4]=p[z.vertexIdxForBones],R.matricesIndices[P*4+1]=p[z.vertexIdxForBones+1],R.matricesIndices[P*4+2]=p[z.vertexIdxForBones+2],R.matricesIndices[P*4+3]=p[z.vertexIdxForBones+3]),E&&R.matricesIndicesExtra&&(R.matricesIndicesExtra[P*4]=E[z.vertexIdxForBones],R.matricesIndicesExtra[P*4+1]=E[z.vertexIdxForBones+1],R.matricesIndicesExtra[P*4+2]=E[z.vertexIdxForBones+2],R.matricesIndicesExtra[P*4+3]=E[z.vertexIdxForBones+3])),z.matrixWeightsOverride?(R.matricesWeights[P*4]=z.matrixWeightsOverride[0],R.matricesWeights[P*4+1]=z.matrixWeightsOverride[1],R.matricesWeights[P*4+2]=z.matrixWeightsOverride[2],R.matricesWeights[P*4+3]=z.matrixWeightsOverride[3]):(m&&(R.matricesWeights[P*4]=m[z.vertexIdxForBones],R.matricesWeights[P*4+1]=m[z.vertexIdxForBones+1],R.matricesWeights[P*4+2]=m[z.vertexIdxForBones+2],R.matricesWeights[P*4+3]=m[z.vertexIdxForBones+3]),M&&R.matricesWeightsExtra&&(R.matricesWeightsExtra[P*4]=M[z.vertexIdxForBones],R.matricesWeightsExtra[P*4+1]=M[z.vertexIdxForBones+1],R.matricesWeightsExtra[P*4+2]=M[z.vertexIdxForBones+2],R.matricesWeightsExtra[P*4+3]=M[z.vertexIdxForBones+3]))),t.captureUVS)z.uv.toArray(R.uvs,P*2);else{R.uvs.push(.5+z.position.x/T.x);const Y=.5+z.position.y/T.y;R.uvs.push(CompatibilityOptions.UseOpenGLOrientationForUV?1-Y:Y)}P++}}}R.indices.length===0&&(R.indices=null),R.positions.length===0&&(R.positions=null),R.normals.length===0&&(R.normals=null),R.uvs.length===0&&(R.uvs=null),((i=R.matricesIndices)===null||i===void 0?void 0:i.length)===0&&(R.matricesIndices=null),((r=R.matricesWeights)===null||r===void 0?void 0:r.length)===0&&(R.matricesWeights=null),((s=R.matricesIndicesExtra)===null||s===void 0?void 0:s.length)===0&&(R.matricesIndicesExtra=null),((n=R.matricesWeightsExtra)===null||n===void 0?void 0:n.length)===0&&(R.matricesWeightsExtra=null);const O=new Mesh(a,e.getScene());return R.applyToMesh(O),l?(O.skeleton=e.skeleton,O.parent=e):(O.position=x.clone(),O.rotation=new Vector3(S,b,C)),O.computeWorldMatrix(!0),O.refreshBoundingInfo(!0,!0),O}Mesh.CreateDecal=(a,e,t,i,r,s)=>CreateDecal(a,e,{position:t,normal:i,size:r,angle:s});function CreateCapsuleVertexData(a={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){const e=Math.max(a.subdivisions?a.subdivisions:2,1),t=Math.max(a.tessellation?a.tessellation:16,3),i=Math.max(a.height?a.height:1,0),r=Math.max(a.radius?a.radius:.25,0),s=Math.max(a.capSubdivisions?a.capSubdivisions:6,1),n=t,o=e,l=Math.max(a.radiusTop?a.radiusTop:r,0),h=Math.max(a.radiusBottom?a.radiusBottom:r,0),u=i-(l+h),c=0,d=2*Math.PI,f=Math.max(a.topCapSubdivisions?a.topCapSubdivisions:s,1),_=Math.max(a.bottomCapSubdivisions?a.bottomCapSubdivisions:s,1),g=Math.acos((h-l)/i);let p=[];const m=[],E=[],M=[];let x=0;const A=[],T=u*.5,C=Math.PI*.5;let b,y;const S=Vector3.Zero(),R=Vector3.Zero(),P=Math.cos(g),N=Math.sin(g),V=new Vector2(l*N,T+l*P).subtract(new Vector2(h*N,-T+h*P)).length(),F=l*g+V+h*(C-g);let U=0;for(y=0;y<=f;y++){const O=[],v=C-g*(y/f);U+=l*g/f;const D=Math.cos(v),B=Math.sin(v),k=D*l;for(b=0;b<=n;b++){const j=b/n,K=j*d+c,L=Math.sin(K),G=Math.cos(K);R.x=k*L,R.y=T+B*l,R.z=k*G,m.push(R.x,R.y,R.z),S.set(D*L,B,D*G),E.push(S.x,S.y,S.z),M.push(j,CompatibilityOptions.UseOpenGLOrientationForUV?U/F:1-U/F),O.push(x),x++}A.push(O)}const H=i-l-h+P*l-P*h,X=N*(h-l)/H;for(y=1;y<=o;y++){const O=[];U+=V/o;const v=N*(y*(h-l)/o+l);for(b=0;b<=n;b++){const D=b/n,B=D*d+c,k=Math.sin(B),j=Math.cos(B);R.x=v*k,R.y=T+P*l-y*H/o,R.z=v*j,m.push(R.x,R.y,R.z),S.set(k,X,j).normalize(),E.push(S.x,S.y,S.z),M.push(D,CompatibilityOptions.UseOpenGLOrientationForUV?U/F:1-U/F),O.push(x),x++}A.push(O)}for(y=1;y<=_;y++){const O=[],v=C-g-(Math.PI-g)*(y/_);U+=h*g/_;const D=Math.cos(v),B=Math.sin(v),k=D*h;for(b=0;b<=n;b++){const j=b/n,K=j*d+c,L=Math.sin(K),G=Math.cos(K);R.x=k*L,R.y=-T+B*h,R.z=k*G,m.push(R.x,R.y,R.z),S.set(D*L,B,D*G),E.push(S.x,S.y,S.z),M.push(j,CompatibilityOptions.UseOpenGLOrientationForUV?U/F:1-U/F),O.push(x),x++}A.push(O)}for(b=0;b<n;b++)for(y=0;y<f+o+_;y++){const O=A[y][b],v=A[y+1][b],D=A[y+1][b+1],B=A[y][b+1];p.push(O),p.push(v),p.push(B),p.push(v),p.push(D),p.push(B)}if(p=p.reverse(),a.orientation&&!a.orientation.equals(Vector3.Up())){const O=new Matrix;a.orientation.clone().scale(Math.PI*.5).cross(Vector3.Up()).toQuaternion().toRotationMatrix(O);const v=Vector3.Zero();for(let D=0;D<m.length;D+=3)v.set(m[D],m[D+1],m[D+2]),Vector3.TransformCoordinatesToRef(v.clone(),O,v),m[D]=v.x,m[D+1]=v.y,m[D+2]=v.z}const w=new VertexData;return w.positions=m,w.normals=E,w.uvs=M,w.indices=p,w}function CreateCapsule(a,e={orientation:Vector3.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},t=null){const i=new Mesh(a,t);return CreateCapsuleVertexData(e).applyToMesh(i,e.updatable),i}Mesh.CreateCapsule=(a,e,t)=>CreateCapsule(a,e,t);VertexData.CreateCapsule=CreateCapsuleVertexData;class _IsoVector{constructor(e=0,t=0){this.x=e,this.y=t,e!==Math.floor(e)&&Logger.Warn("x is not an integer, floor(x) used"),t!==Math.floor(t)&&Logger.Warn("y is not an integer, floor(y) used")}clone(){return new _IsoVector(this.x,this.y)}rotate60About(e){const t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this}rotateNeg60About(e){const t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this}rotate120(e,t){e!==Math.floor(e)&&Logger.Warn("m not an integer only floor(m) used"),t!==Math.floor(t)&&Logger.Warn("n not an integer only floor(n) used");const i=this.x;return this.x=e-i-this.y,this.y=t+i,this}rotateNeg120(e,t){e!==Math.floor(e)&&Logger.Warn("m is not an integer, floor(m) used"),t!==Math.floor(t)&&Logger.Warn("n is not an integer,   floor(n) used");const i=this.x;return this.x=this.y-t,this.y=e+t-i-this.y,this}toCartesianOrigin(e,t){const i=Vector3.Zero();return i.x=e.x+2*this.x*t+this.y*t,i.y=e.y+Math.sqrt(3)*this.y*t,i}static Zero(){return new _IsoVector(0,0)}}class _PrimaryIsoTriangle{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new PolyhedronData("icosahedron","Regular",[[0,PHI,-1],[-PHI,1,0],[-1,0,-PHI],[1,0,-PHI],[PHI,1,0],[0,PHI,1],[-1,0,PHI],[-PHI,-1,0],[0,-PHI,-1],[PHI,-1,0],[1,0,PHI],[0,-PHI,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let e=12;const t={},i=this.m,r=this.n;let s=i,n=1,o=0;r!==0&&(s=Scalar.HCF(i,r)),n=i/s,o=r/s;let l,h,u,c,d;const f=_IsoVector.Zero(),_=new _IsoVector(i,r),g=new _IsoVector(-r,i+r),p=_IsoVector.Zero(),m=_IsoVector.Zero(),E=_IsoVector.Zero();let M=[],x,A,T,C;const b=[],y=this.vertByDist,S=(R,P,N,V)=>{x=R+"|"+N,A=P+"|"+V,x in t||A in t?x in t&&!(A in t)?t[A]=t[x]:A in t&&!(x in t)&&(t[x]=t[A]):(t[x]=e,t[A]=e,e++),y[N][0]>2?b[t[x]]=[-y[N][0],y[N][1],t[x]]:b[t[x]]=[M[y[N][0]],y[N][1],t[x]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let R=0;R<20;R++){if(M=this.IDATA.face[R],u=M[2],c=M[1],d=M[0],T=f.x+"|"+f.y,x=R+"|"+T,x in t||(t[x]=u,b[u]=[M[y[T][0]],y[T][1]]),T=_.x+"|"+_.y,x=R+"|"+T,x in t||(t[x]=c,b[c]=[M[y[T][0]],y[T][1]]),T=g.x+"|"+g.y,x=R+"|"+T,x in t||(t[x]=d,b[d]=[M[y[T][0]],y[T][1]]),l=this.IDATA.edgematch[R][0],h=this.IDATA.edgematch[R][1],h==="B")for(let P=1;P<s;P++)m.x=i-P*(n+o),m.y=r+P*n,E.x=-P*o,E.y=P*(n+o),T=m.x+"|"+m.y,C=E.x+"|"+E.y,S(R,l,T,C);if(h==="O")for(let P=1;P<s;P++)E.x=-P*o,E.y=P*(n+o),p.x=P*n,p.y=P*o,T=E.x+"|"+E.y,C=p.x+"|"+p.y,S(R,l,T,C);if(l=this.IDATA.edgematch[R][2],h=this.IDATA.edgematch[R][3],h&&h==="A")for(let P=1;P<s;P++)p.x=P*n,p.y=P*o,m.x=i-(s-P)*(n+o),m.y=r+(s-P)*n,T=p.x+"|"+p.y,C=m.x+"|"+m.y,S(R,l,T,C);for(let P=0;P<this.vertices.length;P++)T=this.vertices[P].x+"|"+this.vertices[P].y,x=R+"|"+T,x in t||(t[x]=e++,y[T][0]>2?b[t[x]]=[-y[T][0],y[T][1],t[x]]:b[t[x]]=[M[y[T][0]],y[T][1],t[x]])}this.closestTo=b,this.vecToidx=t}calcCoeffs(){const e=this.m,t=this.n,i=Math.sqrt(3)/3,r=e*e+t*t+e*t;this.coau=(e+t)/r,this.cobu=-t/r,this.coav=-i*(e-t)/r,this.cobv=i*(2*e+t)/r}createInnerFacets(){const e=this.m,t=this.n;for(let i=0;i<t+e+1;i++)for(let r=this.min[i];r<this.max[i]+1;r++)r<this.max[i]&&r<this.max[i+1]+1&&this.innerFacets.push(["|"+r+"|"+i,"|"+r+"|"+(i+1),"|"+(r+1)+"|"+i]),i>0&&r<this.max[i-1]&&r+1<this.max[i]+1&&this.innerFacets.push(["|"+r+"|"+i,"|"+(r+1)+"|"+i,"|"+(r+1)+"|"+(i-1)])}edgeVecsABOB(){const e=this.m,t=this.n,i=new _IsoVector(-t,e+t);for(let r=1;r<e+t;r++){const s=new _IsoVector(this.min[r],r),n=new _IsoVector(this.min[r-1],r-1),o=new _IsoVector(this.min[r+1],r+1),l=s.clone(),h=n.clone(),u=o.clone();l.rotate60About(i),h.rotate60About(i),u.rotate60About(i);const c=new _IsoVector(this.max[l.y],l.y),d=new _IsoVector(this.max[l.y-1],l.y-1),f=new _IsoVector(this.max[l.y-1]-1,l.y-1);(l.x!==c.x||l.y!==c.y)&&(l.x!==d.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,f]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,f,c])):l.y===u.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,n,d]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([s,d,o])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,n,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,c])))}}mapABOBtoOBOA(){const e=new _IsoVector(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===0&&e.rotateNeg120(this.m,this.n),i.push(e.clone());this.isoVecsOBOA.push(i)}}mapABOBtoBAOA(){const e=new _IsoVector(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===1&&e.rotate120(this.m,this.n),i.push(e.clone());this.isoVecsBAOA.push(i)}}MapToFace(e,t){const i=this.IDATA.face[e],r=i[2],s=i[1],n=i[0],o=Vector3.FromArray(this.IDATA.vertex[r]),l=Vector3.FromArray(this.IDATA.vertex[s]),h=Vector3.FromArray(this.IDATA.vertex[n]),u=l.subtract(o),c=h.subtract(o),d=u.scale(this.coau).add(c.scale(this.cobu)),f=u.scale(this.coav).add(c.scale(this.cobv));let _,g=TmpVectors.Vector3[0];for(let p=0;p<this.cartesian.length;p++)g=d.scale(this.cartesian[p].x).add(f.scale(this.cartesian[p].y)).add(o),g.x,g.y,g.z,_=e+"|"+this.vertices[p].x+"|"+this.vertices[p].y,t.vertex[this.vecToidx[_]]=[g.x,g.y,g.z]}build(e,t){const i=new Array,r=_IsoVector.Zero(),s=new _IsoVector(e,t),n=new _IsoVector(-t,e+t);i.push(r,s,n);for(let A=t;A<e+1;A++)for(let T=0;T<e+1-A;T++)i.push(new _IsoVector(T,A));if(t>0){const A=Scalar.HCF(e,t),T=e/A,C=t/A;for(let y=1;y<A;y++)i.push(new _IsoVector(y*T,y*C)),i.push(new _IsoVector(-y*C,y*(T+C))),i.push(new _IsoVector(e-y*(T+C),t+y*T));const b=e/t;for(let y=1;y<t;y++)for(let S=0;S<y*b;S++)i.push(new _IsoVector(S,y)),i.push(new _IsoVector(S,y).rotate120(e,t)),i.push(new _IsoVector(S,y).rotateNeg120(e,t))}i.sort((A,T)=>A.x-T.x),i.sort((A,T)=>A.y-T.y);const o=new Array(e+t+1),l=new Array(e+t+1);for(let A=0;A<o.length;A++)o[A]=1/0,l[A]=-1/0;let h=0,u=0;const c=i.length;for(let A=0;A<c;A++)u=i[A].x,h=i[A].y,o[h]=Math.min(u,o[h]),l[h]=Math.max(u,l[h]);const d=(A,T)=>{const C=A.clone();return T==="A"&&C.rotateNeg120(e,t),T==="B"&&C.rotate120(e,t),C.x<0?C.y:C.x+C.y},f=[],_=[],g=[],p=[],m={},E=[];let M=-1,x=-1;for(let A=0;A<c;A++)f[A]=i[A].toCartesianOrigin(new _IsoVector(0,0),.5),_[A]=d(i[A],"O"),g[A]=d(i[A],"A"),p[A]=d(i[A],"B"),_[A]===g[A]&&g[A]===p[A]?(M=3,x=_[A]):_[A]===g[A]?(M=4,x=_[A]):g[A]===p[A]?(M=5,x=g[A]):p[A]===_[A]&&(M=6,x=_[A]),_[A]<g[A]&&_[A]<p[A]&&(M=2,x=_[A]),g[A]<_[A]&&g[A]<p[A]&&(M=1,x=g[A]),p[A]<g[A]&&p[A]<_[A]&&(M=0,x=p[A]),E.push([M,x,i[A].x,i[A].y]);E.sort((A,T)=>A[2]-T[2]),E.sort((A,T)=>A[3]-T[3]),E.sort((A,T)=>A[1]-T[1]),E.sort((A,T)=>A[0]-T[0]);for(let A=0;A<E.length;A++)m[E[A][2]+"|"+E[A][3]]=[E[A][0],E[A][1],A];return this.m=e,this.n=t,this.vertices=i,this.vertByDist=m,this.cartesian=f,this.min=o,this.max=l,this}}class PolyhedronData{constructor(e,t,i,r){this.name=e,this.category=t,this.vertex=i,this.face=r}}class GeodesicData extends PolyhedronData{innerToData(e,t){for(let i=0;i<t.innerFacets.length;i++)this.face.push(t.innerFacets[i].map(r=>t.vecToidx[e+r]))}mapABOBtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsABOB.length;r++){const s=[];for(let n=0;n<3;n++)t.vertexTypes[r][n]===0?s.push(e+"|"+t.isoVecsABOB[r][n].x+"|"+t.isoVecsABOB[r][n].y):s.push(i+"|"+t.isoVecsABOB[r][n].x+"|"+t.isoVecsABOB[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapOBOAtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsOBOA.length;r++){const s=[];for(let n=0;n<3;n++)t.vertexTypes[r][n]===1?s.push(e+"|"+t.isoVecsOBOA[r][n].x+"|"+t.isoVecsOBOA[r][n].y):s.push(i+"|"+t.isoVecsOBOA[r][n].x+"|"+t.isoVecsOBOA[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapBAOAtoDATA(e,t){const i=t.IDATA.edgematch[e][2];for(let r=0;r<t.isoVecsBAOA.length;r++){const s=[];for(let n=0;n<3;n++)t.vertexTypes[r][n]===1?s.push(e+"|"+t.isoVecsBAOA[r][n].x+"|"+t.isoVecsBAOA[r][n].y):s.push(i+"|"+t.isoVecsBAOA[r][n].x+"|"+t.isoVecsBAOA[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}orderData(e){const t=[];for(let n=0;n<13;n++)t[n]=[];const i=e.closestTo;for(let n=0;n<i.length;n++)i[n][0]>-1?i[n][1]>0&&t[i[n][0]].push([n,i[n][1]]):t[12].push([n,i[n][0]]);const r=[];for(let n=0;n<12;n++)r[n]=n;let s=12;for(let n=0;n<12;n++){t[n].sort((o,l)=>o[1]-l[1]);for(let o=0;o<t[n].length;o++)r[t[n][o][0]]=s++}for(let n=0;n<t[12].length;n++)r[t[12][n][0]]=s++;for(let n=0;n<this.vertex.length;n++)this.vertex[n].push(r[n]);this.vertex.sort((n,o)=>n[3]-o[3]);for(let n=0;n<this.vertex.length;n++)this.vertex[n].pop();for(let n=0;n<this.face.length;n++)for(let o=0;o<this.face[n].length;o++)this.face[n][o]=r[this.face[n][o]];this.sharedNodes=t[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(e,t){const i=[],r=[];let s=t.pop();r.push(s);let n=this.face[s].indexOf(e);n=(n+2)%3;let o=this.face[s][n];i.push(o);let l=0;for(;t.length>0;)s=t[l],this.face[s].indexOf(o)>-1?(n=(this.face[s].indexOf(o)+1)%3,o=this.face[s][n],i.push(o),r.push(s),t.splice(l,1),l=0):l++;return this.adjacentFaces.push(i),r}toGoldbergPolyhedronData(){const e=new PolyhedronData("GeoDual","Goldberg",[],[]);e.name="GD dual";const t=this.vertex.length,i=new Array(t);for(let h=0;h<t;h++)i[h]=[];for(let h=0;h<this.face.length;h++)for(let u=0;u<3;u++)i[this.face[h][u]].push(h);let r=0,s=0,n=0,o=[],l=[];this.adjacentFaces=[];for(let h=0;h<i.length;h++)e.face[h]=this.setOrder(h,i[h].concat([])),i[h].forEach(u=>{r=0,s=0,n=0,o=this.face[u];for(let c=0;c<3;c++)l=this.vertex[o[c]],r+=l[0],s+=l[1],n+=l[2];e.vertex[u]=[r/3,s/3,n/3]});return e}static BuildGeodesicData(e){const t=new GeodesicData("Geodesic-m-n","Geodesic",[[0,PHI,-1],[-PHI,1,0],[-1,0,-PHI],[1,0,-PHI],[PHI,1,0],[0,PHI,1],[-1,0,PHI],[-PHI,-1,0],[0,-PHI,-1],[PHI,-1,0],[1,0,PHI],[0,-PHI,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(let r=0;r<e.IDATA.face.length;r++)e.MapToFace(r,t),t.innerToData(r,e),e.IDATA.edgematch[r][1]==="B"&&t.mapABOBtoDATA(r,e),e.IDATA.edgematch[r][1]==="O"&&t.mapOBOAtoDATA(r,e),e.IDATA.edgematch[r][3]==="A"&&t.mapBAOAtoDATA(r,e);t.orderData(e);const i=1;return t.vertex=t.vertex.map(function(r){const s=r[0],n=r[1],o=r[2],l=Math.sqrt(s*s+n*n+o*o);return r[0]*=i/l,r[1]*=i/l,r[2]*=i/l,r}),t}}function CreateGeodesic(a,e,t=null){let i=e.m||1;i!==Math.floor(i)&&Logger.Warn("m not an integer only floor(m) used");let r=e.n||0;if(r!==Math.floor(r)&&Logger.Warn("n not an integer only floor(n) used"),r>i){const h=r;r=i,i=h,Logger.Warn("n > m therefore m and n swapped")}const s=new _PrimaryIsoTriangle;s.build(i,r);const o={custom:GeodesicData.BuildGeodesicData(s),size:e.size,sizeX:e.sizeX,sizeY:e.sizeY,sizeZ:e.sizeZ,faceUV:e.faceUV,faceColors:e.faceColors,flat:e.flat,updatable:e.updatable,sideOrientation:e.sideOrientation,frontUVs:e.frontUVs,backUVs:e.backUVs};return CreatePolyhedron(a,o,t)}Mesh._GoldbergMeshParser=(a,e)=>GoldbergMesh.Parse(a,e);class GoldbergMesh extends Mesh{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return t===void 0?(e>this.goldbergData.nbUnsharedFaces-1&&(Logger.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(Logger.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(Logger.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let i=0;i<e.length;i++){const r=e[i][0],s=e[i][1],n=e[i][2];for(let o=r;o<s+1;o++)this.goldbergData.faceColors[o]=n}const t=[];for(let i=0;i<12;i++)for(let r=0;r<5;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);for(let i=12;i<this.goldbergData.faceColors.length;i++)for(let r=0;r<6;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);return t}setGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.setVerticesData(VertexBuffer.ColorKind,t)}updateGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.updateVerticesData(VertexBuffer.ColorKind,t)}_changeGoldbergFaceUVs(e){const t=this.getVerticesData(VertexBuffer.UVKind);for(let i=0;i<e.length;i++){const r=e[i][0],s=e[i][1],n=e[i][2],o=e[i][3],l=e[i][4],h=[],u=[];let c,d;for(let f=0;f<5;f++)c=n.x+o*Math.cos(l+f*Math.PI/2.5),d=n.y+o*Math.sin(l+f*Math.PI/2.5),c<0&&(c=0),c>1&&(c=1),h.push(c,d);for(let f=0;f<6;f++)c=n.x+o*Math.cos(l+f*Math.PI/3),d=n.y+o*Math.sin(l+f*Math.PI/3),c<0&&(c=0),c>1&&(c=1),u.push(c,d);for(let f=r;f<Math.min(12,s+1);f++)for(let _=0;_<5;_++)t[10*f+2*_]=h[2*_],t[10*f+2*_+1]=h[2*_+1];for(let f=Math.max(12,r);f<s+1;f++)for(let _=0;_<6;_++)t[12*f-24+2*_]=u[2*_],t[12*f-23+2*_]=u[2*_+1]}return t}setGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.setVerticesData(VertexBuffer.UVKind,t)}updateGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(VertexBuffer.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){const r=Vector3.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=r,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";const t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(const i of this.goldbergData.faceColors)t.faceColors.push(i.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(const i of this.goldbergData.faceCenters)t.faceCenters.push(i.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(const i of this.goldbergData.faceZaxis)t.faceZaxis.push(i.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(const i of this.goldbergData.faceYaxis)t.faceYaxis.push(i.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(const i of this.goldbergData.faceXaxis)t.faceXaxis.push(i.asArray())}e.goldbergData=t}static Parse(e,t){const i=e.goldbergData;i.faceColors=i.faceColors.map(s=>Color4.FromArray(s)),i.faceCenters=i.faceCenters.map(s=>Vector3.FromArray(s)),i.faceZaxis=i.faceZaxis.map(s=>Vector3.FromArray(s)),i.faceXaxis=i.faceXaxis.map(s=>Vector3.FromArray(s)),i.faceYaxis=i.faceYaxis.map(s=>Vector3.FromArray(s));const r=new GoldbergMesh(e.name,t);return r.goldbergData=i,r}}function CreateGoldbergVertexData(a,e){const t=a.size,i=a.sizeX||t||1,r=a.sizeY||t||1,s=a.sizeZ||t||1,n=a.sideOrientation===0?0:a.sideOrientation||VertexData.DEFAULTSIDE,o=new Array,l=new Array,h=new Array,u=new Array;let c=1/0,d=-1/0,f=1/0,_=-1/0;for(let m=0;m<e.vertex.length;m++)c=Math.min(c,e.vertex[m][0]*i),d=Math.max(d,e.vertex[m][0]*i),f=Math.min(f,e.vertex[m][1]*r),_=Math.max(_,e.vertex[m][1]*r);let g=0;for(let m=0;m<e.face.length;m++){const E=e.face[m],M=Vector3.FromArray(e.vertex[E[0]]),x=Vector3.FromArray(e.vertex[E[2]]),A=Vector3.FromArray(e.vertex[E[1]]),T=x.subtract(M),C=A.subtract(M),b=Vector3.Cross(C,T).normalize();for(let y=0;y<E.length;y++){h.push(b.x,b.y,b.z);const S=e.vertex[E[y]];o.push(S[0]*i,S[1]*r,S[2]*s);const R=(S[1]*r-f)/(_-f);u.push((S[0]*i-c)/(d-c),CompatibilityOptions.UseOpenGLOrientationForUV?1-R:R)}for(let y=0;y<E.length-2;y++)l.push(g,g+y+2,g+y+1);g+=E.length}VertexData._ComputeSides(n,o,l,h,u);const p=new VertexData;return p.positions=o,p.indices=l,p.normals=h,p.uvs=u,p}function CreateGoldberg(a,e,t=null){const i=e.size,r=e.sizeX||i||1,s=e.sizeY||i||1,n=e.sizeZ||i||1;let o=e.m||1;o!==Math.floor(o)&&Logger.Warn("m not an integer only floor(m) used");let l=e.n||0;if(l!==Math.floor(l)&&Logger.Warn("n not an integer only floor(n) used"),l>o){const _=l;l=o,o=_,Logger.Warn("n > m therefore m and n swapped")}const h=new _PrimaryIsoTriangle;h.build(o,l);const u=GeodesicData.BuildGeodesicData(h),c=u.toGoldbergPolyhedronData(),d=new GoldbergMesh(a,t);e.sideOrientation=Mesh._GetDefaultSideOrientation(e.sideOrientation),d._originalBuilderSideOrientation=e.sideOrientation,CreateGoldbergVertexData(e,c).applyToMesh(d,e.updatable),d.goldbergData.nbSharedFaces=u.sharedNodes,d.goldbergData.nbUnsharedFaces=u.poleNodes,d.goldbergData.adjacentFaces=u.adjacentFaces,d.goldbergData.nbFaces=d.goldbergData.nbSharedFaces+d.goldbergData.nbUnsharedFaces,d.goldbergData.nbFacesAtPole=(d.goldbergData.nbUnsharedFaces-12)/12;for(let _=0;_<u.vertex.length;_++)d.goldbergData.faceCenters.push(Vector3.FromArray(u.vertex[_])),d.goldbergData.faceCenters[_].x*=r,d.goldbergData.faceCenters[_].y*=s,d.goldbergData.faceCenters[_].z*=n,d.goldbergData.faceColors.push(new Color4(1,1,1,1));for(let _=0;_<c.face.length;_++){const g=c.face[_],p=Vector3.FromArray(c.vertex[g[0]]),m=Vector3.FromArray(c.vertex[g[2]]),E=Vector3.FromArray(c.vertex[g[1]]),M=m.subtract(p),x=E.subtract(p),A=Vector3.Cross(x,M).normalize(),T=Vector3.Cross(x,A).normalize();d.goldbergData.faceXaxis.push(x.normalize()),d.goldbergData.faceYaxis.push(A),d.goldbergData.faceZaxis.push(T)}return d}Mesh.CreateGoldberg=CreateGoldberg;class ShapePath{constructor(e){this._paths=[],this._tempPaths=[],this._holes=[],this._resolution=e}moveTo(e,t){this._currentPath=new Path2(e,t),this._tempPaths.push(this._currentPath)}lineTo(e,t){this._currentPath.addLineTo(e,t)}quadraticCurveTo(e,t,i,r){this._currentPath.addQuadraticCurveTo(e,t,i,r,this._resolution)}bezierCurveTo(e,t,i,r,s,n){this._currentPath.addBezierCurveTo(e,t,i,r,s,n,this._resolution)}extractHoles(){for(const e of this._tempPaths)e.area()>0?this._holes.push(e):this._paths.push(e);if(!this._paths.length&&this._holes.length){const e=this._holes;this._holes=this._paths,this._paths=e}this._tempPaths.length=0}get paths(){return this._paths}get holes(){return this._holes}}function CreateShapePath(a,e,t,i,r,s){const n=s.glyphs[a]||s.glyphs["?"];if(!n)return null;const o=new ShapePath(r);if(n.o){const l=n.o.split(" ");for(let h=0,u=l.length;h<u;)switch(l[h++]){case"m":{const d=parseInt(l[h++])*e+t,f=parseInt(l[h++])*e+i;o.moveTo(d,f);break}case"l":{const d=parseInt(l[h++])*e+t,f=parseInt(l[h++])*e+i;o.lineTo(d,f);break}case"q":{const d=parseInt(l[h++])*e+t,f=parseInt(l[h++])*e+i,_=parseInt(l[h++])*e+t,g=parseInt(l[h++])*e+i;o.quadraticCurveTo(_,g,d,f);break}case"b":{const d=parseInt(l[h++])*e+t,f=parseInt(l[h++])*e+i,_=parseInt(l[h++])*e+t,g=parseInt(l[h++])*e+i,p=parseInt(l[h++])*e+t,m=parseInt(l[h++])*e+i;o.bezierCurveTo(_,g,p,m,d,f);break}}}return o.extractHoles(),{offsetX:n.ha*e,shapePath:o}}function CreateTextShapePaths(a,e,t,i){const r=Array.from(a),s=e/i.resolution,n=(i.boundingBox.yMax-i.boundingBox.yMin+i.underlineThickness)*s,o=[];let l=0,h=0;for(let u=0;u<r.length;u++){const c=r[u];if(c===`
`)l=0,h-=n;else{const d=CreateShapePath(c,s,l,h,t,i);d&&(l+=d.offsetX,o.push(d.shapePath))}}return o}function CreateText(a,e,t,i={size:50,resolution:8,depth:1},r=null,s=earcut){const n=CreateTextShapePaths(e,i.size||50,i.resolution||8,t),o=[];for(const h of n){if(!h.paths.length)continue;const u=h.holes.slice();for(const c of h.paths){const d=[],f=[],_=c.getPoints();for(const m of _)f.push(new Vector3(m.x,0,m.y));const g=u.slice();for(const m of g){const E=m.getPoints();let M=!1;for(const A of E)if(c.isPointInside(A)){M=!0;break}if(!M)continue;const x=[];for(const A of E)x.push(new Vector3(A.x,0,A.y));d.push(x),u.splice(u.indexOf(m),1)}if(!d.length&&u.length)for(const m of u){const E=m.getPoints(),M=[];for(const x of E)M.push(new Vector3(x.x,0,x.y));d.push(M)}const p=ExtrudePolygon(a,{shape:f,holes:d.length?d:void 0,depth:i.depth||1,sideOrientation:Mesh._GetDefaultSideOrientation(i.sideOrientation||Mesh.DOUBLESIDE)},r,s);o.push(p)}}const l=Mesh.MergeMeshes(o,!0,!0);if(l){const h=l==null?void 0:l.getBoundingInfo();l.position.x=-(h==null?void 0:h.boundingBox.extendSizeWorld._x),l.position.y=-(h==null?void 0:h.boundingBox.extendSizeWorld._y),l.position.z=-(h==null?void 0:h.boundingBox.extendSizeWorld._z),l.name=a,l.rotation.x=-Math.PI/2,l.bakeCurrentTransformIntoVertices()}return l}const MeshBuilder={CreateBox,CreateTiledBox,CreateSphere,CreateDisc,CreateIcoSphere,CreateRibbon,CreateCylinder,CreateTorus,CreateTorusKnot,CreateLineSystem,CreateLines,CreateDashedLines,ExtrudeShape,ExtrudeShapeCustom,CreateLathe,CreateTiledPlane,CreatePlane,CreateGround,CreateTiledGround,CreateGroundFromHeightMap,CreatePolygon,ExtrudePolygon,CreateTube,CreatePolyhedron,CreateGeodesic,CreateGoldberg,CreateDecal,CreateCapsule,CreateText};class PrePassConfiguration{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,r,s){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&t.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=r.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const n=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==n.frameId&&(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=r.clone()}}}class MaterialFlags{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,Engine.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,Engine.MarkAllMaterialsAsDirty(1))}}MaterialFlags._DiffuseTextureEnabled=!0;MaterialFlags._DetailTextureEnabled=!0;MaterialFlags._DecalMapEnabled=!0;MaterialFlags._AmbientTextureEnabled=!0;MaterialFlags._OpacityTextureEnabled=!0;MaterialFlags._ReflectionTextureEnabled=!0;MaterialFlags._EmissiveTextureEnabled=!0;MaterialFlags._SpecularTextureEnabled=!0;MaterialFlags._BumpTextureEnabled=!0;MaterialFlags._LightmapTextureEnabled=!0;MaterialFlags._RefractionTextureEnabled=!0;MaterialFlags._ColorGradingTextureEnabled=!0;MaterialFlags._FresnelEnabled=!0;MaterialFlags._ClearCoatTextureEnabled=!0;MaterialFlags._ClearCoatBumpTextureEnabled=!0;MaterialFlags._ClearCoatTintTextureEnabled=!0;MaterialFlags._SheenTextureEnabled=!0;MaterialFlags._AnisotropicTextureEnabled=!0;MaterialFlags._ThicknessTextureEnabled=!0;MaterialFlags._RefractionIntensityTextureEnabled=!0;MaterialFlags._TranslucencyIntensityTextureEnabled=!0;MaterialFlags._IridescenceTextureEnabled=!0;const name$U="decalFragmentDeclaration",shader$U=`#ifdef DECAL
uniform vec4 vDecalInfos;
#endif
`;ShaderStore.IncludesShadersStore[name$U]=shader$U;const name$T="defaultFragmentDeclaration",shader$T=`uniform vec4 vEyePosition;
uniform vec4 vDiffuseColor;
#ifdef SPECULARTERM
uniform vec4 vSpecularColor;
#endif
uniform vec3 vEmissiveColor;
uniform vec3 vAmbientColor;
uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;
uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;
uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;
uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;
uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#define ADDITIONAL_FRAGMENT_DECLARATION
`;ShaderStore.IncludesShadersStore[name$T]=shader$T;const name$S="sceneUboDeclaration",shader$S=`layout(std140,column_major) uniform;
uniform Scene {
mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;
mat4 projection;
vec4 vEyePosition;
};
`;ShaderStore.IncludesShadersStore[name$S]=shader$S;const name$R="meshUboDeclaration",shader$R=`#ifdef WEBGL2
uniform mat4 world;
uniform float visibility;
#else
layout(std140,column_major) uniform;
uniform Mesh
{
mat4 world;
float visibility;
};
#endif
#define WORLD_UBO
`;ShaderStore.IncludesShadersStore[name$R]=shader$R;const name$Q="defaultUboDeclaration",shader$Q=`layout(std140,column_major) uniform;
uniform Material
{
vec4 diffuseLeftColor;
vec4 diffuseRightColor;
vec4 opacityParts;
vec4 reflectionLeftColor;
vec4 reflectionRightColor;
vec4 refractionLeftColor;
vec4 refractionRightColor;
vec4 emissiveLeftColor;
vec4 emissiveRightColor;
vec2 vDiffuseInfos;
vec2 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vReflectionInfos;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec2 vSpecularInfos;
vec3 vBumpInfos;
mat4 diffuseMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 reflectionMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 specularMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
float pointSize;
float alphaCutOff;
mat4 refractionMatrix;
vec4 vRefractionInfos;
vec3 vRefractionPosition;
vec3 vRefractionSize;
vec4 vSpecularColor;
vec3 vEmissiveColor;
vec4 vDiffuseColor;
vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;ShaderStore.IncludesShadersStore[name$Q]=shader$Q;const name$P="prePassDeclaration",shader$P=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$P]=shader$P;const name$O="oitDeclaration",shader$O=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;
layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;
uniform sampler2D oitDepthSampler;
uniform sampler2D oitFrontColorSampler;
#endif
`;ShaderStore.IncludesShadersStore[name$O]=shader$O;const name$N="mainUVVaryingDeclaration",shader$N=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;ShaderStore.IncludesShadersStore[name$N]=shader$N;const name$M="helperFunctions",shader$M=`const float PI=3.1415926535897932384626433832795;
const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;
const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;
const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);
const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {
vec3 i0=inMatrix[0];
vec3 i1=inMatrix[1];
vec3 i2=inMatrix[2];
mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);
return outMatrix;
}
mat3 inverseMat3(mat3 inMatrix) {
float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];
float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];
float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];
float b01=a22*a11-a12*a21;
float b11=-a22*a10+a12*a20;
float b21=a21*a10-a11*a20;
float det=a00*b01+a01*b11+a02*b21;
return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;
}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{
vec3 nearZeroSection=0.0773993808*color;
vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{
vec3 nearZeroSection=12.92*color;
vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;
float remainingSection=pow(0.947867299*(color+0.055),2.4);
return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;
float remainingSection=1.055*pow(color,0.41666)-0.055;
return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{
return value*value;
}
vec3 square(vec3 value)
{
return value*value;
}
float pow5(float value) {
float sq=value*value;
return sq*sq*value;
}
float getLuminance(vec3 color)
{
return clamp(dot(color,LuminanceEncodeApprox),0.,1.);
}
float getRand(vec2 seed) {
return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);
}
float dither(vec2 seed,float varianceAmount) {
float rand=getRand(seed);
float normVariance=varianceAmount/255.0;
float dither=mix(-normVariance,normVariance,rand);
return dither;
}
const float rgbdMaxRange=255.0;
vec4 toRGBD(vec3 color) {
float maxRGB=maxEps(max(color.r,max(color.g,color.b)));
float D =max(rgbdMaxRange/maxRGB,1.);
D =clamp(floor(D)/255.0,0.,1.);
vec3 rgb=color.rgb*D;
rgb=toGammaSpace(rgb);
return vec4(clamp(rgb,0.,1.),D); 
}
vec3 fromRGBD(vec4 rgbd) {
rgbd.rgb=toLinearSpace(rgbd.rgb);
return rgbd.rgb/rgbd.a;
}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {
vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;
vec3 halfSize=cubeSize*0.5;
vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;
vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;
vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);
float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);
vec3 intersectPositionWS=vertexPos+origVec*distance;
return intersectPositionWS-cubePos;
}
`;ShaderStore.IncludesShadersStore[name$M]=shader$M;const name$L="lightFragmentDeclaration",shader$L=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X};
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$L]=shader$L;const name$K="lightUboDeclaration",shader$K=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X}; 
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$K]=shader$K;const name$J="lightsFragmentFunctions",shader$J=`struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};
lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 lightVectorW;
float attenuation=1.0;
if (lightData.w==0.)
{
vec3 direction=lightData.xyz-vPositionW;
attenuation=max(0.,1.0-length(direction)/range);
lightVectorW=normalize(direction);
}
else
{
lightVectorW=normalize(-lightData.xyz);
}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 direction=lightData.xyz-vPositionW;
vec3 lightVectorW=normalize(direction);
float attenuation=max(0.,1.0-length(direction)/range);
float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));
if (cosAngle>=lightDirection.w)
{
cosAngle=max(0.,pow(cosAngle,lightData.w));
attenuation*=cosAngle;
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;
}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {
lightingInfo result;
float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor;
#endif
return result;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return textureColor;
}`;ShaderStore.IncludesShadersStore[name$J]=shader$J;const name$I="shadowsFragmentFunctions",shader$I=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{
float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));
return mix(value,1.0,mask);
}
#define inline
float computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;
}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
float visibility=1.;
vec3 poissonDisk[4];
poissonDisk[0]=vec3(-1.0,1.0,-1.0);
poissonDisk[1]=vec3(1.0,-1.0,-1.0);
poissonDisk[2]=vec3(-1.0,-1.0,-1.0);
poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);
}
#define inline
float computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); 
return esm;
}
#define inline
float computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return esm;
}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
vec3 uvLayer=vec3(uv.x,uv.y,layer);
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
float visibility=1.;
vec2 poissonDisk[4];
poissonDisk[0]=vec2(-0.94201624,-0.39906216);
poissonDisk[1]=vec2(0.94558609,-0.76890725);
poissonDisk[2]=vec2(-0.094184101,-0.92938870);
poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float shadow=texture2D(shadowSampler,uvDepthLayer);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));
shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));
shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));
shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);
shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);
shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);
shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);
shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);
shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);
shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);
shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);
shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);
shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);
shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);
shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.)
);
const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);
vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec4 offset=vec4(poissonSamplers[i],0.);
offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);
shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));
shadow=mix(darkness,1.,shadow);
if (numBlocker<1.0) {
return 1.0;
}
else
{
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
if (numBlocker<1.0) {
return 1.0;
}
else
{
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);
float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec3 offset=poissonSamplers[i];
offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);
shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);
}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$I]=shader$I;const name$H="samplerFragmentDeclaration",shader$H=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;ShaderStore.IncludesShadersStore[name$H]=shader$H;const name$G="fresnelFunction",shader$G=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{
float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);
return clamp(fresnelTerm,0.,1.);
}
#endif
`;ShaderStore.IncludesShadersStore[name$G]=shader$G;const name$F="reflectionFunction",shader$F=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0); 
}
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(1.0-s,t,0); 
}
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);
vec3 r=normalize(reflect(cameraToVertex,worldNormal));
r=vec3(reflectionMatrix*vec4(r,0));
float lon=atan(r.z,r.x);
float lat=acos(r.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0);
}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(vec3(view*worldPos));
vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));
vec3 r=reflect(viewDir,viewNormal);
r=vec3(reflectionMatrix*vec4(r,0));
r.z=r.z-1.0;
float m=2.0*length(r);
return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);
}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=worldPos.xyz-eyePosition;
vec3 coords=normalize(reflect(viewDir,worldNormal));
return vec3(reflectionMatrix*vec4(coords,1));
}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*(view*worldPos));
}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*vec4(positionW,1.));
}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;ShaderStore.IncludesShadersStore[name$F]=shader$F;const name$E="imageProcessingDeclaration",shader$E=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;
uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;
uniform vec4 vCameraColorCurveNeutral;
uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;ShaderStore.IncludesShadersStore[name$E]=shader$E;const name$D="imageProcessingFunctions",shader$D=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{
float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);
float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;
sliceUV.x+=sliceInteger*sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice0Color=texture2D(colorTransform,sliceUV);
sliceUV.x+=sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice1Color=texture2D(colorTransform,sliceUV);
vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;
}
#endif
#ifdef TONEMAPPING_ACES
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);
const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);
vec3 RRTAndODTFit(vec3 v)
{
vec3 a=v*(v+0.0245786)-0.000090537;
vec3 b=v*(0.983729*v+0.4329510)+0.238081;
return a/b;
}
vec3 ACESFitted(vec3 color)
{
color=ACESInputMat*color;
color=RRTAndODTFit(color);
color=ACESOutputMat*color;
color=saturate(color);
return color;
}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;
viewportXY=viewportXY*2.0-1.0;
vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);
float vignetteTerm=dot(vignetteXY1,vignetteXY1);
float vignette=pow(vignetteTerm,vignetteSettings2.w);
vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);
result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#ifdef TONEMAPPING
#ifdef TONEMAPPING_ACES
result.rgb=ACESFitted(result.rgb);
#else
const float tonemappingCalibration=1.590579;
result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
#endif
result.rgb=toGammaSpace(result.rgb);
result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);
if (contrast<1.0) {
result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);
} else {
result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);
}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);
vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));
vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;
result.rgb*=colorCurve.rgb;
result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);
float dither=mix(-ditherIntensity,ditherIntensity,rand);
result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;
}`;ShaderStore.IncludesShadersStore[name$D]=shader$D;const name$C="bumpFragmentMainFunctions",shader$C=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{
mat4 ret=inverse(wMatrix);
ret=transpose(ret);
ret[0][3]=0.;
ret[1][3]=0.;
ret[2][3]=0.;
ret[3]=vec4(0.,0.,0.,1.);
return ret;
}
#else
mat4 toNormalMatrix(mat4 m)
{
float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;
mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;
return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);
}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);
}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{
return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);
}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{
vec3 dp1=dFdx(p);
vec3 dp2=dFdy(p);
vec2 duv1=dFdx(uv);
vec2 duv2=dFdy(uv);
vec3 dp2perp=cross(dp2,normal);
vec3 dp1perp=cross(normal,dp1);
vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;
vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;
tangent*=tangentSpaceParams.x;
bitangent*=tangentSpaceParams.y;
float det=max(dot(tangent,tangent),dot(bitangent,bitangent));
float invmax=det==0.0 ? 0.0 : inversesqrt(det);
return mat3(tangent*invmax,bitangent*invmax,normal);
}
#endif
`;ShaderStore.IncludesShadersStore[name$C]=shader$C;const name$B="bumpFragmentFunctions",shader$B=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;
const float maxSamples=15.;
const int iMaxSamples=15;
vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {
float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;
parallaxLimit*=parallaxScale;
vec2 vOffsetDir=normalize(vViewDirCoT.xy);
vec2 vMaxOffset=vOffsetDir*parallaxLimit;
float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));
float stepSize=1.0/numSamples;
float currRayHeight=1.0;
vec2 vCurrOffset=vec2(0,0);
vec2 vLastOffset=vec2(0,0);
float lastSampledHeight=1.0;
float currSampledHeight=1.0;
bool keepWorking=true;
for (int i=0; i<iMaxSamples; i++)
{
currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;
if (!keepWorking)
{
}
else if (currSampledHeight>currRayHeight)
{
float delta1=currSampledHeight-currRayHeight;
float delta2=(currRayHeight+stepSize)-lastSampledHeight;
float ratio=delta1/(delta1+delta2);
vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;
keepWorking=false;
}
else
{
currRayHeight-=stepSize;
vLastOffset=vCurrOffset;
vCurrOffset+=stepSize*vMaxOffset;
lastSampledHeight=currSampledHeight;
}
}
return vCurrOffset;
}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{
float height=texture2D(bumpSampler,vBumpUV).w;
vec2 texCoordOffset=heightScale*viewDir.xy*height;
return -texCoordOffset;
}
#endif
`;ShaderStore.IncludesShadersStore[name$B]=shader$B;const name$A="logDepthDeclaration",shader$A=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;
varying float vFragmentDepth;
#endif
`;ShaderStore.IncludesShadersStore[name$A]=shader$A;const name$z="fogFragmentDeclaration",shader$z=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;
uniform vec3 vFogColor;
varying vec3 vFogDistance;
float CalcFogFactor()
{
float fogCoeff=1.0;
float fogStart=vFogInfos.y;
float fogEnd=vFogInfos.z;
float fogDensity=vFogInfos.w;
float fogDistance=length(vFogDistance);
if (FOGMODE_LINEAR==vFogInfos.x)
{
fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);
}
else if (FOGMODE_EXP==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDensity);
}
else if (FOGMODE_EXP2==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);
}
return clamp(fogCoeff,0.0,1.0);
}
#endif
`;ShaderStore.IncludesShadersStore[name$z]=shader$z;const name$y="bumpFragment",shader$y=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;
mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);
vec2 detailNormalRG=detailColor.wy*2.0-1.0;
float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));
vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);
normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;
vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;
bumpNormal+=vec3(0.0,0.0,1.0);
detailNormal*=vec3(-1.0,-1.0,1.0);
vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;
normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;ShaderStore.IncludesShadersStore[name$y]=shader$y;const name$x="decalFragment",shader$x=`#ifdef DECAL
#ifdef GAMMADECAL
decalColor.rgb=toLinearSpace(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalColor.a*=decalColor.a;
#endif
surfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);
#endif
`;ShaderStore.IncludesShadersStore[name$x]=shader$x;const name$w="depthPrePass",shader$w=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);
return;
#endif
`;ShaderStore.IncludesShadersStore[name$w]=shader$w;const name$v="lightFragment",shader$v=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);
info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {
index{X}=i;
break;
}
}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];
float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};
if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{
index{X}+=1;
float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;
shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$v]=shader$v;const name$u="logDepthFragment",shader$u=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;ShaderStore.IncludesShadersStore[name$u]=shader$u;const name$t="fogFragment",shader$t=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;ShaderStore.IncludesShadersStore[name$t]=shader$t;const name$s="oitFragment",shader$s=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));
vec2 full=unpackHalf2x16(halfFloat);
fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);
vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;
vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);
depth.rg=vec2(-MAX_DEPTH);
frontColor=lastFrontColor;
backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;
float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;
float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;
}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);
return;
}
#endif
`;ShaderStore.IncludesShadersStore[name$s]=shader$s;const name$r="defaultPixelShader",shader$r=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
vec4 baseColor=vec4(1.,1.,1.,1.);
vec3 diffuseColor=vDiffuseColor.rgb;
float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
#ifdef SPECULARTERM
float glossiness=vSpecularColor.a;
vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);
specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#else
float glossiness=0.;
#endif
vec3 diffuseBase=vec3(0.,0.,0.);
lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);
if (dot(refractionVector,viewDirectionW)<1.0) {
refractionColor=refractionLookup;
}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;
reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);
refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);
alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);
alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);
emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);
diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);
color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
gl_FragData[0]=color; 
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULARTERM)
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;
#endif
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=color.rgb*color.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-color.a);
} else {
backColor+=color;
}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;ShaderStore.ShadersStore[name$r]=shader$r;const name$q="decalVertexDeclaration",shader$q=`#ifdef DECAL
uniform vec4 vDecalInfos;
uniform mat4 decalMatrix;
#endif
`;ShaderStore.IncludesShadersStore[name$q]=shader$q;const name$p="defaultVertexDeclaration",shader$p=`uniform mat4 viewProjection;
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;ShaderStore.IncludesShadersStore[name$p]=shader$p;const name$o="uvAttributeDeclaration",shader$o=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;ShaderStore.IncludesShadersStore[name$o]=shader$o;const name$n="prePassVertexDeclaration",shader$n=`#ifdef PREPASS
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
uniform mat4 previousViewProjection;
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$n]=shader$n;const name$m="samplerVertexDeclaration",shader$m=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;ShaderStore.IncludesShadersStore[name$m]=shader$m;const name$l="bumpVertexDeclaration",shader$l=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$l]=shader$l;const name$k="fogVertexDeclaration",shader$k=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;ShaderStore.IncludesShadersStore[name$k]=shader$k;const name$j="lightVxFragmentDeclaration",shader$j=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$j]=shader$j;const name$i="lightVxUboDeclaration",shader$i=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$i]=shader$i;const name$h="morphTargetsVertexGlobalDeclaration",shader$h=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
precision mediump sampler2DArray; 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];
uniform vec3 morphTargetTextureInfo;
uniform sampler2DArray morphTargets;
vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);
float x=vertexIndex-y*morphTargetTextureInfo.y;
vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);
return texture(morphTargets,textureUV).xyz;
}
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$h]=shader$h;const name$g="morphTargetsVertexDeclaration",shader$g=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute vec3 position{X};
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$g]=shader$g;const name$f="morphTargetsVertexGlobal",shader$f=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$f]=shader$f;const name$e="morphTargetsVertex",shader$e=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;
positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];
vertexID+=1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];
#endif
#else
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$e]=shader$e;const name$d="prePassVertex",shader$d=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$d]=shader$d;const name$c="uvVariableDeclaration",shader$c=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;ShaderStore.IncludesShadersStore[name$c]=shader$c;const name$b="samplerVertexImplementation",shader$b=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));
}
#ifdef UV2
else if (v_INFONAME_==1.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));
}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));
}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));
}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));
}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));
}
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$b]=shader$b;const name$a="bumpVertex",shader$a=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);
vec3 tbnTangent=normalize(tangentUpdated.xyz);
vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;
vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$a]=shader$a;const name$9="fogVertex",shader$9=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;ShaderStore.IncludesShadersStore[name$9]=shader$9;const name$8="shadowsVertex",shader$8=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {
vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;ShaderStore.IncludesShadersStore[name$8]=shader$8;const name$7="pointCloudVertex",shader$7=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;ShaderStore.IncludesShadersStore[name$7]=shader$7;const name$6="logDepthVertex",shader$6=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;
gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;ShaderStore.IncludesShadersStore[name$6]=shader$6;const name$5="defaultVertexShader",shader$5=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#include<prePassVertex>
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;ShaderStore.ShadersStore[name$5]=shader$5;const rxOption=new RegExp("^([gimus]+)!");class MaterialPluginManager{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let r=0;r<this._plugins.length;++r)if(this._plugins[r].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const t=e.getClassName();MaterialPluginManager._MaterialPluginClassToMainDefine[t]||(MaterialPluginManager._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++MaterialPluginManager._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(e),this._plugins.sort((r,s)=>r.priority-s.priority),this._codeInjectionPoints={};const i={};i[MaterialPluginManager._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const r of this._plugins)r.collectDefines(i),this._collectPointNames("vertex",r.getCustomCode("vertex")),this._collectPointNames("fragment",r.getCustomCode("fragment"));return this._defineNamesFromPlugins=i,!0}_activatePlugin(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const i of this._activePluginsForExtraEvents)if(t=i.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){var i;switch(e){case MaterialPluginEvent.GetActiveTextures:{const r=t;for(const s of this._activePlugins)s.getActiveTextures(r.activeTextures);break}case MaterialPluginEvent.GetAnimatables:{const r=t;for(const s of this._activePlugins)s.getAnimatables(r.animatables);break}case MaterialPluginEvent.HasTexture:{const r=t;let s=!1;for(const n of this._activePlugins)if(s=n.hasTexture(r.texture),s)break;r.hasTexture=s;break}case MaterialPluginEvent.Disposed:{const r=t;for(const s of this._plugins)s.dispose(r.forceDisposeTextures);break}case MaterialPluginEvent.GetDefineNames:{const r=t;r.defineNames=this._defineNamesFromPlugins;break}case MaterialPluginEvent.PrepareEffect:{const r=t;for(const s of this._activePlugins)r.fallbackRank=s.addFallbacks(r.defines,r.fallbacks,r.fallbackRank),s.getAttributes(r.attributes,this._scene,r.mesh);this._uniformList.length>0&&r.uniforms.push(...this._uniformList),this._samplerList.length>0&&r.samplers.push(...this._samplerList),this._uboList.length>0&&r.uniformBuffersNames.push(...this._uboList),r.customCode=this._injectCustomCode(r.customCode);break}case MaterialPluginEvent.PrepareUniformBuffer:{const r=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const s of this._plugins){const n=s.getUniforms();if(n){if(n.ubo)for(const o of n.ubo){if(o.size&&o.type){const l=(i=o.arraySize)!==null&&i!==void 0?i:0;r.ubo.addUniform(o.name,o.size,l),this._uboDeclaration+=`${o.type} ${o.name}${l>0?`[${l}]`:""};\r
`}this._uniformList.push(o.name)}n.vertex&&(this._vertexDeclaration+=n.vertex+`\r
`),n.fragment&&(this._fragmentDeclaration+=n.fragment+`\r
`)}s.getSamplers(this._samplerList),s.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e){return(t,i)=>{var r;e&&(i=e(t,i)),this._uboDeclaration&&(i=i.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(i=i.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(i=i.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const s=(r=this._codeInjectionPoints)===null||r===void 0?void 0:r[t];if(!s)return i;for(let n in s){let o="";for(const l of this._activePlugins){const h=l.getCustomCode(t);h!=null&&h[n]&&(o+=h[n]+`\r
`)}if(o.length>0)if(n.charAt(0)==="!"){n=n.substring(1);let l="g";if(n.charAt(0)==="!")l="",n=n.substring(1);else{const d=rxOption.exec(n);d&&d.length>=2&&(l=d[1],n=n.substring(l.length+1))}l.indexOf("g")<0&&(l+="g");const h=i,u=new RegExp(n,l);let c=u.exec(h);for(;c!==null;){let d=o;for(let f=0;f<c.length;++f)d=d.replace("$"+f,c[f]);i=i.replace(c[0],d),c=u.exec(h)}}else{const l="#define "+n;i=i.replace(l,`\r
`+o+`\r
`+l)}}return i}}}MaterialPluginManager._MaterialPluginClassToMainDefine={};MaterialPluginManager._MaterialPluginCounter=0;EngineStore.OnEnginesDisposedObservable.add(()=>{UnregisterAllMaterialPlugins()});const plugins=[];let observer=null;function UnregisterAllMaterialPlugins(){plugins.length=0,Material.OnEventObservable.remove(observer),observer=null}class MaterialPluginBase{_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,r,s=!0,n=!1){this.priority=500,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,e.pluginManager||(e.pluginManager=new MaterialPluginManager(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=r,this._pluginManager=e.pluginManager,s&&this._pluginManager._addPlugin(this),n&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,r){return!0}hardBindForSubMesh(e,t,i,r){}bindForSubMesh(e,t,i,r){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if(t[0]==="_")continue;const i=typeof this._pluginDefineNames[t];e[t]={type:i==="number"?"number":i==="string"?"string":i==="boolean"?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){SerializationHelper.Clone(()=>e,this)}serialize(){return SerializationHelper.Serialize(this)}parse(e,t,i){SerializationHelper.Parse(()=>this,e,t,i)}}__decorate([serialize()],MaterialPluginBase.prototype,"name",void 0);__decorate([serialize()],MaterialPluginBase.prototype,"priority",void 0);__decorate([serialize()],MaterialPluginBase.prototype,"registerForExtraEvents",void 0);class MaterialDetailMapDefines extends MaterialDefines{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class DetailMapConfiguration extends MaterialPluginBase{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DetailMap",140,new MaterialDetailMapDefines,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=Material.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&MaterialFlags.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&MaterialFlags.DetailTextureEnabled&&this._isEnabled?(MaterialHelper.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&MaterialFlags.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),MaterialHelper.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&MaterialFlags.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&((t=this._texture)===null||t===void 0||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}__decorate([serializeAsTexture("detailTexture"),expandToProperty("_markAllSubMeshesAsTexturesDirty")],DetailMapConfiguration.prototype,"texture",void 0);__decorate([serialize()],DetailMapConfiguration.prototype,"diffuseBlendLevel",void 0);__decorate([serialize()],DetailMapConfiguration.prototype,"roughnessBlendLevel",void 0);__decorate([serialize()],DetailMapConfiguration.prototype,"bumpLevel",void 0);__decorate([serialize(),expandToProperty("_markAllSubMeshesAsTexturesDirty")],DetailMapConfiguration.prototype,"normalBlendMethod",void 0);__decorate([serialize(),expandToProperty("_markAllSubMeshesAsTexturesDirty")],DetailMapConfiguration.prototype,"isEnabled",void 0);const onCreatedEffectParameters={effect:null,subMesh:null};class StandardMaterialDefines extends MaterialDefines{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class StandardMaterial extends PushMaterial{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new Color3(0,0,0),this.diffuseColor=new Color3(1,1,1),this.specularColor=new Color3(1,1,1),this.emissiveColor=new Color3(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._renderTargets=new SmartArray(16),this._worldViewProjectionMatrix=Matrix.Zero(),this._globalAmbientColor=new Color3(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new DetailMapConfiguration(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new PrePassConfiguration,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),StandardMaterial.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),StandardMaterial.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return StandardMaterial.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||StandardMaterial.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===Material.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==Material.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(MaterialPluginEvent.GetDefineNames,this._eventInfo),t.materialDefines=new StandardMaterialDefines(this._eventInfo.defineNames));const r=this.getScene(),s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();s._needNormals=MaterialHelper.PrepareDefinesForLights(r,e,s,!0,this._maxSimultaneousLights,this._disableLighting),MaterialHelper.PrepareDefinesForMultiview(r,s);const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(MaterialHelper.PrepareDefinesForPrePass(r,s,this.canRenderToMRT&&!o),MaterialHelper.PrepareDefinesForOIT(r,s,o),s._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,s._needUVs=!1;for(let h=1;h<=6;++h)s["MAINUV"+h]=!1;if(r.texturesEnabled){if(s.DIFFUSEDIRECTUV=0,s.BUMPDIRECTUV=0,s.AMBIENTDIRECTUV=0,s.OPACITYDIRECTUV=0,s.EMISSIVEDIRECTUV=0,s.SPECULARDIRECTUV=0,s.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&StandardMaterial.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())MaterialHelper.PrepareDefinesForMergedUV(this._diffuseTexture,s,"DIFFUSE");else return!1;else s.DIFFUSE=!1;if(this._ambientTexture&&StandardMaterial.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())MaterialHelper.PrepareDefinesForMergedUV(this._ambientTexture,s,"AMBIENT");else return!1;else s.AMBIENT=!1;if(this._opacityTexture&&StandardMaterial.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())MaterialHelper.PrepareDefinesForMergedUV(this._opacityTexture,s,"OPACITY"),s.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else s.OPACITY=!1;if(this._reflectionTexture&&StandardMaterial.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(s._needNormals=!0,s.REFLECTION=!0,s.ROUGHNESS=this._roughness>0,s.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,s.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===Texture.INVCUBIC_MODE,s.REFLECTIONMAP_3D=this._reflectionTexture.isCube,s.REFLECTIONMAP_OPPOSITEZ=s.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,s.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case Texture.EXPLICIT_MODE:s.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case Texture.PLANAR_MODE:s.setReflectionMode("REFLECTIONMAP_PLANAR");break;case Texture.PROJECTION_MODE:s.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case Texture.SKYBOX_MODE:s.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case Texture.SPHERICAL_MODE:s.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case Texture.EQUIRECTANGULAR_MODE:s.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case Texture.FIXED_EQUIRECTANGULAR_MODE:s.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case Texture.CUBIC_MODE:case Texture.INVCUBIC_MODE:default:s.setReflectionMode("REFLECTIONMAP_CUBIC");break}s.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else s.REFLECTION=!1,s.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&StandardMaterial.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())MaterialHelper.PrepareDefinesForMergedUV(this._emissiveTexture,s,"EMISSIVE");else return!1;else s.EMISSIVE=!1;if(this._lightmapTexture&&StandardMaterial.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())MaterialHelper.PrepareDefinesForMergedUV(this._lightmapTexture,s,"LIGHTMAP"),s.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,s.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else s.LIGHTMAP=!1;if(this._specularTexture&&StandardMaterial.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())MaterialHelper.PrepareDefinesForMergedUV(this._specularTexture,s,"SPECULAR"),s.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else s.SPECULAR=!1;if(r.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&StandardMaterial.BumpTextureEnabled){if(this._bumpTexture.isReady())MaterialHelper.PrepareDefinesForMergedUV(this._bumpTexture,s,"BUMP"),s.PARALLAX=this._useParallax,s.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;s.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else s.BUMP=!1,s.PARALLAX=!1,s.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&StandardMaterial.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())s._needUVs=!0,s.REFRACTION=!0,s.REFRACTIONMAP_3D=this._refractionTexture.isCube,s.RGBDREFRACTION=this._refractionTexture.isRGBD,s.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else s.REFRACTION=!1;s.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else s.DIFFUSE=!1,s.AMBIENT=!1,s.OPACITY=!1,s.REFLECTION=!1,s.EMISSIVE=!1,s.LIGHTMAP=!1,s.BUMP=!1,s.REFRACTION=!1;s.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),s.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,s.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,s.SPECULAROVERALPHA=this._useSpecularOverAlpha,s.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,s.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,s.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(s._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s),s.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,s.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}s._areFresnelDirty&&(StandardMaterial.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(s.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,s.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,s.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,s.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,s.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,s.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,s._needNormals=!0,s.FRESNEL=!0):s.FRESNEL=!1),MaterialHelper.PrepareDefinesForMisc(e,r,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,s),MaterialHelper.PrepareDefinesForFrameBoundValues(r,n,this,s,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=s,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),MaterialHelper.PrepareDefinesForAttributes(e,s,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let l=!1;if(s.isDirty){const h=s._areLightsDisposed;s.markAsProcessed();const u=new EffectFallbacks;s.REFLECTION&&u.addFallback(0,"REFLECTION"),s.SPECULAR&&u.addFallback(0,"SPECULAR"),s.BUMP&&u.addFallback(0,"BUMP"),s.PARALLAX&&u.addFallback(1,"PARALLAX"),s.PARALLAXOCCLUSION&&u.addFallback(0,"PARALLAXOCCLUSION"),s.SPECULAROVERALPHA&&u.addFallback(0,"SPECULAROVERALPHA"),s.FOG&&u.addFallback(1,"FOG"),s.POINTSIZE&&u.addFallback(0,"POINTSIZE"),s.LOGARITHMICDEPTH&&u.addFallback(0,"LOGARITHMICDEPTH"),MaterialHelper.HandleFallbacksForShadows(s,u,this._maxSimultaneousLights),s.SPECULARTERM&&u.addFallback(0,"SPECULARTERM"),s.DIFFUSEFRESNEL&&u.addFallback(1,"DIFFUSEFRESNEL"),s.OPACITYFRESNEL&&u.addFallback(2,"OPACITYFRESNEL"),s.REFLECTIONFRESNEL&&u.addFallback(3,"REFLECTIONFRESNEL"),s.EMISSIVEFRESNEL&&u.addFallback(4,"EMISSIVEFRESNEL"),s.FRESNEL&&u.addFallback(4,"FRESNEL"),s.MULTIVIEW&&u.addFallback(0,"MULTIVIEW");const c=[VertexBuffer.PositionKind];s.NORMAL&&c.push(VertexBuffer.NormalKind),s.TANGENT&&c.push(VertexBuffer.TangentKind);for(let x=1;x<=6;++x)s["UV"+x]&&c.push(`uv${x===1?"":x}`);s.VERTEXCOLOR&&c.push(VertexBuffer.ColorKind),MaterialHelper.PrepareAttributesForBones(c,e,s,u),MaterialHelper.PrepareAttributesForInstances(c,s),MaterialHelper.PrepareAttributesForMorphTargets(c,e,s),MaterialHelper.PrepareAttributesForBakedVertexAnimation(c,e,s);let d="default";const f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],_=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],g=["Material","Scene","Mesh"];this._eventInfo.fallbacks=u,this._eventInfo.fallbackRank=0,this._eventInfo.defines=s,this._eventInfo.uniforms=f,this._eventInfo.attributes=c,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=g,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(MaterialPluginEvent.PrepareEffect,this._eventInfo),PrePassConfiguration.AddUniforms(f),ImageProcessingConfiguration&&(ImageProcessingConfiguration.PrepareUniforms(f,s),ImageProcessingConfiguration.PrepareSamplers(_,s)),MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:g,samplers:_,defines:s,maxSimultaneousLights:this._maxSimultaneousLights}),addClipPlaneUniforms(f);const p={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,f,g,_,s,c,p));const m=s.toString(),E=t.effect;let M=r.getEngine().createEffect(d,{attributes:c,uniformsNames:f,uniformBuffersNames:g,samplers:_,defines:m,fallbacks:u,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:s.NUM_MORPH_INFLUENCERS},processFinalCode:p.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:s.PREPASS},n);if(this._eventInfo.customCode=void 0,M)if(this._onEffectCreatedObservable&&(onCreatedEffectParameters.effect=M,onCreatedEffectParameters.subMesh=t,this._onEffectCreatedObservable.notifyObservers(onCreatedEffectParameters)),this.allowShaderHotSwapping&&E&&!M.isReady()){if(M=E,s.markAsUnprocessed(),l=this.isFrozen,h)return s._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(M,s,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(s._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!l,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var r;const s=this.getScene(),n=i.materialDefines;if(!n)return;const o=i.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,s,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=o._forceRebindOnNextCall||this._mustRebind(s,o,t.visibility);MaterialHelper.BindBonesParameters(t,o);const h=this._uniformBuffer;if(l){if(this.bindViewProjection(o),!h.useUbo||!this.isFrozen||!h.isSync||o._forceRebindOnNextCall){if(StandardMaterial.FresnelEnabled&&n.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(h.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),h.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&h.updateColor4("opacityParts",new Color3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(h.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),h.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(h.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),h.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(h.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),h.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),s.texturesEnabled){if(this._diffuseTexture&&StandardMaterial.DiffuseTextureEnabled&&(h.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),MaterialHelper.BindTextureMatrix(this._diffuseTexture,h,"diffuse")),this._ambientTexture&&StandardMaterial.AmbientTextureEnabled&&(h.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),MaterialHelper.BindTextureMatrix(this._ambientTexture,h,"ambient")),this._opacityTexture&&StandardMaterial.OpacityTextureEnabled&&(h.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),MaterialHelper.BindTextureMatrix(this._opacityTexture,h,"opacity")),this._hasAlphaChannel()&&h.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&StandardMaterial.ReflectionTextureEnabled&&(h.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),h.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const u=this._reflectionTexture;h.updateVector3("vReflectionPosition",u.boundingBoxPosition),h.updateVector3("vReflectionSize",u.boundingBoxSize)}if(this._emissiveTexture&&StandardMaterial.EmissiveTextureEnabled&&(h.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),MaterialHelper.BindTextureMatrix(this._emissiveTexture,h,"emissive")),this._lightmapTexture&&StandardMaterial.LightmapTextureEnabled&&(h.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),MaterialHelper.BindTextureMatrix(this._lightmapTexture,h,"lightmap")),this._specularTexture&&StandardMaterial.SpecularTextureEnabled&&(h.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),MaterialHelper.BindTextureMatrix(this._specularTexture,h,"specular")),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&StandardMaterial.BumpTextureEnabled&&(h.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),MaterialHelper.BindTextureMatrix(this._bumpTexture,h,"bump"),s._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&StandardMaterial.RefractionTextureEnabled){let u=1;if(this._refractionTexture.isCube||(h.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(u=this._refractionTexture.depth)),h.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,u,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const c=this._refractionTexture;h.updateVector3("vRefractionPosition",c.boundingBoxPosition),h.updateVector3("vRefractionSize",c.boundingBoxSize)}}}this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),n.SPECULARTERM&&h.updateColor4("vSpecularColor",this.specularColor,this.specularPower),h.updateColor3("vEmissiveColor",StandardMaterial.EmissiveTextureEnabled?this.emissiveColor:Color3.BlackReadOnly),h.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),s.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),h.updateColor3("vAmbientColor",this._globalAmbientColor)}s.texturesEnabled&&(this._diffuseTexture&&StandardMaterial.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&StandardMaterial.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&StandardMaterial.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&StandardMaterial.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&StandardMaterial.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&StandardMaterial.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&StandardMaterial.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&StandardMaterial.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&StandardMaterial.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),bindClipPlane(o,this,s),this.bindEyePosition(o)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(s.lightsEnabled&&!this._disableLighting&&MaterialHelper.BindLights(s,t,o,n,this._maxSimultaneousLights),(s.fogEnabled&&t.applyFog&&s.fogMode!==Scene.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||n.PREPASS)&&this.bindView(o),MaterialHelper.BindFogParameters(s,t,o),n.NUM_MORPH_INFLUENCERS&&MaterialHelper.BindMorphTargetParameters(t,o),n.BAKED_VERTEX_ANIMATION_TEXTURE&&((r=t.bakedVertexAnimationManager)===null||r===void 0||r.bind(o,n.INSTANCES)),this.useLogarithmicDepth&&MaterialHelper.BindLogDepth(n,o,s),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),h.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){var i,r,s,n,o,l,h,u,c;t&&((i=this._diffuseTexture)===null||i===void 0||i.dispose(),(r=this._ambientTexture)===null||r===void 0||r.dispose(),(s=this._opacityTexture)===null||s===void 0||s.dispose(),(n=this._reflectionTexture)===null||n===void 0||n.dispose(),(o=this._emissiveTexture)===null||o===void 0||o.dispose(),(l=this._specularTexture)===null||l===void 0||l.dispose(),(h=this._bumpTexture)===null||h===void 0||h.dispose(),(u=this._lightmapTexture)===null||u===void 0||u.dispose(),(c=this._refractionTexture)===null||c===void 0||c.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){const r=SerializationHelper.Clone(()=>new StandardMaterial(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.name=e,r.id=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}static Parse(e,t,i){const r=SerializationHelper.Parse(()=>new StandardMaterial(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),Material._parsePlugins(e,r,t,i),r}static get DiffuseTextureEnabled(){return MaterialFlags.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){MaterialFlags.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return MaterialFlags.DetailTextureEnabled}static set DetailTextureEnabled(e){MaterialFlags.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return MaterialFlags.AmbientTextureEnabled}static set AmbientTextureEnabled(e){MaterialFlags.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return MaterialFlags.OpacityTextureEnabled}static set OpacityTextureEnabled(e){MaterialFlags.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return MaterialFlags.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){MaterialFlags.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return MaterialFlags.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){MaterialFlags.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return MaterialFlags.SpecularTextureEnabled}static set SpecularTextureEnabled(e){MaterialFlags.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return MaterialFlags.BumpTextureEnabled}static set BumpTextureEnabled(e){MaterialFlags.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return MaterialFlags.LightmapTextureEnabled}static set LightmapTextureEnabled(e){MaterialFlags.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return MaterialFlags.RefractionTextureEnabled}static set RefractionTextureEnabled(e){MaterialFlags.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return MaterialFlags.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){MaterialFlags.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return MaterialFlags.FresnelEnabled}static set FresnelEnabled(e){MaterialFlags.FresnelEnabled=e}}__decorate([serializeAsTexture("diffuseTexture")],StandardMaterial.prototype,"_diffuseTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],StandardMaterial.prototype,"diffuseTexture",void 0);__decorate([serializeAsTexture("ambientTexture")],StandardMaterial.prototype,"_ambientTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"ambientTexture",void 0);__decorate([serializeAsTexture("opacityTexture")],StandardMaterial.prototype,"_opacityTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],StandardMaterial.prototype,"opacityTexture",void 0);__decorate([serializeAsTexture("reflectionTexture")],StandardMaterial.prototype,"_reflectionTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"reflectionTexture",void 0);__decorate([serializeAsTexture("emissiveTexture")],StandardMaterial.prototype,"_emissiveTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"emissiveTexture",void 0);__decorate([serializeAsTexture("specularTexture")],StandardMaterial.prototype,"_specularTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"specularTexture",void 0);__decorate([serializeAsTexture("bumpTexture")],StandardMaterial.prototype,"_bumpTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"bumpTexture",void 0);__decorate([serializeAsTexture("lightmapTexture")],StandardMaterial.prototype,"_lightmapTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"lightmapTexture",void 0);__decorate([serializeAsTexture("refractionTexture")],StandardMaterial.prototype,"_refractionTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"refractionTexture",void 0);__decorate([serializeAsColor3("ambient")],StandardMaterial.prototype,"ambientColor",void 0);__decorate([serializeAsColor3("diffuse")],StandardMaterial.prototype,"diffuseColor",void 0);__decorate([serializeAsColor3("specular")],StandardMaterial.prototype,"specularColor",void 0);__decorate([serializeAsColor3("emissive")],StandardMaterial.prototype,"emissiveColor",void 0);__decorate([serialize()],StandardMaterial.prototype,"specularPower",void 0);__decorate([serialize("useAlphaFromDiffuseTexture")],StandardMaterial.prototype,"_useAlphaFromDiffuseTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],StandardMaterial.prototype,"useAlphaFromDiffuseTexture",void 0);__decorate([serialize("useEmissiveAsIllumination")],StandardMaterial.prototype,"_useEmissiveAsIllumination",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useEmissiveAsIllumination",void 0);__decorate([serialize("linkEmissiveWithDiffuse")],StandardMaterial.prototype,"_linkEmissiveWithDiffuse",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"linkEmissiveWithDiffuse",void 0);__decorate([serialize("useSpecularOverAlpha")],StandardMaterial.prototype,"_useSpecularOverAlpha",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useSpecularOverAlpha",void 0);__decorate([serialize("useReflectionOverAlpha")],StandardMaterial.prototype,"_useReflectionOverAlpha",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useReflectionOverAlpha",void 0);__decorate([serialize("disableLighting")],StandardMaterial.prototype,"_disableLighting",void 0);__decorate([expandToProperty("_markAllSubMeshesAsLightsDirty")],StandardMaterial.prototype,"disableLighting",void 0);__decorate([serialize("useObjectSpaceNormalMap")],StandardMaterial.prototype,"_useObjectSpaceNormalMap",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useObjectSpaceNormalMap",void 0);__decorate([serialize("useParallax")],StandardMaterial.prototype,"_useParallax",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useParallax",void 0);__decorate([serialize("useParallaxOcclusion")],StandardMaterial.prototype,"_useParallaxOcclusion",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useParallaxOcclusion",void 0);__decorate([serialize()],StandardMaterial.prototype,"parallaxScaleBias",void 0);__decorate([serialize("roughness")],StandardMaterial.prototype,"_roughness",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"roughness",void 0);__decorate([serialize()],StandardMaterial.prototype,"indexOfRefraction",void 0);__decorate([serialize()],StandardMaterial.prototype,"invertRefractionY",void 0);__decorate([serialize()],StandardMaterial.prototype,"alphaCutOff",void 0);__decorate([serialize("useLightmapAsShadowmap")],StandardMaterial.prototype,"_useLightmapAsShadowmap",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useLightmapAsShadowmap",void 0);__decorate([serializeAsFresnelParameters("diffuseFresnelParameters")],StandardMaterial.prototype,"_diffuseFresnelParameters",void 0);__decorate([expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"diffuseFresnelParameters",void 0);__decorate([serializeAsFresnelParameters("opacityFresnelParameters")],StandardMaterial.prototype,"_opacityFresnelParameters",void 0);__decorate([expandToProperty("_markAllSubMeshesAsFresnelAndMiscDirty")],StandardMaterial.prototype,"opacityFresnelParameters",void 0);__decorate([serializeAsFresnelParameters("reflectionFresnelParameters")],StandardMaterial.prototype,"_reflectionFresnelParameters",void 0);__decorate([expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"reflectionFresnelParameters",void 0);__decorate([serializeAsFresnelParameters("refractionFresnelParameters")],StandardMaterial.prototype,"_refractionFresnelParameters",void 0);__decorate([expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"refractionFresnelParameters",void 0);__decorate([serializeAsFresnelParameters("emissiveFresnelParameters")],StandardMaterial.prototype,"_emissiveFresnelParameters",void 0);__decorate([expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"emissiveFresnelParameters",void 0);__decorate([serialize("useReflectionFresnelFromSpecular")],StandardMaterial.prototype,"_useReflectionFresnelFromSpecular",void 0);__decorate([expandToProperty("_markAllSubMeshesAsFresnelDirty")],StandardMaterial.prototype,"useReflectionFresnelFromSpecular",void 0);__decorate([serialize("useGlossinessFromSpecularMapAlpha")],StandardMaterial.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"useGlossinessFromSpecularMapAlpha",void 0);__decorate([serialize("maxSimultaneousLights")],StandardMaterial.prototype,"_maxSimultaneousLights",void 0);__decorate([expandToProperty("_markAllSubMeshesAsLightsDirty")],StandardMaterial.prototype,"maxSimultaneousLights",void 0);__decorate([serialize("invertNormalMapX")],StandardMaterial.prototype,"_invertNormalMapX",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"invertNormalMapX",void 0);__decorate([serialize("invertNormalMapY")],StandardMaterial.prototype,"_invertNormalMapY",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"invertNormalMapY",void 0);__decorate([serialize("twoSidedLighting")],StandardMaterial.prototype,"_twoSidedLighting",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],StandardMaterial.prototype,"twoSidedLighting",void 0);__decorate([serialize()],StandardMaterial.prototype,"useLogarithmicDepth",null);RegisterClass("BABYLON.StandardMaterial",StandardMaterial);Scene.DefaultMaterialFactory=a=>new StandardMaterial("default material",a);const name$4="imageProcessingCompatibility",shader$4=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;ShaderStore.IncludesShadersStore[name$4]=shader$4;const name$3="gridPixelShader",shader$3=`#extension GL_OES_standard_derivatives : enable
#define SQRT2 1.41421356
#define PI 3.14159
precision highp float;
uniform float visibility;
uniform vec3 mainColor;
uniform vec3 lineColor;
uniform vec4 gridControl;
uniform vec3 gridOffset;
varying vec3 vPosition;
varying vec3 vNormal;
#include<fogFragmentDeclaration>
#ifdef OPACITY
varying vec2 vOpacityUV;
uniform sampler2D opacitySampler;
uniform vec2 vOpacityInfos;
#endif
float getDynamicVisibility(float position) {
float majorGridFrequency=gridControl.y;
if (floor(position+0.5)==floor(position/majorGridFrequency+0.5)*majorGridFrequency)
{
return 1.0;
} 
return gridControl.z;
}
float getAnisotropicAttenuation(float differentialLength) {
const float maxNumberOfLines=10.0;
return clamp(1.0/(differentialLength+1.0)-1.0/maxNumberOfLines,0.0,1.0);
}
float isPointOnLine(float position,float differentialLength) {
float fractionPartOfPosition=position-floor(position+0.5); 
fractionPartOfPosition/=differentialLength; 
fractionPartOfPosition=clamp(fractionPartOfPosition,-1.,1.);
float result=0.5+0.5*cos(fractionPartOfPosition*PI); 
return result; 
}
float contributionOnAxis(float position) {
float differentialLength=length(vec2(dFdx(position),dFdy(position)));
differentialLength*=SQRT2; 
float result=isPointOnLine(position,differentialLength);
float dynamicVisibility=getDynamicVisibility(position);
result*=dynamicVisibility;
float anisotropicAttenuation=getAnisotropicAttenuation(differentialLength);
result*=anisotropicAttenuation;
return result;
}
float normalImpactOnAxis(float x) {
float normalImpact=clamp(1.0-3.0*abs(x*x*x),0.0,1.0);
return normalImpact;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
float gridRatio=gridControl.x;
vec3 gridPos=(vPosition+gridOffset.xyz)/gridRatio;
float x=contributionOnAxis(gridPos.x);
float y=contributionOnAxis(gridPos.y);
float z=contributionOnAxis(gridPos.z);
vec3 normal=normalize(vNormal);
x*=normalImpactOnAxis(normal.x);
y*=normalImpactOnAxis(normal.y);
z*=normalImpactOnAxis(normal.z);
#ifdef MAX_LINE 
float grid=clamp(max(max(x,y),z),0.,1.);
#else
float grid=clamp(x+y+z,0.,1.);
#endif
vec3 color=mix(mainColor,lineColor,grid);
#ifdef FOG
#include<fogFragment>
#endif
float opacity=1.0;
#ifdef TRANSPARENT
opacity=clamp(grid,0.08,gridControl.w*grid);
#endif 
#ifdef OPACITY
opacity*=texture2D(opacitySampler,vOpacityUV).a;
#endif 
gl_FragColor=vec4(color.rgb,opacity*visibility);
#ifdef TRANSPARENT
#ifdef PREMULTIPLYALPHA
gl_FragColor.rgb*=opacity;
#endif
#else 
#endif
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;ShaderStore.ShadersStore[name$3]=shader$3;const name$2="gridVertexShader",shader$2=`precision highp float;
attribute vec3 position;
attribute vec3 normal;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#include<instancesDeclaration>
uniform mat4 projection;
uniform mat4 view;
varying vec3 vPosition;
varying vec3 vNormal;
#include<fogVertexDeclaration>
#ifdef OPACITY
varying vec2 vOpacityUV;
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<fogVertex>
vec4 cameraSpacePosition=view*worldPos;
gl_Position=projection*cameraSpacePosition;
#ifdef OPACITY
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
if (vOpacityInfos.x==0.)
{
vOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));
}
else
{
vOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));
}
#endif 
vPosition=position;
vNormal=normal;
#define CUSTOM_VERTEX_MAIN_END
}`;ShaderStore.ShadersStore[name$2]=shader$2;class GridMaterialDefines extends MaterialDefines{constructor(){super(),this.OPACITY=!1,this.TRANSPARENT=!1,this.FOG=!1,this.PREMULTIPLYALPHA=!1,this.MAX_LINE=!1,this.UV1=!1,this.UV2=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class GridMaterial extends PushMaterial{constructor(e,t){super(e,t),this.mainColor=Color3.Black(),this.lineColor=Color3.Teal(),this.gridRatio=1,this.gridOffset=Vector3.Zero(),this.majorUnitFrequency=10,this.minorUnitVisibility=.33,this.opacity=1,this.preMultiplyAlpha=!1,this.useMaxLine=!1,this._gridControl=new Vector4(this.gridRatio,this.majorUnitFrequency,this.minorUnitVisibility,this.opacity)}needAlphaBlending(){return this.opacity<1||this._opacityTexture&&this._opacityTexture.isReady()}needAlphaBlendingForMesh(e){return e.visibility<1||this.needAlphaBlending()}isReadyForSubMesh(e,t,i){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new GridMaterialDefines);const r=t.materialDefines,s=this.getScene();if(this._isReadyForSubMesh(t))return!0;if(r.TRANSPARENT!==this.opacity<1&&(r.TRANSPARENT=!r.TRANSPARENT,r.markAsUnprocessed()),r.PREMULTIPLYALPHA!=this.preMultiplyAlpha&&(r.PREMULTIPLYALPHA=!r.PREMULTIPLYALPHA,r.markAsUnprocessed()),r.MAX_LINE!==this.useMaxLine&&(r.MAX_LINE=!r.MAX_LINE,r.markAsUnprocessed()),r._areTexturesDirty&&(r._needUVs=!1,s.texturesEnabled&&this._opacityTexture&&MaterialFlags.OpacityTextureEnabled))if(this._opacityTexture.isReady())r._needUVs=!0,r.OPACITY=!0;else return!1;if(MaterialHelper.PrepareDefinesForMisc(e,s,!1,!1,this.fogEnabled,!1,r),MaterialHelper.PrepareDefinesForFrameBoundValues(s,s.getEngine(),this,r,!!i),r.isDirty){r.markAsProcessed(),s.resetCachedMaterial(),MaterialHelper.PrepareDefinesForAttributes(e,r,!1,!1);const n=[VertexBuffer.PositionKind,VertexBuffer.NormalKind];r.UV1&&n.push(VertexBuffer.UVKind),r.UV2&&n.push(VertexBuffer.UV2Kind),r.IMAGEPROCESSINGPOSTPROCESS=s.imageProcessingConfiguration.applyByPostProcess,MaterialHelper.PrepareAttributesForInstances(n,r);const o=r.toString();t.setEffect(s.getEngine().createEffect("grid",n,["projection","mainColor","lineColor","gridControl","gridOffset","vFogInfos","vFogColor","world","view","opacityMatrix","vOpacityInfos","visibility"],["opacitySampler"],o,void 0,this.onCompiled,this.onError),r,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=!!i,!0)}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.materialDefines;if(!s)return;const n=i.effect;n&&(this._activeEffect=n,this._activeEffect.setFloat("visibility",t.visibility),(!s.INSTANCES||s.THIN_INSTANCE)&&this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("view",r.getViewMatrix()),this._activeEffect.setMatrix("projection",r.getProjectionMatrix()),this._mustRebind(r,n)&&(this._activeEffect.setColor3("mainColor",this.mainColor),this._activeEffect.setColor3("lineColor",this.lineColor),this._activeEffect.setVector3("gridOffset",this.gridOffset),this._gridControl.x=this.gridRatio,this._gridControl.y=Math.round(this.majorUnitFrequency),this._gridControl.z=this.minorUnitVisibility,this._gridControl.w=this.opacity,this._activeEffect.setVector4("gridControl",this._gridControl),this._opacityTexture&&MaterialFlags.OpacityTextureEnabled&&(this._activeEffect.setTexture("opacitySampler",this._opacityTexture),this._activeEffect.setFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),this._activeEffect.setMatrix("opacityMatrix",this._opacityTexture.getTextureMatrix()))),MaterialHelper.BindFogParameters(r,t,this._activeEffect),this._afterBind(t,this._activeEffect))}dispose(e){super.dispose(e)}clone(e){return SerializationHelper.Clone(()=>new GridMaterial(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.GridMaterial",e}getClassName(){return"GridMaterial"}static Parse(e,t,i){return SerializationHelper.Parse(()=>new GridMaterial(e.name,t),e,t,i)}}__decorate([serializeAsColor3()],GridMaterial.prototype,"mainColor",void 0);__decorate([serializeAsColor3()],GridMaterial.prototype,"lineColor",void 0);__decorate([serialize()],GridMaterial.prototype,"gridRatio",void 0);__decorate([serializeAsVector3()],GridMaterial.prototype,"gridOffset",void 0);__decorate([serialize()],GridMaterial.prototype,"majorUnitFrequency",void 0);__decorate([serialize()],GridMaterial.prototype,"minorUnitVisibility",void 0);__decorate([serialize()],GridMaterial.prototype,"opacity",void 0);__decorate([serialize()],GridMaterial.prototype,"preMultiplyAlpha",void 0);__decorate([serialize()],GridMaterial.prototype,"useMaxLine",void 0);__decorate([serializeAsTexture("opacityTexture")],GridMaterial.prototype,"_opacityTexture",void 0);__decorate([expandToProperty("_markAllSubMeshesAsTexturesDirty")],GridMaterial.prototype,"opacityTexture",void 0);RegisterClass("BABYLON.GridMaterial",GridMaterial);const XColor$1=new Color3(1,.255,.212),YColor$1=new Color3(.18,.8,.251);function buildGrid(a){const e=new Node("gridNode",a),t=new GridMaterial("gridMaterial",a);t.majorUnitFrequency=5,t.minorUnitVisibility=.45,t.gridRatio=2,t.backFaceCulling=!1,t.mainColor=new Color3(.471,.471,.471),t.lineColor=new Color3(.471,.471,.471),t.opacity=.98;const i=MeshBuilder.CreatePlane("grid",{size:1e3},a);i.material=t,i.parent=e,i.isPickable=!1;const r=new StandardMaterial("xAxis_mat",a);r.diffuseColor=XColor$1;const s=MeshBuilder.CreateTube("xAxis",{path:[new Vector3(-500,0,0),new Vector3(500,0,0)],radius:.05},a);s.material=r,s.parent=e,s.isPickable=!1;const n=new StandardMaterial("xAxis_mat",a);n.diffuseColor=YColor$1;const o=MeshBuilder.CreateTube("xAxis",{path:[new Vector3(0,-500,0),new Vector3(0,500,0)],radius:.05},a);return o.material=n,o.parent=e,o.isPickable=!1,e}class TargetCamera extends Camera{constructor(e,t,i,r=!0){super(e,t,i,r),this._tmpUpVector=Vector3.Zero(),this._tmpTargetVector=Vector3.Zero(),this.cameraDirection=new Vector3(0,0,0),this.cameraRotation=new Vector2(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new Quaternion,this.rotation=new Vector3(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=Vector3.Zero(),this._initialFocalDistance=1,this._viewMatrix=Matrix.Zero(),this._camMatrix=Matrix.Zero(),this._cameraTransformMatrix=Matrix.Zero(),this._cameraRotationMatrix=Matrix.Zero(),this._referencePoint=new Vector3(0,0,1),this._transformedReferencePoint=Vector3.Zero(),this._defaultUp=Vector3.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new Quaternion(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=Epsilon),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),Matrix.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(TmpVectors.Matrix[0]),Vector3.TransformNormalToRef(this.cameraDirection,TmpVectors.Matrix[0],TmpVectors.Vector3[0]),this.position.addInPlace(TmpVectors.Vector3[0]);return}this.position.addInPlace(this.cameraDirection)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*e,this.rotation.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this.rotation.x>1.570796&&(this.rotation.x=1.570796),this.rotation.x<-1.570796&&(this.rotation.x=-1.570796)),this.rotationQuaternion&&this.rotation.lengthSquared()&&Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)),t&&(Math.abs(this.cameraDirection.x)<this.speed*Epsilon&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*Epsilon&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*Epsilon&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*Epsilon&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*Epsilon&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return Vector3.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?Axis.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(Quaternion.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),Axis.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const r=this.parent.getWorldMatrix();Vector3.TransformCoordinatesToRef(e,r,this._globalPosition),Vector3.TransformCoordinatesToRef(t,r,this._tmpTargetVector),Vector3.TransformNormalToRef(i,r,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?Matrix.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):Matrix.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?Matrix.LookAtRHToRef(e,t,i,this._viewMatrix):Matrix.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const r=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(r,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==Camera.RIG_MODE_NONE){const i=new TargetCamera(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,(this.cameraRigMode===Camera.RIG_MODE_VR||this.cameraRigMode===Camera.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new Quaternion),i._cameraRigParams={},i.rotationQuaternion=new Quaternion),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Camera.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,r=this.cameraRigMode===Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*r,t);break}case Camera.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,TargetCamera._TargetFocalPoint),TargetCamera._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const r=TargetCamera._TargetFocalPoint.addInPlace(this.position);Matrix.TranslationToRef(-r.x,-r.y,-r.z,TargetCamera._TargetTransformMatrix),TargetCamera._TargetTransformMatrix.multiplyToRef(Matrix.RotationAxis(t.upVector,e),TargetCamera._RigCamTransformMatrix),Matrix.TranslationToRef(r.x,r.y,r.z,TargetCamera._TargetTransformMatrix),TargetCamera._RigCamTransformMatrix.multiplyToRef(TargetCamera._TargetTransformMatrix,TargetCamera._RigCamTransformMatrix),Vector3.TransformCoordinatesToRef(this.position,TargetCamera._RigCamTransformMatrix,t.position),t.setTarget(r)}getClassName(){return"TargetCamera"}}TargetCamera._RigCamTransformMatrix=new Matrix;TargetCamera._TargetTransformMatrix=new Matrix;TargetCamera._TargetFocalPoint=new Vector3;__decorate([serializeAsVector3()],TargetCamera.prototype,"rotation",void 0);__decorate([serialize()],TargetCamera.prototype,"speed",void 0);__decorate([serializeAsMeshReference("lockedTargetId")],TargetCamera.prototype,"lockedTarget",void 0);var xUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAADDFJREFUeJzt3X9s3HUdx/HXXa+9tuuPdV1/3xkDojCEZGqMJvzwV5SIhmCiRg1KFITB5uYcbsDGj20wwsaP/RJRMWKMwagxgolo4u9oImjUDJ2yKNL2+mPd2rXrer1e784/wDCgbO/+uPX7/b6fj3/36d03ae+5+/74fD6x0sqVJQFwKb7YBwBg8RAAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4lljsA8CrPTE6qn9MTprGvmPJEl1aV1fmI3q1fKmk3UNDKpRKpvHXNDerOcGfW9DwGwmgzspKXfncc6YPV1sioX+uWKGlFRVn4MhesmdoSDdlMqaxlzU0aGNbW5mPCHPBKUAAvbW2VjcsX24aOzg9ra0DA2U+opc7PD2tbcb3rInHtT+VKvMRYa4IQEBt7+hQV2WlaezeoSEdyGbLfEQv2dTXp9FCwTT2lrY2nZVMlvmIMFcEIKAaKip0X1eXaex0qaQbe3tlOxufnz9PTOjRo0dNY89JJrWhtbXMR4T5IAAB9vGmJl3e0GAa+7vxcX1/ZKSsx1OSdGNvr4rG8Q+l06qO8ycWZPx2Am53KmX+EH0pk9GJovXjOXvfOnpUfzxxwjT2E01Nem99fdmOBQuDAATc2cmkbjZeQe/N57VjcLAsx3G8UNCt/f2msQ0VFdplPH3B4iIAIbCprU3nVVebxu4cHNSzudyCH8OdAwPqz+dNY7d3dKjTeAETi4sAhEBVLKaH0mnFDGOnSiWt6elZ0Pc/lMtp39CQaeyFNTVaZbyFicVHAELi0ro6fWrZMtPYnx8/rp+Mji7Ye6/t7VXO8FBSXNJX02klYpZUIQgIQIjs6upSk/GJv3WZjCYX4ILgj0dH9dOxMdPYzy9frncuWTLv98SZQwBCpC2R0N2dnaax/87ltOvw4Xm931SpZH7ctzmR0LaOjnm9H848AhAys/lf9u7BQf13amrO77VzcFCHjBcU7+vq0nIm+4QOAQiZuKSH02lVGs6zs8Wi+X/wV8rk87rHeEvxoro6fdp4fQLBQgBC6IKaGq1paTGN/cGxY/qZ8Rz+ZDdlMho3XENIxGLan0qZ7lAgeAhASG3r6NDrq6pMY7+YyShvnLcvSb8/cUKPGR8rXt/aqgtrasyvjWAhACFVG4+bJwsdnJzUHuN9/KKkdcaJRemqKm1pbze9LoKJAITYR5Yu1YcbG01j7+zvV5/hSb6HjxzRnyYmTK+5u6tLdUz2CTV+eyG3L5XSEsOH8HixqE19faccM1Io6Dbj8/6XNTToyqVLTWMRXAQg5F5XVaXNxq/h3xke1m/Hx1/z37f09+vI9PRpX4dVfqKDAETABuOFuJKk1b29mp7hguDfJyf18JEjpve7lVV+IoMARMBsbsUdyGb1tRlW9Fnd0zNjGF7pnGRSG1jgMzIIQERcVFenq5ubTWM39/W97Kv+90ZG9OtTnBqc7KF0Wkkm+0QGAYiQnZ2dajE8jjtSKGjzixf7ssWiNp7m4uD/fZJVfiKHAERIcyKhHcbJQl8/ckRPTUxox+CgnjfMF2ioqNBOVvmJHAIQMZ9tbtbFhp2CipKu6e7WTuOMQVb5iSYCEDExvXCebpksdCCbNa0ZwCo/0UUAIuj86mqtX6D1+FnlJ9oIQETd1t5unix0Kteyyk+kEYCIqo3HtXeeT+u1zuKiIsKJAETYhxob5/W8/r2zWIMQ4UQAIm6uM/YuYZUfFwhAxKWrqnTHLBfrTMRi2ssqPy4QAAfWtrRo5SxW7WGVHz8IgAOJWEyXGXcZlqR3Gx4kQjQQAAe6p6bMS4JJ9p2AEH4EwIE1vb2z2jb82VxO981zUxGEAwGIuCdGR/X4HPYJ3D4woP+UYZdhBAsBiLBssai1vb1z/tkb5/izCA8CEGF3DQ7quXlsDfbk2Jh+eOzYAh4RgoYARNShXE67jFt7ncqa3l6NFgoLcEQIIgIQUat6ehbkSn5/Pq+tAwMLcEQIIgIQQY+NjOgXx4+fdpz1Sb89Q0P6WzY7v4NCIBGAiDleKGiDcUfg1S0tepfhoZ/pUknXdnfLfiMRYUEAImZLf78yhi3AllVU6Pb2du0zLvbx9MSEvmHcNwDhQQAi5EA2q/3GD+ndnZ1qTiR0fnW1rjcu97Wpr0+HDTsHITwIQESUJF1v3NxjZU2NrjlpD4GtHR3m5cS/bDy9QDgQgIh45OhR/eHECdPYB1MpVZz0tb+pokJ3GVf++fbwsH5puMCIcCAAETBcKOiWWWzucckMF/4+19yst9fWnvbnS1q4W4xYfAQgAjZmMhoynJvXxuOvucZfXNL+dNr0B/FsLqf7mSwUCQQg5J6emNA3Z9jscya3trfrdadYKfhttbX6jHF/wW1MFooEAhBihVJJ1xnvz5+VTGp9S8tpx93T2amlhoVAmSwUDQQgxPYODekvxif07u/qUrVhcdDWREK3t7ebXvPJsTH9iMlCoUYAQmogn9cdxmf031dfrysaG82vvbqlxbwm4NpMRuOzWGwEwUIAQmp9JmOapZeIxfTALDcIScRi2mdcFbhnakp3vLjVOMKHAITQb8bH9djIiGnsF1pa9Obq6lm/x8V1dfpoU5Np7O6hIf2VyUKhRABCZqpU0qqeHlnuwrcmEtpiPJ+fyX3GTUWmZ3ExEsFCAEJm5+CgDk5OmsbuMF7Rfy2pykrdbAzIUxMTesR4OxLBQQBCpHtqSjuMq/y8pbZWVxvv6Z/KhtZWvTGZNI3dlMkwWShkCECIrDYu7x3TC3sCLsQvtyoW0x7jRcThQkEbmSwUKgQgJB4fHdUTxuW9r1q2TBct4O4+H2ho0OXGnYUeHR7Wr8bHF+y9UV4EIASyxaLWGZ+6qz/F8/7zsTuVMj1IVJK0qrubyUIhQQBCYPvAgHl5783t7eqsrFzwYzjb+CixJP0rl9MDTBYKhVhp5UpSHWCHcjldcPCg6X/UNySTeua885Q0LPE1FxPFolYcPKjnDTGqicf1zLnn6izjBUQsDr4BBNxs5t7vTqXK9uGXXphOfK/x9ILJQuFAAALsu8blvSXp/fX1+uAstgCfq481Nek99fWmsUwWCj4CEFBjhYJuMt5Sq4rFtCedLvMRvWRvKqVK4zcNJgsFGwEIqC39/eozLO8tSetaW/WmM3iuvaK6WjcYVxLumZrSnUwWCiwCEEAHsll9xbi8d1sioVva2sp8RK+2taNDHca7DQ8yWSiwCEDAFCVdZ1zeW5Lu7epS4zye95+rhooK3dXRYRrLZKHgOv1i8Dij+vN5XdHYaFrAozoe11XLlp2Bo5rZ1c3NGisWNWk8x+/P59VVhmcUMHc8BwA4xikA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAY/8DtrESS5Hthr8AAAAASUVORK5CYII=",yUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAACLJJREFUeJzt3VmIJHcdwPFfdU/39PTsNcnszM6xazQEhUB0owEXhQheSBA8wAs1eMQQMRgiQRONMZerkYAIIoKIEHwQH0QQ0RdF8CEPyoqC4BmRTBKzZjebY66dmfYhSMQc/e/dnZ2u/n0+z39mCqrr+/9XdVV1daQ33QsgpcZObwCwcwQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhsbKc3gOd68v6NeOJXp4vGTr6qGfve2t7mLXp+j/98PZ7+3WbR2D1XtmL3a33cho09MoTa84148Lbl2Frr9R07Nt2Iyx+Yiuau6jxs2bO2lnvx1w8/Facf3eo7tmpFHP7T1HnYKgblFGAIjR9qxMzHxovGbvx7Kx79zuo2b9Fz/evbq0UHf0TE7Cc6Mf7S5jZvEWeiOtKb7j/NcN6tP7wVxy4+GVsr/XdPe64Rh/8+FY3O+VkFbK314tjFJ2N9qX8AGp0qDv9lKtqL5pphZK8MqfZcI2av7RSNXX94K45/b22bt+hZx7+7VnTwR0TMXtdx8A8xe2aILdwyEc3dZbP60tHl6K1v8wZFRO90xNLXVorGNiarWPjsxDZvEWdDAIZYa38jDnyybBWw9s+tOP797b8WcPy+1Vh7oOzK/9z1nWjN+ogNM3tnyM3f1I3mnsJVwN0r0dvYvm3pbUYsfbVs9m/uqmLuRrP/sBOAITd2YRVzN5QdSKt/24zHfrh91wIe+8FarP65cPb/zES09vt4DTt7qAbmb5yIsQvKVgEP3rUcUXZ9bjC9iKWvlM3+Y/uqmPu02b8OBKAGmnurmC9cTq/8cTNO/PjcXw088aP1WP5D2fnF/E0TMTZ1fm9M4swIQE3M3TARrZmy3fXgncsR5/jujqWjy0XjxqYbceB6s39dCEBNNCarmL+p7MB6+thGPP6zc7cKOPnT9XjqN2Wz/8Lnyr+6ZOcJQI0c+FQn2guFq4A7ymbsEktHy87923ONOHBd2deWDAcBqJFGp/zGmifv34hTvyx7ovDFnPrF6Xjy12V/Z+GWbjS6Zv86EYCamb12IsYvKnuwZumus18FlP6N8UONmLmm7AEmhocA1EzVjli4uWwVMMjs/XwGWUUsfKEbjXGzf90IQA3NfKQTnYsLVwGF5+/Pp/Q6wvhFzZi52rl/HQlADVWtiMVbu0VjB7mC/78G+Sbh4O3dqHbmpUScJQGoqekPjsfEK0pXAYNfCyi9l6BzSTOmP+Dcv64EoKaqZsTiF8tWAYPcxRcx2N2EB+/oRuXFcrUlADU2/d7xmHxlwdE3wH38EeXPE3Qvbcb0e8z+dSYAddYoXwWUPsk3yBOFB++c9AmqObuv5i54Zzt2XdF/FVD6LH/pOwUmLx+LC97hyl/dCUDdVRGLt5WtAo7ftxpr/3jhVcAgbxU6eGc3wtf+tScAI2DqqnbsPlKwCjgdsXTPC68CSt8ruOuKsZh6m9l/FAjAiDh4x2TRuBd6o+8gbxY+dHTS7D8iBGBE7H1TK/a8odV33NZaLx6697mrgIfuWYmt1f5f/O9+fSv2vrH//6EeBGCEHLqr7FrA//+qzyC/LlT6P6gHARghu1/Xir1vLlgFLPfi4a8/uwp46N6V2Hyq/+y/7y2t2HOl2X+UCMCIOfTlsvPzR765Ghsne7F5qhePfKts9l+8vew6A/XhJs4Rs+s1YzF1VTtO/uTFL+dvPtGLR76xEr1exOap/rP/1Nvbft57BPlx0BH09LGN+P2rH+/7MM9/XzW+caLPwCrist/ui8nDAjBqnAKMoMnDY3Hhu/rfo79xotf/4I+IC9897uAfUQIwohZv756bvduIWLzVa75HlQCMqO6lzZh+39k/qTf9/vHoXmb2H1UCMMIOfunsntWvmuVvHqKeBGCEdS5pxv4Pnfm7+vZf3YmJl5e9dYh6EoARt3jbmb2vr2pFLHzeuf+oE4ARN/6SRsx8dPBVwMzHO9F5mdl/1AlAAou3dqMxUf74XqNTxeItzv0zEIAE2vONmL2mfBUwe20n2os+GhnYy0ks3DxRtrcbz/zCLzkIQBKtA42oCk7pq+YzY8nBnobEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBIbGynN4Dz59Ddk9HbevExlSkhlepIb7q30xsB7Ay9h8QEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBI7D/Zj419kHQdHgAAAABJRU5ErkJggg==",zUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAACApJREFUeJzt3UuMlXcZx/HnzA1mYGDOQG0UEIhCwnCLRjfaRN2oiRsx9bZy07RpbCxJC7XegpZ6KSmtSRc2deFGa9xaXbjRGtuNJgYKWCqkNNA6Gpgr04G5HRckTZq2+m/CO2fe83w+6yfht4BvhuTlT2PrgVYrgJS62j0AaB8BgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAASEwBITAAgMQGAxAQAEhMASEwAIDEBgMQEABITAEhMACAxAYDEBAAS62n3AMosXv93zLzyi3bPKDL4gXui0b2m3TMoIAA1sTj7Woyf/ma7ZxRZ8/6vRbcA1IK/AkBiAgCJCQAkJgCQmABAYgIAiQkAJCYA3FS9g7uie9XGds+gkA+BaqJv6EOx9UBr2X/d62PPx+izt0VE2a/d3Hs8ouG3VV34CYB31lqKsZMHo/QP/8B7Px/9t3622k3cVALAO5q+8FTMjf+16LbR1RdDex6peBE3mwDwtpbmx2PizHeK79ftOBS9a3dUuIgqCABva+LMd2Np7nLRbXf/pli/sx7/UIk3EwDeYn7qdEy//GTxfXP3I9HoWVvhIqoiALzF2Il7IloLRberhj8Wa7Z8teJFVEUAeJOZS0/Htct/KjtudMXwvscjolHlJCokALyhtfh6TJx+sPh+7dY7oq/50QoXUTUB4A2TLx6NhddfKbrt6m3G0MjRihdRNQEgIiIWZs7H1PnHiu+Hdh2J7lW3VLiI5SAARETE2MmD0Vq8VnTbOzgSa7ffXfEiloMAELP/+UPMjj5TfN/cezwaXb0VLmK5CEByraW5GD/xjeL7gfd9Ifpv/UyFi1hOApDc1LnjMX/1bNFto2tVNPf8pOJFLCcBSGzx2mhMnf1R8f26nYejZ80HK1zEchOAxMZP3RdLC1NFt939m2P9zgcqXsRyE4Ckro89HzMXny6+b+455r/76kACkFFrKcZO3hulD32s2vDxWLP5y9Vuoi0EIKHpC0/G3Pjfyo4bXTG81/f+nUoAkrnx0Mf3iu8Ht90Zfc2PVLiIdhKAZCZOf7v4oY8b3/s/VPEi2kkAEpmfOhXTF54qvh8a+UF09Xniu5MJQCLv5qGP3sGRWLvtrooX0W4CkMTMxV/FtcvPFt839z3me/8EBCCB1sLVGD99uPh+YNPt0f+eT1e4iJVCABKYPPtwLM6+WnTb6O6P5p5jFS9ipRCADrcwcz6mzpU/9LFux+HoGdhW3SBWFAHocGMn743W0vWi2xvf+x+qeBEriQB0sNnRZ2J29HfF98N7H/W9fzIC0KFaS3Mx/sJ9xferNtwWA5u+WOEiViIB6FBT5x6N+asvlR03umN4/xPhe/98BKADLc6+GpNnf1h8P7j9ruhbv7/CRaxUAtCBxk8ditbC1aLbrt5mDO36fsWLWKkEoMNcv/JczFz6dfH90MhR3/snJgCdpLUYYye+HqUPffSu2x2D2++sdhMrmgB0kOmXfxZzkyeK74f3PxHR6KlwESudAHSIpbmxmPjHkeL7gU1fitUbP1nZHupBADrExJlvFT/0ceN7f+/7IwAdYW7i7zF94efF9+t3PuB7fyJCADpAK8ZfOBjRWiy67unfEut2+N6fGwSg5mYu/jKuXf5z8X1z7/FodA9UuIg6EYAaay1cjfFT5f9bz+pbPhUDm26vcBF1IwA1NvHiQ7F47bWy40Z3NPc+Xu0gakcAamph5lxMn/9p8f3g9rujb/2+ChdRRwJQU+/moY+uvuEY2nWk2kHUkgDU0Ozob2N29PfF90MjD0dX34YKF1FXAlAzNx76uL/4vnfdnhjcdkeFi6gzAaiZqX8eK3/oI3zvz/8mADWyOHspJl/6cfH9ms1fidUbP1HhIupOAGpk/NT9xQ99NLr7Y2h3eSzISQBq4vqVv8TMpd8U36/f+WD0DGytcBGdoLH1QKvs9Qjap7UY//rjh2Nu8mS7lxTb8rkr0dU33O4Z/B9+AqiBpfnJWv3hpz4EABITAEhMACAxAYDEBAASEwBITAAgMf9KpAYa3QPRrNlnvd4drAdfAkJi/goAiQkAJCYAkJgAQGICAIkJACQmAJCYAEBiAgCJCQAkJgCQmABAYgIAiQkAJCYAkJgAQGICAIkJACQmAJCYAEBiAgCJCQAkJgCQmABAYgIAiQkAJCYAkJgAQGICAIkJACQmAJCYAEBiAgCJCQAkJgCQmABAYgIAiQkAJCYAkJgAQGICAIkJACQmAJCYAEBiAgCJCQAkJgCQmABAYgIAiQkAJCYAkJgAQGICAIkJACQmAJCYAEBiAgCJCQAkJgCQmABAYgIAiQkAJCYAkJgAQGICAIkJACQmAJCYAEBiAgCJCQAkJgCQmABAYgIAiQkAJCYAkJgAQGICAIkJACQmAJCYAEBiAgCJCQAkJgCQmABAYgIAiQkAJCYAkJgAQGICAIkJACQmAJDYfwFg1lu3oXQGDgAAAABJRU5ErkJggg==",xHoverUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAACzZJREFUeJzt3WlsVGUbh/H/tGAjEFAogktAtHGDROuWiBE0EokGImoimzaxCihiRUUKLt/cAGWRLUoRgwYFjZhUU6NGjRiMC0rUKInggqACFi1YrUDb98MTE94GnHs6c+g5575+n0y8Z+ZJSK9OZ87znExreXmrALhU1NELANBxCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABzr1NELwCEMGSKdcopt9ssvpQ0bol3PoXTqJI0bJxUZf4esXSs1NES7JuSMAMTRrl3S3Lm2H676eunaa6W9e6Nf18HGjpWmTrXNrl8vPftspMtB+/AnQBx98420Zo1ttlcvaeLEaNfTVs+e0oQJttl//pEefTTa9aDdCEBcLV4s7dxpmx0zRiori3Y9B6uqkrp1s80uXy5t3x7tetBuBCCuGhvDnwEWxcXSzJlSJhPtmiTpzDOlESNss1u3SitXRrse5IUAxNmbb0rr1tlmy8ulYcOiXU8mE0Jj/eDvkUekffuiXRPyQgDibs4c+w/R3XdLRx8d3VpGjpQGDbLNvvGG9PHH0a0FBUEA4m7bNumZZ2yzffpIlZXRrKNLF2nKFNtsY6M0b14060BBEYAkWLFC+v5722xFhdS/f+HXMGmSVFpqm128OHyVidgjAEmwf3/4e7q1Nfts587S9OmFff1+/aTRo22z334rvfRSYV8fkSEASbFhg1RXZ5u96CLpkksK99r33isddVT2uZYW6eGHpebmwr02IkUAkmTePGnPHtus9Yc2m0svlS6+2Db7yivSF1/k/5o4YghAktTXS4sW2WZPOil8HpCPzp3tl/s2NEhLluT3ejjiCEDS5PJb9uabpRNOaP9rVVSEv/8t5s6V/vij/a+FDkEAkqalRXroIenAgeyzJSX23+BtHXecdNNNttmNG6XXXmvf66BDEYAk2rxZevFF2+ywYeFDwVxNnRq++8+muTls9rF8Q4HYIQBJtWSJ9PPPttlp08L+fatzzpGGD7fNPv98+OoPiUQAkqqpyb5ZaMCAsH/foqgoBMOysWjHDmnZMtvzIpYIQJK98470/vu22YkTpd69s89dd5101lm255w9W/rrL9ssYokAJN1jj0l//519rmvXsI//v3TvLt12m+1116+X3n3XNovYIgBJ9+uvUk2Nbfaqq6Rzzz38/588WTrmmOzPwyk/qUEA0mDlStsHcZmMNGNGOECkrVNPDW//LWpqOOUnJQhAGuTyVVxZ2aF/0KurDx2GtrZulZ57Lvc1IpYIQFps3CjV1tpm277Vv+IK6fzzbY/llJ9UIQBpMm+e9Pvv2ee6d5duvz38d0mJdOedtuevq+OUn5QhAGnS0CAtXGibveaacLxXZaV0/PHZ5xsbpfnz81sfYifTWl7ONZxpksmED+nKy7PPbt4cNvtYtg3Pnm2//BiJwTuAtGltDX+nWzYLlZXZfvg55Se1CEAabdkSrtEvBE75STUCkFZPP23fLPRf1q7llJ8UIwBp1dQkzZqV33Ps3m3/UBGJRADSbN26/K7XX7DAfgYhEokApF17d+x99hmn/DhAANJuxw7pqadye0xzc/jzgVN+Uo8AeLBqlbRpk32eU37cIAAeNDeH/ftWn3wS3VoQKwTAg7597UeCSYW7qQhijwB4UF2d223D+/eXbrwxuvUgNghA2g0ZIg0dmvvjbrlFOvHEwq8HsUIA0qykJLydb+9jZ84s7HoQOwQgzfL9LT54sHT55YVbD2KHAKRVv36F+Tu+ulrq1i3/50EsEYC0uu++wnySX1oa7imAVCIAaTR8uHThhdnnrFf6jR0rnXZafmtCLBGAtOnSRbrrLtvs6tXSp59mnysulh58MNw2DKnCv2jaTJ4cbu2dTUND2CMwa5btsI+BA6VRo/JfH2KFAKRJWZk0erRtdtGiEIEtW6SXX7Y9pqpK6tmz/etD7BCAtMhkpPvvt93cY9OmcNLPv5YutR8nbj1CHIlAANJi1Cjp7LNts48/Hs76+9eePdLixbbHjhghXXBB7utDLBGANOjRQ5oyxTZbVxcO+2jr1Velr77K/vhMpnBfMaLDEYA0qKqSjj02+1xT0+HP+GtpCbcaP/idweH07y/dcENua0QsEYCkGzhQuvpq2+zy5eF24ofz9df2Y8AmTGCzUAoQgCQrKgof/Fm+n9++3XZX3yeflPbuzT7HZqFUIABJNmaMdMYZttknnrDd1Xf3bvsZgoMHS5ddZptFLBGApOrVS7r1VtvsRx9J771nf+7Vq+1nAk6fHq4+RCIRgKS65x7bLr3m5vDbPxfNzeEDQctegT59pEmTcnt+xAYBSKLzzgsbfixeeCHcBThXn38uvf22bXbcOOn003N/DXQ4ApA0nTuH7+Ezmeyzu3dLy5a1/7XmzrXdVKS42P5hJGKFf7GkqaiQBgywzS5caPtE/3B27JBWrLDNDhrEZqEEIgBJ0revVFlpm920Saqtzf81V66UfvzRNnvHHWwWShgCkCQzZtiO925tDfcEtFzVl83+/eG5LHr0CFclIjEIQFIMHRqO+LZ4/XVp48bCvfaHH4Y7DVuMHMlmoQQhAElQUiJNm2abbWw8/PX++Zgzx3YhUSYTrhBks1AiEIAkyOV475oaadeuwq9h2zbbpcSSdPLJ0vjxhV8DCo4AxF0ux3v/9FP43j8qy5dLv/xim504kc1CCUAA4i6XvffWt+nt1dQkzZ9vm2WzUCIQgDi78krb8d5S+KDugw+iXY8kvfWW/fbhbBaKPQIQV127SlOn2mb37w+//Y+UWbOkAwdss2wWijUCEFeTJ0u9e9tmV62Sfvgh0uX8n+++k9assc326cOdhWKMAMRRWZl0/fW22fr68OHckbZ0qfTbb7bZ8ePZLBRTBCBuioqkBx6wHe8tSQsWSH/+Ge2aDqWxMdxbwILNQrHVqaMXgDZKS8PhHZYDPPbtC1f9dZTa2nAmgfVbitJSaefOaNeEnGRay8uNd4gEkDa8JwMcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHCMAACOEQDAMQIAOEYAAMcIAOAYAQAcIwCAYwQAcIwAAI4RAMAxAgA4RgAAxwgA4BgBABwjAIBjBABwjAAAjhEAwDECADhGAADHCADgGAEAHCMAgGMEAHDsf3WKH0gfKmrHAAAAAElFTkSuQmCC",yHoverUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAACJtJREFUeJzt3f/P1XUdh/HrRkCYyiQoZpmruazmWKUupXItc87mMhvTIomk1tpcZqP+hDLRNGsW8c07EFQEEUzMIlJcsUAmJZmkTFMMBL0RlS9yA+fup9ICPO/Dfc59f855Xo/f4H6d83lt9851zrnPOZ/TNaFvbB+SIg0Z7AUkDR4DIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUrChg72ADncm5/AxPlE0+zQbWctDLd7oyM7lM3yA8UWzG1jDE6xv8UZqVNeEvrF9g72E/tc4TuVu1jKM4XVnd7GTiZzFPvYMwGZvGsFI7uExRjO27uxBDvBlzmMrzw/AZmqETwEqaDsv8GsWFM2ezDu4lMkt3uhwl/G1ohs/wHLme+OvKB8BVNQYxrGE9RzPiLqzPWxnImfTy/4B2AyGMZwlrOednFJ3tpf9XMHH2cHWAdhMjfIRQEX1sJ1lzCuaHcM4LmFSizd60+e5sujGD7CUbm/8FWYAKmweP2Evu4tmp3Bt0d8M+msow/gK3y6a3cdeFvCzFm+k/jAAFbaLHpZyW9HsOE7lIia2eCO4mMt5N6cVzS5hNjt5qcUbqT8MQMUt5Ofs4fWi2auYxnEtfGV3CMcxme8Uze5jD3cyo2W7qDkMQMW9yk4WMbNo9j28jwu4tGW7XMhlnMbpRbN38At20dOyXdQcBqAN3MUMXuOVotmrmMaQFvxau+jiq1xbNLubV7mbWU3fQc1nANrAbl7jrsKH0+/ng5zP55q+w6e5hNP5cNHsQm7ldXY1fQc1nwFoE4uYySu8XDQ7le/RRVdTjz+l8N5/FztZzJymHlutYwDaxD72spBbi2bPYDzncUHTjj2BC/kQHy2avZ2fFr90qcFnANrIEubwEtuKZr/O95t23Cl8t2iuh+3cS3fTjqvWMwBtpJf9xW+sOZNzOItP9fuYZ3M+H+Hcotl53MIb7Ov3MTVwDECbWcZ8trGlaHYq0/p9vNLr2M4LLGd+v4+ngWUA2swBepnPLUWzjdx7H0kjjyK6uZkD9B7zsTQ4DEAbWsGd/It/Fs2WPn8/ktK/I2xjC79h0TEfR4PHALShgxygm5uKZhv5C/5bNfJKwhyme+/fpgxAm3qQxTzH00Wzpa/hv1Xpewm28Ay/456Gr1/VYADaVI1D3MaPi2YbeRcfNPZuwtlczyEOFl+3qsUAtLFVLGMzT9Sda+R9/FD+eYJn2cQfWF58vaoeA9DGatSKHwWUfpKvkU8UzuJ6atSKZlVNBqDNrWYFT7Kh7lzpZ/lLzynwDx7nER4o2lHVZQDaXB99zOXGotmLuZxTeO9Rf97IWYVm8SP68Hyy7c4AdIA1rORvPFp3bijDuJJrjvrz0vMKPskG/syqhnZUNRmADjGb6UVzRzujbyNnFp7BD7z37xAGoEM8ymoe409154YxnElcfdj/T+YahnN83cv/lbWs55Fj2lHVYwA6yCyuK5r7/2/1aeTbhUqPofZgADrI46xjHQ/XnRvBSL7Et/7770lczUhOqHu5dTzEBtb0Z0VVjAHoML/kh0XPzyfyDU7iZE5kFF9katF1z+aG/q6nivHrwTvMJv7CGlbySS5627kTOIkr+CbQxYmMqnu9f+S3fr13B/LLQTvQGYynm1V1P8zzn1ONj2L028710cdUPstTbGzajqoGnwJ0oKfYyGpW1J0bxei6N36Ah7nfG3+HMgAdajbTm/I+/Ro1ugs/b6D2YwA61LNs4vfc2+/rWclSNvP3JmykKjIAHWwuN/Trs/o1DhWfeUjtyQB0sC08w4MsPubLP8AinmdzEzdS1RiADjeXG4/pfH0HOcCvuLkFG6lKDECHe5Et3M8dDV/uPhawledasJGqxAAE6OYm9vNG8Xwv+4u/e0DtzQAEeJkXuY/bi+eXMY8dbG3hRqoK3wkYYgzvYjkb657ss0aNLzCeHnYM0GYaTD4CCNHDDmocqjtX45A3/iAGQApmAKRgBkAKZgCkYAZACmYApGAGQApmAKRgBkAKZgCkYAZACmYApGAGQApmAKRgBkAKZgCkYAZACmYApGAGQApmAKRgBkAKZgCkYAZACmYApGAGQApmAKRgBkAKNnSwF9DAmcl1dNVpfh+1AdpGVeC3A0vBfAogBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBTMAUjADIAUzAFIwAyAFMwBSMAMgBfs3HN5eIhKROccAAAAASUVORK5CYII=",zHoverUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAB2FJREFUeJzt3X+o33UVx/Fz7+7SdOVaiTOpOytqZpS0WREtMC3/KOePFG1pmssiTIh+WSkTN7QiLf+qmZgtcz/A0kprzSAqTaWiHyiuNLJmLCq15co53W5/3BRCrfeFfe73fr6vx+PvA/fA5T65l3vu+46MHz8xUUCk0UEvAAyOAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGBjg16ANs+bW3XSEYPeos2a71b9a8egt6CFAPTEAc+pOve0QW/R5tofCEBf+BEAggkABBMACCYAEEwAIJgAQDABgGACwB51z31VDz406C1o5RCoJ+78fdWCE6b/4y5aWHXtRVUjI23zq66qemxXtzux5/gOgKc1OlK14sz2L/5Nt1f98Bfd7sSeJQA8rVPeXPWql7TNPvpY1cVf7XYf9jwB4CntN6fqI8va5y+/vurerd3tQzcEgKf04XdUzXt22+yfH6j64je63YduCABP8tIXVC17S/v8p9ZU/dNf//WSAPAkK8+qGpvVNvvzzVXfurnbfeiOAPBfli6pet0r2mZ3T1St/HLVxES3O9EdAeAJz9yr6txT2+fX31T1q3u624fuCQBPOOfEqoP2b5vdtr3qkrXd7kP3BICqqhqfX7V8afv8ZRuqHvhHd/swPQSAqpq8+Ntrdtvs3Vuqrt7Y7T5MDwGglhxWdeTi9nn3/sNDAMLNHqu6cHn7/Mbbqn70y+72YXoJQLj3LK160UFtszsfrfr01d3uw/QSgGD7z606ewp/Yrzavf/QEYBg57+7as4+bbNb769afV23+zD9BCDUooVVS9/QPn/xGv/tZxgJQKDRkaoLlrc/9PGzzVU33NLtTgyGAARadnTVK1/cNrt7omrlle79h5UAhNlvTtWHTmmfX7ep6te/624fBksAwnx0WftDH9u2V126rtt9GCwBCPKyF06+89fqc+vd+w87AQgylYc+7t5Sdc33ut2HwROAEMcuqXrtoe3zK937RxCAAPvuXfWJ09vnv3Nr1Y/d+0cQgAAfOLFq/ry22R07J49+yCAAQ258ftXyY9rnV19Xdd9futuHmUUAhtwFy6ue0fjQx9b7q770zW73YWYRgCF25OKqNy1qn7/oK+790wjAkJo9VnX+Ge3zP72r6safdLYOM5QADKmzjq06+Plts7t2V624wr1/IgEYQvPnVZ399vb5tZuq7rq3s3WYwQRgCH3y9Mnf/bfYtr3q8+u73YeZSwCGzOKFVcdM4aGPS9a6908mAENk1mjVqve2P/Tx2y1V627qdidmNgEYIu88uuqQBe3zK65w759OAIbE3DlVHzy5ff6GW6puu6O7fegHARgSHzu1/aGPHTu9788kARgChx5cdfJR7fPu/XmcAPTcyH9e+J3V+Jnc+reqy6/vdif6QwB67rg3Vr3m5e3zq66qeviR7vahXwSgx/bdu+rjp7XP33rH5GMf8DgB6LFzTqo6oPGhj127qy68stt96B8B6KkFB1ad+bb2+a9trNr8h+72oZ8EoKem8tDH37dXXbah233oJwHooaMOrzri1e3zn72m6sGHutuH/hKAnpk9VnXeFF74/c0fqzZ8v7t96DcB6Jn3Hdf+0EeVe3/+NwHokQOfW/X+E9rnv31z1e13drcP/ScAPXLeGe0Pfbj3p4UA9MThh1S99fXt81/4etWf/trdPgyHkfHjPQU5080arbrx0qqF44PepN1h75r89SMzm+8AeuBZ+/Tri5/+EAAIJgAQTAAgmABAMAGAYAIAwQQAgo0NegH+v4cfqfpMz856vTvYDy4BIZgfASCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGD/BtgF99bcqVjSAAAAAElFTkSuQmCC",negXUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAyBJREFUeJzt1CEBACAAwDCgv6QYiSAG4luCq8+z9x1A0vodAPxjABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABBmABD2AN/nBPhn808nAAAAAElFTkSuQmCC",negYUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAyFJREFUeJzt1DEBwCAAwLAx8fx4whfI4GiioFfH2vN8QNL/OgB4xwAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAgzAAg7AK66QTagClLPQAAAABJRU5ErkJggg==",negZUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAyFJREFUeJzt1DEBwCAAwLAx/VhAGGpABkcTBb065trnA5L+1wHAOwYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYQYAYRfqZwUBP/LD8AAAAABJRU5ErkJggg==",negXHoverUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAC+tJREFUeJzt3VtTk2cXgOEVQhK2EtkECGJrtWitorZuQEE86fSwf84/0rPOdKYVTUGrVcSC1Vb8tBISkBAMxoTsvgM3I1XJSsiGZN3XYbvI+8y03pLkfZ/Hcffy5ZwAMKmh2gsAUD0EADCMAACGEQDAMAIAGEYAAMMIAGAYAQAMIwCAYQQAMIwAAIYRAMAwAgAYRgAAwwgAYBgBAAwjAIBhBAAwjAAAhhEAwDACABhGAADDCABgGAEADCMAgGEEADCMAACGEQDAMAIAGEYAAMMIAGAYAQAMIwCAYQQAMIwAAIYRAMAwAgAYRgAAwwgAYBgBAAwjAIBhBAAwjAAAhhEAwDACABhGAADDCABgGAEADCMAgGEEADCMAACGEQDAMAIAGEYAAMMIAGAYAQAMIwCAYQQAMIwAAIYRAMAwAgAYRgAAwwgAYBgBAAwjAIBhBAAwjAAAhhEAwDACABhGAADDCABgGAEADCMAgGEEADCMAACGEQDAMAIAGEYAAMMIAGAYAQAMIwCAYQQAMIwAAIYRAMAwAgAYRgAAwwgAYBgBAAwjAIBhBAAwjAAAhjVWewHYme7hYXE06v4zRh8+lNTGRplX9CF3R4d0HDyoms0mk7I6N1fmFeEtAlDjGtxu6Tt3TjXb4vPJk59+KvOKPjRw8aK079+vml2cnCzzavA+3gLUuJU7dyS5tqaa7Th4UP0HsVQKuearlRWJ8Ld/RRGAGpfLZOTZlSvqef/4uDiczvIt6D0NjY3Sf/68bjiXk8XJScnlcuVdFLYgAHXgZTAoaw8eqGY9Xq90Dw+XeUWv9Zw6Je49e1Szq3NzEg+Hy7wi/BcBqBPBQEDSiYRqtvfMGXG1tpZ1Pa62Nuk5dUo1m47HJXT9elnXg48jAHUik0io/xA1uFzSNzpa1vX4L1yQBpdLNbs0NSWZZLKs68HHEYA6Epmfl3gopJrde/iwtPr9ZVlHa3+/dBw6pJot5O0LSo8A1JNcTp79+qvkslnV+MDEhDgaSvu/gMPhkIGJCdVsLpPha78qIwB1JhGJyPPZWdVsU2endH79dUmv33X8uDR1dalmV2ZmJBGJlPT6KAwBqEPhGzdkMxZTzfadOyeNzc0lua6zqUl6z5xRzaZiMVn+44+SXBfFIwB1KJtOy1IgoJp1ejzqOwnz6RsZEWdTk2p28do1yaZSJbkuikcA6tT6woK8ePxYNdt59Ki09Pbu6HrNPT3SefSoajb25Il6bSgvAlDH1H/LOhwycPGiiMNR9LX8Y2PiUPx8Np2WxatXi74OSosA1LFULCbhW7dUs80+n3QeOVLUdbxDQ+qvFJdv3pTNFy+Kug5KjwDUueczM5J4/lw12zc6Kk6Pp6DXb2hslP6REdVsMhqVlbt3C3p9lBcBqHO5bFb9K3djc7P6U/y3fKdPi6u9XTW7ODkpuUymoNdHeREAA14uLUlkfl412zU8LE3d3apZd0eH9Jw8qZpde/BANp49U82icgiAEUvT05J+9SrvnOPtB4IK/rEx1aPFmc1NCU1NqV4TlUUAjMgkErI0Pa2abe3vF++XX2470zY4KHs+/1z1eqHpaUnF46pZVBYBMGTt/n3ZWFxUzfZv8zSfw+lU/5bALj+7GwEwZvHKFdUHca7WVvGdPv3Rf9c9PCwerzf/xdjlZ9cjAMYko1FZmZlRzfacOPHBH/TGlpZPhuG/Vv/8k11+djkCYNDyrVuqm3E+9qt+/+ioON3uvD+bjscldONG0WtEZRAAg7LptPo5/LbBQdlz4ICIvL5bcO/hw6qfY5ef2kAAjIo9fSrrjx6pZgfGx6XB5VI/L8AuP7WDABgWDARUDwu52tvlix9+UD0xWOg25aguAmBYamND/T5d+7jwysyM+qASVB8BMG51dlZerayU5LXY5af2EADjcm++q5cSfFfPLj+1hwBA4uHwjk/kffH4Mbv81CBOB64AZ1OTfPb991VdQzwc3vbgkND0tOw5cKCoE4Oy6bQElXsQYnchABXQ4HRK2759VV1Dvtt/M5ubsjQ1Jfu/+67g19beWITdh7cAeCf68GHBz+wXcmsxdh8CgC0K3bWHXX5qGwHAFsloVBLK7/EzyaS8Wl4u84pQTgQAW+w9ckSalVuCOT0e6S3RoSKoDgKAd5wej/SfP1/Qz3QdPy7NPT1lWhHKjQDgnb6RkYLPCXQ4HLLv0iXVoSDYfQgAROTNwSBFnhTc7PNJ57FjJV4RKoH7ACogm8lUfUvsV9scDlKKv8X7RkZk/dEjSbP5Z00hABWQSSRk4ccfq72MT+o8dmzH7+Odbrf4L1yQpz//XKJVoRJ4C2BcY0tLyY4H9w4NSdvgYEleC5VBAIzrP3++4PMAtzNw8aLqsBDsDgTAsFa/X73H37+//CKZzc28cx6vV3zffLPTpaFCCIBRjoYG9eEeL/73P1m7f1+WlUeN+779VnduAKqOABjVffKkNHV15Z3LZTKy9NtvIiLyfHZWtd1XIScHoboIgEGutjbpVR7usTIzI8loVERex2Dx2jXVz7UNDuY9XxDVRwAM8r/Z5jufdDwuK7dvb/lnG//+K+sLC7rrjI2V9ANGlB4BMKZ9/37p+OIL1ezS1NRHP/gLBgKSTafz/nxjS4v0nj1b8BpROQTAEIfTKf7xcdVsPBT65OEeqVhMVu7cUb1O9/Hj6i3FUXkEwBD1p/O5nATzvNdfuX1btw2Yw/H63gAeFtqVCIAR7o4O9ffzkfv3JZ5no49sOv3u24F8dvKgEcqLABgxMD6uukMvs7mpPi1ofWFBYk+eqGb7RkeL2nEY5UUADPAeOiTtn32mmg3//ntBT/QFAwHVnoBOt7vgzUZQfgSgzjW4XNI/NqaaTa6tyeq9ewW9fjIaleezs6pZ79BQ1bdHx1YEoM71nj2r/tU7GAhILpst+Brhmzcl9fKlanZgYoKHhXYRAlDHmjo7pXt4WDW7vrAgsadPi7pONpWS0PS0atbj9Yrv1KmiroPSIwB1bGBiQhwN+f8Tv3+/f7HWHjyQl8GgatZ3+jQPC+0SBKBO7f3qK2n1+1Wzy3fulORor8XJSdVbCIfTKX4eFtoVCEAdcno80j86qppNbWx8cL9/sRKRiETm51Wz7YOD4j10qCTXRfEIQB3qGx1Vb++9NDUl2VSqZNcOXb8u6URCNesfHxen212ya6NwBKDONPt80nX0qGr25dKSRP/+u6TXzySTEt7mGPL38bBQ9RGAevLmvntR3Hefy+Vk8erVsixjdX5e4uGwarZreJiThaqIANSRQp68i8zNSWKbswJ2JJeTYCCgGuVkoeoiAHWikF+nM8mkhJX3+xcrHgrJ2l9/qWZ5WKh6CECd8F+4oN59J3TjhvqDup1Ymp6WTDKpmuVhoeogAHWg1e8X79CQajYRiUhkbq7MK3otHY9L+OZN1SwPC1UHAahxDqdT9l26pJ4PXr1a1P3+xVq9d08Sq6uqWR4WqjwCUON6TpwQz969qtnoP//IxuJimVe0VS6bVX8gKMLDQpVGAGqYq61NfMrtvbPptISmpsq8oo/bePZM1h89Us16vF7p4WGhiuF04Brm3rNHwsrTepJra7IZi5V5RZ8WDATybjP2Vk6x4zBKw3H38uVctRcBoDp4CwAYRgAAwwgAYBgBAAwjAIBhBAAwjAAAhhEAwDACABhGAADDCABgGAEADCMAgGEEADCMAACGEQDAMAIAGEYAAMMIAGAYAQAMIwCAYQQAMIwAAIYRAMAwAgAYRgAAwwgAYBgBAAwjAIBhBAAwjAAAhhEAwDACABhGAADDCABgGAEADCMAgGEEADCMAACGEQDAMAIAGEYAAMMIAGAYAQAMIwCAYQQAMIwAAIYRAMAwAgAYRgAAwwgAYBgBAAwjAIBhBAAwjAAAhhEAwDACABhGAADDCABgGAEADCMAgGEEADCMAACGEQDAMAIAGEYAAMMIAGAYAQAMIwCAYQQAMIwAAIYRAMAwAgAYRgAAwwgAYBgBAAwjAIBhBAAwjAAAhhEAwDACABhGAADDCABgGAEADCMAgGEEADCMAACGEQDAMAIAGEYAAMMIAGDY/wEstiEQxhXsywAAAABJRU5ErkJggg==",negYHoverUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAACOtJREFUeJzt3c1XUwcax/EngIiIClJfKDC1jtpxOFQt4jhjZzHntKuZzSznH+p+/oXZzh8xY0UJ70JVBKWaEN5BCBBCQl666GlrC22eQG7Cye/72Wkfc59F+SYh996E/t33Vd4ASKqp9AIAKocAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIIwAAMIIACCMAADCCAAgjAAAwggAIKyu0gvg6K6ev24tja2u2ej6G1tJLAW80cFuXuy2xvrTrtnXq1MW310PeCMQgCqQzefswUd/c81ePX/D/jvxn4A32q+5ocW+uPZ3C4VCBWe3Upv2dH6oDFuBtwBVILI+Y3Obs67ZtjPt1nHudwFvtF9v5wPXD7+Z2VDssWVz2YA3ghkBqBoD0Ufu2d6OBwFust+Zk2ftkwtdrtnNVNwml74JeCP8gABUiVg8YrF4xDXb2XzF2s52BLzRT3o7/mI1Id//agPRR5bN8+xfLgSgivRHv3bP9nb8OcBNftJUf8ZuXvzUNbuRfGdTK88D3gjvIwBVZGEzZpGNb12zV1qu2cWmtoA3MuvpuG+1NbWu2XD0keXyuYA3wvsIQJXpjzx0z94N+FVA44nT1nXplmt2bWfVXq1OBroP9iMAVWZ5e9G+fffKNXut9RNrbbwQ2C532u9ZXc0J12w4+tDylg9sFxyMAFSh/oj/hymoVwENdaes+/Jnrtnl7UWbWZsOZA/8NgJQhdZ2Vuz16pRr9sYHf7TmU+dLvsPtD+9afW29azZcxC8vUVoEoEr1Rx9aPl/4VUAoFLKe9vslPXZ97Um71XbXNbu0vWBv12dKenz4EYAqtZF8Z1Orvo/Ubl7strMnz5Xs2LfaeuxkXYNr9knk/yU7LopHAKrYYLTP9bFaTajGPmv/U0mOWVdzwm5/2Ouand+M2ezG25IcF4dDAKrYxu66vVz2nVbbdem2na5vOvIxuy/fsVMnGl2z/VH/R5YIBgGocgOzvgtramtqj/wqoLam1u6033PNRjfe2Fw8eqTj4egIQJXbSsXtxfK4a7aYZ++DdF26bU31Z1yz4SIuXkJwCICAwdnHlsllCs4V8/79l4r5PcKbd69scWvuUMdBaREAAYn0tj1bHHPNFvMb/PcV80kCz/7HBwEQMRR7YnvZdMG5Yj7D/0Ex5xK8XntZsVuSYT8CICK5t2MTC6Ou2WLO4jPzn02Yt7wNzj52Py6CRwCEjMyFLZ1NFZwr5jx+M//1BNMrL2w1sex+XASPAAjZzSTdN9v0XsnnvaIwn+fZ/zgiAGJG5wZtN5MsOOe9lt/77D+5PGHryTXXLMqHAIhJZ1M2Njfomi10Nx/vXYVy+ZwNxZ64d0T5EABBTxeGLbm3U3Du+/v5df/qf/feV/D50rjFdzfc+6F8CICgvWzaRubCrtnejgcH3tHXe2fhbC5jwzz7H1sEQNT4wohtp7cKzv3aPf293y3wzeKYbaU2i94P5UEARGVzGRuJOV8F/OJbfbzfLpTJZdyvNFAZBEDYs8Ux20zFC841N7TY9dY//Pjne52fux5/fGHYEuntQ++H4BEAYdl81oZj/a7Z3s7PLWQhu3D6kn3UcrXg/F42baNzA0ddEQHj24HL4PetN+zTyz0V3WF0fsAi6/u/NOTF0rj1tN+3cw3Nv/nvWxs/sI/PX3N/y8/Y/JDrkwZUFgEog6b6s9bZfKWiO0yvvjjw73P5nA3O9tmX1/9R8DH++vEXBUNhZpbK7NrYvO9cA1QWbwFgL1eeuc7S8/zwm5mNzg9aKrN71LVQBgQAls/nbWC2rySPtZtJ2rjzegNUHgGAmZm9WpksyZV6w7GwpR33HcDxQABgZt9fq3/UVwE76YRNLIyUaCOUAwHAj2bWpmxpe+HQ/34o9sQyub0SboSgEQD8zED0cK8CEulte770tMTbIGgEAD/zdv21LRzijr0Ds32uOw/jeOE8gDLYTm9aLB6p8A7+U3LD0a/tn13/cs9vpeI2uTRxmLVQYQSgDGbWpm1mbbrSa7jNbry1WDzquuDHzCwc7bNsvvC3D+H44S0ADuS9hn8rtWlTK88C3gZBIQA4UMJxrwAzs529hOsbiHE8EQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBjfDowD7ewl7HHkf4Xn0okybIOgEAAcKLmXtJFYuNJrIGC8BQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEEQBAGAEAhBEAQBgBAIQRAEAYAQCEfQdsqwM/9UcxrgAAAABJRU5ErkJggg==",negZHoverUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAB85JREFUeJzt3VtzFeQVx+GVA+EcEQiU6th0bOwwoi0WEBwZsXyEfoJ+n/YjtLe96G1neuWA1SooCqgjoqVa6qEGApEgJJBDL+xNR9F3Q3Z2sv/Pc/3OsC7gB9lZrAz87g8XlwqINNjrAYDeEQAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBsuNcD0D2DgwN1YN/DvR6jyYVLN2rm6/lejxFHAPrY0GDV0QM7ez1Gk88nbwtAD/gSAIIJAAQTAAgmABBMACCYAEAwAYBgAkDPzc4t1NT0nV6PEckiUB+7O79Uv//jhyv+627dPFy//c14rRtu+/vltbNTdXt2octT8V38C4Bl98KhseY//FPTd+r8B191eSLuRQBYVo/s3lg//+nW5vcnT0/W4uJSFyfi+wgAy2ZgoOr4kV3N7z/8ZKY++exWFyfihwgAy2b/3m01tn1909v5haV6+Y2rXZ6IHyIALIuN64fq8P4dze/ffOda3bh5t4sT0UIAWBZHD+6sjeuHmt7OfD1fb757vcsT0UIAeGC7d6yvfRMPNb9/+Y0rdXd+sYsT0UoAeGDHDu+qgYG2t599ebsufjzT3YFoJgA8kCcnRuvR3Rub3i4tVb30+mSXJ6ITAsB9G1k3WEd/1X5y7PwH03Xl2lwXJ6JTAsB9O7J/R23e1LZNPju3UK+dneryRHRKALgvD4+O1P6925rf//1t+/6rkQBwX359eKyGhto++Zu6fqfeuWjffzUSADo28ZMtNf7o5ub3L52y779aCQAdGR4aqBcOjTW/v/jxTP37C/v+q5UA0JGDT22vh7aua3o7v7BUf3vTvv9qJgA027p5uA4+3f6jxt44b99/tRMAmh17tv3Qx8zX83XmvWtdnogHJQA0eWzPpnpivP3Qx4nTk3V33gd/q50A8IMGBwfqxcPtH/xd/uJWffTJzS5OxHJxFHSFbd82UscPt1/N6YZLl2/W2+9PN7//5d5ttfPhtkMfS0tVJ09fud/RWGECsMI2jAzWYz/e1NMZrt9oP8G9acNQPdfBoY9zF+z7ryW+BOB7PX9gZ60fafttMju3UK/b919TBIB72r1zQ0eHPl5962rdnrPvv5YIAPd0vINDH5PX5uz7r0ECwHfaNzFae3ZtaH5/4tRkLfmu35ojAHzLyLrBer6DQx8f/HOmPv3P7S5ORLcIAN/y3DPthz7mF5bqlTP2/dcqAeD/bN/W2aGP0+en7PuvYfYAVtjcncW63OP/Hnvtq3v/gX3x2bEaHGz75O/Gzfl66z33/dcyAVhhU9N36s9//bTXY3ynifEtNf5I+6GPk/b91zxfAlBV/zv0cbDDff9/2fdf6wSAqqo69HT7oY/FxaU6ccq+fz8QAGrr5uE68FT7oY9zF6br6nX7/v1AAKgXn93VfOhjdm6hTp1z6KNfCEC4x/ZsqonxLc3vXzlj37+fCECwTg99TE7N1bsf2vfvJwIQbH8Hhz6qvjnzZd+/vwhAqE0bhupIB4c+Llyy79+PBCDU0YNjzYc+7s4v1atv+bZfPxKAQLt3bqgnfzba/P6bff/5Lk5ErwhAmIGBquNH2g99fDVz175/HxOAME9OPFR7xtoPfZw8faXmF3zy168EIMjIusF6/pn2D/4uf36r/nHZvn8/E4AgnRz6WFxcqhPu+/c9AQixo8NDH2ft+0cQgBDHOjj0cWvWff8UAhDgifGtHR36ePXM1Zq7s9jFiVgtBKDPDQ8N1AuH2i/8Tk7N1Xsf2fdPIQB97tAvttfolrZDH1Xu+6cRgD42umW4Duzb3vz+wqUb9emX9v2TOArax44d2lXrhhtX/qpq7+Ojtffx9hXh5fanv1yuzydne/brJ/IvgD726I829noEVjkBgGACAMEEAIIJAAQTAAgmABBMACCYRaA+9vq5qeaf+LMauDu48gSgj519f7rXI7DKrZ2/HoBlJwAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACCYAEAwAYBgAgDBBACCCQAEEwAIJgAQTAAgmABAMAGAYAIAwQQAggkABBMACCYAEEwAIJgAQDABgGACAMEEAIIJAAQTAAgmABBMACDYfwFLMHUh8yx8MwAAAABJRU5ErkJggg==";const CameraSideLength=10,XColor=new Color3(1,.255,.212),YColor=new Color3(.18,.8,.251),ZColor=new Color3(0,.42,.78);function createOrientationViewScene(a,e){return new IndicatorBuilder(a,e).scene}var lt;class IndicatorBuilder{constructor(e,t){re(this,"scene");re(this,"engine");re(this,"camera");re(this,"source");re(this,"root");re(this,"buttons");Q(this,lt,Quaternion.FromEulerAngles(Math.PI,-Math.PI/2,0));this.engine=e,this.source=t,this.scene=new Scene(e),this.scene.autoClear=!1,this.camera=new TargetCamera("orientationViewCamera",new Vector3(0,0,-10),this.scene),this.camera.target=Vector3.Zero(),this.camera.mode=Camera.ORTHOGRAPHIC_CAMERA,this.camera.upVector=new Vector3(0,0,1),this.camera.orthoTop=CameraSideLength,this.camera.orthoBottom=-CameraSideLength,this.root=new TransformNode("root",this.scene),this.buttons=new Array,this.createIndicatorObject(),this.root.scalingDeterminant=.2,this.root.position=new Vector3(.85*CameraSideLength,CameraSideLength-1.2,0),this.updateAspectRatio(),this.updateRotation()}updateAspectRatio(){const e=this.engine,t=this.camera,i=this.root,r=function(){const s=CameraSideLength*e.getAspectRatio(t);t.orthoLeft=-s,t.orthoRight=s,i.position.x=s-1.2};r(),this.engine.onResizeObservable.add(r)}updateRotation(){const e=this.source,t=this.root,i=this.buttons,r=I(this,lt),s=new Quaternion,n=new Quaternion,o=function(){e.getViewMatrix().decompose(void 0,s,void 0,void 0),t.rotationQuaternion=s,n.copyFrom(s),n.invertInPlace(),n.multiplyInPlace(r),i.forEach(l=>l.rotationQuaternion=n)};o(),this.source.onViewMatrixChangedObservable.add(o)}createIndicatorObject(){this.createButton("x",new Vector3(4,0,0),xUrl,xHoverUrl),this.createButton("nx",new Vector3(-4,0,0),negXUrl,negXHoverUrl),this.createButton("y",new Vector3(0,4,0),yUrl,yHoverUrl),this.createButton("ny",new Vector3(0,-4,0),negYUrl,negYHoverUrl),this.createButton("z",new Vector3(0,0,4),zUrl,zHoverUrl),this.createButton("nz",new Vector3(0,0,-4),negZUrl,negZHoverUrl),this.createAxis("xAxis",new Vector3(3.5,0,0),XColor),this.createAxis("yAxis",new Vector3(0,3.5,0),YColor),this.createAxis("zAxis",new Vector3(0,0,3.5),ZColor)}createButton(e,t,i,r){const s=loadTexture(i,this.scene),n=MeshBuilder.CreateSphere(e,{diameter:2,segments:16},this.scene);n.position=t,n.material=s,n.parent=this.root,n.rotationQuaternion=I(this,lt),this.buttons.push(n)}createAxis(e,t,i){const r=new StandardMaterial(e+"_mat");r.emissiveColor=i,r.freeze();const s=MeshBuilder.CreateTube(e,{path:[Vector3.Zero(),t],tessellation:3,radius:.1},this.scene);s.material=r,s.parent=this.root}}lt=new WeakMap;function loadTexture(a,e){const t=new Texture(a,e);t.hasAlpha=!0;const i=new StandardMaterial("",e);return i.emissiveTexture=t,i.diffuseTexture=t,i.freeze(),i}var He,Xe,Ye,St,si;class PathVisualizer{constructor(e,t){Q(this,St);Q(this,He,void 0);Q(this,Xe,void 0);Q(this,Ye,void 0);$(this,He,e),$(this,Xe,t),$(this,Ye,new Map)}setPathEnabled(e,t,i){if(I(this,Xe).paths.findIndex(n=>n.id==e)==-1)return;const r=I(this,Ye).get(e)??ne(this,St,si).call(this,e);if(!r)return;r.setEnabled(t);const s=r.material;s.diffuseColor=Color3.FromHexString(i)}}He=new WeakMap,Xe=new WeakMap,Ye=new WeakMap,St=new WeakSet,si=function(e){const t=I(this,Xe).paths.find(s=>s.id==e);if(!t)return null;const i=t.points.map(s=>{var n,o,l;return new Vector3(((n=s.position)==null?void 0:n.x)??0,((o=s.position)==null?void 0:o.y)??0,((l=s.position)==null?void 0:l.z)??0)}),r=MeshBuilder.CreateTube(t.name,{path:i,radius:.05},I(this,He));return r.material=new StandardMaterial(t.name+"_material",I(this,He)),I(this,Ye).set(e,r),r};class AutoRotationBehavior{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===PointerEventTypes.POINTERDOWN){this._isPointerDown=!0;return}i.type===PointerEventTypes.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;const i=PrecisionDate.Now;let r=0;this._lastFrameTime!=null&&(r=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();const s=i-this._lastInteractionTime-this._idleRotationWaitTime,n=Math.max(Math.min(s/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*n,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(r/1e3))})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=e??PrecisionDate.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<Epsilon:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=PrecisionDate.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}class EasingFunction{constructor(){this._easingMode=EasingFunction.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case EasingFunction.EASINGMODE_EASEIN:return this.easeInCore(e);case EasingFunction.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:this.easeInCore(e*2)*.5}}EasingFunction.EASINGMODE_EASEIN=0;EasingFunction.EASINGMODE_EASEOUT=1;EasingFunction.EASINGMODE_EASEINOUT=2;class BackEase extends EasingFunction{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}class ExponentialEase extends EasingFunction{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}class BouncingBehavior{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(!i)return;i.computeWorldMatrix(!0);const r=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=r*.05,this.upperRadiusTransitionRange=r*.05}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(BouncingBehavior.EasingFunction.setEasingMode(BouncingBehavior.EasingMode),this._radiusBounceTransition=Animation.CreateAnimation("radius",Animation.ANIMATIONTYPE_FLOAT,60,BouncingBehavior.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=Animation.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}BouncingBehavior.EasingFunction=new BackEase(.3);BouncingBehavior.EasingMode=EasingFunction.EASINGMODE_EASEOUT;class FramingBehavior{constructor(){this.onTargetFramingAnimationEndObservable=new Observable,this._mode=FramingBehavior.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();FramingBehavior.EasingFunction.setEasingMode(FramingBehavior.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===PointerEventTypes.POINTERDOWN){this._isPointerDown=!0;return}i.type===PointerEventTypes.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const r=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(r.min,r.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const r=new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let n=0;n<e.length;n++){const o=e[n].getHierarchyBoundingVectors(!0);Vector3.CheckExtends(o.min,r,s),Vector3.CheckExtends(o.max,r,s)}this.zoomOnBoundingInfo(r,s,t,i)}zoomOnBoundingInfo(e,t,i=!1,r=null){let s;if(!this._attachedCamera)return;const n=e.y,o=t.y,l=n+(o-n)*this._positionScale,h=t.subtract(e).scale(.5);if(i)s=new Vector3(0,l,0);else{const d=e.add(h);s=new Vector3(d.x,l,d.z)}this._vectorTransition||(this._vectorTransition=Animation.CreateAnimation("target",Animation.ANIMATIONTYPE_VECTOR3,60,FramingBehavior.EasingFunction)),this._betaIsAnimating=!0;let u=Animation.TransitionTo("target",s,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);u&&this._animatables.push(u);let c=0;if(this._mode===FramingBehavior.FitFrustumSidesMode){const d=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=h.length()+this._attachedCamera.minZ),c=d}else this._mode===FramingBehavior.IgnoreBoundsSizeMode&&(c=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const d=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/d,this._attachedCamera.wheelPrecision=100/c}this._radiusTransition||(this._radiusTransition=Animation.CreateAnimation("radius",Animation.ANIMATIONTYPE_FLOAT,60,FramingBehavior.EasingFunction)),u=Animation.TransitionTo("radius",c,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),r&&r(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),u&&this._animatables.push(u)}_calculateLowerRadiusFromModelBoundingSphere(e,t){const r=t.subtract(e).length(),s=this._getFrustumSlope(),o=r*.5*this._radiusScale,l=o*Math.sqrt(1+1/(s.x*s.x)),h=o*Math.sqrt(1+1/(s.y*s.y));let u=Math.max(l,h);const c=this._attachedCamera;return c?(c.lowerRadiusLimit&&this._mode===FramingBehavior.IgnoreBoundsSizeMode&&(u=u<c.lowerRadiusLimit?c.lowerRadiusLimit:u),c.upperRadiusLimit&&(u=u>c.upperRadiusLimit?c.upperRadiusLimit:u),u):0}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=PrecisionDate.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,i=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=Animation.CreateAnimation("beta",Animation.ANIMATIONTYPE_FLOAT,60,FramingBehavior.EasingFunction));const r=Animation.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});r&&this._animatables.push(r)}}_getFrustumSlope(){const e=this._attachedCamera;if(!e)return Vector2.Zero();const i=e.getScene().getEngine().getAspectRatio(e),r=Math.tan(e.fov/2),s=r*i;return new Vector2(s,r)}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=PrecisionDate.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}FramingBehavior.EasingFunction=new ExponentialEase;FramingBehavior.EasingMode=EasingFunction.EASINGMODE_EASEINOUT;FramingBehavior.IgnoreBoundsSizeMode=0;FramingBehavior.FitFrustumSidesMode=1;var CameraInputTypes={};class CameraInputsManager{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();if(this.attached[t]){Logger.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e){i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck();return}}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=Camera.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const i in this.attached){const r=this.attached[i],s=SerializationHelper.Serialize(r);t[r.getClassName()]=s}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const i in t){const r=CameraInputTypes[i];if(r){const s=t[i],n=SerializationHelper.Parse(()=>new r,s,null);this.add(n)}}}else for(const i in this.attached){const r=CameraInputTypes[this.attached[i].getClassName()];if(r){const s=SerializationHelper.Parse(()=>new r,e,null);this.remove(this.attached[i]),this.add(s)}}}}class BaseCameraPointersInput{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=Tools.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let r=0,s=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=o=>{var l,h;const u=o.event,c=u.pointerType==="touch";if(t.isInVRExclusivePointerMode||o.type!==PointerEventTypes.POINTERMOVE&&this.buttons.indexOf(u.button)===-1)return;const d=u.target;if(this._altKey=u.altKey,this._ctrlKey=u.ctrlKey,this._metaKey=u.metaKey,this._shiftKey=u.shiftKey,this._buttonsPressed=u.buttons,t.isPointerLock){const f=u.movementX,_=u.movementY;this.onTouch(null,f,_),this._pointA=null,this._pointB=null}else{if(o.type!==PointerEventTypes.POINTERDOWN&&c&&((l=this._pointA)===null||l===void 0?void 0:l.pointerId)!==u.pointerId&&((h=this._pointB)===null||h===void 0?void 0:h.pointerId)!==u.pointerId)return;if(o.type===PointerEventTypes.POINTERDOWN&&(this._currentActiveButton===-1||c)){try{d==null||d.setPointerCapture(u.pointerId)}catch{}if(this._pointA===null)this._pointA={x:u.clientX,y:u.clientY,pointerId:u.pointerId,type:u.pointerType};else if(this._pointB===null)this._pointB={x:u.clientX,y:u.clientY,pointerId:u.pointerId,type:u.pointerType};else return;this._currentActiveButton===-1&&!c&&(this._currentActiveButton=u.button),this.onButtonDown(u),e||(u.preventDefault(),i&&i.focus())}else if(o.type===PointerEventTypes.POINTERDOUBLETAP)this.onDoubleTap(u.pointerType);else if(o.type===PointerEventTypes.POINTERUP&&(this._currentActiveButton===u.button||c)){try{d==null||d.releasePointerCapture(u.pointerId)}catch{}c||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==u.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==u.pointerId?this._pointB=null:this._pointA=this._pointB=null,(r!==0||s)&&(this.onMultiTouch(this._pointA,this._pointB,r,0,s,null),r=0,s=null),this._currentActiveButton=-1,this.onButtonUp(u),e||u.preventDefault()}else if(o.type===PointerEventTypes.POINTERMOVE){if(e||u.preventDefault(),this._pointA&&this._pointB===null){const f=u.clientX-this._pointA.x,_=u.clientY-this._pointA.y;this.onTouch(this._pointA,f,_),this._pointA.x=u.clientX,this._pointA.y=u.clientY}else if(this._pointA&&this._pointB){const f=this._pointA.pointerId===u.pointerId?this._pointA:this._pointB;f.x=u.clientX,f.y=u.clientY;const _=this._pointA.x-this._pointB.x,g=this._pointA.y-this._pointB.y,p=_*_+g*g,m={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:u.pointerId,type:o.type};this.onMultiTouch(this._pointA,this._pointB,r,p,s,m),s=m,r=p}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,PointerEventTypes.POINTERDOWN|PointerEventTypes.POINTERUP|PointerEventTypes.POINTERMOVE|PointerEventTypes.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,r=0,s=null,this.onLostFocus()},this._contextMenuBind=this.onContextMenu.bind(this),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const n=this.camera.getScene().getEngine().getHostWindow();n&&Tools.RegisterTopRootEvents(n,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&Tools.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,r,s,n){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}__decorate([serialize()],BaseCameraPointersInput.prototype,"buttons",void 0);class ArcRotateCameraPointersInput extends BaseCameraPointersInput{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){const i=t.x-e.x,r=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=r/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||ArcRotateCameraPointersInput.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,r,s,n){i===0&&s===null||r===0&&n===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,r),this._computeMultiTouchPanning(s,n)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(r)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,r),this._isPinching=!0):this._computeMultiTouchPanning(s,n)):this.multiTouchPanning?this._computeMultiTouchPanning(s,n):this.pinchZoom&&this._computePinchZoom(i,r))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}ArcRotateCameraPointersInput.MinimumRadiusForPinch=.001;__decorate([serialize()],ArcRotateCameraPointersInput.prototype,"buttons",void 0);__decorate([serialize()],ArcRotateCameraPointersInput.prototype,"angularSensibilityX",void 0);__decorate([serialize()],ArcRotateCameraPointersInput.prototype,"angularSensibilityY",void 0);__decorate([serialize()],ArcRotateCameraPointersInput.prototype,"pinchPrecision",void 0);__decorate([serialize()],ArcRotateCameraPointersInput.prototype,"pinchDeltaPercentage",void 0);__decorate([serialize()],ArcRotateCameraPointersInput.prototype,"useNaturalPinchZoom",void 0);__decorate([serialize()],ArcRotateCameraPointersInput.prototype,"pinchZoom",void 0);__decorate([serialize()],ArcRotateCameraPointersInput.prototype,"panningSensibility",void 0);__decorate([serialize()],ArcRotateCameraPointersInput.prototype,"multiTouchPanning",void 0);__decorate([serialize()],ArcRotateCameraPointersInput.prototype,"multiTouchPanAndZoom",void 0);CameraInputTypes.ArcRotateCameraPointersInput=ArcRotateCameraPointersInput;class ArcRotateCameraKeyboardMoveInput{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=Tools.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===KeyboardEventTypes.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];this.keysLeft.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(i)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}__decorate([serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"keysUp",void 0);__decorate([serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"keysDown",void 0);__decorate([serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"keysLeft",void 0);__decorate([serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"keysRight",void 0);__decorate([serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"keysReset",void 0);__decorate([serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"panningSensibility",void 0);__decorate([serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"zoomingSensibility",void 0);__decorate([serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"useAltToZoom",void 0);__decorate([serialize()],ArcRotateCameraKeyboardMoveInput.prototype,"angularSpeed",void 0);CameraInputTypes.ArcRotateCameraKeyboardMoveInput=ArcRotateCameraKeyboardMoveInput;const ffMultiplier=40;class ArcRotateCameraMouseWheelInput{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._inertialPanning=Vector3.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const r=e*.01*this.wheelDeltaPercentage*t;return e>0?i=r/(1+this.wheelDeltaPercentage):i=r*(1+this.wheelDeltaPercentage),i}attachControl(e){e=Tools.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==PointerEventTypes.POINTERWHEEL)return;const i=t.event;let r=0;const s=i.deltaMode===EventConstants.DOM_DELTA_LINE?ffMultiplier:1,n=-(i.deltaY*s);if(this.customComputeDeltaFromMouseWheel)r=this.customComputeDeltaFromMouseWheel(n,this,i);else if(this.wheelDeltaPercentage){if(r=this._computeDeltaFromMouseWheelLegacyEvent(n,this.camera.radius),r>0){let o=this.camera.radius,l=this.camera.inertialRadiusOffset+r;for(let h=0;h<20&&Math.abs(l)>.001;h++)o-=l,l*=this.camera.inertia;o=Scalar.Clamp(o,0,Number.MAX_VALUE),r=this._computeDeltaFromMouseWheelLegacyEvent(n,o)}}else r=n/(this.wheelPrecision*40);r&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(r)):this.camera.inertialRadiusOffset+=r),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,PointerEventTypes.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=Plane.FromPositionAndNormal(e.target,t)}_getPosition(){var e;const t=this.camera,i=t.getScene(),r=i.createPickingRay(i.pointerX,i.pointerY,Matrix.Identity(),t,!1);r.origin.x-=t.targetScreenOffset.x,r.origin.y-=t.targetScreenOffset.y;let s=0;return this._hitPlane&&(s=(e=r.intersectsPlane(this._hitPlane))!==null&&e!==void 0?e:0),r.origin.addInPlace(r.direction.scaleInPlace(s))}_zoomToMouse(e){var t,i;const r=this.camera,s=1-r.inertia;if(r.lowerRadiusLimit){const u=(t=r.lowerRadiusLimit)!==null&&t!==void 0?t:0;r.radius-(r.inertialRadiusOffset+e)/s<u&&(e=(r.radius-u)*s-r.inertialRadiusOffset)}if(r.upperRadiusLimit){const u=(i=r.upperRadiusLimit)!==null&&i!==void 0?i:0;r.radius-(r.inertialRadiusOffset+e)/s>u&&(e=(r.radius-u)*s-r.inertialRadiusOffset)}const o=e/s/r.radius,l=this._getPosition(),h=TmpVectors.Vector3[6];l.subtractToRef(r.target,h),h.scaleInPlace(o),h.scaleInPlace(s),this._inertialPanning.addInPlace(h),r.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<Epsilon&&(e.x=0),Math.abs(e.y)<Epsilon&&(e.y=0),Math.abs(e.z)<Epsilon&&(e.z=0)}}__decorate([serialize()],ArcRotateCameraMouseWheelInput.prototype,"wheelPrecision",void 0);__decorate([serialize()],ArcRotateCameraMouseWheelInput.prototype,"zoomToMouseLocation",void 0);__decorate([serialize()],ArcRotateCameraMouseWheelInput.prototype,"wheelDeltaPercentage",void 0);CameraInputTypes.ArcRotateCameraMouseWheelInput=ArcRotateCameraMouseWheelInput;class ArcRotateCameraInputsManager extends CameraInputsManager{constructor(e){super(e)}addMouseWheel(){return this.add(new ArcRotateCameraMouseWheelInput),this}addPointers(){return this.add(new ArcRotateCameraPointersInput),this}addKeyboard(){return this.add(new ArcRotateCameraKeyboardMoveInput),this}}Node.AddNodeConstructor("ArcRotateCamera",(a,e)=>()=>new ArcRotateCamera(a,0,0,1,Vector3.Zero(),e));class ArcRotateCamera extends TargetCamera{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new Matrix,this._upToYMatrix=new Matrix,this._upVector=Vector3.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){Matrix.RotationAlignToRef(Vector3.UpReadOnly,this._upVector,this._yToUpMatrix),Matrix.RotationAlignToRef(this._upVector,Vector3.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new BouncingBehavior,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new FramingBehavior,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new AutoRotationBehavior,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,r,s,n,o=!0){super(e,Vector3.Zero(),n,o),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=Vector3.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=Vector2.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this._viewMatrix=new Matrix,this.panningAxis=new Vector3(1,1,0),this._transformedDirection=new Vector3,this.mapPanning=!1,this.onMeshTargetChangedObservable=new Observable,this.checkCollisions=!1,this.collisionRadius=new Vector3(.5,.5,.5),this._previousPosition=Vector3.Zero(),this._collisionVelocity=Vector3.Zero(),this._newPosition=Vector3.Zero(),this._computationVector=Vector3.Zero(),this._onCollisionPositionChange=(l,h,u=null)=>{u?(this.setPosition(h),this.onCollide&&this.onCollide(u)):this._previousPosition.copyFrom(this._position);const c=Math.cos(this.alpha),d=Math.sin(this.alpha),f=Math.cos(this.beta);let _=Math.sin(this.beta);_===0&&(_=1e-4);const g=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*c*_,this.radius*f,this.radius*d*_),g.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let p=this.upVector;this.allowUpsideDown&&this.beta<0&&(p=p.clone(),p=p.negate()),this._computeViewMatrix(this._position,g,p),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=Vector3.Zero(),s&&this.setTarget(s),this.alpha=t,this.beta=i,this.radius=r,this.getViewMatrix(),this.inputs=new ArcRotateCameraInputsManager(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=Vector2.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}const e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,i=!0,r=2){const s=arguments;t=Tools.BackCompatCameraNoPreventDefault(s),this._useCtrlForPanning=i,this._panningMouseButton=r,typeof s[0]=="boolean"&&(s.length>1&&(this._useCtrlForPanning=s[1]),s.length>2&&(this._panningMouseButton=s[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){const e=this.invertRotation?-1:1;let t=this.inertialAlphaOffset;this.beta<=0&&(t*=-1),this.getScene().useRightHandedSystem&&(t*=-1),this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(t*=-1),this.alpha+=t*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<Epsilon&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<Epsilon&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*Epsilon&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){const e=new Vector3(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),Vector3.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),(this.mapPanning||!this.panningAxis.y)&&(this._transformedDirection.y=0),this._targetHost||(this.panningDistanceLimit?(this._transformedDirection.addInPlace(this._target),Vector3.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)):this._target.addInPlace(this._transformedDirection)),this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*Epsilon&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*Epsilon&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&Vector3.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);const e=this.alpha;this._computationVector.x===0&&this._computationVector.z===0?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,r=!1){var s;if(r=(s=this.overrideCloneAlphaBetaRadius)!==null&&s!==void 0?s:r,e.getBoundingInfo)t?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const n=e,o=this._getTargetPosition();if(o&&!i&&o.equals(n))return;this._targetHost=null,this._target=n,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}r||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let r=Math.sin(this.beta);r===0&&(r=1e-4),this.radius===0&&(this.radius=1e-4);const s=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*i,this.radius*t*r),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&Vector3.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),s.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const n=this.getScene().collisionCoordinator;this._collider||(this._collider=n.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,n.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let n=this.upVector;this.allowUpsideDown&&r<0&&(n=n.negate()),this._computeViewMatrix(this._position,s,n),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=s,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=Mesh.MinMax(e),r=Vector3.Distance(i.min,i.max);this.radius=r*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:r},t)}focusOn(e,t=!1){let i,r;if(e.min===void 0){const s=e||this.getScene().meshes;i=Mesh.MinMax(s),r=Vector3.Distance(i.min,i.max)}else{const s=e;i=s,r=s.distance}this._target=Mesh.Center(i),t||(this.maxZ=r*2)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Camera.RIG_MODE_STEREOSCOPIC_INTERLACED:case Camera.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}const r=new ArcRotateCamera(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return r._cameraRigParams={},r.isRigCamera=!0,r.rigParent=this,r.upVector=this.upVector,r.mode=this.mode,r.orthoLeft=this.orthoLeft,r.orthoRight=this.orthoRight,r.orthoBottom=this.orthoBottom,r.orthoTop=this.orthoTop,r}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Camera.RIG_MODE_STEREOSCOPIC_INTERLACED:case Camera.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}__decorate([serialize()],ArcRotateCamera.prototype,"alpha",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"beta",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"radius",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"overrideCloneAlphaBetaRadius",void 0);__decorate([serializeAsVector3("target")],ArcRotateCamera.prototype,"_target",void 0);__decorate([serializeAsMeshReference("targetHost")],ArcRotateCamera.prototype,"_targetHost",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"inertialAlphaOffset",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"inertialBetaOffset",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"inertialRadiusOffset",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"lowerAlphaLimit",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"upperAlphaLimit",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"lowerBetaLimit",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"upperBetaLimit",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"lowerRadiusLimit",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"upperRadiusLimit",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"inertialPanningX",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"inertialPanningY",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"pinchToPanMaxDistance",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"panningDistanceLimit",void 0);__decorate([serializeAsVector3()],ArcRotateCamera.prototype,"panningOriginTarget",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"panningInertia",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"zoomToMouseLocation",null);__decorate([serialize()],ArcRotateCamera.prototype,"zoomOnFactor",void 0);__decorate([serializeAsVector2()],ArcRotateCamera.prototype,"targetScreenOffset",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"allowUpsideDown",void 0);__decorate([serialize()],ArcRotateCamera.prototype,"useInputToRestoreState",void 0);function buildCamera(a,e){var s,n,o,l,h,u;const t=new Vector3(((s=e==null?void 0:e.position)==null?void 0:s.x)??1,((n=e==null?void 0:e.position)==null?void 0:n.y)??1,((o=e==null?void 0:e.position)==null?void 0:o.z)??1),i=new Vector3(((l=e==null?void 0:e.target)==null?void 0:l.x)??0,((h=e==null?void 0:e.target)==null?void 0:h.y)??0,((u=e==null?void 0:e.target)==null?void 0:u.z)??0),r=new ArcRotateCamera("camera",0,0,1,i,a.scene);return r.upVector=new Vector3(0,0,1),r.setPosition(t),r}const Hold={ease:()=>0},Ahead={ease:()=>1},Step={ease:a=>a<=.5?0:1};function getInterpolation(a){switch(a){case Interpolation.AHEAD:return Ahead;case Interpolation.HOLD:return Hold;case Interpolation.STEP:return Step;case Interpolation.LINEAR:case Interpolation.UNRECOGNIZED:default:return null}}var Qe,ht,Xt;class PathInterpolator{constructor(e,t){Q(this,ht);re(this,"path",[]);Q(this,Qe,null);if(typeof e=="number"){ne(this,ht,Xt).call(this,e,t);return}if(!e||!e.source){this.path=[{time:0,position:new Vector3}];return}switch(e.source.$case){case"constValue":{const i=e.source.constValue;this.path=[{time:0,position:new Vector3(i.x,i.y,i.z)}];return}case"pathId":{const i=e.source.pathId;ne(this,ht,Xt).call(this,i,t);return}}}interpolate(e){const t=this.path.findIndex(h=>h.time>e);if(t==-1)return this.path[this.path.length-1].position;if(t==0)return this.path[0].position;if(this.path[t].time-e<1e-7)return this.path[t].position;const i=this.path[t-1].time,r=this.path[t].time;let s=(e-i)/(r-i);I(this,Qe)&&(s=I(this,Qe).call(this,s));const n=this.path[t-1].position,l=this.path[t].position.subtract(n);return n.add(l.scaleInPlace(s))}}Qe=new WeakMap,ht=new WeakSet,Xt=function(e,t){var r;const i=t.paths.find(s=>s.id==e);!i||i.points.length==0?this.path=[{time:0,position:new Vector3}]:(this.path=i.points.map(s=>{var n,o,l;return{time:s.time,position:new Vector3((n=s.position)==null?void 0:n.x,(o=s.position)==null?void 0:o.y,(l=s.position)==null?void 0:l.z)}}),$(this,Qe,((r=getInterpolation(i.interpolation))==null?void 0:r.ease)??null))};const EY=new Vector3(0,1,0),backwardArrowShape=[new Vector3(0,0,0),new Vector3(.5,0,0),new Vector3(.5,2/3,0),new Vector3(1,2/3,0),new Vector3(0,1,0)],forwardArrowShape=[new Vector3(0,0,0),new Vector3(1,1/3,0),new Vector3(.5,1/3,0),new Vector3(.5,1,0),new Vector3(0,1,0)],doubleArrowShape=[new Vector3(0,0,0),new Vector3(1,1/3,0),new Vector3(.5,1/3,0),new Vector3(.5,2/3,0),new Vector3(1,2/3,0),new Vector3(0,1,0)];function alignVector(a){let e=EY.cross(a),t=Math.acos(Vector3.Dot(EY,a));return t<1e-7?(e=new Vector3(1,0,0),a.y<0&&(t=Math.PI)):t>3.141592&&(e=new Vector3(1,0,0),a.y>0&&(t=Math.PI)),Quaternion.RotationAxis(e,t)}function buildLine(a,e,t){var s,n,o,l,h,u,c,d,f,_,g,p;let i;!e.pointForward&&!e.pointBackward?i=MeshBuilder.CreateCylinder(t.name,{height:1}):e.pointForward&&!e.pointBackward?i=MeshBuilder.CreateLathe(t.name,{shape:forwardArrowShape,tessellation:24}):!e.pointForward&&e.pointBackward?i=MeshBuilder.CreateLathe(t.name,{shape:backwardArrowShape,tessellation:24}):i=MeshBuilder.CreateLathe(t.name,{shape:doubleArrowShape,tessellation:24}),a.applyMetadata(i,t);const r=a.parseColor(e.color,"material");if(i.material=r,a.parseScalar(e.lineWidth,i,"scaling.z"),a.parseScalar(e.lineWidth,i,"scaling.x"),a.parseVector(e.start,i,"position"),((n=(s=e.start)==null?void 0:s.source)==null?void 0:n.$case)=="pathId"||((l=(o=e.end)==null?void 0:o.source)==null?void 0:l.$case)=="pathId"){let m=new Array,E=Interpolation.UNRECOGNIZED,M=Interpolation.UNRECOGNIZED;if(((u=(h=e.start)==null?void 0:h.source)==null?void 0:u.$case)=="pathId"){const R=e.start.source.pathId,P=a.project.paths.find(N=>N.id==R);P==null||P.points.forEach(N=>m.push(N.time)),P&&P.interpolation in Interpolation&&(E=P.interpolation)}if(((d=(c=e.end)==null?void 0:c.source)==null?void 0:d.$case)=="pathId"){const R=e.end.source.pathId,P=a.project.paths.find(N=>N.id==R);P==null||P.points.forEach(N=>m.push(N.time)),P&&P.interpolation in Interpolation&&(M=P.interpolation)}if(m.length==0){i.scaling.y=0;return}m.sort((R,P)=>R-P),m=m.filter((R,P)=>!(P>0&&Math.abs(m[P-1]-R)<1e-7));const x=new PathInterpolator(e.start,a.project),A=new PathInterpolator(e.end,a.project),T=new Animation(t.name+"_length","scaling.y",1,Animation.ANIMATIONTYPE_FLOAT,Animation.ANIMATIONLOOPMODE_CYCLE),C=new Animation(t.name+"_rot","rotationQuaternion",1,Animation.ANIMATIONTYPE_QUATERNION,Animation.ANIMATIONLOOPMODE_CYCLE),b=new Array,y=new Array;m.forEach(R=>{const P=x.interpolate(R),V=A.interpolate(R).subtract(P);b.push({frame:R,value:V.length()}),V.normalize();const F=alignVector(V);y.push({frame:R,value:F})}),T.setKeys(b),C.setKeys(y);let S=Interpolation.LINEAR;E!=Interpolation.UNRECOGNIZED?(M==Interpolation.UNRECOGNIZED||x==A)&&(S=E):M!=Interpolation.UNRECOGNIZED&&(S=M),T.setEasingFunction(getInterpolation(S)),C.setEasingFunction(getInterpolation(S)),a.animationGroup.addTargetedAnimation(T,i),a.animationGroup.addTargetedAnimation(C,i)}else{const m=((_=(f=e.start)==null?void 0:f.source)==null?void 0:_.constValue)??{x:0,y:0,z:0},E=((p=(g=e.end)==null?void 0:g.source)==null?void 0:p.constValue)??{x:0,y:0,z:0},M=new Vector3(E.x-m.x,E.y-m.y,E.z-m.z);i.scaling.y=M.length(),M.normalize();const x=alignVector(M);i.rotationQuaternion=x}}var Ae,Ke,It,ni,Rt,ai;class OverlayBuilder{constructor(e){Q(this,It);Q(this,Rt);Q(this,Ae,void 0);Q(this,Ke,void 0);re(this,"rootContainer");$(this,Ae,e),$(this,Ke,new Map),this.rootContainer=new Rectangle("textRoot"),this.rootContainer.width=1,this.rootContainer.height=1,this.rootContainer.thickness=0,this.rootContainer.color="white",I(this,Ae).overlayTexture.addControl(this.rootContainer)}build(e,t){const i=new TextBlock(t.name);i.resizeToFit=!0,I(this,Ae).applyMetadata(i,t),I(this,Ae).textEngine.addText(i,e.text),I(this,Ae).parseScalar(e.fontSize,i,"fontSize"),ne(this,Rt,ai).call(this,e.position,i),e.bold&&(i.fontWeight="800"),e.italic&&(i.fontStyle="italic"),ne(this,It,ni).call(this,e.position).addControl(i)}}Ae=new WeakMap,Ke=new WeakMap,It=new WeakSet,ni=function(e){e==TextPosition.UNRECOGNIZED&&(e=TextPosition.LOWER_LEFT);let t=I(this,Ke).get(e);if(t)return t;switch(t=new StackPanel(textPositionToJSON(e)),t.adaptWidthToChildren=!0,t.spacing=5,t.paddingBottom="10",t.paddingTop="20",t.paddingLeft="10",t.paddingRight="10",e){case TextPosition.CENTER:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_CENTER;break;case TextPosition.UPPER_RIGHT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_RIGHT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP,t.paddingRight="100";break;case TextPosition.TOP:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP;break;case TextPosition.UPPER_LEFT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP;break;case TextPosition.LEFT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_CENTER;break;case TextPosition.LOWER_LEFT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_BOTTOM;break;case TextPosition.BOTTOM:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_BOTTOM;break;case TextPosition.LOWER_RIGHT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_RIGHT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_BOTTOM;break;case TextPosition.RIGHT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_RIGHT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_CENTER;break}return this.rootContainer.addControl(t),I(this,Ke).set(e,t),t},Rt=new WeakSet,ai=function(e,t){switch(e){case TextPosition.CENTER:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_CENTER;break;case TextPosition.UPPER_RIGHT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_RIGHT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP;break;case TextPosition.TOP:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP;break;case TextPosition.UPPER_LEFT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_TOP;break;case TextPosition.LEFT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_CENTER;break;case TextPosition.LOWER_LEFT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_LEFT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_BOTTOM;break;case TextPosition.BOTTOM:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_CENTER,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_BOTTOM;break;case TextPosition.LOWER_RIGHT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_RIGHT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_BOTTOM;break;case TextPosition.RIGHT:t.horizontalAlignment=Control.HORIZONTAL_ALIGNMENT_RIGHT,t.verticalAlignment=Control.VERTICAL_ALIGNMENT_CENTER;break}};function toHex(a,e,t,i){const r=s=>Math.round(s*255).toString(16);return r(a)+r(e)+r(t)+r(i)}function setProperty(a,e,t){const i=e.split(".");for(let r=0;r<i.length-1;++r)a=a[i[r]];a[i[i.length-1]]=t}var ct,Te,Ze,ut,dt,qe,ft,Yt;class RotationProxy{constructor(e,t,i=Quaternion.Identity()){Q(this,ft);re(this,"target");re(this,"property");Q(this,ct,void 0);Q(this,Te,new Vector3);Q(this,Ze,0);Q(this,ut,new Quaternion);Q(this,dt,new Quaternion);Q(this,qe,new Quaternion);this.target=e,this.property=t,$(this,ct,i)}get normal(){return I(this,Te)}set normal(e){e.lengthSquared()<=1e-5?$(this,Te,Axis.Z):e.normalizeToRef(I(this,Te)),ne(this,ft,Yt).call(this)}get rotation(){return I(this,Ze)}set rotation(e){$(this,Ze,e),ne(this,ft,Yt).call(this)}}ct=new WeakMap,Te=new WeakMap,Ze=new WeakMap,ut=new WeakMap,dt=new WeakMap,qe=new WeakMap,ft=new WeakSet,Yt=function(){Quaternion.FromUnitVectorsToRef(Axis.Z,I(this,Te),I(this,ut)),Quaternion.RotationAxisToRef(I(this,Te),I(this,Ze),I(this,dt)),I(this,dt).multiplyToRef(I(this,ut),I(this,qe)),I(this,qe).multiplyInPlace(I(this,ct)),setProperty(this.target,this.property,I(this,qe))};const BaseQuaternion=Quaternion.RotationAxis(Axis.X,.5*Math.PI);var le,$e,Pt,oi;class PrismBuilder{constructor(e){Q(this,Pt);Q(this,le,void 0);Q(this,$e,void 0);$(this,le,e),$(this,$e,new Map)}build(e,t){var s,n,o,l,h,u,c,d,f,_;let i;I(this,le).isStaticMaterial(e.color)?i=ne(this,Pt,oi).call(this,e.nVertices,e.color).createInstance(t.name):(i=MeshBuilder.CreateCylinder(t.name,{tessellation:e.nVertices,height:1,diameter:2},I(this,le).scene),i.material=I(this,le).parseColor(e.color,t.name+"_mat")),I(this,le).applyMetadata(i,t),I(this,le).parseScalar(e.radius,i,"scaling.x"),I(this,le).parseScalar(e.radius,i,"scaling.z"),I(this,le).parseScalar(e.height,i,"scaling.y"),I(this,le).parseVector(e.position,i,"position");const r=new RotationProxy(i,"rotationQuaternion",BaseQuaternion);I(this,le).parseScalar(e.rotation,r,"rotation"),I(this,le).parseVector(e.normal,r,"normal"),((n=(s=e.radius)==null?void 0:s.source)==null?void 0:n.$case)!="graphId"&&((l=(o=e.height)==null?void 0:o.source)==null?void 0:l.$case)!="graphId"&&((u=(h=e.normal)==null?void 0:h.source)==null?void 0:u.$case)!="pathId"&&((d=(c=e.rotation)==null?void 0:c.source)==null?void 0:d.$case)!="graphId"&&((_=(f=e.position)==null?void 0:f.source)==null?void 0:_.$case)!="pathId"&&i.freezeWorldMatrix()}}le=new WeakMap,$e=new WeakMap,Pt=new WeakSet,oi=function(e,t){//! You must externally ensure that color is indeed static
const i=I(this,le).parseColor(t,""),r=i.diffuseColor,s=e.toString()+"#"+toHex(r.r,r.g,r.b,i.alpha),n=I(this,$e).get(s);if(n)return n;{const o=MeshBuilder.CreateCylinder("prismTemplate_"+s,{tessellation:e,diameter:2,height:1},I(this,le).scene);return o.isVisible=!1,o.material=i,I(this,$e).set(s,o),o}};var de,je,Dt,li;class SphereBuilder{constructor(e){Q(this,Dt);Q(this,de,void 0);Q(this,je,void 0);$(this,de,e),$(this,je,new Map)}build(e,t){var r,s,n,o;let i;I(this,de).isStaticMaterial(e.color)?i=ne(this,Dt,li).call(this,e.color).createInstance(t.name):(i=MeshBuilder.CreateSphere(t.name,{diameter:2},I(this,de).scene),i.material=I(this,de).parseColor(e.color,t.name+"_mat")),I(this,de).applyMetadata(i,t),I(this,de).parseScalar(e.radius,i,"scalingDeterminant"),I(this,de).parseVector(e.position,i,"position"),((s=(r=e.radius)==null?void 0:r.source)==null?void 0:s.$case)!="graphId"&&((o=(n=e.position)==null?void 0:n.source)==null?void 0:o.$case)!="pathId"&&i.freezeWorldMatrix()}}de=new WeakMap,je=new WeakMap,Dt=new WeakSet,li=function(e){//! You must externally ensure that color is indeed static
const t=I(this,de).parseColor(e,""),i=t.diffuseColor,r=toHex(i.r,i.g,i.b,t.alpha),s=I(this,je).get(r);if(s)return s;{const n=MeshBuilder.CreateSphere("sphereTemplate_#"+r,{diameter:2},I(this,de).scene);return n.isVisible=!1,n.material=I(this,de).parseColor(e,""),I(this,je).set(r,n),n}};class TargetedAnimation{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class AnimationGroup{get from(){return this._from}get to(){return this._to}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.isAdditive=this._isAdditive}}}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}constructor(e,t=null){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._parentContainer=null,this.onAnimationEndObservable=new Observable,this.onAnimationLoopObservable=new Observable,this.onAnimationGroupLoopObservable=new Observable,this.onAnimationGroupEndObservable=new Observable,this.onAnimationGroupPauseObservable=new Observable,this.onAnimationGroupPlayObservable=new Observable,this.metadata=null,this._animationLoopFlags=[],this._scene=t||EngineStore.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new TargetedAnimation;i.animation=e,i.target=t;const r=e.getKeys();return this._from>r[0].frame&&(this._from=r[0].frame),this._to<r[r.length-1].frame&&(this._to=r[r.length-1].frame),this._targetedAnimations.push(i),i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){e==null&&(e=this._from),t==null&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const s=this._targetedAnimations[i].animation.getKeys(),n=s[0],o=s[s.length-1];if(n.frame>e){const l={frame:e,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};s.splice(0,0,l)}if(o.frame<t){const l={frame:t,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};s.push(l)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._targetedAnimations.length&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,r,s){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let n=0;n<this._targetedAnimations.length;n++){const o=this._targetedAnimations[n],l=this._scene.beginDirectAnimation(o.target,[o.animation],i!==void 0?i:this._from,r!==void 0?r:this._to,e,t,void 0,void 0,s!==void 0?s:this._isAdditive);l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(l)},this._processLoop(l,o,n),this._animatables.push(l)}return this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;const e=this._animatables.slice();for(let i=0;i<e.length;i++)e[i].stop(void 0,void 0,!0);let t=0;for(let i=0;i<this._scene._activeAnimatables.length;i++){const r=this._scene._activeAnimatables[i];r._runtimeAnimations.length>0&&(this._scene._activeAnimatables[t++]=r)}return this._scene._activeAnimatables.length=t,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.weight=e}return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){const t=this._animatables.indexOf(e);t>-1&&this._animatables.splice(t,1),this._animatables.length===0&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const r=new AnimationGroup(e||this.name,this._scene);for(const s of this._targetedAnimations)r.addTargetedAnimation(i?s.animation.clone():s.animation,t?t(s.target):s.target);return r}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return Tags&&Tags.HasTags(this)&&(e.tags=Tags.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new AnimationGroup(e.name,t);for(let r=0;r<e.targetedAnimations.length;r++){const s=e.targetedAnimations[r],n=Animation.Parse(s.animation),o=s.targetId;if(s.animation.property==="influence"){const l=t.getMorphTargetById(o);l&&i.addTargetedAnimation(n,l)}else{const l=t.getNodeById(o);l!=null&&i.addTargetedAnimation(n,l)}}return e.from!==null&&e.to!==null&&i.normalize(e.from,e.to),Tags&&Tags.AddTagsTo(i,e.tags),e.metadata!==void 0&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t=0,i,r=!1,s){let n=e;r&&(n=e.clone(s||n.name));const o=n.targetedAnimations;for(let l=0;l<o.length;l++){const h=o[l];Animation.MakeAnimationAdditive(h.animation,t,i)}return n.isAdditive=!0,n}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}class ClipboardEventTypes{}ClipboardEventTypes.COPY=1;ClipboardEventTypes.CUT=2;ClipboardEventTypes.PASTE=3;class ClipboardInfo{constructor(e,t){this.type=e,this.event=t}static GetTypeFromCharacter(e){switch(e){case 67:return ClipboardEventTypes.COPY;case 86:return ClipboardEventTypes.PASTE;case 88:return ClipboardEventTypes.CUT;default:return-1}}}class LayerSceneComponent{constructor(e){this.name=SceneComponentConstants.NAME_LAYER,this.scene=e||EngineStore.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.layers=new Array)}register(){this.scene._beforeCameraDrawStage.registerStep(SceneComponentConstants.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(SceneComponentConstants.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForegroundWithPostProcessing),this.scene._afterCameraPostProcessStage.registerStep(SceneComponentConstants.STEP_AFTERCAMERAPOSTPROCESS_LAYER,this,this._drawCameraForegroundWithoutPostProcessing),this.scene._beforeRenderTargetDrawStage.registerStep(SceneComponentConstants.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(SceneComponentConstants.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForegroundWithPostProcessing),this.scene._afterRenderTargetPostProcessStage.registerStep(SceneComponentConstants.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER,this,this._drawRenderTargetForegroundWithoutPostProcessing)}rebuild(){const e=this.scene.layers;for(const t of e)t._rebuild()}dispose(){const e=this.scene.layers;for(;e.length;)e[0].dispose()}_draw(e){const t=this.scene.layers;if(t.length){this._engine.setDepthBuffer(!1);for(const i of t)e(i)&&i.render();this._engine.setDepthBuffer(!0)}}_drawCameraPredicate(e,t,i,r){return!e.renderOnlyInRenderTargetTextures&&e.isBackground===t&&e.applyPostProcess===i&&(e.layerMask&r)!==0}_drawCameraBackground(e){this._draw(t=>this._drawCameraPredicate(t,!0,!0,e.layerMask))}_drawCameraForegroundWithPostProcessing(e){this._draw(t=>this._drawCameraPredicate(t,!1,!0,e.layerMask))}_drawCameraForegroundWithoutPostProcessing(e){this._draw(t=>this._drawCameraPredicate(t,!1,!1,e.layerMask))}_drawRenderTargetPredicate(e,t,i,r,s){return e.renderTargetTextures.length>0&&e.isBackground===t&&e.applyPostProcess===i&&e.renderTargetTextures.indexOf(s)>-1&&(e.layerMask&r)!==0}_drawRenderTargetBackground(e){this._draw(t=>this._drawRenderTargetPredicate(t,!0,!0,this.scene.activeCamera.layerMask,e))}_drawRenderTargetForegroundWithPostProcessing(e){this._draw(t=>this._drawRenderTargetPredicate(t,!1,!0,this.scene.activeCamera.layerMask,e))}_drawRenderTargetForegroundWithoutPostProcessing(e){this._draw(t=>this._drawRenderTargetPredicate(t,!1,!1,this.scene.activeCamera.layerMask,e))}addFromContainer(e){e.layers&&e.layers.forEach(t=>{this.scene.layers.push(t)})}removeFromContainer(e,t=!1){e.layers&&e.layers.forEach(i=>{const r=this.scene.layers.indexOf(i);r!==-1&&this.scene.layers.splice(r,1),t&&i.dispose()})}}const name$1="layerPixelShader",shader$1=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec4 color;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef LINEAR
baseColor.rgb=toGammaSpace(baseColor.rgb);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4)
discard;
#endif
gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;ShaderStore.ShadersStore[name$1]=shader$1;const name="layerVertexShader",shader=`attribute vec2 position;
uniform vec2 scale;
uniform vec2 offset;
uniform mat4 textureMatrix;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 shiftedPosition=position*scale+offset;
vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));
gl_Position=vec4(shiftedPosition,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;ShaderStore.ShadersStore[name]=shader;class Layer{set applyPostProcess(e){this._applyPostProcess=e}get applyPostProcess(){return this.isBackground||this._applyPostProcess}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}constructor(e,t,i,r,s){this.name=e,this._applyPostProcess=!0,this.scale=new Vector2(1,1),this.offset=new Vector2(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this.isEnabled=!0,this._vertexBuffers={},this.onDisposeObservable=new Observable,this.onBeforeRenderObservable=new Observable,this.onAfterRenderObservable=new Observable,this.texture=t?new Texture(t,i,!0):null,this.isBackground=r===void 0?!0:r,this.color=s===void 0?new Color4(1,1,1,1):s,this._scene=i||EngineStore.LastCreatedScene;let n=this._scene._getComponent(SceneComponentConstants.NAME_LAYER);n||(n=new LayerSceneComponent(this._scene),this._scene._addComponent(n)),this._scene.layers.push(this);const o=this._scene.getEngine();this._drawWrapper=new DrawWrapper(o);const l=[];l.push(1,1),l.push(-1,1),l.push(-1,-1),l.push(1,-1);const h=new VertexBuffer(o,l,VertexBuffer.PositionKind,!1,!1,2);this._vertexBuffers[VertexBuffer.PositionKind]=h,this._createIndexBuffer()}_createIndexBuffer(){const e=this._scene.getEngine(),t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[VertexBuffer.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}isReady(){var e;const t=this._scene.getEngine();let i="";this.alphaTest&&(i="#define ALPHATEST"),this.texture&&!this.texture.gammaSpace&&(i+=`\r
#define LINEAR`),this._previousDefines!==i&&(this._previousDefines=i,this._drawWrapper.effect=t.createEffect("layer",[VertexBuffer.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],i));const r=this._drawWrapper.effect;return(r==null?void 0:r.isReady())&&((e=this.texture)===null||e===void 0?void 0:e.isReady())}render(){if(!this.isEnabled)return;const e=this._scene.getEngine();if(!this.isReady())return;const t=this._drawWrapper.effect;this.onBeforeRenderObservable.notifyObservers(this),e.enableEffect(this._drawWrapper),e.setState(!1),t.setTexture("textureSampler",this.texture),t.setMatrix("textureMatrix",this.texture.getTextureMatrix()),t.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),t.setVector2("offset",this.offset),t.setVector2("scale",this.scale),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t),this.alphaTest?e.drawElementsType(Material.TriangleFillMode,0,6):(e.setAlphaMode(this.alphaBlendingMode),e.drawElementsType(Material.TriangleFillMode,0,6),e.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this)}dispose(){const e=this._vertexBuffers[VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];const t=this._scene.layers.indexOf(this);this._scene.layers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()}}class Style{constructor(e){this._fontFamily="Arial",this._fontStyle="",this._fontWeight="",this._fontSize=new ValueAndUnit(18,ValueAndUnit.UNITMODE_PIXEL,!1),this.onChangedObservable=new Observable,this._host=e}get fontSize(){return this._fontSize.toString(this._host)}set fontSize(e){this._fontSize.toString(this._host)!==e&&this._fontSize.fromString(e)&&this.onChangedObservable.notifyObservers(this)}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this.onChangedObservable.notifyObservers(this))}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle!==e&&(this._fontStyle=e,this.onChangedObservable.notifyObservers(this))}get fontWeight(){return this._fontWeight}set fontWeight(e){this._fontWeight!==e&&(this._fontWeight=e,this.onChangedObservable.notifyObservers(this))}dispose(){this.onChangedObservable.clear()}}class AdvancedDynamicTexture extends DynamicTexture{get numLayoutCalls(){return this._numLayoutCalls}get numRenderCalls(){return this._numRenderCalls}get renderScale(){return this._renderScale}set renderScale(e){e!==this._renderScale&&(this._renderScale=e,this._onResize())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this.markAsDirty())}get idealWidth(){return this._idealWidth}set idealWidth(e){this._idealWidth!==e&&(this._idealWidth=e,this.markAsDirty(),this._rootContainer._markAllAsDirty())}get idealHeight(){return this._idealHeight}set idealHeight(e){this._idealHeight!==e&&(this._idealHeight=e,this.markAsDirty(),this._rootContainer._markAllAsDirty())}get useSmallestIdeal(){return this._useSmallestIdeal}set useSmallestIdeal(e){this._useSmallestIdeal!==e&&(this._useSmallestIdeal=e,this.markAsDirty(),this._rootContainer._markAllAsDirty())}get renderAtIdealSize(){return this._renderAtIdealSize}set renderAtIdealSize(e){this._renderAtIdealSize!==e&&(this._renderAtIdealSize=e,this._onResize())}get idealRatio(){let e=0,t=0;return this._idealWidth&&(e=this.getSize().width/this._idealWidth),this._idealHeight&&(t=this.getSize().height/this._idealHeight),this._useSmallestIdeal&&this._idealWidth&&this._idealHeight?window.innerWidth<window.innerHeight?e:t:this._idealWidth?e:this._idealHeight?t:1}get layer(){return this._layerToDispose}get rootContainer(){return this._rootContainer}getChildren(){return[this._rootContainer]}getDescendants(e,t){return this._rootContainer.getDescendants(e,t)}getControlsByType(e){return this._rootContainer.getDescendants(!1,t=>t.typeName===e)}getControlByName(e){return this._getControlByKey("name",e)}_getControlByKey(e,t){return this._rootContainer.getDescendants().find(i=>i[e]===t)||null}get focusedControl(){return this._focusedControl}set focusedControl(e){this._focusedControl!=e&&(this._focusedControl&&this._focusedControl.onBlur(),e&&e.onFocus(),this._focusedControl=e)}get isForeground(){return this.layer?!this.layer.isBackground:!0}set isForeground(e){this.layer&&this.layer.isBackground!==!e&&(this.layer.isBackground=!e)}get clipboardData(){return this._clipboardData}set clipboardData(e){this._clipboardData=e}constructor(e,t=0,i=0,r,s=!1,n=Texture.NEAREST_SAMPLINGMODE,o=!0){super(e,{width:t,height:i},r,s,n,Constants.TEXTUREFORMAT_RGBA,o),this.onGuiReadyObservable=new Observable,this._isDirty=!1,this._rootContainer=new Container("root"),this._lastControlOver={},this._lastControlDown={},this._capturingControl={},this._linkedControls=new Array,this._isFullscreen=!1,this._fullscreenViewport=new Viewport(0,0,1,1),this._idealWidth=0,this._idealHeight=0,this._useSmallestIdeal=!1,this._renderAtIdealSize=!1,this._blockNextFocusCheck=!1,this._renderScale=1,this._cursorChanged=!1,this._defaultMousePointerId=0,this._rootChildrenHaveChanged=!1,this._capturedPointerIds=new Set,this._numLayoutCalls=0,this._numRenderCalls=0,this._clipboardData="",this.onClipboardObservable=new Observable,this.onControlPickedObservable=new Observable,this.onBeginLayoutObservable=new Observable,this.onEndLayoutObservable=new Observable,this.onBeginRenderObservable=new Observable,this.onEndRenderObservable=new Observable,this.premulAlpha=!1,this.applyYInversionOnUpdate=!0,this.checkPointerEveryFrame=!1,this._useInvalidateRectOptimization=!0,this._invalidatedRectangle=null,this._clearMeasure=new Measure(0,0,0,0),this._onClipboardCopy=l=>{const h=l,u=new ClipboardInfo(ClipboardEventTypes.COPY,h);this.onClipboardObservable.notifyObservers(u),h.preventDefault()},this._onClipboardCut=l=>{const h=l,u=new ClipboardInfo(ClipboardEventTypes.CUT,h);this.onClipboardObservable.notifyObservers(u),h.preventDefault()},this._onClipboardPaste=l=>{const h=l,u=new ClipboardInfo(ClipboardEventTypes.PASTE,h);this.onClipboardObservable.notifyObservers(u),h.preventDefault()},this.parseContent=this.parseSerializedObject,r=this.getScene(),!(!r||!this._texture)&&(this.applyYInversionOnUpdate=o,this._rootElement=r.getEngine().getInputElement(),this._renderObserver=r.onBeforeCameraRenderObservable.add(l=>this._checkUpdate(l)),this._controlAddedObserver=this._rootContainer.onControlAddedObservable.add(l=>{l&&(this._rootChildrenHaveChanged=!0)}),this._controlRemovedObserver=this._rootContainer.onControlRemovedObservable.add(l=>{l&&(this._rootChildrenHaveChanged=!0)}),this._preKeyboardObserver=r.onPreKeyboardObservable.add(l=>{this._focusedControl&&(l.type===KeyboardEventTypes.KEYDOWN&&this._focusedControl.processKeyboard(l.event),l.skipOnPointerObservable=!0)}),this._rootContainer._link(this),this.hasAlpha=!0,(!t||!i)&&(this._resizeObserver=r.getEngine().onResizeObservable.add(()=>this._onResize()),this._onResize()),this._texture.isReady=!0)}getClassName(){return"AdvancedDynamicTexture"}executeOnAllControls(e,t){t||(t=this._rootContainer),e(t);for(const i of t.children){if(i.children){this.executeOnAllControls(e,i);continue}e(i)}}get useInvalidateRectOptimization(){return this._useInvalidateRectOptimization}set useInvalidateRectOptimization(e){this._useInvalidateRectOptimization=e}invalidateRect(e,t,i,r){if(this._useInvalidateRectOptimization)if(!this._invalidatedRectangle)this._invalidatedRectangle=new Measure(e,t,i-e+1,r-t+1);else{const s=Math.ceil(Math.max(this._invalidatedRectangle.left+this._invalidatedRectangle.width-1,i)),n=Math.ceil(Math.max(this._invalidatedRectangle.top+this._invalidatedRectangle.height-1,r));this._invalidatedRectangle.left=Math.floor(Math.min(this._invalidatedRectangle.left,e)),this._invalidatedRectangle.top=Math.floor(Math.min(this._invalidatedRectangle.top,t)),this._invalidatedRectangle.width=s-this._invalidatedRectangle.left+1,this._invalidatedRectangle.height=n-this._invalidatedRectangle.top+1}}markAsDirty(){this._isDirty=!0}createStyle(){return new Style(this)}addControl(e){return this._rootContainer.addControl(e),this}removeControl(e){return this._rootContainer.removeControl(e),this}moveToNonOverlappedPosition(e,t=1,i=1){let r;if(Array.isArray(e))r=e;else{const s=this.getDescendants(!0);r=e===void 0?s.filter(n=>n.overlapGroup!==void 0):s.filter(n=>n.overlapGroup===e)}r.forEach(s=>{var n;let o=Vector2.Zero();const l=new Vector2(s.centerX,s.centerY);r.forEach(h=>{if(s!==h&&AdvancedDynamicTexture._Overlaps(s,h)){const u=l.subtract(new Vector2(h.centerX,h.centerY)),c=u.length();c>0&&(o=o.add(u.normalize().scale(i/c)))}}),o.length()>0&&(o=o.normalize().scale(t*((n=s.overlapDeltaMultiplier)!==null&&n!==void 0?n:1)),s.linkOffsetXInPixels+=o.x,s.linkOffsetYInPixels+=o.y)})}dispose(){const e=this.getScene();e&&(this._rootElement=null,e.onBeforeCameraRenderObservable.remove(this._renderObserver),this._resizeObserver&&e.getEngine().onResizeObservable.remove(this._resizeObserver),this._prePointerObserver&&e.onPrePointerObservable.remove(this._prePointerObserver),this._sceneRenderObserver&&e.onBeforeRenderObservable.remove(this._sceneRenderObserver),this._pointerObserver&&e.onPointerObservable.remove(this._pointerObserver),this._preKeyboardObserver&&e.onPreKeyboardObservable.remove(this._preKeyboardObserver),this._canvasPointerOutObserver&&e.getEngine().onCanvasPointerOutObservable.remove(this._canvasPointerOutObserver),this._canvasBlurObserver&&e.getEngine().onCanvasBlurObservable.remove(this._canvasBlurObserver),this._controlAddedObserver&&this._rootContainer.onControlAddedObservable.remove(this._controlAddedObserver),this._controlRemovedObserver&&this._rootContainer.onControlRemovedObservable.remove(this._controlRemovedObserver),this._layerToDispose&&(this._layerToDispose.texture=null,this._layerToDispose.dispose(),this._layerToDispose=null),this._rootContainer.dispose(),this.onClipboardObservable.clear(),this.onControlPickedObservable.clear(),this.onBeginRenderObservable.clear(),this.onEndRenderObservable.clear(),this.onBeginLayoutObservable.clear(),this.onEndLayoutObservable.clear(),this.onGuiReadyObservable.clear(),super.dispose())}_onResize(){const e=this.getScene();if(!e)return;const t=e.getEngine(),i=this.getSize();let r=t.getRenderWidth()*this._renderScale,s=t.getRenderHeight()*this._renderScale;this._renderAtIdealSize&&(this._idealWidth?(s=s*this._idealWidth/r,r=this._idealWidth):this._idealHeight&&(r=r*this._idealHeight/s,s=this._idealHeight)),(i.width!==r||i.height!==s)&&(this.scaleTo(r,s),this.markAsDirty(),(this._idealWidth||this._idealHeight)&&this._rootContainer._markAllAsDirty()),this.invalidateRect(0,0,i.width-1,i.height-1)}_getGlobalViewport(){const e=this.getSize(),t=this._fullscreenViewport.toGlobal(e.width,e.height),i=Math.round(t.width*(1/this.rootContainer.scaleX)),r=Math.round(t.height*(1/this.rootContainer.scaleY));return t.x+=(t.width-i)/2,t.y+=(t.height-r)/2,t.width=i,t.height=r,t}getProjectedPosition(e,t){const i=this.getProjectedPositionWithZ(e,t);return new Vector2(i.x,i.y)}getProjectedPositionWithZ(e,t){const i=this.getScene();if(!i)return Vector3.Zero();const r=this._getGlobalViewport(),s=Vector3.Project(e,t,i.getTransformMatrix(),r);return new Vector3(s.x,s.y,s.z)}_checkUpdate(e,t){if(!(this._layerToDispose&&!(e.layerMask&this._layerToDispose.layerMask))){if(this._isFullscreen&&this._linkedControls.length){const i=this.getScene();if(!i)return;const r=this._getGlobalViewport();for(const s of this._linkedControls){if(!s.isVisible)continue;const n=s._linkedMesh;if(!n||n.isDisposed()){Tools.SetImmediate(()=>{s.linkWithMesh(null)});continue}const o=n.getBoundingInfo?n.getBoundingInfo().boundingSphere.center:Vector3.ZeroReadOnly,l=Vector3.Project(o,n.getWorldMatrix(),i.getTransformMatrix(),r);if(l.z<0||l.z>1){s.notRenderable=!0;continue}s.notRenderable=!1,this.useInvalidateRectOptimization&&s.invalidateRect(),s._moveToProjectedPosition(l)}}!this._isDirty&&!this._rootContainer.isDirty||(this._isDirty=!1,this._render(t),t||this.update(this.applyYInversionOnUpdate,this.premulAlpha,AdvancedDynamicTexture.AllowGPUOptimizations))}}_render(e){var t;const i=this.getSize(),r=i.width,s=i.height,n=this.getContext();if(n.font="18px Arial",n.strokeStyle="white",this.onGuiReadyObservable.hasObservers()&&this._checkGuiIsReady(),this._rootChildrenHaveChanged){const l=(t=this.getScene())===null||t===void 0?void 0:t.activeCamera;l&&(this._rootChildrenHaveChanged=!1,this._checkUpdate(l,!0))}this.onBeginLayoutObservable.notifyObservers(this);const o=new Measure(0,0,r,s);this._numLayoutCalls=0,this._rootContainer._layout(o,n),this.onEndLayoutObservable.notifyObservers(this),this._isDirty=!1,!e&&(this._invalidatedRectangle?this._clearMeasure.copyFrom(this._invalidatedRectangle):this._clearMeasure.copyFromFloats(0,0,r,s),n.clearRect(this._clearMeasure.left,this._clearMeasure.top,this._clearMeasure.width,this._clearMeasure.height),this._background&&(n.save(),n.fillStyle=this._background,n.fillRect(this._clearMeasure.left,this._clearMeasure.top,this._clearMeasure.width,this._clearMeasure.height),n.restore()),this.onBeginRenderObservable.notifyObservers(this),this._numRenderCalls=0,this._rootContainer._render(n,this._invalidatedRectangle),this.onEndRenderObservable.notifyObservers(this),this._invalidatedRectangle=null)}_changeCursor(e){this._rootElement&&(this._rootElement.style.cursor=e,this._cursorChanged=!0)}_registerLastControlDown(e,t){this._lastControlDown[t]=e,this.onControlPickedObservable.notifyObservers(e)}_doPicking(e,t,i,r,s,n,o,l){const h=this.getScene();if(!h)return;const u=h.getEngine(),c=this.getSize();if(this._isFullscreen){const d=h.cameraToUseForPointers||h.activeCamera;if(!d)return;const f=d.viewport;e=e*(c.width/(u.getRenderWidth()*f.width)),t=t*(c.height/(u.getRenderHeight()*f.height))}if(this._capturingControl[s]){this._capturingControl[s].isPointerBlocker&&(this._shouldBlockPointer=!0),this._capturingControl[s]._processObservables(r,e,t,i,s,n);return}this._cursorChanged=!1,this._rootContainer._processPicking(e,t,i,r,s,n,o,l)||(h.doNotHandleCursors||this._changeCursor(""),r===PointerEventTypes.POINTERMOVE&&this._lastControlOver[s]&&(this._lastControlOver[s]._onPointerOut(this._lastControlOver[s],i),delete this._lastControlOver[s])),!this._cursorChanged&&!h.doNotHandleCursors&&this._changeCursor(""),this._manageFocus()}_cleanControlAfterRemovalFromList(e,t){for(const i in e){if(!Object.prototype.hasOwnProperty.call(e,i))continue;e[i]===t&&delete e[i]}}_cleanControlAfterRemoval(e){this._cleanControlAfterRemovalFromList(this._lastControlDown,e),this._cleanControlAfterRemovalFromList(this._lastControlOver,e)}pick(e,t,i=null){this._isFullscreen&&this._scene&&this._translateToPicking(this._scene,new Viewport(0,0,0,0),i,e,t)}_translateToPicking(e,t,i,r=e.pointerX,s=e.pointerY){const n=e.cameraToUseForPointers||e.activeCamera,o=e.getEngine(),l=e.cameraToUseForPointers;if(!n)t.x=0,t.y=0,t.width=o.getRenderWidth(),t.height=o.getRenderHeight();else if(n.rigCameras.length){const c=new Viewport(0,0,1,1);n.rigCameras.forEach(d=>{d.viewport.toGlobalToRef(o.getRenderWidth(),o.getRenderHeight(),c);const f=r/o.getHardwareScalingLevel()-c.x,_=s/o.getHardwareScalingLevel()-(o.getRenderHeight()-c.y-c.height);f<0||_<0||r>c.width||s>c.height||(e.cameraToUseForPointers=d,t.x=c.x,t.y=c.y,t.width=c.width,t.height=c.height)})}else n.viewport.toGlobalToRef(o.getRenderWidth(),o.getRenderHeight(),t);const h=r/o.getHardwareScalingLevel()-t.x,u=s/o.getHardwareScalingLevel()-(o.getRenderHeight()-t.y-t.height);if(this._shouldBlockPointer=!1,i){const c=i.event.pointerId||this._defaultMousePointerId;this._doPicking(h,u,i,i.type,c,i.event.button,i.event.deltaX,i.event.deltaY),(this._shouldBlockPointer||this._capturingControl[c])&&(i.skipOnPointerObservable=!0)}else this._doPicking(h,u,null,PointerEventTypes.POINTERMOVE,this._defaultMousePointerId,0);e.cameraToUseForPointers=l}attach(){const e=this.getScene();if(!e)return;const t=new Viewport(0,0,0,0);this._prePointerObserver=e.onPrePointerObservable.add(i=>{if(!(e.isPointerCaptured(i.event.pointerId)&&i.type===PointerEventTypes.POINTERUP&&!this._capturedPointerIds.has(i.event.pointerId))&&!(i.type!==PointerEventTypes.POINTERMOVE&&i.type!==PointerEventTypes.POINTERUP&&i.type!==PointerEventTypes.POINTERDOWN&&i.type!==PointerEventTypes.POINTERWHEEL)){if(i.type===PointerEventTypes.POINTERMOVE){if(e.isPointerCaptured(i.event.pointerId))return;i.event.pointerId&&(this._defaultMousePointerId=i.event.pointerId)}this._translateToPicking(e,t,i)}}),this._attachPickingToSceneRender(e,()=>this._translateToPicking(e,t,null),!1),this._attachToOnPointerOut(e),this._attachToOnBlur(e)}registerClipboardEvents(){self.addEventListener("copy",this._onClipboardCopy,!1),self.addEventListener("cut",this._onClipboardCut,!1),self.addEventListener("paste",this._onClipboardPaste,!1)}unRegisterClipboardEvents(){self.removeEventListener("copy",this._onClipboardCopy),self.removeEventListener("cut",this._onClipboardCut),self.removeEventListener("paste",this._onClipboardPaste)}_transformUvs(e){const t=this.getTextureMatrix();let i;if(t.isIdentityAs3x2())i=e;else{const r=TmpVectors.Matrix[0];t.getRowToRef(0,TmpVectors.Vector4[0]),t.getRowToRef(1,TmpVectors.Vector4[1]),t.getRowToRef(2,TmpVectors.Vector4[2]);const s=TmpVectors.Vector4[0],n=TmpVectors.Vector4[1],o=TmpVectors.Vector4[2];r.setRowFromFloats(0,s.x,s.y,0,0),r.setRowFromFloats(1,n.x,n.y,0,0),r.setRowFromFloats(2,0,0,1,0),r.setRowFromFloats(3,o.x,o.y,0,1),i=TmpVectors.Vector2[0],Vector2.TransformToRef(e,r,i)}if((this.wrapU===Texture.WRAP_ADDRESSMODE||this.wrapU===Texture.MIRROR_ADDRESSMODE)&&i.x>1){let r=i.x-Math.trunc(i.x);this.wrapU===Texture.MIRROR_ADDRESSMODE&&Math.trunc(i.x)%2===1&&(r=1-r),i.x=r}if((this.wrapV===Texture.WRAP_ADDRESSMODE||this.wrapV===Texture.MIRROR_ADDRESSMODE)&&i.y>1){let r=i.y-Math.trunc(i.y);this.wrapV===Texture.MIRROR_ADDRESSMODE&&Math.trunc(i.x)%2===1&&(r=1-r),i.y=r}return i}attachToMesh(e,t=!0){const i=this.getScene();i&&(this._pointerObserver&&i.onPointerObservable.remove(this._pointerObserver),this._pointerObserver=i.onPointerObservable.add(r=>{if(r.type!==PointerEventTypes.POINTERMOVE&&r.type!==PointerEventTypes.POINTERUP&&r.type!==PointerEventTypes.POINTERDOWN&&r.type!==PointerEventTypes.POINTERWHEEL)return;r.type===PointerEventTypes.POINTERMOVE&&r.event.pointerId&&(this._defaultMousePointerId=r.event.pointerId);const s=r.event.pointerId||this._defaultMousePointerId;if(r.pickInfo&&r.pickInfo.hit&&r.pickInfo.pickedMesh===e){let n=r.pickInfo.getTextureCoordinates();if(n){n=this._transformUvs(n);const o=this.getSize();this._doPicking(n.x*o.width,(this.applyYInversionOnUpdate?1-n.y:n.y)*o.height,r,r.type,s,r.event.button,r.event.deltaX,r.event.deltaY)}}else if(r.type===PointerEventTypes.POINTERUP){if(this._lastControlDown[s]&&this._lastControlDown[s]._forcePointerUp(s),delete this._lastControlDown[s],this.focusedControl){const n=this.focusedControl.keepsFocusWith();let o=!0;if(n)for(const l of n){if(this===l._host)continue;const h=l._host;if(h._lastControlOver[s]&&h._lastControlOver[s].isAscendant(l)){o=!1;break}}o&&(this.focusedControl=null)}}else r.type===PointerEventTypes.POINTERMOVE&&(this._lastControlOver[s]&&this._lastControlOver[s]._onPointerOut(this._lastControlOver[s],r,!0),delete this._lastControlOver[s])}),e.enablePointerMoveEvents=t,this._attachPickingToSceneRender(i,()=>{const r=this._defaultMousePointerId,s=i==null?void 0:i.pick(i.pointerX,i.pointerY);if(s&&s.hit&&s.pickedMesh===e){let n=s.getTextureCoordinates();if(n){n=this._transformUvs(n);const o=this.getSize();this._doPicking(n.x*o.width,(this.applyYInversionOnUpdate?1-n.y:n.y)*o.height,null,PointerEventTypes.POINTERMOVE,r,0)}}else this._lastControlOver[r]&&this._lastControlOver[r]._onPointerOut(this._lastControlOver[r],null,!0),delete this._lastControlOver[r]},!0),this._attachToOnPointerOut(i),this._attachToOnBlur(i))}moveFocusToControl(e){this.focusedControl=e,this._lastPickedControl=e,this._blockNextFocusCheck=!0}_manageFocus(){if(this._blockNextFocusCheck){this._blockNextFocusCheck=!1,this._lastPickedControl=this._focusedControl;return}if(this._focusedControl&&this._focusedControl!==this._lastPickedControl){if(this._lastPickedControl.isFocusInvisible)return;this.focusedControl=null}}_attachPickingToSceneRender(e,t,i){this._sceneRenderObserver=e.onBeforeRenderObservable.add(()=>{this.checkPointerEveryFrame&&(this._linkedControls.length>0||i)&&t()})}_attachToOnPointerOut(e){this._canvasPointerOutObserver=e.getEngine().onCanvasPointerOutObservable.add(t=>{this._lastControlOver[t.pointerId]&&this._lastControlOver[t.pointerId]._onPointerOut(this._lastControlOver[t.pointerId],null),delete this._lastControlOver[t.pointerId],this._lastControlDown[t.pointerId]&&this._lastControlDown[t.pointerId]!==this._capturingControl[t.pointerId]&&(this._lastControlDown[t.pointerId]._forcePointerUp(t.pointerId),delete this._lastControlDown[t.pointerId])})}_attachToOnBlur(e){this._canvasBlurObserver=e.getEngine().onCanvasBlurObservable.add(()=>{Object.entries(this._lastControlDown).forEach(([,t])=>{t._onCanvasBlur()}),this.focusedControl=null,this._lastControlDown={}})}serializeContent(){const e=this.getSize(),t={root:{},width:e.width,height:e.height};return this._rootContainer.serialize(t.root),t}parseSerializedObject(e,t){if(this._rootContainer=Control.Parse(e.root,this),t){const i=e.width,r=e.height;typeof i=="number"&&typeof r=="number"&&i>=0&&r>=0?this.scaleTo(i,r):this.scaleTo(1920,1080)}}clone(e){const t=this.getScene();if(!t)return this;const i=this.getSize(),r=this.serializeContent(),s=new AdvancedDynamicTexture(e??"Clone of "+this.name,i.width,i.height,t,!this.noMipmap,this.samplingMode);return s.parseSerializedObject(r),s}static async ParseFromSnippetAsync(e,t,i){const r=i??AdvancedDynamicTexture.CreateFullscreenUI("ADT from snippet");if(e==="_BLANK")return r;const s=await AdvancedDynamicTexture._LoadURLContentAsync(AdvancedDynamicTexture.SnippetUrl+"/"+e.replace(/#/g,"/"),!0);return r.parseSerializedObject(s,t),r}parseFromSnippetAsync(e,t){return AdvancedDynamicTexture.ParseFromSnippetAsync(e,t,this)}static async ParseFromFileAsync(e,t,i){const r=i??AdvancedDynamicTexture.CreateFullscreenUI("ADT from URL"),s=await AdvancedDynamicTexture._LoadURLContentAsync(e);return r.parseSerializedObject(s,t),r}parseFromURLAsync(e,t){return AdvancedDynamicTexture.ParseFromFileAsync(e,t,this)}static _LoadURLContentAsync(e,t=!1){return e===""?Promise.reject("No URL provided"):new Promise((i,r)=>{const s=new WebRequest;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){let n;if(t){const l=JSON.parse(JSON.parse(s.responseText).jsonPayload);n=l.encodedGui?new TextDecoder("utf-8").decode(DecodeBase64ToBinary(l.encodedGui)):l.gui}else n=s.responseText;const o=JSON.parse(n);i(o)}else r("Unable to load")}),s.open("GET",e),s.send()})}static _Overlaps(e,t){return!(e.centerX>t.centerX+t.widthInPixels||e.centerX+e.widthInPixels<t.centerX||e.centerY+e.heightInPixels<t.centerY||e.centerY>t.centerY+t.heightInPixels)}static CreateForMesh(e,t=1024,i=1024,r=!0,s=!1,n,o=this._CreateMaterial){const l=RandomGUID(),h=new AdvancedDynamicTexture(`AdvancedDynamicTexture for ${e.name} [${l}]`,t,i,e.getScene(),!0,Texture.TRILINEAR_SAMPLINGMODE,n);return o(e,l,h,s),h.attachToMesh(e,r),h}static _CreateMaterial(e,t,i,r){const s=GetClass("BABYLON.StandardMaterial");if(!s)throw"StandardMaterial needs to be imported before as it contains a side-effect required by your code.";const n=new s(`AdvancedDynamicTextureMaterial for ${e.name} [${t}]`,e.getScene());n.backFaceCulling=!1,n.diffuseColor=Color3.Black(),n.specularColor=Color3.Black(),r?(n.diffuseTexture=i,n.emissiveTexture=i,i.hasAlpha=!0):(n.emissiveTexture=i,n.opacityTexture=i),e.material=n}static CreateForMeshTexture(e,t=1024,i=1024,r=!0,s){const n=new AdvancedDynamicTexture(e.name+" AdvancedDynamicTexture",t,i,e.getScene(),!0,Texture.TRILINEAR_SAMPLINGMODE,s);return n.attachToMesh(e,r),n}static CreateFullscreenUI(e,t=!0,i=null,r=Texture.BILINEAR_SAMPLINGMODE,s=!1){const n=new AdvancedDynamicTexture(e,0,0,i,!1,r),o=n.getScene(),l=new Layer(e+"_layer",null,o,!t);if(l.texture=n,n._layerToDispose=l,n._isFullscreen=!0,s&&o){const h=1/o.getEngine().getHardwareScalingLevel();n._rootContainer.scaleX=h,n._rootContainer.scaleY=h}return n.attach(),n}scale(e){super.scale(e),this.markAsDirty()}scaleTo(e,t){super.scaleTo(e,t),this.markAsDirty()}_checkGuiIsReady(){this.guiIsReady()&&(this.onGuiReadyObservable.notifyObservers(this),this.onGuiReadyObservable.clear())}guiIsReady(){return this._rootContainer.isReady()}}AdvancedDynamicTexture.SnippetUrl=Constants.SnippetUrl;AdvancedDynamicTexture.AllowGPUOptimizations=!0;var sprintf={};(function(a){(function(){var e={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[+-]/};function t(o){return r(n(o),arguments)}function i(o,l){return t.apply(null,[o].concat(l||[]))}function r(o,l){var h=1,u=o.length,c,d="",f,_,g,p,m,E,M,x;for(f=0;f<u;f++)if(typeof o[f]=="string")d+=o[f];else if(typeof o[f]=="object"){if(g=o[f],g.keys)for(c=l[h],_=0;_<g.keys.length;_++){if(c==null)throw new Error(t('[sprintf] Cannot access property "%s" of undefined value "%s"',g.keys[_],g.keys[_-1]));c=c[g.keys[_]]}else g.param_no?c=l[g.param_no]:c=l[h++];if(e.not_type.test(g.type)&&e.not_primitive.test(g.type)&&c instanceof Function&&(c=c()),e.numeric_arg.test(g.type)&&typeof c!="number"&&isNaN(c))throw new TypeError(t("[sprintf] expecting number but found %T",c));switch(e.number.test(g.type)&&(M=c>=0),g.type){case"b":c=parseInt(c,10).toString(2);break;case"c":c=String.fromCharCode(parseInt(c,10));break;case"d":case"i":c=parseInt(c,10);break;case"j":c=JSON.stringify(c,null,g.width?parseInt(g.width):0);break;case"e":c=g.precision?parseFloat(c).toExponential(g.precision):parseFloat(c).toExponential();break;case"f":c=g.precision?parseFloat(c).toFixed(g.precision):parseFloat(c);break;case"g":c=g.precision?String(Number(c.toPrecision(g.precision))):parseFloat(c);break;case"o":c=(parseInt(c,10)>>>0).toString(8);break;case"s":c=String(c),c=g.precision?c.substring(0,g.precision):c;break;case"t":c=String(!!c),c=g.precision?c.substring(0,g.precision):c;break;case"T":c=Object.prototype.toString.call(c).slice(8,-1).toLowerCase(),c=g.precision?c.substring(0,g.precision):c;break;case"u":c=parseInt(c,10)>>>0;break;case"v":c=c.valueOf(),c=g.precision?c.substring(0,g.precision):c;break;case"x":c=(parseInt(c,10)>>>0).toString(16);break;case"X":c=(parseInt(c,10)>>>0).toString(16).toUpperCase();break}e.json.test(g.type)?d+=c:(e.number.test(g.type)&&(!M||g.sign)?(x=M?"+":"-",c=c.toString().replace(e.sign,"")):x="",m=g.pad_char?g.pad_char==="0"?"0":g.pad_char.charAt(1):" ",E=g.width-(x+c).length,p=g.width&&E>0?m.repeat(E):"",d+=g.align?x+c+p:m==="0"?x+p+c:p+x+c)}return d}var s=Object.create(null);function n(o){if(s[o])return s[o];for(var l=o,h,u=[],c=0;l;){if((h=e.text.exec(l))!==null)u.push(h[0]);else if((h=e.modulo.exec(l))!==null)u.push("%");else if((h=e.placeholder.exec(l))!==null){if(h[2]){c|=1;var d=[],f=h[2],_=[];if((_=e.key.exec(f))!==null)for(d.push(_[1]);(f=f.substring(_[0].length))!=="";)if((_=e.key_access.exec(f))!==null)d.push(_[1]);else if((_=e.index_access.exec(f))!==null)d.push(_[1]);else throw new SyntaxError("[sprintf] failed to parse named argument key");else throw new SyntaxError("[sprintf] failed to parse named argument key");h[2]=d}else c|=2;if(c===3)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");u.push({placeholder:h[0],param_no:h[1],keys:h[2],sign:h[3],pad_char:h[4],align:h[5],width:h[6],precision:h[7],type:h[8]})}else throw new SyntaxError("[sprintf] unexpected placeholder");l=l.substring(h[0].length)}return s[o]=u}a.sprintf=t,a.vsprintf=i,typeof window<"u"&&(window.sprintf=t,window.vsprintf=i)})()})(sprintf);var Je,_t,Qt;class GraphInterpolator{constructor(e,t){Q(this,_t);re(this,"points",[]);Q(this,Je,null);if(typeof e=="number"){ne(this,_t,Qt).call(this,e,t);return}if(!e||!e.source){this.points=[{time:0,value:0}];return}switch(e.source.$case){case"constValue":{const i=e.source.constValue;this.points=[{time:0,value:i}];return}case"graphId":{const i=e.source.graphId;ne(this,_t,Qt).call(this,i,t);return}}}interpolate(e){const t=this.points.findIndex(l=>l.time>e);if(t==-1)return this.points[this.points.length-1].value;if(t==0)return this.points[0].value;if(this.points[t].time-e<1e-7)return this.points[t].value;const i=this.points[t-1].time,r=this.points[t].time;let s=(e-i)/(r-i);I(this,Je)&&(s=I(this,Je).call(this,s));const n=this.points[t-1].value,o=this.points[t].value;return n*(1-s)+o*s}}Je=new WeakMap,_t=new WeakSet,Qt=function(e,t){var r;const i=t.graphs.find(s=>s.id==e);!i||i.points.length==0?this.points=[{time:0,value:0}]:(this.points=i.points.map(s=>({time:s.time,value:s.value})),$(this,Je,((r=getInterpolation(i.interpolation))==null?void 0:r.ease)??null))};const DataRefPattern=/%\(.+?\)/m,GraphRefPattern=/%\(graphs\[(\d+?)\]\)/gm,PathRefPattern=/%\(paths\[(\d+?)\]\.[x-z]\)/gm;var et,tt,Ee,gt,ve,pt,xe;class TextEngine{constructor(e){Q(this,et,void 0);Q(this,tt,!1);Q(this,Ee,void 0);Q(this,gt,void 0);Q(this,ve,void 0);Q(this,pt,void 0);Q(this,xe,void 0);$(this,et,e),$(this,Ee,new Map),$(this,gt,new Proxy(I(this,Ee),{get:function(t,i){var r;return((r=t.get(Number(i)))==null?void 0:r.currentValue)??0}})),$(this,ve,new Map),$(this,pt,new Proxy(I(this,ve),{get:function(t,i){var r;return((r=t.get(Number(i)))==null?void 0:r.currentValue)??Vector3.Zero()}})),$(this,xe,[])}get isDirty(){return I(this,tt)}addText(e,t){if(!DataRefPattern.test(t))return e.text=t,!1;I(this,xe).push({template:t,target:e}),$(this,tt,!0);for(const i of t.matchAll(GraphRefPattern)){const r=Number(i[1]);I(this,Ee).has(r)||I(this,Ee).set(r,{interpolation:new GraphInterpolator(r,I(this,et)),currentValue:NaN})}for(const i of t.matchAll(PathRefPattern)){const r=Number(i[1]);I(this,ve).has(r)||I(this,ve).set(r,{interpolation:new PathInterpolator(r,I(this,et)),currentValue:new Vector3})}return!0}removeText(e){const t=I(this,xe).findIndex(i=>i.target==e);t>-1&&I(this,xe).splice(t,1)}update(e){I(this,Ee).forEach(t=>{t.currentValue=t.interpolation.interpolate(e)}),I(this,ve).forEach(t=>{t.currentValue=t.interpolation.interpolate(e)}),I(this,xe).forEach(t=>{t.target.text=sprintf.sprintf(t.template,{graphs:I(this,gt),paths:I(this,pt)})}),$(this,tt,!1)}}et=new WeakMap,tt=new WeakMap,Ee=new WeakMap,gt=new WeakMap,ve=new WeakMap,pt=new WeakMap,xe=new WeakMap;const BackgroundColor=new Color4(.239,.239,.239,1);function isMetadata(a){return"name"in a&&"description"in a}var mt,it;class SceneBuildTool{constructor(e,t){re(this,"animationGroup");re(this,"scene");re(this,"overlayTexture");re(this,"textEngine");re(this,"project");Q(this,mt,0);re(this,"objectMap");Q(this,it,void 0);re(this,"defaultMaterial");this.project=e,this.scene=new Scene(t),this.animationGroup=new AnimationGroup("animationGroup",this.scene),this.objectMap=new Map,$(this,it,new Map),this.defaultMaterial=new StandardMaterial("default"),this.defaultMaterial.diffuseColor=Color3.Black(),this.defaultMaterial.freeze(),this.overlayTexture=AdvancedDynamicTexture.CreateFullscreenUI("GUI",!0,this.scene),this.textEngine=new TextEngine(this.project),this.scene.clearColor=BackgroundColor}applyMetadata(e,t){e.uniqueId=Ht(this,mt)._++,e.metadata=t,this.objectMap.set(e.uniqueId,e)}skipObject(){Ht(this,mt)._++}parseScalar(e,t,i){if(!e||!e.source)return setProperty(t,i,0);switch(e.source.$case){case"constValue":return setProperty(t,i,e.source.constValue);case"graphId":{const r=e.source.graphId,s=this.project.graphs.find(n=>n.id==r);if(!s||s.points.length==0)return setProperty(t,i,0);{const n=new Animation(s.name,i,1,Animation.ANIMATIONTYPE_FLOAT,Animation.ANIMATIONLOOPMODE_CYCLE),o=s.points.map(l=>({frame:l.time,value:l.value}));n.setKeys(o),n.setEasingFunction(getInterpolation(s.interpolation)),this.animationGroup.addTargetedAnimation(n,t);return}}}}parseVector(e,t,i){if(!e||!e.source)return setProperty(t,i,new Vector3);switch(e.source.$case){case"constValue":{const r=e.source.constValue;return setProperty(t,i,new Vector3(r.x,r.y,r.z))}case"pathId":{const r=e.source.pathId,s=this.project.paths.find(n=>n.id==r);if(!s||s.points.length==0)return setProperty(t,i,new Vector3);{const n=new Animation(s.name,i,1,Animation.ANIMATIONTYPE_VECTOR3,Animation.ANIMATIONLOOPMODE_CYCLE),o=s.points.map(l=>{var h,u,c;return{frame:l.time,value:new Vector3((h=l.position)==null?void 0:h.x,(u=l.position)==null?void 0:u.y,(c=l.position)==null?void 0:c.z)}});n.setKeys(o),n.setEasingFunction(getInterpolation(s.interpolation)),this.animationGroup.addTargetedAnimation(n,t);return}}}}parseColor(e,t){if(!e||!e.source)return this.defaultMaterial;switch(e.source.$case){case"constValue":{const i=e.source.constValue;return this.getStaticMaterial(i.r,i.g,i.b,i.a)}case"scalarValue":{const[i,r]=this.mapColor(e.source.scalarValue);return this.getStaticMaterial(i.r,i.g,i.b,r)}case"graphId":{const i=new StandardMaterial(t),r=e.source.graphId,s=this.project.graphs.find(n=>n.id==r);if(!s||s.points.length==0)return this.defaultMaterial;if(s.points.length==1){const n=s.points[0].value,[o,l]=this.mapColor(n);return this.getStaticMaterial(o.r,o.g,o.b,l)}else{const n=new Animation(s.name,"diffuseColor",1,Animation.ANIMATIONTYPE_COLOR3,Animation.ANIMATIONLOOPMODE_CYCLE),o=new Animation(s.name,"alpha",1,Animation.ANIMATIONTYPE_FLOAT,Animation.ANIMATIONLOOPMODE_CYCLE),l=Array(),h=Array();let u=s.points[0].time,c=s.points[0].value;for(let f=1;f<s.points.length;++f){l.pop(),h.pop();const _=s.points[f].time,g=s.points[f].value,[p,m]=this.colorFrames(u,c,_,g);l.push(...p),h.push(...m),u=_,c=g}n.setKeys(l),o.setKeys(h);const d=getInterpolation(s.interpolation);return n.setEasingFunction(d),o.setEasingFunction(d),this.animationGroup.addTargetedAnimation(n,i),this.animationGroup.addTargetedAnimation(o,i),i}}}}mapColor(e){if(!this.project.colormap||this.project.colormap.stops.length==0)return[Color3.Black(),1];const t=this.project.colormap.stops,i=t.findIndex(c=>c.value>e);if(i==-1){const c=t[t.length-1].color;return c?[new Color3(c.r,c.g,c.b),c.a]:[Color3.Black(),1]}if(i==0){const c=t[0].color;return c?[new Color3(c.r,c.g,c.b),c.a]:[Color3.Black(),1]}const r=t[i-1],s=t[i];if(!r.color||!s.color)return[Color3.Black(),1];const n=(e-r.value)/(s.value-r.value),o=r.color.r+(s.color.r-r.color.r)*n,l=r.color.g+(s.color.g-r.color.g)*n,h=r.color.b+(s.color.b-r.color.b)*n,u=r.color.a+(s.color.a-r.color.a)*n;return[new Color3(o,l,h),u]}getStaticMaterial(e,t,i,r){const s=toHex(e,t,i,r),n=I(this,it).get(s);if(n)return n;{const o=new StandardMaterial(s,this.scene);return o.diffuseColor=new Color3(e,t,i),o.alpha=r,o.freeze(),I(this,it).set(s,o),o}}isStaticMaterial(e){if(!e||!e.source)return!0;switch(e.source.$case){case"constValue":case"scalarValue":return!0;case"graphId":{const t=e.source.graphId,i=this.project.graphs.find(r=>r.id==t);return!i||i.points.length<=0}}}colorFrames(e,t,i,r){const s=Array(),n=Array();if(!this.project.colormap||this.project.colormap.stops.length==0)return[s,n];const o=this.project.colormap.stops,l=i-e,h=r-t;let u=o.findIndex(g=>g.value>t);u==-1&&(u=o.length-1);let c=o.findIndex(g=>g.value>r);c==-1&&(c=o.length);const d=this.mapColor(t);s.push({frame:e,value:d[0]}),n.push({frame:e,value:d[1]});const f=u<=c?1:-1;for(let g=u;g!=c;g+=f){const p=o[g];if(!p.color)continue;const m=(p.value-t)/h,E=e+m*l;s.push({frame:E,value:new Color3(p.color.r,p.color.g,p.color.b)}),n.push({frame:E,value:p.color.a})}const _=this.mapColor(r);return s.push({frame:i,value:_[0]}),n.push({frame:i,value:_[1]}),[s,n]}}mt=new WeakMap,it=new WeakMap;ThinEngine.prototype.updateRawTexture=function(a,e,t,i,r=null,s=0,n=!1){if(!a)return;const o=this._getRGBABufferInternalSizedFormat(s,t,n),l=this._getInternalFormat(t),h=this._getWebGLTextureType(s);this._bindTextureDirectly(this._gl.TEXTURE_2D,a,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(a._bufferView=e,a.format=t,a.type=s,a.invertY=i,a._compression=r),a.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],a.width,a.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,a.width,a.height,0,l,h,e),a.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),a.isReady=!0};ThinEngine.prototype.createRawTexture=function(a,e,t,i,r,s,n,o=null,l=0,h=0,u=!1){const c=new InternalTexture(this,InternalTextureSource.Raw);c.baseWidth=e,c.baseHeight=t,c.width=e,c.height=t,c.format=i,c.generateMipMaps=r,c.samplingMode=n,c.invertY=s,c._compression=o,c.type=l,c._useSRGBBuffer=this._getUseSRGBBuffer(u,!r),this._doNotHandleContextLost||(c._bufferView=a),this.updateRawTexture(c,a,i,s,o,l,c._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,c,!0);const d=this._getSamplingParameters(n,r);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),r&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(c),c};ThinEngine.prototype.createRawCubeTexture=function(a,e,t,i,r,s,n,o=null){const l=this._gl,h=new InternalTexture(this,InternalTextureSource.CubeRaw);h.isCube=!0,h.format=t,h.type=i,this._doNotHandleContextLost||(h._bufferViewArray=a);const u=this._getWebGLTextureType(i);let c=this._getInternalFormat(t);c===l.RGB&&(c=l.RGBA),u===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(r=!1,n=1,Logger.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):u===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,n=1,Logger.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):u===l.FLOAT&&!this._caps.textureFloatRender?(r=!1,Logger.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):u===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(r=!1,Logger.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));const d=e,f=d;if(h.width=d,h.height=f,h.invertY=s,h._compression=o,!this.needPOTTextures||Tools.IsExponentOfTwo(h.width)&&Tools.IsExponentOfTwo(h.height)||(r=!1),a)this.updateRawCubeTexture(h,a,t,i,s,o);else{const p=this._getRGBABufferInternalSizedFormat(i),m=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,h,!0);for(let E=0;E<6;E++)o?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+E,m,this.getCaps().s3tc[o],h.width,h.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+E,m,p,h.width,h.height,0,c,u,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,h,!0),a&&r&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const g=this._getSamplingParameters(n,r);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,g.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,g.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),h.generateMipMaps=r,h.samplingMode=n,h.isReady=!0,h};ThinEngine.prototype.updateRawCubeTexture=function(a,e,t,i,r,s=null,n=0){a._bufferViewArray=e,a.format=t,a.type=i,a.invertY=r,a._compression=s;const o=this._gl,l=this._getWebGLTextureType(i);let h=this._getInternalFormat(t);const u=this._getRGBABufferInternalSizedFormat(i);let c=!1;h===o.RGB&&(h=o.RGBA,c=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,a,!0),this._unpackFlipY(r===void 0?!0:!!r),a.width%4!==0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let f=0;f<6;f++){let _=e[f];s?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+f,n,this.getCaps().s3tc[s],a.width,a.height,0,_):(c&&(_=_convertRGBtoRGBATextureData(_,a.width,a.height,i)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+f,n,u,a.width,a.height,0,h,l,_))}(!this.needPOTTextures||Tools.IsExponentOfTwo(a.width)&&Tools.IsExponentOfTwo(a.height))&&a.generateMipMaps&&n===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),a.isReady=!0};ThinEngine.prototype.createRawCubeTextureFromUrl=function(a,e,t,i,r,s,n,o,l=null,h=null,u=3,c=!1){const d=this._gl,f=this.createRawCubeTexture(null,t,i,r,!s,c,u,null);e==null||e.addPendingData(f),f.url=a,f.isReady=!1,this._internalTexturesCache.push(f);const _=(p,m)=>{e==null||e.removePendingData(f),h&&p&&h(p.status+" "+p.statusText,m)},g=p=>{const m=f.width,E=n(p);if(E){if(o){const M=this._getWebGLTextureType(r);let x=this._getInternalFormat(i);const A=this._getRGBABufferInternalSizedFormat(r);let T=!1;x===d.RGB&&(x=d.RGBA,T=!0),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);const C=o(E);for(let b=0;b<C.length;b++){const y=m>>b;for(let S=0;S<6;S++){let R=C[b][S];T&&(R=_convertRGBtoRGBATextureData(R,y,y,r)),d.texImage2D(S,b,A,y,y,0,x,M,R)}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,E,i,r,c);f.isReady=!0,e==null||e.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),l&&l()}};return this._loadFile(a,p=>{g(p)},void 0,e==null?void 0:e.offlineProvider,!0,_),f};function _convertRGBtoRGBATextureData(a,e,t,i){let r,s=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),s=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let n=0;n<e;n++)for(let o=0;o<t;o++){const l=(o*e+n)*3,h=(o*e+n)*4;r[h+0]=a[l+0],r[h+1]=a[l+1],r[h+2]=a[l+2],r[h+3]=s}return r}function _makeCreateRawTextureFunction(a){return function(e,t,i,r,s,n,o,l,h=null,u=0){const c=a?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=a?InternalTextureSource.Raw3D:InternalTextureSource.Raw2DArray,f=new InternalTexture(this,d);f.baseWidth=t,f.baseHeight=i,f.baseDepth=r,f.width=t,f.height=i,f.depth=r,f.format=s,f.type=u,f.generateMipMaps=n,f.samplingMode=l,a?f.is3D=!0:f.is2DArray=!0,this._doNotHandleContextLost||(f._bufferView=e),a?this.updateRawTexture3D(f,e,s,o,h,u):this.updateRawTexture2DArray(f,e,s,o,h,u),this._bindTextureDirectly(c,f,!0);const _=this._getSamplingParameters(l,n);return this._gl.texParameteri(c,this._gl.TEXTURE_MAG_FILTER,_.mag),this._gl.texParameteri(c,this._gl.TEXTURE_MIN_FILTER,_.min),n&&this._gl.generateMipmap(c),this._bindTextureDirectly(c,null),this._internalTexturesCache.push(f),f}}ThinEngine.prototype.createRawTexture2DArray=_makeCreateRawTextureFunction(!1);ThinEngine.prototype.createRawTexture3D=_makeCreateRawTextureFunction(!0);function _makeUpdateRawTextureFunction(a){return function(e,t,i,r,s=null,n=0){const o=a?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(n),h=this._getInternalFormat(i),u=this._getRGBABufferInternalSizedFormat(n,i);this._bindTextureDirectly(o,e,!0),this._unpackFlipY(r===void 0?!0:!!r),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=s),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&t?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[s],e.width,e.height,e.depth,0,t):this._gl.texImage3D(o,0,u,e.width,e.height,e.depth,0,h,l,t),e.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),e.isReady=!0}}ThinEngine.prototype.updateRawTexture2DArray=_makeUpdateRawTextureFunction(!1);ThinEngine.prototype.updateRawTexture3D=_makeUpdateRawTextureFunction(!0);class RawTexture extends Texture{constructor(e,t,i,r,s,n=!0,o=!1,l=3,h=0,u,c){super(null,s,!n,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,u),this.format=r,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&h===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&h===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,r,n,o,l,null,h,u??0,c??!1),this.wrapU=Texture.CLAMP_ADDRESSMODE,this.wrapV=Texture.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,i,r,s=!0,n=!1,o=3){return new RawTexture(e,t,i,1,r,s,n,o)}static CreateLuminanceAlphaTexture(e,t,i,r,s=!0,n=!1,o=3){return new RawTexture(e,t,i,2,r,s,n,o)}static CreateAlphaTexture(e,t,i,r,s=!0,n=!1,o=3){return new RawTexture(e,t,i,0,r,s,n,o)}static CreateRGBTexture(e,t,i,r,s=!0,n=!1,o=3,l=0,h=0,u=!1){return new RawTexture(e,t,i,4,r,s,n,o,l,h,u)}static CreateRGBATexture(e,t,i,r,s=!0,n=!1,o=3,l=0,h=0,u=!1){return new RawTexture(e,t,i,5,r,s,n,o,l,h,u)}static CreateRGBAStorageTexture(e,t,i,r,s=!0,n=!1,o=3,l=0,h=!1){return new RawTexture(e,t,i,5,r,s,n,o,l,1,h)}static CreateRTexture(e,t,i,r,s=!0,n=!1,o=Texture.TRILINEAR_SAMPLINGMODE,l=1){return new RawTexture(e,t,i,6,r,s,n,o,l)}static CreateRStorageTexture(e,t,i,r,s=!0,n=!1,o=Texture.TRILINEAR_SAMPLINGMODE,l=1){return new RawTexture(e,t,i,6,r,s,n,o,l,1)}}const TEXTURE_SIZE=2048;var Pe,rt,ce,Me,De,Oe,we,Be,ae,ue,Le,Ce,At,Kt;class TubeController{constructor(e,t,i){Q(this,At);Q(this,Pe,void 0);Q(this,rt,void 0);Q(this,ce,void 0);Q(this,Me,void 0);Q(this,De,void 0);Q(this,Oe,void 0);Q(this,we,void 0);Q(this,Be,void 0);Q(this,ae,void 0);Q(this,ue,void 0);Q(this,Le,void 0);Q(this,Ce,void 0);var s;if($(this,Pe,i.name),$(this,rt,t.isGrowing),$(this,Oe,e.scene),$(this,we,new PathInterpolator(t.pathId,e.project)),$(this,Be,new GraphInterpolator(t.radius,e.project)),$(this,ae,I(this,we).path.map(n=>n.time).concat(I(this,Be).points.map(n=>n.time))),I(this,ae).sort((n,o)=>n-o),$(this,ae,I(this,ae).filter((n,o)=>!(o>0&&Math.abs(I(this,ae)[o-1]-n)<1e-7))),I(this,ae).length<2){$(this,Me,0),$(this,De,0),$(this,ue,[]),$(this,Le,[]),$(this,Ce,0);return}$(this,Ce,I(this,ae).length),$(this,Me,I(this,ae)[0]),$(this,De,I(this,ae)[I(this,Ce)-1]);const r=I(this,De)-I(this,Me);if($(this,ue,I(this,ae).map(n=>I(this,we).interpolate(n))),$(this,Le,I(this,ae).map(n=>I(this,Be).interpolate(n))),I(this,ue).push(I(this,ue)[I(this,Ce)-1],I(this,ue)[I(this,Ce)-1]),$(this,ce,ne(this,At,Kt).call(this,((s=e.project.meta)==null?void 0:s.startTime)??0)),e.applyMetadata(I(this,ce),i),!t.color||!t.color.source||t.color.source.$case!="graphId")I(this,ce).material=e.parseColor(t.color,i.name+"_color");else{const n=t.color.source.graphId,o=e.project.graphs.find(l=>l.id==n);if(!o||o.points.length==0)I(this,ce).material=e.defaultMaterial;else{const l=new GraphInterpolator(n,e.project),h=I(this,Me),u=new Uint8Array(function*(){for(let f=0;f<TEXTURE_SIZE;++f){const _=f/TEXTURE_SIZE*r+h,g=l.interpolate(_),[p,m]=e.mapColor(g);yield p.r*255,yield p.g*255,yield p.b*255,yield m*255}}()),c=RawTexture.CreateRGBATexture(u,1,TEXTURE_SIZE,e.scene),d=new StandardMaterial(i.name+"_mat",e.scene);d.diffuseTexture=c,I(this,ce).material=d}}}update(e){I(this,ae).length<2||!I(this,rt)&&I(this,ce)!=null||$(this,ce,ne(this,At,Kt).call(this,e))}get isEnabled(){var e;return((e=I(this,ce))==null?void 0:e.isEnabled())??!1}}Pe=new WeakMap,rt=new WeakMap,ce=new WeakMap,Me=new WeakMap,De=new WeakMap,Oe=new WeakMap,we=new WeakMap,Be=new WeakMap,ae=new WeakMap,ue=new WeakMap,Le=new WeakMap,Ce=new WeakMap,At=new WeakSet,Kt=function(e){if(!I(this,rt)||e>I(this,De))return MeshBuilder.CreateTube(I(this,Pe),{path:I(this,ue).slice(0,-2),radiusFunction:s=>I(this,Le)[s],tessellation:64,sideOrientation:Mesh.DOUBLESIDE,updatable:!0,instance:I(this,ce)},I(this,Oe));if(e-I(this,Me)<=1e-4)return MeshBuilder.CreateTube(I(this,Pe),{path:I(this,ue),radius:0,sideOrientation:Mesh.DOUBLESIDE,updatable:!0,instance:I(this,ce)},I(this,Oe));const t=I(this,ae).findIndex(s=>s>=e),i=I(this,ue).slice(0,t);if(e-I(this,ae)[t]<1e-7){const s=I(this,ue)[t].subtract(I(this,ue)[t-1]).normalize(),n=I(this,we).interpolate(e);i[t]=n,i[t+1]=n.add(s.scaleInPlace(1e-6))}i.push(...I(this,ue).slice(t,-2));const r=s=>s<t?I(this,Le)[s]:s==t?I(this,Be).interpolate(e):0;return MeshBuilder.CreateTube(I(this,Pe),{path:i,radiusFunction:r,sideOrientation:Mesh.DOUBLESIDE,updatable:!0,instance:I(this,ce)},I(this,Oe))};function buildScene(a,e){var E,M,x;const t=new SceneBuildTool(a,e),i=buildCamera(t,a.camera),r=i.position.subtract(i.target),s=new HemisphericLight("light",r,t.scene);i.onViewMatrixChangedObservable.add(()=>{i.position.subtractToRef(i.target,s.direction)});const n=new OverlayBuilder(t),o=new PrismBuilder(t),l=new SphereBuilder(t),h=[];a.animatibles.forEach(A=>{if(!A.instance){t.skipObject();return}switch(A.instance.$case){case"line":buildLine(t,A.instance.line,A);break;case"prism":o.build(A.instance.prism,A);break;case"sphere":l.build(A.instance.sphere,A);break;case"tube":h.push(new TubeController(t,A.instance.tube,A));break;case"overlay":n.build(A.instance.overlay,A);break}});let u=((E=a.meta)==null?void 0:E.speedRatio)??1;u<=0&&(u=1),t.animationGroup.speedRatio=u;const c=!1;{const A=new TransformNode("master",t.scene),T=new Animation("masterAnimation","scalingDeterminant",1,Animation.ANIMATIONTYPE_FLOAT,Animation.ANIMATIONLOOPMODE_CYCLE);T.setKeys([{frame:0,value:0},{frame:1,value:0}]),t.animationGroup.addTargetedAnimation(T,A)}t.animationGroup.normalize((M=a.meta)==null?void 0:M.startTime,(x=a.meta)==null?void 0:x.endTime);const d=new Description(t.overlayTexture,t.textEngine),f=buildGrid(t.scene),_=createOrientationViewScene(e,i),g=new Observable;t.scene.detachControl();const p={animation:t.animationGroup,isStatic:c,scene:t.scene,camera:i,objectMap:t.objectMap,indicatorLayer:_,grid:f,pathVisualizer:new PathVisualizer(t.scene,a),overlayRoot:n.rootContainer,overlayTexture:t.overlayTexture,textEngine:t.textEngine,description:d,onAnimationTick:g};e.runRenderLoop(()=>{p.scene.render(),p.indicatorLayer.render()});let m=NaN;return t.scene.registerBeforeRender(()=>{const A=p.animation.animatables[0].masterFrame,T=p.animation.isPlaying||m!=A;T&&(h.forEach(C=>{C.isEnabled&&C.update(A)}),g.notifyObservers({currentFrame:A})),(T||p.textEngine.isDirty)&&p.textEngine.update(A),m=A}),p}function createDownload(a,e){const t=URL.createObjectURL(a),i=document.createElement("a");i.setAttribute("href",t),i.setAttribute("download",e),i.click(),URL.revokeObjectURL(t)}function takeScreenshot(a,e="Screenshot.png"){a.toBlob(t=>{t&&createDownload(t,e)})}let canvas=null,ctx=null;function getFontOffset(a){if((!canvas||!ctx)&&(canvas=new OffscreenCanvas(64,64),ctx=canvas.getContext("2d"),!ctx))throw Error("2D context in offscreen not available!");ctx.font=a,ctx.textBaseline="alphabetic";const e=ctx.measureText("Hg").actualBoundingBoxDescent;ctx.textBaseline="bottom";const t=ctx.measureText("Hg").actualBoundingBoxAscent;return{ascent:t,height:t+e,descent:e}}function patchEngine(a){a.getFontOffset=getFontOffset}var ye,pe,q,Fe,Tt,Et,vt,xt,Mt,Ot,hi,wt,ci,Bt,ui,Ct,st,Ne;class LocalController{constructor(e){Q(this,Ot);Q(this,wt);Q(this,Bt);Q(this,ye,void 0);Q(this,pe,void 0);Q(this,q,null);Q(this,Fe,null);Q(this,Tt,Vector3.Zero());Q(this,Et,Vector3.Zero());Q(this,vt,[]);Q(this,xt,[]);Q(this,Mt,[]);re(this,"screenshotFilename","");Q(this,Ct,Vector3.One());Q(this,st,Quaternion.Zero());Q(this,Ne,Vector3.Zero());$(this,ye,e),$(this,pe,new Engine(e,!0,{preserveDrawingBuffer:!0})),e instanceof OffscreenCanvas&&patchEngine(I(this,pe))}load(e){var t;I(this,q)&&(I(this,q).indicatorLayer.dispose(),I(this,q).scene.dispose()),$(this,q,buildScene(e,I(this,pe))),I(this,q).scene.doNotHandleCursors=!0,$(this,Tt,I(this,q).camera.position.clone()),$(this,Et,I(this,q).camera.target.clone()),I(this,q).onAnimationTick.add(ne(this,Ot,hi).bind(this)),I(this,q).animation.onAnimationGroupLoopObservable.add(ne(this,wt,ci).bind(this)),this.screenshotFilename=(((t=e.meta)==null?void 0:t.name)??"Screenshot")+".png"}loadStage(e){if(!I(this,q))return;this.removeStage();const t=I(this,q).scene;import("./sceneLoader-c8905956.js").then(async i=>{await import("./index-d26f90f7.js"),i.SceneLoader.ImportMeshAsync("",e,void 0,t,void 0,".glb").then(r=>{r.meshes[0]&&($(this,Fe,r.meshes[0]),I(this,Fe).rotate(Axis.X,-Math.PI/2))})})}removeStage(){var e;(e=I(this,Fe))==null||e.dispose(),$(this,Fe,null)}get currentFrame(){var e;return((e=I(this,q))==null?void 0:e.animation.animatables[0].masterFrame)??0}get isStatic(){var e;return((e=I(this,q))==null?void 0:e.isStatic)??!0}get isPlaying(){var e;return((e=I(this,q))==null?void 0:e.animation.isPlaying)??!1}get speedRatio(){var e;return((e=I(this,q))==null?void 0:e.animation.speedRatio)??1}set speedRatio(e){I(this,q)&&(I(this,q).animation.speedRatio=e)}play(){var e;(e=I(this,q))==null||e.animation.play(!0)}pause(){var e;(e=I(this,q))==null||e.animation.pause()}goToFrame(e){var t;(t=I(this,q))==null||t.animation.goToFrame(e)}registerOnFrameChanged(e){I(this,xt).push(e)}registerOnAnimationLoop(e){I(this,vt).push(e)}select(e){var t,i;if(e!=null){const r=(t=I(this,q))==null?void 0:t.scene.getMeshByUniqueId(e);r&&r.metadata&&isMetadata(r.metadata)&&((i=I(this,q))==null||i.description.showDescription(r,r.metadata.name,r.metadata.description))}ne(this,Bt,ui).call(this,e)}target(e){if(!I(this,q))return;const t=I(this,q).scene.getMeshByUniqueId(e);if(t){const i=I(this,q).camera,r=t.position.subtract(i.target);i.setTarget(t.position),i.setPosition(i.position.add(r))}}setObjectsEnabled(e,t){var r;if(!((r=I(this,q))!=null&&r.scene))return;const i=I(this,q).objectMap;if(e)e.forEach(s=>{const n=i.get(s);n&&(n instanceof Node?n.setEnabled(t):n.isVisible=t)});else for(const s of i.values())s instanceof Node?s.setEnabled(t):s.isVisible=t}setPathEnabled(e,t,i){var r;(r=I(this,q))==null||r.pathVisualizer.setPathEnabled(e,t,i)}resetCamera(){var e,t;(e=I(this,q))==null||e.camera.setPosition(I(this,Tt)),(t=I(this,q))==null||t.camera.setTarget(I(this,Et))}registerOnObjectPicked(e){I(this,Mt).push(e)}simulatePointerDown(e,t){I(this,q)&&I(this,q).overlayTexture.pick(e,t,new PointerInfoPre(PointerEventTypes.POINTERDOWN,{type:"pointerdown",target:{},preventDefault:()=>{},inputIndex:PointerInput.LeftClick,altKey:!1,button:0,buttons:1,clientX:e,clientY:t,ctrlKey:!1,metaKey:!1,movementX:0,movementY:0,offsetX:e,offsetY:t,pageX:e,pageY:t,shiftKey:!1,x:e,y:t},e,t))}simulatePointerUp(e,t){if(!I(this,q))return;const i=I(this,q).scene.pick(e,t);if(i&&i.hit&&i.pickedMesh){const r=i.pickedMesh.uniqueId;this.select(r)}I(this,q).overlayTexture.pick(e,t,new PointerInfoPre(PointerEventTypes.POINTERUP,{type:"pointerup",target:{},preventDefault:()=>{},inputIndex:PointerInput.LeftClick,altKey:!1,button:0,buttons:1,clientX:e,clientY:t,ctrlKey:!1,metaKey:!1,movementX:0,movementY:0,offsetX:e,offsetY:t,pageX:e,pageY:t,shiftKey:!1,x:e,y:t},e,t))}simulatePointerMove(e,t){I(this,q)&&I(this,q).overlayTexture.pick(e,t,new PointerInfoPre(PointerEventTypes.POINTERMOVE,{type:"pointermove",target:{},preventDefault:()=>{},inputIndex:PointerInput.Move,altKey:!1,button:-1,buttons:0,clientX:e,clientY:t,ctrlKey:!1,metaKey:!1,movementX:0,movementY:0,offsetX:e,offsetY:t,pageX:e,pageY:t,shiftKey:!1,x:e,y:t},e,t))}panCamera(e,t){if(!I(this,q))return;const i=I(this,q).camera;i.target.subtractToRef(i.position,I(this,Ct));const r=I(this,Ct).length();e=-e/I(this,pe).getRenderWidth()*r,t=t/I(this,pe).getRenderHeight()*r,I(this,Ne).copyFromFloats(e,t,0),i.getViewMatrix().decompose(void 0,I(this,st),void 0,void 0),I(this,st).invertInPlace(),I(this,Ne).applyRotationQuaternionInPlace(I(this,st)),i.setTarget(i.target.add(I(this,Ne))),i.setPosition(i.position.add(I(this,Ne)))}rotateCamera(e,t){I(this,q)&&(e+=I(this,q).camera.alpha,t+=I(this,q).camera.beta,e%=2*Math.PI,t%=Math.PI,I(this,q).camera.alpha=e,I(this,q).camera.beta=t)}zoomCamera(e){I(this,q)&&(I(this,q).camera.radius+=e)}setCameraTarget(e,t,i){I(this,q)&&I(this,q).camera.setTarget(new Vector3(e,t,i))}setCameraRotation(e,t){I(this,q)&&(I(this,q).camera.alpha=e,I(this,q).camera.beta=t)}setCameraZoom(e){I(this,q)&&(I(this,q).camera.radius=e)}get isGridEnabled(){var e;return((e=I(this,q))==null?void 0:e.grid.isEnabled())??!1}setGridEnabled(e){var t;(t=I(this,q))==null||t.grid.setEnabled(e)}resize(e,t){I(this,ye).width=e,I(this,ye).height=t,I(this,pe).resize(!0)}setTheme(e){I(this,q)&&(I(this,q).overlayRoot.color=e.fontColor,I(this,q).scene.clearColor=Color4.FromColor3(Color3.FromHexString(e.clearColor),1))}dispose(){I(this,pe).dispose()}screenshot(){I(this,ye)instanceof HTMLCanvasElement&&takeScreenshot(I(this,ye),this.screenshotFilename)}}ye=new WeakMap,pe=new WeakMap,q=new WeakMap,Fe=new WeakMap,Tt=new WeakMap,Et=new WeakMap,vt=new WeakMap,xt=new WeakMap,Mt=new WeakMap,Ot=new WeakSet,hi=function(e){I(this,xt).forEach(t=>t(e.currentFrame))},wt=new WeakSet,ci=function(){I(this,vt).forEach(e=>e())},Bt=new WeakSet,ui=function(e){I(this,Mt).forEach(t=>t(e))},Ct=new WeakMap,st=new WeakMap,Ne=new WeakMap;let controller;function messageHandler(a){switch(a.data.type){case"load":{const e=a.data.data,t=new Uint8Array(e),i=Project.decode(t);controller.load(i)}break;case"loadStage":controller.loadStage(a.data.url);break;case"removeStage":controller.removeStage();break;case"play":controller.play();break;case"pause":controller.pause();break;case"goToFrame":controller.goToFrame(a.data.frame);break;case"resetCamera":controller.resetCamera();break;case"resize":controller.resize(a.data.width,a.data.height);break;case"setTheme":controller.setTheme(a.data.theme);break;case"select":controller.select(a.data.id);break;case"target":controller.target(a.data.id);break;case"setGridEnabled":controller.setGridEnabled(a.data.enabled);break;case"setObjectsEnabled":controller.setObjectsEnabled(a.data.objectIds,a.data.enabled);break;case"setPathEnabled":controller.setPathEnabled(a.data.id,a.data.enabled,a.data.color);break;case"pointerDown":controller.simulatePointerDown(a.data.x,a.data.y);break;case"pointerUp":controller.simulatePointerUp(a.data.x,a.data.y);break;case"pointermove":controller.simulatePointerMove(a.data.x,a.data.y);break;case"panCamera":controller.panCamera(a.data.dx,a.data.dy);break;case"rotateCamera":controller.rotateCamera(a.data.alpha,a.data.beta);break;case"zoom":controller.zoomCamera(a.data.delta);break;case"setCameraTarget":controller.setCameraTarget(a.data.x,a.data.y,a.data.z);break;case"setCameraRotation":controller.setCameraRotation(a.data.alpha,a.data.beta);break;case"setCameraZoom":controller.setCameraZoom(a.data.distance);break;case"setSpeedRatio":controller.speedRatio=a.data.value;break}}onmessage=a=>{const e=a.data.canvas;controller=new LocalController(e),controller.registerOnAnimationLoop(()=>postMessage({type:"onAnimationLoop"})),controller.registerOnFrameChanged(t=>postMessage({type:"onFrameChanged",currentFrame:t})),controller.registerOnObjectPicked(t=>postMessage({type:"onObjectPicked",objectId:t})),postMessage("done"),onmessage=messageHandler};export{VertexBuffer as $,AbstractScene as A,Bone as B,Camera as C,Decode as D,EngineStore as E,StandardMaterial as F,Color3 as G,Material as H,InstancedMesh as I,Constants as J,KeyboardEventTypes as K,Light as L,Mesh as M,Node as N,Observable as O,PointerEventTypes as P,Quaternion as Q,RuntimeError as R,ShaderMaterial as S,TransformNode as T,HemisphericLight as U,Vector3 as V,VertexData as W,MultiMaterial as X,Geometry as Y,SubMesh as Z,__decorate as _,Logger as a,ShaderStore as a0,InternalTextureSource as a1,ThinEngine as a2,InternalTexture as a3,serializeAsColor4 as a4,SmartArray as a5,DrawWrapper as a6,ShaderLanguage as a7,SerializationHelper as a8,GetClass as a9,AnimationGroup as aA,AnimationKeyInterpolation as aB,Buffer as aC,IsBase64DataUrl as aD,LoadFileError as aE,BoundingInfo as aF,RandomGUID as aG,LoadImage as aH,serializeAsMatrix as aI,_WarnImport as aJ,SceneLoaderFlags as aK,RegisterClass as aa,Viewport as ab,Scalar as ac,_ObserveArray as ad,RenderingManager as ae,PostProcessManager as af,expandToProperty as ag,MaterialPluginBase as ah,MaterialDefines as ai,ToLinearSpace as aj,BaseTexture as ak,serializeAsColor3 as al,MaterialFlags as am,MaterialHelper as an,serializeAsVector2 as ao,serializeAsImageProcessingConfiguration as ap,PushMaterial as aq,DetailMapConfiguration as ar,PrePassConfiguration as as,MaterialPluginEvent as at,addClipPlaneUniforms as au,ImageProcessingConfiguration as av,TmpColors as aw,bindClipPlane as ax,Scene as ay,EffectFallbacks as az,Tools as b,DecodeBase64UrlToBinary as c,ErrorCodes as d,CameraInputTypes as e,EventConstants as f,Coordinate as g,Matrix as h,CameraInputsManager as i,serializeAsVector3 as j,TargetCamera as k,Vector2 as l,Engine as m,AnimationRange as n,Animation as o,TmpVectors as p,RawTexture as q,DeepCopier as r,serialize as s,Axis as t,Texture as u,serializeAsTexture as v,Vector4 as w,Effect as x,Color4 as y,AbstractMesh as z};
